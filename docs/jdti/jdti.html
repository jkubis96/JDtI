<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>jdti.jdti API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>
    /* --- Custom Style --- */
    pre {
    line-height: 130%;
    background: #1e1e1e; /* ciemne tło jak w VS Code */
    color: #e0e0e0;
    padding: 1em;
    border-radius: 10px;
    overflow-x: auto;
    }

    span.linenos {
    color: #888;
    background-color: transparent;
    padding-left: 5px;
    padding-right: 20px;
    }

    .pdoc-code .hll {
    background-color: rgba(255, 153, 51, 0.2);
    }

    .pdoc-code {
    background: #1e1e1e;
    color: #e0e0e0;
    }

    /* --- Comments (szaro-zielone) --- */
    .pdoc-code .c,
    .pdoc-code .cm,
    .pdoc-code .ch,
    .pdoc-code .cpf,
    .pdoc-code .c1,
    .pdoc-code .cs {
    color: #6a9955;
    font-style: italic;
    }

    /* --- Keywords (zielone / limonkowe) --- */
    .pdoc-code .k,
    .pdoc-code .kd,
    .pdoc-code .kn,
    .pdoc-code .kr,
    .pdoc-code .kc,
    .pdoc-code .nt {
    color: #4ec9b0;
    font-weight: bold;
    }

    /* --- Strings (czerwono-pomarańczowe) --- */
    .pdoc-code .s,
    .pdoc-code .s1,
    .pdoc-code .s2,
    .pdoc-code .sa,
    .pdoc-code .sb,
    .pdoc-code .sd,
    .pdoc-code .sh,
    .pdoc-code .sr {
    color: #f78c6c;
    }

    /* --- Numbers (szare) --- */
    .pdoc-code .m,
    .pdoc-code .mi,
    .pdoc-code .mf,
    .pdoc-code .mh,
    .pdoc-code .il {
    color: #c0c0c0;
    }

    /* --- Functions (fioletowe) --- */
    .pdoc-code .nf,
    .pdoc-code .fm {
    color: #c586c0;
    font-weight: bold;
    }

    /* --- Classes / Types (niebiesko-fioletowe) --- */
    .pdoc-code .nc,
    .pdoc-code .nn,
    .pdoc-code .kt {
    color: #9cdcfe;
    font-weight: bold;
    }

    /* --- Constants / Variables (zielono-niebieskie) --- */
    .pdoc-code .nv,
    .pdoc-code .vc,
    .pdoc-code .vg,
    .pdoc-code .vi {
    color: #4ec9b0;
    }

    /* --- Operators (jasnoszare) --- */
    .pdoc-code .o,
    .pdoc-code .ow {
    color: #d4d4d4;
    }

    /* --- Decorators / Special (pomarańczowo-fioletowe) --- */
    .pdoc-code .nd,
    .pdoc-code .ne,
    .pdoc-code .gu,
    .pdoc-code .gt {
    color: #d16969;
    font-weight: bold;
    }

    /* --- Errors / Diff --- */
    .pdoc-code .err {
    border: 1px solid #ff5555;
    background: rgba(255, 85, 85, 0.1);
    }

    /* --- Misc --- */
    .pdoc-code .w { color: #777; }
    .pdoc-code .go { color: #999; }
    .pdoc-code .gp { color: #ffcc00; font-weight: bold; }
    </style>
    <style>/* custom style *//*! theme.css */:root{--pdoc-background:#585656;}.pdoc{
        --text:#ffffff;
        --muted:#ffffff;
        --link:#c51616;
        --link-hover:#c51616;
        --code:#302d2d;
        --active:#302d2d;
        --accent:#302d2d;
        --accent2:#c1c1c1;
        --nav-hover:rgba(255, 255, 255, 0.5);
        --name:#cf7b0c;
        --def:#ff0000;
        --annotation:#9f00be;}
    </style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../jdti.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;jdti</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Clustering">Clustering</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Clustering.__init__">Clustering</a>
                        </li>
                        <li>
                                <a class="variable" href="#Clustering.clustering_data">clustering_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#Clustering.clustering_metadata">clustering_metadata</a>
                        </li>
                        <li>
                                <a class="variable" href="#Clustering.subclusters">subclusters</a>
                        </li>
                        <li>
                                <a class="variable" href="#Clustering.explained_var">explained_var</a>
                        </li>
                        <li>
                                <a class="variable" href="#Clustering.cumulative_var">cumulative_var</a>
                        </li>
                        <li>
                                <a class="variable" href="#Clustering.pca">pca</a>
                        </li>
                        <li>
                                <a class="variable" href="#Clustering.harmonized_pca">harmonized_pca</a>
                        </li>
                        <li>
                                <a class="variable" href="#Clustering.umap">umap</a>
                        </li>
                        <li>
                                <a class="function" href="#Clustering.add_data_frame">add_data_frame</a>
                        </li>
                        <li>
                                <a class="function" href="#Clustering.harmonize_sets">harmonize_sets</a>
                        </li>
                        <li>
                                <a class="function" href="#Clustering.perform_PCA">perform_PCA</a>
                        </li>
                        <li>
                                <a class="function" href="#Clustering.knee_plot_PCA">knee_plot_PCA</a>
                        </li>
                        <li>
                                <a class="function" href="#Clustering.find_clusters_PCA">find_clusters_PCA</a>
                        </li>
                        <li>
                                <a class="function" href="#Clustering.perform_UMAP">perform_UMAP</a>
                        </li>
                        <li>
                                <a class="function" href="#Clustering.knee_plot_umap">knee_plot_umap</a>
                        </li>
                        <li>
                                <a class="function" href="#Clustering.find_clusters_UMAP">find_clusters_UMAP</a>
                        </li>
                        <li>
                                <a class="function" href="#Clustering.UMAP_vis">UMAP_vis</a>
                        </li>
                        <li>
                                <a class="function" href="#Clustering.UMAP_feature">UMAP_feature</a>
                        </li>
                        <li>
                                <a class="function" href="#Clustering.get_umap_data">get_umap_data</a>
                        </li>
                        <li>
                                <a class="function" href="#Clustering.get_pca_data">get_pca_data</a>
                        </li>
                        <li>
                                <a class="function" href="#Clustering.return_clusters">return_clusters</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#COMPsc">COMPsc</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#COMPsc.__init__">COMPsc</a>
                        </li>
                        <li>
                                <a class="variable" href="#COMPsc.objects">objects</a>
                        </li>
                        <li>
                                <a class="variable" href="#COMPsc.input_data">input_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#COMPsc.input_metadata">input_metadata</a>
                        </li>
                        <li>
                                <a class="variable" href="#COMPsc.normalized_data">normalized_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#COMPsc.agg_metadata">agg_metadata</a>
                        </li>
                        <li>
                                <a class="variable" href="#COMPsc.agg_normalized_data">agg_normalized_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#COMPsc.similarity">similarity</a>
                        </li>
                        <li>
                                <a class="variable" href="#COMPsc.var_data">var_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#COMPsc.subclusters_">subclusters_</a>
                        </li>
                        <li>
                                <a class="variable" href="#COMPsc.cells_calc">cells_calc</a>
                        </li>
                        <li>
                                <a class="variable" href="#COMPsc.gene_calc">gene_calc</a>
                        </li>
                        <li>
                                <a class="variable" href="#COMPsc.composition_data">composition_data</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.project_dir">project_dir</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.save_project">save_project</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.load_project">load_project</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.reduce_cols">reduce_cols</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.reduce_rows">reduce_rows</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.get_data">get_data</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.get_partial_data">get_partial_data</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.get_metadata">get_metadata</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.gene_calculation">gene_calculation</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.gene_histograme">gene_histograme</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.gene_threshold">gene_threshold</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.cells_calculation">cells_calculation</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.cell_histograme">cell_histograme</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.cluster_threshold">cluster_threshold</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.load_sparse_from_projects">load_sparse_from_projects</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.rename_names">rename_names</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.rename_subclusters">rename_subclusters</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.save_sparse">save_sparse</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.normalize_counts">normalize_counts</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.statistic">statistic</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.calculate_difference_markers">calculate_difference_markers</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.clustering_features">clustering_features</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.average">average</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.estimating_similarity">estimating_similarity</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.similarity_plot">similarity_plot</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.spatial_similarity">spatial_similarity</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.subcluster_prepare">subcluster_prepare</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.define_subclusters">define_subclusters</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.subcluster_features_scatter">subcluster_features_scatter</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.subcluster_DEG_scatter">subcluster_DEG_scatter</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.accept_subclusters">accept_subclusters</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.scatter_plot">scatter_plot</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.data_composition">data_composition</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.composition_pie">composition_pie</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.bar_composition">bar_composition</a>
                        </li>
                        <li>
                                <a class="function" href="#COMPsc.cell_regression">cell_regression</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../jdti.html">jdti</a><wbr>.jdti    </h1>

                
                        <input id="mod-jdti-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-jdti-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">harmonypy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">harmonize</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">umap</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">adjustText</span><span class="w"> </span><span class="kn">import</span> <span class="n">adjust_text</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">joblib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">FancyArrowPatch</span><span class="p">,</span> <span class="n">Patch</span><span class="p">,</span> <span class="n">Polygon</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">sparse</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">mmwrite</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConvexHull</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial.distance</span><span class="w"> </span><span class="kn">import</span> <span class="n">pdist</span><span class="p">,</span> <span class="n">squareform</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">zscore</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.cluster</span><span class="w"> </span><span class="kn">import</span> <span class="n">DBSCAN</span><span class="p">,</span> <span class="n">MeanShift</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">pairwise_distances</span><span class="p">,</span> <span class="n">silhouette_score</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">MinMaxScaler</span><span class="p">,</span> <span class="n">StandardScaler</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Clustering</span><span class="p">:</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="sd">    A class for performing dimensionality reduction, clustering, and visualization</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="sd">    on high-dimensional data (e.g., single-cell gene expression).</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="sd">    The class provides methods for:</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="sd">    - Normalizing and extracting subsets of data</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="sd">    - Principal Component Analysis (PCA) and related clustering</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="sd">    - Uniform Manifold Approximation and Projection (UMAP) and clustering</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="sd">    - Visualization of PCA and UMAP embeddings</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="sd">    - Harmonization of batch effects</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="sd">    - Accessing processed data and cluster labels</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="sd">    Methods</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="sd">    -------</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a><span class="sd">    add_data_frame(data, metadata)</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="sd">        Class method to create a Clustering instance from a DataFrame and metadata.</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="sd">    harmonize_sets()</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="sd">        Perform batch effect harmonization on PCA data.</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="sd">    perform_PCA(pc_num=100, width=8, height=6)</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="sd">        Perform PCA on the dataset and visualize the first two PCs.</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">    knee_plot_PCA(width=8, height=6)</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="sd">        Plot the cumulative variance explained by PCs to determine optimal dimensionality.</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="sd">    find_clusters_PCA(pc_num=0, eps=0.5, min_samples=10, width=8, height=6, harmonized=False)</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="sd">        Apply DBSCAN clustering to PCA embeddings and visualize results.</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="sd">    perform_UMAP(factorize=False, umap_num=100, pc_num=0, harmonized=False, ...)</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="sd">        Compute UMAP embeddings with optional parameter tuning.</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="sd">    knee_plot_umap(eps=0.5, min_samples=10)</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="sd">        Determine optimal UMAP dimensionality using silhouette scores.</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a><span class="sd">    find_clusters_UMAP(umap_n=5, eps=0.5, min_samples=10, width=8, height=6)</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="sd">        Apply DBSCAN clustering on UMAP embeddings and visualize clusters.</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="sd">    UMAP_vis(names_slot=&#39;cell_names&#39;, set_sep=True, point_size=0.6, ...)</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="sd">        Visualize UMAP embeddings with labels and optional cluster numbering.</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a><span class="sd">    UMAP_feature(feature_name, features_data=None, point_size=0.6, ...)</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a><span class="sd">        Plot a single feature over UMAP coordinates with customizable colormap.</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a><span class="sd">    get_umap_data()</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a><span class="sd">        Return the UMAP embeddings along with cluster labels if available.</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a><span class="sd">    get_pca_data()</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a><span class="sd">        Return the PCA results along with cluster labels if available.</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a><span class="sd">    return_clusters(clusters=&#39;umap&#39;)</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a><span class="sd">        Return the cluster labels for UMAP or PCA embeddings.</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a><span class="sd">    Raises</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a><span class="sd">    ------</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a><span class="sd">    ValueError</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a><span class="sd">        For invalid parameters, mismatched dimensions, or missing metadata.</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a><span class="sd">        Initialize the clustering class with data and optional metadata.</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a><span class="sd">        Parameters</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="sd">        ----------</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a><span class="sd">        data : pandas.DataFrame</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a><span class="sd">            Input data for clustering. Columns are considered as samples.</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a><span class="sd">        metadata : pandas.DataFrame, optional</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a><span class="sd">            Metadata for the samples. If None, a default DataFrame with column</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a><span class="sd">            names as &#39;cell_names&#39; is created.</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a><span class="sd">        Attributes</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a><span class="sd">        ----------</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a><span class="sd">        -clustering_data : pandas.DataFrame</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a><span class="sd">        -clustering_metadata : pandas.DataFrame</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a><span class="sd">        -subclusters : None or dict</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a><span class="sd">        -explained_var : None or numpy.ndarray</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a><span class="sd">        -cumulative_var : None or numpy.ndarray</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a><span class="sd">        -pca : None or pandas.DataFrame</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a><span class="sd">        -harmonized_pca : None or pandas.DataFrame</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a><span class="sd">        -umap : None or pandas.DataFrame</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_data</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The input data used for clustering.&quot;&quot;&quot;</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;cell_names&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)})</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span> <span class="o">=</span> <span class="n">metadata</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Metadata associated with the samples.&quot;&quot;&quot;</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Placeholder for storing subcluster information.&quot;&quot;&quot;</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">explained_var</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Explained variance from PCA, initialized as None.&quot;&quot;&quot;</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_var</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Cumulative explained variance from PCA, initialized as None.&quot;&quot;&quot;</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pca</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;PCA-transformed data, initialized as None.&quot;&quot;&quot;</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;PCA data after batch effect harmonization, initialized as None.&quot;&quot;&quot;</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">umap</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;UMAP embeddings, initialized as None.&quot;&quot;&quot;</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_data_frame</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a><span class="sd">        Create a Clustering instance from a DataFrame and optional metadata.</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a><span class="sd">        Parameters</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a><span class="sd">        ----------</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a><span class="sd">        data : pandas.DataFrame</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a><span class="sd">            Input data with features as rows and samples/cells as columns.</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a><span class="sd">        metadata : pandas.DataFrame or None</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a><span class="sd">            Optional metadata for the samples.</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a><span class="sd">            Each row corresponds to a sample/cell, and column names in this DataFrame</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a><span class="sd">            should match the sample/cell names in `data`. Columns can contain additional</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a><span class="sd">            information such as cell type, experimental condition, batch, sets, etc.</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a><span class="sd">        Returns</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a><span class="sd">        -------</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a><span class="sd">        Clustering</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a><span class="sd">            A new instance of the Clustering class.</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">harmonize_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sets&quot;</span><span class="p">):</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a><span class="sd">        Perform batch effect harmonization on PCA embeddings.</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a><span class="sd">        Parameters</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a><span class="sd">        ----------</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a><span class="sd">        batch_col : str, default &#39;sets&#39;</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a><span class="sd">            Name of the column in `metadata` that contains batch information for the samples/cells.</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a><span class="sd">        Returns</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a><span class="sd">        -------</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a><span class="sd">        None</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a><span class="sd">            Updates the `harmonized_pca` attribute with harmonized data.</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>        <span class="n">data_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="p">)</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>            <span class="n">harmonize</span><span class="o">.</span><span class="n">run_harmony</span><span class="p">(</span><span class="n">data_mat</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">vars_use</span><span class="o">=</span><span class="n">batch_col</span><span class="p">)</span><span class="o">.</span><span class="n">Z_corr</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="o">.</span><span class="n">columns</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">perform_PCA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pc_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="sd">        Perform Principal Component Analysis (PCA) on the dataset.</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a><span class="sd">        This method standardizes the data, applies PCA, stores results as attributes,</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a><span class="sd">        and generates a scatter plot of the first two principal components.</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a><span class="sd">        Parameters</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a><span class="sd">        ----------</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a><span class="sd">        pc_num : int, default 100</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a><span class="sd">            Number of principal components to compute.</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a><span class="sd">            If 0, computes all available components.</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a><span class="sd">        width : int or float, default 8</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a><span class="sd">            Width of the PCA figure.</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a><span class="sd">        height : int or float, default 6</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a><span class="sd">            Height of the PCA figure.</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a><span class="sd">        Returns</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a><span class="sd">        -------</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a><span class="sd">            Scatter plot showing the first two principal components.</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a><span class="sd">        Updates</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a><span class="sd">        -------</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a><span class="sd">        self.pca : pandas.DataFrame</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a><span class="sd">            DataFrame with principal component scores for each sample.</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a><span class="sd">        self.explained_var : numpy.ndarray</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a><span class="sd">            Percentage of variance explained by each principal component.</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a><span class="sd">        self.cumulative_var : numpy.ndarray</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a><span class="sd">            Cumulative explained variance.</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>        <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>        <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clustering_data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>        <span class="k">if</span> <span class="n">pc_num</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pc_num</span> <span class="o">&gt;</span> <span class="n">data_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>            <span class="n">pc_num</span> <span class="o">=</span> <span class="n">data_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>        <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">pc_num</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>        <span class="n">principal_components</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">)</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>        <span class="n">pca_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>            <span class="n">data</span><span class="o">=</span><span class="n">principal_components</span><span class="p">,</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;PC&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pc_num</span><span class="p">)],</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>        <span class="p">)</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">explained_var</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explained_var</span><span class="p">)</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pca</span> <span class="o">=</span> <span class="n">pca_df</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pca_df</span><span class="p">[</span><span class="s2">&quot;PC1&quot;</span><span class="p">],</span> <span class="n">pca_df</span><span class="p">[</span><span class="s2">&quot;PC2&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;PC 1&quot;</span><span class="p">)</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;PC 2&quot;</span><span class="p">)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">knee_plot_PCA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">):</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a><span class="sd">        Plot cumulative explained variance to determine the optimal number of PCs.</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a><span class="sd">        Parameters</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a><span class="sd">        ----------</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a><span class="sd">        width : int, default 8</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a><span class="sd">            Width of the figure.</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a><span class="sd">        height : int or, default 6</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a><span class="sd">            Height of the figure.</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a><span class="sd">        Returns</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a><span class="sd">        -------</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a><span class="sd">            Line plot showing cumulative variance explained by each PC.</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>        <span class="n">fig_knee</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explained_var</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_var</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;PC (n components)&quot;</span><span class="p">)</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative explained variance (%)&quot;</span><span class="p">)</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>        <span class="n">xticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explained_var</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>        <span class="k">return</span> <span class="n">fig_knee</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_clusters_PCA</span><span class="p">(</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>        <span class="n">pc_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>        <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>        <span class="n">min_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>        <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>        <span class="n">harmonized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>    <span class="p">):</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a><span class="sd">        Apply DBSCAN clustering to PCA embeddings and visualize the results.</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a><span class="sd">        This method performs density-based clustering (DBSCAN) on the PCA-reduced</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a><span class="sd">        dataset. Cluster labels are stored in the object&#39;s metadata, and a scatter</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a><span class="sd">        plot of the first two principal components with cluster annotations is returned.</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a><span class="sd">        Parameters</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a><span class="sd">        ----------</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a><span class="sd">        pc_num : int, default 2</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a><span class="sd">            Number of principal components to use for clustering.</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a><span class="sd">            If 0, uses all available components.</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a><span class="sd">        eps : float, default 0.5</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a><span class="sd">            Maximum distance between two points for them to be considered</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a><span class="sd">            as neighbors (DBSCAN parameter).</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a><span class="sd">        min_samples : int, default 10</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a><span class="sd">            Minimum number of samples required to form a cluster (DBSCAN parameter).</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a><span class="sd">        width : int, default 8</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a><span class="sd">            Width of the output scatter plot.</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a><span class="sd">        height : int, default 6</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a><span class="sd">            Height of the output scatter plot.</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a><span class="sd">        harmonized : bool, default False</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a><span class="sd">            If True, use harmonized PCA data (`self.harmonized_pca`).</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a><span class="sd">            If False, use standard PCA results (`self.pca`).</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a><span class="sd">        Returns</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a><span class="sd">        -------</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a><span class="sd">            Scatter plot of the first two principal components colored by</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a><span class="sd">            cluster assignments.</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a><span class="sd">        Updates</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a><span class="sd">        -------</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a><span class="sd">        self.clustering_metadata[&#39;PCA_clusters&#39;] : list</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a><span class="sd">            Cluster labels assigned to each cell/sample.</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a><span class="sd">        self.input_metadata[&#39;PCA_clusters&#39;] : list, optional</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a><span class="sd">            Cluster labels stored in input metadata (if available).</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>        <span class="n">dbscan</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="n">min_samples</span><span class="p">)</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>        <span class="k">if</span> <span class="n">pc_num</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">harmonized</span><span class="p">:</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>            <span class="n">PCA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>        <span class="k">elif</span> <span class="n">pc_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>            <span class="n">PCA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>            <span class="k">if</span> <span class="n">harmonized</span><span class="p">:</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>                <span class="n">PCA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">pc_num</span><span class="p">]</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>                <span class="n">PCA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">pc_num</span><span class="p">]</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>        <span class="n">dbscan_labels</span> <span class="o">=</span> <span class="n">dbscan</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">PCA</span><span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>        <span class="n">pca_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">PCA</span><span class="p">)</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>        <span class="n">pca_df</span><span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbscan_labels</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>        <span class="k">for</span> <span class="n">cluster_id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pca_df</span><span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>            <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">pca_df</span><span class="p">[</span><span class="n">pca_df</span><span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cluster_id</span><span class="p">]</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>                <span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;PC1&quot;</span><span class="p">],</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>                <span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;PC2&quot;</span><span class="p">],</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cluster </span><span class="si">{</span><span class="n">cluster_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>            <span class="p">)</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;PC 1&quot;</span><span class="p">)</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;PC 2&quot;</span><span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Clusters&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;PCA_clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dbscan_labels</span><span class="p">]</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;PCA_clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dbscan_labels</span><span class="p">]</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>            <span class="k">pass</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">perform_UMAP</span><span class="p">(</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>        <span class="n">factorize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>        <span class="n">umap_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>        <span class="n">pc_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>        <span class="n">harmonized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>        <span class="n">n_neighbors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>        <span class="n">min_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>        <span class="n">spread</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>        <span class="n">set_op_mix_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>        <span class="n">local_connectivity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>        <span class="n">repulsion_strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>        <span class="n">negative_sample_rate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>        <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>    <span class="p">):</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="sd">        Compute and visualize UMAP embeddings of the dataset.</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a><span class="sd">        This method applies Uniform Manifold Approximation and Projection (UMAP)</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a><span class="sd">        for dimensionality reduction on either raw, PCA, or harmonized PCA data.</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a><span class="sd">        Results are stored as a DataFrame (`self.umap`) and a scatter plot figure</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a><span class="sd">        (`self.UMAP_plot`).</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a><span class="sd">        Parameters</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a><span class="sd">        ----------</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a><span class="sd">        factorize : bool, default False</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a><span class="sd">            If True, categorical sample labels (from column names) are factorized</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a><span class="sd">            and used as supervision in UMAP fitting.</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a><span class="sd">        umap_num : int, default 100</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a><span class="sd">            Number of UMAP dimensions to compute. If 0, matches the input dimension.</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a><span class="sd">        pc_num : int, default 0</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a><span class="sd">            Number of principal components to use as UMAP input.</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a><span class="sd">            If 0, use all available components or raw data.</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a><span class="sd">        harmonized : bool, default False</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a><span class="sd">            If True, use harmonized PCA embeddings (`self.harmonized_pca`).</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a><span class="sd">            If False, use standard PCA or raw scaled data.</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a><span class="sd">        n_neighbors : int, default 5</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a><span class="sd">            UMAP parameter controlling the size of the local neighborhood.</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a><span class="sd">        min_dist : float, default 0.1</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a><span class="sd">            UMAP parameter controlling minimum allowed distance between embedded points.</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a><span class="sd">        spread : int | float, default 1.0</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a><span class="sd">            Effective scale of embedded space (UMAP parameter).</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a><span class="sd">        set_op_mix_ratio : int | float, default 1.0</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a><span class="sd">            Interpolation parameter between union and intersection in fuzzy sets.</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a><span class="sd">        local_connectivity : int, default 1</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a><span class="sd">            Number of nearest neighbors assumed for each point.</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a><span class="sd">        repulsion_strength : int | float, default 1.0</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a><span class="sd">            Weighting applied to negative samples during optimization.</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a><span class="sd">        negative_sample_rate : int, default 5</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a><span class="sd">            Number of negative samples per positive sample in optimization.</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a><span class="sd">        width : int, default 8</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a><span class="sd">            Width of the output scatter plot.</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a><span class="sd">        height : int, default 6</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a><span class="sd">            Height of the output scatter plot.</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a><span class="sd">        Updates</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a><span class="sd">        -------</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a><span class="sd">        self.umap : pandas.DataFrame</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a><span class="sd">            Table of UMAP embeddings with columns `UMAP1 ... UMAPn`.</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a><span class="sd">        Notes</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a><span class="sd">        -----</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a><span class="sd">        For supervised UMAP (`factorize=True`), categorical codes from column</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a><span class="sd">        names of the dataset are used as labels.</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>        <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>        <span class="k">if</span> <span class="n">pc_num</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">harmonized</span><span class="p">:</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>            <span class="n">data_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>        <span class="k">elif</span> <span class="n">pc_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>            <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clustering_data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>            <span class="k">if</span> <span class="n">harmonized</span><span class="p">:</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>                <span class="n">data_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">pc_num</span><span class="p">]</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>                <span class="n">data_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">pc_num</span><span class="p">]</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>        <span class="k">if</span> <span class="n">umap_num</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">umap_num</span> <span class="o">&gt;</span> <span class="n">data_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>            <span class="n">umap_num</span> <span class="o">=</span> <span class="n">data_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>            <span class="n">reducer</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">UMAP</span><span class="p">(</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>                <span class="n">n_components</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data_scaled</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>                <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>                <span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">,</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>                <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>                <span class="n">spread</span><span class="o">=</span><span class="n">spread</span><span class="p">,</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>                <span class="n">set_op_mix_ratio</span><span class="o">=</span><span class="n">set_op_mix_ratio</span><span class="p">,</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>                <span class="n">local_connectivity</span><span class="o">=</span><span class="n">local_connectivity</span><span class="p">,</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>                <span class="n">repulsion_strength</span><span class="o">=</span><span class="n">repulsion_strength</span><span class="p">,</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>                <span class="n">negative_sample_rate</span><span class="o">=</span><span class="n">negative_sample_rate</span><span class="p">,</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>                <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>            <span class="p">)</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>            <span class="n">reducer</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">UMAP</span><span class="p">(</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>                <span class="n">n_components</span><span class="o">=</span><span class="n">umap_num</span><span class="p">,</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>                <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>                <span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">,</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>                <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>                <span class="n">spread</span><span class="o">=</span><span class="n">spread</span><span class="p">,</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>                <span class="n">set_op_mix_ratio</span><span class="o">=</span><span class="n">set_op_mix_ratio</span><span class="p">,</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>                <span class="n">local_connectivity</span><span class="o">=</span><span class="n">local_connectivity</span><span class="p">,</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>                <span class="n">repulsion_strength</span><span class="o">=</span><span class="n">repulsion_strength</span><span class="p">,</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>                <span class="n">negative_sample_rate</span><span class="o">=</span><span class="n">negative_sample_rate</span><span class="p">,</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>                <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>            <span class="p">)</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>        <span class="k">if</span> <span class="n">factorize</span><span class="p">:</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>            <span class="n">embedding</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>                <span class="n">X</span><span class="o">=</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clustering_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">codes</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>            <span class="p">)</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>            <span class="n">embedding</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">data_scaled</span><span class="p">)</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>        <span class="n">umap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>            <span class="n">embedding</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;UMAP&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">umap_num</span><span class="p">)]</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>        <span class="p">)</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;UMAP1&quot;</span><span class="p">],</span> <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;UMAP2&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">)</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">)</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">umap</span> <span class="o">=</span> <span class="n">umap_df</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">knee_plot_umap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">min_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a><span class="sd">        Plot silhouette scores for different UMAP dimensions to determine optimal n_components.</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a><span class="sd">        Parameters</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a><span class="sd">        ----------</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a><span class="sd">        eps : float, default 0.5</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a><span class="sd">            DBSCAN eps parameter for clustering each UMAP dimension.</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a><span class="sd">        min_samples : int, default 10</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a><span class="sd">            Minimum number of samples to form a cluster in DBSCAN.</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a><span class="sd">        Returns</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a><span class="sd">        -------</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a><span class="sd">            Silhouette score plot across UMAP dimensions.</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>        <span class="n">umap_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">umap</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>        <span class="n">silhouette_scores</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>        <span class="n">component</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">umap_range</span><span class="p">:</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>            <span class="n">db</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="n">min_samples</span><span class="p">)</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">umap</span><span class="p">)[:,</span> <span class="p">:</span><span class="n">n</span><span class="p">])</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>                <span class="n">score</span> <span class="o">=</span> <span class="n">silhouette_score</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">umap</span><span class="p">)[:,</span> <span class="p">:</span><span class="n">n</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>                <span class="n">score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>            <span class="n">silhouette_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>            <span class="n">component</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">silhouette_scores</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP (n_components)&quot;</span><span class="p">)</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Silhouette Score&quot;</span><span class="p">)</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">component</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">component</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_clusters_UMAP</span><span class="p">(</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>        <span class="n">umap_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>        <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>        <span class="n">min_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>        <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>    <span class="p">):</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a><span class="sd">        Apply DBSCAN clustering on UMAP embeddings and visualize clusters.</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a><span class="sd">        This method performs density-based clustering (DBSCAN) on the UMAP-reduced</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a><span class="sd">        dataset. Cluster labels are stored in the object&#39;s metadata, and a scatter</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a><span class="sd">        plot of the first two UMAP components with cluster annotations is returned.</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a><span class="sd">        Parameters</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a><span class="sd">        ----------</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a><span class="sd">        umap_n : int, default 5</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a><span class="sd">            Number of UMAP dimensions to use for DBSCAN clustering.</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a><span class="sd">            Must be &lt;= number of columns in `self.umap`.</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a><span class="sd">        eps : float | int, default 0.5</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a><span class="sd">            Maximum neighborhood distance between two samples for them to be considered</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a><span class="sd">            as in the same cluster (DBSCAN parameter).</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a><span class="sd">        min_samples : int, default 10</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a><span class="sd">            Minimum number of samples in a neighborhood to form a cluster (DBSCAN parameter).</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a><span class="sd">        width : int, default 8</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a><span class="sd">            Figure width.</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a><span class="sd">        height : int, default 6</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a><span class="sd">            Figure height.</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a><span class="sd">        Returns</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a><span class="sd">        -------</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a><span class="sd">            Scatter plot of the first two UMAP components colored by</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a><span class="sd">            cluster assignments.</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a><span class="sd">        Updates</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a><span class="sd">        -------</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a><span class="sd">        self.clustering_metadata[&#39;UMAP_clusters&#39;] : list</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a><span class="sd">            Cluster labels assigned to each cell/sample.</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a><span class="sd">        self.input_metadata[&#39;UMAP_clusters&#39;] : list, optional</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a><span class="sd">            Cluster labels stored in input metadata (if available).</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>        <span class="n">dbscan</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="n">min_samples</span><span class="p">)</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>        <span class="n">dbscan_labels</span> <span class="o">=</span> <span class="n">dbscan</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">umap</span><span class="p">)[:,</span> <span class="p">:</span><span class="n">umap_n</span><span class="p">])</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>        <span class="n">umap_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">umap</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>        <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbscan_labels</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>        <span class="k">for</span> <span class="n">cluster_id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>            <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">umap_df</span><span class="p">[</span><span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cluster_id</span><span class="p">]</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>                <span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;UMAP1&quot;</span><span class="p">],</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>                <span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;UMAP2&quot;</span><span class="p">],</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cluster </span><span class="si">{</span><span class="n">cluster_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>            <span class="p">)</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">)</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">)</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Clusters&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;UMAP_clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dbscan_labels</span><span class="p">]</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;UMAP_clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dbscan_labels</span><span class="p">]</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>            <span class="k">pass</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">UMAP_vis</span><span class="p">(</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>        <span class="n">names_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>        <span class="n">set_sep</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>        <span class="n">point_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>        <span class="n">font_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>        <span class="n">legend_split_col</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>        <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>        <span class="n">inc_num</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>    <span class="p">):</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a><span class="sd">        Visualize UMAP embeddings with sample labels based on specyfic metadata slot.</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a><span class="sd">        Parameters</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a><span class="sd">        ----------</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a><span class="sd">        names_slot : str, default &#39;cell_names&#39;</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a><span class="sd">            Column in metadata to use as sample labels.</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a><span class="sd">        set_sep : bool, default True</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="sd">            If True, separate points by dataset.</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a><span class="sd">        point_size : float, default 0.6</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a><span class="sd">            Size of scatter points.</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a><span class="sd">        font_size : int, default 6</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a><span class="sd">            Font size for numbers on points.</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a><span class="sd">        legend_split_col : int, default 2</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a><span class="sd">            Number of columns in legend.</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a><span class="sd">        width : int, default 8</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a><span class="sd">            Figure width.</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a><span class="sd">        height : int, default 6</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a><span class="sd">            Figure height.</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a><span class="sd">        inc_num : bool, default True</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a><span class="sd">            If True, annotate points with numeric labels.</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a><span class="sd">        Returns</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a><span class="sd">        -------</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a><span class="sd">            UMAP scatter plot figure.</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>        <span class="n">umap_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">umap</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>        <span class="n">umap_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="n">names_slot</span><span class="p">]</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>        <span class="k">if</span> <span class="n">set_sep</span><span class="p">:</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>            <span class="k">if</span> <span class="s2">&quot;sets&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>                <span class="n">umap_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>                <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>            <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>        <span class="n">umap_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;tmp_nam&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>        <span class="n">umap_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;tmp_nam&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>            <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;tmp_nam&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>        <span class="p">)</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>        <span class="n">numeric_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">umap_df</span><span class="p">[[</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="s2">&quot;tmp_nam&quot;</span><span class="p">,</span> <span class="s2">&quot;names&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>        <span class="p">)</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>        <span class="n">numeric_df</span><span class="p">[</span><span class="s2">&quot;numeric_values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numeric_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>        <span class="n">umap_df</span> <span class="o">=</span> <span class="n">umap_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>            <span class="n">numeric_df</span><span class="p">[[</span><span class="s2">&quot;tmp_nam&quot;</span><span class="p">,</span> <span class="s2">&quot;numeric_values&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;tmp_nam&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>        <span class="p">)</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>        <span class="n">markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">]</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>        <span class="n">marker_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>            <span class="n">ds</span><span class="p">:</span> <span class="n">markers</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">markers</span><span class="p">)]</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>        <span class="p">}</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>        <span class="n">cord_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">nam</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">numeric_df</span><span class="p">[</span><span class="s2">&quot;numeric_values&quot;</span><span class="p">],</span> <span class="n">numeric_df</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]):</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>            <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">umap_df</span><span class="p">[</span><span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;numeric_values&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">num</span><span class="p">]</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>                <span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;UMAP1&quot;</span><span class="p">],</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>                <span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;UMAP2&quot;</span><span class="p">],</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">nam</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>                <span class="n">marker</span><span class="o">=</span><span class="n">marker_map</span><span class="p">[</span><span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>                <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>            <span class="p">)</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>            <span class="n">coords</span> <span class="o">=</span> <span class="n">cluster_data</span><span class="p">[[</span><span class="s2">&quot;UMAP1&quot;</span><span class="p">,</span> <span class="s2">&quot;UMAP2&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>            <span class="n">dists</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>            <span class="n">sum_dists</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>            <span class="n">center_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">sum_dists</span><span class="p">)</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>            <span class="n">center_point</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">center_idx</span><span class="p">]</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>            <span class="n">cord_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">center_point</span><span class="p">)</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>        <span class="k">if</span> <span class="n">inc_num</span><span class="p">:</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>            <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>            <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cord_list</span><span class="p">,</span> <span class="n">numeric_df</span><span class="p">[</span><span class="s2">&quot;numeric_values&quot;</span><span class="p">]):</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>                <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>                        <span class="n">x</span><span class="p">,</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>                        <span class="n">y</span><span class="p">,</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>                        <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">),</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>                        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>                        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>                        <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>                    <span class="p">)</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>                <span class="p">)</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>            <span class="n">adjust_text</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">)</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">)</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Clusters&quot;</span><span class="p">,</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>            <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>            <span class="n">ncol</span><span class="o">=</span><span class="n">legend_split_col</span><span class="p">,</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>            <span class="n">markerscale</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>        <span class="p">)</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">UMAP_feature</span><span class="p">(</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>        <span class="n">feature_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>        <span class="n">features_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>        <span class="n">point_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>        <span class="n">font_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>        <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>        <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;light&quot;</span><span class="p">,</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>    <span class="p">):</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a><span class="sd">        Visualize UMAP embedding with expression levels of a selected feature.</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a><span class="sd">        Each point (cell) in the UMAP plot is colored according to the expression</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a><span class="sd">        value of the chosen feature, enabling interpretation of spatial patterns</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a><span class="sd">        of gene activity or metadata distribution in low-dimensional space.</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a><span class="sd">        Parameters</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a><span class="sd">        ----------</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a><span class="sd">        feature_name : str</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a><span class="sd">           Name of the feature to plot.</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a><span class="sd">        features_data : pandas.DataFrame or None, default None</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a><span class="sd">            If None, the function uses the DataFrame containing the clustering data.</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a><span class="sd">            To plot features not used in clustering, provide a wider DataFrame</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a><span class="sd">            containing the original feature values.</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a><span class="sd">        point_size : float, default 0.6</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a><span class="sd">            Size of scatter points in the plot.</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a><span class="sd">        font_size : int, default 6</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a><span class="sd">            Font size for axis labels and annotations.</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a><span class="sd">        width : int, default 8</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a><span class="sd">            Width of the matplotlib figure.</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a><span class="sd">        height : int, default 6</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a><span class="sd">            Height of the matplotlib figure.</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a><span class="sd">        palette : str, default &#39;light&#39;</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a><span class="sd">            Color palette for expression visualization. Options are:</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a><span class="sd">            - &#39;light&#39;</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a><span class="sd">            - &#39;dark&#39;</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a><span class="sd">            - &#39;green&#39;</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a><span class="sd">            - &#39;gray&#39;</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a><span class="sd">        Returns</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a><span class="sd">        -------</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a><span class="sd">            UMAP scatter plot colored by feature values.</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>        <span class="n">umap_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">umap</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>        <span class="k">if</span> <span class="n">features_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>            <span class="n">features_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_data</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>        <span class="k">if</span> <span class="n">features_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">umap_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>                <span class="s2">&quot;Imputed &#39;features_data&#39; shape does not match the number of UMAP cells&quot;</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>            <span class="p">)</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>        <span class="n">blist</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>            <span class="kc">True</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">feature_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">features_data</span><span class="o">.</span><span class="n">index</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>        <span class="p">]</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">blist</span><span class="p">):</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Imputed feature_name is not included in the data&quot;</span><span class="p">)</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>        <span class="n">umap_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;feature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>            <span class="n">features_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">blist</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>            <span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>        <span class="p">)</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>        <span class="n">umap_df</span> <span class="o">=</span> <span class="n">umap_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;feature&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mcolors</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>        <span class="k">if</span> <span class="n">palette</span> <span class="o">==</span> <span class="s2">&quot;light&quot;</span><span class="p">:</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>            <span class="n">palette</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">sequential</span><span class="o">.</span><span class="n">Sunsetdark</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>        <span class="k">elif</span> <span class="n">palette</span> <span class="o">==</span> <span class="s2">&quot;dark&quot;</span><span class="p">:</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>            <span class="n">palette</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">sequential</span><span class="o">.</span><span class="n">thermal</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>        <span class="k">elif</span> <span class="n">palette</span> <span class="o">==</span> <span class="s2">&quot;green&quot;</span><span class="p">:</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>            <span class="n">palette</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">sequential</span><span class="o">.</span><span class="n">Aggrnyl</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>        <span class="k">elif</span> <span class="n">palette</span> <span class="o">==</span> <span class="s2">&quot;gray&quot;</span><span class="p">:</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>            <span class="n">palette</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">sequential</span><span class="o">.</span><span class="n">gray</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>            <span class="n">palette</span> <span class="o">=</span> <span class="n">palette</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>                <span class="s1">&#39;Palette not found. Use: &quot;light&quot;, &quot;dark&quot;, &quot;gray&quot;, or &quot;green&quot;&#39;</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>            <span class="p">)</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>        <span class="n">converted</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">palette</span><span class="p">:</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>            <span class="n">rgb_255</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">unlabel_rgb</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>            <span class="n">rgb_01</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span> <span class="o">/</span> <span class="mf">255.0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rgb_255</span><span class="p">)</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>            <span class="n">converted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rgb_01</span><span class="p">)</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>        <span class="n">my_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">converted</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;custom&quot;</span><span class="p">)</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="n">sc</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>            <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;UMAP1&quot;</span><span class="p">],</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>            <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;UMAP2&quot;</span><span class="p">],</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>            <span class="n">c</span><span class="o">=</span><span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">],</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>            <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>            <span class="n">cmap</span><span class="o">=</span><span class="n">my_cmap</span><span class="p">,</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>            <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>            <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>        <span class="p">)</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feature_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">)</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">)</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_umap_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a><span class="sd">        Retrieve UMAP embedding data with optional cluster labels.</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a><span class="sd">        Returns the UMAP coordinates stored in `self.umap`. If clustering</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a><span class="sd">        metadata is available (specifically `UMAP_clusters`), the corresponding</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a><span class="sd">        cluster assignments are appended as an additional column.</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a><span class="sd">        Returns</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a><span class="sd">        -------</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a><span class="sd">        pandas.DataFrame</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a><span class="sd">            DataFrame containing UMAP coordinates (columns: &#39;UMAP1&#39;, &#39;UMAP2&#39;, ...).</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a><span class="sd">            If available, includes an extra column &#39;clusters&#39; with cluster labels.</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a><span class="sd">        Notes</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a><span class="sd">        -----</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a><span class="sd">        - UMAP embeddings must be computed beforehand (e.g., using `perform_UMAP`).</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a><span class="sd">        - Cluster labels are added only if present in `self.clustering_metadata`.</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>        <span class="n">umap_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">umap</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>            <span class="n">umap_data</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;UMAP_clusters&quot;</span><span class="p">]</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>            <span class="k">pass</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>        <span class="k">return</span> <span class="n">umap_data</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_pca_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a><span class="sd">        Retrieve PCA embedding data with optional cluster labels.</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a><span class="sd">        Returns the principal component scores stored in `self.pca`. If clustering</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a><span class="sd">        metadata is available (specifically `PCA_clusters`), the corresponding</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a><span class="sd">        cluster assignments are appended as an additional column.</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a><span class="sd">        Returns</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a><span class="sd">        -------</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a><span class="sd">        pandas.DataFrame</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a><span class="sd">            DataFrame containing PCA coordinates (columns: &#39;PC1&#39;, &#39;PC2&#39;, ...).</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a><span class="sd">            If available, includes an extra column &#39;clusters&#39; with cluster labels.</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a><span class="sd">        Notes</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a><span class="sd">        -----</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a><span class="sd">        - PCA must be computed beforehand (e.g., using `perform_PCA`).</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a><span class="sd">        - Cluster labels are added only if present in `self.clustering_metadata`.</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>        <span class="n">pca_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>            <span class="n">pca_data</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;PCA_clusters&quot;</span><span class="p">]</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>            <span class="k">pass</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>        <span class="k">return</span> <span class="n">pca_data</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">return_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clusters</span><span class="o">=</span><span class="s2">&quot;umap&quot;</span><span class="p">):</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a><span class="sd">        Retrieve cluster labels from UMAP or PCA clustering results.</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a><span class="sd">        Parameters</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a><span class="sd">        ----------</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a><span class="sd">        clusters : str, default &#39;umap&#39;</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a><span class="sd">            Source of cluster labels to return. Must be one of:</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a><span class="sd">            - &#39;umap&#39;: return cluster labels from UMAP embeddings.</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a><span class="sd">            - &#39;pca&#39; : return cluster labels from PCA embeddings.</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a><span class="sd">        Returns</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a><span class="sd">        -------</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a><span class="sd">        list</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a><span class="sd">            Cluster labels corresponding to the selected embedding method.</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a><span class="sd">        Raises</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a><span class="sd">        ------</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a><span class="sd">        ValueError</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a><span class="sd">            If `clusters` is not &#39;umap&#39; or &#39;pca&#39;.</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a><span class="sd">        Notes</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a><span class="sd">        -----</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a><span class="sd">        Requires that clustering has already been performed</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a><span class="sd">        (e.g., using `find_clusters_UMAP` or `find_clusters_PCA`).</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>        <span class="k">if</span> <span class="n">clusters</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;umap&quot;</span><span class="p">:</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>            <span class="n">clusters_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;UMAP_clusters&quot;</span><span class="p">]</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>        <span class="k">elif</span> <span class="n">clusters</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;pca&quot;</span><span class="p">:</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>            <span class="n">clusters_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;PCA_clusters&quot;</span><span class="p">]</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parameter &#39;clusters&#39; must be either &#39;umap&#39; or &#39;pca&#39;.&quot;</span><span class="p">)</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>        <span class="k">return</span> <span class="n">clusters_vector</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a><span class="k">class</span><span class="w"> </span><span class="nc">COMPsc</span><span class="p">(</span><span class="n">Clustering</span><span class="p">):</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a><span class="sd">    A class `COMPsc` (Comparison of single-cell data) designed for the integration,</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a><span class="sd">    analysis, and visualization of single-cell datasets.</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a><span class="sd">    The class supports independent dataset integration, subclustering of existing clusters,</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a><span class="sd">    marker detection, and multiple visualization strategies.</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a><span class="sd">    The COMPsc class provides methods for:</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a><span class="sd">        - Normalizing and filtering single-cell data</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a><span class="sd">        - Loading and saving sparse 10x-style datasets</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a><span class="sd">        - Computing differential expression and marker genes</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a><span class="sd">        - Clustering and subclustering analysis</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a><span class="sd">        - Visualizing similarity and spatial relationships</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a><span class="sd">        - Aggregating data by cell and set annotations</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a><span class="sd">        - Managing metadata and renaming labels</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a><span class="sd">        - Plotting gene detection histograms and feature scatters</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a><span class="sd">    Methods</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a><span class="sd">    -------</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a><span class="sd">    project_dir(path_to_directory, project_list)</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a><span class="sd">        Scans a directory to create a COMPsc instance mapping project names to their paths.</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a><span class="sd">    save_project(name, path=os.getcwd())</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a><span class="sd">        Saves the COMPsc object to a pickle file on disk.</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a><span class="sd">    load_project(path)</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a><span class="sd">        Loads a previously saved COMPsc object from a pickle file.</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a><span class="sd">    reduce_cols(reg, inc_set=False)</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a><span class="sd">        Removes columns from data tables where column names contain a specified name or partial substring.</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a><span class="sd">    reduce_rows(reg, inc_set=False)</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a><span class="sd">        Removes rows from data tables where column names contain a specified feature (gene) name.</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a><span class="sd">    get_data(set_info=False)</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a><span class="sd">        Returns normalized data with optional set annotations in column names.</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a><span class="sd">    get_metadata()</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a><span class="sd">        Returns the stored input metadata.</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a><span class="sd">    get_partial_data(names=None, features=None, name_slot=&#39;cell_names&#39;)</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a><span class="sd">        Return a subset of the data by sample names and/or features.</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a><span class="sd">    gene_calculation()</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a><span class="sd">        Calculates and stores per-cell gene detection counts as a pandas Series.</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a><span class="sd">    gene_histograme(bins=100)</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a><span class="sd">        Plots a histogram of genes detected per cell with an overlaid normal distribution.</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a><span class="sd">    gene_threshold(min_n=None, max_n=None)</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a><span class="sd">        Filters cells based on minimum and/or maximum gene detection thresholds.</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a><span class="sd">    load_sparse_from_projects(normalized_data=False)</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a><span class="sd">        Loads and concatenates sparse 10x-style datasets from project paths into count or normalized data.</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a><span class="sd">    rename_names(mapping, slot=&#39;cell_names&#39;)</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a><span class="sd">        Renames entries in a specified metadata column using a provided mapping dictionary.</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a><span class="sd">    rename_subclusters(mapping)</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a><span class="sd">        Renames subcluster labels using a provided mapping dictionary.</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a><span class="sd">    save_sparse(path_to_save=os.getcwd(), name_slot=&#39;cell_names&#39;, data_slot=&#39;normalized&#39;)</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a><span class="sd">        Exports data as 10x-compatible sparse files (matrix.mtx, barcodes.tsv, genes.tsv).</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a><span class="sd">    normalize_data(normalize=True, normalize_factor=100000)</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a><span class="sd">        Normalizes raw counts to counts-per-specified factor (e.g., CPM-like).</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a><span class="sd">    statistic(cells=None, sets=None, min_exp=0.01, min_pct=0.1, n_proc=10)</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a><span class="sd">        Computes per-feature differential expression statistics (Mann-Whitney U) comparing target vs. rest groups.</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a><span class="sd">    calculate_difference_markers(min_exp=0, min_pct=0.25, n_proc=10, force=False)</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a><span class="sd">        Computes and caches differential markers using the statistic method.</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a><span class="sd">    clustering_features(features_list=None, name_slot=&#39;cell_names&#39;, p_val=0.05, top_n=25, adj_mean=True, beta=0.4)</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a><span class="sd">        Prepares clustering input by selecting marker features and optionally smoothing cell values.</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a><span class="sd">    average()</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a><span class="sd">        Aggregates normalized data by averaging across (cell_name, set) pairs.</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a><span class="sd">    estimating_similarity(method=&#39;pearson&#39;, p_val=0.05, top_n=25)</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a><span class="sd">        Computes pairwise correlation and Euclidean distance between aggregated samples.</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a><span class="sd">    similarity_plot(split_sets=True, set_info=True, cmap=&#39;seismic&#39;, width=12, height=10)</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a><span class="sd">        Visualizes pairwise similarity as a scatter plot with correlation as hue and scaled distance as point size.</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a><span class="sd">    spatial_similarity(set_info=True, bandwidth=1, n_neighbors=5, min_dist=0.1, legend_split=2, point_size=20, ...)</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a><span class="sd">        Creates a UMAP-like visualization of similarity relationships with cluster hulls and nearest-neighbor arrows.</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a><span class="sd">    subcluster_prepare(features, cluster)</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a><span class="sd">        Initializes a Clustering object for subcluster analysis on a selected parent cluster.</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a><span class="sd">    define_subclusters(umap_num=2, eps=0.5, min_samples=10, bandwidth=1, n_neighbors=5, min_dist=0.1, ...)</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a><span class="sd">        Performs UMAP and DBSCAN clustering on prepared subcluster data and stores cluster labels.</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a><span class="sd">    subcluster_features_scatter(colors=&#39;viridis&#39;, hclust=&#39;complete&#39;, img_width=3, img_high=5, label_size=6, ...)</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a><span class="sd">        Visualizes averaged expression and occurrence of features for subclusters as a scatter plot.</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a><span class="sd">    subcluster_DEG_scatter(top_n=3, min_exp=0, min_pct=0.25, p_val=0.05, colors=&#39;viridis&#39;, ...)</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a><span class="sd">        Plots top differential features for subclusters as a features-scatter visualization.</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a><span class="sd">    accept_subclusters()</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a><span class="sd">        Commits subcluster labels to main metadata by renaming cell names and clears subcluster data.</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a><span class="sd">    Raises</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a><span class="sd">    ------</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a><span class="sd">    ValueError</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a><span class="sd">        For invalid parameters, mismatched dimensions, or missing metadata.</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>        <span class="n">objects</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>    <span class="p">):</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a><span class="sd">        Initialize the COMPsc class for single-cell data integration and analysis.</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a><span class="sd">        Parameters</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a><span class="sd">        ----------</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a><span class="sd">        objects : list or None, optional</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a><span class="sd">            Optional list of data objects to initialize the instance with.</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a><span class="sd">        Attributes</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a><span class="sd">        ----------</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a><span class="sd">        -objects : list or None</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a><span class="sd">        -input_data : pandas.DataFrame or None</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a><span class="sd">        -input_metadata : pandas.DataFrame or None</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a><span class="sd">        -normalized_data : pandas.DataFrame or None</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a><span class="sd">        -agg_metadata : pandas.DataFrame or None</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a><span class="sd">        -agg_normalized_data : pandas.DataFrame or None</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a><span class="sd">        -similarity : pandas.DataFrame or None</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a><span class="sd">        -var_data : pandas.DataFrame or None</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a><span class="sd">        -subclusters_ : instance of Clustering class or None</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a><span class="sd">        -cells_calc : pandas.Series or None</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a><span class="sd">        -gene_calc : pandas.Series or None</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a><span class="sd">        -composition_data : pandas.DataFrame or None</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="n">objects</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Stores the input data objects.&quot;&quot;&quot;</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Raw input data for clustering or integration analysis.&quot;&quot;&quot;</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Metadata associated with the input data.&quot;&quot;&quot;</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalized version of the input data.&quot;&quot;&quot;</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Aggregated metadata for all sets in object related to &quot;agg_normalized_data&quot;&#39;&#39;&#39;</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregated and normalized data across multiple sets.&quot;&quot;&quot;</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Similarity data between cells across all samples. and sets&quot;&quot;&quot;</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;DEG analysis results summarizing variance across all samples in the object.&quot;&quot;&quot;</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Placeholder for information about subclusters analysis; if computed.&quot;&quot;&quot;</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of cells detected per sample (grouped by lineage, e.g., cluster or name), reflecting data composition.&quot;&quot;&quot;</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of genes detected per sample (cell), reflecting the sequencing depth.&quot;&quot;&quot;</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">composition_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Data describing composition of cells across clusters or sets.&quot;&quot;&quot;</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">project_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path_to_directory</span><span class="p">,</span> <span class="n">project_list</span><span class="p">):</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a><span class="sd">        Scan a directory and build a COMPsc instance mapping provided project names</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a><span class="sd">        to their paths.</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a><span class="sd">        Parameters</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a><span class="sd">        ----------</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a><span class="sd">        path_to_directory : str</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a><span class="sd">            Path containing project subfolders.</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a><span class="sd">        project_list : list[str]</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a><span class="sd">            List of filenames (folder names) to include in the returned object map.</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a><span class="sd">        Returns</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a><span class="sd">        -------</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a><span class="sd">        COMPsc</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a><span class="sd">            New COMPsc instance with `objects` populated.</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a><span class="sd">        Raises</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a><span class="sd">        ------</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a><span class="sd">        Exception</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a><span class="sd">            A generic exception is caught and a message printed if scanning fails.</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a><span class="sd">        Notes</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a><span class="sd">        -----</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a><span class="sd">        Function attempts to match entries in `project_list` to directory</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a><span class="sd">        names and constructs a simplified object key from the folder name.</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>            <span class="n">objects</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path_to_directory</span><span class="p">)):</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">project_list</span><span class="p">:</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>                    <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>                    <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">filename</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>                        <span class="n">objects</span><span class="p">[</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>                            <span class="nb">str</span><span class="p">(</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>                                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>                                    <span class="s2">&quot;_count&quot;</span><span class="p">,</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>                                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>                                    <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>                                        <span class="s2">&quot;_fq&quot;</span><span class="p">,</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>                                        <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>                                        <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>                                            <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;_.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>                                            <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>                                            <span class="n">filename</span><span class="p">,</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>                                        <span class="p">),</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>                                    <span class="p">),</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>                                <span class="p">)</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>                            <span class="p">)</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>                        <span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()):</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a><span class="sd">        Save the COMPsc object to disk using pickle.</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a><span class="sd">        Parameters</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a><span class="sd">        ----------</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a><span class="sd">        name : str</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a><span class="sd">            Base filename (without extension) to use when saving.</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a><span class="sd">        path : str, default os.getcwd()</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a><span class="sd">            Directory in which to save the project file.</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a><span class="sd">        Returns</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a><span class="sd">        -------</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a><span class="sd">        None</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a><span class="sd">        Side Effects</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a><span class="sd">        ------------</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a><span class="sd">        - Writes a file `&lt;path&gt;/&lt;name&gt;.jpkl` containing the pickled object.</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a><span class="sd">        - Prints a confirmation message with saved path.</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>        <span class="n">full</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.jpkl&quot;</span><span class="p">)</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project saved as </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_project</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a><span class="sd">        Load a previously saved COMPsc project from a pickle file.</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a><span class="sd">        Parameters</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a><span class="sd">        ----------</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a><span class="sd">        path : str</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a><span class="sd">            Full path to the pickled project file.</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a><span class="sd">        Returns</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a><span class="sd">        -------</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a><span class="sd">        COMPsc</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a><span class="sd">            The unpickled COMPsc object.</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a><span class="sd">        Raises</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a><span class="sd">        ------</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a><span class="sd">        FileNotFoundError</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a><span class="sd">            If the provided path does not exist.</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;File does not exist!&quot;</span><span class="p">)</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>        <span class="k">return</span> <span class="n">obj</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reduce_cols</span><span class="p">(</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>        <span class="n">reg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>        <span class="n">full</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>        <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>        <span class="n">inc_set</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>    <span class="p">):</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a><span class="sd">        Remove columns (cells) whose names contain a substring `reg` or</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a><span class="sd">        full name `full` from available tables.</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a><span class="sd">        Parameters</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a><span class="sd">        ----------</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a><span class="sd">        reg : str | None</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a><span class="sd">            Substring to search for in column/cell names; matching columns will be removed.</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a><span class="sd">            If not None, `full` must be None.</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a><span class="sd">        full : str | None</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a><span class="sd">            Full name to search for in column/cell names; matching columns will be removed.</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a><span class="sd">            If not None, `reg` must be None.</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a><span class="sd">            Column in metadata to use as sample names.</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a><span class="sd">        inc_set : bool, default False</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a><span class="sd">            If True, column names are interpreted as &#39;cell_name # set&#39; when matching.</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a><span class="sd">        Update</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a><span class="sd">        ------------</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a><span class="sd">        Mutates `self.input_data`, `self.normalized_data`, `self.input_metadata`,</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a><span class="sd">        `self.agg_normalized_data`, and `self.agg_metadata` (if they exist),</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a><span class="sd">        removing columns/rows that match `reg`.</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a><span class="sd">        Raises</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a><span class="sd">        ------</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a><span class="sd">        Raises ValueError if nothing matches the reduction mask.</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>        <span class="k">if</span> <span class="n">reg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">full</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>                <span class="s2">&quot;Both &#39;reg&#39; and &#39;full&#39; arguments not provided. Please provide at least one of them!&quot;</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>            <span class="p">)</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>        <span class="k">if</span> <span class="n">reg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">full</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>                <span class="s2">&quot;Both &#39;reg&#39; and &#39;full&#39; arguments are provided. &quot;</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>                <span class="s2">&quot;Please provide only one of them!</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>                <span class="s2">&quot;&#39;reg&#39; is used when only part of the name must be detected.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>                <span class="s2">&quot;&#39;full&#39; is used if the full name must be detected.&quot;</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>            <span class="p">)</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>        <span class="k">if</span> <span class="n">reg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>                        <span class="o">+</span> <span class="s2">&quot; # &quot;</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>                    <span class="p">)</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">reg</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>                        <span class="o">+</span> <span class="s2">&quot; # &quot;</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>                    <span class="p">)</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>                    <span class="n">reg</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>                <span class="p">]</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>                        <span class="o">+</span> <span class="s2">&quot; # &quot;</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>                    <span class="p">)</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>                    <span class="n">reg</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>                <span class="p">]</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>                    <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>                <span class="p">)</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>                <span class="p">)</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>                    <span class="p">)</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>                    <span class="n">reg</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>                <span class="p">]</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>                    <span class="p">)</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">reg</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]]</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>                    <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>                <span class="p">)</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>                <span class="p">)</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>        <span class="k">elif</span> <span class="n">full</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>                        <span class="o">+</span> <span class="s2">&quot; # &quot;</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>                    <span class="p">)</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>                    <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">full</span><span class="p">:</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>                            <span class="s2">&quot;Not include the set info (name # set) in the &#39;full&#39; argument, where &#39;inc_set&#39; is True&quot;</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>                            <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>                        <span class="p">)</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">full</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>                        <span class="o">+</span> <span class="s2">&quot; # &quot;</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>                    <span class="p">)</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>                    <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">full</span><span class="p">:</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>                            <span class="s2">&quot;Not include the set info (name # set) in the &#39;full&#39; argument, where &#39;inc_set&#39; is True&quot;</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>                            <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>                        <span class="p">)</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">full</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>                        <span class="o">+</span> <span class="s2">&quot; # &quot;</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>                    <span class="p">)</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>                    <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">full</span><span class="p">:</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>                            <span class="s2">&quot;Not include the set info (name # set) in the &#39;full&#39; argument, where &#39;inc_set&#39; is True&quot;</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>                            <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>                        <span class="p">)</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">full</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]]</span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>                    <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>                <span class="p">)</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>                <span class="p">)</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>                    <span class="p">)</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>                    <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">full</span><span class="p">:</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>                            <span class="s2">&quot;Not include the set info (name # set) in the &#39;full&#39; argument, where &#39;inc_set&#39; is True&quot;</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>                            <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>                        <span class="p">)</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>                    <span class="n">full</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>                <span class="p">]</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>                    <span class="p">)</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>                    <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">full</span><span class="p">:</span>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>                            <span class="s2">&quot;Not include the set info (name # set) in the &#39;full&#39; argument, where &#39;inc_set&#39; is True&quot;</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>                            <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>                        <span class="p">)</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">full</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]]</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>                    <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>                <span class="p">)</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a>                <span class="p">)</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_calculation</span><span class="p">()</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">()</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reduce_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a><span class="sd">        Remove rows (features) whose names are included in features_list.</span>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a><span class="sd">        Parameters</span>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a><span class="sd">        ----------</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a><span class="sd">        features_list : list</span>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a><span class="sd">            List of features to search for in index/gene names; matching entries will be removed.</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a><span class="sd">        Update</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a><span class="sd">        ------------</span>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a><span class="sd">        Mutates `self.input_data`, `self.normalized_data`, `self.input_metadata`,</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a><span class="sd">        `self.agg_normalized_data`, and `self.agg_metadata` (if they exist),</span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a><span class="sd">        removing columns/rows that match `reg`.</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a><span class="sd">        Raises</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a><span class="sd">        ------</span>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a><span class="sd">        Prints a message listing features that are not found in the data.</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">find_features</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features_list</span><span class="p">)</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a>            <span class="n">res_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;included&quot;</span><span class="p">]]</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res_list</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">find_features</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features_list</span><span class="p">)</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a>            <span class="n">res_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;included&quot;</span><span class="p">]]</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res_list</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">find_features</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features_list</span><span class="p">)</span>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a>            <span class="n">res_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;included&quot;</span><span class="p">]]</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res_list</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;not_included&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Features not found:&quot;</span><span class="p">)</span>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;not_included&quot;</span><span class="p">]:</span>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_calculation</span><span class="p">()</span>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">()</span>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_info</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a><span class="sd">        Return normalized data with optional set annotation appended to column names.</span>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a><span class="sd">        Parameters</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a><span class="sd">        ----------</span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a><span class="sd">        set_info : bool, default False</span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a><span class="sd">            If True, column names are returned as &quot;cell_name # set&quot;; otherwise</span>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a><span class="sd">            only the `cell_name` is used.</span>
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a>
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a><span class="sd">        Returns</span>
</span><span id="L-1737"><a href="#L-1737"><span class="linenos">1737</span></a><span class="sd">        -------</span>
</span><span id="L-1738"><a href="#L-1738"><span class="linenos">1738</span></a><span class="sd">        pandas.DataFrame</span>
</span><span id="L-1739"><a href="#L-1739"><span class="linenos">1739</span></a><span class="sd">            The `self.normalized_data` table with columns renamed according to `set_info`.</span>
</span><span id="L-1740"><a href="#L-1740"><span class="linenos">1740</span></a>
</span><span id="L-1741"><a href="#L-1741"><span class="linenos">1741</span></a><span class="sd">        Raises</span>
</span><span id="L-1742"><a href="#L-1742"><span class="linenos">1742</span></a><span class="sd">        ------</span>
</span><span id="L-1743"><a href="#L-1743"><span class="linenos">1743</span></a><span class="sd">        AttributeError</span>
</span><span id="L-1744"><a href="#L-1744"><span class="linenos">1744</span></a><span class="sd">            If `self.normalized_data` or `self.input_metadata` is missing.</span>
</span><span id="L-1745"><a href="#L-1745"><span class="linenos">1745</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1746"><a href="#L-1746"><span class="linenos">1746</span></a>
</span><span id="L-1747"><a href="#L-1747"><span class="linenos">1747</span></a>        <span class="n">to_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span>
</span><span id="L-1748"><a href="#L-1748"><span class="linenos">1748</span></a>
</span><span id="L-1749"><a href="#L-1749"><span class="linenos">1749</span></a>        <span class="k">if</span> <span class="n">set_info</span><span class="p">:</span>
</span><span id="L-1750"><a href="#L-1750"><span class="linenos">1750</span></a>            <span class="n">to_return</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1751"><a href="#L-1751"><span class="linenos">1751</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-1752"><a href="#L-1752"><span class="linenos">1752</span></a>            <span class="p">)</span>
</span><span id="L-1753"><a href="#L-1753"><span class="linenos">1753</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1754"><a href="#L-1754"><span class="linenos">1754</span></a>            <span class="n">to_return</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span>
</span><span id="L-1755"><a href="#L-1755"><span class="linenos">1755</span></a>
</span><span id="L-1756"><a href="#L-1756"><span class="linenos">1756</span></a>        <span class="k">return</span> <span class="n">to_return</span>
</span><span id="L-1757"><a href="#L-1757"><span class="linenos">1757</span></a>
</span><span id="L-1758"><a href="#L-1758"><span class="linenos">1758</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_partial_data</span><span class="p">(</span>
</span><span id="L-1759"><a href="#L-1759"><span class="linenos">1759</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1760"><a href="#L-1760"><span class="linenos">1760</span></a>        <span class="n">names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1761"><a href="#L-1761"><span class="linenos">1761</span></a>        <span class="n">features</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1762"><a href="#L-1762"><span class="linenos">1762</span></a>        <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="L-1763"><a href="#L-1763"><span class="linenos">1763</span></a>        <span class="n">inc_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1764"><a href="#L-1764"><span class="linenos">1764</span></a>    <span class="p">):</span>
</span><span id="L-1765"><a href="#L-1765"><span class="linenos">1765</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1766"><a href="#L-1766"><span class="linenos">1766</span></a><span class="sd">        Return a subset of the data filtered by sample names and/or feature names.</span>
</span><span id="L-1767"><a href="#L-1767"><span class="linenos">1767</span></a>
</span><span id="L-1768"><a href="#L-1768"><span class="linenos">1768</span></a><span class="sd">        Parameters</span>
</span><span id="L-1769"><a href="#L-1769"><span class="linenos">1769</span></a><span class="sd">        ----------</span>
</span><span id="L-1770"><a href="#L-1770"><span class="linenos">1770</span></a><span class="sd">        names : list, str, or None</span>
</span><span id="L-1771"><a href="#L-1771"><span class="linenos">1771</span></a><span class="sd">            Names of samples to include. If None, all samples are considered.</span>
</span><span id="L-1772"><a href="#L-1772"><span class="linenos">1772</span></a>
</span><span id="L-1773"><a href="#L-1773"><span class="linenos">1773</span></a><span class="sd">        features : list, str, or None</span>
</span><span id="L-1774"><a href="#L-1774"><span class="linenos">1774</span></a><span class="sd">            Names of features to include. If None, all features are considered.</span>
</span><span id="L-1775"><a href="#L-1775"><span class="linenos">1775</span></a>
</span><span id="L-1776"><a href="#L-1776"><span class="linenos">1776</span></a><span class="sd">        name_slot : str</span>
</span><span id="L-1777"><a href="#L-1777"><span class="linenos">1777</span></a><span class="sd">            Column in metadata to use as sample names.</span>
</span><span id="L-1778"><a href="#L-1778"><span class="linenos">1778</span></a>
</span><span id="L-1779"><a href="#L-1779"><span class="linenos">1779</span></a><span class="sd">        inc_metadata : bool</span>
</span><span id="L-1780"><a href="#L-1780"><span class="linenos">1780</span></a><span class="sd">            If True return tuple (data, metadata)</span>
</span><span id="L-1781"><a href="#L-1781"><span class="linenos">1781</span></a>
</span><span id="L-1782"><a href="#L-1782"><span class="linenos">1782</span></a><span class="sd">        Returns</span>
</span><span id="L-1783"><a href="#L-1783"><span class="linenos">1783</span></a><span class="sd">        -------</span>
</span><span id="L-1784"><a href="#L-1784"><span class="linenos">1784</span></a><span class="sd">        pandas.DataFrame</span>
</span><span id="L-1785"><a href="#L-1785"><span class="linenos">1785</span></a><span class="sd">            Subset of the normalized data based on the specified names and features.</span>
</span><span id="L-1786"><a href="#L-1786"><span class="linenos">1786</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1787"><a href="#L-1787"><span class="linenos">1787</span></a>
</span><span id="L-1788"><a href="#L-1788"><span class="linenos">1788</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1789"><a href="#L-1789"><span class="linenos">1789</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span>
</span><span id="L-1790"><a href="#L-1790"><span class="linenos">1790</span></a>
</span><span id="L-1791"><a href="#L-1791"><span class="linenos">1791</span></a>        <span class="k">if</span> <span class="n">name_slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-1792"><a href="#L-1792"><span class="linenos">1792</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-1793"><a href="#L-1793"><span class="linenos">1793</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1794"><a href="#L-1794"><span class="linenos">1794</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;name_slot&#39; not occured in data!&#39;&quot;</span><span class="p">)</span>
</span><span id="L-1795"><a href="#L-1795"><span class="linenos">1795</span></a>
</span><span id="L-1796"><a href="#L-1796"><span class="linenos">1796</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-1797"><a href="#L-1797"><span class="linenos">1797</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">features</span><span class="p">]</span>
</span><span id="L-1798"><a href="#L-1798"><span class="linenos">1798</span></a>        <span class="k">elif</span> <span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1799"><a href="#L-1799"><span class="linenos">1799</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1800"><a href="#L-1800"><span class="linenos">1800</span></a>
</span><span id="L-1801"><a href="#L-1801"><span class="linenos">1801</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-1802"><a href="#L-1802"><span class="linenos">1802</span></a>            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">names</span><span class="p">]</span>
</span><span id="L-1803"><a href="#L-1803"><span class="linenos">1803</span></a>        <span class="k">elif</span> <span class="n">names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1804"><a href="#L-1804"><span class="linenos">1804</span></a>            <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1805"><a href="#L-1805"><span class="linenos">1805</span></a>
</span><span id="L-1806"><a href="#L-1806"><span class="linenos">1806</span></a>        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">features</span><span class="p">]</span>
</span><span id="L-1807"><a href="#L-1807"><span class="linenos">1807</span></a>        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
</span><span id="L-1808"><a href="#L-1808"><span class="linenos">1808</span></a>
</span><span id="L-1809"><a href="#L-1809"><span class="linenos">1809</span></a>        <span class="n">columns_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-1810"><a href="#L-1810"><span class="linenos">1810</span></a>        <span class="n">features_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-1811"><a href="#L-1811"><span class="linenos">1811</span></a>
</span><span id="L-1812"><a href="#L-1812"><span class="linenos">1812</span></a>        <span class="n">columns_bool</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">columns_names</span><span class="p">]</span>
</span><span id="L-1813"><a href="#L-1813"><span class="linenos">1813</span></a>        <span class="n">features_bool</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">features</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">features_names</span><span class="p">]</span>
</span><span id="L-1814"><a href="#L-1814"><span class="linenos">1814</span></a>
</span><span id="L-1815"><a href="#L-1815"><span class="linenos">1815</span></a>        <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns_bool</span> <span class="ow">and</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">features_bool</span><span class="p">:</span>
</span><span id="L-1816"><a href="#L-1816"><span class="linenos">1816</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Missing &#39;names&#39; and/or &#39;features&#39;. Returning full dataset instead.&quot;</span><span class="p">)</span>
</span><span id="L-1817"><a href="#L-1817"><span class="linenos">1817</span></a>            <span class="k">if</span> <span class="n">inc_metadata</span><span class="p">:</span>
</span><span id="L-1818"><a href="#L-1818"><span class="linenos">1818</span></a>                <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span>
</span><span id="L-1819"><a href="#L-1819"><span class="linenos">1819</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1820"><a href="#L-1820"><span class="linenos">1820</span></a>                <span class="k">return</span> <span class="n">data</span>
</span><span id="L-1821"><a href="#L-1821"><span class="linenos">1821</span></a>
</span><span id="L-1822"><a href="#L-1822"><span class="linenos">1822</span></a>        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">columns_bool</span><span class="p">:</span>
</span><span id="L-1823"><a href="#L-1823"><span class="linenos">1823</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">columns_bool</span><span class="p">]</span>
</span><span id="L-1824"><a href="#L-1824"><span class="linenos">1824</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">columns_bool</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1825"><a href="#L-1825"><span class="linenos">1825</span></a>
</span><span id="L-1826"><a href="#L-1826"><span class="linenos">1826</span></a>            <span class="k">if</span> <span class="n">inc_metadata</span><span class="p">:</span>
</span><span id="L-1827"><a href="#L-1827"><span class="linenos">1827</span></a>                <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span>
</span><span id="L-1828"><a href="#L-1828"><span class="linenos">1828</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1829"><a href="#L-1829"><span class="linenos">1829</span></a>                <span class="k">return</span> <span class="n">data</span>
</span><span id="L-1830"><a href="#L-1830"><span class="linenos">1830</span></a>
</span><span id="L-1831"><a href="#L-1831"><span class="linenos">1831</span></a>        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">features_bool</span><span class="p">:</span>
</span><span id="L-1832"><a href="#L-1832"><span class="linenos">1832</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">features_bool</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1833"><a href="#L-1833"><span class="linenos">1833</span></a>
</span><span id="L-1834"><a href="#L-1834"><span class="linenos">1834</span></a>            <span class="k">if</span> <span class="n">inc_metadata</span><span class="p">:</span>
</span><span id="L-1835"><a href="#L-1835"><span class="linenos">1835</span></a>                <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span>
</span><span id="L-1836"><a href="#L-1836"><span class="linenos">1836</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1837"><a href="#L-1837"><span class="linenos">1837</span></a>                <span class="k">return</span> <span class="n">data</span>
</span><span id="L-1838"><a href="#L-1838"><span class="linenos">1838</span></a>
</span><span id="L-1839"><a href="#L-1839"><span class="linenos">1839</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1840"><a href="#L-1840"><span class="linenos">1840</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1841"><a href="#L-1841"><span class="linenos">1841</span></a><span class="sd">        Return the stored input metadata.</span>
</span><span id="L-1842"><a href="#L-1842"><span class="linenos">1842</span></a>
</span><span id="L-1843"><a href="#L-1843"><span class="linenos">1843</span></a><span class="sd">        Returns</span>
</span><span id="L-1844"><a href="#L-1844"><span class="linenos">1844</span></a><span class="sd">        -------</span>
</span><span id="L-1845"><a href="#L-1845"><span class="linenos">1845</span></a><span class="sd">        pandas.DataFrame</span>
</span><span id="L-1846"><a href="#L-1846"><span class="linenos">1846</span></a><span class="sd">            `self.input_metadata` (may be None if not set).</span>
</span><span id="L-1847"><a href="#L-1847"><span class="linenos">1847</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1848"><a href="#L-1848"><span class="linenos">1848</span></a>
</span><span id="L-1849"><a href="#L-1849"><span class="linenos">1849</span></a>        <span class="n">to_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span>
</span><span id="L-1850"><a href="#L-1850"><span class="linenos">1850</span></a>
</span><span id="L-1851"><a href="#L-1851"><span class="linenos">1851</span></a>        <span class="k">return</span> <span class="n">to_return</span>
</span><span id="L-1852"><a href="#L-1852"><span class="linenos">1852</span></a>
</span><span id="L-1853"><a href="#L-1853"><span class="linenos">1853</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gene_calculation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1854"><a href="#L-1854"><span class="linenos">1854</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1855"><a href="#L-1855"><span class="linenos">1855</span></a><span class="sd">        Calculate and store per-cell counts (e.g., number of detected genes).</span>
</span><span id="L-1856"><a href="#L-1856"><span class="linenos">1856</span></a>
</span><span id="L-1857"><a href="#L-1857"><span class="linenos">1857</span></a><span class="sd">        The method computes a binary (presence/absence) per cell and sums across</span>
</span><span id="L-1858"><a href="#L-1858"><span class="linenos">1858</span></a><span class="sd">        features to produce `self.gene_calc`.</span>
</span><span id="L-1859"><a href="#L-1859"><span class="linenos">1859</span></a>
</span><span id="L-1860"><a href="#L-1860"><span class="linenos">1860</span></a><span class="sd">        Update</span>
</span><span id="L-1861"><a href="#L-1861"><span class="linenos">1861</span></a><span class="sd">        ------</span>
</span><span id="L-1862"><a href="#L-1862"><span class="linenos">1862</span></a><span class="sd">        Sets `self.gene_calc` as a pandas.Series.</span>
</span><span id="L-1863"><a href="#L-1863"><span class="linenos">1863</span></a>
</span><span id="L-1864"><a href="#L-1864"><span class="linenos">1864</span></a><span class="sd">        Side Effects</span>
</span><span id="L-1865"><a href="#L-1865"><span class="linenos">1865</span></a><span class="sd">        ------------</span>
</span><span id="L-1866"><a href="#L-1866"><span class="linenos">1866</span></a><span class="sd">        Uses `self.input_data` when available, otherwise `self.normalized_data`.</span>
</span><span id="L-1867"><a href="#L-1867"><span class="linenos">1867</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1868"><a href="#L-1868"><span class="linenos">1868</span></a>
</span><span id="L-1869"><a href="#L-1869"><span class="linenos">1869</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1870"><a href="#L-1870"><span class="linenos">1870</span></a>
</span><span id="L-1871"><a href="#L-1871"><span class="linenos">1871</span></a>            <span class="n">bin_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1872"><a href="#L-1872"><span class="linenos">1872</span></a>
</span><span id="L-1873"><a href="#L-1873"><span class="linenos">1873</span></a>            <span class="n">bin_col</span> <span class="o">=</span> <span class="n">bin_col</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bin_col</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1874"><a href="#L-1874"><span class="linenos">1874</span></a>
</span><span id="L-1875"><a href="#L-1875"><span class="linenos">1875</span></a>            <span class="n">sum_data</span> <span class="o">=</span> <span class="n">bin_col</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1876"><a href="#L-1876"><span class="linenos">1876</span></a>
</span><span id="L-1877"><a href="#L-1877"><span class="linenos">1877</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">=</span> <span class="n">sum_data</span>
</span><span id="L-1878"><a href="#L-1878"><span class="linenos">1878</span></a>
</span><span id="L-1879"><a href="#L-1879"><span class="linenos">1879</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1880"><a href="#L-1880"><span class="linenos">1880</span></a>
</span><span id="L-1881"><a href="#L-1881"><span class="linenos">1881</span></a>            <span class="n">bin_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1882"><a href="#L-1882"><span class="linenos">1882</span></a>
</span><span id="L-1883"><a href="#L-1883"><span class="linenos">1883</span></a>            <span class="n">bin_col</span> <span class="o">=</span> <span class="n">bin_col</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bin_col</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1884"><a href="#L-1884"><span class="linenos">1884</span></a>
</span><span id="L-1885"><a href="#L-1885"><span class="linenos">1885</span></a>            <span class="n">sum_data</span> <span class="o">=</span> <span class="n">bin_col</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1886"><a href="#L-1886"><span class="linenos">1886</span></a>
</span><span id="L-1887"><a href="#L-1887"><span class="linenos">1887</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">=</span> <span class="n">sum_data</span>
</span><span id="L-1888"><a href="#L-1888"><span class="linenos">1888</span></a>
</span><span id="L-1889"><a href="#L-1889"><span class="linenos">1889</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gene_histograme</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="L-1890"><a href="#L-1890"><span class="linenos">1890</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1891"><a href="#L-1891"><span class="linenos">1891</span></a><span class="sd">        Plot a histogram of the number of genes detected per cell.</span>
</span><span id="L-1892"><a href="#L-1892"><span class="linenos">1892</span></a>
</span><span id="L-1893"><a href="#L-1893"><span class="linenos">1893</span></a><span class="sd">        Parameters</span>
</span><span id="L-1894"><a href="#L-1894"><span class="linenos">1894</span></a><span class="sd">        ----------</span>
</span><span id="L-1895"><a href="#L-1895"><span class="linenos">1895</span></a><span class="sd">        bins : int, default 100</span>
</span><span id="L-1896"><a href="#L-1896"><span class="linenos">1896</span></a><span class="sd">            Number of histogram bins.</span>
</span><span id="L-1897"><a href="#L-1897"><span class="linenos">1897</span></a>
</span><span id="L-1898"><a href="#L-1898"><span class="linenos">1898</span></a><span class="sd">        Returns</span>
</span><span id="L-1899"><a href="#L-1899"><span class="linenos">1899</span></a><span class="sd">        -------</span>
</span><span id="L-1900"><a href="#L-1900"><span class="linenos">1900</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="L-1901"><a href="#L-1901"><span class="linenos">1901</span></a><span class="sd">            Figure containing the histogram of gene contents.</span>
</span><span id="L-1902"><a href="#L-1902"><span class="linenos">1902</span></a>
</span><span id="L-1903"><a href="#L-1903"><span class="linenos">1903</span></a><span class="sd">        Notes</span>
</span><span id="L-1904"><a href="#L-1904"><span class="linenos">1904</span></a><span class="sd">        -----</span>
</span><span id="L-1905"><a href="#L-1905"><span class="linenos">1905</span></a><span class="sd">        Requires `self.gene_calc` to be computed prior to calling.</span>
</span><span id="L-1906"><a href="#L-1906"><span class="linenos">1906</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1907"><a href="#L-1907"><span class="linenos">1907</span></a>
</span><span id="L-1908"><a href="#L-1908"><span class="linenos">1908</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="L-1909"><a href="#L-1909"><span class="linenos">1909</span></a>
</span><span id="L-1910"><a href="#L-1910"><span class="linenos">1910</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
</span><span id="L-1911"><a href="#L-1911"><span class="linenos">1911</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span>
</span><span id="L-1912"><a href="#L-1912"><span class="linenos">1912</span></a>        <span class="p">)</span>
</span><span id="L-1913"><a href="#L-1913"><span class="linenos">1913</span></a>
</span><span id="L-1914"><a href="#L-1914"><span class="linenos">1914</span></a>        <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">)</span>
</span><span id="L-1915"><a href="#L-1915"><span class="linenos">1915</span></a>
</span><span id="L-1916"><a href="#L-1916"><span class="linenos">1916</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="L-1917"><a href="#L-1917"><span class="linenos">1917</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="L-1918"><a href="#L-1918"><span class="linenos">1918</span></a>
</span><span id="L-1919"><a href="#L-1919"><span class="linenos">1919</span></a>        <span class="n">y_scaled</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1920"><a href="#L-1920"><span class="linenos">1920</span></a>
</span><span id="L-1921"><a href="#L-1921"><span class="linenos">1921</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="L-1922"><a href="#L-1922"><span class="linenos">1922</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y_scaled</span><span class="p">,</span> <span class="s2">&quot;r-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Normal(μ=</span><span class="si">{</span><span class="n">mu</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, σ=</span><span class="si">{</span><span class="n">sigma</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-1923"><a href="#L-1923"><span class="linenos">1923</span></a>        <span class="p">)</span>
</span><span id="L-1924"><a href="#L-1924"><span class="linenos">1924</span></a>
</span><span id="L-1925"><a href="#L-1925"><span class="linenos">1925</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>
</span><span id="L-1926"><a href="#L-1926"><span class="linenos">1926</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
</span><span id="L-1927"><a href="#L-1927"><span class="linenos">1927</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Histogram of genes detected per cell&quot;</span><span class="p">)</span>
</span><span id="L-1928"><a href="#L-1928"><span class="linenos">1928</span></a>
</span><span id="L-1929"><a href="#L-1929"><span class="linenos">1929</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">),</span> <span class="mi">20</span><span class="p">))</span>
</span><span id="L-1930"><a href="#L-1930"><span class="linenos">1930</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
</span><span id="L-1931"><a href="#L-1931"><span class="linenos">1931</span></a>
</span><span id="L-1932"><a href="#L-1932"><span class="linenos">1932</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="L-1933"><a href="#L-1933"><span class="linenos">1933</span></a>
</span><span id="L-1934"><a href="#L-1934"><span class="linenos">1934</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="L-1935"><a href="#L-1935"><span class="linenos">1935</span></a>
</span><span id="L-1936"><a href="#L-1936"><span class="linenos">1936</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gene_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">max_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-1937"><a href="#L-1937"><span class="linenos">1937</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1938"><a href="#L-1938"><span class="linenos">1938</span></a><span class="sd">        Filter cells by gene-detection thresholds (min and/or max).</span>
</span><span id="L-1939"><a href="#L-1939"><span class="linenos">1939</span></a>
</span><span id="L-1940"><a href="#L-1940"><span class="linenos">1940</span></a><span class="sd">        Parameters</span>
</span><span id="L-1941"><a href="#L-1941"><span class="linenos">1941</span></a><span class="sd">        ----------</span>
</span><span id="L-1942"><a href="#L-1942"><span class="linenos">1942</span></a><span class="sd">        min_n : int or None</span>
</span><span id="L-1943"><a href="#L-1943"><span class="linenos">1943</span></a><span class="sd">            Minimum number of detected genes required to keep a cell.</span>
</span><span id="L-1944"><a href="#L-1944"><span class="linenos">1944</span></a>
</span><span id="L-1945"><a href="#L-1945"><span class="linenos">1945</span></a><span class="sd">        max_n : int or None</span>
</span><span id="L-1946"><a href="#L-1946"><span class="linenos">1946</span></a><span class="sd">            Maximum number of detected genes allowed to keep a cell.</span>
</span><span id="L-1947"><a href="#L-1947"><span class="linenos">1947</span></a>
</span><span id="L-1948"><a href="#L-1948"><span class="linenos">1948</span></a><span class="sd">        Update</span>
</span><span id="L-1949"><a href="#L-1949"><span class="linenos">1949</span></a><span class="sd">        -------</span>
</span><span id="L-1950"><a href="#L-1950"><span class="linenos">1950</span></a><span class="sd">        Filters `self.input_data`, `self.normalized_data`, `self.input_metadata`</span>
</span><span id="L-1951"><a href="#L-1951"><span class="linenos">1951</span></a><span class="sd">        (and calls `average()` if `self.agg_normalized_data` exists).</span>
</span><span id="L-1952"><a href="#L-1952"><span class="linenos">1952</span></a>
</span><span id="L-1953"><a href="#L-1953"><span class="linenos">1953</span></a><span class="sd">        Side Effects</span>
</span><span id="L-1954"><a href="#L-1954"><span class="linenos">1954</span></a><span class="sd">        ------------</span>
</span><span id="L-1955"><a href="#L-1955"><span class="linenos">1955</span></a><span class="sd">        Raises ValueError if both bounds are None or if filtering removes all cells.</span>
</span><span id="L-1956"><a href="#L-1956"><span class="linenos">1956</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1957"><a href="#L-1957"><span class="linenos">1957</span></a>
</span><span id="L-1958"><a href="#L-1958"><span class="linenos">1958</span></a>        <span class="k">if</span> <span class="n">min_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1959"><a href="#L-1959"><span class="linenos">1959</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">&gt;</span> <span class="n">min_n</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">&lt;</span> <span class="n">max_n</span><span class="p">)</span>
</span><span id="L-1960"><a href="#L-1960"><span class="linenos">1960</span></a>        <span class="k">elif</span> <span class="n">min_n</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1961"><a href="#L-1961"><span class="linenos">1961</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">&lt;</span> <span class="n">max_n</span>
</span><span id="L-1962"><a href="#L-1962"><span class="linenos">1962</span></a>        <span class="k">elif</span> <span class="n">min_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1963"><a href="#L-1963"><span class="linenos">1963</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">&gt;</span> <span class="n">min_n</span>
</span><span id="L-1964"><a href="#L-1964"><span class="linenos">1964</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1965"><a href="#L-1965"><span class="linenos">1965</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lack of both min_n and max_n values&quot;</span><span class="p">)</span>
</span><span id="L-1966"><a href="#L-1966"><span class="linenos">1966</span></a>
</span><span id="L-1967"><a href="#L-1967"><span class="linenos">1967</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1968"><a href="#L-1968"><span class="linenos">1968</span></a>
</span><span id="L-1969"><a href="#L-1969"><span class="linenos">1969</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1970"><a href="#L-1970"><span class="linenos">1970</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing to reduce&quot;</span><span class="p">)</span>
</span><span id="L-1971"><a href="#L-1971"><span class="linenos">1971</span></a>
</span><span id="L-1972"><a href="#L-1972"><span class="linenos">1972</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
</span><span id="L-1973"><a href="#L-1973"><span class="linenos">1973</span></a>
</span><span id="L-1974"><a href="#L-1974"><span class="linenos">1974</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1975"><a href="#L-1975"><span class="linenos">1975</span></a>
</span><span id="L-1976"><a href="#L-1976"><span class="linenos">1976</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1977"><a href="#L-1977"><span class="linenos">1977</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing to reduce&quot;</span><span class="p">)</span>
</span><span id="L-1978"><a href="#L-1978"><span class="linenos">1978</span></a>
</span><span id="L-1979"><a href="#L-1979"><span class="linenos">1979</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
</span><span id="L-1980"><a href="#L-1980"><span class="linenos">1980</span></a>
</span><span id="L-1981"><a href="#L-1981"><span class="linenos">1981</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1982"><a href="#L-1982"><span class="linenos">1982</span></a>
</span><span id="L-1983"><a href="#L-1983"><span class="linenos">1983</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1984"><a href="#L-1984"><span class="linenos">1984</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing to reduce&quot;</span><span class="p">)</span>
</span><span id="L-1985"><a href="#L-1985"><span class="linenos">1985</span></a>
</span><span id="L-1986"><a href="#L-1986"><span class="linenos">1986</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="L-1987"><a href="#L-1987"><span class="linenos">1987</span></a>                <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-1988"><a href="#L-1988"><span class="linenos">1988</span></a>            <span class="p">)</span>
</span><span id="L-1989"><a href="#L-1989"><span class="linenos">1989</span></a>
</span><span id="L-1990"><a href="#L-1990"><span class="linenos">1990</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="L-1991"><a href="#L-1991"><span class="linenos">1991</span></a>                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="L-1992"><a href="#L-1992"><span class="linenos">1992</span></a>            <span class="p">)</span>
</span><span id="L-1993"><a href="#L-1993"><span class="linenos">1993</span></a>
</span><span id="L-1994"><a href="#L-1994"><span class="linenos">1994</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1995"><a href="#L-1995"><span class="linenos">1995</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
</span><span id="L-1996"><a href="#L-1996"><span class="linenos">1996</span></a>
</span><span id="L-1997"><a href="#L-1997"><span class="linenos">1997</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_calculation</span><span class="p">()</span>
</span><span id="L-1998"><a href="#L-1998"><span class="linenos">1998</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">()</span>
</span><span id="L-1999"><a href="#L-1999"><span class="linenos">1999</span></a>
</span><span id="L-2000"><a href="#L-2000"><span class="linenos">2000</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cells_calculation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_slot</span><span class="o">=</span><span class="s2">&quot;cell_names&quot;</span><span class="p">):</span>
</span><span id="L-2001"><a href="#L-2001"><span class="linenos">2001</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2002"><a href="#L-2002"><span class="linenos">2002</span></a><span class="sd">        Calculate number of cells per  call name / cluster.</span>
</span><span id="L-2003"><a href="#L-2003"><span class="linenos">2003</span></a>
</span><span id="L-2004"><a href="#L-2004"><span class="linenos">2004</span></a><span class="sd">        The method computes a binary (presence/absence) per cell name / cluster and sums across</span>
</span><span id="L-2005"><a href="#L-2005"><span class="linenos">2005</span></a><span class="sd">        cells.</span>
</span><span id="L-2006"><a href="#L-2006"><span class="linenos">2006</span></a>
</span><span id="L-2007"><a href="#L-2007"><span class="linenos">2007</span></a><span class="sd">        Parameters</span>
</span><span id="L-2008"><a href="#L-2008"><span class="linenos">2008</span></a><span class="sd">        ----------</span>
</span><span id="L-2009"><a href="#L-2009"><span class="linenos">2009</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="L-2010"><a href="#L-2010"><span class="linenos">2010</span></a><span class="sd">            Column in metadata to use as sample names.</span>
</span><span id="L-2011"><a href="#L-2011"><span class="linenos">2011</span></a>
</span><span id="L-2012"><a href="#L-2012"><span class="linenos">2012</span></a><span class="sd">        Update</span>
</span><span id="L-2013"><a href="#L-2013"><span class="linenos">2013</span></a><span class="sd">        ------</span>
</span><span id="L-2014"><a href="#L-2014"><span class="linenos">2014</span></a><span class="sd">        Sets `self.cells_calc` as a pd.DataFrame.</span>
</span><span id="L-2015"><a href="#L-2015"><span class="linenos">2015</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2016"><a href="#L-2016"><span class="linenos">2016</span></a>
</span><span id="L-2017"><a href="#L-2017"><span class="linenos">2017</span></a>        <span class="n">ls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">])</span>
</span><span id="L-2018"><a href="#L-2018"><span class="linenos">2018</span></a>
</span><span id="L-2019"><a href="#L-2019"><span class="linenos">2019</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="L-2020"><a href="#L-2020"><span class="linenos">2020</span></a>            <span class="p">{</span>
</span><span id="L-2021"><a href="#L-2021"><span class="linenos">2021</span></a>                <span class="s2">&quot;cluster&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
</span><span id="L-2022"><a href="#L-2022"><span class="linenos">2022</span></a>                <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
</span><span id="L-2023"><a href="#L-2023"><span class="linenos">2023</span></a>            <span class="p">}</span>
</span><span id="L-2024"><a href="#L-2024"><span class="linenos">2024</span></a>        <span class="p">)</span>
</span><span id="L-2025"><a href="#L-2025"><span class="linenos">2025</span></a>
</span><span id="L-2026"><a href="#L-2026"><span class="linenos">2026</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span> <span class="o">=</span> <span class="n">df</span>
</span><span id="L-2027"><a href="#L-2027"><span class="linenos">2027</span></a>
</span><span id="L-2028"><a href="#L-2028"><span class="linenos">2028</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cell_histograme</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">):</span>
</span><span id="L-2029"><a href="#L-2029"><span class="linenos">2029</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2030"><a href="#L-2030"><span class="linenos">2030</span></a><span class="sd">        Plot a histogram of the number of cells detected per cell name (cluster).</span>
</span><span id="L-2031"><a href="#L-2031"><span class="linenos">2031</span></a>
</span><span id="L-2032"><a href="#L-2032"><span class="linenos">2032</span></a><span class="sd">        Parameters</span>
</span><span id="L-2033"><a href="#L-2033"><span class="linenos">2033</span></a><span class="sd">        ----------</span>
</span><span id="L-2034"><a href="#L-2034"><span class="linenos">2034</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="L-2035"><a href="#L-2035"><span class="linenos">2035</span></a><span class="sd">            Column in metadata to use as sample names.</span>
</span><span id="L-2036"><a href="#L-2036"><span class="linenos">2036</span></a>
</span><span id="L-2037"><a href="#L-2037"><span class="linenos">2037</span></a><span class="sd">        Returns</span>
</span><span id="L-2038"><a href="#L-2038"><span class="linenos">2038</span></a><span class="sd">        -------</span>
</span><span id="L-2039"><a href="#L-2039"><span class="linenos">2039</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="L-2040"><a href="#L-2040"><span class="linenos">2040</span></a><span class="sd">            Figure containing the histogram of cell contents.</span>
</span><span id="L-2041"><a href="#L-2041"><span class="linenos">2041</span></a>
</span><span id="L-2042"><a href="#L-2042"><span class="linenos">2042</span></a><span class="sd">        Notes</span>
</span><span id="L-2043"><a href="#L-2043"><span class="linenos">2043</span></a><span class="sd">        -----</span>
</span><span id="L-2044"><a href="#L-2044"><span class="linenos">2044</span></a><span class="sd">        Requires `self.cells_calc` to be computed prior to calling.</span>
</span><span id="L-2045"><a href="#L-2045"><span class="linenos">2045</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2046"><a href="#L-2046"><span class="linenos">2046</span></a>
</span><span id="L-2047"><a href="#L-2047"><span class="linenos">2047</span></a>        <span class="k">if</span> <span class="n">name_slot</span> <span class="o">!=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">:</span>
</span><span id="L-2048"><a href="#L-2048"><span class="linenos">2048</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">(</span><span class="n">name_slot</span><span class="o">=</span><span class="n">name_slot</span><span class="p">)</span>
</span><span id="L-2049"><a href="#L-2049"><span class="linenos">2049</span></a>
</span><span id="L-2050"><a href="#L-2050"><span class="linenos">2050</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="L-2051"><a href="#L-2051"><span class="linenos">2051</span></a>
</span><span id="L-2052"><a href="#L-2052"><span class="linenos">2052</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
</span><span id="L-2053"><a href="#L-2053"><span class="linenos">2053</span></a>            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]),</span>
</span><span id="L-2054"><a href="#L-2054"><span class="linenos">2054</span></a>            <span class="n">bins</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">])),</span>
</span><span id="L-2055"><a href="#L-2055"><span class="linenos">2055</span></a>            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="L-2056"><a href="#L-2056"><span class="linenos">2056</span></a>            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
</span><span id="L-2057"><a href="#L-2057"><span class="linenos">2057</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
</span><span id="L-2058"><a href="#L-2058"><span class="linenos">2058</span></a>        <span class="p">)</span>
</span><span id="L-2059"><a href="#L-2059"><span class="linenos">2059</span></a>
</span><span id="L-2060"><a href="#L-2060"><span class="linenos">2060</span></a>        <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
</span><span id="L-2061"><a href="#L-2061"><span class="linenos">2061</span></a>            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])</span>
</span><span id="L-2062"><a href="#L-2062"><span class="linenos">2062</span></a>        <span class="p">)</span>
</span><span id="L-2063"><a href="#L-2063"><span class="linenos">2063</span></a>
</span><span id="L-2064"><a href="#L-2064"><span class="linenos">2064</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
</span><span id="L-2065"><a href="#L-2065"><span class="linenos">2065</span></a>            <span class="nb">min</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])),</span> <span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])),</span> <span class="mi">1000</span>
</span><span id="L-2066"><a href="#L-2066"><span class="linenos">2066</span></a>        <span class="p">)</span>
</span><span id="L-2067"><a href="#L-2067"><span class="linenos">2067</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="L-2068"><a href="#L-2068"><span class="linenos">2068</span></a>
</span><span id="L-2069"><a href="#L-2069"><span class="linenos">2069</span></a>        <span class="n">y_scaled</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]))</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-2070"><a href="#L-2070"><span class="linenos">2070</span></a>
</span><span id="L-2071"><a href="#L-2071"><span class="linenos">2071</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="L-2072"><a href="#L-2072"><span class="linenos">2072</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y_scaled</span><span class="p">,</span> <span class="s2">&quot;r-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Normal(μ=</span><span class="si">{</span><span class="n">mu</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, σ=</span><span class="si">{</span><span class="n">sigma</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-2073"><a href="#L-2073"><span class="linenos">2073</span></a>        <span class="p">)</span>
</span><span id="L-2074"><a href="#L-2074"><span class="linenos">2074</span></a>
</span><span id="L-2075"><a href="#L-2075"><span class="linenos">2075</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>
</span><span id="L-2076"><a href="#L-2076"><span class="linenos">2076</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
</span><span id="L-2077"><a href="#L-2077"><span class="linenos">2077</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Histogram of cells detected per cell name / cluster&quot;</span><span class="p">)</span>
</span><span id="L-2078"><a href="#L-2078"><span class="linenos">2078</span></a>
</span><span id="L-2079"><a href="#L-2079"><span class="linenos">2079</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span>
</span><span id="L-2080"><a href="#L-2080"><span class="linenos">2080</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
</span><span id="L-2081"><a href="#L-2081"><span class="linenos">2081</span></a>                <span class="nb">min</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])),</span> <span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])),</span> <span class="mi">20</span>
</span><span id="L-2082"><a href="#L-2082"><span class="linenos">2082</span></a>            <span class="p">)</span>
</span><span id="L-2083"><a href="#L-2083"><span class="linenos">2083</span></a>        <span class="p">)</span>
</span><span id="L-2084"><a href="#L-2084"><span class="linenos">2084</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
</span><span id="L-2085"><a href="#L-2085"><span class="linenos">2085</span></a>
</span><span id="L-2086"><a href="#L-2086"><span class="linenos">2086</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="L-2087"><a href="#L-2087"><span class="linenos">2087</span></a>
</span><span id="L-2088"><a href="#L-2088"><span class="linenos">2088</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="L-2089"><a href="#L-2089"><span class="linenos">2089</span></a>
</span><span id="L-2090"><a href="#L-2090"><span class="linenos">2090</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cluster_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">):</span>
</span><span id="L-2091"><a href="#L-2091"><span class="linenos">2091</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2092"><a href="#L-2092"><span class="linenos">2092</span></a><span class="sd">        Filter cell names / clusters by cell-detection threshold.</span>
</span><span id="L-2093"><a href="#L-2093"><span class="linenos">2093</span></a>
</span><span id="L-2094"><a href="#L-2094"><span class="linenos">2094</span></a><span class="sd">        Parameters</span>
</span><span id="L-2095"><a href="#L-2095"><span class="linenos">2095</span></a><span class="sd">        ----------</span>
</span><span id="L-2096"><a href="#L-2096"><span class="linenos">2096</span></a><span class="sd">        min_n : int or None</span>
</span><span id="L-2097"><a href="#L-2097"><span class="linenos">2097</span></a><span class="sd">            Minimum number of detected genes required to keep a cell.</span>
</span><span id="L-2098"><a href="#L-2098"><span class="linenos">2098</span></a>
</span><span id="L-2099"><a href="#L-2099"><span class="linenos">2099</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="L-2100"><a href="#L-2100"><span class="linenos">2100</span></a><span class="sd">            Column in metadata to use as sample names.</span>
</span><span id="L-2101"><a href="#L-2101"><span class="linenos">2101</span></a>
</span><span id="L-2102"><a href="#L-2102"><span class="linenos">2102</span></a>
</span><span id="L-2103"><a href="#L-2103"><span class="linenos">2103</span></a><span class="sd">        Update</span>
</span><span id="L-2104"><a href="#L-2104"><span class="linenos">2104</span></a><span class="sd">        -------</span>
</span><span id="L-2105"><a href="#L-2105"><span class="linenos">2105</span></a><span class="sd">        Filters `self.input_data`, `self.normalized_data`, `self.input_metadata`</span>
</span><span id="L-2106"><a href="#L-2106"><span class="linenos">2106</span></a><span class="sd">        (and calls `average()` if `self.agg_normalized_data` exists).</span>
</span><span id="L-2107"><a href="#L-2107"><span class="linenos">2107</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2108"><a href="#L-2108"><span class="linenos">2108</span></a>
</span><span id="L-2109"><a href="#L-2109"><span class="linenos">2109</span></a>        <span class="k">if</span> <span class="n">name_slot</span> <span class="o">!=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">:</span>
</span><span id="L-2110"><a href="#L-2110"><span class="linenos">2110</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">(</span><span class="n">name_slot</span><span class="o">=</span><span class="n">name_slot</span><span class="p">)</span>
</span><span id="L-2111"><a href="#L-2111"><span class="linenos">2111</span></a>
</span><span id="L-2112"><a href="#L-2112"><span class="linenos">2112</span></a>        <span class="k">if</span> <span class="n">min_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2113"><a href="#L-2113"><span class="linenos">2113</span></a>            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_n</span><span class="p">]</span>
</span><span id="L-2114"><a href="#L-2114"><span class="linenos">2114</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2115"><a href="#L-2115"><span class="linenos">2115</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lack of min_n value&quot;</span><span class="p">)</span>
</span><span id="L-2116"><a href="#L-2116"><span class="linenos">2116</span></a>
</span><span id="L-2117"><a href="#L-2117"><span class="linenos">2117</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2118"><a href="#L-2118"><span class="linenos">2118</span></a>
</span><span id="L-2119"><a href="#L-2119"><span class="linenos">2119</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2120"><a href="#L-2120"><span class="linenos">2120</span></a>
</span><span id="L-2121"><a href="#L-2121"><span class="linenos">2121</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-2122"><a href="#L-2122"><span class="linenos">2122</span></a>
</span><span id="L-2123"><a href="#L-2123"><span class="linenos">2123</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-2124"><a href="#L-2124"><span class="linenos">2124</span></a>
</span><span id="L-2125"><a href="#L-2125"><span class="linenos">2125</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2126"><a href="#L-2126"><span class="linenos">2126</span></a>
</span><span id="L-2127"><a href="#L-2127"><span class="linenos">2127</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="L-2128"><a href="#L-2128"><span class="linenos">2128</span></a>
</span><span id="L-2129"><a href="#L-2129"><span class="linenos">2129</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2130"><a href="#L-2130"><span class="linenos">2130</span></a>
</span><span id="L-2131"><a href="#L-2131"><span class="linenos">2131</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-2132"><a href="#L-2132"><span class="linenos">2132</span></a>
</span><span id="L-2133"><a href="#L-2133"><span class="linenos">2133</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-2134"><a href="#L-2134"><span class="linenos">2134</span></a>                    <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="L-2135"><a href="#L-2135"><span class="linenos">2135</span></a>                <span class="p">]</span>
</span><span id="L-2136"><a href="#L-2136"><span class="linenos">2136</span></a>
</span><span id="L-2137"><a href="#L-2137"><span class="linenos">2137</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2138"><a href="#L-2138"><span class="linenos">2138</span></a>
</span><span id="L-2139"><a href="#L-2139"><span class="linenos">2139</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="L-2140"><a href="#L-2140"><span class="linenos">2140</span></a>
</span><span id="L-2141"><a href="#L-2141"><span class="linenos">2141</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2142"><a href="#L-2142"><span class="linenos">2142</span></a>
</span><span id="L-2143"><a href="#L-2143"><span class="linenos">2143</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-2144"><a href="#L-2144"><span class="linenos">2144</span></a>
</span><span id="L-2145"><a href="#L-2145"><span class="linenos">2145</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-2146"><a href="#L-2146"><span class="linenos">2146</span></a>                    <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="L-2147"><a href="#L-2147"><span class="linenos">2147</span></a>                <span class="p">]</span>
</span><span id="L-2148"><a href="#L-2148"><span class="linenos">2148</span></a>
</span><span id="L-2149"><a href="#L-2149"><span class="linenos">2149</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2150"><a href="#L-2150"><span class="linenos">2150</span></a>
</span><span id="L-2151"><a href="#L-2151"><span class="linenos">2151</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="L-2152"><a href="#L-2152"><span class="linenos">2152</span></a>                        <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-2153"><a href="#L-2153"><span class="linenos">2153</span></a>                    <span class="p">)</span>
</span><span id="L-2154"><a href="#L-2154"><span class="linenos">2154</span></a>
</span><span id="L-2155"><a href="#L-2155"><span class="linenos">2155</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="L-2156"><a href="#L-2156"><span class="linenos">2156</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="L-2157"><a href="#L-2157"><span class="linenos">2157</span></a>                <span class="p">)</span>
</span><span id="L-2158"><a href="#L-2158"><span class="linenos">2158</span></a>
</span><span id="L-2159"><a href="#L-2159"><span class="linenos">2159</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2160"><a href="#L-2160"><span class="linenos">2160</span></a>
</span><span id="L-2161"><a href="#L-2161"><span class="linenos">2161</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-2162"><a href="#L-2162"><span class="linenos">2162</span></a>
</span><span id="L-2163"><a href="#L-2163"><span class="linenos">2163</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-2164"><a href="#L-2164"><span class="linenos">2164</span></a>                    <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
</span><span id="L-2165"><a href="#L-2165"><span class="linenos">2165</span></a>                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="L-2166"><a href="#L-2166"><span class="linenos">2166</span></a>                <span class="p">]</span>
</span><span id="L-2167"><a href="#L-2167"><span class="linenos">2167</span></a>
</span><span id="L-2168"><a href="#L-2168"><span class="linenos">2168</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2169"><a href="#L-2169"><span class="linenos">2169</span></a>
</span><span id="L-2170"><a href="#L-2170"><span class="linenos">2170</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="L-2171"><a href="#L-2171"><span class="linenos">2171</span></a>
</span><span id="L-2172"><a href="#L-2172"><span class="linenos">2172</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2173"><a href="#L-2173"><span class="linenos">2173</span></a>
</span><span id="L-2174"><a href="#L-2174"><span class="linenos">2174</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-2175"><a href="#L-2175"><span class="linenos">2175</span></a>
</span><span id="L-2176"><a href="#L-2176"><span class="linenos">2176</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-2177"><a href="#L-2177"><span class="linenos">2177</span></a>                    <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="L-2178"><a href="#L-2178"><span class="linenos">2178</span></a>                <span class="p">]</span>
</span><span id="L-2179"><a href="#L-2179"><span class="linenos">2179</span></a>
</span><span id="L-2180"><a href="#L-2180"><span class="linenos">2180</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2181"><a href="#L-2181"><span class="linenos">2181</span></a>
</span><span id="L-2182"><a href="#L-2182"><span class="linenos">2182</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="L-2183"><a href="#L-2183"><span class="linenos">2183</span></a>                        <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-2184"><a href="#L-2184"><span class="linenos">2184</span></a>                    <span class="p">)</span>
</span><span id="L-2185"><a href="#L-2185"><span class="linenos">2185</span></a>
</span><span id="L-2186"><a href="#L-2186"><span class="linenos">2186</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="L-2187"><a href="#L-2187"><span class="linenos">2187</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="L-2188"><a href="#L-2188"><span class="linenos">2188</span></a>                <span class="p">)</span>
</span><span id="L-2189"><a href="#L-2189"><span class="linenos">2189</span></a>
</span><span id="L-2190"><a href="#L-2190"><span class="linenos">2190</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gene_calculation</span><span class="p">()</span>
</span><span id="L-2191"><a href="#L-2191"><span class="linenos">2191</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">()</span>
</span><span id="L-2192"><a href="#L-2192"><span class="linenos">2192</span></a>
</span><span id="L-2193"><a href="#L-2193"><span class="linenos">2193</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_sparse_from_projects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalized_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="L-2194"><a href="#L-2194"><span class="linenos">2194</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2195"><a href="#L-2195"><span class="linenos">2195</span></a><span class="sd">        Load sparse 10x-style datasets from stored project paths, concatenate them,</span>
</span><span id="L-2196"><a href="#L-2196"><span class="linenos">2196</span></a><span class="sd">        and populate `input_data` / `normalized_data` and `input_metadata`.</span>
</span><span id="L-2197"><a href="#L-2197"><span class="linenos">2197</span></a>
</span><span id="L-2198"><a href="#L-2198"><span class="linenos">2198</span></a><span class="sd">        Parameters</span>
</span><span id="L-2199"><a href="#L-2199"><span class="linenos">2199</span></a><span class="sd">        ----------</span>
</span><span id="L-2200"><a href="#L-2200"><span class="linenos">2200</span></a><span class="sd">        normalized_data : bool, default False</span>
</span><span id="L-2201"><a href="#L-2201"><span class="linenos">2201</span></a><span class="sd">            If True, store concatenated tables in `self.normalized_data`.</span>
</span><span id="L-2202"><a href="#L-2202"><span class="linenos">2202</span></a><span class="sd">            If False, store them in `self.input_data` and normalization</span>
</span><span id="L-2203"><a href="#L-2203"><span class="linenos">2203</span></a><span class="sd">            is needed using normalize_data() method.</span>
</span><span id="L-2204"><a href="#L-2204"><span class="linenos">2204</span></a>
</span><span id="L-2205"><a href="#L-2205"><span class="linenos">2205</span></a><span class="sd">        Side Effects</span>
</span><span id="L-2206"><a href="#L-2206"><span class="linenos">2206</span></a><span class="sd">        ------------</span>
</span><span id="L-2207"><a href="#L-2207"><span class="linenos">2207</span></a><span class="sd">        - Reads each project using `load_sparse(...)` (expects matrix.mtx, genes.tsv, barcodes.tsv).</span>
</span><span id="L-2208"><a href="#L-2208"><span class="linenos">2208</span></a><span class="sd">        - Concatenates all projects column-wise and sets `self.input_metadata`.</span>
</span><span id="L-2209"><a href="#L-2209"><span class="linenos">2209</span></a><span class="sd">        - Replaces NaNs with zeros and updates `self.gene_calc`.</span>
</span><span id="L-2210"><a href="#L-2210"><span class="linenos">2210</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2211"><a href="#L-2211"><span class="linenos">2211</span></a>
</span><span id="L-2212"><a href="#L-2212"><span class="linenos">2212</span></a>        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span>
</span><span id="L-2213"><a href="#L-2213"><span class="linenos">2213</span></a>
</span><span id="L-2214"><a href="#L-2214"><span class="linenos">2214</span></a>        <span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span><span id="L-2215"><a href="#L-2215"><span class="linenos">2215</span></a>        <span class="n">full_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span><span id="L-2216"><a href="#L-2216"><span class="linenos">2216</span></a>
</span><span id="L-2217"><a href="#L-2217"><span class="linenos">2217</span></a>        <span class="k">for</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-2218"><a href="#L-2218"><span class="linenos">2218</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
</span><span id="L-2219"><a href="#L-2219"><span class="linenos">2219</span></a>
</span><span id="L-2220"><a href="#L-2220"><span class="linenos">2220</span></a>            <span class="n">dt</span><span class="p">,</span> <span class="n">met</span> <span class="o">=</span> <span class="n">load_sparse</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">obj</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">ke</span><span class="p">)</span>
</span><span id="L-2221"><a href="#L-2221"><span class="linenos">2221</span></a>
</span><span id="L-2222"><a href="#L-2222"><span class="linenos">2222</span></a>            <span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">full_data</span><span class="p">,</span> <span class="n">dt</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-2223"><a href="#L-2223"><span class="linenos">2223</span></a>            <span class="n">full_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">full_metadata</span><span class="p">,</span> <span class="n">met</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2224"><a href="#L-2224"><span class="linenos">2224</span></a>
</span><span id="L-2225"><a href="#L-2225"><span class="linenos">2225</span></a>        <span class="n">full_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">full_data</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-2226"><a href="#L-2226"><span class="linenos">2226</span></a>
</span><span id="L-2227"><a href="#L-2227"><span class="linenos">2227</span></a>        <span class="k">if</span> <span class="n">normalized_data</span><span class="p">:</span>
</span><span id="L-2228"><a href="#L-2228"><span class="linenos">2228</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="n">full_data</span>
</span><span id="L-2229"><a href="#L-2229"><span class="linenos">2229</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="n">full_metadata</span>
</span><span id="L-2230"><a href="#L-2230"><span class="linenos">2230</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2231"><a href="#L-2231"><span class="linenos">2231</span></a>
</span><span id="L-2232"><a href="#L-2232"><span class="linenos">2232</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="n">full_data</span>
</span><span id="L-2233"><a href="#L-2233"><span class="linenos">2233</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="n">full_metadata</span>
</span><span id="L-2234"><a href="#L-2234"><span class="linenos">2234</span></a>
</span><span id="L-2235"><a href="#L-2235"><span class="linenos">2235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_calculation</span><span class="p">()</span>
</span><span id="L-2236"><a href="#L-2236"><span class="linenos">2236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">()</span>
</span><span id="L-2237"><a href="#L-2237"><span class="linenos">2237</span></a>
</span><span id="L-2238"><a href="#L-2238"><span class="linenos">2238</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rename_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">):</span>
</span><span id="L-2239"><a href="#L-2239"><span class="linenos">2239</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2240"><a href="#L-2240"><span class="linenos">2240</span></a><span class="sd">        Rename entries in `self.input_metadata[slot]` according to a provided mapping.</span>
</span><span id="L-2241"><a href="#L-2241"><span class="linenos">2241</span></a>
</span><span id="L-2242"><a href="#L-2242"><span class="linenos">2242</span></a><span class="sd">        Parameters</span>
</span><span id="L-2243"><a href="#L-2243"><span class="linenos">2243</span></a><span class="sd">        ----------</span>
</span><span id="L-2244"><a href="#L-2244"><span class="linenos">2244</span></a><span class="sd">        mapping : dict</span>
</span><span id="L-2245"><a href="#L-2245"><span class="linenos">2245</span></a><span class="sd">            Dictionary with keys &#39;old_name&#39; and &#39;new_name&#39;, each mapping to a list</span>
</span><span id="L-2246"><a href="#L-2246"><span class="linenos">2246</span></a><span class="sd">            of equal length describing replacements.</span>
</span><span id="L-2247"><a href="#L-2247"><span class="linenos">2247</span></a>
</span><span id="L-2248"><a href="#L-2248"><span class="linenos">2248</span></a><span class="sd">        slot : str, default &#39;cell_names&#39;</span>
</span><span id="L-2249"><a href="#L-2249"><span class="linenos">2249</span></a><span class="sd">            Metadata column to operate on.</span>
</span><span id="L-2250"><a href="#L-2250"><span class="linenos">2250</span></a>
</span><span id="L-2251"><a href="#L-2251"><span class="linenos">2251</span></a><span class="sd">        Update</span>
</span><span id="L-2252"><a href="#L-2252"><span class="linenos">2252</span></a><span class="sd">        -------</span>
</span><span id="L-2253"><a href="#L-2253"><span class="linenos">2253</span></a><span class="sd">        Updates `self.input_metadata[slot]` in-place with renamed values.</span>
</span><span id="L-2254"><a href="#L-2254"><span class="linenos">2254</span></a>
</span><span id="L-2255"><a href="#L-2255"><span class="linenos">2255</span></a><span class="sd">        Raises</span>
</span><span id="L-2256"><a href="#L-2256"><span class="linenos">2256</span></a><span class="sd">        ------</span>
</span><span id="L-2257"><a href="#L-2257"><span class="linenos">2257</span></a><span class="sd">        ValueError</span>
</span><span id="L-2258"><a href="#L-2258"><span class="linenos">2258</span></a><span class="sd">            If mapping keys are incorrect, lengths differ, or some &#39;old_name&#39; values</span>
</span><span id="L-2259"><a href="#L-2259"><span class="linenos">2259</span></a><span class="sd">            are not present in the metadata column.</span>
</span><span id="L-2260"><a href="#L-2260"><span class="linenos">2260</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2261"><a href="#L-2261"><span class="linenos">2261</span></a>
</span><span id="L-2262"><a href="#L-2262"><span class="linenos">2262</span></a>        <span class="k">if</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;old_name&quot;</span><span class="p">,</span> <span class="s2">&quot;new_name&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="L-2263"><a href="#L-2263"><span class="linenos">2263</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-2264"><a href="#L-2264"><span class="linenos">2264</span></a>                <span class="s2">&quot;Mapping dictionary must contain keys &#39;old_name&#39; and &#39;new_name&#39;, &quot;</span>
</span><span id="L-2265"><a href="#L-2265"><span class="linenos">2265</span></a>                <span class="s2">&quot;each with a list of names to change.&quot;</span>
</span><span id="L-2266"><a href="#L-2266"><span class="linenos">2266</span></a>            <span class="p">)</span>
</span><span id="L-2267"><a href="#L-2267"><span class="linenos">2267</span></a>
</span><span id="L-2268"><a href="#L-2268"><span class="linenos">2268</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;old_name&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;new_name&quot;</span><span class="p">]):</span>
</span><span id="L-2269"><a href="#L-2269"><span class="linenos">2269</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-2270"><a href="#L-2270"><span class="linenos">2270</span></a>                <span class="s2">&quot;Mapping dictionary lists &#39;old_name&#39; and &#39;new_name&#39; &quot;</span>
</span><span id="L-2271"><a href="#L-2271"><span class="linenos">2271</span></a>                <span class="s2">&quot;must have the same length!&quot;</span>
</span><span id="L-2272"><a href="#L-2272"><span class="linenos">2272</span></a>            <span class="p">)</span>
</span><span id="L-2273"><a href="#L-2273"><span class="linenos">2273</span></a>
</span><span id="L-2274"><a href="#L-2274"><span class="linenos">2274</span></a>        <span class="n">names_vector</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span>
</span><span id="L-2275"><a href="#L-2275"><span class="linenos">2275</span></a>
</span><span id="L-2276"><a href="#L-2276"><span class="linenos">2276</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">elem</span> <span class="ow">in</span> <span class="n">names_vector</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;old_name&quot;</span><span class="p">])):</span>
</span><span id="L-2277"><a href="#L-2277"><span class="linenos">2277</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-2278"><a href="#L-2278"><span class="linenos">2278</span></a>                <span class="sa">f</span><span class="s2">&quot;Some entries from &#39;old_name&#39; do not exist in the names of slot </span><span class="si">{</span><span class="n">slot</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="L-2279"><a href="#L-2279"><span class="linenos">2279</span></a>            <span class="p">)</span>
</span><span id="L-2280"><a href="#L-2280"><span class="linenos">2280</span></a>
</span><span id="L-2281"><a href="#L-2281"><span class="linenos">2281</span></a>        <span class="n">replace_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;old_name&quot;</span><span class="p">],</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;new_name&quot;</span><span class="p">]))</span>
</span><span id="L-2282"><a href="#L-2282"><span class="linenos">2282</span></a>
</span><span id="L-2283"><a href="#L-2283"><span class="linenos">2283</span></a>        <span class="n">names_vector_ret</span> <span class="o">=</span> <span class="p">[</span><span class="n">replace_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">names_vector</span><span class="p">]</span>
</span><span id="L-2284"><a href="#L-2284"><span class="linenos">2284</span></a>
</span><span id="L-2285"><a href="#L-2285"><span class="linenos">2285</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">names_vector_ret</span>
</span><span id="L-2286"><a href="#L-2286"><span class="linenos">2286</span></a>
</span><span id="L-2287"><a href="#L-2287"><span class="linenos">2287</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rename_subclusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
</span><span id="L-2288"><a href="#L-2288"><span class="linenos">2288</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2289"><a href="#L-2289"><span class="linenos">2289</span></a><span class="sd">        Rename labels stored in `self.subclusters_.subclusters` according to mapping.</span>
</span><span id="L-2290"><a href="#L-2290"><span class="linenos">2290</span></a>
</span><span id="L-2291"><a href="#L-2291"><span class="linenos">2291</span></a><span class="sd">        Parameters</span>
</span><span id="L-2292"><a href="#L-2292"><span class="linenos">2292</span></a><span class="sd">        ----------</span>
</span><span id="L-2293"><a href="#L-2293"><span class="linenos">2293</span></a><span class="sd">        mapping : dict</span>
</span><span id="L-2294"><a href="#L-2294"><span class="linenos">2294</span></a><span class="sd">            Mapping with keys &#39;old_name&#39; and &#39;new_name&#39; (lists of equal length).</span>
</span><span id="L-2295"><a href="#L-2295"><span class="linenos">2295</span></a>
</span><span id="L-2296"><a href="#L-2296"><span class="linenos">2296</span></a><span class="sd">        Update</span>
</span><span id="L-2297"><a href="#L-2297"><span class="linenos">2297</span></a><span class="sd">        -------</span>
</span><span id="L-2298"><a href="#L-2298"><span class="linenos">2298</span></a><span class="sd">        Updates `self.subclusters_.subclusters` with renamed labels.</span>
</span><span id="L-2299"><a href="#L-2299"><span class="linenos">2299</span></a>
</span><span id="L-2300"><a href="#L-2300"><span class="linenos">2300</span></a><span class="sd">        Raises</span>
</span><span id="L-2301"><a href="#L-2301"><span class="linenos">2301</span></a><span class="sd">        ------</span>
</span><span id="L-2302"><a href="#L-2302"><span class="linenos">2302</span></a><span class="sd">        ValueError</span>
</span><span id="L-2303"><a href="#L-2303"><span class="linenos">2303</span></a><span class="sd">            If mapping is invalid or old names are not present.</span>
</span><span id="L-2304"><a href="#L-2304"><span class="linenos">2304</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2305"><a href="#L-2305"><span class="linenos">2305</span></a>
</span><span id="L-2306"><a href="#L-2306"><span class="linenos">2306</span></a>        <span class="k">if</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;old_name&quot;</span><span class="p">,</span> <span class="s2">&quot;new_name&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="L-2307"><a href="#L-2307"><span class="linenos">2307</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-2308"><a href="#L-2308"><span class="linenos">2308</span></a>                <span class="s2">&quot;Mapping dictionary must contain keys &#39;old_name&#39; and &#39;new_name&#39;, &quot;</span>
</span><span id="L-2309"><a href="#L-2309"><span class="linenos">2309</span></a>                <span class="s2">&quot;each with a list of names to change.&quot;</span>
</span><span id="L-2310"><a href="#L-2310"><span class="linenos">2310</span></a>            <span class="p">)</span>
</span><span id="L-2311"><a href="#L-2311"><span class="linenos">2311</span></a>
</span><span id="L-2312"><a href="#L-2312"><span class="linenos">2312</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;old_name&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;new_name&quot;</span><span class="p">]):</span>
</span><span id="L-2313"><a href="#L-2313"><span class="linenos">2313</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-2314"><a href="#L-2314"><span class="linenos">2314</span></a>                <span class="s2">&quot;Mapping dictionary lists &#39;old_name&#39; and &#39;new_name&#39; &quot;</span>
</span><span id="L-2315"><a href="#L-2315"><span class="linenos">2315</span></a>                <span class="s2">&quot;must have the same length!&quot;</span>
</span><span id="L-2316"><a href="#L-2316"><span class="linenos">2316</span></a>            <span class="p">)</span>
</span><span id="L-2317"><a href="#L-2317"><span class="linenos">2317</span></a>
</span><span id="L-2318"><a href="#L-2318"><span class="linenos">2318</span></a>        <span class="n">names_vector</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span><span class="p">)</span>
</span><span id="L-2319"><a href="#L-2319"><span class="linenos">2319</span></a>
</span><span id="L-2320"><a href="#L-2320"><span class="linenos">2320</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">elem</span> <span class="ow">in</span> <span class="n">names_vector</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;old_name&quot;</span><span class="p">])):</span>
</span><span id="L-2321"><a href="#L-2321"><span class="linenos">2321</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-2322"><a href="#L-2322"><span class="linenos">2322</span></a>                <span class="s2">&quot;Some entries from &#39;old_name&#39; do not exist in the subcluster names.&quot;</span>
</span><span id="L-2323"><a href="#L-2323"><span class="linenos">2323</span></a>            <span class="p">)</span>
</span><span id="L-2324"><a href="#L-2324"><span class="linenos">2324</span></a>
</span><span id="L-2325"><a href="#L-2325"><span class="linenos">2325</span></a>        <span class="n">replace_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;old_name&quot;</span><span class="p">],</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;new_name&quot;</span><span class="p">]))</span>
</span><span id="L-2326"><a href="#L-2326"><span class="linenos">2326</span></a>
</span><span id="L-2327"><a href="#L-2327"><span class="linenos">2327</span></a>        <span class="n">names_vector_ret</span> <span class="o">=</span> <span class="p">[</span><span class="n">replace_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">names_vector</span><span class="p">]</span>
</span><span id="L-2328"><a href="#L-2328"><span class="linenos">2328</span></a>
</span><span id="L-2329"><a href="#L-2329"><span class="linenos">2329</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span> <span class="o">=</span> <span class="n">names_vector_ret</span>
</span><span id="L-2330"><a href="#L-2330"><span class="linenos">2330</span></a>
</span><span id="L-2331"><a href="#L-2331"><span class="linenos">2331</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_sparse</span><span class="p">(</span>
</span><span id="L-2332"><a href="#L-2332"><span class="linenos">2332</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-2333"><a href="#L-2333"><span class="linenos">2333</span></a>        <span class="n">path_to_save</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
</span><span id="L-2334"><a href="#L-2334"><span class="linenos">2334</span></a>        <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="L-2335"><a href="#L-2335"><span class="linenos">2335</span></a>        <span class="n">data_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;normalized&quot;</span><span class="p">,</span>
</span><span id="L-2336"><a href="#L-2336"><span class="linenos">2336</span></a>    <span class="p">):</span>
</span><span id="L-2337"><a href="#L-2337"><span class="linenos">2337</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2338"><a href="#L-2338"><span class="linenos">2338</span></a><span class="sd">        Export data as 10x-compatible sparse files (matrix.mtx, barcodes.tsv, genes.tsv).</span>
</span><span id="L-2339"><a href="#L-2339"><span class="linenos">2339</span></a>
</span><span id="L-2340"><a href="#L-2340"><span class="linenos">2340</span></a><span class="sd">        Parameters</span>
</span><span id="L-2341"><a href="#L-2341"><span class="linenos">2341</span></a><span class="sd">        ----------</span>
</span><span id="L-2342"><a href="#L-2342"><span class="linenos">2342</span></a><span class="sd">        path_to_save : str, default current working directory</span>
</span><span id="L-2343"><a href="#L-2343"><span class="linenos">2343</span></a><span class="sd">            Directory where files will be written.</span>
</span><span id="L-2344"><a href="#L-2344"><span class="linenos">2344</span></a>
</span><span id="L-2345"><a href="#L-2345"><span class="linenos">2345</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="L-2346"><a href="#L-2346"><span class="linenos">2346</span></a><span class="sd">            Metadata column providing cell names for barcodes.tsv.</span>
</span><span id="L-2347"><a href="#L-2347"><span class="linenos">2347</span></a>
</span><span id="L-2348"><a href="#L-2348"><span class="linenos">2348</span></a><span class="sd">        data_slot : str, default &#39;normalized&#39;</span>
</span><span id="L-2349"><a href="#L-2349"><span class="linenos">2349</span></a><span class="sd">            Either &#39;normalized&#39; (uses self.normalized_data) or &#39;count&#39; (uses self.input_data).</span>
</span><span id="L-2350"><a href="#L-2350"><span class="linenos">2350</span></a>
</span><span id="L-2351"><a href="#L-2351"><span class="linenos">2351</span></a><span class="sd">        Raises</span>
</span><span id="L-2352"><a href="#L-2352"><span class="linenos">2352</span></a><span class="sd">        ------</span>
</span><span id="L-2353"><a href="#L-2353"><span class="linenos">2353</span></a><span class="sd">        ValueError</span>
</span><span id="L-2354"><a href="#L-2354"><span class="linenos">2354</span></a><span class="sd">            If `data_slot` is not &#39;normalized&#39; or &#39;count&#39;.</span>
</span><span id="L-2355"><a href="#L-2355"><span class="linenos">2355</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2356"><a href="#L-2356"><span class="linenos">2356</span></a>
</span><span id="L-2357"><a href="#L-2357"><span class="linenos">2357</span></a>        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="L-2358"><a href="#L-2358"><span class="linenos">2358</span></a>
</span><span id="L-2359"><a href="#L-2359"><span class="linenos">2359</span></a>        <span class="k">if</span> <span class="n">data_slot</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;normalized&quot;</span><span class="p">:</span>
</span><span id="L-2360"><a href="#L-2360"><span class="linenos">2360</span></a>
</span><span id="L-2361"><a href="#L-2361"><span class="linenos">2361</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="L-2362"><a href="#L-2362"><span class="linenos">2362</span></a>            <span class="n">mtx</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="p">)</span>
</span><span id="L-2363"><a href="#L-2363"><span class="linenos">2363</span></a>
</span><span id="L-2364"><a href="#L-2364"><span class="linenos">2364</span></a>        <span class="k">elif</span> <span class="n">data_slot</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span>
</span><span id="L-2365"><a href="#L-2365"><span class="linenos">2365</span></a>
</span><span id="L-2366"><a href="#L-2366"><span class="linenos">2366</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="L-2367"><a href="#L-2367"><span class="linenos">2367</span></a>            <span class="n">mtx</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">)</span>
</span><span id="L-2368"><a href="#L-2368"><span class="linenos">2368</span></a>
</span><span id="L-2369"><a href="#L-2369"><span class="linenos">2369</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2370"><a href="#L-2370"><span class="linenos">2370</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;data_slot&#39; must be included in &#39;normalized&#39; or &#39;count&#39;&quot;</span><span class="p">)</span>
</span><span id="L-2371"><a href="#L-2371"><span class="linenos">2371</span></a>
</span><span id="L-2372"><a href="#L-2372"><span class="linenos">2372</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2373"><a href="#L-2373"><span class="linenos">2373</span></a>
</span><span id="L-2374"><a href="#L-2374"><span class="linenos">2374</span></a>        <span class="n">mmwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s2">&quot;matrix.mtx&quot;</span><span class="p">),</span> <span class="n">mtx</span><span class="p">)</span>
</span><span id="L-2375"><a href="#L-2375"><span class="linenos">2375</span></a>
</span><span id="L-2376"><a href="#L-2376"><span class="linenos">2376</span></a>        <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">names</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
</span><span id="L-2377"><a href="#L-2377"><span class="linenos">2377</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s2">&quot;barcodes.tsv&quot;</span><span class="p">),</span>
</span><span id="L-2378"><a href="#L-2378"><span class="linenos">2378</span></a>            <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-2379"><a href="#L-2379"><span class="linenos">2379</span></a>            <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-2380"><a href="#L-2380"><span class="linenos">2380</span></a>            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-2381"><a href="#L-2381"><span class="linenos">2381</span></a>        <span class="p">)</span>
</span><span id="L-2382"><a href="#L-2382"><span class="linenos">2382</span></a>
</span><span id="L-2383"><a href="#L-2383"><span class="linenos">2383</span></a>        <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">features</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
</span><span id="L-2384"><a href="#L-2384"><span class="linenos">2384</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s2">&quot;genes.tsv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
</span><span id="L-2385"><a href="#L-2385"><span class="linenos">2385</span></a>        <span class="p">)</span>
</span><span id="L-2386"><a href="#L-2386"><span class="linenos">2386</span></a>
</span><span id="L-2387"><a href="#L-2387"><span class="linenos">2387</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">normalize_counts</span><span class="p">(</span>
</span><span id="L-2388"><a href="#L-2388"><span class="linenos">2388</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">normalize_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">log_transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2389"><a href="#L-2389"><span class="linenos">2389</span></a>    <span class="p">):</span>
</span><span id="L-2390"><a href="#L-2390"><span class="linenos">2390</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2391"><a href="#L-2391"><span class="linenos">2391</span></a><span class="sd">        Normalize raw counts to counts-per-(normalize_factor)</span>
</span><span id="L-2392"><a href="#L-2392"><span class="linenos">2392</span></a><span class="sd">        (e.g., CPM, TPM - depending on normalize_factor).</span>
</span><span id="L-2393"><a href="#L-2393"><span class="linenos">2393</span></a>
</span><span id="L-2394"><a href="#L-2394"><span class="linenos">2394</span></a><span class="sd">        Parameters</span>
</span><span id="L-2395"><a href="#L-2395"><span class="linenos">2395</span></a><span class="sd">        ----------</span>
</span><span id="L-2396"><a href="#L-2396"><span class="linenos">2396</span></a><span class="sd">        normalize_factor : int, default 100000</span>
</span><span id="L-2397"><a href="#L-2397"><span class="linenos">2397</span></a><span class="sd">            Scaling factor used after dividing by column sums.</span>
</span><span id="L-2398"><a href="#L-2398"><span class="linenos">2398</span></a>
</span><span id="L-2399"><a href="#L-2399"><span class="linenos">2399</span></a><span class="sd">        log_transform : bool, default True</span>
</span><span id="L-2400"><a href="#L-2400"><span class="linenos">2400</span></a><span class="sd">            If True, apply log2(x+1) transformation to normalized values.</span>
</span><span id="L-2401"><a href="#L-2401"><span class="linenos">2401</span></a>
</span><span id="L-2402"><a href="#L-2402"><span class="linenos">2402</span></a><span class="sd">        Update</span>
</span><span id="L-2403"><a href="#L-2403"><span class="linenos">2403</span></a><span class="sd">        -------</span>
</span><span id="L-2404"><a href="#L-2404"><span class="linenos">2404</span></a><span class="sd">            Sets `self.normalized_data` to normalized values (fills NaNs with 0).</span>
</span><span id="L-2405"><a href="#L-2405"><span class="linenos">2405</span></a>
</span><span id="L-2406"><a href="#L-2406"><span class="linenos">2406</span></a><span class="sd">        Raises</span>
</span><span id="L-2407"><a href="#L-2407"><span class="linenos">2407</span></a><span class="sd">        ------</span>
</span><span id="L-2408"><a href="#L-2408"><span class="linenos">2408</span></a><span class="sd">        ValueError</span>
</span><span id="L-2409"><a href="#L-2409"><span class="linenos">2409</span></a><span class="sd">            If `self.input_data` is missing (cannot normalize).</span>
</span><span id="L-2410"><a href="#L-2410"><span class="linenos">2410</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2411"><a href="#L-2411"><span class="linenos">2411</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2412"><a href="#L-2412"><span class="linenos">2412</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input data is missing, cannot normalize.&quot;</span><span class="p">)</span>
</span><span id="L-2413"><a href="#L-2413"><span class="linenos">2413</span></a>
</span><span id="L-2414"><a href="#L-2414"><span class="linenos">2414</span></a>        <span class="n">sum_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-2415"><a href="#L-2415"><span class="linenos">2415</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">sum_col</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">normalize_factor</span>
</span><span id="L-2416"><a href="#L-2416"><span class="linenos">2416</span></a>
</span><span id="L-2417"><a href="#L-2417"><span class="linenos">2417</span></a>        <span class="k">if</span> <span class="n">log_transform</span><span class="p">:</span>
</span><span id="L-2418"><a href="#L-2418"><span class="linenos">2418</span></a>            <span class="c1"># log2(x + 1) to avoid -inf for zeros</span>
</span><span id="L-2419"><a href="#L-2419"><span class="linenos">2419</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-2420"><a href="#L-2420"><span class="linenos">2420</span></a>
</span><span id="L-2421"><a href="#L-2421"><span class="linenos">2421</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">statistic</span><span class="p">(</span>
</span><span id="L-2422"><a href="#L-2422"><span class="linenos">2422</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-2423"><a href="#L-2423"><span class="linenos">2423</span></a>        <span class="n">cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-2424"><a href="#L-2424"><span class="linenos">2424</span></a>        <span class="n">sets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-2425"><a href="#L-2425"><span class="linenos">2425</span></a>        <span class="n">min_exp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
</span><span id="L-2426"><a href="#L-2426"><span class="linenos">2426</span></a>        <span class="n">min_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-2427"><a href="#L-2427"><span class="linenos">2427</span></a>        <span class="n">n_proc</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="L-2428"><a href="#L-2428"><span class="linenos">2428</span></a>    <span class="p">):</span>
</span><span id="L-2429"><a href="#L-2429"><span class="linenos">2429</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2430"><a href="#L-2430"><span class="linenos">2430</span></a><span class="sd">        Compute per-feature statistics (Mann–Whitney U) comparing target vs rest.</span>
</span><span id="L-2431"><a href="#L-2431"><span class="linenos">2431</span></a>
</span><span id="L-2432"><a href="#L-2432"><span class="linenos">2432</span></a><span class="sd">        This is a wrapper similar to `calc_DEG` tailored to use `self.normalized_data`</span>
</span><span id="L-2433"><a href="#L-2433"><span class="linenos">2433</span></a><span class="sd">        and `self.input_metadata`. It returns per-feature statistics including p-values,</span>
</span><span id="L-2434"><a href="#L-2434"><span class="linenos">2434</span></a><span class="sd">        adjusted p-values, means, variances, effect-size measures and fold-changes.</span>
</span><span id="L-2435"><a href="#L-2435"><span class="linenos">2435</span></a>
</span><span id="L-2436"><a href="#L-2436"><span class="linenos">2436</span></a><span class="sd">        Parameters</span>
</span><span id="L-2437"><a href="#L-2437"><span class="linenos">2437</span></a><span class="sd">        ----------</span>
</span><span id="L-2438"><a href="#L-2438"><span class="linenos">2438</span></a><span class="sd">        cells : list, &#39;All&#39;, dict, or None</span>
</span><span id="L-2439"><a href="#L-2439"><span class="linenos">2439</span></a><span class="sd">            Defines the target cells or groups for comparison (several modes supported).</span>
</span><span id="L-2440"><a href="#L-2440"><span class="linenos">2440</span></a>
</span><span id="L-2441"><a href="#L-2441"><span class="linenos">2441</span></a><span class="sd">        sets : &#39;All&#39;, dict, or None</span>
</span><span id="L-2442"><a href="#L-2442"><span class="linenos">2442</span></a><span class="sd">            Alternative grouping mode (operate on `self.input_metadata[&#39;sets&#39;]`).</span>
</span><span id="L-2443"><a href="#L-2443"><span class="linenos">2443</span></a>
</span><span id="L-2444"><a href="#L-2444"><span class="linenos">2444</span></a><span class="sd">        min_exp : float, default 0.01</span>
</span><span id="L-2445"><a href="#L-2445"><span class="linenos">2445</span></a><span class="sd">            Minimum expression threshold used when filtering features.</span>
</span><span id="L-2446"><a href="#L-2446"><span class="linenos">2446</span></a>
</span><span id="L-2447"><a href="#L-2447"><span class="linenos">2447</span></a><span class="sd">        min_pct : float, default 0.1</span>
</span><span id="L-2448"><a href="#L-2448"><span class="linenos">2448</span></a><span class="sd">            Minimum proportion of expressing cells in the target group required to test a feature.</span>
</span><span id="L-2449"><a href="#L-2449"><span class="linenos">2449</span></a>
</span><span id="L-2450"><a href="#L-2450"><span class="linenos">2450</span></a><span class="sd">        n_proc : int, default 10</span>
</span><span id="L-2451"><a href="#L-2451"><span class="linenos">2451</span></a><span class="sd">            Number of parallel jobs to use.</span>
</span><span id="L-2452"><a href="#L-2452"><span class="linenos">2452</span></a>
</span><span id="L-2453"><a href="#L-2453"><span class="linenos">2453</span></a><span class="sd">        Returns</span>
</span><span id="L-2454"><a href="#L-2454"><span class="linenos">2454</span></a><span class="sd">        -------</span>
</span><span id="L-2455"><a href="#L-2455"><span class="linenos">2455</span></a><span class="sd">        pandas.DataFrame or dict</span>
</span><span id="L-2456"><a href="#L-2456"><span class="linenos">2456</span></a><span class="sd">            Results DataFrame (or dict containing valid/control cells + DataFrame),</span>
</span><span id="L-2457"><a href="#L-2457"><span class="linenos">2457</span></a><span class="sd">            similar to `calc_DEG` interface.</span>
</span><span id="L-2458"><a href="#L-2458"><span class="linenos">2458</span></a>
</span><span id="L-2459"><a href="#L-2459"><span class="linenos">2459</span></a><span class="sd">        Raises</span>
</span><span id="L-2460"><a href="#L-2460"><span class="linenos">2460</span></a><span class="sd">        ------</span>
</span><span id="L-2461"><a href="#L-2461"><span class="linenos">2461</span></a><span class="sd">        ValueError</span>
</span><span id="L-2462"><a href="#L-2462"><span class="linenos">2462</span></a><span class="sd">            If neither `cells` nor `sets` is provided, or input metadata mismatch occurs.</span>
</span><span id="L-2463"><a href="#L-2463"><span class="linenos">2463</span></a>
</span><span id="L-2464"><a href="#L-2464"><span class="linenos">2464</span></a><span class="sd">        Notes</span>
</span><span id="L-2465"><a href="#L-2465"><span class="linenos">2465</span></a><span class="sd">        -----</span>
</span><span id="L-2466"><a href="#L-2466"><span class="linenos">2466</span></a><span class="sd">        Multiple modes supported: single-list entities, &#39;All&#39;, pairwise dicts, etc.</span>
</span><span id="L-2467"><a href="#L-2467"><span class="linenos">2467</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2468"><a href="#L-2468"><span class="linenos">2468</span></a>
</span><span id="L-2469"><a href="#L-2469"><span class="linenos">2469</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">stat_calc</span><span class="p">(</span><span class="n">choose</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">):</span>
</span><span id="L-2470"><a href="#L-2470"><span class="linenos">2470</span></a>            <span class="n">target_values</span> <span class="o">=</span> <span class="n">choose</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">]</span>
</span><span id="L-2471"><a href="#L-2471"><span class="linenos">2471</span></a>            <span class="n">rest_values</span> <span class="o">=</span> <span class="n">choose</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rest&quot;</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">]</span>
</span><span id="L-2472"><a href="#L-2472"><span class="linenos">2472</span></a>
</span><span id="L-2473"><a href="#L-2473"><span class="linenos">2473</span></a>            <span class="n">pct_valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_values</span><span class="p">)</span>
</span><span id="L-2474"><a href="#L-2474"><span class="linenos">2474</span></a>            <span class="n">pct_rest</span> <span class="o">=</span> <span class="p">(</span><span class="n">rest_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest_values</span><span class="p">)</span>
</span><span id="L-2475"><a href="#L-2475"><span class="linenos">2475</span></a>
</span><span id="L-2476"><a href="#L-2476"><span class="linenos">2476</span></a>            <span class="n">avg_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_values</span><span class="p">)</span>
</span><span id="L-2477"><a href="#L-2477"><span class="linenos">2477</span></a>            <span class="n">avg_ctrl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rest_values</span><span class="p">)</span>
</span><span id="L-2478"><a href="#L-2478"><span class="linenos">2478</span></a>            <span class="n">sd_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">target_values</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-2479"><a href="#L-2479"><span class="linenos">2479</span></a>            <span class="n">sd_ctrl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">rest_values</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-2480"><a href="#L-2480"><span class="linenos">2480</span></a>            <span class="n">esm</span> <span class="o">=</span> <span class="p">(</span><span class="n">avg_valid</span> <span class="o">-</span> <span class="n">avg_ctrl</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">sd_valid</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sd_ctrl</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="L-2481"><a href="#L-2481"><span class="linenos">2481</span></a>
</span><span id="L-2482"><a href="#L-2482"><span class="linenos">2482</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">target_values</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rest_values</span><span class="p">):</span>
</span><span id="L-2483"><a href="#L-2483"><span class="linenos">2483</span></a>                <span class="n">p_val</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-2484"><a href="#L-2484"><span class="linenos">2484</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2485"><a href="#L-2485"><span class="linenos">2485</span></a>                <span class="n">_</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span>
</span><span id="L-2486"><a href="#L-2486"><span class="linenos">2486</span></a>                    <span class="n">target_values</span><span class="p">,</span> <span class="n">rest_values</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s2">&quot;two-sided&quot;</span>
</span><span id="L-2487"><a href="#L-2487"><span class="linenos">2487</span></a>                <span class="p">)</span>
</span><span id="L-2488"><a href="#L-2488"><span class="linenos">2488</span></a>
</span><span id="L-2489"><a href="#L-2489"><span class="linenos">2489</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="L-2490"><a href="#L-2490"><span class="linenos">2490</span></a>                <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="n">feature_name</span><span class="p">,</span>
</span><span id="L-2491"><a href="#L-2491"><span class="linenos">2491</span></a>                <span class="s2">&quot;p_val&quot;</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
</span><span id="L-2492"><a href="#L-2492"><span class="linenos">2492</span></a>                <span class="s2">&quot;pct_valid&quot;</span><span class="p">:</span> <span class="n">pct_valid</span><span class="p">,</span>
</span><span id="L-2493"><a href="#L-2493"><span class="linenos">2493</span></a>                <span class="s2">&quot;pct_ctrl&quot;</span><span class="p">:</span> <span class="n">pct_rest</span><span class="p">,</span>
</span><span id="L-2494"><a href="#L-2494"><span class="linenos">2494</span></a>                <span class="s2">&quot;avg_valid&quot;</span><span class="p">:</span> <span class="n">avg_valid</span><span class="p">,</span>
</span><span id="L-2495"><a href="#L-2495"><span class="linenos">2495</span></a>                <span class="s2">&quot;avg_ctrl&quot;</span><span class="p">:</span> <span class="n">avg_ctrl</span><span class="p">,</span>
</span><span id="L-2496"><a href="#L-2496"><span class="linenos">2496</span></a>                <span class="s2">&quot;sd_valid&quot;</span><span class="p">:</span> <span class="n">sd_valid</span><span class="p">,</span>
</span><span id="L-2497"><a href="#L-2497"><span class="linenos">2497</span></a>                <span class="s2">&quot;sd_ctrl&quot;</span><span class="p">:</span> <span class="n">sd_ctrl</span><span class="p">,</span>
</span><span id="L-2498"><a href="#L-2498"><span class="linenos">2498</span></a>                <span class="s2">&quot;esm&quot;</span><span class="p">:</span> <span class="n">esm</span><span class="p">,</span>
</span><span id="L-2499"><a href="#L-2499"><span class="linenos">2499</span></a>            <span class="p">}</span>
</span><span id="L-2500"><a href="#L-2500"><span class="linenos">2500</span></a>
</span><span id="L-2501"><a href="#L-2501"><span class="linenos">2501</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">prepare_and_run_stat</span><span class="p">(</span>
</span><span id="L-2502"><a href="#L-2502"><span class="linenos">2502</span></a>            <span class="n">choose</span><span class="p">,</span> <span class="n">valid_group</span><span class="p">,</span> <span class="n">min_exp</span><span class="p">,</span> <span class="n">min_pct</span><span class="p">,</span> <span class="n">n_proc</span><span class="p">,</span> <span class="n">factors</span>
</span><span id="L-2503"><a href="#L-2503"><span class="linenos">2503</span></a>        <span class="p">):</span>
</span><span id="L-2504"><a href="#L-2504"><span class="linenos">2504</span></a>
</span><span id="L-2505"><a href="#L-2505"><span class="linenos">2505</span></a>            <span class="n">tmp_dat</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">]</span>
</span><span id="L-2506"><a href="#L-2506"><span class="linenos">2506</span></a>            <span class="n">tmp_dat</span> <span class="o">=</span> <span class="n">tmp_dat</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;DEG&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-2507"><a href="#L-2507"><span class="linenos">2507</span></a>
</span><span id="L-2508"><a href="#L-2508"><span class="linenos">2508</span></a>            <span class="n">counts</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp_dat</span> <span class="o">&gt;</span> <span class="n">min_exp</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2509"><a href="#L-2509"><span class="linenos">2509</span></a>
</span><span id="L-2510"><a href="#L-2510"><span class="linenos">2510</span></a>            <span class="n">total_count</span> <span class="o">=</span> <span class="n">tmp_dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2511"><a href="#L-2511"><span class="linenos">2511</span></a>
</span><span id="L-2512"><a href="#L-2512"><span class="linenos">2512</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="L-2513"><a href="#L-2513"><span class="linenos">2513</span></a>                <span class="p">{</span><span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmp_dat</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="s2">&quot;pct&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">counts</span> <span class="o">/</span> <span class="n">total_count</span><span class="p">)}</span>
</span><span id="L-2514"><a href="#L-2514"><span class="linenos">2514</span></a>            <span class="p">)</span>
</span><span id="L-2515"><a href="#L-2515"><span class="linenos">2515</span></a>
</span><span id="L-2516"><a href="#L-2516"><span class="linenos">2516</span></a>            <span class="k">del</span> <span class="n">tmp_dat</span>
</span><span id="L-2517"><a href="#L-2517"><span class="linenos">2517</span></a>
</span><span id="L-2518"><a href="#L-2518"><span class="linenos">2518</span></a>            <span class="n">drop_col</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">][</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">min_pct</span><span class="p">]</span>
</span><span id="L-2519"><a href="#L-2519"><span class="linenos">2519</span></a>
</span><span id="L-2520"><a href="#L-2520"><span class="linenos">2520</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">drop_col</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
</span><span id="L-2521"><a href="#L-2521"><span class="linenos">2521</span></a>                <span class="n">drop_col</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">][</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-2522"><a href="#L-2522"><span class="linenos">2522</span></a>
</span><span id="L-2523"><a href="#L-2523"><span class="linenos">2523</span></a>            <span class="k">del</span> <span class="n">info</span>
</span><span id="L-2524"><a href="#L-2524"><span class="linenos">2524</span></a>
</span><span id="L-2525"><a href="#L-2525"><span class="linenos">2525</span></a>            <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">drop_col</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-2526"><a href="#L-2526"><span class="linenos">2526</span></a>
</span><span id="L-2527"><a href="#L-2527"><span class="linenos">2527</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_proc</span><span class="p">)(</span>
</span><span id="L-2528"><a href="#L-2528"><span class="linenos">2528</span></a>                <span class="n">delayed</span><span class="p">(</span><span class="n">stat_calc</span><span class="p">)(</span><span class="n">choose</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>
</span><span id="L-2529"><a href="#L-2529"><span class="linenos">2529</span></a>                <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">choose</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="s2">&quot;DEG&quot;</span><span class="p">])</span>
</span><span id="L-2530"><a href="#L-2530"><span class="linenos">2530</span></a>            <span class="p">)</span>
</span><span id="L-2531"><a href="#L-2531"><span class="linenos">2531</span></a>
</span><span id="L-2532"><a href="#L-2532"><span class="linenos">2532</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="L-2533"><a href="#L-2533"><span class="linenos">2533</span></a>            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_group</span>
</span><span id="L-2534"><a href="#L-2534"><span class="linenos">2534</span></a>            <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;p_val&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2535"><a href="#L-2535"><span class="linenos">2535</span></a>
</span><span id="L-2536"><a href="#L-2536"><span class="linenos">2536</span></a>            <span class="n">num_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="L-2537"><a href="#L-2537"><span class="linenos">2537</span></a>            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;adj_pval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
</span><span id="L-2538"><a href="#L-2538"><span class="linenos">2538</span></a>                <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;p_val&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_tests</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_tests</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-2539"><a href="#L-2539"><span class="linenos">2539</span></a>            <span class="p">)</span>
</span><span id="L-2540"><a href="#L-2540"><span class="linenos">2540</span></a>
</span><span id="L-2541"><a href="#L-2541"><span class="linenos">2541</span></a>            <span class="n">factors_df</span> <span class="o">=</span> <span class="n">factors</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;factor&quot;</span><span class="p">)</span>
</span><span id="L-2542"><a href="#L-2542"><span class="linenos">2542</span></a>
</span><span id="L-2543"><a href="#L-2543"><span class="linenos">2543</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">factors_df</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;feature&quot;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
</span><span id="L-2544"><a href="#L-2544"><span class="linenos">2544</span></a>
</span><span id="L-2545"><a href="#L-2545"><span class="linenos">2545</span></a>            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;FC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;factor&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
</span><span id="L-2546"><a href="#L-2546"><span class="linenos">2546</span></a>                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;factor&quot;</span><span class="p">]</span>
</span><span id="L-2547"><a href="#L-2547"><span class="linenos">2547</span></a>            <span class="p">)</span>
</span><span id="L-2548"><a href="#L-2548"><span class="linenos">2548</span></a>            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;log(FC)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;FC&quot;</span><span class="p">])</span>
</span><span id="L-2549"><a href="#L-2549"><span class="linenos">2549</span></a>            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;norm_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span>
</span><span id="L-2550"><a href="#L-2550"><span class="linenos">2550</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;factor&quot;</span><span class="p">])</span>
</span><span id="L-2551"><a href="#L-2551"><span class="linenos">2551</span></a>
</span><span id="L-2552"><a href="#L-2552"><span class="linenos">2552</span></a>            <span class="k">return</span> <span class="n">df</span>
</span><span id="L-2553"><a href="#L-2553"><span class="linenos">2553</span></a>
</span><span id="L-2554"><a href="#L-2554"><span class="linenos">2554</span></a>        <span class="n">choose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-2555"><a href="#L-2555"><span class="linenos">2555</span></a>        <span class="n">factors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-2556"><a href="#L-2556"><span class="linenos">2556</span></a>        <span class="n">factors</span><span class="p">[</span><span class="n">factors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">factors</span><span class="p">[</span><span class="n">factors</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="L-2557"><a href="#L-2557"><span class="linenos">2557</span></a>
</span><span id="L-2558"><a href="#L-2558"><span class="linenos">2558</span></a>        <span class="n">final_results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2559"><a href="#L-2559"><span class="linenos">2559</span></a>
</span><span id="L-2560"><a href="#L-2560"><span class="linenos">2560</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cells</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2561"><a href="#L-2561"><span class="linenos">2561</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis started...</span><span class="se">\n</span><span class="s2">Comparing selected cells to the whole set...&quot;</span><span class="p">)</span>
</span><span id="L-2562"><a href="#L-2562"><span class="linenos">2562</span></a>            <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-2563"><a href="#L-2563"><span class="linenos">2563</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-2564"><a href="#L-2564"><span class="linenos">2564</span></a>            <span class="p">)</span>
</span><span id="L-2565"><a href="#L-2565"><span class="linenos">2565</span></a>
</span><span id="L-2566"><a href="#L-2566"><span class="linenos">2566</span></a>            <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-2567"><a href="#L-2567"><span class="linenos">2567</span></a>                <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span>
</span><span id="L-2568"><a href="#L-2568"><span class="linenos">2568</span></a>
</span><span id="L-2569"><a href="#L-2569"><span class="linenos">2569</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="L-2570"><a href="#L-2570"><span class="linenos">2570</span></a>                    <span class="s2">&quot;Not include the set info (name # set) in the &#39;cells&#39; list. &quot;</span>
</span><span id="L-2571"><a href="#L-2571"><span class="linenos">2571</span></a>                    <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="L-2572"><a href="#L-2572"><span class="linenos">2572</span></a>                <span class="p">)</span>
</span><span id="L-2573"><a href="#L-2573"><span class="linenos">2573</span></a>
</span><span id="L-2574"><a href="#L-2574"><span class="linenos">2574</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;target&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">cells</span> <span class="k">else</span> <span class="s2">&quot;rest&quot;</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-2575"><a href="#L-2575"><span class="linenos">2575</span></a>            <span class="n">valid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-2576"><a href="#L-2576"><span class="linenos">2576</span></a>                <span class="nb">set</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">]])</span>
</span><span id="L-2577"><a href="#L-2577"><span class="linenos">2577</span></a>            <span class="p">)</span>
</span><span id="L-2578"><a href="#L-2578"><span class="linenos">2578</span></a>
</span><span id="L-2579"><a href="#L-2579"><span class="linenos">2579</span></a>            <span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span id="L-2580"><a href="#L-2580"><span class="linenos">2580</span></a>            <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="L-2581"><a href="#L-2581"><span class="linenos">2581</span></a>
</span><span id="L-2582"><a href="#L-2582"><span class="linenos">2582</span></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="n">prepare_and_run_stat</span><span class="p">(</span>
</span><span id="L-2583"><a href="#L-2583"><span class="linenos">2583</span></a>                <span class="n">choose</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="L-2584"><a href="#L-2584"><span class="linenos">2584</span></a>                <span class="n">valid_group</span><span class="o">=</span><span class="n">valid</span><span class="p">,</span>
</span><span id="L-2585"><a href="#L-2585"><span class="linenos">2585</span></a>                <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span>
</span><span id="L-2586"><a href="#L-2586"><span class="linenos">2586</span></a>                <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span>
</span><span id="L-2587"><a href="#L-2587"><span class="linenos">2587</span></a>                <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span>
</span><span id="L-2588"><a href="#L-2588"><span class="linenos">2588</span></a>                <span class="n">factors</span><span class="o">=</span><span class="n">factors</span><span class="p">,</span>
</span><span id="L-2589"><a href="#L-2589"><span class="linenos">2589</span></a>            <span class="p">)</span>
</span><span id="L-2590"><a href="#L-2590"><span class="linenos">2590</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;valid_cells&quot;</span><span class="p">:</span> <span class="n">valid</span><span class="p">,</span> <span class="s2">&quot;control_cells&quot;</span><span class="p">:</span> <span class="s2">&quot;rest&quot;</span><span class="p">,</span> <span class="s2">&quot;DEG&quot;</span><span class="p">:</span> <span class="n">result_df</span><span class="p">}</span>
</span><span id="L-2591"><a href="#L-2591"><span class="linenos">2591</span></a>
</span><span id="L-2592"><a href="#L-2592"><span class="linenos">2592</span></a>        <span class="k">elif</span> <span class="n">cells</span> <span class="o">==</span> <span class="s2">&quot;All&quot;</span> <span class="ow">and</span> <span class="n">sets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2593"><a href="#L-2593"><span class="linenos">2593</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis started...</span><span class="se">\n</span><span class="s2">Comparing each type of cell to others...&quot;</span><span class="p">)</span>
</span><span id="L-2594"><a href="#L-2594"><span class="linenos">2594</span></a>            <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-2595"><a href="#L-2595"><span class="linenos">2595</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-2596"><a href="#L-2596"><span class="linenos">2596</span></a>            <span class="p">)</span>
</span><span id="L-2597"><a href="#L-2597"><span class="linenos">2597</span></a>            <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="L-2598"><a href="#L-2598"><span class="linenos">2598</span></a>
</span><span id="L-2599"><a href="#L-2599"><span class="linenos">2599</span></a>            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">):</span>
</span><span id="L-2600"><a href="#L-2600"><span class="linenos">2600</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calculating statistics for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2601"><a href="#L-2601"><span class="linenos">2601</span></a>                <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;target&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">label</span> <span class="k">else</span> <span class="s2">&quot;rest&quot;</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-2602"><a href="#L-2602"><span class="linenos">2602</span></a>                <span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span id="L-2603"><a href="#L-2603"><span class="linenos">2603</span></a>                <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="L-2604"><a href="#L-2604"><span class="linenos">2604</span></a>                <span class="n">result_df</span> <span class="o">=</span> <span class="n">prepare_and_run_stat</span><span class="p">(</span>
</span><span id="L-2605"><a href="#L-2605"><span class="linenos">2605</span></a>                    <span class="n">choose</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
</span><span id="L-2606"><a href="#L-2606"><span class="linenos">2606</span></a>                    <span class="n">valid_group</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
</span><span id="L-2607"><a href="#L-2607"><span class="linenos">2607</span></a>                    <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span>
</span><span id="L-2608"><a href="#L-2608"><span class="linenos">2608</span></a>                    <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span>
</span><span id="L-2609"><a href="#L-2609"><span class="linenos">2609</span></a>                    <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span>
</span><span id="L-2610"><a href="#L-2610"><span class="linenos">2610</span></a>                    <span class="n">factors</span><span class="o">=</span><span class="n">factors</span><span class="p">,</span>
</span><span id="L-2611"><a href="#L-2611"><span class="linenos">2611</span></a>                <span class="p">)</span>
</span><span id="L-2612"><a href="#L-2612"><span class="linenos">2612</span></a>                <span class="n">final_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_df</span><span class="p">)</span>
</span><span id="L-2613"><a href="#L-2613"><span class="linenos">2613</span></a>
</span><span id="L-2614"><a href="#L-2614"><span class="linenos">2614</span></a>            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">final_results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2615"><a href="#L-2615"><span class="linenos">2615</span></a>
</span><span id="L-2616"><a href="#L-2616"><span class="linenos">2616</span></a>        <span class="k">elif</span> <span class="n">cells</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sets</span> <span class="o">==</span> <span class="s2">&quot;All&quot;</span><span class="p">:</span>
</span><span id="L-2617"><a href="#L-2617"><span class="linenos">2617</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis started...</span><span class="se">\n</span><span class="s2">Comparing each set/group to others...&quot;</span><span class="p">)</span>
</span><span id="L-2618"><a href="#L-2618"><span class="linenos">2618</span></a>            <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-2619"><a href="#L-2619"><span class="linenos">2619</span></a>            <span class="n">unique_sets</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="L-2620"><a href="#L-2620"><span class="linenos">2620</span></a>
</span><span id="L-2621"><a href="#L-2621"><span class="linenos">2621</span></a>            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">unique_sets</span><span class="p">):</span>
</span><span id="L-2622"><a href="#L-2622"><span class="linenos">2622</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calculating statistics for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2623"><a href="#L-2623"><span class="linenos">2623</span></a>                <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;target&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">label</span> <span class="k">else</span> <span class="s2">&quot;rest&quot;</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-2624"><a href="#L-2624"><span class="linenos">2624</span></a>
</span><span id="L-2625"><a href="#L-2625"><span class="linenos">2625</span></a>                <span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span id="L-2626"><a href="#L-2626"><span class="linenos">2626</span></a>                <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="L-2627"><a href="#L-2627"><span class="linenos">2627</span></a>                <span class="n">result_df</span> <span class="o">=</span> <span class="n">prepare_and_run_stat</span><span class="p">(</span>
</span><span id="L-2628"><a href="#L-2628"><span class="linenos">2628</span></a>                    <span class="n">choose</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
</span><span id="L-2629"><a href="#L-2629"><span class="linenos">2629</span></a>                    <span class="n">valid_group</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
</span><span id="L-2630"><a href="#L-2630"><span class="linenos">2630</span></a>                    <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span>
</span><span id="L-2631"><a href="#L-2631"><span class="linenos">2631</span></a>                    <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span>
</span><span id="L-2632"><a href="#L-2632"><span class="linenos">2632</span></a>                    <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span>
</span><span id="L-2633"><a href="#L-2633"><span class="linenos">2633</span></a>                    <span class="n">factors</span><span class="o">=</span><span class="n">factors</span><span class="p">,</span>
</span><span id="L-2634"><a href="#L-2634"><span class="linenos">2634</span></a>                <span class="p">)</span>
</span><span id="L-2635"><a href="#L-2635"><span class="linenos">2635</span></a>                <span class="n">final_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_df</span><span class="p">)</span>
</span><span id="L-2636"><a href="#L-2636"><span class="linenos">2636</span></a>
</span><span id="L-2637"><a href="#L-2637"><span class="linenos">2637</span></a>            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">final_results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2638"><a href="#L-2638"><span class="linenos">2638</span></a>
</span><span id="L-2639"><a href="#L-2639"><span class="linenos">2639</span></a>        <span class="k">elif</span> <span class="n">cells</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sets</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="L-2640"><a href="#L-2640"><span class="linenos">2640</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis started...</span><span class="se">\n</span><span class="s2">Comparing groups...&quot;</span><span class="p">)</span>
</span><span id="L-2641"><a href="#L-2641"><span class="linenos">2641</span></a>
</span><span id="L-2642"><a href="#L-2642"><span class="linenos">2642</span></a>            <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-2643"><a href="#L-2643"><span class="linenos">2643</span></a>
</span><span id="L-2644"><a href="#L-2644"><span class="linenos">2644</span></a>            <span class="n">group_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-2645"><a href="#L-2645"><span class="linenos">2645</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-2646"><a href="#L-2646"><span class="linenos">2646</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only pairwise group comparison is supported.&quot;</span><span class="p">)</span>
</span><span id="L-2647"><a href="#L-2647"><span class="linenos">2647</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-2648"><a href="#L-2648"><span class="linenos">2648</span></a>
</span><span id="L-2649"><a href="#L-2649"><span class="linenos">2649</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-2650"><a href="#L-2650"><span class="linenos">2650</span></a>                <span class="p">(</span>
</span><span id="L-2651"><a href="#L-2651"><span class="linenos">2651</span></a>                    <span class="s2">&quot;target&quot;</span>
</span><span id="L-2652"><a href="#L-2652"><span class="linenos">2652</span></a>                    <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">[</span><span class="n">group_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-2653"><a href="#L-2653"><span class="linenos">2653</span></a>                    <span class="k">else</span> <span class="s2">&quot;rest&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">[</span><span class="n">group_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">else</span> <span class="s2">&quot;drop&quot;</span>
</span><span id="L-2654"><a href="#L-2654"><span class="linenos">2654</span></a>                <span class="p">)</span>
</span><span id="L-2655"><a href="#L-2655"><span class="linenos">2655</span></a>                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">choose</span><span class="o">.</span><span class="n">index</span>
</span><span id="L-2656"><a href="#L-2656"><span class="linenos">2656</span></a>            <span class="p">]</span>
</span><span id="L-2657"><a href="#L-2657"><span class="linenos">2657</span></a>            <span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span id="L-2658"><a href="#L-2658"><span class="linenos">2658</span></a>            <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="L-2659"><a href="#L-2659"><span class="linenos">2659</span></a>
</span><span id="L-2660"><a href="#L-2660"><span class="linenos">2660</span></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="n">prepare_and_run_stat</span><span class="p">(</span>
</span><span id="L-2661"><a href="#L-2661"><span class="linenos">2661</span></a>                <span class="n">choose</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="L-2662"><a href="#L-2662"><span class="linenos">2662</span></a>                <span class="n">valid_group</span><span class="o">=</span><span class="n">group_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-2663"><a href="#L-2663"><span class="linenos">2663</span></a>                <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span>
</span><span id="L-2664"><a href="#L-2664"><span class="linenos">2664</span></a>                <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span>
</span><span id="L-2665"><a href="#L-2665"><span class="linenos">2665</span></a>                <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span>
</span><span id="L-2666"><a href="#L-2666"><span class="linenos">2666</span></a>                <span class="n">factors</span><span class="o">=</span><span class="n">factors</span><span class="p">,</span>
</span><span id="L-2667"><a href="#L-2667"><span class="linenos">2667</span></a>            <span class="p">)</span>
</span><span id="L-2668"><a href="#L-2668"><span class="linenos">2668</span></a>            <span class="k">return</span> <span class="n">result_df</span>
</span><span id="L-2669"><a href="#L-2669"><span class="linenos">2669</span></a>
</span><span id="L-2670"><a href="#L-2670"><span class="linenos">2670</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cells</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2671"><a href="#L-2671"><span class="linenos">2671</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis started...</span><span class="se">\n</span><span class="s2">Comparing groups...&quot;</span><span class="p">)</span>
</span><span id="L-2672"><a href="#L-2672"><span class="linenos">2672</span></a>            <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-2673"><a href="#L-2673"><span class="linenos">2673</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-2674"><a href="#L-2674"><span class="linenos">2674</span></a>            <span class="p">)</span>
</span><span id="L-2675"><a href="#L-2675"><span class="linenos">2675</span></a>
</span><span id="L-2676"><a href="#L-2676"><span class="linenos">2676</span></a>            <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">cells</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-2677"><a href="#L-2677"><span class="linenos">2677</span></a>                <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span>
</span><span id="L-2678"><a href="#L-2678"><span class="linenos">2678</span></a>
</span><span id="L-2679"><a href="#L-2679"><span class="linenos">2679</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="L-2680"><a href="#L-2680"><span class="linenos">2680</span></a>                    <span class="s2">&quot;Not include the set info (name # set) in the &#39;cells&#39; dict. &quot;</span>
</span><span id="L-2681"><a href="#L-2681"><span class="linenos">2681</span></a>                    <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="L-2682"><a href="#L-2682"><span class="linenos">2682</span></a>                <span class="p">)</span>
</span><span id="L-2683"><a href="#L-2683"><span class="linenos">2683</span></a>
</span><span id="L-2684"><a href="#L-2684"><span class="linenos">2684</span></a>            <span class="n">group_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cells</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-2685"><a href="#L-2685"><span class="linenos">2685</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-2686"><a href="#L-2686"><span class="linenos">2686</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only pairwise group comparison is supported.&quot;</span><span class="p">)</span>
</span><span id="L-2687"><a href="#L-2687"><span class="linenos">2687</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-2688"><a href="#L-2688"><span class="linenos">2688</span></a>
</span><span id="L-2689"><a href="#L-2689"><span class="linenos">2689</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-2690"><a href="#L-2690"><span class="linenos">2690</span></a>                <span class="p">(</span>
</span><span id="L-2691"><a href="#L-2691"><span class="linenos">2691</span></a>                    <span class="s2">&quot;target&quot;</span>
</span><span id="L-2692"><a href="#L-2692"><span class="linenos">2692</span></a>                    <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">[</span><span class="n">group_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-2693"><a href="#L-2693"><span class="linenos">2693</span></a>                    <span class="k">else</span> <span class="s2">&quot;rest&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">[</span><span class="n">group_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">else</span> <span class="s2">&quot;drop&quot;</span>
</span><span id="L-2694"><a href="#L-2694"><span class="linenos">2694</span></a>                <span class="p">)</span>
</span><span id="L-2695"><a href="#L-2695"><span class="linenos">2695</span></a>                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">choose</span><span class="o">.</span><span class="n">index</span>
</span><span id="L-2696"><a href="#L-2696"><span class="linenos">2696</span></a>            <span class="p">]</span>
</span><span id="L-2697"><a href="#L-2697"><span class="linenos">2697</span></a>
</span><span id="L-2698"><a href="#L-2698"><span class="linenos">2698</span></a>            <span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span id="L-2699"><a href="#L-2699"><span class="linenos">2699</span></a>            <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="L-2700"><a href="#L-2700"><span class="linenos">2700</span></a>
</span><span id="L-2701"><a href="#L-2701"><span class="linenos">2701</span></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="n">prepare_and_run_stat</span><span class="p">(</span>
</span><span id="L-2702"><a href="#L-2702"><span class="linenos">2702</span></a>                <span class="n">choose</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="L-2703"><a href="#L-2703"><span class="linenos">2703</span></a>                <span class="n">valid_group</span><span class="o">=</span><span class="n">group_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-2704"><a href="#L-2704"><span class="linenos">2704</span></a>                <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span>
</span><span id="L-2705"><a href="#L-2705"><span class="linenos">2705</span></a>                <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span>
</span><span id="L-2706"><a href="#L-2706"><span class="linenos">2706</span></a>                <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span>
</span><span id="L-2707"><a href="#L-2707"><span class="linenos">2707</span></a>                <span class="n">factors</span><span class="o">=</span><span class="n">factors</span><span class="p">,</span>
</span><span id="L-2708"><a href="#L-2708"><span class="linenos">2708</span></a>            <span class="p">)</span>
</span><span id="L-2709"><a href="#L-2709"><span class="linenos">2709</span></a>
</span><span id="L-2710"><a href="#L-2710"><span class="linenos">2710</span></a>            <span class="k">return</span> <span class="n">result_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2711"><a href="#L-2711"><span class="linenos">2711</span></a>
</span><span id="L-2712"><a href="#L-2712"><span class="linenos">2712</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2713"><a href="#L-2713"><span class="linenos">2713</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-2714"><a href="#L-2714"><span class="linenos">2714</span></a>                <span class="s2">&quot;You must specify either &#39;cells&#39; or &#39;sets&#39; (or both). None were provided, which is not allowed for this analysis.&quot;</span>
</span><span id="L-2715"><a href="#L-2715"><span class="linenos">2715</span></a>            <span class="p">)</span>
</span><span id="L-2716"><a href="#L-2716"><span class="linenos">2716</span></a>
</span><span id="L-2717"><a href="#L-2717"><span class="linenos">2717</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_difference_markers</span><span class="p">(</span>
</span><span id="L-2718"><a href="#L-2718"><span class="linenos">2718</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">min_exp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_pct</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-2719"><a href="#L-2719"><span class="linenos">2719</span></a>    <span class="p">):</span>
</span><span id="L-2720"><a href="#L-2720"><span class="linenos">2720</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2721"><a href="#L-2721"><span class="linenos">2721</span></a><span class="sd">        Compute differential markers (var_data) if not already present.</span>
</span><span id="L-2722"><a href="#L-2722"><span class="linenos">2722</span></a>
</span><span id="L-2723"><a href="#L-2723"><span class="linenos">2723</span></a><span class="sd">        Parameters</span>
</span><span id="L-2724"><a href="#L-2724"><span class="linenos">2724</span></a><span class="sd">        ----------</span>
</span><span id="L-2725"><a href="#L-2725"><span class="linenos">2725</span></a><span class="sd">        min_exp : float, default 0</span>
</span><span id="L-2726"><a href="#L-2726"><span class="linenos">2726</span></a><span class="sd">            Minimum expression threshold passed to `statistic`.</span>
</span><span id="L-2727"><a href="#L-2727"><span class="linenos">2727</span></a>
</span><span id="L-2728"><a href="#L-2728"><span class="linenos">2728</span></a><span class="sd">        min_pct : float, default 0.25</span>
</span><span id="L-2729"><a href="#L-2729"><span class="linenos">2729</span></a><span class="sd">            Minimum percent expressed in target group.</span>
</span><span id="L-2730"><a href="#L-2730"><span class="linenos">2730</span></a>
</span><span id="L-2731"><a href="#L-2731"><span class="linenos">2731</span></a><span class="sd">        n_proc : int, default 10</span>
</span><span id="L-2732"><a href="#L-2732"><span class="linenos">2732</span></a><span class="sd">            Parallel jobs.</span>
</span><span id="L-2733"><a href="#L-2733"><span class="linenos">2733</span></a>
</span><span id="L-2734"><a href="#L-2734"><span class="linenos">2734</span></a><span class="sd">        force : bool, default False</span>
</span><span id="L-2735"><a href="#L-2735"><span class="linenos">2735</span></a><span class="sd">            If True, recompute even if `self.var_data` is present.</span>
</span><span id="L-2736"><a href="#L-2736"><span class="linenos">2736</span></a>
</span><span id="L-2737"><a href="#L-2737"><span class="linenos">2737</span></a><span class="sd">        Update</span>
</span><span id="L-2738"><a href="#L-2738"><span class="linenos">2738</span></a><span class="sd">        -------</span>
</span><span id="L-2739"><a href="#L-2739"><span class="linenos">2739</span></a><span class="sd">        Sets `self.var_data` to the result of `self.statistic(...)`.</span>
</span><span id="L-2740"><a href="#L-2740"><span class="linenos">2740</span></a>
</span><span id="L-2741"><a href="#L-2741"><span class="linenos">2741</span></a><span class="sd">        Raise</span>
</span><span id="L-2742"><a href="#L-2742"><span class="linenos">2742</span></a><span class="sd">        ------</span>
</span><span id="L-2743"><a href="#L-2743"><span class="linenos">2743</span></a><span class="sd">        ValueError if already computed and `force` is False.</span>
</span><span id="L-2744"><a href="#L-2744"><span class="linenos">2744</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2745"><a href="#L-2745"><span class="linenos">2745</span></a>
</span><span id="L-2746"><a href="#L-2746"><span class="linenos">2746</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
</span><span id="L-2747"><a href="#L-2747"><span class="linenos">2747</span></a>
</span><span id="L-2748"><a href="#L-2748"><span class="linenos">2748</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="p">(</span>
</span><span id="L-2749"><a href="#L-2749"><span class="linenos">2749</span></a>                <span class="n">cells</span><span class="o">=</span><span class="s2">&quot;All&quot;</span><span class="p">,</span> <span class="n">sets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span> <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span>
</span><span id="L-2750"><a href="#L-2750"><span class="linenos">2750</span></a>            <span class="p">)</span>
</span><span id="L-2751"><a href="#L-2751"><span class="linenos">2751</span></a>
</span><span id="L-2752"><a href="#L-2752"><span class="linenos">2752</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2753"><a href="#L-2753"><span class="linenos">2753</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-2754"><a href="#L-2754"><span class="linenos">2754</span></a>                <span class="s2">&quot;self.calculate_difference_markers() has already been executed. &quot;</span>
</span><span id="L-2755"><a href="#L-2755"><span class="linenos">2755</span></a>                <span class="s2">&quot;The results are stored in self.var. &quot;</span>
</span><span id="L-2756"><a href="#L-2756"><span class="linenos">2756</span></a>                <span class="s2">&quot;If you want to recalculate with different statistics, please rerun the method with force=True.&quot;</span>
</span><span id="L-2757"><a href="#L-2757"><span class="linenos">2757</span></a>            <span class="p">)</span>
</span><span id="L-2758"><a href="#L-2758"><span class="linenos">2758</span></a>
</span><span id="L-2759"><a href="#L-2759"><span class="linenos">2759</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clustering_features</span><span class="p">(</span>
</span><span id="L-2760"><a href="#L-2760"><span class="linenos">2760</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-2761"><a href="#L-2761"><span class="linenos">2761</span></a>        <span class="n">features_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-2762"><a href="#L-2762"><span class="linenos">2762</span></a>        <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="L-2763"><a href="#L-2763"><span class="linenos">2763</span></a>        <span class="n">p_val</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
</span><span id="L-2764"><a href="#L-2764"><span class="linenos">2764</span></a>        <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
</span><span id="L-2765"><a href="#L-2765"><span class="linenos">2765</span></a>        <span class="n">adj_mean</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-2766"><a href="#L-2766"><span class="linenos">2766</span></a>        <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
</span><span id="L-2767"><a href="#L-2767"><span class="linenos">2767</span></a>    <span class="p">):</span>
</span><span id="L-2768"><a href="#L-2768"><span class="linenos">2768</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2769"><a href="#L-2769"><span class="linenos">2769</span></a><span class="sd">        Prepare clustering input by selecting marker features and optionally smoothing cell values</span>
</span><span id="L-2770"><a href="#L-2770"><span class="linenos">2770</span></a><span class="sd">        toward group means.</span>
</span><span id="L-2771"><a href="#L-2771"><span class="linenos">2771</span></a>
</span><span id="L-2772"><a href="#L-2772"><span class="linenos">2772</span></a><span class="sd">        Parameters</span>
</span><span id="L-2773"><a href="#L-2773"><span class="linenos">2773</span></a><span class="sd">        ----------</span>
</span><span id="L-2774"><a href="#L-2774"><span class="linenos">2774</span></a><span class="sd">        features_list : list or None</span>
</span><span id="L-2775"><a href="#L-2775"><span class="linenos">2775</span></a><span class="sd">            If provided, use this list of features. If None, features are selected</span>
</span><span id="L-2776"><a href="#L-2776"><span class="linenos">2776</span></a><span class="sd">            from `self.var_data` (adj_pval &lt;= p_val, positive logFC) picking `top_n` per group.</span>
</span><span id="L-2777"><a href="#L-2777"><span class="linenos">2777</span></a>
</span><span id="L-2778"><a href="#L-2778"><span class="linenos">2778</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="L-2779"><a href="#L-2779"><span class="linenos">2779</span></a><span class="sd">            Metadata column used for naming.</span>
</span><span id="L-2780"><a href="#L-2780"><span class="linenos">2780</span></a>
</span><span id="L-2781"><a href="#L-2781"><span class="linenos">2781</span></a><span class="sd">        p_val : float, default 0.05</span>
</span><span id="L-2782"><a href="#L-2782"><span class="linenos">2782</span></a><span class="sd">            Adjusted p-value cutoff when selecting features automatically.</span>
</span><span id="L-2783"><a href="#L-2783"><span class="linenos">2783</span></a>
</span><span id="L-2784"><a href="#L-2784"><span class="linenos">2784</span></a><span class="sd">        top_n : int, default 25</span>
</span><span id="L-2785"><a href="#L-2785"><span class="linenos">2785</span></a><span class="sd">            Number of top features per valid group to keep if `features_list` is None.</span>
</span><span id="L-2786"><a href="#L-2786"><span class="linenos">2786</span></a>
</span><span id="L-2787"><a href="#L-2787"><span class="linenos">2787</span></a><span class="sd">        adj_mean : bool, default True</span>
</span><span id="L-2788"><a href="#L-2788"><span class="linenos">2788</span></a><span class="sd">            If True, adjust cell values toward group means using `beta`.</span>
</span><span id="L-2789"><a href="#L-2789"><span class="linenos">2789</span></a>
</span><span id="L-2790"><a href="#L-2790"><span class="linenos">2790</span></a><span class="sd">        beta : float, default 0.2</span>
</span><span id="L-2791"><a href="#L-2791"><span class="linenos">2791</span></a><span class="sd">            Adjustment strength toward group mean.</span>
</span><span id="L-2792"><a href="#L-2792"><span class="linenos">2792</span></a>
</span><span id="L-2793"><a href="#L-2793"><span class="linenos">2793</span></a><span class="sd">        Update</span>
</span><span id="L-2794"><a href="#L-2794"><span class="linenos">2794</span></a><span class="sd">        ------</span>
</span><span id="L-2795"><a href="#L-2795"><span class="linenos">2795</span></a><span class="sd">        Sets `self.clustering_data` and `self.clustering_metadata` to the selected subset,</span>
</span><span id="L-2796"><a href="#L-2796"><span class="linenos">2796</span></a><span class="sd">        ready for PCA/UMAP/clustering.</span>
</span><span id="L-2797"><a href="#L-2797"><span class="linenos">2797</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2798"><a href="#L-2798"><span class="linenos">2798</span></a>
</span><span id="L-2799"><a href="#L-2799"><span class="linenos">2799</span></a>        <span class="k">if</span> <span class="n">features_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">features_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2800"><a href="#L-2800"><span class="linenos">2800</span></a>
</span><span id="L-2801"><a href="#L-2801"><span class="linenos">2801</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2802"><a href="#L-2802"><span class="linenos">2802</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-2803"><a href="#L-2803"><span class="linenos">2803</span></a>                    <span class="s2">&quot;Lack of &#39;self.var_data&#39;. Use self.calculate_difference_markers() method first.&quot;</span>
</span><span id="L-2804"><a href="#L-2804"><span class="linenos">2804</span></a>                <span class="p">)</span>
</span><span id="L-2805"><a href="#L-2805"><span class="linenos">2805</span></a>
</span><span id="L-2806"><a href="#L-2806"><span class="linenos">2806</span></a>            <span class="n">df_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;adj_pval&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_val</span><span class="p">]</span>
</span><span id="L-2807"><a href="#L-2807"><span class="linenos">2807</span></a>            <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">df_tmp</span><span class="p">[</span><span class="n">df_tmp</span><span class="p">[</span><span class="s2">&quot;log(FC)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-2808"><a href="#L-2808"><span class="linenos">2808</span></a>            <span class="n">df_tmp</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-2809"><a href="#L-2809"><span class="linenos">2809</span></a>                <span class="n">df_tmp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
</span><span id="L-2810"><a href="#L-2810"><span class="linenos">2810</span></a>                    <span class="p">[</span><span class="s2">&quot;valid_group&quot;</span><span class="p">,</span> <span class="s2">&quot;esm&quot;</span><span class="p">,</span> <span class="s2">&quot;log(FC)&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
</span><span id="L-2811"><a href="#L-2811"><span class="linenos">2811</span></a>                <span class="p">)</span>
</span><span id="L-2812"><a href="#L-2812"><span class="linenos">2812</span></a>                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;valid_group&quot;</span><span class="p">)</span>
</span><span id="L-2813"><a href="#L-2813"><span class="linenos">2813</span></a>                <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">top_n</span><span class="p">)</span>
</span><span id="L-2814"><a href="#L-2814"><span class="linenos">2814</span></a>            <span class="p">)</span>
</span><span id="L-2815"><a href="#L-2815"><span class="linenos">2815</span></a>
</span><span id="L-2816"><a href="#L-2816"><span class="linenos">2816</span></a>            <span class="n">feaures_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df_tmp</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">]))</span>
</span><span id="L-2817"><a href="#L-2817"><span class="linenos">2817</span></a>
</span><span id="L-2818"><a href="#L-2818"><span class="linenos">2818</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_partial_data</span><span class="p">(</span>
</span><span id="L-2819"><a href="#L-2819"><span class="linenos">2819</span></a>            <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">feaures_list</span><span class="p">,</span> <span class="n">name_slot</span><span class="o">=</span><span class="n">name_slot</span>
</span><span id="L-2820"><a href="#L-2820"><span class="linenos">2820</span></a>        <span class="p">)</span>
</span><span id="L-2821"><a href="#L-2821"><span class="linenos">2821</span></a>        <span class="n">data_avg</span> <span class="o">=</span> <span class="n">average</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-2822"><a href="#L-2822"><span class="linenos">2822</span></a>
</span><span id="L-2823"><a href="#L-2823"><span class="linenos">2823</span></a>        <span class="k">if</span> <span class="n">adj_mean</span><span class="p">:</span>
</span><span id="L-2824"><a href="#L-2824"><span class="linenos">2824</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">adjust_cells_to_group_mean</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">data_avg</span><span class="o">=</span><span class="n">data_avg</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">)</span>
</span><span id="L-2825"><a href="#L-2825"><span class="linenos">2825</span></a>
</span><span id="L-2826"><a href="#L-2826"><span class="linenos">2826</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_data</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="L-2827"><a href="#L-2827"><span class="linenos">2827</span></a>
</span><span id="L-2828"><a href="#L-2828"><span class="linenos">2828</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span>
</span><span id="L-2829"><a href="#L-2829"><span class="linenos">2829</span></a>
</span><span id="L-2830"><a href="#L-2830"><span class="linenos">2830</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">average</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2831"><a href="#L-2831"><span class="linenos">2831</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2832"><a href="#L-2832"><span class="linenos">2832</span></a><span class="sd">        Aggregate normalized data by (cell_name, set) pairs computing the mean per group.</span>
</span><span id="L-2833"><a href="#L-2833"><span class="linenos">2833</span></a>
</span><span id="L-2834"><a href="#L-2834"><span class="linenos">2834</span></a><span class="sd">        The method constructs new column names as &quot;cell_name # set&quot;, averages columns</span>
</span><span id="L-2835"><a href="#L-2835"><span class="linenos">2835</span></a><span class="sd">        sharing identical labels, and populates `self.agg_normalized_data` and `self.agg_metadata`.</span>
</span><span id="L-2836"><a href="#L-2836"><span class="linenos">2836</span></a>
</span><span id="L-2837"><a href="#L-2837"><span class="linenos">2837</span></a><span class="sd">        Update</span>
</span><span id="L-2838"><a href="#L-2838"><span class="linenos">2838</span></a><span class="sd">        ------</span>
</span><span id="L-2839"><a href="#L-2839"><span class="linenos">2839</span></a><span class="sd">        Sets `self.agg_normalized_data` (features x aggregated samples) and</span>
</span><span id="L-2840"><a href="#L-2840"><span class="linenos">2840</span></a><span class="sd">        `self.agg_metadata` (DataFrame with &#39;cell_names&#39; and &#39;sets&#39;).</span>
</span><span id="L-2841"><a href="#L-2841"><span class="linenos">2841</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2842"><a href="#L-2842"><span class="linenos">2842</span></a>
</span><span id="L-2843"><a href="#L-2843"><span class="linenos">2843</span></a>        <span class="n">wide_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span>
</span><span id="L-2844"><a href="#L-2844"><span class="linenos">2844</span></a>
</span><span id="L-2845"><a href="#L-2845"><span class="linenos">2845</span></a>        <span class="n">wide_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span>
</span><span id="L-2846"><a href="#L-2846"><span class="linenos">2846</span></a>
</span><span id="L-2847"><a href="#L-2847"><span class="linenos">2847</span></a>        <span class="n">new_names</span> <span class="o">=</span> <span class="n">wide_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="n">wide_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-2848"><a href="#L-2848"><span class="linenos">2848</span></a>
</span><span id="L-2849"><a href="#L-2849"><span class="linenos">2849</span></a>        <span class="n">wide_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_names</span><span class="p">)</span>
</span><span id="L-2850"><a href="#L-2850"><span class="linenos">2850</span></a>
</span><span id="L-2851"><a href="#L-2851"><span class="linenos">2851</span></a>        <span class="n">aggregated_df</span> <span class="o">=</span> <span class="n">wide_data</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">wide_data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-2852"><a href="#L-2852"><span class="linenos">2852</span></a>
</span><span id="L-2853"><a href="#L-2853"><span class="linenos">2853</span></a>        <span class="n">sets</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*# &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">aggregated_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-2854"><a href="#L-2854"><span class="linenos">2854</span></a>        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; #.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">aggregated_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-2855"><a href="#L-2855"><span class="linenos">2855</span></a>
</span><span id="L-2856"><a href="#L-2856"><span class="linenos">2856</span></a>        <span class="n">aggregated_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">names</span>
</span><span id="L-2857"><a href="#L-2857"><span class="linenos">2857</span></a>        <span class="n">aggregated_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;cell_names&quot;</span><span class="p">:</span> <span class="n">names</span><span class="p">,</span> <span class="s2">&quot;sets&quot;</span><span class="p">:</span> <span class="n">sets</span><span class="p">})</span>
</span><span id="L-2858"><a href="#L-2858"><span class="linenos">2858</span></a>
</span><span id="L-2859"><a href="#L-2859"><span class="linenos">2859</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="n">aggregated_metadata</span>
</span><span id="L-2860"><a href="#L-2860"><span class="linenos">2860</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="o">=</span> <span class="n">aggregated_df</span>
</span><span id="L-2861"><a href="#L-2861"><span class="linenos">2861</span></a>
</span><span id="L-2862"><a href="#L-2862"><span class="linenos">2862</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">estimating_similarity</span><span class="p">(</span>
</span><span id="L-2863"><a href="#L-2863"><span class="linenos">2863</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;pearson&quot;</span><span class="p">,</span> <span class="n">p_val</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span>
</span><span id="L-2864"><a href="#L-2864"><span class="linenos">2864</span></a>    <span class="p">):</span>
</span><span id="L-2865"><a href="#L-2865"><span class="linenos">2865</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2866"><a href="#L-2866"><span class="linenos">2866</span></a><span class="sd">        Estimate pairwise similarity and Euclidean distance between aggregated samples.</span>
</span><span id="L-2867"><a href="#L-2867"><span class="linenos">2867</span></a>
</span><span id="L-2868"><a href="#L-2868"><span class="linenos">2868</span></a><span class="sd">        Parameters</span>
</span><span id="L-2869"><a href="#L-2869"><span class="linenos">2869</span></a><span class="sd">        ----------</span>
</span><span id="L-2870"><a href="#L-2870"><span class="linenos">2870</span></a><span class="sd">        method : str, default &#39;pearson&#39;</span>
</span><span id="L-2871"><a href="#L-2871"><span class="linenos">2871</span></a><span class="sd">            Correlation method to use (passed to pandas.DataFrame.corr()).</span>
</span><span id="L-2872"><a href="#L-2872"><span class="linenos">2872</span></a>
</span><span id="L-2873"><a href="#L-2873"><span class="linenos">2873</span></a><span class="sd">        p_val : float, default 0.05</span>
</span><span id="L-2874"><a href="#L-2874"><span class="linenos">2874</span></a><span class="sd">            Adjusted p-value cutoff used to select marker features from `self.var_data`.</span>
</span><span id="L-2875"><a href="#L-2875"><span class="linenos">2875</span></a>
</span><span id="L-2876"><a href="#L-2876"><span class="linenos">2876</span></a><span class="sd">        top_n : int, default 25</span>
</span><span id="L-2877"><a href="#L-2877"><span class="linenos">2877</span></a><span class="sd">            Number of top features per valid group to include.</span>
</span><span id="L-2878"><a href="#L-2878"><span class="linenos">2878</span></a>
</span><span id="L-2879"><a href="#L-2879"><span class="linenos">2879</span></a><span class="sd">        Update</span>
</span><span id="L-2880"><a href="#L-2880"><span class="linenos">2880</span></a><span class="sd">        -------</span>
</span><span id="L-2881"><a href="#L-2881"><span class="linenos">2881</span></a><span class="sd">        Computes a combined table with per-pair correlation and euclidean distance</span>
</span><span id="L-2882"><a href="#L-2882"><span class="linenos">2882</span></a><span class="sd">        and stores it in `self.similarity`.</span>
</span><span id="L-2883"><a href="#L-2883"><span class="linenos">2883</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2884"><a href="#L-2884"><span class="linenos">2884</span></a>
</span><span id="L-2885"><a href="#L-2885"><span class="linenos">2885</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2886"><a href="#L-2886"><span class="linenos">2886</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-2887"><a href="#L-2887"><span class="linenos">2887</span></a>                <span class="s2">&quot;Lack of &#39;self.var_data&#39;. Use self.calculate_difference_markers() method first.&quot;</span>
</span><span id="L-2888"><a href="#L-2888"><span class="linenos">2888</span></a>            <span class="p">)</span>
</span><span id="L-2889"><a href="#L-2889"><span class="linenos">2889</span></a>
</span><span id="L-2890"><a href="#L-2890"><span class="linenos">2890</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2891"><a href="#L-2891"><span class="linenos">2891</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
</span><span id="L-2892"><a href="#L-2892"><span class="linenos">2892</span></a>
</span><span id="L-2893"><a href="#L-2893"><span class="linenos">2893</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span>
</span><span id="L-2894"><a href="#L-2894"><span class="linenos">2894</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span>
</span><span id="L-2895"><a href="#L-2895"><span class="linenos">2895</span></a>
</span><span id="L-2896"><a href="#L-2896"><span class="linenos">2896</span></a>        <span class="n">df_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;adj_pval&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_val</span><span class="p">]</span>
</span><span id="L-2897"><a href="#L-2897"><span class="linenos">2897</span></a>        <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">df_tmp</span><span class="p">[</span><span class="n">df_tmp</span><span class="p">[</span><span class="s2">&quot;log(FC)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-2898"><a href="#L-2898"><span class="linenos">2898</span></a>        <span class="n">df_tmp</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-2899"><a href="#L-2899"><span class="linenos">2899</span></a>            <span class="n">df_tmp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
</span><span id="L-2900"><a href="#L-2900"><span class="linenos">2900</span></a>                <span class="p">[</span><span class="s2">&quot;valid_group&quot;</span><span class="p">,</span> <span class="s2">&quot;esm&quot;</span><span class="p">,</span> <span class="s2">&quot;log(FC)&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
</span><span id="L-2901"><a href="#L-2901"><span class="linenos">2901</span></a>            <span class="p">)</span>
</span><span id="L-2902"><a href="#L-2902"><span class="linenos">2902</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;valid_group&quot;</span><span class="p">)</span>
</span><span id="L-2903"><a href="#L-2903"><span class="linenos">2903</span></a>            <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">top_n</span><span class="p">)</span>
</span><span id="L-2904"><a href="#L-2904"><span class="linenos">2904</span></a>        <span class="p">)</span>
</span><span id="L-2905"><a href="#L-2905"><span class="linenos">2905</span></a>
</span><span id="L-2906"><a href="#L-2906"><span class="linenos">2906</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df_tmp</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">]))]</span>
</span><span id="L-2907"><a href="#L-2907"><span class="linenos">2907</span></a>
</span><span id="L-2908"><a href="#L-2908"><span class="linenos">2908</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-2909"><a href="#L-2909"><span class="linenos">2909</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]]</span>
</span><span id="L-2910"><a href="#L-2910"><span class="linenos">2910</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2911"><a href="#L-2911"><span class="linenos">2911</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-2912"><a href="#L-2912"><span class="linenos">2912</span></a>
</span><span id="L-2913"><a href="#L-2913"><span class="linenos">2913</span></a>        <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
</span><span id="L-2914"><a href="#L-2914"><span class="linenos">2914</span></a>
</span><span id="L-2915"><a href="#L-2915"><span class="linenos">2915</span></a>        <span class="n">scaled_data</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-2916"><a href="#L-2916"><span class="linenos">2916</span></a>
</span><span id="L-2917"><a href="#L-2917"><span class="linenos">2917</span></a>        <span class="n">scaled_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scaled_data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</span><span id="L-2918"><a href="#L-2918"><span class="linenos">2918</span></a>
</span><span id="L-2919"><a href="#L-2919"><span class="linenos">2919</span></a>        <span class="n">cor</span> <span class="o">=</span> <span class="n">scaled_df</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
</span><span id="L-2920"><a href="#L-2920"><span class="linenos">2920</span></a>        <span class="n">cor_df</span> <span class="o">=</span> <span class="n">cor</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="L-2921"><a href="#L-2921"><span class="linenos">2921</span></a>        <span class="n">cor_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">,</span> <span class="s2">&quot;cell2&quot;</span><span class="p">,</span> <span class="s2">&quot;correlation&quot;</span><span class="p">]</span>
</span><span id="L-2922"><a href="#L-2922"><span class="linenos">2922</span></a>
</span><span id="L-2923"><a href="#L-2923"><span class="linenos">2923</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="n">pdist</span><span class="p">(</span><span class="n">scaled_df</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;euclidean&quot;</span><span class="p">)</span>
</span><span id="L-2924"><a href="#L-2924"><span class="linenos">2924</span></a>        <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="L-2925"><a href="#L-2925"><span class="linenos">2925</span></a>            <span class="n">squareform</span><span class="p">(</span><span class="n">distances</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">scaled_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">scaled_df</span><span class="o">.</span><span class="n">columns</span>
</span><span id="L-2926"><a href="#L-2926"><span class="linenos">2926</span></a>        <span class="p">)</span>
</span><span id="L-2927"><a href="#L-2927"><span class="linenos">2927</span></a>        <span class="n">dist_df</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="L-2928"><a href="#L-2928"><span class="linenos">2928</span></a>        <span class="n">dist_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">,</span> <span class="s2">&quot;cell2&quot;</span><span class="p">,</span> <span class="s2">&quot;euclidean_dist&quot;</span><span class="p">]</span>
</span><span id="L-2929"><a href="#L-2929"><span class="linenos">2929</span></a>
</span><span id="L-2930"><a href="#L-2930"><span class="linenos">2930</span></a>        <span class="n">full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cor_df</span><span class="p">,</span> <span class="n">dist_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">,</span> <span class="s2">&quot;cell2&quot;</span><span class="p">])</span>
</span><span id="L-2931"><a href="#L-2931"><span class="linenos">2931</span></a>
</span><span id="L-2932"><a href="#L-2932"><span class="linenos">2932</span></a>        <span class="n">full</span> <span class="o">=</span> <span class="n">full</span><span class="p">[</span><span class="n">full</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">full</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]]</span>
</span><span id="L-2933"><a href="#L-2933"><span class="linenos">2933</span></a>        <span class="n">full</span> <span class="o">=</span> <span class="n">full</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2934"><a href="#L-2934"><span class="linenos">2934</span></a>
</span><span id="L-2935"><a href="#L-2935"><span class="linenos">2935</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="o">=</span> <span class="n">full</span>
</span><span id="L-2936"><a href="#L-2936"><span class="linenos">2936</span></a>
</span><span id="L-2937"><a href="#L-2937"><span class="linenos">2937</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">similarity_plot</span><span class="p">(</span>
</span><span id="L-2938"><a href="#L-2938"><span class="linenos">2938</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-2939"><a href="#L-2939"><span class="linenos">2939</span></a>        <span class="n">split_sets</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-2940"><a href="#L-2940"><span class="linenos">2940</span></a>        <span class="n">set_info</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-2941"><a href="#L-2941"><span class="linenos">2941</span></a>        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;seismic&quot;</span><span class="p">,</span>
</span><span id="L-2942"><a href="#L-2942"><span class="linenos">2942</span></a>        <span class="n">width</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="L-2943"><a href="#L-2943"><span class="linenos">2943</span></a>        <span class="n">height</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="L-2944"><a href="#L-2944"><span class="linenos">2944</span></a>    <span class="p">):</span>
</span><span id="L-2945"><a href="#L-2945"><span class="linenos">2945</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2946"><a href="#L-2946"><span class="linenos">2946</span></a><span class="sd">        Visualize pairwise similarity as a scatter plot.</span>
</span><span id="L-2947"><a href="#L-2947"><span class="linenos">2947</span></a>
</span><span id="L-2948"><a href="#L-2948"><span class="linenos">2948</span></a><span class="sd">        Parameters</span>
</span><span id="L-2949"><a href="#L-2949"><span class="linenos">2949</span></a><span class="sd">        ----------</span>
</span><span id="L-2950"><a href="#L-2950"><span class="linenos">2950</span></a><span class="sd">        split_sets : bool, default True</span>
</span><span id="L-2951"><a href="#L-2951"><span class="linenos">2951</span></a><span class="sd">            If True and set information is present, split plotting area roughly into two halves to visualize cross-set pairs.</span>
</span><span id="L-2952"><a href="#L-2952"><span class="linenos">2952</span></a>
</span><span id="L-2953"><a href="#L-2953"><span class="linenos">2953</span></a><span class="sd">        set_info : bool, default True</span>
</span><span id="L-2954"><a href="#L-2954"><span class="linenos">2954</span></a><span class="sd">            If True, keep the &#39; # set&#39; annotation in labels; otherwise strip it.</span>
</span><span id="L-2955"><a href="#L-2955"><span class="linenos">2955</span></a>
</span><span id="L-2956"><a href="#L-2956"><span class="linenos">2956</span></a><span class="sd">        cmap : str, default &#39;seismic&#39;</span>
</span><span id="L-2957"><a href="#L-2957"><span class="linenos">2957</span></a><span class="sd">            Color map for correlation (hue).</span>
</span><span id="L-2958"><a href="#L-2958"><span class="linenos">2958</span></a>
</span><span id="L-2959"><a href="#L-2959"><span class="linenos">2959</span></a><span class="sd">        width : int, default 12</span>
</span><span id="L-2960"><a href="#L-2960"><span class="linenos">2960</span></a><span class="sd">            Figure width.</span>
</span><span id="L-2961"><a href="#L-2961"><span class="linenos">2961</span></a>
</span><span id="L-2962"><a href="#L-2962"><span class="linenos">2962</span></a><span class="sd">        height : int, default 10</span>
</span><span id="L-2963"><a href="#L-2963"><span class="linenos">2963</span></a><span class="sd">            Figure height.</span>
</span><span id="L-2964"><a href="#L-2964"><span class="linenos">2964</span></a>
</span><span id="L-2965"><a href="#L-2965"><span class="linenos">2965</span></a><span class="sd">        Returns</span>
</span><span id="L-2966"><a href="#L-2966"><span class="linenos">2966</span></a><span class="sd">        -------</span>
</span><span id="L-2967"><a href="#L-2967"><span class="linenos">2967</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="L-2968"><a href="#L-2968"><span class="linenos">2968</span></a>
</span><span id="L-2969"><a href="#L-2969"><span class="linenos">2969</span></a><span class="sd">        Raises</span>
</span><span id="L-2970"><a href="#L-2970"><span class="linenos">2970</span></a><span class="sd">        ------</span>
</span><span id="L-2971"><a href="#L-2971"><span class="linenos">2971</span></a><span class="sd">        ValueError</span>
</span><span id="L-2972"><a href="#L-2972"><span class="linenos">2972</span></a><span class="sd">            If `self.similarity` is None.</span>
</span><span id="L-2973"><a href="#L-2973"><span class="linenos">2973</span></a>
</span><span id="L-2974"><a href="#L-2974"><span class="linenos">2974</span></a><span class="sd">        Notes</span>
</span><span id="L-2975"><a href="#L-2975"><span class="linenos">2975</span></a><span class="sd">        -----</span>
</span><span id="L-2976"><a href="#L-2976"><span class="linenos">2976</span></a><span class="sd">        The function filters pairs by z-scored euclidean distance &gt; 0 to focus on closer pairs.</span>
</span><span id="L-2977"><a href="#L-2977"><span class="linenos">2977</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2978"><a href="#L-2978"><span class="linenos">2978</span></a>
</span><span id="L-2979"><a href="#L-2979"><span class="linenos">2979</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2980"><a href="#L-2980"><span class="linenos">2980</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-2981"><a href="#L-2981"><span class="linenos">2981</span></a>                <span class="s2">&quot;Similarity data is missing. Please calculate similarity using self.estimating_similarity.&quot;</span>
</span><span id="L-2982"><a href="#L-2982"><span class="linenos">2982</span></a>            <span class="p">)</span>
</span><span id="L-2983"><a href="#L-2983"><span class="linenos">2983</span></a>
</span><span id="L-2984"><a href="#L-2984"><span class="linenos">2984</span></a>        <span class="n">similarity_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span>
</span><span id="L-2985"><a href="#L-2985"><span class="linenos">2985</span></a>
</span><span id="L-2986"><a href="#L-2986"><span class="linenos">2986</span></a>        <span class="k">if</span> <span class="s2">&quot; # &quot;</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-2987"><a href="#L-2987"><span class="linenos">2987</span></a>            <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;set1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-2988"><a href="#L-2988"><span class="linenos">2988</span></a>                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*# &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">]</span>
</span><span id="L-2989"><a href="#L-2989"><span class="linenos">2989</span></a>            <span class="p">]</span>
</span><span id="L-2990"><a href="#L-2990"><span class="linenos">2990</span></a>            <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;set2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-2991"><a href="#L-2991"><span class="linenos">2991</span></a>                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*# &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]</span>
</span><span id="L-2992"><a href="#L-2992"><span class="linenos">2992</span></a>            <span class="p">]</span>
</span><span id="L-2993"><a href="#L-2993"><span class="linenos">2993</span></a>
</span><span id="L-2994"><a href="#L-2994"><span class="linenos">2994</span></a>        <span class="k">if</span> <span class="n">split_sets</span> <span class="ow">and</span> <span class="s2">&quot; # &quot;</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-2995"><a href="#L-2995"><span class="linenos">2995</span></a>            <span class="n">sets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-2996"><a href="#L-2996"><span class="linenos">2996</span></a>                <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;set1&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;set2&quot;</span><span class="p">]))</span>
</span><span id="L-2997"><a href="#L-2997"><span class="linenos">2997</span></a>            <span class="p">)</span>
</span><span id="L-2998"><a href="#L-2998"><span class="linenos">2998</span></a>
</span><span id="L-2999"><a href="#L-2999"><span class="linenos">2999</span></a>            <span class="n">mm</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-3000"><a href="#L-3000"><span class="linenos">3000</span></a>
</span><span id="L-3001"><a href="#L-3001"><span class="linenos">3001</span></a>            <span class="n">x_s</span> <span class="o">=</span> <span class="n">sets</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">mm</span><span class="p">]</span>
</span><span id="L-3002"><a href="#L-3002"><span class="linenos">3002</span></a>            <span class="n">y_s</span> <span class="o">=</span> <span class="n">sets</span><span class="p">[</span><span class="n">mm</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)]</span>
</span><span id="L-3003"><a href="#L-3003"><span class="linenos">3003</span></a>
</span><span id="L-3004"><a href="#L-3004"><span class="linenos">3004</span></a>            <span class="n">similarity_data</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="p">[</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;set1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">x_s</span><span class="p">)]</span>
</span><span id="L-3005"><a href="#L-3005"><span class="linenos">3005</span></a>            <span class="n">similarity_data</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="p">[</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;set2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">y_s</span><span class="p">)]</span>
</span><span id="L-3006"><a href="#L-3006"><span class="linenos">3006</span></a>
</span><span id="L-3007"><a href="#L-3007"><span class="linenos">3007</span></a>            <span class="n">similarity_data</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;set1&quot;</span><span class="p">,</span> <span class="s2">&quot;set2&quot;</span><span class="p">])</span>
</span><span id="L-3008"><a href="#L-3008"><span class="linenos">3008</span></a>
</span><span id="L-3009"><a href="#L-3009"><span class="linenos">3009</span></a>        <span class="k">if</span> <span class="n">set_info</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="s2">&quot; # &quot;</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-3010"><a href="#L-3010"><span class="linenos">3010</span></a>            <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-3011"><a href="#L-3011"><span class="linenos">3011</span></a>                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; #.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">]</span>
</span><span id="L-3012"><a href="#L-3012"><span class="linenos">3012</span></a>            <span class="p">]</span>
</span><span id="L-3013"><a href="#L-3013"><span class="linenos">3013</span></a>            <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-3014"><a href="#L-3014"><span class="linenos">3014</span></a>                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; #.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]</span>
</span><span id="L-3015"><a href="#L-3015"><span class="linenos">3015</span></a>            <span class="p">]</span>
</span><span id="L-3016"><a href="#L-3016"><span class="linenos">3016</span></a>
</span><span id="L-3017"><a href="#L-3017"><span class="linenos">3017</span></a>        <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;-euclidean_zscore&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">zscore</span><span class="p">(</span>
</span><span id="L-3018"><a href="#L-3018"><span class="linenos">3018</span></a>            <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;euclidean_dist&quot;</span><span class="p">]</span>
</span><span id="L-3019"><a href="#L-3019"><span class="linenos">3019</span></a>        <span class="p">)</span>
</span><span id="L-3020"><a href="#L-3020"><span class="linenos">3020</span></a>
</span><span id="L-3021"><a href="#L-3021"><span class="linenos">3021</span></a>        <span class="n">similarity_data</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="p">[</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;-euclidean_zscore&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-3022"><a href="#L-3022"><span class="linenos">3022</span></a>
</span><span id="L-3023"><a href="#L-3023"><span class="linenos">3023</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="L-3024"><a href="#L-3024"><span class="linenos">3024</span></a>        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
</span><span id="L-3025"><a href="#L-3025"><span class="linenos">3025</span></a>            <span class="n">data</span><span class="o">=</span><span class="n">similarity_data</span><span class="p">,</span>
</span><span id="L-3026"><a href="#L-3026"><span class="linenos">3026</span></a>            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;cell1&quot;</span><span class="p">,</span>
</span><span id="L-3027"><a href="#L-3027"><span class="linenos">3027</span></a>            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;cell2&quot;</span><span class="p">,</span>
</span><span id="L-3028"><a href="#L-3028"><span class="linenos">3028</span></a>            <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;correlation&quot;</span><span class="p">,</span>
</span><span id="L-3029"><a href="#L-3029"><span class="linenos">3029</span></a>            <span class="n">size</span><span class="o">=</span><span class="s2">&quot;-euclidean_zscore&quot;</span><span class="p">,</span>
</span><span id="L-3030"><a href="#L-3030"><span class="linenos">3030</span></a>            <span class="n">sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
</span><span id="L-3031"><a href="#L-3031"><span class="linenos">3031</span></a>            <span class="n">palette</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="L-3032"><a href="#L-3032"><span class="linenos">3032</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-3033"><a href="#L-3033"><span class="linenos">3033</span></a>            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="L-3034"><a href="#L-3034"><span class="linenos">3034</span></a>        <span class="p">)</span>
</span><span id="L-3035"><a href="#L-3035"><span class="linenos">3035</span></a>
</span><span id="L-3036"><a href="#L-3036"><span class="linenos">3036</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
</span><span id="L-3037"><a href="#L-3037"><span class="linenos">3037</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-3038"><a href="#L-3038"><span class="linenos">3038</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Cell 1&quot;</span><span class="p">)</span>
</span><span id="L-3039"><a href="#L-3039"><span class="linenos">3039</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cell 2&quot;</span><span class="p">)</span>
</span><span id="L-3040"><a href="#L-3040"><span class="linenos">3040</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
</span><span id="L-3041"><a href="#L-3041"><span class="linenos">3041</span></a>
</span><span id="L-3042"><a href="#L-3042"><span class="linenos">3042</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
</span><span id="L-3043"><a href="#L-3043"><span class="linenos">3043</span></a>
</span><span id="L-3044"><a href="#L-3044"><span class="linenos">3044</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-3045"><a href="#L-3045"><span class="linenos">3045</span></a>
</span><span id="L-3046"><a href="#L-3046"><span class="linenos">3046</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="L-3047"><a href="#L-3047"><span class="linenos">3047</span></a>
</span><span id="L-3048"><a href="#L-3048"><span class="linenos">3048</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">spatial_similarity</span><span class="p">(</span>
</span><span id="L-3049"><a href="#L-3049"><span class="linenos">3049</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-3050"><a href="#L-3050"><span class="linenos">3050</span></a>        <span class="n">set_info</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-3051"><a href="#L-3051"><span class="linenos">3051</span></a>        <span class="n">bandwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-3052"><a href="#L-3052"><span class="linenos">3052</span></a>        <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="L-3053"><a href="#L-3053"><span class="linenos">3053</span></a>        <span class="n">min_dist</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-3054"><a href="#L-3054"><span class="linenos">3054</span></a>        <span class="n">legend_split</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-3055"><a href="#L-3055"><span class="linenos">3055</span></a>        <span class="n">point_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
</span><span id="L-3056"><a href="#L-3056"><span class="linenos">3056</span></a>        <span class="n">spread</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-3057"><a href="#L-3057"><span class="linenos">3057</span></a>        <span class="n">set_op_mix_ratio</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-3058"><a href="#L-3058"><span class="linenos">3058</span></a>        <span class="n">local_connectivity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-3059"><a href="#L-3059"><span class="linenos">3059</span></a>        <span class="n">repulsion_strength</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-3060"><a href="#L-3060"><span class="linenos">3060</span></a>        <span class="n">negative_sample_rate</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="L-3061"><a href="#L-3061"><span class="linenos">3061</span></a>        <span class="n">threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-3062"><a href="#L-3062"><span class="linenos">3062</span></a>        <span class="n">width</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="L-3063"><a href="#L-3063"><span class="linenos">3063</span></a>        <span class="n">height</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="L-3064"><a href="#L-3064"><span class="linenos">3064</span></a>    <span class="p">):</span>
</span><span id="L-3065"><a href="#L-3065"><span class="linenos">3065</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3066"><a href="#L-3066"><span class="linenos">3066</span></a><span class="sd">        Create a spatial UMAP-like visualization of similarity relationships between samples.</span>
</span><span id="L-3067"><a href="#L-3067"><span class="linenos">3067</span></a>
</span><span id="L-3068"><a href="#L-3068"><span class="linenos">3068</span></a><span class="sd">        Parameters</span>
</span><span id="L-3069"><a href="#L-3069"><span class="linenos">3069</span></a><span class="sd">        ----------</span>
</span><span id="L-3070"><a href="#L-3070"><span class="linenos">3070</span></a><span class="sd">        set_info : bool, default True</span>
</span><span id="L-3071"><a href="#L-3071"><span class="linenos">3071</span></a><span class="sd">            If True, retain set information in labels.</span>
</span><span id="L-3072"><a href="#L-3072"><span class="linenos">3072</span></a>
</span><span id="L-3073"><a href="#L-3073"><span class="linenos">3073</span></a><span class="sd">        bandwidth : float, default 1</span>
</span><span id="L-3074"><a href="#L-3074"><span class="linenos">3074</span></a><span class="sd">            Bandwidth used by MeanShift for clustering polygons.</span>
</span><span id="L-3075"><a href="#L-3075"><span class="linenos">3075</span></a>
</span><span id="L-3076"><a href="#L-3076"><span class="linenos">3076</span></a><span class="sd">        point_size : float, default 100</span>
</span><span id="L-3077"><a href="#L-3077"><span class="linenos">3077</span></a><span class="sd">            Size of scatter points.</span>
</span><span id="L-3078"><a href="#L-3078"><span class="linenos">3078</span></a>
</span><span id="L-3079"><a href="#L-3079"><span class="linenos">3079</span></a><span class="sd">        legend_split : int, default 2</span>
</span><span id="L-3080"><a href="#L-3080"><span class="linenos">3080</span></a><span class="sd">            Number of columns in legend.</span>
</span><span id="L-3081"><a href="#L-3081"><span class="linenos">3081</span></a>
</span><span id="L-3082"><a href="#L-3082"><span class="linenos">3082</span></a><span class="sd">        n_neighbors, min_dist, spread, set_op_mix_ratio, local_connectivity, repulsion_strength, negative_sample_rate : parameters passed to UMAP.</span>
</span><span id="L-3083"><a href="#L-3083"><span class="linenos">3083</span></a>
</span><span id="L-3084"><a href="#L-3084"><span class="linenos">3084</span></a><span class="sd">        threshold : float, default 0.1</span>
</span><span id="L-3085"><a href="#L-3085"><span class="linenos">3085</span></a><span class="sd">            Minimum text distance for label adjustment to avoid overlap.</span>
</span><span id="L-3086"><a href="#L-3086"><span class="linenos">3086</span></a>
</span><span id="L-3087"><a href="#L-3087"><span class="linenos">3087</span></a><span class="sd">        width : int, default 12</span>
</span><span id="L-3088"><a href="#L-3088"><span class="linenos">3088</span></a><span class="sd">            Figure width.</span>
</span><span id="L-3089"><a href="#L-3089"><span class="linenos">3089</span></a>
</span><span id="L-3090"><a href="#L-3090"><span class="linenos">3090</span></a><span class="sd">        height : int, default 10</span>
</span><span id="L-3091"><a href="#L-3091"><span class="linenos">3091</span></a><span class="sd">            Figure height.</span>
</span><span id="L-3092"><a href="#L-3092"><span class="linenos">3092</span></a>
</span><span id="L-3093"><a href="#L-3093"><span class="linenos">3093</span></a><span class="sd">        Returns</span>
</span><span id="L-3094"><a href="#L-3094"><span class="linenos">3094</span></a><span class="sd">        -------</span>
</span><span id="L-3095"><a href="#L-3095"><span class="linenos">3095</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="L-3096"><a href="#L-3096"><span class="linenos">3096</span></a>
</span><span id="L-3097"><a href="#L-3097"><span class="linenos">3097</span></a><span class="sd">        Raises</span>
</span><span id="L-3098"><a href="#L-3098"><span class="linenos">3098</span></a><span class="sd">        ------</span>
</span><span id="L-3099"><a href="#L-3099"><span class="linenos">3099</span></a><span class="sd">        ValueError</span>
</span><span id="L-3100"><a href="#L-3100"><span class="linenos">3100</span></a><span class="sd">            If `self.similarity` is None.</span>
</span><span id="L-3101"><a href="#L-3101"><span class="linenos">3101</span></a>
</span><span id="L-3102"><a href="#L-3102"><span class="linenos">3102</span></a><span class="sd">        Notes</span>
</span><span id="L-3103"><a href="#L-3103"><span class="linenos">3103</span></a><span class="sd">        -----</span>
</span><span id="L-3104"><a href="#L-3104"><span class="linenos">3104</span></a><span class="sd">        Builds a precomputed distance matrix combining correlation and euclidean distance,</span>
</span><span id="L-3105"><a href="#L-3105"><span class="linenos">3105</span></a><span class="sd">        runs UMAP with metric=&#39;precomputed&#39;, then overlays cluster hulls (MeanShift + convex hull)</span>
</span><span id="L-3106"><a href="#L-3106"><span class="linenos">3106</span></a><span class="sd">        and arrows to indicate nearest neighbors (minimal combined distance).</span>
</span><span id="L-3107"><a href="#L-3107"><span class="linenos">3107</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-3108"><a href="#L-3108"><span class="linenos">3108</span></a>
</span><span id="L-3109"><a href="#L-3109"><span class="linenos">3109</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3110"><a href="#L-3110"><span class="linenos">3110</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-3111"><a href="#L-3111"><span class="linenos">3111</span></a>                <span class="s2">&quot;Similarity data is missing. Please calculate similarity using self.estimating_similarity.&quot;</span>
</span><span id="L-3112"><a href="#L-3112"><span class="linenos">3112</span></a>            <span class="p">)</span>
</span><span id="L-3113"><a href="#L-3113"><span class="linenos">3113</span></a>
</span><span id="L-3114"><a href="#L-3114"><span class="linenos">3114</span></a>        <span class="n">similarity_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span>
</span><span id="L-3115"><a href="#L-3115"><span class="linenos">3115</span></a>
</span><span id="L-3116"><a href="#L-3116"><span class="linenos">3116</span></a>        <span class="n">sim</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;correlation&quot;</span><span class="p">]</span>
</span><span id="L-3117"><a href="#L-3117"><span class="linenos">3117</span></a>        <span class="n">sim_scaled</span> <span class="o">=</span> <span class="p">(</span><span class="n">sim</span> <span class="o">-</span> <span class="n">sim</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">sim</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</span><span id="L-3118"><a href="#L-3118"><span class="linenos">3118</span></a>        <span class="n">eu_dist</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;euclidean_dist&quot;</span><span class="p">]</span>
</span><span id="L-3119"><a href="#L-3119"><span class="linenos">3119</span></a>        <span class="n">eu_dist_scaled</span> <span class="o">=</span> <span class="p">(</span><span class="n">eu_dist</span> <span class="o">-</span> <span class="n">eu_dist</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">eu_dist</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">eu_dist</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</span><span id="L-3120"><a href="#L-3120"><span class="linenos">3120</span></a>
</span><span id="L-3121"><a href="#L-3121"><span class="linenos">3121</span></a>        <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;combo_dist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sim_scaled</span><span class="p">)</span> <span class="o">*</span> <span class="n">eu_dist_scaled</span>
</span><span id="L-3122"><a href="#L-3122"><span class="linenos">3122</span></a>
</span><span id="L-3123"><a href="#L-3123"><span class="linenos">3123</span></a>        <span class="c1"># for nn target</span>
</span><span id="L-3124"><a href="#L-3124"><span class="linenos">3124</span></a>        <span class="n">arrow_df</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-3125"><a href="#L-3125"><span class="linenos">3125</span></a>        <span class="n">arrow_df</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
</span><span id="L-3126"><a href="#L-3126"><span class="linenos">3126</span></a>            <span class="n">similarity_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;cell1&quot;</span><span class="p">)[</span><span class="s2">&quot;combo_dist&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
</span><span id="L-3127"><a href="#L-3127"><span class="linenos">3127</span></a>        <span class="p">]</span>
</span><span id="L-3128"><a href="#L-3128"><span class="linenos">3128</span></a>
</span><span id="L-3129"><a href="#L-3129"><span class="linenos">3129</span></a>        <span class="n">cells</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">])</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]))</span>
</span><span id="L-3130"><a href="#L-3130"><span class="linenos">3130</span></a>        <span class="n">combo_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">cells</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cells</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="L-3131"><a href="#L-3131"><span class="linenos">3131</span></a>
</span><span id="L-3132"><a href="#L-3132"><span class="linenos">3132</span></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="L-3133"><a href="#L-3133"><span class="linenos">3133</span></a>            <span class="n">combo_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;combo_dist&quot;</span><span class="p">]</span>
</span><span id="L-3134"><a href="#L-3134"><span class="linenos">3134</span></a>            <span class="n">combo_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;combo_dist&quot;</span><span class="p">]</span>
</span><span id="L-3135"><a href="#L-3135"><span class="linenos">3135</span></a>
</span><span id="L-3136"><a href="#L-3136"><span class="linenos">3136</span></a>        <span class="n">umap_model</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">UMAP</span><span class="p">(</span>
</span><span id="L-3137"><a href="#L-3137"><span class="linenos">3137</span></a>            <span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-3138"><a href="#L-3138"><span class="linenos">3138</span></a>            <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;precomputed&quot;</span><span class="p">,</span>
</span><span id="L-3139"><a href="#L-3139"><span class="linenos">3139</span></a>            <span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">,</span>
</span><span id="L-3140"><a href="#L-3140"><span class="linenos">3140</span></a>            <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span>
</span><span id="L-3141"><a href="#L-3141"><span class="linenos">3141</span></a>            <span class="n">spread</span><span class="o">=</span><span class="n">spread</span><span class="p">,</span>
</span><span id="L-3142"><a href="#L-3142"><span class="linenos">3142</span></a>            <span class="n">set_op_mix_ratio</span><span class="o">=</span><span class="n">set_op_mix_ratio</span><span class="p">,</span>
</span><span id="L-3143"><a href="#L-3143"><span class="linenos">3143</span></a>            <span class="n">local_connectivity</span><span class="o">=</span><span class="n">set_op_mix_ratio</span><span class="p">,</span>
</span><span id="L-3144"><a href="#L-3144"><span class="linenos">3144</span></a>            <span class="n">repulsion_strength</span><span class="o">=</span><span class="n">repulsion_strength</span><span class="p">,</span>
</span><span id="L-3145"><a href="#L-3145"><span class="linenos">3145</span></a>            <span class="n">negative_sample_rate</span><span class="o">=</span><span class="n">negative_sample_rate</span><span class="p">,</span>
</span><span id="L-3146"><a href="#L-3146"><span class="linenos">3146</span></a>            <span class="n">transform_seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
</span><span id="L-3147"><a href="#L-3147"><span class="linenos">3147</span></a>            <span class="n">init</span><span class="o">=</span><span class="s2">&quot;spectral&quot;</span><span class="p">,</span>
</span><span id="L-3148"><a href="#L-3148"><span class="linenos">3148</span></a>            <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
</span><span id="L-3149"><a href="#L-3149"><span class="linenos">3149</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-3150"><a href="#L-3150"><span class="linenos">3150</span></a>        <span class="p">)</span>
</span><span id="L-3151"><a href="#L-3151"><span class="linenos">3151</span></a>
</span><span id="L-3152"><a href="#L-3152"><span class="linenos">3152</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">umap_model</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">combo_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="L-3153"><a href="#L-3153"><span class="linenos">3153</span></a>        <span class="n">cell_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combo_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="L-3154"><a href="#L-3154"><span class="linenos">3154</span></a>        <span class="n">num_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_names</span><span class="p">)</span>
</span><span id="L-3155"><a href="#L-3155"><span class="linenos">3155</span></a>        <span class="n">palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;tab20c&quot;</span><span class="p">,</span> <span class="n">num_cells</span><span class="p">)</span>
</span><span id="L-3156"><a href="#L-3156"><span class="linenos">3156</span></a>
</span><span id="L-3157"><a href="#L-3157"><span class="linenos">3157</span></a>        <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">in</span> <span class="n">cell_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-3158"><a href="#L-3158"><span class="linenos">3158</span></a>            <span class="n">avsets</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
</span><span id="L-3159"><a href="#L-3159"><span class="linenos">3159</span></a>                <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*# &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">]]</span>
</span><span id="L-3160"><a href="#L-3160"><span class="linenos">3160</span></a>                <span class="o">+</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*# &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]]</span>
</span><span id="L-3161"><a href="#L-3161"><span class="linenos">3161</span></a>            <span class="p">)</span>
</span><span id="L-3162"><a href="#L-3162"><span class="linenos">3162</span></a>            <span class="n">num_sets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">avsets</span><span class="p">)</span>
</span><span id="L-3163"><a href="#L-3163"><span class="linenos">3163</span></a>            <span class="n">color_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span> <span class="o">//</span> <span class="n">num_sets</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sets</span><span class="p">)]</span>
</span><span id="L-3164"><a href="#L-3164"><span class="linenos">3164</span></a>            <span class="n">color_mapping_sets</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-3165"><a href="#L-3165"><span class="linenos">3165</span></a>                <span class="n">set_name</span><span class="p">:</span> <span class="n">palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">set_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">color_indices</span><span class="p">,</span> <span class="n">avsets</span><span class="p">)</span>
</span><span id="L-3166"><a href="#L-3166"><span class="linenos">3166</span></a>            <span class="p">}</span>
</span><span id="L-3167"><a href="#L-3167"><span class="linenos">3167</span></a>            <span class="n">color_mapping</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-3168"><a href="#L-3168"><span class="linenos">3168</span></a>                <span class="n">name</span><span class="p">:</span> <span class="n">color_mapping_sets</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*# &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)]</span>
</span><span id="L-3169"><a href="#L-3169"><span class="linenos">3169</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cell_names</span><span class="p">)</span>
</span><span id="L-3170"><a href="#L-3170"><span class="linenos">3170</span></a>            <span class="p">}</span>
</span><span id="L-3171"><a href="#L-3171"><span class="linenos">3171</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-3172"><a href="#L-3172"><span class="linenos">3172</span></a>            <span class="n">color_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cell_names</span><span class="p">)}</span>
</span><span id="L-3173"><a href="#L-3173"><span class="linenos">3173</span></a>
</span><span id="L-3174"><a href="#L-3174"><span class="linenos">3174</span></a>        <span class="n">meanshift</span> <span class="o">=</span> <span class="n">MeanShift</span><span class="p">(</span><span class="n">bandwidth</span><span class="o">=</span><span class="n">bandwidth</span><span class="p">)</span>
</span><span id="L-3175"><a href="#L-3175"><span class="linenos">3175</span></a>        <span class="n">labels</span> <span class="o">=</span> <span class="n">meanshift</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</span><span id="L-3176"><a href="#L-3176"><span class="linenos">3176</span></a>
</span><span id="L-3177"><a href="#L-3177"><span class="linenos">3177</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="L-3178"><a href="#L-3178"><span class="linenos">3178</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
</span><span id="L-3179"><a href="#L-3179"><span class="linenos">3179</span></a>
</span><span id="L-3180"><a href="#L-3180"><span class="linenos">3180</span></a>        <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
</span><span id="L-3181"><a href="#L-3181"><span class="linenos">3181</span></a>        <span class="n">cluster_palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;hls&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">))</span>
</span><span id="L-3182"><a href="#L-3182"><span class="linenos">3182</span></a>
</span><span id="L-3183"><a href="#L-3183"><span class="linenos">3183</span></a>        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
</span><span id="L-3184"><a href="#L-3184"><span class="linenos">3184</span></a>            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-3185"><a href="#L-3185"><span class="linenos">3185</span></a>                <span class="k">continue</span>
</span><span id="L-3186"><a href="#L-3186"><span class="linenos">3186</span></a>            <span class="n">cluster_coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">label</span><span class="p">]</span>
</span><span id="L-3187"><a href="#L-3187"><span class="linenos">3187</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_coords</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-3188"><a href="#L-3188"><span class="linenos">3188</span></a>                <span class="k">continue</span>
</span><span id="L-3189"><a href="#L-3189"><span class="linenos">3189</span></a>
</span><span id="L-3190"><a href="#L-3190"><span class="linenos">3190</span></a>            <span class="n">hull</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">(</span><span class="n">cluster_coords</span><span class="p">)</span>
</span><span id="L-3191"><a href="#L-3191"><span class="linenos">3191</span></a>            <span class="n">hull_points</span> <span class="o">=</span> <span class="n">cluster_coords</span><span class="p">[</span><span class="n">hull</span><span class="o">.</span><span class="n">vertices</span><span class="p">]</span>
</span><span id="L-3192"><a href="#L-3192"><span class="linenos">3192</span></a>
</span><span id="L-3193"><a href="#L-3193"><span class="linenos">3193</span></a>            <span class="n">centroid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hull_points</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-3194"><a href="#L-3194"><span class="linenos">3194</span></a>            <span class="n">expanded</span> <span class="o">=</span> <span class="n">hull_points</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="n">hull_points</span> <span class="o">-</span> <span class="n">centroid</span><span class="p">)</span>
</span><span id="L-3195"><a href="#L-3195"><span class="linenos">3195</span></a>
</span><span id="L-3196"><a href="#L-3196"><span class="linenos">3196</span></a>            <span class="n">poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span>
</span><span id="L-3197"><a href="#L-3197"><span class="linenos">3197</span></a>                <span class="n">expanded</span><span class="p">,</span>
</span><span id="L-3198"><a href="#L-3198"><span class="linenos">3198</span></a>                <span class="n">closed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-3199"><a href="#L-3199"><span class="linenos">3199</span></a>                <span class="n">facecolor</span><span class="o">=</span><span class="n">cluster_palette</span><span class="p">[</span><span class="n">label</span><span class="p">],</span>
</span><span id="L-3200"><a href="#L-3200"><span class="linenos">3200</span></a>                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="L-3201"><a href="#L-3201"><span class="linenos">3201</span></a>                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span><span id="L-3202"><a href="#L-3202"><span class="linenos">3202</span></a>                <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-3203"><a href="#L-3203"><span class="linenos">3203</span></a>            <span class="p">)</span>
</span><span id="L-3204"><a href="#L-3204"><span class="linenos">3204</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
</span><span id="L-3205"><a href="#L-3205"><span class="linenos">3205</span></a>
</span><span id="L-3206"><a href="#L-3206"><span class="linenos">3206</span></a>        <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3207"><a href="#L-3207"><span class="linenos">3207</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
</span><span id="L-3208"><a href="#L-3208"><span class="linenos">3208</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="L-3209"><a href="#L-3209"><span class="linenos">3209</span></a>                <span class="n">x</span><span class="p">,</span>
</span><span id="L-3210"><a href="#L-3210"><span class="linenos">3210</span></a>                <span class="n">y</span><span class="p">,</span>
</span><span id="L-3211"><a href="#L-3211"><span class="linenos">3211</span></a>                <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span>
</span><span id="L-3212"><a href="#L-3212"><span class="linenos">3212</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">color_mapping</span><span class="p">[</span><span class="n">cell_names</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
</span><span id="L-3213"><a href="#L-3213"><span class="linenos">3213</span></a>                <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="L-3214"><a href="#L-3214"><span class="linenos">3214</span></a>                <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="L-3215"><a href="#L-3215"><span class="linenos">3215</span></a>                <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-3216"><a href="#L-3216"><span class="linenos">3216</span></a>            <span class="p">)</span>
</span><span id="L-3217"><a href="#L-3217"><span class="linenos">3217</span></a>            <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-3218"><a href="#L-3218"><span class="linenos">3218</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="L-3219"><a href="#L-3219"><span class="linenos">3219</span></a>                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span>
</span><span id="L-3220"><a href="#L-3220"><span class="linenos">3220</span></a>                <span class="p">)</span>
</span><span id="L-3221"><a href="#L-3221"><span class="linenos">3221</span></a>            <span class="p">)</span>
</span><span id="L-3222"><a href="#L-3222"><span class="linenos">3222</span></a>
</span><span id="L-3223"><a href="#L-3223"><span class="linenos">3223</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">dist</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
</span><span id="L-3224"><a href="#L-3224"><span class="linenos">3224</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-3225"><a href="#L-3225"><span class="linenos">3225</span></a>
</span><span id="L-3226"><a href="#L-3226"><span class="linenos">3226</span></a>        <span class="n">texts_to_adjust</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3227"><a href="#L-3227"><span class="linenos">3227</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
</span><span id="L-3228"><a href="#L-3228"><span class="linenos">3228</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">t2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
</span><span id="L-3229"><a href="#L-3229"><span class="linenos">3229</span></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">j</span><span class="p">:</span>
</span><span id="L-3230"><a href="#L-3230"><span class="linenos">3230</span></a>                    <span class="k">continue</span>
</span><span id="L-3231"><a href="#L-3231"><span class="linenos">3231</span></a>                <span class="n">d</span> <span class="o">=</span> <span class="n">dist</span><span class="p">(</span>
</span><span id="L-3232"><a href="#L-3232"><span class="linenos">3232</span></a>                    <span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">get_position</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t1</span><span class="o">.</span><span class="n">get_position</span><span class="p">()[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-3233"><a href="#L-3233"><span class="linenos">3233</span></a>                    <span class="p">(</span><span class="n">t2</span><span class="o">.</span><span class="n">get_position</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t2</span><span class="o">.</span><span class="n">get_position</span><span class="p">()[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-3234"><a href="#L-3234"><span class="linenos">3234</span></a>                <span class="p">)</span>
</span><span id="L-3235"><a href="#L-3235"><span class="linenos">3235</span></a>                <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="L-3236"><a href="#L-3236"><span class="linenos">3236</span></a>                    <span class="k">if</span> <span class="n">t1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">texts_to_adjust</span><span class="p">:</span>
</span><span id="L-3237"><a href="#L-3237"><span class="linenos">3237</span></a>                        <span class="n">texts_to_adjust</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
</span><span id="L-3238"><a href="#L-3238"><span class="linenos">3238</span></a>                    <span class="k">if</span> <span class="n">t2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">texts_to_adjust</span><span class="p">:</span>
</span><span id="L-3239"><a href="#L-3239"><span class="linenos">3239</span></a>                        <span class="n">texts_to_adjust</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
</span><span id="L-3240"><a href="#L-3240"><span class="linenos">3240</span></a>
</span><span id="L-3241"><a href="#L-3241"><span class="linenos">3241</span></a>        <span class="n">adjust_text</span><span class="p">(</span>
</span><span id="L-3242"><a href="#L-3242"><span class="linenos">3242</span></a>            <span class="n">texts_to_adjust</span><span class="p">,</span>
</span><span id="L-3243"><a href="#L-3243"><span class="linenos">3243</span></a>            <span class="n">expand_text</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
</span><span id="L-3244"><a href="#L-3244"><span class="linenos">3244</span></a>            <span class="n">force_text</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
</span><span id="L-3245"><a href="#L-3245"><span class="linenos">3245</span></a>            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span>
</span><span id="L-3246"><a href="#L-3246"><span class="linenos">3246</span></a>            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
</span><span id="L-3247"><a href="#L-3247"><span class="linenos">3247</span></a>        <span class="p">)</span>
</span><span id="L-3248"><a href="#L-3248"><span class="linenos">3248</span></a>
</span><span id="L-3249"><a href="#L-3249"><span class="linenos">3249</span></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">arrow_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="L-3250"><a href="#L-3250"><span class="linenos">3250</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-3251"><a href="#L-3251"><span class="linenos">3251</span></a>                <span class="n">idx1</span> <span class="o">=</span> <span class="n">cell_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">])</span>
</span><span id="L-3252"><a href="#L-3252"><span class="linenos">3252</span></a>                <span class="n">idx2</span> <span class="o">=</span> <span class="n">cell_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">])</span>
</span><span id="L-3253"><a href="#L-3253"><span class="linenos">3253</span></a>            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="L-3254"><a href="#L-3254"><span class="linenos">3254</span></a>                <span class="k">continue</span>
</span><span id="L-3255"><a href="#L-3255"><span class="linenos">3255</span></a>            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span>
</span><span id="L-3256"><a href="#L-3256"><span class="linenos">3256</span></a>            <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span>
</span><span id="L-3257"><a href="#L-3257"><span class="linenos">3257</span></a>            <span class="n">arrow</span> <span class="o">=</span> <span class="n">FancyArrowPatch</span><span class="p">(</span>
</span><span id="L-3258"><a href="#L-3258"><span class="linenos">3258</span></a>                <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span>
</span><span id="L-3259"><a href="#L-3259"><span class="linenos">3259</span></a>                <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span>
</span><span id="L-3260"><a href="#L-3260"><span class="linenos">3260</span></a>                <span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span>
</span><span id="L-3261"><a href="#L-3261"><span class="linenos">3261</span></a>                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
</span><span id="L-3262"><a href="#L-3262"><span class="linenos">3262</span></a>                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
</span><span id="L-3263"><a href="#L-3263"><span class="linenos">3263</span></a>                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="L-3264"><a href="#L-3264"><span class="linenos">3264</span></a>                <span class="n">mutation_scale</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="L-3265"><a href="#L-3265"><span class="linenos">3265</span></a>                <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-3266"><a href="#L-3266"><span class="linenos">3266</span></a>            <span class="p">)</span>
</span><span id="L-3267"><a href="#L-3267"><span class="linenos">3267</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">arrow</span><span class="p">)</span>
</span><span id="L-3268"><a href="#L-3268"><span class="linenos">3268</span></a>
</span><span id="L-3269"><a href="#L-3269"><span class="linenos">3269</span></a>        <span class="k">if</span> <span class="n">set_info</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="s2">&quot; # &quot;</span> <span class="ow">in</span> <span class="n">cell_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-3270"><a href="#L-3270"><span class="linenos">3270</span></a>
</span><span id="L-3271"><a href="#L-3271"><span class="linenos">3271</span></a>            <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-3272"><a href="#L-3272"><span class="linenos">3272</span></a>                <span class="n">Patch</span><span class="p">(</span>
</span><span id="L-3273"><a href="#L-3273"><span class="linenos">3273</span></a>                    <span class="n">facecolor</span><span class="o">=</span><span class="n">color_mapping</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
</span><span id="L-3274"><a href="#L-3274"><span class="linenos">3274</span></a>                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="L-3275"><a href="#L-3275"><span class="linenos">3275</span></a>                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> – </span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; #.*&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-3276"><a href="#L-3276"><span class="linenos">3276</span></a>                <span class="p">)</span>
</span><span id="L-3277"><a href="#L-3277"><span class="linenos">3277</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cell_names</span><span class="p">)</span>
</span><span id="L-3278"><a href="#L-3278"><span class="linenos">3278</span></a>            <span class="p">]</span>
</span><span id="L-3279"><a href="#L-3279"><span class="linenos">3279</span></a>
</span><span id="L-3280"><a href="#L-3280"><span class="linenos">3280</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-3281"><a href="#L-3281"><span class="linenos">3281</span></a>
</span><span id="L-3282"><a href="#L-3282"><span class="linenos">3282</span></a>            <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-3283"><a href="#L-3283"><span class="linenos">3283</span></a>                <span class="n">Patch</span><span class="p">(</span>
</span><span id="L-3284"><a href="#L-3284"><span class="linenos">3284</span></a>                    <span class="n">facecolor</span><span class="o">=</span><span class="n">color_mapping</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
</span><span id="L-3285"><a href="#L-3285"><span class="linenos">3285</span></a>                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="L-3286"><a href="#L-3286"><span class="linenos">3286</span></a>                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> – </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-3287"><a href="#L-3287"><span class="linenos">3287</span></a>                <span class="p">)</span>
</span><span id="L-3288"><a href="#L-3288"><span class="linenos">3288</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cell_names</span><span class="p">)</span>
</span><span id="L-3289"><a href="#L-3289"><span class="linenos">3289</span></a>            <span class="p">]</span>
</span><span id="L-3290"><a href="#L-3290"><span class="linenos">3290</span></a>
</span><span id="L-3291"><a href="#L-3291"><span class="linenos">3291</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="L-3292"><a href="#L-3292"><span class="linenos">3292</span></a>            <span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span>
</span><span id="L-3293"><a href="#L-3293"><span class="linenos">3293</span></a>            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Cells&quot;</span><span class="p">,</span>
</span><span id="L-3294"><a href="#L-3294"><span class="linenos">3294</span></a>            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="L-3295"><a href="#L-3295"><span class="linenos">3295</span></a>            <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span>
</span><span id="L-3296"><a href="#L-3296"><span class="linenos">3296</span></a>            <span class="n">ncol</span><span class="o">=</span><span class="n">legend_split</span><span class="p">,</span>
</span><span id="L-3297"><a href="#L-3297"><span class="linenos">3297</span></a>        <span class="p">)</span>
</span><span id="L-3298"><a href="#L-3298"><span class="linenos">3298</span></a>
</span><span id="L-3299"><a href="#L-3299"><span class="linenos">3299</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">)</span>
</span><span id="L-3300"><a href="#L-3300"><span class="linenos">3300</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">)</span>
</span><span id="L-3301"><a href="#L-3301"><span class="linenos">3301</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-3302"><a href="#L-3302"><span class="linenos">3302</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-3303"><a href="#L-3303"><span class="linenos">3303</span></a>
</span><span id="L-3304"><a href="#L-3304"><span class="linenos">3304</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="L-3305"><a href="#L-3305"><span class="linenos">3305</span></a>
</span><span id="L-3306"><a href="#L-3306"><span class="linenos">3306</span></a>    <span class="c1"># subclusters part</span>
</span><span id="L-3307"><a href="#L-3307"><span class="linenos">3307</span></a>
</span><span id="L-3308"><a href="#L-3308"><span class="linenos">3308</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">subcluster_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">cluster</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-3309"><a href="#L-3309"><span class="linenos">3309</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3310"><a href="#L-3310"><span class="linenos">3310</span></a><span class="sd">        Prepare a `Clustering` object for subcluster analysis on a selected parent cluster.</span>
</span><span id="L-3311"><a href="#L-3311"><span class="linenos">3311</span></a>
</span><span id="L-3312"><a href="#L-3312"><span class="linenos">3312</span></a><span class="sd">        Parameters</span>
</span><span id="L-3313"><a href="#L-3313"><span class="linenos">3313</span></a><span class="sd">        ----------</span>
</span><span id="L-3314"><a href="#L-3314"><span class="linenos">3314</span></a><span class="sd">        features : list</span>
</span><span id="L-3315"><a href="#L-3315"><span class="linenos">3315</span></a><span class="sd">            Features to include for subcluster analysis.</span>
</span><span id="L-3316"><a href="#L-3316"><span class="linenos">3316</span></a>
</span><span id="L-3317"><a href="#L-3317"><span class="linenos">3317</span></a><span class="sd">        cluster : str</span>
</span><span id="L-3318"><a href="#L-3318"><span class="linenos">3318</span></a><span class="sd">            Parent cluster name (used to select matching cells).</span>
</span><span id="L-3319"><a href="#L-3319"><span class="linenos">3319</span></a>
</span><span id="L-3320"><a href="#L-3320"><span class="linenos">3320</span></a><span class="sd">        Update</span>
</span><span id="L-3321"><a href="#L-3321"><span class="linenos">3321</span></a><span class="sd">        ------</span>
</span><span id="L-3322"><a href="#L-3322"><span class="linenos">3322</span></a><span class="sd">        Initializes `self.subclusters_` as a new `Clustering` instance containing the</span>
</span><span id="L-3323"><a href="#L-3323"><span class="linenos">3323</span></a><span class="sd">        reduced data for the given cluster and stores `current_features` and `current_cluster`.</span>
</span><span id="L-3324"><a href="#L-3324"><span class="linenos">3324</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-3325"><a href="#L-3325"><span class="linenos">3325</span></a>
</span><span id="L-3326"><a href="#L-3326"><span class="linenos">3326</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span>
</span><span id="L-3327"><a href="#L-3327"><span class="linenos">3327</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">])</span>
</span><span id="L-3328"><a href="#L-3328"><span class="linenos">3328</span></a>
</span><span id="L-3329"><a href="#L-3329"><span class="linenos">3329</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="n">reduce_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="n">cluster</span><span class="p">])</span>
</span><span id="L-3330"><a href="#L-3330"><span class="linenos">3330</span></a>
</span><span id="L-3331"><a href="#L-3331"><span class="linenos">3331</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="o">=</span> <span class="n">Clustering</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-3332"><a href="#L-3332"><span class="linenos">3332</span></a>
</span><span id="L-3333"><a href="#L-3333"><span class="linenos">3333</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">current_features</span> <span class="o">=</span> <span class="n">features</span>
</span><span id="L-3334"><a href="#L-3334"><span class="linenos">3334</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">current_cluster</span> <span class="o">=</span> <span class="n">cluster</span>
</span><span id="L-3335"><a href="#L-3335"><span class="linenos">3335</span></a>
</span><span id="L-3336"><a href="#L-3336"><span class="linenos">3336</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_subclusters</span><span class="p">(</span>
</span><span id="L-3337"><a href="#L-3337"><span class="linenos">3337</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-3338"><a href="#L-3338"><span class="linenos">3338</span></a>        <span class="n">umap_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="L-3339"><a href="#L-3339"><span class="linenos">3339</span></a>        <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="L-3340"><a href="#L-3340"><span class="linenos">3340</span></a>        <span class="n">min_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="L-3341"><a href="#L-3341"><span class="linenos">3341</span></a>        <span class="n">n_neighbors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="L-3342"><a href="#L-3342"><span class="linenos">3342</span></a>        <span class="n">min_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-3343"><a href="#L-3343"><span class="linenos">3343</span></a>        <span class="n">spread</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-3344"><a href="#L-3344"><span class="linenos">3344</span></a>        <span class="n">set_op_mix_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-3345"><a href="#L-3345"><span class="linenos">3345</span></a>        <span class="n">local_connectivity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-3346"><a href="#L-3346"><span class="linenos">3346</span></a>        <span class="n">repulsion_strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-3347"><a href="#L-3347"><span class="linenos">3347</span></a>        <span class="n">negative_sample_rate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="L-3348"><a href="#L-3348"><span class="linenos">3348</span></a>        <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="L-3349"><a href="#L-3349"><span class="linenos">3349</span></a>        <span class="n">height</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="L-3350"><a href="#L-3350"><span class="linenos">3350</span></a>    <span class="p">):</span>
</span><span id="L-3351"><a href="#L-3351"><span class="linenos">3351</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3352"><a href="#L-3352"><span class="linenos">3352</span></a><span class="sd">        Compute UMAP and DBSCAN clustering within a previously prepared subcluster dataset.</span>
</span><span id="L-3353"><a href="#L-3353"><span class="linenos">3353</span></a>
</span><span id="L-3354"><a href="#L-3354"><span class="linenos">3354</span></a><span class="sd">        Parameters</span>
</span><span id="L-3355"><a href="#L-3355"><span class="linenos">3355</span></a><span class="sd">        ----------</span>
</span><span id="L-3356"><a href="#L-3356"><span class="linenos">3356</span></a><span class="sd">        umap_num : int, default 2</span>
</span><span id="L-3357"><a href="#L-3357"><span class="linenos">3357</span></a><span class="sd">            Number of UMAP dimensions to compute.</span>
</span><span id="L-3358"><a href="#L-3358"><span class="linenos">3358</span></a>
</span><span id="L-3359"><a href="#L-3359"><span class="linenos">3359</span></a><span class="sd">        eps : float, default 0.5</span>
</span><span id="L-3360"><a href="#L-3360"><span class="linenos">3360</span></a><span class="sd">            DBSCAN eps parameter.</span>
</span><span id="L-3361"><a href="#L-3361"><span class="linenos">3361</span></a>
</span><span id="L-3362"><a href="#L-3362"><span class="linenos">3362</span></a><span class="sd">        min_samples : int, default 10</span>
</span><span id="L-3363"><a href="#L-3363"><span class="linenos">3363</span></a><span class="sd">            DBSCAN min_samples parameter.</span>
</span><span id="L-3364"><a href="#L-3364"><span class="linenos">3364</span></a>
</span><span id="L-3365"><a href="#L-3365"><span class="linenos">3365</span></a><span class="sd">        n_neighbors, min_dist, spread, set_op_mix_ratio, local_connectivity, repulsion_strength, negative_sample_rate, width, height :</span>
</span><span id="L-3366"><a href="#L-3366"><span class="linenos">3366</span></a><span class="sd">            Additional parameters passed to UMAP / plotting / MeanShift as appropriate.</span>
</span><span id="L-3367"><a href="#L-3367"><span class="linenos">3367</span></a>
</span><span id="L-3368"><a href="#L-3368"><span class="linenos">3368</span></a><span class="sd">        Update</span>
</span><span id="L-3369"><a href="#L-3369"><span class="linenos">3369</span></a><span class="sd">        -------</span>
</span><span id="L-3370"><a href="#L-3370"><span class="linenos">3370</span></a><span class="sd">        Stores cluster labels in `self.subclusters_.subclusters`.</span>
</span><span id="L-3371"><a href="#L-3371"><span class="linenos">3371</span></a>
</span><span id="L-3372"><a href="#L-3372"><span class="linenos">3372</span></a><span class="sd">        Raises</span>
</span><span id="L-3373"><a href="#L-3373"><span class="linenos">3373</span></a><span class="sd">        ------</span>
</span><span id="L-3374"><a href="#L-3374"><span class="linenos">3374</span></a><span class="sd">        RuntimeError</span>
</span><span id="L-3375"><a href="#L-3375"><span class="linenos">3375</span></a><span class="sd">            If `self.subclusters_` has not been prepared.</span>
</span><span id="L-3376"><a href="#L-3376"><span class="linenos">3376</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-3377"><a href="#L-3377"><span class="linenos">3377</span></a>
</span><span id="L-3378"><a href="#L-3378"><span class="linenos">3378</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3379"><a href="#L-3379"><span class="linenos">3379</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="L-3380"><a href="#L-3380"><span class="linenos">3380</span></a>                <span class="s2">&quot;Nothing to return. &#39;self.subcluster_prepare&#39; was not conducted!&quot;</span>
</span><span id="L-3381"><a href="#L-3381"><span class="linenos">3381</span></a>            <span class="p">)</span>
</span><span id="L-3382"><a href="#L-3382"><span class="linenos">3382</span></a>
</span><span id="L-3383"><a href="#L-3383"><span class="linenos">3383</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">perform_UMAP</span><span class="p">(</span>
</span><span id="L-3384"><a href="#L-3384"><span class="linenos">3384</span></a>            <span class="n">factorize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-3385"><a href="#L-3385"><span class="linenos">3385</span></a>            <span class="n">umap_num</span><span class="o">=</span><span class="n">umap_num</span><span class="p">,</span>
</span><span id="L-3386"><a href="#L-3386"><span class="linenos">3386</span></a>            <span class="n">pc_num</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-3387"><a href="#L-3387"><span class="linenos">3387</span></a>            <span class="n">harmonized</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-3388"><a href="#L-3388"><span class="linenos">3388</span></a>            <span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">,</span>
</span><span id="L-3389"><a href="#L-3389"><span class="linenos">3389</span></a>            <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span>
</span><span id="L-3390"><a href="#L-3390"><span class="linenos">3390</span></a>            <span class="n">spread</span><span class="o">=</span><span class="n">spread</span><span class="p">,</span>
</span><span id="L-3391"><a href="#L-3391"><span class="linenos">3391</span></a>            <span class="n">set_op_mix_ratio</span><span class="o">=</span><span class="n">set_op_mix_ratio</span><span class="p">,</span>
</span><span id="L-3392"><a href="#L-3392"><span class="linenos">3392</span></a>            <span class="n">local_connectivity</span><span class="o">=</span><span class="n">local_connectivity</span><span class="p">,</span>
</span><span id="L-3393"><a href="#L-3393"><span class="linenos">3393</span></a>            <span class="n">repulsion_strength</span><span class="o">=</span><span class="n">repulsion_strength</span><span class="p">,</span>
</span><span id="L-3394"><a href="#L-3394"><span class="linenos">3394</span></a>            <span class="n">negative_sample_rate</span><span class="o">=</span><span class="n">negative_sample_rate</span><span class="p">,</span>
</span><span id="L-3395"><a href="#L-3395"><span class="linenos">3395</span></a>            <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
</span><span id="L-3396"><a href="#L-3396"><span class="linenos">3396</span></a>            <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
</span><span id="L-3397"><a href="#L-3397"><span class="linenos">3397</span></a>        <span class="p">)</span>
</span><span id="L-3398"><a href="#L-3398"><span class="linenos">3398</span></a>
</span><span id="L-3399"><a href="#L-3399"><span class="linenos">3399</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">find_clusters_UMAP</span><span class="p">(</span>
</span><span id="L-3400"><a href="#L-3400"><span class="linenos">3400</span></a>            <span class="n">umap_n</span><span class="o">=</span><span class="n">umap_num</span><span class="p">,</span>
</span><span id="L-3401"><a href="#L-3401"><span class="linenos">3401</span></a>            <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span>
</span><span id="L-3402"><a href="#L-3402"><span class="linenos">3402</span></a>            <span class="n">min_samples</span><span class="o">=</span><span class="n">min_samples</span><span class="p">,</span>
</span><span id="L-3403"><a href="#L-3403"><span class="linenos">3403</span></a>            <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
</span><span id="L-3404"><a href="#L-3404"><span class="linenos">3404</span></a>            <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
</span><span id="L-3405"><a href="#L-3405"><span class="linenos">3405</span></a>        <span class="p">)</span>
</span><span id="L-3406"><a href="#L-3406"><span class="linenos">3406</span></a>
</span><span id="L-3407"><a href="#L-3407"><span class="linenos">3407</span></a>        <span class="n">clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">return_clusters</span><span class="p">(</span><span class="n">clusters</span><span class="o">=</span><span class="s2">&quot;umap&quot;</span><span class="p">)</span>
</span><span id="L-3408"><a href="#L-3408"><span class="linenos">3408</span></a>
</span><span id="L-3409"><a href="#L-3409"><span class="linenos">3409</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">clusters</span><span class="p">)]</span>
</span><span id="L-3410"><a href="#L-3410"><span class="linenos">3410</span></a>
</span><span id="L-3411"><a href="#L-3411"><span class="linenos">3411</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="L-3412"><a href="#L-3412"><span class="linenos">3412</span></a>
</span><span id="L-3413"><a href="#L-3413"><span class="linenos">3413</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">subcluster_features_scatter</span><span class="p">(</span>
</span><span id="L-3414"><a href="#L-3414"><span class="linenos">3414</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-3415"><a href="#L-3415"><span class="linenos">3415</span></a>        <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
</span><span id="L-3416"><a href="#L-3416"><span class="linenos">3416</span></a>        <span class="n">hclust</span><span class="o">=</span><span class="s2">&quot;complete&quot;</span><span class="p">,</span>
</span><span id="L-3417"><a href="#L-3417"><span class="linenos">3417</span></a>        <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-3418"><a href="#L-3418"><span class="linenos">3418</span></a>        <span class="n">img_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="L-3419"><a href="#L-3419"><span class="linenos">3419</span></a>        <span class="n">img_high</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="L-3420"><a href="#L-3420"><span class="linenos">3420</span></a>        <span class="n">label_size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="L-3421"><a href="#L-3421"><span class="linenos">3421</span></a>        <span class="n">size_scale</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span>
</span><span id="L-3422"><a href="#L-3422"><span class="linenos">3422</span></a>        <span class="n">y_lab</span><span class="o">=</span><span class="s2">&quot;Genes&quot;</span><span class="p">,</span>
</span><span id="L-3423"><a href="#L-3423"><span class="linenos">3423</span></a>        <span class="n">legend_lab</span><span class="o">=</span><span class="s2">&quot;normalized&quot;</span><span class="p">,</span>
</span><span id="L-3424"><a href="#L-3424"><span class="linenos">3424</span></a>        <span class="n">bbox_to_anchor_scale</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
</span><span id="L-3425"><a href="#L-3425"><span class="linenos">3425</span></a>        <span class="n">bbox_to_anchor_perc</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.91</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">),</span>
</span><span id="L-3426"><a href="#L-3426"><span class="linenos">3426</span></a>    <span class="p">):</span>
</span><span id="L-3427"><a href="#L-3427"><span class="linenos">3427</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3428"><a href="#L-3428"><span class="linenos">3428</span></a><span class="sd">        Create a features-scatter visualization for the subclusters (averaged and occurrence).</span>
</span><span id="L-3429"><a href="#L-3429"><span class="linenos">3429</span></a>
</span><span id="L-3430"><a href="#L-3430"><span class="linenos">3430</span></a><span class="sd">        Parameters</span>
</span><span id="L-3431"><a href="#L-3431"><span class="linenos">3431</span></a><span class="sd">        ----------</span>
</span><span id="L-3432"><a href="#L-3432"><span class="linenos">3432</span></a><span class="sd">        colors : str, default &#39;viridis&#39;</span>
</span><span id="L-3433"><a href="#L-3433"><span class="linenos">3433</span></a><span class="sd">            Colormap name passed to `features_scatter`.</span>
</span><span id="L-3434"><a href="#L-3434"><span class="linenos">3434</span></a>
</span><span id="L-3435"><a href="#L-3435"><span class="linenos">3435</span></a><span class="sd">        hclust : str or None</span>
</span><span id="L-3436"><a href="#L-3436"><span class="linenos">3436</span></a><span class="sd">            Hierarchical clustering linkage to order rows/columns.</span>
</span><span id="L-3437"><a href="#L-3437"><span class="linenos">3437</span></a>
</span><span id="L-3438"><a href="#L-3438"><span class="linenos">3438</span></a><span class="sd">        scale: bool, default False</span>
</span><span id="L-3439"><a href="#L-3439"><span class="linenos">3439</span></a><span class="sd">            If True, expression data will be scaled (0–1) across the rows (features).</span>
</span><span id="L-3440"><a href="#L-3440"><span class="linenos">3440</span></a>
</span><span id="L-3441"><a href="#L-3441"><span class="linenos">3441</span></a><span class="sd">        img_width, img_high : float</span>
</span><span id="L-3442"><a href="#L-3442"><span class="linenos">3442</span></a><span class="sd">            Figure size.</span>
</span><span id="L-3443"><a href="#L-3443"><span class="linenos">3443</span></a>
</span><span id="L-3444"><a href="#L-3444"><span class="linenos">3444</span></a><span class="sd">        label_size : int</span>
</span><span id="L-3445"><a href="#L-3445"><span class="linenos">3445</span></a><span class="sd">            Font size for labels.</span>
</span><span id="L-3446"><a href="#L-3446"><span class="linenos">3446</span></a>
</span><span id="L-3447"><a href="#L-3447"><span class="linenos">3447</span></a><span class="sd">        size_scale : int</span>
</span><span id="L-3448"><a href="#L-3448"><span class="linenos">3448</span></a><span class="sd">            Bubble size scaling.</span>
</span><span id="L-3449"><a href="#L-3449"><span class="linenos">3449</span></a>
</span><span id="L-3450"><a href="#L-3450"><span class="linenos">3450</span></a><span class="sd">        y_lab : str</span>
</span><span id="L-3451"><a href="#L-3451"><span class="linenos">3451</span></a><span class="sd">            X axis label.</span>
</span><span id="L-3452"><a href="#L-3452"><span class="linenos">3452</span></a>
</span><span id="L-3453"><a href="#L-3453"><span class="linenos">3453</span></a><span class="sd">        legend_lab : str</span>
</span><span id="L-3454"><a href="#L-3454"><span class="linenos">3454</span></a><span class="sd">            Colorbar label.</span>
</span><span id="L-3455"><a href="#L-3455"><span class="linenos">3455</span></a>
</span><span id="L-3456"><a href="#L-3456"><span class="linenos">3456</span></a><span class="sd">        bbox_to_anchor_scale : int, default=25</span>
</span><span id="L-3457"><a href="#L-3457"><span class="linenos">3457</span></a><span class="sd">            Vertical scale (percentage) for positioning the colorbar.</span>
</span><span id="L-3458"><a href="#L-3458"><span class="linenos">3458</span></a>
</span><span id="L-3459"><a href="#L-3459"><span class="linenos">3459</span></a><span class="sd">        bbox_to_anchor_perc : tuple, default=(0.91, 0.63)</span>
</span><span id="L-3460"><a href="#L-3460"><span class="linenos">3460</span></a><span class="sd">            Anchor position for the size legend (percent bubble legend).</span>
</span><span id="L-3461"><a href="#L-3461"><span class="linenos">3461</span></a>
</span><span id="L-3462"><a href="#L-3462"><span class="linenos">3462</span></a><span class="sd">        Returns</span>
</span><span id="L-3463"><a href="#L-3463"><span class="linenos">3463</span></a><span class="sd">        -------</span>
</span><span id="L-3464"><a href="#L-3464"><span class="linenos">3464</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="L-3465"><a href="#L-3465"><span class="linenos">3465</span></a>
</span><span id="L-3466"><a href="#L-3466"><span class="linenos">3466</span></a><span class="sd">        Raises</span>
</span><span id="L-3467"><a href="#L-3467"><span class="linenos">3467</span></a><span class="sd">        ------</span>
</span><span id="L-3468"><a href="#L-3468"><span class="linenos">3468</span></a><span class="sd">        RuntimeError</span>
</span><span id="L-3469"><a href="#L-3469"><span class="linenos">3469</span></a><span class="sd">            If subcluster preparation/definition has not been run.</span>
</span><span id="L-3470"><a href="#L-3470"><span class="linenos">3470</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-3471"><a href="#L-3471"><span class="linenos">3471</span></a>
</span><span id="L-3472"><a href="#L-3472"><span class="linenos">3472</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3473"><a href="#L-3473"><span class="linenos">3473</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="L-3474"><a href="#L-3474"><span class="linenos">3474</span></a>                <span class="s2">&quot;Nothing to return. &#39;self.subcluster_prepare&#39; -&gt; &#39;self.define_subclusters&#39; pip was not conducted!&quot;</span>
</span><span id="L-3475"><a href="#L-3475"><span class="linenos">3475</span></a>            <span class="p">)</span>
</span><span id="L-3476"><a href="#L-3476"><span class="linenos">3476</span></a>
</span><span id="L-3477"><a href="#L-3477"><span class="linenos">3477</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span>
</span><span id="L-3478"><a href="#L-3478"><span class="linenos">3478</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">])</span>
</span><span id="L-3479"><a href="#L-3479"><span class="linenos">3479</span></a>
</span><span id="L-3480"><a href="#L-3480"><span class="linenos">3480</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="n">reduce_data</span><span class="p">(</span>
</span><span id="L-3481"><a href="#L-3481"><span class="linenos">3481</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="p">,</span>
</span><span id="L-3482"><a href="#L-3482"><span class="linenos">3482</span></a>            <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">current_features</span><span class="p">,</span>
</span><span id="L-3483"><a href="#L-3483"><span class="linenos">3483</span></a>            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">current_cluster</span><span class="p">],</span>
</span><span id="L-3484"><a href="#L-3484"><span class="linenos">3484</span></a>        <span class="p">)</span>
</span><span id="L-3485"><a href="#L-3485"><span class="linenos">3485</span></a>
</span><span id="L-3486"><a href="#L-3486"><span class="linenos">3486</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span>
</span><span id="L-3487"><a href="#L-3487"><span class="linenos">3487</span></a>
</span><span id="L-3488"><a href="#L-3488"><span class="linenos">3488</span></a>        <span class="n">avg</span> <span class="o">=</span> <span class="n">average</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="L-3489"><a href="#L-3489"><span class="linenos">3489</span></a>        <span class="n">occ</span> <span class="o">=</span> <span class="n">occurrence</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="L-3490"><a href="#L-3490"><span class="linenos">3490</span></a>
</span><span id="L-3491"><a href="#L-3491"><span class="linenos">3491</span></a>        <span class="n">scatter</span> <span class="o">=</span> <span class="n">features_scatter</span><span class="p">(</span>
</span><span id="L-3492"><a href="#L-3492"><span class="linenos">3492</span></a>            <span class="n">expression_data</span><span class="o">=</span><span class="n">avg</span><span class="p">,</span>
</span><span id="L-3493"><a href="#L-3493"><span class="linenos">3493</span></a>            <span class="n">occurence_data</span><span class="o">=</span><span class="n">occ</span><span class="p">,</span>
</span><span id="L-3494"><a href="#L-3494"><span class="linenos">3494</span></a>            <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-3495"><a href="#L-3495"><span class="linenos">3495</span></a>            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
</span><span id="L-3496"><a href="#L-3496"><span class="linenos">3496</span></a>            <span class="n">metadata_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-3497"><a href="#L-3497"><span class="linenos">3497</span></a>            <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
</span><span id="L-3498"><a href="#L-3498"><span class="linenos">3498</span></a>            <span class="n">hclust</span><span class="o">=</span><span class="n">hclust</span><span class="p">,</span>
</span><span id="L-3499"><a href="#L-3499"><span class="linenos">3499</span></a>            <span class="n">img_width</span><span class="o">=</span><span class="n">img_width</span><span class="p">,</span>
</span><span id="L-3500"><a href="#L-3500"><span class="linenos">3500</span></a>            <span class="n">img_high</span><span class="o">=</span><span class="n">img_high</span><span class="p">,</span>
</span><span id="L-3501"><a href="#L-3501"><span class="linenos">3501</span></a>            <span class="n">label_size</span><span class="o">=</span><span class="n">label_size</span><span class="p">,</span>
</span><span id="L-3502"><a href="#L-3502"><span class="linenos">3502</span></a>            <span class="n">size_scale</span><span class="o">=</span><span class="n">size_scale</span><span class="p">,</span>
</span><span id="L-3503"><a href="#L-3503"><span class="linenos">3503</span></a>            <span class="n">y_lab</span><span class="o">=</span><span class="n">y_lab</span><span class="p">,</span>
</span><span id="L-3504"><a href="#L-3504"><span class="linenos">3504</span></a>            <span class="n">legend_lab</span><span class="o">=</span><span class="n">legend_lab</span><span class="p">,</span>
</span><span id="L-3505"><a href="#L-3505"><span class="linenos">3505</span></a>            <span class="n">bbox_to_anchor_scale</span><span class="o">=</span><span class="n">bbox_to_anchor_scale</span><span class="p">,</span>
</span><span id="L-3506"><a href="#L-3506"><span class="linenos">3506</span></a>            <span class="n">bbox_to_anchor_perc</span><span class="o">=</span><span class="n">bbox_to_anchor_perc</span><span class="p">,</span>
</span><span id="L-3507"><a href="#L-3507"><span class="linenos">3507</span></a>        <span class="p">)</span>
</span><span id="L-3508"><a href="#L-3508"><span class="linenos">3508</span></a>
</span><span id="L-3509"><a href="#L-3509"><span class="linenos">3509</span></a>        <span class="k">return</span> <span class="n">scatter</span>
</span><span id="L-3510"><a href="#L-3510"><span class="linenos">3510</span></a>
</span><span id="L-3511"><a href="#L-3511"><span class="linenos">3511</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">subcluster_DEG_scatter</span><span class="p">(</span>
</span><span id="L-3512"><a href="#L-3512"><span class="linenos">3512</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-3513"><a href="#L-3513"><span class="linenos">3513</span></a>        <span class="n">top_n</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="L-3514"><a href="#L-3514"><span class="linenos">3514</span></a>        <span class="n">min_exp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-3515"><a href="#L-3515"><span class="linenos">3515</span></a>        <span class="n">min_pct</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
</span><span id="L-3516"><a href="#L-3516"><span class="linenos">3516</span></a>        <span class="n">p_val</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
</span><span id="L-3517"><a href="#L-3517"><span class="linenos">3517</span></a>        <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
</span><span id="L-3518"><a href="#L-3518"><span class="linenos">3518</span></a>        <span class="n">hclust</span><span class="o">=</span><span class="s2">&quot;complete&quot;</span><span class="p">,</span>
</span><span id="L-3519"><a href="#L-3519"><span class="linenos">3519</span></a>        <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-3520"><a href="#L-3520"><span class="linenos">3520</span></a>        <span class="n">img_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="L-3521"><a href="#L-3521"><span class="linenos">3521</span></a>        <span class="n">img_high</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="L-3522"><a href="#L-3522"><span class="linenos">3522</span></a>        <span class="n">label_size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="L-3523"><a href="#L-3523"><span class="linenos">3523</span></a>        <span class="n">size_scale</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span>
</span><span id="L-3524"><a href="#L-3524"><span class="linenos">3524</span></a>        <span class="n">y_lab</span><span class="o">=</span><span class="s2">&quot;Genes&quot;</span><span class="p">,</span>
</span><span id="L-3525"><a href="#L-3525"><span class="linenos">3525</span></a>        <span class="n">legend_lab</span><span class="o">=</span><span class="s2">&quot;normalized&quot;</span><span class="p">,</span>
</span><span id="L-3526"><a href="#L-3526"><span class="linenos">3526</span></a>        <span class="n">bbox_to_anchor_scale</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
</span><span id="L-3527"><a href="#L-3527"><span class="linenos">3527</span></a>        <span class="n">bbox_to_anchor_perc</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.91</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">),</span>
</span><span id="L-3528"><a href="#L-3528"><span class="linenos">3528</span></a>        <span class="n">n_proc</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="L-3529"><a href="#L-3529"><span class="linenos">3529</span></a>    <span class="p">):</span>
</span><span id="L-3530"><a href="#L-3530"><span class="linenos">3530</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3531"><a href="#L-3531"><span class="linenos">3531</span></a><span class="sd">        Plot top differential features (DEGs) for subclusters as a features-scatter.</span>
</span><span id="L-3532"><a href="#L-3532"><span class="linenos">3532</span></a>
</span><span id="L-3533"><a href="#L-3533"><span class="linenos">3533</span></a><span class="sd">        Parameters</span>
</span><span id="L-3534"><a href="#L-3534"><span class="linenos">3534</span></a><span class="sd">        ----------</span>
</span><span id="L-3535"><a href="#L-3535"><span class="linenos">3535</span></a><span class="sd">        top_n : int, default 3</span>
</span><span id="L-3536"><a href="#L-3536"><span class="linenos">3536</span></a><span class="sd">            Number of top features per subcluster to show.</span>
</span><span id="L-3537"><a href="#L-3537"><span class="linenos">3537</span></a>
</span><span id="L-3538"><a href="#L-3538"><span class="linenos">3538</span></a><span class="sd">        min_exp : float, default 0</span>
</span><span id="L-3539"><a href="#L-3539"><span class="linenos">3539</span></a><span class="sd">            Minimum expression threshold passed to `statistic`.</span>
</span><span id="L-3540"><a href="#L-3540"><span class="linenos">3540</span></a>
</span><span id="L-3541"><a href="#L-3541"><span class="linenos">3541</span></a><span class="sd">        min_pct : float, default 0.25</span>
</span><span id="L-3542"><a href="#L-3542"><span class="linenos">3542</span></a><span class="sd">            Minimum percent expressed in target group.</span>
</span><span id="L-3543"><a href="#L-3543"><span class="linenos">3543</span></a>
</span><span id="L-3544"><a href="#L-3544"><span class="linenos">3544</span></a><span class="sd">        p_val: float, default 0.05</span>
</span><span id="L-3545"><a href="#L-3545"><span class="linenos">3545</span></a><span class="sd">            Maximum p-value for visualizing features.</span>
</span><span id="L-3546"><a href="#L-3546"><span class="linenos">3546</span></a>
</span><span id="L-3547"><a href="#L-3547"><span class="linenos">3547</span></a><span class="sd">        n_proc : int, default 10</span>
</span><span id="L-3548"><a href="#L-3548"><span class="linenos">3548</span></a><span class="sd">            Parallel jobs used for DEG calculation.</span>
</span><span id="L-3549"><a href="#L-3549"><span class="linenos">3549</span></a>
</span><span id="L-3550"><a href="#L-3550"><span class="linenos">3550</span></a><span class="sd">        scale: bool, default False</span>
</span><span id="L-3551"><a href="#L-3551"><span class="linenos">3551</span></a><span class="sd">            If True, expression_data will be scaled (0–1) across the rows (features).</span>
</span><span id="L-3552"><a href="#L-3552"><span class="linenos">3552</span></a>
</span><span id="L-3553"><a href="#L-3553"><span class="linenos">3553</span></a><span class="sd">        colors : str, default=&#39;viridis&#39;</span>
</span><span id="L-3554"><a href="#L-3554"><span class="linenos">3554</span></a><span class="sd">            Colormap for expression values.</span>
</span><span id="L-3555"><a href="#L-3555"><span class="linenos">3555</span></a>
</span><span id="L-3556"><a href="#L-3556"><span class="linenos">3556</span></a><span class="sd">        hclust : str or None, default=&#39;complete&#39;</span>
</span><span id="L-3557"><a href="#L-3557"><span class="linenos">3557</span></a><span class="sd">            Linkage method for hierarchical clustering. If None, no clustering</span>
</span><span id="L-3558"><a href="#L-3558"><span class="linenos">3558</span></a><span class="sd">            is performed.</span>
</span><span id="L-3559"><a href="#L-3559"><span class="linenos">3559</span></a>
</span><span id="L-3560"><a href="#L-3560"><span class="linenos">3560</span></a><span class="sd">        img_width : int or float, default=8</span>
</span><span id="L-3561"><a href="#L-3561"><span class="linenos">3561</span></a><span class="sd">            Width of the plot in inches.</span>
</span><span id="L-3562"><a href="#L-3562"><span class="linenos">3562</span></a>
</span><span id="L-3563"><a href="#L-3563"><span class="linenos">3563</span></a><span class="sd">        img_high : int or float, default=5</span>
</span><span id="L-3564"><a href="#L-3564"><span class="linenos">3564</span></a><span class="sd">            Height of the plot in inches.</span>
</span><span id="L-3565"><a href="#L-3565"><span class="linenos">3565</span></a>
</span><span id="L-3566"><a href="#L-3566"><span class="linenos">3566</span></a><span class="sd">        label_size : int, default=10</span>
</span><span id="L-3567"><a href="#L-3567"><span class="linenos">3567</span></a><span class="sd">            Font size for axis labels and ticks.</span>
</span><span id="L-3568"><a href="#L-3568"><span class="linenos">3568</span></a>
</span><span id="L-3569"><a href="#L-3569"><span class="linenos">3569</span></a><span class="sd">        size_scale : int or float, default=100</span>
</span><span id="L-3570"><a href="#L-3570"><span class="linenos">3570</span></a><span class="sd">            Scaling factor for bubble sizes.</span>
</span><span id="L-3571"><a href="#L-3571"><span class="linenos">3571</span></a>
</span><span id="L-3572"><a href="#L-3572"><span class="linenos">3572</span></a><span class="sd">        y_lab : str, default=&#39;Genes&#39;</span>
</span><span id="L-3573"><a href="#L-3573"><span class="linenos">3573</span></a><span class="sd">            Label for the x-axis.</span>
</span><span id="L-3574"><a href="#L-3574"><span class="linenos">3574</span></a>
</span><span id="L-3575"><a href="#L-3575"><span class="linenos">3575</span></a><span class="sd">        legend_lab : str, default=&#39;normalized&#39;</span>
</span><span id="L-3576"><a href="#L-3576"><span class="linenos">3576</span></a><span class="sd">            Label for the colorbar legend.</span>
</span><span id="L-3577"><a href="#L-3577"><span class="linenos">3577</span></a>
</span><span id="L-3578"><a href="#L-3578"><span class="linenos">3578</span></a><span class="sd">        bbox_to_anchor_scale : int, default=25</span>
</span><span id="L-3579"><a href="#L-3579"><span class="linenos">3579</span></a><span class="sd">            Vertical scale (percentage) for positioning the colorbar.</span>
</span><span id="L-3580"><a href="#L-3580"><span class="linenos">3580</span></a>
</span><span id="L-3581"><a href="#L-3581"><span class="linenos">3581</span></a><span class="sd">        bbox_to_anchor_perc : tuple, default=(0.91, 0.63)</span>
</span><span id="L-3582"><a href="#L-3582"><span class="linenos">3582</span></a><span class="sd">            Anchor position for the size legend (percent bubble legend).</span>
</span><span id="L-3583"><a href="#L-3583"><span class="linenos">3583</span></a>
</span><span id="L-3584"><a href="#L-3584"><span class="linenos">3584</span></a><span class="sd">        Returns</span>
</span><span id="L-3585"><a href="#L-3585"><span class="linenos">3585</span></a><span class="sd">        -------</span>
</span><span id="L-3586"><a href="#L-3586"><span class="linenos">3586</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="L-3587"><a href="#L-3587"><span class="linenos">3587</span></a>
</span><span id="L-3588"><a href="#L-3588"><span class="linenos">3588</span></a><span class="sd">        Raises</span>
</span><span id="L-3589"><a href="#L-3589"><span class="linenos">3589</span></a><span class="sd">        ------</span>
</span><span id="L-3590"><a href="#L-3590"><span class="linenos">3590</span></a><span class="sd">        RuntimeError</span>
</span><span id="L-3591"><a href="#L-3591"><span class="linenos">3591</span></a><span class="sd">            If subcluster preparation/definition has not been run.</span>
</span><span id="L-3592"><a href="#L-3592"><span class="linenos">3592</span></a>
</span><span id="L-3593"><a href="#L-3593"><span class="linenos">3593</span></a><span class="sd">        Notes</span>
</span><span id="L-3594"><a href="#L-3594"><span class="linenos">3594</span></a><span class="sd">        -----</span>
</span><span id="L-3595"><a href="#L-3595"><span class="linenos">3595</span></a><span class="sd">        Internally calls `calc_DEG` (or equivalent) to obtain statistics, filters</span>
</span><span id="L-3596"><a href="#L-3596"><span class="linenos">3596</span></a><span class="sd">        by p-value and effect-size, selects top features per valid group and plots them.</span>
</span><span id="L-3597"><a href="#L-3597"><span class="linenos">3597</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-3598"><a href="#L-3598"><span class="linenos">3598</span></a>
</span><span id="L-3599"><a href="#L-3599"><span class="linenos">3599</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3600"><a href="#L-3600"><span class="linenos">3600</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="L-3601"><a href="#L-3601"><span class="linenos">3601</span></a>                <span class="s2">&quot;Nothing to return. &#39;self.subcluster_prepare&#39; -&gt; &#39;self.define_subclusters&#39; pip was not conducted!&quot;</span>
</span><span id="L-3602"><a href="#L-3602"><span class="linenos">3602</span></a>            <span class="p">)</span>
</span><span id="L-3603"><a href="#L-3603"><span class="linenos">3603</span></a>
</span><span id="L-3604"><a href="#L-3604"><span class="linenos">3604</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span>
</span><span id="L-3605"><a href="#L-3605"><span class="linenos">3605</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">])</span>
</span><span id="L-3606"><a href="#L-3606"><span class="linenos">3606</span></a>
</span><span id="L-3607"><a href="#L-3607"><span class="linenos">3607</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="n">reduce_data</span><span class="p">(</span>
</span><span id="L-3608"><a href="#L-3608"><span class="linenos">3608</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">current_cluster</span><span class="p">]</span>
</span><span id="L-3609"><a href="#L-3609"><span class="linenos">3609</span></a>        <span class="p">)</span>
</span><span id="L-3610"><a href="#L-3610"><span class="linenos">3610</span></a>
</span><span id="L-3611"><a href="#L-3611"><span class="linenos">3611</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span>
</span><span id="L-3612"><a href="#L-3612"><span class="linenos">3612</span></a>
</span><span id="L-3613"><a href="#L-3613"><span class="linenos">3613</span></a>        <span class="n">deg_stats</span> <span class="o">=</span> <span class="n">calc_DEG</span><span class="p">(</span>
</span><span id="L-3614"><a href="#L-3614"><span class="linenos">3614</span></a>            <span class="n">dat</span><span class="p">,</span>
</span><span id="L-3615"><a href="#L-3615"><span class="linenos">3615</span></a>            <span class="n">metadata_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-3616"><a href="#L-3616"><span class="linenos">3616</span></a>            <span class="n">entities</span><span class="o">=</span><span class="s2">&quot;All&quot;</span><span class="p">,</span>
</span><span id="L-3617"><a href="#L-3617"><span class="linenos">3617</span></a>            <span class="n">sets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-3618"><a href="#L-3618"><span class="linenos">3618</span></a>            <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span>
</span><span id="L-3619"><a href="#L-3619"><span class="linenos">3619</span></a>            <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span>
</span><span id="L-3620"><a href="#L-3620"><span class="linenos">3620</span></a>            <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span>
</span><span id="L-3621"><a href="#L-3621"><span class="linenos">3621</span></a>        <span class="p">)</span>
</span><span id="L-3622"><a href="#L-3622"><span class="linenos">3622</span></a>
</span><span id="L-3623"><a href="#L-3623"><span class="linenos">3623</span></a>        <span class="n">deg_stats</span> <span class="o">=</span> <span class="n">deg_stats</span><span class="p">[</span><span class="n">deg_stats</span><span class="p">[</span><span class="s2">&quot;p_val&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_val</span><span class="p">]</span>
</span><span id="L-3624"><a href="#L-3624"><span class="linenos">3624</span></a>        <span class="n">deg_stats</span> <span class="o">=</span> <span class="n">deg_stats</span><span class="p">[</span><span class="n">deg_stats</span><span class="p">[</span><span class="s2">&quot;log(FC)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-3625"><a href="#L-3625"><span class="linenos">3625</span></a>
</span><span id="L-3626"><a href="#L-3626"><span class="linenos">3626</span></a>        <span class="n">deg_stats</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-3627"><a href="#L-3627"><span class="linenos">3627</span></a>            <span class="n">deg_stats</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
</span><span id="L-3628"><a href="#L-3628"><span class="linenos">3628</span></a>                <span class="p">[</span><span class="s2">&quot;valid_group&quot;</span><span class="p">,</span> <span class="s2">&quot;esm&quot;</span><span class="p">,</span> <span class="s2">&quot;log(FC)&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
</span><span id="L-3629"><a href="#L-3629"><span class="linenos">3629</span></a>            <span class="p">)</span>
</span><span id="L-3630"><a href="#L-3630"><span class="linenos">3630</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;valid_group&quot;</span><span class="p">)</span>
</span><span id="L-3631"><a href="#L-3631"><span class="linenos">3631</span></a>            <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">top_n</span><span class="p">)</span>
</span><span id="L-3632"><a href="#L-3632"><span class="linenos">3632</span></a>        <span class="p">)</span>
</span><span id="L-3633"><a href="#L-3633"><span class="linenos">3633</span></a>
</span><span id="L-3634"><a href="#L-3634"><span class="linenos">3634</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="n">reduce_data</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">deg_stats</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">])))</span>
</span><span id="L-3635"><a href="#L-3635"><span class="linenos">3635</span></a>
</span><span id="L-3636"><a href="#L-3636"><span class="linenos">3636</span></a>        <span class="n">avg</span> <span class="o">=</span> <span class="n">average</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="L-3637"><a href="#L-3637"><span class="linenos">3637</span></a>        <span class="n">occ</span> <span class="o">=</span> <span class="n">occurrence</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="L-3638"><a href="#L-3638"><span class="linenos">3638</span></a>
</span><span id="L-3639"><a href="#L-3639"><span class="linenos">3639</span></a>        <span class="n">scatter</span> <span class="o">=</span> <span class="n">features_scatter</span><span class="p">(</span>
</span><span id="L-3640"><a href="#L-3640"><span class="linenos">3640</span></a>            <span class="n">expression_data</span><span class="o">=</span><span class="n">avg</span><span class="p">,</span>
</span><span id="L-3641"><a href="#L-3641"><span class="linenos">3641</span></a>            <span class="n">occurence_data</span><span class="o">=</span><span class="n">occ</span><span class="p">,</span>
</span><span id="L-3642"><a href="#L-3642"><span class="linenos">3642</span></a>            <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-3643"><a href="#L-3643"><span class="linenos">3643</span></a>            <span class="n">metadata_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-3644"><a href="#L-3644"><span class="linenos">3644</span></a>            <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
</span><span id="L-3645"><a href="#L-3645"><span class="linenos">3645</span></a>            <span class="n">hclust</span><span class="o">=</span><span class="n">hclust</span><span class="p">,</span>
</span><span id="L-3646"><a href="#L-3646"><span class="linenos">3646</span></a>            <span class="n">img_width</span><span class="o">=</span><span class="n">img_width</span><span class="p">,</span>
</span><span id="L-3647"><a href="#L-3647"><span class="linenos">3647</span></a>            <span class="n">img_high</span><span class="o">=</span><span class="n">img_high</span><span class="p">,</span>
</span><span id="L-3648"><a href="#L-3648"><span class="linenos">3648</span></a>            <span class="n">label_size</span><span class="o">=</span><span class="n">label_size</span><span class="p">,</span>
</span><span id="L-3649"><a href="#L-3649"><span class="linenos">3649</span></a>            <span class="n">size_scale</span><span class="o">=</span><span class="n">size_scale</span><span class="p">,</span>
</span><span id="L-3650"><a href="#L-3650"><span class="linenos">3650</span></a>            <span class="n">y_lab</span><span class="o">=</span><span class="n">y_lab</span><span class="p">,</span>
</span><span id="L-3651"><a href="#L-3651"><span class="linenos">3651</span></a>            <span class="n">legend_lab</span><span class="o">=</span><span class="n">legend_lab</span><span class="p">,</span>
</span><span id="L-3652"><a href="#L-3652"><span class="linenos">3652</span></a>            <span class="n">bbox_to_anchor_scale</span><span class="o">=</span><span class="n">bbox_to_anchor_scale</span><span class="p">,</span>
</span><span id="L-3653"><a href="#L-3653"><span class="linenos">3653</span></a>            <span class="n">bbox_to_anchor_perc</span><span class="o">=</span><span class="n">bbox_to_anchor_perc</span><span class="p">,</span>
</span><span id="L-3654"><a href="#L-3654"><span class="linenos">3654</span></a>        <span class="p">)</span>
</span><span id="L-3655"><a href="#L-3655"><span class="linenos">3655</span></a>
</span><span id="L-3656"><a href="#L-3656"><span class="linenos">3656</span></a>        <span class="k">return</span> <span class="n">scatter</span>
</span><span id="L-3657"><a href="#L-3657"><span class="linenos">3657</span></a>
</span><span id="L-3658"><a href="#L-3658"><span class="linenos">3658</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">accept_subclusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-3659"><a href="#L-3659"><span class="linenos">3659</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3660"><a href="#L-3660"><span class="linenos">3660</span></a><span class="sd">        Commit subcluster labels into the main `input_metadata` by renaming cell names.</span>
</span><span id="L-3661"><a href="#L-3661"><span class="linenos">3661</span></a>
</span><span id="L-3662"><a href="#L-3662"><span class="linenos">3662</span></a><span class="sd">        The method replaces occurrences of the parent cluster name in `self.input_metadata[&#39;cell_names&#39;]`</span>
</span><span id="L-3663"><a href="#L-3663"><span class="linenos">3663</span></a><span class="sd">        with the expanded names that include subcluster suffixes (via `add_subnames`),</span>
</span><span id="L-3664"><a href="#L-3664"><span class="linenos">3664</span></a><span class="sd">        then clears `self.subclusters_`.</span>
</span><span id="L-3665"><a href="#L-3665"><span class="linenos">3665</span></a>
</span><span id="L-3666"><a href="#L-3666"><span class="linenos">3666</span></a><span class="sd">        Update</span>
</span><span id="L-3667"><a href="#L-3667"><span class="linenos">3667</span></a><span class="sd">        ------</span>
</span><span id="L-3668"><a href="#L-3668"><span class="linenos">3668</span></a><span class="sd">        Modifies `self.input_metadata[&#39;cell_names&#39;]`.</span>
</span><span id="L-3669"><a href="#L-3669"><span class="linenos">3669</span></a>
</span><span id="L-3670"><a href="#L-3670"><span class="linenos">3670</span></a><span class="sd">        Resets `self.subclusters_` to None.</span>
</span><span id="L-3671"><a href="#L-3671"><span class="linenos">3671</span></a>
</span><span id="L-3672"><a href="#L-3672"><span class="linenos">3672</span></a><span class="sd">        Raises</span>
</span><span id="L-3673"><a href="#L-3673"><span class="linenos">3673</span></a><span class="sd">        ------</span>
</span><span id="L-3674"><a href="#L-3674"><span class="linenos">3674</span></a><span class="sd">        RuntimeError</span>
</span><span id="L-3675"><a href="#L-3675"><span class="linenos">3675</span></a><span class="sd">            If `self.subclusters_` is not defined or subclusters were not computed.</span>
</span><span id="L-3676"><a href="#L-3676"><span class="linenos">3676</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-3677"><a href="#L-3677"><span class="linenos">3677</span></a>
</span><span id="L-3678"><a href="#L-3678"><span class="linenos">3678</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3679"><a href="#L-3679"><span class="linenos">3679</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="L-3680"><a href="#L-3680"><span class="linenos">3680</span></a>                <span class="s2">&quot;Nothing to return. &#39;self.subcluster_prepare&#39; -&gt; &#39;self.define_subclusters&#39; pip was not conducted!&quot;</span>
</span><span id="L-3681"><a href="#L-3681"><span class="linenos">3681</span></a>            <span class="p">)</span>
</span><span id="L-3682"><a href="#L-3682"><span class="linenos">3682</span></a>
</span><span id="L-3683"><a href="#L-3683"><span class="linenos">3683</span></a>        <span class="n">new_meta</span> <span class="o">=</span> <span class="n">add_subnames</span><span class="p">(</span>
</span><span id="L-3684"><a href="#L-3684"><span class="linenos">3684</span></a>            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]),</span>
</span><span id="L-3685"><a href="#L-3685"><span class="linenos">3685</span></a>            <span class="n">parent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">current_cluster</span><span class="p">,</span>
</span><span id="L-3686"><a href="#L-3686"><span class="linenos">3686</span></a>            <span class="n">new_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span><span class="p">,</span>
</span><span id="L-3687"><a href="#L-3687"><span class="linenos">3687</span></a>        <span class="p">)</span>
</span><span id="L-3688"><a href="#L-3688"><span class="linenos">3688</span></a>
</span><span id="L-3689"><a href="#L-3689"><span class="linenos">3689</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_meta</span>
</span><span id="L-3690"><a href="#L-3690"><span class="linenos">3690</span></a>
</span><span id="L-3691"><a href="#L-3691"><span class="linenos">3691</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-3692"><a href="#L-3692"><span class="linenos">3692</span></a>
</span><span id="L-3693"><a href="#L-3693"><span class="linenos">3693</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">scatter_plot</span><span class="p">(</span>
</span><span id="L-3694"><a href="#L-3694"><span class="linenos">3694</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-3695"><a href="#L-3695"><span class="linenos">3695</span></a>        <span class="n">names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-3696"><a href="#L-3696"><span class="linenos">3696</span></a>        <span class="n">features</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-3697"><a href="#L-3697"><span class="linenos">3697</span></a>        <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="L-3698"><a href="#L-3698"><span class="linenos">3698</span></a>        <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-3699"><a href="#L-3699"><span class="linenos">3699</span></a>        <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
</span><span id="L-3700"><a href="#L-3700"><span class="linenos">3700</span></a>        <span class="n">hclust</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-3701"><a href="#L-3701"><span class="linenos">3701</span></a>        <span class="n">img_width</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="L-3702"><a href="#L-3702"><span class="linenos">3702</span></a>        <span class="n">img_high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-3703"><a href="#L-3703"><span class="linenos">3703</span></a>        <span class="n">label_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="L-3704"><a href="#L-3704"><span class="linenos">3704</span></a>        <span class="n">size_scale</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
</span><span id="L-3705"><a href="#L-3705"><span class="linenos">3705</span></a>        <span class="n">y_lab</span><span class="o">=</span><span class="s2">&quot;Genes&quot;</span><span class="p">,</span>
</span><span id="L-3706"><a href="#L-3706"><span class="linenos">3706</span></a>        <span class="n">legend_lab</span><span class="o">=</span><span class="s2">&quot;log(CPM + 1)&quot;</span><span class="p">,</span>
</span><span id="L-3707"><a href="#L-3707"><span class="linenos">3707</span></a>        <span class="n">set_box_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="L-3708"><a href="#L-3708"><span class="linenos">3708</span></a>        <span class="n">set_box_high</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="L-3709"><a href="#L-3709"><span class="linenos">3709</span></a>        <span class="n">bbox_to_anchor_scale</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
</span><span id="L-3710"><a href="#L-3710"><span class="linenos">3710</span></a>        <span class="n">bbox_to_anchor_perc</span><span class="o">=</span><span class="p">(</span><span class="mf">0.90</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.24</span><span class="p">),</span>
</span><span id="L-3711"><a href="#L-3711"><span class="linenos">3711</span></a>        <span class="n">bbox_to_anchor_group</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">),</span>
</span><span id="L-3712"><a href="#L-3712"><span class="linenos">3712</span></a>    <span class="p">):</span>
</span><span id="L-3713"><a href="#L-3713"><span class="linenos">3713</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3714"><a href="#L-3714"><span class="linenos">3714</span></a><span class="sd">        Create a bubble scatter plot of selected features across samples inside project.</span>
</span><span id="L-3715"><a href="#L-3715"><span class="linenos">3715</span></a>
</span><span id="L-3716"><a href="#L-3716"><span class="linenos">3716</span></a><span class="sd">        Each point represents a feature-sample pair, where the color encodes the</span>
</span><span id="L-3717"><a href="#L-3717"><span class="linenos">3717</span></a><span class="sd">        expression value and the size encodes occurrence or relative abundance.</span>
</span><span id="L-3718"><a href="#L-3718"><span class="linenos">3718</span></a><span class="sd">        Optionally, hierarchical clustering can be applied to order rows and columns.</span>
</span><span id="L-3719"><a href="#L-3719"><span class="linenos">3719</span></a>
</span><span id="L-3720"><a href="#L-3720"><span class="linenos">3720</span></a><span class="sd">        Parameters</span>
</span><span id="L-3721"><a href="#L-3721"><span class="linenos">3721</span></a><span class="sd">        ----------</span>
</span><span id="L-3722"><a href="#L-3722"><span class="linenos">3722</span></a><span class="sd">        names : list, str, or None</span>
</span><span id="L-3723"><a href="#L-3723"><span class="linenos">3723</span></a><span class="sd">            Names of samples to include. If None, all samples are considered.</span>
</span><span id="L-3724"><a href="#L-3724"><span class="linenos">3724</span></a>
</span><span id="L-3725"><a href="#L-3725"><span class="linenos">3725</span></a><span class="sd">        features : list, str, or None</span>
</span><span id="L-3726"><a href="#L-3726"><span class="linenos">3726</span></a><span class="sd">            Names of features to include. If None, all features are considered.</span>
</span><span id="L-3727"><a href="#L-3727"><span class="linenos">3727</span></a>
</span><span id="L-3728"><a href="#L-3728"><span class="linenos">3728</span></a><span class="sd">        name_slot : str</span>
</span><span id="L-3729"><a href="#L-3729"><span class="linenos">3729</span></a><span class="sd">            Column in metadata to use as sample names.</span>
</span><span id="L-3730"><a href="#L-3730"><span class="linenos">3730</span></a>
</span><span id="L-3731"><a href="#L-3731"><span class="linenos">3731</span></a><span class="sd">        scale: bool, default False</span>
</span><span id="L-3732"><a href="#L-3732"><span class="linenos">3732</span></a><span class="sd">            If True, expression_data will be scaled (0–1) across the rows (features).</span>
</span><span id="L-3733"><a href="#L-3733"><span class="linenos">3733</span></a>
</span><span id="L-3734"><a href="#L-3734"><span class="linenos">3734</span></a><span class="sd">        colors : str, default=&#39;viridis&#39;</span>
</span><span id="L-3735"><a href="#L-3735"><span class="linenos">3735</span></a><span class="sd">            Colormap for expression values.</span>
</span><span id="L-3736"><a href="#L-3736"><span class="linenos">3736</span></a>
</span><span id="L-3737"><a href="#L-3737"><span class="linenos">3737</span></a><span class="sd">        hclust : str or None, default=&#39;complete&#39;</span>
</span><span id="L-3738"><a href="#L-3738"><span class="linenos">3738</span></a><span class="sd">            Linkage method for hierarchical clustering. If None, no clustering</span>
</span><span id="L-3739"><a href="#L-3739"><span class="linenos">3739</span></a><span class="sd">            is performed.</span>
</span><span id="L-3740"><a href="#L-3740"><span class="linenos">3740</span></a>
</span><span id="L-3741"><a href="#L-3741"><span class="linenos">3741</span></a><span class="sd">        img_width : int or float, default=8</span>
</span><span id="L-3742"><a href="#L-3742"><span class="linenos">3742</span></a><span class="sd">            Width of the plot in inches.</span>
</span><span id="L-3743"><a href="#L-3743"><span class="linenos">3743</span></a>
</span><span id="L-3744"><a href="#L-3744"><span class="linenos">3744</span></a><span class="sd">        img_high : int or float, default=5</span>
</span><span id="L-3745"><a href="#L-3745"><span class="linenos">3745</span></a><span class="sd">            Height of the plot in inches.</span>
</span><span id="L-3746"><a href="#L-3746"><span class="linenos">3746</span></a>
</span><span id="L-3747"><a href="#L-3747"><span class="linenos">3747</span></a><span class="sd">        label_size : int, default=10</span>
</span><span id="L-3748"><a href="#L-3748"><span class="linenos">3748</span></a><span class="sd">            Font size for axis labels and ticks.</span>
</span><span id="L-3749"><a href="#L-3749"><span class="linenos">3749</span></a>
</span><span id="L-3750"><a href="#L-3750"><span class="linenos">3750</span></a><span class="sd">        size_scale : int or float, default=100</span>
</span><span id="L-3751"><a href="#L-3751"><span class="linenos">3751</span></a><span class="sd">            Scaling factor for bubble sizes.</span>
</span><span id="L-3752"><a href="#L-3752"><span class="linenos">3752</span></a>
</span><span id="L-3753"><a href="#L-3753"><span class="linenos">3753</span></a><span class="sd">        y_lab : str, default=&#39;Genes&#39;</span>
</span><span id="L-3754"><a href="#L-3754"><span class="linenos">3754</span></a><span class="sd">            Label for the x-axis.</span>
</span><span id="L-3755"><a href="#L-3755"><span class="linenos">3755</span></a>
</span><span id="L-3756"><a href="#L-3756"><span class="linenos">3756</span></a><span class="sd">        legend_lab : str, default=&#39;log(CPM + 1)&#39;</span>
</span><span id="L-3757"><a href="#L-3757"><span class="linenos">3757</span></a><span class="sd">            Label for the colorbar legend.</span>
</span><span id="L-3758"><a href="#L-3758"><span class="linenos">3758</span></a>
</span><span id="L-3759"><a href="#L-3759"><span class="linenos">3759</span></a><span class="sd">        bbox_to_anchor_scale : int, default=25</span>
</span><span id="L-3760"><a href="#L-3760"><span class="linenos">3760</span></a><span class="sd">            Vertical scale (percentage) for positioning the colorbar.</span>
</span><span id="L-3761"><a href="#L-3761"><span class="linenos">3761</span></a>
</span><span id="L-3762"><a href="#L-3762"><span class="linenos">3762</span></a><span class="sd">        bbox_to_anchor_perc : tuple, default=(0.91, 0.63)</span>
</span><span id="L-3763"><a href="#L-3763"><span class="linenos">3763</span></a><span class="sd">            Anchor position for the size legend (percent bubble legend).</span>
</span><span id="L-3764"><a href="#L-3764"><span class="linenos">3764</span></a>
</span><span id="L-3765"><a href="#L-3765"><span class="linenos">3765</span></a><span class="sd">        bbox_to_anchor_group : tuple, default=(1.01, 0.4)</span>
</span><span id="L-3766"><a href="#L-3766"><span class="linenos">3766</span></a><span class="sd">            Anchor position for the group legend.</span>
</span><span id="L-3767"><a href="#L-3767"><span class="linenos">3767</span></a>
</span><span id="L-3768"><a href="#L-3768"><span class="linenos">3768</span></a><span class="sd">        Returns</span>
</span><span id="L-3769"><a href="#L-3769"><span class="linenos">3769</span></a><span class="sd">        -------</span>
</span><span id="L-3770"><a href="#L-3770"><span class="linenos">3770</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="L-3771"><a href="#L-3771"><span class="linenos">3771</span></a><span class="sd">            The generated scatter plot figure.</span>
</span><span id="L-3772"><a href="#L-3772"><span class="linenos">3772</span></a>
</span><span id="L-3773"><a href="#L-3773"><span class="linenos">3773</span></a><span class="sd">        Notes</span>
</span><span id="L-3774"><a href="#L-3774"><span class="linenos">3774</span></a><span class="sd">        -----</span>
</span><span id="L-3775"><a href="#L-3775"><span class="linenos">3775</span></a><span class="sd">        Colors represent expression values normalized to the colormap.</span>
</span><span id="L-3776"><a href="#L-3776"><span class="linenos">3776</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-3777"><a href="#L-3777"><span class="linenos">3777</span></a>
</span><span id="L-3778"><a href="#L-3778"><span class="linenos">3778</span></a>        <span class="n">prtd</span><span class="p">,</span> <span class="n">met</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_partial_data</span><span class="p">(</span>
</span><span id="L-3779"><a href="#L-3779"><span class="linenos">3779</span></a>            <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">name_slot</span><span class="o">=</span><span class="n">name_slot</span><span class="p">,</span> <span class="n">inc_metadata</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-3780"><a href="#L-3780"><span class="linenos">3780</span></a>        <span class="p">)</span>
</span><span id="L-3781"><a href="#L-3781"><span class="linenos">3781</span></a>
</span><span id="L-3782"><a href="#L-3782"><span class="linenos">3782</span></a>        <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
</span><span id="L-3783"><a href="#L-3783"><span class="linenos">3783</span></a>
</span><span id="L-3784"><a href="#L-3784"><span class="linenos">3784</span></a>            <span class="n">legend_lab</span> <span class="o">=</span> <span class="s2">&quot;Scaled</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">legend_lab</span>
</span><span id="L-3785"><a href="#L-3785"><span class="linenos">3785</span></a>
</span><span id="L-3786"><a href="#L-3786"><span class="linenos">3786</span></a>            <span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-3787"><a href="#L-3787"><span class="linenos">3787</span></a>            <span class="n">prtd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="L-3788"><a href="#L-3788"><span class="linenos">3788</span></a>                <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">prtd</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
</span><span id="L-3789"><a href="#L-3789"><span class="linenos">3789</span></a>                <span class="n">index</span><span class="o">=</span><span class="n">prtd</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
</span><span id="L-3790"><a href="#L-3790"><span class="linenos">3790</span></a>                <span class="n">columns</span><span class="o">=</span><span class="n">prtd</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
</span><span id="L-3791"><a href="#L-3791"><span class="linenos">3791</span></a>            <span class="p">)</span>
</span><span id="L-3792"><a href="#L-3792"><span class="linenos">3792</span></a>
</span><span id="L-3793"><a href="#L-3793"><span class="linenos">3793</span></a>        <span class="n">prtd</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">prtd</span><span class="o">.</span><span class="n">columns</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">met</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-3794"><a href="#L-3794"><span class="linenos">3794</span></a>
</span><span id="L-3795"><a href="#L-3795"><span class="linenos">3795</span></a>        <span class="n">prtd_avg</span> <span class="o">=</span> <span class="n">average</span><span class="p">(</span><span class="n">prtd</span><span class="p">)</span>
</span><span id="L-3796"><a href="#L-3796"><span class="linenos">3796</span></a>
</span><span id="L-3797"><a href="#L-3797"><span class="linenos">3797</span></a>        <span class="n">meta_sets</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*#&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prtd_avg</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-3798"><a href="#L-3798"><span class="linenos">3798</span></a>
</span><span id="L-3799"><a href="#L-3799"><span class="linenos">3799</span></a>        <span class="n">prtd_avg</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;#.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prtd_avg</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-3800"><a href="#L-3800"><span class="linenos">3800</span></a>
</span><span id="L-3801"><a href="#L-3801"><span class="linenos">3801</span></a>        <span class="n">prtd_occ</span> <span class="o">=</span> <span class="n">occurrence</span><span class="p">(</span><span class="n">prtd</span><span class="p">)</span>
</span><span id="L-3802"><a href="#L-3802"><span class="linenos">3802</span></a>
</span><span id="L-3803"><a href="#L-3803"><span class="linenos">3803</span></a>        <span class="n">prtd_occ</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;#.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prtd_occ</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-3804"><a href="#L-3804"><span class="linenos">3804</span></a>
</span><span id="L-3805"><a href="#L-3805"><span class="linenos">3805</span></a>        <span class="n">fig_scatter</span> <span class="o">=</span> <span class="n">features_scatter</span><span class="p">(</span>
</span><span id="L-3806"><a href="#L-3806"><span class="linenos">3806</span></a>            <span class="n">expression_data</span><span class="o">=</span><span class="n">prtd_avg</span><span class="p">,</span>
</span><span id="L-3807"><a href="#L-3807"><span class="linenos">3807</span></a>            <span class="n">occurence_data</span><span class="o">=</span><span class="n">prtd_occ</span><span class="p">,</span>
</span><span id="L-3808"><a href="#L-3808"><span class="linenos">3808</span></a>            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
</span><span id="L-3809"><a href="#L-3809"><span class="linenos">3809</span></a>            <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-3810"><a href="#L-3810"><span class="linenos">3810</span></a>            <span class="n">metadata_list</span><span class="o">=</span><span class="n">meta_sets</span><span class="p">,</span>
</span><span id="L-3811"><a href="#L-3811"><span class="linenos">3811</span></a>            <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
</span><span id="L-3812"><a href="#L-3812"><span class="linenos">3812</span></a>            <span class="n">hclust</span><span class="o">=</span><span class="n">hclust</span><span class="p">,</span>
</span><span id="L-3813"><a href="#L-3813"><span class="linenos">3813</span></a>            <span class="n">img_width</span><span class="o">=</span><span class="n">img_width</span><span class="p">,</span>
</span><span id="L-3814"><a href="#L-3814"><span class="linenos">3814</span></a>            <span class="n">img_high</span><span class="o">=</span><span class="n">img_high</span><span class="p">,</span>
</span><span id="L-3815"><a href="#L-3815"><span class="linenos">3815</span></a>            <span class="n">label_size</span><span class="o">=</span><span class="n">label_size</span><span class="p">,</span>
</span><span id="L-3816"><a href="#L-3816"><span class="linenos">3816</span></a>            <span class="n">size_scale</span><span class="o">=</span><span class="n">size_scale</span><span class="p">,</span>
</span><span id="L-3817"><a href="#L-3817"><span class="linenos">3817</span></a>            <span class="n">y_lab</span><span class="o">=</span><span class="n">y_lab</span><span class="p">,</span>
</span><span id="L-3818"><a href="#L-3818"><span class="linenos">3818</span></a>            <span class="n">legend_lab</span><span class="o">=</span><span class="n">legend_lab</span><span class="p">,</span>
</span><span id="L-3819"><a href="#L-3819"><span class="linenos">3819</span></a>            <span class="n">set_box_size</span><span class="o">=</span><span class="n">set_box_size</span><span class="p">,</span>
</span><span id="L-3820"><a href="#L-3820"><span class="linenos">3820</span></a>            <span class="n">set_box_high</span><span class="o">=</span><span class="n">set_box_high</span><span class="p">,</span>
</span><span id="L-3821"><a href="#L-3821"><span class="linenos">3821</span></a>            <span class="n">bbox_to_anchor_scale</span><span class="o">=</span><span class="n">bbox_to_anchor_scale</span><span class="p">,</span>
</span><span id="L-3822"><a href="#L-3822"><span class="linenos">3822</span></a>            <span class="n">bbox_to_anchor_perc</span><span class="o">=</span><span class="n">bbox_to_anchor_perc</span><span class="p">,</span>
</span><span id="L-3823"><a href="#L-3823"><span class="linenos">3823</span></a>            <span class="n">bbox_to_anchor_group</span><span class="o">=</span><span class="n">bbox_to_anchor_group</span><span class="p">,</span>
</span><span id="L-3824"><a href="#L-3824"><span class="linenos">3824</span></a>        <span class="p">)</span>
</span><span id="L-3825"><a href="#L-3825"><span class="linenos">3825</span></a>
</span><span id="L-3826"><a href="#L-3826"><span class="linenos">3826</span></a>        <span class="k">return</span> <span class="n">fig_scatter</span>
</span><span id="L-3827"><a href="#L-3827"><span class="linenos">3827</span></a>
</span><span id="L-3828"><a href="#L-3828"><span class="linenos">3828</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">data_composition</span><span class="p">(</span>
</span><span id="L-3829"><a href="#L-3829"><span class="linenos">3829</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-3830"><a href="#L-3830"><span class="linenos">3830</span></a>        <span class="n">features_count</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-3831"><a href="#L-3831"><span class="linenos">3831</span></a>        <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="L-3832"><a href="#L-3832"><span class="linenos">3832</span></a>        <span class="n">set_sep</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-3833"><a href="#L-3833"><span class="linenos">3833</span></a>    <span class="p">):</span>
</span><span id="L-3834"><a href="#L-3834"><span class="linenos">3834</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3835"><a href="#L-3835"><span class="linenos">3835</span></a><span class="sd">        Compute composition of cell types in data set.</span>
</span><span id="L-3836"><a href="#L-3836"><span class="linenos">3836</span></a>
</span><span id="L-3837"><a href="#L-3837"><span class="linenos">3837</span></a><span class="sd">        This function counts the occurrences of specific cells (e.g., cell types, subtypes)</span>
</span><span id="L-3838"><a href="#L-3838"><span class="linenos">3838</span></a><span class="sd">        within metadata entries, calculates their relative percentages, and stores</span>
</span><span id="L-3839"><a href="#L-3839"><span class="linenos">3839</span></a><span class="sd">        the results in `self.composition_data`.</span>
</span><span id="L-3840"><a href="#L-3840"><span class="linenos">3840</span></a>
</span><span id="L-3841"><a href="#L-3841"><span class="linenos">3841</span></a><span class="sd">        Parameters</span>
</span><span id="L-3842"><a href="#L-3842"><span class="linenos">3842</span></a><span class="sd">        ----------</span>
</span><span id="L-3843"><a href="#L-3843"><span class="linenos">3843</span></a><span class="sd">        features_count : list or None</span>
</span><span id="L-3844"><a href="#L-3844"><span class="linenos">3844</span></a><span class="sd">            List of features (part or full names) to be counted.</span>
</span><span id="L-3845"><a href="#L-3845"><span class="linenos">3845</span></a><span class="sd">            If None, all unique elements from the specified `name_slot` metadata field are used.</span>
</span><span id="L-3846"><a href="#L-3846"><span class="linenos">3846</span></a>
</span><span id="L-3847"><a href="#L-3847"><span class="linenos">3847</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="L-3848"><a href="#L-3848"><span class="linenos">3848</span></a><span class="sd">            Metadata field containing sample identifiers or labels.</span>
</span><span id="L-3849"><a href="#L-3849"><span class="linenos">3849</span></a>
</span><span id="L-3850"><a href="#L-3850"><span class="linenos">3850</span></a><span class="sd">        set_sep : bool, default True</span>
</span><span id="L-3851"><a href="#L-3851"><span class="linenos">3851</span></a><span class="sd">            If True and multiple sets are present in metadata, compute composition</span>
</span><span id="L-3852"><a href="#L-3852"><span class="linenos">3852</span></a><span class="sd">            separately for each set.</span>
</span><span id="L-3853"><a href="#L-3853"><span class="linenos">3853</span></a>
</span><span id="L-3854"><a href="#L-3854"><span class="linenos">3854</span></a><span class="sd">        Update</span>
</span><span id="L-3855"><a href="#L-3855"><span class="linenos">3855</span></a><span class="sd">        -------</span>
</span><span id="L-3856"><a href="#L-3856"><span class="linenos">3856</span></a><span class="sd">        Stores results in `self.composition_data` as a pandas DataFrame with:</span>
</span><span id="L-3857"><a href="#L-3857"><span class="linenos">3857</span></a><span class="sd">        - &#39;name&#39;: feature name</span>
</span><span id="L-3858"><a href="#L-3858"><span class="linenos">3858</span></a><span class="sd">        - &#39;n&#39;: number of occurrences</span>
</span><span id="L-3859"><a href="#L-3859"><span class="linenos">3859</span></a><span class="sd">        - &#39;pct&#39;: percentage of occurrences</span>
</span><span id="L-3860"><a href="#L-3860"><span class="linenos">3860</span></a><span class="sd">        - &#39;set&#39; (if applicable): dataset identifier</span>
</span><span id="L-3861"><a href="#L-3861"><span class="linenos">3861</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-3862"><a href="#L-3862"><span class="linenos">3862</span></a>
</span><span id="L-3863"><a href="#L-3863"><span class="linenos">3863</span></a>        <span class="n">validated_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">])</span>
</span><span id="L-3864"><a href="#L-3864"><span class="linenos">3864</span></a>        <span class="n">sets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">])</span>
</span><span id="L-3865"><a href="#L-3865"><span class="linenos">3865</span></a>
</span><span id="L-3866"><a href="#L-3866"><span class="linenos">3866</span></a>        <span class="k">if</span> <span class="n">features_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3867"><a href="#L-3867"><span class="linenos">3867</span></a>            <span class="n">features_count</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]))</span>
</span><span id="L-3868"><a href="#L-3868"><span class="linenos">3868</span></a>
</span><span id="L-3869"><a href="#L-3869"><span class="linenos">3869</span></a>        <span class="k">if</span> <span class="n">set_sep</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sets</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-3870"><a href="#L-3870"><span class="linenos">3870</span></a>
</span><span id="L-3871"><a href="#L-3871"><span class="linenos">3871</span></a>            <span class="n">final_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span><span id="L-3872"><a href="#L-3872"><span class="linenos">3872</span></a>
</span><span id="L-3873"><a href="#L-3873"><span class="linenos">3873</span></a>            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">sets</span><span class="p">):</span>
</span><span id="L-3874"><a href="#L-3874"><span class="linenos">3874</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="L-3875"><a href="#L-3875"><span class="linenos">3875</span></a>
</span><span id="L-3876"><a href="#L-3876"><span class="linenos">3876</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span> <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">x</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">]</span>
</span><span id="L-3877"><a href="#L-3877"><span class="linenos">3877</span></a>
</span><span id="L-3878"><a href="#L-3878"><span class="linenos">3878</span></a>                <span class="n">tmp_val_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">validated_list</span><span class="p">)</span>
</span><span id="L-3879"><a href="#L-3879"><span class="linenos">3879</span></a>
</span><span id="L-3880"><a href="#L-3880"><span class="linenos">3880</span></a>                <span class="n">tmp_val_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmp_val_list</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
</span><span id="L-3881"><a href="#L-3881"><span class="linenos">3881</span></a>
</span><span id="L-3882"><a href="#L-3882"><span class="linenos">3882</span></a>                <span class="n">res_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;set&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="L-3883"><a href="#L-3883"><span class="linenos">3883</span></a>
</span><span id="L-3884"><a href="#L-3884"><span class="linenos">3884</span></a>                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">features_count</span><span class="p">):</span>
</span><span id="L-3885"><a href="#L-3885"><span class="linenos">3885</span></a>                    <span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-3886"><a href="#L-3886"><span class="linenos">3886</span></a>                        <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">tmp_val_list</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">element</span><span class="p">)</span>
</span><span id="L-3887"><a href="#L-3887"><span class="linenos">3887</span></a>                    <span class="p">)</span>
</span><span id="L-3888"><a href="#L-3888"><span class="linenos">3888</span></a>                    <span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-3889"><a href="#L-3889"><span class="linenos">3889</span></a>                    <span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="L-3890"><a href="#L-3890"><span class="linenos">3890</span></a>                    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res_dict</span><span class="p">)</span>
</span><span id="L-3891"><a href="#L-3891"><span class="linenos">3891</span></a>                    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="L-3892"><a href="#L-3892"><span class="linenos">3892</span></a>                    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-3893"><a href="#L-3893"><span class="linenos">3893</span></a>
</span><span id="L-3894"><a href="#L-3894"><span class="linenos">3894</span></a>                <span class="n">final_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">final_res</span><span class="p">,</span> <span class="n">res</span><span class="p">])</span>
</span><span id="L-3895"><a href="#L-3895"><span class="linenos">3895</span></a>
</span><span id="L-3896"><a href="#L-3896"><span class="linenos">3896</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">final_res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="s2">&quot;pct&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
</span><span id="L-3897"><a href="#L-3897"><span class="linenos">3897</span></a>
</span><span id="L-3898"><a href="#L-3898"><span class="linenos">3898</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-3899"><a href="#L-3899"><span class="linenos">3899</span></a>
</span><span id="L-3900"><a href="#L-3900"><span class="linenos">3900</span></a>            <span class="n">res_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="L-3901"><a href="#L-3901"><span class="linenos">3901</span></a>
</span><span id="L-3902"><a href="#L-3902"><span class="linenos">3902</span></a>            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">features_count</span><span class="p">):</span>
</span><span id="L-3903"><a href="#L-3903"><span class="linenos">3903</span></a>                <span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-3904"><a href="#L-3904"><span class="linenos">3904</span></a>                    <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">validated_list</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">element</span><span class="p">)</span>
</span><span id="L-3905"><a href="#L-3905"><span class="linenos">3905</span></a>                <span class="p">)</span>
</span><span id="L-3906"><a href="#L-3906"><span class="linenos">3906</span></a>                <span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-3907"><a href="#L-3907"><span class="linenos">3907</span></a>
</span><span id="L-3908"><a href="#L-3908"><span class="linenos">3908</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res_dict</span><span class="p">)</span>
</span><span id="L-3909"><a href="#L-3909"><span class="linenos">3909</span></a>            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="L-3910"><a href="#L-3910"><span class="linenos">3910</span></a>            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-3911"><a href="#L-3911"><span class="linenos">3911</span></a>
</span><span id="L-3912"><a href="#L-3912"><span class="linenos">3912</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;pct&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-3913"><a href="#L-3913"><span class="linenos">3913</span></a>
</span><span id="L-3914"><a href="#L-3914"><span class="linenos">3914</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">composition_data</span> <span class="o">=</span> <span class="n">res</span>
</span><span id="L-3915"><a href="#L-3915"><span class="linenos">3915</span></a>
</span><span id="L-3916"><a href="#L-3916"><span class="linenos">3916</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">composition_pie</span><span class="p">(</span>
</span><span id="L-3917"><a href="#L-3917"><span class="linenos">3917</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-3918"><a href="#L-3918"><span class="linenos">3918</span></a>        <span class="n">width</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="L-3919"><a href="#L-3919"><span class="linenos">3919</span></a>        <span class="n">height</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="L-3920"><a href="#L-3920"><span class="linenos">3920</span></a>        <span class="n">font_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="L-3921"><a href="#L-3921"><span class="linenos">3921</span></a>        <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tab20&quot;</span><span class="p">,</span>
</span><span id="L-3922"><a href="#L-3922"><span class="linenos">3922</span></a>        <span class="n">legend_split_col</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-3923"><a href="#L-3923"><span class="linenos">3923</span></a>        <span class="n">offset_labels</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="L-3924"><a href="#L-3924"><span class="linenos">3924</span></a>        <span class="n">legend_bbox</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.15</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
</span><span id="L-3925"><a href="#L-3925"><span class="linenos">3925</span></a>    <span class="p">):</span>
</span><span id="L-3926"><a href="#L-3926"><span class="linenos">3926</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3927"><a href="#L-3927"><span class="linenos">3927</span></a><span class="sd">        Visualize the composition of cell lineages using pie charts.</span>
</span><span id="L-3928"><a href="#L-3928"><span class="linenos">3928</span></a>
</span><span id="L-3929"><a href="#L-3929"><span class="linenos">3929</span></a><span class="sd">        Generates pie charts showing the relative proportions of features stored</span>
</span><span id="L-3930"><a href="#L-3930"><span class="linenos">3930</span></a><span class="sd">        in `self.composition_data`. If multiple sets are present, a separate</span>
</span><span id="L-3931"><a href="#L-3931"><span class="linenos">3931</span></a><span class="sd">        chart is drawn for each set.</span>
</span><span id="L-3932"><a href="#L-3932"><span class="linenos">3932</span></a>
</span><span id="L-3933"><a href="#L-3933"><span class="linenos">3933</span></a><span class="sd">        Parameters</span>
</span><span id="L-3934"><a href="#L-3934"><span class="linenos">3934</span></a><span class="sd">        ----------</span>
</span><span id="L-3935"><a href="#L-3935"><span class="linenos">3935</span></a><span class="sd">        width : int, default 6</span>
</span><span id="L-3936"><a href="#L-3936"><span class="linenos">3936</span></a><span class="sd">            Width of the figure.</span>
</span><span id="L-3937"><a href="#L-3937"><span class="linenos">3937</span></a>
</span><span id="L-3938"><a href="#L-3938"><span class="linenos">3938</span></a><span class="sd">        height : int, default 6</span>
</span><span id="L-3939"><a href="#L-3939"><span class="linenos">3939</span></a><span class="sd">            Height of the figure (applied per set if multiple sets are plotted).</span>
</span><span id="L-3940"><a href="#L-3940"><span class="linenos">3940</span></a>
</span><span id="L-3941"><a href="#L-3941"><span class="linenos">3941</span></a><span class="sd">        font_size : int, default 15</span>
</span><span id="L-3942"><a href="#L-3942"><span class="linenos">3942</span></a><span class="sd">            Font size for labels and annotations.</span>
</span><span id="L-3943"><a href="#L-3943"><span class="linenos">3943</span></a>
</span><span id="L-3944"><a href="#L-3944"><span class="linenos">3944</span></a><span class="sd">        cmap : str, default &#39;tab20&#39;</span>
</span><span id="L-3945"><a href="#L-3945"><span class="linenos">3945</span></a><span class="sd">            Colormap used for pie slices.</span>
</span><span id="L-3946"><a href="#L-3946"><span class="linenos">3946</span></a>
</span><span id="L-3947"><a href="#L-3947"><span class="linenos">3947</span></a><span class="sd">        legend_split_col : int, default 1</span>
</span><span id="L-3948"><a href="#L-3948"><span class="linenos">3948</span></a><span class="sd">            Number of columns in the legend.</span>
</span><span id="L-3949"><a href="#L-3949"><span class="linenos">3949</span></a>
</span><span id="L-3950"><a href="#L-3950"><span class="linenos">3950</span></a><span class="sd">        offset_labels : float or int, default 0.5</span>
</span><span id="L-3951"><a href="#L-3951"><span class="linenos">3951</span></a><span class="sd">            Spacing offset for label placement relative to pie slices.</span>
</span><span id="L-3952"><a href="#L-3952"><span class="linenos">3952</span></a>
</span><span id="L-3953"><a href="#L-3953"><span class="linenos">3953</span></a><span class="sd">        legend_bbox : tuple, default (1.15, 0.95)</span>
</span><span id="L-3954"><a href="#L-3954"><span class="linenos">3954</span></a><span class="sd">            Bounding box anchor position for the legend.</span>
</span><span id="L-3955"><a href="#L-3955"><span class="linenos">3955</span></a>
</span><span id="L-3956"><a href="#L-3956"><span class="linenos">3956</span></a><span class="sd">        Returns</span>
</span><span id="L-3957"><a href="#L-3957"><span class="linenos">3957</span></a><span class="sd">        -------</span>
</span><span id="L-3958"><a href="#L-3958"><span class="linenos">3958</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="L-3959"><a href="#L-3959"><span class="linenos">3959</span></a><span class="sd">            Pie chart visualization of composition data.</span>
</span><span id="L-3960"><a href="#L-3960"><span class="linenos">3960</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-3961"><a href="#L-3961"><span class="linenos">3961</span></a>
</span><span id="L-3962"><a href="#L-3962"><span class="linenos">3962</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_data</span>
</span><span id="L-3963"><a href="#L-3963"><span class="linenos">3963</span></a>
</span><span id="L-3964"><a href="#L-3964"><span class="linenos">3964</span></a>        <span class="k">if</span> <span class="s2">&quot;set&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-3965"><a href="#L-3965"><span class="linenos">3965</span></a>
</span><span id="L-3966"><a href="#L-3966"><span class="linenos">3966</span></a>            <span class="n">sets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]))</span>
</span><span id="L-3967"><a href="#L-3967"><span class="linenos">3967</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)))</span>
</span><span id="L-3968"><a href="#L-3968"><span class="linenos">3968</span></a>
</span><span id="L-3969"><a href="#L-3969"><span class="linenos">3969</span></a>            <span class="n">all_wedges</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3970"><a href="#L-3970"><span class="linenos">3970</span></a>            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="L-3971"><a href="#L-3971"><span class="linenos">3971</span></a>
</span><span id="L-3972"><a href="#L-3972"><span class="linenos">3972</span></a>            <span class="n">set_nam</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]))</span>
</span><span id="L-3973"><a href="#L-3973"><span class="linenos">3973</span></a>
</span><span id="L-3974"><a href="#L-3974"><span class="linenos">3974</span></a>            <span class="n">legend_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]))</span>
</span><span id="L-3975"><a href="#L-3975"><span class="linenos">3975</span></a>
</span><span id="L-3976"><a href="#L-3976"><span class="linenos">3976</span></a>            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">set_nam</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">set_nam</span><span class="p">)]</span>
</span><span id="L-3977"><a href="#L-3977"><span class="linenos">3977</span></a>
</span><span id="L-3978"><a href="#L-3978"><span class="linenos">3978</span></a>            <span class="n">cmap_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">legend_labels</span><span class="p">,</span> <span class="n">colors</span><span class="p">))</span>
</span><span id="L-3979"><a href="#L-3979"><span class="linenos">3979</span></a>
</span><span id="L-3980"><a href="#L-3980"><span class="linenos">3980</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sets</span><span class="p">):</span>
</span><span id="L-3981"><a href="#L-3981"><span class="linenos">3981</span></a>                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-3982"><a href="#L-3982"><span class="linenos">3982</span></a>                <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-3983"><a href="#L-3983"><span class="linenos">3983</span></a>
</span><span id="L-3984"><a href="#L-3984"><span class="linenos">3984</span></a>                <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tmp_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
</span><span id="L-3985"><a href="#L-3985"><span class="linenos">3985</span></a>
</span><span id="L-3986"><a href="#L-3986"><span class="linenos">3986</span></a>                <span class="n">wedges</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span>
</span><span id="L-3987"><a href="#L-3987"><span class="linenos">3987</span></a>                    <span class="n">tmp_df</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">],</span>
</span><span id="L-3988"><a href="#L-3988"><span class="linenos">3988</span></a>                    <span class="n">startangle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
</span><span id="L-3989"><a href="#L-3989"><span class="linenos">3989</span></a>                    <span class="n">labeldistance</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span>
</span><span id="L-3990"><a href="#L-3990"><span class="linenos">3990</span></a>                    <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="n">cmap_dict</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tmp_df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]],</span>
</span><span id="L-3991"><a href="#L-3991"><span class="linenos">3991</span></a>                    <span class="n">wedgeprops</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;edgecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">},</span>
</span><span id="L-3992"><a href="#L-3992"><span class="linenos">3992</span></a>                <span class="p">)</span>
</span><span id="L-3993"><a href="#L-3993"><span class="linenos">3993</span></a>
</span><span id="L-3994"><a href="#L-3994"><span class="linenos">3994</span></a>                <span class="n">all_wedges</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">wedges</span><span class="p">)</span>
</span><span id="L-3995"><a href="#L-3995"><span class="linenos">3995</span></a>
</span><span id="L-3996"><a href="#L-3996"><span class="linenos">3996</span></a>                <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
</span><span id="L-3997"><a href="#L-3997"><span class="linenos">3997</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3998"><a href="#L-3998"><span class="linenos">3998</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wedges</span><span class="p">):</span>
</span><span id="L-3999"><a href="#L-3999"><span class="linenos">3999</span></a>                    <span class="n">ang</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">theta2</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">theta1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">theta1</span>
</span><span id="L-4000"><a href="#L-4000"><span class="linenos">4000</span></a>                    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
</span><span id="L-4001"><a href="#L-4001"><span class="linenos">4001</span></a>                    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
</span><span id="L-4002"><a href="#L-4002"><span class="linenos">4002</span></a>                    <span class="n">horizontalalignment</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;left&quot;</span><span class="p">}[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>
</span><span id="L-4003"><a href="#L-4003"><span class="linenos">4003</span></a>                    <span class="n">connectionstyle</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;angle,angleA=0,angleB=</span><span class="si">{</span><span class="n">ang</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-4004"><a href="#L-4004"><span class="linenos">4004</span></a>                    <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;arrowprops&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;connectionstyle&quot;</span><span class="p">:</span> <span class="n">connectionstyle</span><span class="p">})</span>
</span><span id="L-4005"><a href="#L-4005"><span class="linenos">4005</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-4006"><a href="#L-4006"><span class="linenos">4006</span></a>                        <span class="n">n</span> <span class="o">+=</span> <span class="n">offset_labels</span>
</span><span id="L-4007"><a href="#L-4007"><span class="linenos">4007</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="L-4008"><a href="#L-4008"><span class="linenos">4008</span></a>                            <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-4009"><a href="#L-4009"><span class="linenos">4009</span></a>                            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
</span><span id="L-4010"><a href="#L-4010"><span class="linenos">4010</span></a>                            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">4</span><span class="p">),</span> <span class="mf">1.01</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">y</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)),</span>
</span><span id="L-4011"><a href="#L-4011"><span class="linenos">4011</span></a>                            <span class="n">horizontalalignment</span><span class="o">=</span><span class="n">horizontalalignment</span><span class="p">,</span>
</span><span id="L-4012"><a href="#L-4012"><span class="linenos">4012</span></a>                            <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
</span><span id="L-4013"><a href="#L-4013"><span class="linenos">4013</span></a>                            <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
</span><span id="L-4014"><a href="#L-4014"><span class="linenos">4014</span></a>                            <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
</span><span id="L-4015"><a href="#L-4015"><span class="linenos">4015</span></a>                        <span class="p">)</span>
</span><span id="L-4016"><a href="#L-4016"><span class="linenos">4016</span></a>
</span><span id="L-4017"><a href="#L-4017"><span class="linenos">4017</span></a>                <span class="n">circle2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
</span><span id="L-4018"><a href="#L-4018"><span class="linenos">4018</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle2</span><span class="p">)</span>
</span><span id="L-4019"><a href="#L-4019"><span class="linenos">4019</span></a>
</span><span id="L-4020"><a href="#L-4020"><span class="linenos">4020</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="L-4021"><a href="#L-4021"><span class="linenos">4021</span></a>                    <span class="mi">0</span><span class="p">,</span>
</span><span id="L-4022"><a href="#L-4022"><span class="linenos">4022</span></a>                    <span class="mi">0</span><span class="p">,</span>
</span><span id="L-4023"><a href="#L-4023"><span class="linenos">4023</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-4024"><a href="#L-4024"><span class="linenos">4024</span></a>                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="L-4025"><a href="#L-4025"><span class="linenos">4025</span></a>                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="L-4026"><a href="#L-4026"><span class="linenos">4026</span></a>                    <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
</span><span id="L-4027"><a href="#L-4027"><span class="linenos">4027</span></a>                    <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
</span><span id="L-4028"><a href="#L-4028"><span class="linenos">4028</span></a>                <span class="p">)</span>
</span><span id="L-4029"><a href="#L-4029"><span class="linenos">4029</span></a>
</span><span id="L-4030"><a href="#L-4030"><span class="linenos">4030</span></a>            <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-4031"><a href="#L-4031"><span class="linenos">4031</span></a>                <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">cmap_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
</span><span id="L-4032"><a href="#L-4032"><span class="linenos">4032</span></a>                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">legend_labels</span>
</span><span id="L-4033"><a href="#L-4033"><span class="linenos">4033</span></a>            <span class="p">]</span>
</span><span id="L-4034"><a href="#L-4034"><span class="linenos">4034</span></a>
</span><span id="L-4035"><a href="#L-4035"><span class="linenos">4035</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="L-4036"><a href="#L-4036"><span class="linenos">4036</span></a>                <span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span>
</span><span id="L-4037"><a href="#L-4037"><span class="linenos">4037</span></a>                <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center right&quot;</span><span class="p">,</span>
</span><span id="L-4038"><a href="#L-4038"><span class="linenos">4038</span></a>                <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">legend_bbox</span><span class="p">,</span>
</span><span id="L-4039"><a href="#L-4039"><span class="linenos">4039</span></a>                <span class="n">ncol</span><span class="o">=</span><span class="n">legend_split_col</span><span class="p">,</span>
</span><span id="L-4040"><a href="#L-4040"><span class="linenos">4040</span></a>                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-4041"><a href="#L-4041"><span class="linenos">4041</span></a>            <span class="p">)</span>
</span><span id="L-4042"><a href="#L-4042"><span class="linenos">4042</span></a>
</span><span id="L-4043"><a href="#L-4043"><span class="linenos">4043</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-4044"><a href="#L-4044"><span class="linenos">4044</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-4045"><a href="#L-4045"><span class="linenos">4045</span></a>
</span><span id="L-4046"><a href="#L-4046"><span class="linenos">4046</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-4047"><a href="#L-4047"><span class="linenos">4047</span></a>
</span><span id="L-4048"><a href="#L-4048"><span class="linenos">4048</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
</span><span id="L-4049"><a href="#L-4049"><span class="linenos">4049</span></a>
</span><span id="L-4050"><a href="#L-4050"><span class="linenos">4050</span></a>            <span class="n">legend_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
</span><span id="L-4051"><a href="#L-4051"><span class="linenos">4051</span></a>
</span><span id="L-4052"><a href="#L-4052"><span class="linenos">4052</span></a>            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="L-4053"><a href="#L-4053"><span class="linenos">4053</span></a>            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))]</span>
</span><span id="L-4054"><a href="#L-4054"><span class="linenos">4054</span></a>
</span><span id="L-4055"><a href="#L-4055"><span class="linenos">4055</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="L-4056"><a href="#L-4056"><span class="linenos">4056</span></a>                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
</span><span id="L-4057"><a href="#L-4057"><span class="linenos">4057</span></a>            <span class="p">)</span>
</span><span id="L-4058"><a href="#L-4058"><span class="linenos">4058</span></a>
</span><span id="L-4059"><a href="#L-4059"><span class="linenos">4059</span></a>            <span class="n">wedges</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span>
</span><span id="L-4060"><a href="#L-4060"><span class="linenos">4060</span></a>                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">],</span>
</span><span id="L-4061"><a href="#L-4061"><span class="linenos">4061</span></a>                <span class="n">startangle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
</span><span id="L-4062"><a href="#L-4062"><span class="linenos">4062</span></a>                <span class="n">labeldistance</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span>
</span><span id="L-4063"><a href="#L-4063"><span class="linenos">4063</span></a>                <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
</span><span id="L-4064"><a href="#L-4064"><span class="linenos">4064</span></a>                <span class="n">wedgeprops</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;edgecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">},</span>
</span><span id="L-4065"><a href="#L-4065"><span class="linenos">4065</span></a>            <span class="p">)</span>
</span><span id="L-4066"><a href="#L-4066"><span class="linenos">4066</span></a>
</span><span id="L-4067"><a href="#L-4067"><span class="linenos">4067</span></a>            <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
</span><span id="L-4068"><a href="#L-4068"><span class="linenos">4068</span></a>            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-4069"><a href="#L-4069"><span class="linenos">4069</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wedges</span><span class="p">):</span>
</span><span id="L-4070"><a href="#L-4070"><span class="linenos">4070</span></a>                <span class="n">ang</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">theta2</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">theta1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">theta1</span>
</span><span id="L-4071"><a href="#L-4071"><span class="linenos">4071</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
</span><span id="L-4072"><a href="#L-4072"><span class="linenos">4072</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
</span><span id="L-4073"><a href="#L-4073"><span class="linenos">4073</span></a>                <span class="n">horizontalalignment</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;left&quot;</span><span class="p">}[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>
</span><span id="L-4074"><a href="#L-4074"><span class="linenos">4074</span></a>                <span class="n">connectionstyle</span> <span class="o">=</span> <span class="s2">&quot;angle,angleA=0,angleB=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span>
</span><span id="L-4075"><a href="#L-4075"><span class="linenos">4075</span></a>                <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;arrowprops&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;connectionstyle&quot;</span><span class="p">:</span> <span class="n">connectionstyle</span><span class="p">})</span>
</span><span id="L-4076"><a href="#L-4076"><span class="linenos">4076</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-4077"><a href="#L-4077"><span class="linenos">4077</span></a>                    <span class="n">n</span> <span class="o">+=</span> <span class="n">offset_labels</span>
</span><span id="L-4078"><a href="#L-4078"><span class="linenos">4078</span></a>
</span><span id="L-4079"><a href="#L-4079"><span class="linenos">4079</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="L-4080"><a href="#L-4080"><span class="linenos">4080</span></a>                        <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-4081"><a href="#L-4081"><span class="linenos">4081</span></a>                        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
</span><span id="L-4082"><a href="#L-4082"><span class="linenos">4082</span></a>                        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">4</span><span class="p">),</span> <span class="n">y</span> <span class="o">*</span> <span class="mf">1.01</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">y</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)),</span>
</span><span id="L-4083"><a href="#L-4083"><span class="linenos">4083</span></a>                        <span class="n">horizontalalignment</span><span class="o">=</span><span class="n">horizontalalignment</span><span class="p">,</span>
</span><span id="L-4084"><a href="#L-4084"><span class="linenos">4084</span></a>                        <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
</span><span id="L-4085"><a href="#L-4085"><span class="linenos">4085</span></a>                        <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
</span><span id="L-4086"><a href="#L-4086"><span class="linenos">4086</span></a>                        <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
</span><span id="L-4087"><a href="#L-4087"><span class="linenos">4087</span></a>                    <span class="p">)</span>
</span><span id="L-4088"><a href="#L-4088"><span class="linenos">4088</span></a>
</span><span id="L-4089"><a href="#L-4089"><span class="linenos">4089</span></a>            <span class="n">circle2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
</span><span id="L-4090"><a href="#L-4090"><span class="linenos">4090</span></a>            <span class="n">circle2</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
</span><span id="L-4091"><a href="#L-4091"><span class="linenos">4091</span></a>
</span><span id="L-4092"><a href="#L-4092"><span class="linenos">4092</span></a>            <span class="n">p</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
</span><span id="L-4093"><a href="#L-4093"><span class="linenos">4093</span></a>            <span class="n">p</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle2</span><span class="p">)</span>
</span><span id="L-4094"><a href="#L-4094"><span class="linenos">4094</span></a>
</span><span id="L-4095"><a href="#L-4095"><span class="linenos">4095</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="L-4096"><a href="#L-4096"><span class="linenos">4096</span></a>                <span class="n">wedges</span><span class="p">,</span>
</span><span id="L-4097"><a href="#L-4097"><span class="linenos">4097</span></a>                <span class="n">legend_labels</span><span class="p">,</span>
</span><span id="L-4098"><a href="#L-4098"><span class="linenos">4098</span></a>                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-4099"><a href="#L-4099"><span class="linenos">4099</span></a>                <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span>
</span><span id="L-4100"><a href="#L-4100"><span class="linenos">4100</span></a>                <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">legend_bbox</span><span class="p">,</span>
</span><span id="L-4101"><a href="#L-4101"><span class="linenos">4101</span></a>                <span class="n">ncol</span><span class="o">=</span><span class="n">legend_split_col</span><span class="p">,</span>
</span><span id="L-4102"><a href="#L-4102"><span class="linenos">4102</span></a>            <span class="p">)</span>
</span><span id="L-4103"><a href="#L-4103"><span class="linenos">4103</span></a>
</span><span id="L-4104"><a href="#L-4104"><span class="linenos">4104</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-4105"><a href="#L-4105"><span class="linenos">4105</span></a>
</span><span id="L-4106"><a href="#L-4106"><span class="linenos">4106</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="L-4107"><a href="#L-4107"><span class="linenos">4107</span></a>
</span><span id="L-4108"><a href="#L-4108"><span class="linenos">4108</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bar_composition</span><span class="p">(</span>
</span><span id="L-4109"><a href="#L-4109"><span class="linenos">4109</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-4110"><a href="#L-4110"><span class="linenos">4110</span></a>        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;tab20b&quot;</span><span class="p">,</span>
</span><span id="L-4111"><a href="#L-4111"><span class="linenos">4111</span></a>        <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-4112"><a href="#L-4112"><span class="linenos">4112</span></a>        <span class="n">height</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="L-4113"><a href="#L-4113"><span class="linenos">4113</span></a>        <span class="n">font_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="L-4114"><a href="#L-4114"><span class="linenos">4114</span></a>        <span class="n">legend_split_col</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-4115"><a href="#L-4115"><span class="linenos">4115</span></a>        <span class="n">legend_bbox</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="L-4116"><a href="#L-4116"><span class="linenos">4116</span></a>    <span class="p">):</span>
</span><span id="L-4117"><a href="#L-4117"><span class="linenos">4117</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-4118"><a href="#L-4118"><span class="linenos">4118</span></a><span class="sd">        Visualize the composition of cell lineages using bar plots.</span>
</span><span id="L-4119"><a href="#L-4119"><span class="linenos">4119</span></a>
</span><span id="L-4120"><a href="#L-4120"><span class="linenos">4120</span></a><span class="sd">        Produces bar plots showing the distribution of features stored in</span>
</span><span id="L-4121"><a href="#L-4121"><span class="linenos">4121</span></a><span class="sd">        `self.composition_data`. If multiple sets are present, a separate</span>
</span><span id="L-4122"><a href="#L-4122"><span class="linenos">4122</span></a><span class="sd">        bar is drawn for each set. Percentages are annotated alongside the bars.</span>
</span><span id="L-4123"><a href="#L-4123"><span class="linenos">4123</span></a>
</span><span id="L-4124"><a href="#L-4124"><span class="linenos">4124</span></a><span class="sd">        Parameters</span>
</span><span id="L-4125"><a href="#L-4125"><span class="linenos">4125</span></a><span class="sd">        ----------</span>
</span><span id="L-4126"><a href="#L-4126"><span class="linenos">4126</span></a><span class="sd">        cmap : str, default &#39;tab20b&#39;</span>
</span><span id="L-4127"><a href="#L-4127"><span class="linenos">4127</span></a><span class="sd">            Colormap used for stacked bars.</span>
</span><span id="L-4128"><a href="#L-4128"><span class="linenos">4128</span></a>
</span><span id="L-4129"><a href="#L-4129"><span class="linenos">4129</span></a><span class="sd">        width : int, default 2</span>
</span><span id="L-4130"><a href="#L-4130"><span class="linenos">4130</span></a><span class="sd">            Width of each subplot (per set).</span>
</span><span id="L-4131"><a href="#L-4131"><span class="linenos">4131</span></a>
</span><span id="L-4132"><a href="#L-4132"><span class="linenos">4132</span></a><span class="sd">        height : int, default 6</span>
</span><span id="L-4133"><a href="#L-4133"><span class="linenos">4133</span></a><span class="sd">            Height of the figure.</span>
</span><span id="L-4134"><a href="#L-4134"><span class="linenos">4134</span></a>
</span><span id="L-4135"><a href="#L-4135"><span class="linenos">4135</span></a><span class="sd">        font_size : int, default 15</span>
</span><span id="L-4136"><a href="#L-4136"><span class="linenos">4136</span></a><span class="sd">            Font size for labels and annotations.</span>
</span><span id="L-4137"><a href="#L-4137"><span class="linenos">4137</span></a>
</span><span id="L-4138"><a href="#L-4138"><span class="linenos">4138</span></a><span class="sd">        legend_split_col : int, default 1</span>
</span><span id="L-4139"><a href="#L-4139"><span class="linenos">4139</span></a><span class="sd">            Number of columns in the legend.</span>
</span><span id="L-4140"><a href="#L-4140"><span class="linenos">4140</span></a>
</span><span id="L-4141"><a href="#L-4141"><span class="linenos">4141</span></a><span class="sd">        legend_bbox : tuple, default (1.3, 1)</span>
</span><span id="L-4142"><a href="#L-4142"><span class="linenos">4142</span></a><span class="sd">            Bounding box anchor position for the legend.</span>
</span><span id="L-4143"><a href="#L-4143"><span class="linenos">4143</span></a>
</span><span id="L-4144"><a href="#L-4144"><span class="linenos">4144</span></a><span class="sd">        Returns</span>
</span><span id="L-4145"><a href="#L-4145"><span class="linenos">4145</span></a><span class="sd">        -------</span>
</span><span id="L-4146"><a href="#L-4146"><span class="linenos">4146</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="L-4147"><a href="#L-4147"><span class="linenos">4147</span></a><span class="sd">            Stacked bar plot visualization of composition data.</span>
</span><span id="L-4148"><a href="#L-4148"><span class="linenos">4148</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-4149"><a href="#L-4149"><span class="linenos">4149</span></a>
</span><span id="L-4150"><a href="#L-4150"><span class="linenos">4150</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_data</span>
</span><span id="L-4151"><a href="#L-4151"><span class="linenos">4151</span></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-4152"><a href="#L-4152"><span class="linenos">4152</span></a>
</span><span id="L-4153"><a href="#L-4153"><span class="linenos">4153</span></a>        <span class="k">if</span> <span class="s2">&quot;set&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-4154"><a href="#L-4154"><span class="linenos">4154</span></a>
</span><span id="L-4155"><a href="#L-4155"><span class="linenos">4155</span></a>            <span class="n">sets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]))</span>
</span><span id="L-4156"><a href="#L-4156"><span class="linenos">4156</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">),</span> <span class="n">height</span><span class="p">))</span>
</span><span id="L-4157"><a href="#L-4157"><span class="linenos">4157</span></a>
</span><span id="L-4158"><a href="#L-4158"><span class="linenos">4158</span></a>            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="L-4159"><a href="#L-4159"><span class="linenos">4159</span></a>
</span><span id="L-4160"><a href="#L-4160"><span class="linenos">4160</span></a>            <span class="n">set_nam</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]))</span>
</span><span id="L-4161"><a href="#L-4161"><span class="linenos">4161</span></a>
</span><span id="L-4162"><a href="#L-4162"><span class="linenos">4162</span></a>            <span class="n">legend_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]))</span>
</span><span id="L-4163"><a href="#L-4163"><span class="linenos">4163</span></a>
</span><span id="L-4164"><a href="#L-4164"><span class="linenos">4164</span></a>            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">set_nam</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">set_nam</span><span class="p">)]</span>
</span><span id="L-4165"><a href="#L-4165"><span class="linenos">4165</span></a>
</span><span id="L-4166"><a href="#L-4166"><span class="linenos">4166</span></a>            <span class="n">cmap_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">legend_labels</span><span class="p">,</span> <span class="n">colors</span><span class="p">))</span>
</span><span id="L-4167"><a href="#L-4167"><span class="linenos">4167</span></a>
</span><span id="L-4168"><a href="#L-4168"><span class="linenos">4168</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sets</span><span class="p">):</span>
</span><span id="L-4169"><a href="#L-4169"><span class="linenos">4169</span></a>                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-4170"><a href="#L-4170"><span class="linenos">4170</span></a>
</span><span id="L-4171"><a href="#L-4171"><span class="linenos">4171</span></a>                <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-4172"><a href="#L-4172"><span class="linenos">4172</span></a>
</span><span id="L-4173"><a href="#L-4173"><span class="linenos">4173</span></a>                <span class="n">values</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-4174"><a href="#L-4174"><span class="linenos">4174</span></a>                <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</span><span id="L-4175"><a href="#L-4175"><span class="linenos">4175</span></a>                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
</span><span id="L-4176"><a href="#L-4176"><span class="linenos">4176</span></a>                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
</span><span id="L-4177"><a href="#L-4177"><span class="linenos">4177</span></a>
</span><span id="L-4178"><a href="#L-4178"><span class="linenos">4178</span></a>                <span class="n">idx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</span><span id="L-4179"><a href="#L-4179"><span class="linenos">4179</span></a>                <span class="n">correction</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</span><span id="L-4180"><a href="#L-4180"><span class="linenos">4180</span></a>                <span class="n">values</span><span class="p">[</span><span class="n">idx_max</span><span class="p">]</span> <span class="o">+=</span> <span class="n">correction</span>
</span><span id="L-4181"><a href="#L-4181"><span class="linenos">4181</span></a>
</span><span id="L-4182"><a href="#L-4182"><span class="linenos">4182</span></a>                <span class="n">names</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-4183"><a href="#L-4183"><span class="linenos">4183</span></a>                <span class="n">perc</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-4184"><a href="#L-4184"><span class="linenos">4184</span></a>                <span class="n">nums</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="p">[</span><span class="s2">&quot;num&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-4185"><a href="#L-4185"><span class="linenos">4185</span></a>
</span><span id="L-4186"><a href="#L-4186"><span class="linenos">4186</span></a>                <span class="n">bottom</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-4187"><a href="#L-4187"><span class="linenos">4187</span></a>                <span class="n">centers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-4188"><a href="#L-4188"><span class="linenos">4188</span></a>                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">nums</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
</span><span id="L-4189"><a href="#L-4189"><span class="linenos">4189</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">bottom</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap_dict</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-4190"><a href="#L-4190"><span class="linenos">4190</span></a>                    <span class="n">centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bottom</span> <span class="o">+</span> <span class="n">val</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-4191"><a href="#L-4191"><span class="linenos">4191</span></a>                    <span class="n">bottom</span> <span class="o">+=</span> <span class="n">val</span>
</span><span id="L-4192"><a href="#L-4192"><span class="linenos">4192</span></a>
</span><span id="L-4193"><a href="#L-4193"><span class="linenos">4193</span></a>                <span class="n">y_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">centers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">centers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">centers</span><span class="p">))</span>
</span><span id="L-4194"><a href="#L-4194"><span class="linenos">4194</span></a>                <span class="n">x_text</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.8</span>
</span><span id="L-4195"><a href="#L-4195"><span class="linenos">4195</span></a>
</span><span id="L-4196"><a href="#L-4196"><span class="linenos">4196</span></a>                <span class="k">for</span> <span class="n">y_label</span><span class="p">,</span> <span class="n">y_center</span><span class="p">,</span> <span class="n">pct</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
</span><span id="L-4197"><a href="#L-4197"><span class="linenos">4197</span></a>                    <span class="n">y_positions</span><span class="p">,</span> <span class="n">centers</span><span class="p">,</span> <span class="n">perc</span><span class="p">,</span> <span class="n">nums</span>
</span><span id="L-4198"><a href="#L-4198"><span class="linenos">4198</span></a>                <span class="p">):</span>
</span><span id="L-4199"><a href="#L-4199"><span class="linenos">4199</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="L-4200"><a href="#L-4200"><span class="linenos">4200</span></a>                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
</span><span id="L-4201"><a href="#L-4201"><span class="linenos">4201</span></a>                        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_center</span><span class="p">),</span>
</span><span id="L-4202"><a href="#L-4202"><span class="linenos">4202</span></a>                        <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
</span><span id="L-4203"><a href="#L-4203"><span class="linenos">4203</span></a>                        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">x_text</span><span class="p">,</span> <span class="n">y_label</span><span class="p">),</span>
</span><span id="L-4204"><a href="#L-4204"><span class="linenos">4204</span></a>                        <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
</span><span id="L-4205"><a href="#L-4205"><span class="linenos">4205</span></a>                        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
</span><span id="L-4206"><a href="#L-4206"><span class="linenos">4206</span></a>                        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="L-4207"><a href="#L-4207"><span class="linenos">4207</span></a>                        <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
</span><span id="L-4208"><a href="#L-4208"><span class="linenos">4208</span></a>                        <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="L-4209"><a href="#L-4209"><span class="linenos">4209</span></a>                            <span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span>
</span><span id="L-4210"><a href="#L-4210"><span class="linenos">4210</span></a>                            <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-4211"><a href="#L-4211"><span class="linenos">4211</span></a>                            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="L-4212"><a href="#L-4212"><span class="linenos">4212</span></a>                            <span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;angle3,angleA=0,angleB=90&quot;</span><span class="p">,</span>
</span><span id="L-4213"><a href="#L-4213"><span class="linenos">4213</span></a>                        <span class="p">),</span>
</span><span id="L-4214"><a href="#L-4214"><span class="linenos">4214</span></a>                    <span class="p">)</span>
</span><span id="L-4215"><a href="#L-4215"><span class="linenos">4215</span></a>
</span><span id="L-4216"><a href="#L-4216"><span class="linenos">4216</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="L-4217"><a href="#L-4217"><span class="linenos">4217</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
</span><span id="L-4218"><a href="#L-4218"><span class="linenos">4218</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="L-4219"><a href="#L-4219"><span class="linenos">4219</span></a>
</span><span id="L-4220"><a href="#L-4220"><span class="linenos">4220</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
</span><span id="L-4221"><a href="#L-4221"><span class="linenos">4221</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
</span><span id="L-4222"><a href="#L-4222"><span class="linenos">4222</span></a>                <span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="L-4223"><a href="#L-4223"><span class="linenos">4223</span></a>                    <span class="n">spine</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-4224"><a href="#L-4224"><span class="linenos">4224</span></a>
</span><span id="L-4225"><a href="#L-4225"><span class="linenos">4225</span></a>            <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-4226"><a href="#L-4226"><span class="linenos">4226</span></a>                <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">cmap_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
</span><span id="L-4227"><a href="#L-4227"><span class="linenos">4227</span></a>                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">legend_labels</span>
</span><span id="L-4228"><a href="#L-4228"><span class="linenos">4228</span></a>            <span class="p">]</span>
</span><span id="L-4229"><a href="#L-4229"><span class="linenos">4229</span></a>
</span><span id="L-4230"><a href="#L-4230"><span class="linenos">4230</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="L-4231"><a href="#L-4231"><span class="linenos">4231</span></a>                <span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span>
</span><span id="L-4232"><a href="#L-4232"><span class="linenos">4232</span></a>                <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center right&quot;</span><span class="p">,</span>
</span><span id="L-4233"><a href="#L-4233"><span class="linenos">4233</span></a>                <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">legend_bbox</span><span class="p">,</span>
</span><span id="L-4234"><a href="#L-4234"><span class="linenos">4234</span></a>                <span class="n">ncol</span><span class="o">=</span><span class="n">legend_split_col</span><span class="p">,</span>
</span><span id="L-4235"><a href="#L-4235"><span class="linenos">4235</span></a>                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-4236"><a href="#L-4236"><span class="linenos">4236</span></a>            <span class="p">)</span>
</span><span id="L-4237"><a href="#L-4237"><span class="linenos">4237</span></a>
</span><span id="L-4238"><a href="#L-4238"><span class="linenos">4238</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-4239"><a href="#L-4239"><span class="linenos">4239</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-4240"><a href="#L-4240"><span class="linenos">4240</span></a>
</span><span id="L-4241"><a href="#L-4241"><span class="linenos">4241</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-4242"><a href="#L-4242"><span class="linenos">4242</span></a>
</span><span id="L-4243"><a href="#L-4243"><span class="linenos">4243</span></a>            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="L-4244"><a href="#L-4244"><span class="linenos">4244</span></a>
</span><span id="L-4245"><a href="#L-4245"><span class="linenos">4245</span></a>            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))]</span>
</span><span id="L-4246"><a href="#L-4246"><span class="linenos">4246</span></a>
</span><span id="L-4247"><a href="#L-4247"><span class="linenos">4247</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="L-4248"><a href="#L-4248"><span class="linenos">4248</span></a>
</span><span id="L-4249"><a href="#L-4249"><span class="linenos">4249</span></a>            <span class="n">values</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-4250"><a href="#L-4250"><span class="linenos">4250</span></a>            <span class="n">names</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-4251"><a href="#L-4251"><span class="linenos">4251</span></a>            <span class="n">perc</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-4252"><a href="#L-4252"><span class="linenos">4252</span></a>            <span class="n">nums</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;num&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-4253"><a href="#L-4253"><span class="linenos">4253</span></a>
</span><span id="L-4254"><a href="#L-4254"><span class="linenos">4254</span></a>            <span class="n">bottom</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-4255"><a href="#L-4255"><span class="linenos">4255</span></a>            <span class="n">centers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-4256"><a href="#L-4256"><span class="linenos">4256</span></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">nums</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
</span><span id="L-4257"><a href="#L-4257"><span class="linenos">4257</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">bottom</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-4258"><a href="#L-4258"><span class="linenos">4258</span></a>                <span class="n">centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bottom</span> <span class="o">+</span> <span class="n">val</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-4259"><a href="#L-4259"><span class="linenos">4259</span></a>                <span class="n">bottom</span> <span class="o">+=</span> <span class="n">val</span>
</span><span id="L-4260"><a href="#L-4260"><span class="linenos">4260</span></a>
</span><span id="L-4261"><a href="#L-4261"><span class="linenos">4261</span></a>            <span class="n">y_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">centers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">centers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">centers</span><span class="p">))</span>
</span><span id="L-4262"><a href="#L-4262"><span class="linenos">4262</span></a>            <span class="n">x_text</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.8</span>
</span><span id="L-4263"><a href="#L-4263"><span class="linenos">4263</span></a>
</span><span id="L-4264"><a href="#L-4264"><span class="linenos">4264</span></a>            <span class="k">for</span> <span class="n">y_label</span><span class="p">,</span> <span class="n">y_center</span><span class="p">,</span> <span class="n">pct</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">y_positions</span><span class="p">,</span> <span class="n">centers</span><span class="p">,</span> <span class="n">perc</span><span class="p">,</span> <span class="n">nums</span><span class="p">):</span>
</span><span id="L-4265"><a href="#L-4265"><span class="linenos">4265</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="L-4266"><a href="#L-4266"><span class="linenos">4266</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="n">pct</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-4267"><a href="#L-4267"><span class="linenos">4267</span></a>                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_center</span><span class="p">),</span>
</span><span id="L-4268"><a href="#L-4268"><span class="linenos">4268</span></a>                    <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
</span><span id="L-4269"><a href="#L-4269"><span class="linenos">4269</span></a>                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">x_text</span><span class="p">,</span> <span class="n">y_label</span><span class="p">),</span>
</span><span id="L-4270"><a href="#L-4270"><span class="linenos">4270</span></a>                    <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
</span><span id="L-4271"><a href="#L-4271"><span class="linenos">4271</span></a>                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
</span><span id="L-4272"><a href="#L-4272"><span class="linenos">4272</span></a>                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="L-4273"><a href="#L-4273"><span class="linenos">4273</span></a>                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
</span><span id="L-4274"><a href="#L-4274"><span class="linenos">4274</span></a>                    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="L-4275"><a href="#L-4275"><span class="linenos">4275</span></a>                        <span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span>
</span><span id="L-4276"><a href="#L-4276"><span class="linenos">4276</span></a>                        <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-4277"><a href="#L-4277"><span class="linenos">4277</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="L-4278"><a href="#L-4278"><span class="linenos">4278</span></a>                        <span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;angle3,angleA=0,angleB=90&quot;</span><span class="p">,</span>
</span><span id="L-4279"><a href="#L-4279"><span class="linenos">4279</span></a>                    <span class="p">),</span>
</span><span id="L-4280"><a href="#L-4280"><span class="linenos">4280</span></a>                <span class="p">)</span>
</span><span id="L-4281"><a href="#L-4281"><span class="linenos">4281</span></a>
</span><span id="L-4282"><a href="#L-4282"><span class="linenos">4282</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
</span><span id="L-4283"><a href="#L-4283"><span class="linenos">4283</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
</span><span id="L-4284"><a href="#L-4284"><span class="linenos">4284</span></a>            <span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="L-4285"><a href="#L-4285"><span class="linenos">4285</span></a>                <span class="n">spine</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-4286"><a href="#L-4286"><span class="linenos">4286</span></a>
</span><span id="L-4287"><a href="#L-4287"><span class="linenos">4287</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="L-4288"><a href="#L-4288"><span class="linenos">4288</span></a>                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Legend&quot;</span><span class="p">,</span>
</span><span id="L-4289"><a href="#L-4289"><span class="linenos">4289</span></a>                <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">legend_bbox</span><span class="p">,</span>
</span><span id="L-4290"><a href="#L-4290"><span class="linenos">4290</span></a>                <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span>
</span><span id="L-4291"><a href="#L-4291"><span class="linenos">4291</span></a>                <span class="n">ncol</span><span class="o">=</span><span class="n">legend_split_col</span><span class="p">,</span>
</span><span id="L-4292"><a href="#L-4292"><span class="linenos">4292</span></a>            <span class="p">)</span>
</span><span id="L-4293"><a href="#L-4293"><span class="linenos">4293</span></a>
</span><span id="L-4294"><a href="#L-4294"><span class="linenos">4294</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-4295"><a href="#L-4295"><span class="linenos">4295</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-4296"><a href="#L-4296"><span class="linenos">4296</span></a>
</span><span id="L-4297"><a href="#L-4297"><span class="linenos">4297</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="L-4298"><a href="#L-4298"><span class="linenos">4298</span></a>
</span><span id="L-4299"><a href="#L-4299"><span class="linenos">4299</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cell_regression</span><span class="p">(</span>
</span><span id="L-4300"><a href="#L-4300"><span class="linenos">4300</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-4301"><a href="#L-4301"><span class="linenos">4301</span></a>        <span class="n">cell_x</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-4302"><a href="#L-4302"><span class="linenos">4302</span></a>        <span class="n">cell_y</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-4303"><a href="#L-4303"><span class="linenos">4303</span></a>        <span class="n">set_x</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-4304"><a href="#L-4304"><span class="linenos">4304</span></a>        <span class="n">set_y</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-4305"><a href="#L-4305"><span class="linenos">4305</span></a>        <span class="n">threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="L-4306"><a href="#L-4306"><span class="linenos">4306</span></a>        <span class="n">image_width</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="L-4307"><a href="#L-4307"><span class="linenos">4307</span></a>        <span class="n">image_high</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
</span><span id="L-4308"><a href="#L-4308"><span class="linenos">4308</span></a>        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="L-4309"><a href="#L-4309"><span class="linenos">4309</span></a>    <span class="p">):</span>
</span><span id="L-4310"><a href="#L-4310"><span class="linenos">4310</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-4311"><a href="#L-4311"><span class="linenos">4311</span></a><span class="sd">        Perform regression analysis between two selected cells and visualize the relationship.</span>
</span><span id="L-4312"><a href="#L-4312"><span class="linenos">4312</span></a>
</span><span id="L-4313"><a href="#L-4313"><span class="linenos">4313</span></a><span class="sd">        This function computes a linear regression between two specified cells from</span>
</span><span id="L-4314"><a href="#L-4314"><span class="linenos">4314</span></a><span class="sd">        aggregated normalized data, plots the regression line with scatter points,</span>
</span><span id="L-4315"><a href="#L-4315"><span class="linenos">4315</span></a><span class="sd">        annotates regression statistics, and highlights potential outliers.</span>
</span><span id="L-4316"><a href="#L-4316"><span class="linenos">4316</span></a>
</span><span id="L-4317"><a href="#L-4317"><span class="linenos">4317</span></a><span class="sd">        Parameters</span>
</span><span id="L-4318"><a href="#L-4318"><span class="linenos">4318</span></a><span class="sd">        ----------</span>
</span><span id="L-4319"><a href="#L-4319"><span class="linenos">4319</span></a><span class="sd">        cell_x : str</span>
</span><span id="L-4320"><a href="#L-4320"><span class="linenos">4320</span></a><span class="sd">            Name of the first cell (X-axis).</span>
</span><span id="L-4321"><a href="#L-4321"><span class="linenos">4321</span></a>
</span><span id="L-4322"><a href="#L-4322"><span class="linenos">4322</span></a><span class="sd">        cell_y : str</span>
</span><span id="L-4323"><a href="#L-4323"><span class="linenos">4323</span></a><span class="sd">            Name of the second cell (Y-axis).</span>
</span><span id="L-4324"><a href="#L-4324"><span class="linenos">4324</span></a>
</span><span id="L-4325"><a href="#L-4325"><span class="linenos">4325</span></a><span class="sd">        set_x : str or None</span>
</span><span id="L-4326"><a href="#L-4326"><span class="linenos">4326</span></a><span class="sd">            Dataset identifier corresponding to `cell_x`. If None, cell is selected only by name.</span>
</span><span id="L-4327"><a href="#L-4327"><span class="linenos">4327</span></a>
</span><span id="L-4328"><a href="#L-4328"><span class="linenos">4328</span></a><span class="sd">        set_y : str or None</span>
</span><span id="L-4329"><a href="#L-4329"><span class="linenos">4329</span></a><span class="sd">            Dataset identifier corresponding to `cell_y`. If None, cell is selected only by name.</span>
</span><span id="L-4330"><a href="#L-4330"><span class="linenos">4330</span></a>
</span><span id="L-4331"><a href="#L-4331"><span class="linenos">4331</span></a><span class="sd">        threshold : int or float, default 10</span>
</span><span id="L-4332"><a href="#L-4332"><span class="linenos">4332</span></a><span class="sd">            Threshold for detecting outliers. Points deviating from the mean or diagonal by more</span>
</span><span id="L-4333"><a href="#L-4333"><span class="linenos">4333</span></a><span class="sd">            than this value are annotated.</span>
</span><span id="L-4334"><a href="#L-4334"><span class="linenos">4334</span></a>
</span><span id="L-4335"><a href="#L-4335"><span class="linenos">4335</span></a><span class="sd">        image_width : int, default 12</span>
</span><span id="L-4336"><a href="#L-4336"><span class="linenos">4336</span></a><span class="sd">            Width of the regression plot (in inches).</span>
</span><span id="L-4337"><a href="#L-4337"><span class="linenos">4337</span></a>
</span><span id="L-4338"><a href="#L-4338"><span class="linenos">4338</span></a><span class="sd">        image_high : int, default 7</span>
</span><span id="L-4339"><a href="#L-4339"><span class="linenos">4339</span></a><span class="sd">            Height of the regression plot (in inches).</span>
</span><span id="L-4340"><a href="#L-4340"><span class="linenos">4340</span></a>
</span><span id="L-4341"><a href="#L-4341"><span class="linenos">4341</span></a><span class="sd">        color : str, default &#39;black&#39;</span>
</span><span id="L-4342"><a href="#L-4342"><span class="linenos">4342</span></a><span class="sd">            Color of the regression scatter points and line.</span>
</span><span id="L-4343"><a href="#L-4343"><span class="linenos">4343</span></a>
</span><span id="L-4344"><a href="#L-4344"><span class="linenos">4344</span></a><span class="sd">        Returns</span>
</span><span id="L-4345"><a href="#L-4345"><span class="linenos">4345</span></a><span class="sd">        -------</span>
</span><span id="L-4346"><a href="#L-4346"><span class="linenos">4346</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="L-4347"><a href="#L-4347"><span class="linenos">4347</span></a><span class="sd">            Regression plot figure with annotated regression line, R², p-value, and outliers.</span>
</span><span id="L-4348"><a href="#L-4348"><span class="linenos">4348</span></a>
</span><span id="L-4349"><a href="#L-4349"><span class="linenos">4349</span></a><span class="sd">        Raises</span>
</span><span id="L-4350"><a href="#L-4350"><span class="linenos">4350</span></a><span class="sd">        ------</span>
</span><span id="L-4351"><a href="#L-4351"><span class="linenos">4351</span></a><span class="sd">        ValueError</span>
</span><span id="L-4352"><a href="#L-4352"><span class="linenos">4352</span></a><span class="sd">            If `cell_x` or `cell_y` are not found in the dataset.</span>
</span><span id="L-4353"><a href="#L-4353"><span class="linenos">4353</span></a><span class="sd">            If multiple matches are found for a cell name and `set_x`/`set_y` are not specified.</span>
</span><span id="L-4354"><a href="#L-4354"><span class="linenos">4354</span></a>
</span><span id="L-4355"><a href="#L-4355"><span class="linenos">4355</span></a><span class="sd">        Notes</span>
</span><span id="L-4356"><a href="#L-4356"><span class="linenos">4356</span></a><span class="sd">        -----</span>
</span><span id="L-4357"><a href="#L-4357"><span class="linenos">4357</span></a><span class="sd">        - The function automatically calls `jseq_object.average()` if aggregated data is not available.</span>
</span><span id="L-4358"><a href="#L-4358"><span class="linenos">4358</span></a><span class="sd">        - Outliers are annotated with their corresponding index labels.</span>
</span><span id="L-4359"><a href="#L-4359"><span class="linenos">4359</span></a><span class="sd">        - Regression is computed using `scipy.stats.linregress`.</span>
</span><span id="L-4360"><a href="#L-4360"><span class="linenos">4360</span></a>
</span><span id="L-4361"><a href="#L-4361"><span class="linenos">4361</span></a><span class="sd">        Examples</span>
</span><span id="L-4362"><a href="#L-4362"><span class="linenos">4362</span></a><span class="sd">        --------</span>
</span><span id="L-4363"><a href="#L-4363"><span class="linenos">4363</span></a><span class="sd">        &gt;&gt;&gt; obj.cell_regression(cell_x=&quot;Purkinje&quot;, cell_y=&quot;Granule&quot;, set_x=&quot;Exp1&quot;, set_y=&quot;Exp2&quot;)</span>
</span><span id="L-4364"><a href="#L-4364"><span class="linenos">4364</span></a><span class="sd">        &gt;&gt;&gt; obj.cell_regression(cell_x=&quot;NeuronA&quot;, cell_y=&quot;NeuronB&quot;, threshold=5, color=&quot;blue&quot;)</span>
</span><span id="L-4365"><a href="#L-4365"><span class="linenos">4365</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-4366"><a href="#L-4366"><span class="linenos">4366</span></a>
</span><span id="L-4367"><a href="#L-4367"><span class="linenos">4367</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-4368"><a href="#L-4368"><span class="linenos">4368</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
</span><span id="L-4369"><a href="#L-4369"><span class="linenos">4369</span></a>
</span><span id="L-4370"><a href="#L-4370"><span class="linenos">4370</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span>
</span><span id="L-4371"><a href="#L-4371"><span class="linenos">4371</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span>
</span><span id="L-4372"><a href="#L-4372"><span class="linenos">4372</span></a>
</span><span id="L-4373"><a href="#L-4373"><span class="linenos">4373</span></a>        <span class="k">if</span> <span class="n">set_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">set_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-4374"><a href="#L-4374"><span class="linenos">4374</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-4375"><a href="#L-4375"><span class="linenos">4375</span></a>            <span class="n">cell_x</span> <span class="o">=</span> <span class="n">cell_x</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="n">set_x</span>
</span><span id="L-4376"><a href="#L-4376"><span class="linenos">4376</span></a>            <span class="n">cell_y</span> <span class="o">=</span> <span class="n">cell_y</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="n">set_y</span>
</span><span id="L-4377"><a href="#L-4377"><span class="linenos">4377</span></a>
</span><span id="L-4378"><a href="#L-4378"><span class="linenos">4378</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-4379"><a href="#L-4379"><span class="linenos">4379</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span>
</span><span id="L-4380"><a href="#L-4380"><span class="linenos">4380</span></a>
</span><span id="L-4381"><a href="#L-4381"><span class="linenos">4381</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_x</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-4382"><a href="#L-4382"><span class="linenos">4382</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;cell_x&#39; value not in cell names!&quot;</span><span class="p">)</span>
</span><span id="L-4383"><a href="#L-4383"><span class="linenos">4383</span></a>
</span><span id="L-4384"><a href="#L-4384"><span class="linenos">4384</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_y</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-4385"><a href="#L-4385"><span class="linenos">4385</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;cell_y&#39; value not in cell names!&quot;</span><span class="p">)</span>
</span><span id="L-4386"><a href="#L-4386"><span class="linenos">4386</span></a>
</span><span id="L-4387"><a href="#L-4387"><span class="linenos">4387</span></a>        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">cell_x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-4388"><a href="#L-4388"><span class="linenos">4388</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-4389"><a href="#L-4389"><span class="linenos">4389</span></a>                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">cell_x</span><span class="si">}</span><span class="s2">&#39; occurs more than once. If you want to select a specific cell, &quot;</span>
</span><span id="L-4390"><a href="#L-4390"><span class="linenos">4390</span></a>                <span class="sa">f</span><span class="s2">&quot;please also provide the corresponding &#39;set_x&#39; and &#39;set_y&#39; values.&quot;</span>
</span><span id="L-4391"><a href="#L-4391"><span class="linenos">4391</span></a>            <span class="p">)</span>
</span><span id="L-4392"><a href="#L-4392"><span class="linenos">4392</span></a>
</span><span id="L-4393"><a href="#L-4393"><span class="linenos">4393</span></a>        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">cell_y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-4394"><a href="#L-4394"><span class="linenos">4394</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-4395"><a href="#L-4395"><span class="linenos">4395</span></a>                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">cell_y</span><span class="si">}</span><span class="s2">&#39; occurs more than once. If you want to select a specific cell, &quot;</span>
</span><span id="L-4396"><a href="#L-4396"><span class="linenos">4396</span></a>                <span class="sa">f</span><span class="s2">&quot;please also provide the corresponding &#39;set_x&#39; and &#39;set_y&#39; values.&quot;</span>
</span><span id="L-4397"><a href="#L-4397"><span class="linenos">4397</span></a>            <span class="p">)</span>
</span><span id="L-4398"><a href="#L-4398"><span class="linenos">4398</span></a>
</span><span id="L-4399"><a href="#L-4399"><span class="linenos">4399</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">image_width</span><span class="p">,</span> <span class="n">image_high</span><span class="p">))</span>
</span><span id="L-4400"><a href="#L-4400"><span class="linenos">4400</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">cell_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">cell_y</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
</span><span id="L-4401"><a href="#L-4401"><span class="linenos">4401</span></a>
</span><span id="L-4402"><a href="#L-4402"><span class="linenos">4402</span></a>        <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span>
</span><span id="L-4403"><a href="#L-4403"><span class="linenos">4403</span></a>            <span class="n">data</span><span class="p">[</span><span class="n">cell_x</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">cell_y</span><span class="p">]</span>
</span><span id="L-4404"><a href="#L-4404"><span class="linenos">4404</span></a>        <span class="p">)</span>
</span><span id="L-4405"><a href="#L-4405"><span class="linenos">4405</span></a>        <span class="n">equation</span> <span class="o">=</span> <span class="s2">&quot;y = </span><span class="si">{:.2f}</span><span class="s2">x + </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">)</span>
</span><span id="L-4406"><a href="#L-4406"><span class="linenos">4406</span></a>
</span><span id="L-4407"><a href="#L-4407"><span class="linenos">4407</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="L-4408"><a href="#L-4408"><span class="linenos">4408</span></a>            <span class="s2">&quot;R-squared = </span><span class="si">{:.2f}</span><span class="se">\n</span><span class="s2">P-value = </span><span class="si">{:.2f}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-4409"><a href="#L-4409"><span class="linenos">4409</span></a>                <span class="n">r_value</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">equation</span>
</span><span id="L-4410"><a href="#L-4410"><span class="linenos">4410</span></a>            <span class="p">),</span>
</span><span id="L-4411"><a href="#L-4411"><span class="linenos">4411</span></a>            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.90</span><span class="p">),</span>
</span><span id="L-4412"><a href="#L-4412"><span class="linenos">4412</span></a>            <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
</span><span id="L-4413"><a href="#L-4413"><span class="linenos">4413</span></a>            <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="L-4414"><a href="#L-4414"><span class="linenos">4414</span></a>        <span class="p">)</span>
</span><span id="L-4415"><a href="#L-4415"><span class="linenos">4415</span></a>
</span><span id="L-4416"><a href="#L-4416"><span class="linenos">4416</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-4417"><a href="#L-4417"><span class="linenos">4417</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-4418"><a href="#L-4418"><span class="linenos">4418</span></a>
</span><span id="L-4419"><a href="#L-4419"><span class="linenos">4419</span></a>        <span class="n">diff</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-4420"><a href="#L-4420"><span class="linenos">4420</span></a>        <span class="n">x_mean</span><span class="p">,</span> <span class="n">y_mean</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">cell_x</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">data</span><span class="p">[</span><span class="n">cell_y</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="L-4421"><a href="#L-4421"><span class="linenos">4421</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">cell_x</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">cell_y</span><span class="p">])):</span>
</span><span id="L-4422"><a href="#L-4422"><span class="linenos">4422</span></a>            <span class="n">diff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">))</span>
</span><span id="L-4423"><a href="#L-4423"><span class="linenos">4423</span></a>            <span class="n">diff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">yi</span> <span class="o">-</span> <span class="n">y_mean</span><span class="p">))</span>
</span><span id="L-4424"><a href="#L-4424"><span class="linenos">4424</span></a>
</span><span id="L-4425"><a href="#L-4425"><span class="linenos">4425</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">annotate_outliers</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
</span><span id="L-4426"><a href="#L-4426"><span class="linenos">4426</span></a>            <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-4427"><a href="#L-4427"><span class="linenos">4427</span></a>            <span class="n">x_mean</span><span class="p">,</span> <span class="n">y_mean</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="L-4428"><a href="#L-4428"><span class="linenos">4428</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)):</span>
</span><span id="L-4429"><a href="#L-4429"><span class="linenos">4429</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="L-4430"><a href="#L-4430"><span class="linenos">4430</span></a>                    <span class="nb">abs</span><span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span>
</span><span id="L-4431"><a href="#L-4431"><span class="linenos">4431</span></a>                    <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">yi</span> <span class="o">-</span> <span class="n">y_mean</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span>
</span><span id="L-4432"><a href="#L-4432"><span class="linenos">4432</span></a>                    <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">yi</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span>
</span><span id="L-4433"><a href="#L-4433"><span class="linenos">4433</span></a>                <span class="p">):</span>
</span><span id="L-4434"><a href="#L-4434"><span class="linenos">4434</span></a>                    <span class="n">text</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-4435"><a href="#L-4435"><span class="linenos">4435</span></a>                    <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-4436"><a href="#L-4436"><span class="linenos">4436</span></a>
</span><span id="L-4437"><a href="#L-4437"><span class="linenos">4437</span></a>            <span class="k">return</span> <span class="n">texts</span>
</span><span id="L-4438"><a href="#L-4438"><span class="linenos">4438</span></a>
</span><span id="L-4439"><a href="#L-4439"><span class="linenos">4439</span></a>        <span class="n">texts</span> <span class="o">=</span> <span class="n">annotate_outliers</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">cell_x</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">cell_y</span><span class="p">],</span> <span class="n">threshold</span><span class="p">)</span>
</span><span id="L-4440"><a href="#L-4440"><span class="linenos">4440</span></a>
</span><span id="L-4441"><a href="#L-4441"><span class="linenos">4441</span></a>        <span class="n">adjust_text</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>
</span><span id="L-4442"><a href="#L-4442"><span class="linenos">4442</span></a>
</span><span id="L-4443"><a href="#L-4443"><span class="linenos">4443</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-4444"><a href="#L-4444"><span class="linenos">4444</span></a>
</span><span id="L-4445"><a href="#L-4445"><span class="linenos">4445</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span></pre></div>


            </section>
                <section id="Clustering">
                            <input id="Clustering-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Clustering</span>:

                <label class="view-source-button" for="Clustering-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Clustering"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Clustering-31"><a href="#Clustering-31"><span class="linenos">  31</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Clustering</span><span class="p">:</span>
</span><span id="Clustering-32"><a href="#Clustering-32"><span class="linenos">  32</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering-33"><a href="#Clustering-33"><span class="linenos">  33</span></a><span class="sd">    A class for performing dimensionality reduction, clustering, and visualization</span>
</span><span id="Clustering-34"><a href="#Clustering-34"><span class="linenos">  34</span></a><span class="sd">    on high-dimensional data (e.g., single-cell gene expression).</span>
</span><span id="Clustering-35"><a href="#Clustering-35"><span class="linenos">  35</span></a>
</span><span id="Clustering-36"><a href="#Clustering-36"><span class="linenos">  36</span></a><span class="sd">    The class provides methods for:</span>
</span><span id="Clustering-37"><a href="#Clustering-37"><span class="linenos">  37</span></a><span class="sd">    - Normalizing and extracting subsets of data</span>
</span><span id="Clustering-38"><a href="#Clustering-38"><span class="linenos">  38</span></a><span class="sd">    - Principal Component Analysis (PCA) and related clustering</span>
</span><span id="Clustering-39"><a href="#Clustering-39"><span class="linenos">  39</span></a><span class="sd">    - Uniform Manifold Approximation and Projection (UMAP) and clustering</span>
</span><span id="Clustering-40"><a href="#Clustering-40"><span class="linenos">  40</span></a><span class="sd">    - Visualization of PCA and UMAP embeddings</span>
</span><span id="Clustering-41"><a href="#Clustering-41"><span class="linenos">  41</span></a><span class="sd">    - Harmonization of batch effects</span>
</span><span id="Clustering-42"><a href="#Clustering-42"><span class="linenos">  42</span></a><span class="sd">    - Accessing processed data and cluster labels</span>
</span><span id="Clustering-43"><a href="#Clustering-43"><span class="linenos">  43</span></a>
</span><span id="Clustering-44"><a href="#Clustering-44"><span class="linenos">  44</span></a><span class="sd">    Methods</span>
</span><span id="Clustering-45"><a href="#Clustering-45"><span class="linenos">  45</span></a><span class="sd">    -------</span>
</span><span id="Clustering-46"><a href="#Clustering-46"><span class="linenos">  46</span></a><span class="sd">    add_data_frame(data, metadata)</span>
</span><span id="Clustering-47"><a href="#Clustering-47"><span class="linenos">  47</span></a><span class="sd">        Class method to create a Clustering instance from a DataFrame and metadata.</span>
</span><span id="Clustering-48"><a href="#Clustering-48"><span class="linenos">  48</span></a>
</span><span id="Clustering-49"><a href="#Clustering-49"><span class="linenos">  49</span></a><span class="sd">    harmonize_sets()</span>
</span><span id="Clustering-50"><a href="#Clustering-50"><span class="linenos">  50</span></a><span class="sd">        Perform batch effect harmonization on PCA data.</span>
</span><span id="Clustering-51"><a href="#Clustering-51"><span class="linenos">  51</span></a>
</span><span id="Clustering-52"><a href="#Clustering-52"><span class="linenos">  52</span></a><span class="sd">    perform_PCA(pc_num=100, width=8, height=6)</span>
</span><span id="Clustering-53"><a href="#Clustering-53"><span class="linenos">  53</span></a><span class="sd">        Perform PCA on the dataset and visualize the first two PCs.</span>
</span><span id="Clustering-54"><a href="#Clustering-54"><span class="linenos">  54</span></a>
</span><span id="Clustering-55"><a href="#Clustering-55"><span class="linenos">  55</span></a><span class="sd">    knee_plot_PCA(width=8, height=6)</span>
</span><span id="Clustering-56"><a href="#Clustering-56"><span class="linenos">  56</span></a><span class="sd">        Plot the cumulative variance explained by PCs to determine optimal dimensionality.</span>
</span><span id="Clustering-57"><a href="#Clustering-57"><span class="linenos">  57</span></a>
</span><span id="Clustering-58"><a href="#Clustering-58"><span class="linenos">  58</span></a><span class="sd">    find_clusters_PCA(pc_num=0, eps=0.5, min_samples=10, width=8, height=6, harmonized=False)</span>
</span><span id="Clustering-59"><a href="#Clustering-59"><span class="linenos">  59</span></a><span class="sd">        Apply DBSCAN clustering to PCA embeddings and visualize results.</span>
</span><span id="Clustering-60"><a href="#Clustering-60"><span class="linenos">  60</span></a>
</span><span id="Clustering-61"><a href="#Clustering-61"><span class="linenos">  61</span></a><span class="sd">    perform_UMAP(factorize=False, umap_num=100, pc_num=0, harmonized=False, ...)</span>
</span><span id="Clustering-62"><a href="#Clustering-62"><span class="linenos">  62</span></a><span class="sd">        Compute UMAP embeddings with optional parameter tuning.</span>
</span><span id="Clustering-63"><a href="#Clustering-63"><span class="linenos">  63</span></a>
</span><span id="Clustering-64"><a href="#Clustering-64"><span class="linenos">  64</span></a><span class="sd">    knee_plot_umap(eps=0.5, min_samples=10)</span>
</span><span id="Clustering-65"><a href="#Clustering-65"><span class="linenos">  65</span></a><span class="sd">        Determine optimal UMAP dimensionality using silhouette scores.</span>
</span><span id="Clustering-66"><a href="#Clustering-66"><span class="linenos">  66</span></a>
</span><span id="Clustering-67"><a href="#Clustering-67"><span class="linenos">  67</span></a><span class="sd">    find_clusters_UMAP(umap_n=5, eps=0.5, min_samples=10, width=8, height=6)</span>
</span><span id="Clustering-68"><a href="#Clustering-68"><span class="linenos">  68</span></a><span class="sd">        Apply DBSCAN clustering on UMAP embeddings and visualize clusters.</span>
</span><span id="Clustering-69"><a href="#Clustering-69"><span class="linenos">  69</span></a>
</span><span id="Clustering-70"><a href="#Clustering-70"><span class="linenos">  70</span></a><span class="sd">    UMAP_vis(names_slot=&#39;cell_names&#39;, set_sep=True, point_size=0.6, ...)</span>
</span><span id="Clustering-71"><a href="#Clustering-71"><span class="linenos">  71</span></a><span class="sd">        Visualize UMAP embeddings with labels and optional cluster numbering.</span>
</span><span id="Clustering-72"><a href="#Clustering-72"><span class="linenos">  72</span></a>
</span><span id="Clustering-73"><a href="#Clustering-73"><span class="linenos">  73</span></a><span class="sd">    UMAP_feature(feature_name, features_data=None, point_size=0.6, ...)</span>
</span><span id="Clustering-74"><a href="#Clustering-74"><span class="linenos">  74</span></a><span class="sd">        Plot a single feature over UMAP coordinates with customizable colormap.</span>
</span><span id="Clustering-75"><a href="#Clustering-75"><span class="linenos">  75</span></a>
</span><span id="Clustering-76"><a href="#Clustering-76"><span class="linenos">  76</span></a><span class="sd">    get_umap_data()</span>
</span><span id="Clustering-77"><a href="#Clustering-77"><span class="linenos">  77</span></a><span class="sd">        Return the UMAP embeddings along with cluster labels if available.</span>
</span><span id="Clustering-78"><a href="#Clustering-78"><span class="linenos">  78</span></a>
</span><span id="Clustering-79"><a href="#Clustering-79"><span class="linenos">  79</span></a><span class="sd">    get_pca_data()</span>
</span><span id="Clustering-80"><a href="#Clustering-80"><span class="linenos">  80</span></a><span class="sd">        Return the PCA results along with cluster labels if available.</span>
</span><span id="Clustering-81"><a href="#Clustering-81"><span class="linenos">  81</span></a>
</span><span id="Clustering-82"><a href="#Clustering-82"><span class="linenos">  82</span></a><span class="sd">    return_clusters(clusters=&#39;umap&#39;)</span>
</span><span id="Clustering-83"><a href="#Clustering-83"><span class="linenos">  83</span></a><span class="sd">        Return the cluster labels for UMAP or PCA embeddings.</span>
</span><span id="Clustering-84"><a href="#Clustering-84"><span class="linenos">  84</span></a>
</span><span id="Clustering-85"><a href="#Clustering-85"><span class="linenos">  85</span></a><span class="sd">    Raises</span>
</span><span id="Clustering-86"><a href="#Clustering-86"><span class="linenos">  86</span></a><span class="sd">    ------</span>
</span><span id="Clustering-87"><a href="#Clustering-87"><span class="linenos">  87</span></a><span class="sd">    ValueError</span>
</span><span id="Clustering-88"><a href="#Clustering-88"><span class="linenos">  88</span></a><span class="sd">        For invalid parameters, mismatched dimensions, or missing metadata.</span>
</span><span id="Clustering-89"><a href="#Clustering-89"><span class="linenos">  89</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Clustering-90"><a href="#Clustering-90"><span class="linenos">  90</span></a>
</span><span id="Clustering-91"><a href="#Clustering-91"><span class="linenos">  91</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
</span><span id="Clustering-92"><a href="#Clustering-92"><span class="linenos">  92</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering-93"><a href="#Clustering-93"><span class="linenos">  93</span></a><span class="sd">        Initialize the clustering class with data and optional metadata.</span>
</span><span id="Clustering-94"><a href="#Clustering-94"><span class="linenos">  94</span></a>
</span><span id="Clustering-95"><a href="#Clustering-95"><span class="linenos">  95</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering-96"><a href="#Clustering-96"><span class="linenos">  96</span></a><span class="sd">        ----------</span>
</span><span id="Clustering-97"><a href="#Clustering-97"><span class="linenos">  97</span></a><span class="sd">        data : pandas.DataFrame</span>
</span><span id="Clustering-98"><a href="#Clustering-98"><span class="linenos">  98</span></a><span class="sd">            Input data for clustering. Columns are considered as samples.</span>
</span><span id="Clustering-99"><a href="#Clustering-99"><span class="linenos">  99</span></a>
</span><span id="Clustering-100"><a href="#Clustering-100"><span class="linenos"> 100</span></a><span class="sd">        metadata : pandas.DataFrame, optional</span>
</span><span id="Clustering-101"><a href="#Clustering-101"><span class="linenos"> 101</span></a><span class="sd">            Metadata for the samples. If None, a default DataFrame with column</span>
</span><span id="Clustering-102"><a href="#Clustering-102"><span class="linenos"> 102</span></a><span class="sd">            names as &#39;cell_names&#39; is created.</span>
</span><span id="Clustering-103"><a href="#Clustering-103"><span class="linenos"> 103</span></a>
</span><span id="Clustering-104"><a href="#Clustering-104"><span class="linenos"> 104</span></a><span class="sd">        Attributes</span>
</span><span id="Clustering-105"><a href="#Clustering-105"><span class="linenos"> 105</span></a><span class="sd">        ----------</span>
</span><span id="Clustering-106"><a href="#Clustering-106"><span class="linenos"> 106</span></a><span class="sd">        -clustering_data : pandas.DataFrame</span>
</span><span id="Clustering-107"><a href="#Clustering-107"><span class="linenos"> 107</span></a><span class="sd">        -clustering_metadata : pandas.DataFrame</span>
</span><span id="Clustering-108"><a href="#Clustering-108"><span class="linenos"> 108</span></a><span class="sd">        -subclusters : None or dict</span>
</span><span id="Clustering-109"><a href="#Clustering-109"><span class="linenos"> 109</span></a><span class="sd">        -explained_var : None or numpy.ndarray</span>
</span><span id="Clustering-110"><a href="#Clustering-110"><span class="linenos"> 110</span></a><span class="sd">        -cumulative_var : None or numpy.ndarray</span>
</span><span id="Clustering-111"><a href="#Clustering-111"><span class="linenos"> 111</span></a><span class="sd">        -pca : None or pandas.DataFrame</span>
</span><span id="Clustering-112"><a href="#Clustering-112"><span class="linenos"> 112</span></a><span class="sd">        -harmonized_pca : None or pandas.DataFrame</span>
</span><span id="Clustering-113"><a href="#Clustering-113"><span class="linenos"> 113</span></a><span class="sd">        -umap : None or pandas.DataFrame</span>
</span><span id="Clustering-114"><a href="#Clustering-114"><span class="linenos"> 114</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering-115"><a href="#Clustering-115"><span class="linenos"> 115</span></a>
</span><span id="Clustering-116"><a href="#Clustering-116"><span class="linenos"> 116</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_data</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="Clustering-117"><a href="#Clustering-117"><span class="linenos"> 117</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The input data used for clustering.&quot;&quot;&quot;</span>
</span><span id="Clustering-118"><a href="#Clustering-118"><span class="linenos"> 118</span></a>
</span><span id="Clustering-119"><a href="#Clustering-119"><span class="linenos"> 119</span></a>        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Clustering-120"><a href="#Clustering-120"><span class="linenos"> 120</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;cell_names&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)})</span>
</span><span id="Clustering-121"><a href="#Clustering-121"><span class="linenos"> 121</span></a>
</span><span id="Clustering-122"><a href="#Clustering-122"><span class="linenos"> 122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span> <span class="o">=</span> <span class="n">metadata</span>
</span><span id="Clustering-123"><a href="#Clustering-123"><span class="linenos"> 123</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Metadata associated with the samples.&quot;&quot;&quot;</span>
</span><span id="Clustering-124"><a href="#Clustering-124"><span class="linenos"> 124</span></a>
</span><span id="Clustering-125"><a href="#Clustering-125"><span class="linenos"> 125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Clustering-126"><a href="#Clustering-126"><span class="linenos"> 126</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Placeholder for storing subcluster information.&quot;&quot;&quot;</span>
</span><span id="Clustering-127"><a href="#Clustering-127"><span class="linenos"> 127</span></a>
</span><span id="Clustering-128"><a href="#Clustering-128"><span class="linenos"> 128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">explained_var</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Clustering-129"><a href="#Clustering-129"><span class="linenos"> 129</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Explained variance from PCA, initialized as None.&quot;&quot;&quot;</span>
</span><span id="Clustering-130"><a href="#Clustering-130"><span class="linenos"> 130</span></a>
</span><span id="Clustering-131"><a href="#Clustering-131"><span class="linenos"> 131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_var</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Clustering-132"><a href="#Clustering-132"><span class="linenos"> 132</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Cumulative explained variance from PCA, initialized as None.&quot;&quot;&quot;</span>
</span><span id="Clustering-133"><a href="#Clustering-133"><span class="linenos"> 133</span></a>
</span><span id="Clustering-134"><a href="#Clustering-134"><span class="linenos"> 134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pca</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Clustering-135"><a href="#Clustering-135"><span class="linenos"> 135</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;PCA-transformed data, initialized as None.&quot;&quot;&quot;</span>
</span><span id="Clustering-136"><a href="#Clustering-136"><span class="linenos"> 136</span></a>
</span><span id="Clustering-137"><a href="#Clustering-137"><span class="linenos"> 137</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Clustering-138"><a href="#Clustering-138"><span class="linenos"> 138</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;PCA data after batch effect harmonization, initialized as None.&quot;&quot;&quot;</span>
</span><span id="Clustering-139"><a href="#Clustering-139"><span class="linenos"> 139</span></a>
</span><span id="Clustering-140"><a href="#Clustering-140"><span class="linenos"> 140</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">umap</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Clustering-141"><a href="#Clustering-141"><span class="linenos"> 141</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;UMAP embeddings, initialized as None.&quot;&quot;&quot;</span>
</span><span id="Clustering-142"><a href="#Clustering-142"><span class="linenos"> 142</span></a>
</span><span id="Clustering-143"><a href="#Clustering-143"><span class="linenos"> 143</span></a>    <span class="nd">@classmethod</span>
</span><span id="Clustering-144"><a href="#Clustering-144"><span class="linenos"> 144</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_data_frame</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Clustering-145"><a href="#Clustering-145"><span class="linenos"> 145</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering-146"><a href="#Clustering-146"><span class="linenos"> 146</span></a><span class="sd">        Create a Clustering instance from a DataFrame and optional metadata.</span>
</span><span id="Clustering-147"><a href="#Clustering-147"><span class="linenos"> 147</span></a>
</span><span id="Clustering-148"><a href="#Clustering-148"><span class="linenos"> 148</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering-149"><a href="#Clustering-149"><span class="linenos"> 149</span></a><span class="sd">        ----------</span>
</span><span id="Clustering-150"><a href="#Clustering-150"><span class="linenos"> 150</span></a><span class="sd">        data : pandas.DataFrame</span>
</span><span id="Clustering-151"><a href="#Clustering-151"><span class="linenos"> 151</span></a><span class="sd">            Input data with features as rows and samples/cells as columns.</span>
</span><span id="Clustering-152"><a href="#Clustering-152"><span class="linenos"> 152</span></a>
</span><span id="Clustering-153"><a href="#Clustering-153"><span class="linenos"> 153</span></a><span class="sd">        metadata : pandas.DataFrame or None</span>
</span><span id="Clustering-154"><a href="#Clustering-154"><span class="linenos"> 154</span></a><span class="sd">            Optional metadata for the samples.</span>
</span><span id="Clustering-155"><a href="#Clustering-155"><span class="linenos"> 155</span></a><span class="sd">            Each row corresponds to a sample/cell, and column names in this DataFrame</span>
</span><span id="Clustering-156"><a href="#Clustering-156"><span class="linenos"> 156</span></a><span class="sd">            should match the sample/cell names in `data`. Columns can contain additional</span>
</span><span id="Clustering-157"><a href="#Clustering-157"><span class="linenos"> 157</span></a><span class="sd">            information such as cell type, experimental condition, batch, sets, etc.</span>
</span><span id="Clustering-158"><a href="#Clustering-158"><span class="linenos"> 158</span></a>
</span><span id="Clustering-159"><a href="#Clustering-159"><span class="linenos"> 159</span></a><span class="sd">        Returns</span>
</span><span id="Clustering-160"><a href="#Clustering-160"><span class="linenos"> 160</span></a><span class="sd">        -------</span>
</span><span id="Clustering-161"><a href="#Clustering-161"><span class="linenos"> 161</span></a><span class="sd">        Clustering</span>
</span><span id="Clustering-162"><a href="#Clustering-162"><span class="linenos"> 162</span></a><span class="sd">            A new instance of the Clustering class.</span>
</span><span id="Clustering-163"><a href="#Clustering-163"><span class="linenos"> 163</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering-164"><a href="#Clustering-164"><span class="linenos"> 164</span></a>
</span><span id="Clustering-165"><a href="#Clustering-165"><span class="linenos"> 165</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
</span><span id="Clustering-166"><a href="#Clustering-166"><span class="linenos"> 166</span></a>
</span><span id="Clustering-167"><a href="#Clustering-167"><span class="linenos"> 167</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">harmonize_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sets&quot;</span><span class="p">):</span>
</span><span id="Clustering-168"><a href="#Clustering-168"><span class="linenos"> 168</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering-169"><a href="#Clustering-169"><span class="linenos"> 169</span></a><span class="sd">        Perform batch effect harmonization on PCA embeddings.</span>
</span><span id="Clustering-170"><a href="#Clustering-170"><span class="linenos"> 170</span></a>
</span><span id="Clustering-171"><a href="#Clustering-171"><span class="linenos"> 171</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering-172"><a href="#Clustering-172"><span class="linenos"> 172</span></a><span class="sd">        ----------</span>
</span><span id="Clustering-173"><a href="#Clustering-173"><span class="linenos"> 173</span></a><span class="sd">        batch_col : str, default &#39;sets&#39;</span>
</span><span id="Clustering-174"><a href="#Clustering-174"><span class="linenos"> 174</span></a><span class="sd">            Name of the column in `metadata` that contains batch information for the samples/cells.</span>
</span><span id="Clustering-175"><a href="#Clustering-175"><span class="linenos"> 175</span></a>
</span><span id="Clustering-176"><a href="#Clustering-176"><span class="linenos"> 176</span></a><span class="sd">        Returns</span>
</span><span id="Clustering-177"><a href="#Clustering-177"><span class="linenos"> 177</span></a><span class="sd">        -------</span>
</span><span id="Clustering-178"><a href="#Clustering-178"><span class="linenos"> 178</span></a><span class="sd">        None</span>
</span><span id="Clustering-179"><a href="#Clustering-179"><span class="linenos"> 179</span></a><span class="sd">            Updates the `harmonized_pca` attribute with harmonized data.</span>
</span><span id="Clustering-180"><a href="#Clustering-180"><span class="linenos"> 180</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering-181"><a href="#Clustering-181"><span class="linenos"> 181</span></a>
</span><span id="Clustering-182"><a href="#Clustering-182"><span class="linenos"> 182</span></a>        <span class="n">data_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="p">)</span>
</span><span id="Clustering-183"><a href="#Clustering-183"><span class="linenos"> 183</span></a>
</span><span id="Clustering-184"><a href="#Clustering-184"><span class="linenos"> 184</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span>
</span><span id="Clustering-185"><a href="#Clustering-185"><span class="linenos"> 185</span></a>
</span><span id="Clustering-186"><a href="#Clustering-186"><span class="linenos"> 186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="Clustering-187"><a href="#Clustering-187"><span class="linenos"> 187</span></a>            <span class="n">harmonize</span><span class="o">.</span><span class="n">run_harmony</span><span class="p">(</span><span class="n">data_mat</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">vars_use</span><span class="o">=</span><span class="n">batch_col</span><span class="p">)</span><span class="o">.</span><span class="n">Z_corr</span>
</span><span id="Clustering-188"><a href="#Clustering-188"><span class="linenos"> 188</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span id="Clustering-189"><a href="#Clustering-189"><span class="linenos"> 189</span></a>
</span><span id="Clustering-190"><a href="#Clustering-190"><span class="linenos"> 190</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="o">.</span><span class="n">columns</span>
</span><span id="Clustering-191"><a href="#Clustering-191"><span class="linenos"> 191</span></a>
</span><span id="Clustering-192"><a href="#Clustering-192"><span class="linenos"> 192</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">perform_PCA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pc_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
</span><span id="Clustering-193"><a href="#Clustering-193"><span class="linenos"> 193</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering-194"><a href="#Clustering-194"><span class="linenos"> 194</span></a><span class="sd">        Perform Principal Component Analysis (PCA) on the dataset.</span>
</span><span id="Clustering-195"><a href="#Clustering-195"><span class="linenos"> 195</span></a>
</span><span id="Clustering-196"><a href="#Clustering-196"><span class="linenos"> 196</span></a><span class="sd">        This method standardizes the data, applies PCA, stores results as attributes,</span>
</span><span id="Clustering-197"><a href="#Clustering-197"><span class="linenos"> 197</span></a><span class="sd">        and generates a scatter plot of the first two principal components.</span>
</span><span id="Clustering-198"><a href="#Clustering-198"><span class="linenos"> 198</span></a>
</span><span id="Clustering-199"><a href="#Clustering-199"><span class="linenos"> 199</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering-200"><a href="#Clustering-200"><span class="linenos"> 200</span></a><span class="sd">        ----------</span>
</span><span id="Clustering-201"><a href="#Clustering-201"><span class="linenos"> 201</span></a><span class="sd">        pc_num : int, default 100</span>
</span><span id="Clustering-202"><a href="#Clustering-202"><span class="linenos"> 202</span></a><span class="sd">            Number of principal components to compute.</span>
</span><span id="Clustering-203"><a href="#Clustering-203"><span class="linenos"> 203</span></a><span class="sd">            If 0, computes all available components.</span>
</span><span id="Clustering-204"><a href="#Clustering-204"><span class="linenos"> 204</span></a>
</span><span id="Clustering-205"><a href="#Clustering-205"><span class="linenos"> 205</span></a><span class="sd">        width : int or float, default 8</span>
</span><span id="Clustering-206"><a href="#Clustering-206"><span class="linenos"> 206</span></a><span class="sd">            Width of the PCA figure.</span>
</span><span id="Clustering-207"><a href="#Clustering-207"><span class="linenos"> 207</span></a>
</span><span id="Clustering-208"><a href="#Clustering-208"><span class="linenos"> 208</span></a><span class="sd">        height : int or float, default 6</span>
</span><span id="Clustering-209"><a href="#Clustering-209"><span class="linenos"> 209</span></a><span class="sd">            Height of the PCA figure.</span>
</span><span id="Clustering-210"><a href="#Clustering-210"><span class="linenos"> 210</span></a>
</span><span id="Clustering-211"><a href="#Clustering-211"><span class="linenos"> 211</span></a><span class="sd">        Returns</span>
</span><span id="Clustering-212"><a href="#Clustering-212"><span class="linenos"> 212</span></a><span class="sd">        -------</span>
</span><span id="Clustering-213"><a href="#Clustering-213"><span class="linenos"> 213</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="Clustering-214"><a href="#Clustering-214"><span class="linenos"> 214</span></a><span class="sd">            Scatter plot showing the first two principal components.</span>
</span><span id="Clustering-215"><a href="#Clustering-215"><span class="linenos"> 215</span></a>
</span><span id="Clustering-216"><a href="#Clustering-216"><span class="linenos"> 216</span></a><span class="sd">        Updates</span>
</span><span id="Clustering-217"><a href="#Clustering-217"><span class="linenos"> 217</span></a><span class="sd">        -------</span>
</span><span id="Clustering-218"><a href="#Clustering-218"><span class="linenos"> 218</span></a><span class="sd">        self.pca : pandas.DataFrame</span>
</span><span id="Clustering-219"><a href="#Clustering-219"><span class="linenos"> 219</span></a><span class="sd">            DataFrame with principal component scores for each sample.</span>
</span><span id="Clustering-220"><a href="#Clustering-220"><span class="linenos"> 220</span></a>
</span><span id="Clustering-221"><a href="#Clustering-221"><span class="linenos"> 221</span></a><span class="sd">        self.explained_var : numpy.ndarray</span>
</span><span id="Clustering-222"><a href="#Clustering-222"><span class="linenos"> 222</span></a><span class="sd">            Percentage of variance explained by each principal component.</span>
</span><span id="Clustering-223"><a href="#Clustering-223"><span class="linenos"> 223</span></a>
</span><span id="Clustering-224"><a href="#Clustering-224"><span class="linenos"> 224</span></a><span class="sd">        self.cumulative_var : numpy.ndarray</span>
</span><span id="Clustering-225"><a href="#Clustering-225"><span class="linenos"> 225</span></a><span class="sd">            Cumulative explained variance.</span>
</span><span id="Clustering-226"><a href="#Clustering-226"><span class="linenos"> 226</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering-227"><a href="#Clustering-227"><span class="linenos"> 227</span></a>
</span><span id="Clustering-228"><a href="#Clustering-228"><span class="linenos"> 228</span></a>        <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
</span><span id="Clustering-229"><a href="#Clustering-229"><span class="linenos"> 229</span></a>        <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clustering_data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="Clustering-230"><a href="#Clustering-230"><span class="linenos"> 230</span></a>
</span><span id="Clustering-231"><a href="#Clustering-231"><span class="linenos"> 231</span></a>        <span class="k">if</span> <span class="n">pc_num</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pc_num</span> <span class="o">&gt;</span> <span class="n">data_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="Clustering-232"><a href="#Clustering-232"><span class="linenos"> 232</span></a>            <span class="n">pc_num</span> <span class="o">=</span> <span class="n">data_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Clustering-233"><a href="#Clustering-233"><span class="linenos"> 233</span></a>
</span><span id="Clustering-234"><a href="#Clustering-234"><span class="linenos"> 234</span></a>        <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">pc_num</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</span><span id="Clustering-235"><a href="#Clustering-235"><span class="linenos"> 235</span></a>
</span><span id="Clustering-236"><a href="#Clustering-236"><span class="linenos"> 236</span></a>        <span class="n">principal_components</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">)</span>
</span><span id="Clustering-237"><a href="#Clustering-237"><span class="linenos"> 237</span></a>
</span><span id="Clustering-238"><a href="#Clustering-238"><span class="linenos"> 238</span></a>        <span class="n">pca_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="Clustering-239"><a href="#Clustering-239"><span class="linenos"> 239</span></a>            <span class="n">data</span><span class="o">=</span><span class="n">principal_components</span><span class="p">,</span>
</span><span id="Clustering-240"><a href="#Clustering-240"><span class="linenos"> 240</span></a>            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;PC&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pc_num</span><span class="p">)],</span>
</span><span id="Clustering-241"><a href="#Clustering-241"><span class="linenos"> 241</span></a>        <span class="p">)</span>
</span><span id="Clustering-242"><a href="#Clustering-242"><span class="linenos"> 242</span></a>
</span><span id="Clustering-243"><a href="#Clustering-243"><span class="linenos"> 243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">explained_var</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="Clustering-244"><a href="#Clustering-244"><span class="linenos"> 244</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explained_var</span><span class="p">)</span>
</span><span id="Clustering-245"><a href="#Clustering-245"><span class="linenos"> 245</span></a>
</span><span id="Clustering-246"><a href="#Clustering-246"><span class="linenos"> 246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pca</span> <span class="o">=</span> <span class="n">pca_df</span>
</span><span id="Clustering-247"><a href="#Clustering-247"><span class="linenos"> 247</span></a>
</span><span id="Clustering-248"><a href="#Clustering-248"><span class="linenos"> 248</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="Clustering-249"><a href="#Clustering-249"><span class="linenos"> 249</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pca_df</span><span class="p">[</span><span class="s2">&quot;PC1&quot;</span><span class="p">],</span> <span class="n">pca_df</span><span class="p">[</span><span class="s2">&quot;PC2&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="Clustering-250"><a href="#Clustering-250"><span class="linenos"> 250</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;PC 1&quot;</span><span class="p">)</span>
</span><span id="Clustering-251"><a href="#Clustering-251"><span class="linenos"> 251</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;PC 2&quot;</span><span class="p">)</span>
</span><span id="Clustering-252"><a href="#Clustering-252"><span class="linenos"> 252</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Clustering-253"><a href="#Clustering-253"><span class="linenos"> 253</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="Clustering-254"><a href="#Clustering-254"><span class="linenos"> 254</span></a>
</span><span id="Clustering-255"><a href="#Clustering-255"><span class="linenos"> 255</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="Clustering-256"><a href="#Clustering-256"><span class="linenos"> 256</span></a>
</span><span id="Clustering-257"><a href="#Clustering-257"><span class="linenos"> 257</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">knee_plot_PCA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">):</span>
</span><span id="Clustering-258"><a href="#Clustering-258"><span class="linenos"> 258</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering-259"><a href="#Clustering-259"><span class="linenos"> 259</span></a><span class="sd">        Plot cumulative explained variance to determine the optimal number of PCs.</span>
</span><span id="Clustering-260"><a href="#Clustering-260"><span class="linenos"> 260</span></a>
</span><span id="Clustering-261"><a href="#Clustering-261"><span class="linenos"> 261</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering-262"><a href="#Clustering-262"><span class="linenos"> 262</span></a><span class="sd">        ----------</span>
</span><span id="Clustering-263"><a href="#Clustering-263"><span class="linenos"> 263</span></a><span class="sd">        width : int, default 8</span>
</span><span id="Clustering-264"><a href="#Clustering-264"><span class="linenos"> 264</span></a><span class="sd">            Width of the figure.</span>
</span><span id="Clustering-265"><a href="#Clustering-265"><span class="linenos"> 265</span></a>
</span><span id="Clustering-266"><a href="#Clustering-266"><span class="linenos"> 266</span></a><span class="sd">        height : int or, default 6</span>
</span><span id="Clustering-267"><a href="#Clustering-267"><span class="linenos"> 267</span></a><span class="sd">            Height of the figure.</span>
</span><span id="Clustering-268"><a href="#Clustering-268"><span class="linenos"> 268</span></a>
</span><span id="Clustering-269"><a href="#Clustering-269"><span class="linenos"> 269</span></a><span class="sd">        Returns</span>
</span><span id="Clustering-270"><a href="#Clustering-270"><span class="linenos"> 270</span></a><span class="sd">        -------</span>
</span><span id="Clustering-271"><a href="#Clustering-271"><span class="linenos"> 271</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="Clustering-272"><a href="#Clustering-272"><span class="linenos"> 272</span></a><span class="sd">            Line plot showing cumulative variance explained by each PC.</span>
</span><span id="Clustering-273"><a href="#Clustering-273"><span class="linenos"> 273</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering-274"><a href="#Clustering-274"><span class="linenos"> 274</span></a>
</span><span id="Clustering-275"><a href="#Clustering-275"><span class="linenos"> 275</span></a>        <span class="n">fig_knee</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="Clustering-276"><a href="#Clustering-276"><span class="linenos"> 276</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explained_var</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_var</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
</span><span id="Clustering-277"><a href="#Clustering-277"><span class="linenos"> 277</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;PC (n components)&quot;</span><span class="p">)</span>
</span><span id="Clustering-278"><a href="#Clustering-278"><span class="linenos"> 278</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative explained variance (%)&quot;</span><span class="p">)</span>
</span><span id="Clustering-279"><a href="#Clustering-279"><span class="linenos"> 279</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Clustering-280"><a href="#Clustering-280"><span class="linenos"> 280</span></a>
</span><span id="Clustering-281"><a href="#Clustering-281"><span class="linenos"> 281</span></a>        <span class="n">xticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explained_var</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="Clustering-282"><a href="#Clustering-282"><span class="linenos"> 282</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="Clustering-283"><a href="#Clustering-283"><span class="linenos"> 283</span></a>
</span><span id="Clustering-284"><a href="#Clustering-284"><span class="linenos"> 284</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="Clustering-285"><a href="#Clustering-285"><span class="linenos"> 285</span></a>
</span><span id="Clustering-286"><a href="#Clustering-286"><span class="linenos"> 286</span></a>        <span class="k">return</span> <span class="n">fig_knee</span>
</span><span id="Clustering-287"><a href="#Clustering-287"><span class="linenos"> 287</span></a>
</span><span id="Clustering-288"><a href="#Clustering-288"><span class="linenos"> 288</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_clusters_PCA</span><span class="p">(</span>
</span><span id="Clustering-289"><a href="#Clustering-289"><span class="linenos"> 289</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Clustering-290"><a href="#Clustering-290"><span class="linenos"> 290</span></a>        <span class="n">pc_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="Clustering-291"><a href="#Clustering-291"><span class="linenos"> 291</span></a>        <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="Clustering-292"><a href="#Clustering-292"><span class="linenos"> 292</span></a>        <span class="n">min_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="Clustering-293"><a href="#Clustering-293"><span class="linenos"> 293</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="Clustering-294"><a href="#Clustering-294"><span class="linenos"> 294</span></a>        <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="Clustering-295"><a href="#Clustering-295"><span class="linenos"> 295</span></a>        <span class="n">harmonized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Clustering-296"><a href="#Clustering-296"><span class="linenos"> 296</span></a>    <span class="p">):</span>
</span><span id="Clustering-297"><a href="#Clustering-297"><span class="linenos"> 297</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering-298"><a href="#Clustering-298"><span class="linenos"> 298</span></a><span class="sd">        Apply DBSCAN clustering to PCA embeddings and visualize the results.</span>
</span><span id="Clustering-299"><a href="#Clustering-299"><span class="linenos"> 299</span></a>
</span><span id="Clustering-300"><a href="#Clustering-300"><span class="linenos"> 300</span></a><span class="sd">        This method performs density-based clustering (DBSCAN) on the PCA-reduced</span>
</span><span id="Clustering-301"><a href="#Clustering-301"><span class="linenos"> 301</span></a><span class="sd">        dataset. Cluster labels are stored in the object&#39;s metadata, and a scatter</span>
</span><span id="Clustering-302"><a href="#Clustering-302"><span class="linenos"> 302</span></a><span class="sd">        plot of the first two principal components with cluster annotations is returned.</span>
</span><span id="Clustering-303"><a href="#Clustering-303"><span class="linenos"> 303</span></a>
</span><span id="Clustering-304"><a href="#Clustering-304"><span class="linenos"> 304</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering-305"><a href="#Clustering-305"><span class="linenos"> 305</span></a><span class="sd">        ----------</span>
</span><span id="Clustering-306"><a href="#Clustering-306"><span class="linenos"> 306</span></a><span class="sd">        pc_num : int, default 2</span>
</span><span id="Clustering-307"><a href="#Clustering-307"><span class="linenos"> 307</span></a><span class="sd">            Number of principal components to use for clustering.</span>
</span><span id="Clustering-308"><a href="#Clustering-308"><span class="linenos"> 308</span></a><span class="sd">            If 0, uses all available components.</span>
</span><span id="Clustering-309"><a href="#Clustering-309"><span class="linenos"> 309</span></a>
</span><span id="Clustering-310"><a href="#Clustering-310"><span class="linenos"> 310</span></a><span class="sd">        eps : float, default 0.5</span>
</span><span id="Clustering-311"><a href="#Clustering-311"><span class="linenos"> 311</span></a><span class="sd">            Maximum distance between two points for them to be considered</span>
</span><span id="Clustering-312"><a href="#Clustering-312"><span class="linenos"> 312</span></a><span class="sd">            as neighbors (DBSCAN parameter).</span>
</span><span id="Clustering-313"><a href="#Clustering-313"><span class="linenos"> 313</span></a>
</span><span id="Clustering-314"><a href="#Clustering-314"><span class="linenos"> 314</span></a><span class="sd">        min_samples : int, default 10</span>
</span><span id="Clustering-315"><a href="#Clustering-315"><span class="linenos"> 315</span></a><span class="sd">            Minimum number of samples required to form a cluster (DBSCAN parameter).</span>
</span><span id="Clustering-316"><a href="#Clustering-316"><span class="linenos"> 316</span></a>
</span><span id="Clustering-317"><a href="#Clustering-317"><span class="linenos"> 317</span></a><span class="sd">        width : int, default 8</span>
</span><span id="Clustering-318"><a href="#Clustering-318"><span class="linenos"> 318</span></a><span class="sd">            Width of the output scatter plot.</span>
</span><span id="Clustering-319"><a href="#Clustering-319"><span class="linenos"> 319</span></a>
</span><span id="Clustering-320"><a href="#Clustering-320"><span class="linenos"> 320</span></a><span class="sd">        height : int, default 6</span>
</span><span id="Clustering-321"><a href="#Clustering-321"><span class="linenos"> 321</span></a><span class="sd">            Height of the output scatter plot.</span>
</span><span id="Clustering-322"><a href="#Clustering-322"><span class="linenos"> 322</span></a>
</span><span id="Clustering-323"><a href="#Clustering-323"><span class="linenos"> 323</span></a><span class="sd">        harmonized : bool, default False</span>
</span><span id="Clustering-324"><a href="#Clustering-324"><span class="linenos"> 324</span></a><span class="sd">            If True, use harmonized PCA data (`self.harmonized_pca`).</span>
</span><span id="Clustering-325"><a href="#Clustering-325"><span class="linenos"> 325</span></a><span class="sd">            If False, use standard PCA results (`self.pca`).</span>
</span><span id="Clustering-326"><a href="#Clustering-326"><span class="linenos"> 326</span></a>
</span><span id="Clustering-327"><a href="#Clustering-327"><span class="linenos"> 327</span></a><span class="sd">        Returns</span>
</span><span id="Clustering-328"><a href="#Clustering-328"><span class="linenos"> 328</span></a><span class="sd">        -------</span>
</span><span id="Clustering-329"><a href="#Clustering-329"><span class="linenos"> 329</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="Clustering-330"><a href="#Clustering-330"><span class="linenos"> 330</span></a><span class="sd">            Scatter plot of the first two principal components colored by</span>
</span><span id="Clustering-331"><a href="#Clustering-331"><span class="linenos"> 331</span></a><span class="sd">            cluster assignments.</span>
</span><span id="Clustering-332"><a href="#Clustering-332"><span class="linenos"> 332</span></a>
</span><span id="Clustering-333"><a href="#Clustering-333"><span class="linenos"> 333</span></a><span class="sd">        Updates</span>
</span><span id="Clustering-334"><a href="#Clustering-334"><span class="linenos"> 334</span></a><span class="sd">        -------</span>
</span><span id="Clustering-335"><a href="#Clustering-335"><span class="linenos"> 335</span></a><span class="sd">        self.clustering_metadata[&#39;PCA_clusters&#39;] : list</span>
</span><span id="Clustering-336"><a href="#Clustering-336"><span class="linenos"> 336</span></a><span class="sd">            Cluster labels assigned to each cell/sample.</span>
</span><span id="Clustering-337"><a href="#Clustering-337"><span class="linenos"> 337</span></a>
</span><span id="Clustering-338"><a href="#Clustering-338"><span class="linenos"> 338</span></a><span class="sd">        self.input_metadata[&#39;PCA_clusters&#39;] : list, optional</span>
</span><span id="Clustering-339"><a href="#Clustering-339"><span class="linenos"> 339</span></a><span class="sd">            Cluster labels stored in input metadata (if available).</span>
</span><span id="Clustering-340"><a href="#Clustering-340"><span class="linenos"> 340</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering-341"><a href="#Clustering-341"><span class="linenos"> 341</span></a>
</span><span id="Clustering-342"><a href="#Clustering-342"><span class="linenos"> 342</span></a>        <span class="n">dbscan</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="n">min_samples</span><span class="p">)</span>
</span><span id="Clustering-343"><a href="#Clustering-343"><span class="linenos"> 343</span></a>
</span><span id="Clustering-344"><a href="#Clustering-344"><span class="linenos"> 344</span></a>        <span class="k">if</span> <span class="n">pc_num</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">harmonized</span><span class="p">:</span>
</span><span id="Clustering-345"><a href="#Clustering-345"><span class="linenos"> 345</span></a>            <span class="n">PCA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span>
</span><span id="Clustering-346"><a href="#Clustering-346"><span class="linenos"> 346</span></a>
</span><span id="Clustering-347"><a href="#Clustering-347"><span class="linenos"> 347</span></a>        <span class="k">elif</span> <span class="n">pc_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Clustering-348"><a href="#Clustering-348"><span class="linenos"> 348</span></a>            <span class="n">PCA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca</span>
</span><span id="Clustering-349"><a href="#Clustering-349"><span class="linenos"> 349</span></a>
</span><span id="Clustering-350"><a href="#Clustering-350"><span class="linenos"> 350</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering-351"><a href="#Clustering-351"><span class="linenos"> 351</span></a>            <span class="k">if</span> <span class="n">harmonized</span><span class="p">:</span>
</span><span id="Clustering-352"><a href="#Clustering-352"><span class="linenos"> 352</span></a>
</span><span id="Clustering-353"><a href="#Clustering-353"><span class="linenos"> 353</span></a>                <span class="n">PCA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">pc_num</span><span class="p">]</span>
</span><span id="Clustering-354"><a href="#Clustering-354"><span class="linenos"> 354</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering-355"><a href="#Clustering-355"><span class="linenos"> 355</span></a>
</span><span id="Clustering-356"><a href="#Clustering-356"><span class="linenos"> 356</span></a>                <span class="n">PCA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">pc_num</span><span class="p">]</span>
</span><span id="Clustering-357"><a href="#Clustering-357"><span class="linenos"> 357</span></a>
</span><span id="Clustering-358"><a href="#Clustering-358"><span class="linenos"> 358</span></a>        <span class="n">dbscan_labels</span> <span class="o">=</span> <span class="n">dbscan</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">PCA</span><span class="p">)</span>
</span><span id="Clustering-359"><a href="#Clustering-359"><span class="linenos"> 359</span></a>
</span><span id="Clustering-360"><a href="#Clustering-360"><span class="linenos"> 360</span></a>        <span class="n">pca_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">PCA</span><span class="p">)</span>
</span><span id="Clustering-361"><a href="#Clustering-361"><span class="linenos"> 361</span></a>        <span class="n">pca_df</span><span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbscan_labels</span>
</span><span id="Clustering-362"><a href="#Clustering-362"><span class="linenos"> 362</span></a>
</span><span id="Clustering-363"><a href="#Clustering-363"><span class="linenos"> 363</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="Clustering-364"><a href="#Clustering-364"><span class="linenos"> 364</span></a>
</span><span id="Clustering-365"><a href="#Clustering-365"><span class="linenos"> 365</span></a>        <span class="k">for</span> <span class="n">cluster_id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pca_df</span><span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
</span><span id="Clustering-366"><a href="#Clustering-366"><span class="linenos"> 366</span></a>            <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">pca_df</span><span class="p">[</span><span class="n">pca_df</span><span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cluster_id</span><span class="p">]</span>
</span><span id="Clustering-367"><a href="#Clustering-367"><span class="linenos"> 367</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="Clustering-368"><a href="#Clustering-368"><span class="linenos"> 368</span></a>                <span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;PC1&quot;</span><span class="p">],</span>
</span><span id="Clustering-369"><a href="#Clustering-369"><span class="linenos"> 369</span></a>                <span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;PC2&quot;</span><span class="p">],</span>
</span><span id="Clustering-370"><a href="#Clustering-370"><span class="linenos"> 370</span></a>                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cluster </span><span class="si">{</span><span class="n">cluster_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Clustering-371"><a href="#Clustering-371"><span class="linenos"> 371</span></a>                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span><span id="Clustering-372"><a href="#Clustering-372"><span class="linenos"> 372</span></a>            <span class="p">)</span>
</span><span id="Clustering-373"><a href="#Clustering-373"><span class="linenos"> 373</span></a>
</span><span id="Clustering-374"><a href="#Clustering-374"><span class="linenos"> 374</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;PC 1&quot;</span><span class="p">)</span>
</span><span id="Clustering-375"><a href="#Clustering-375"><span class="linenos"> 375</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;PC 2&quot;</span><span class="p">)</span>
</span><span id="Clustering-376"><a href="#Clustering-376"><span class="linenos"> 376</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Clusters&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
</span><span id="Clustering-377"><a href="#Clustering-377"><span class="linenos"> 377</span></a>
</span><span id="Clustering-378"><a href="#Clustering-378"><span class="linenos"> 378</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Clustering-379"><a href="#Clustering-379"><span class="linenos"> 379</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="Clustering-380"><a href="#Clustering-380"><span class="linenos"> 380</span></a>
</span><span id="Clustering-381"><a href="#Clustering-381"><span class="linenos"> 381</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;PCA_clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dbscan_labels</span><span class="p">]</span>
</span><span id="Clustering-382"><a href="#Clustering-382"><span class="linenos"> 382</span></a>
</span><span id="Clustering-383"><a href="#Clustering-383"><span class="linenos"> 383</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Clustering-384"><a href="#Clustering-384"><span class="linenos"> 384</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;PCA_clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dbscan_labels</span><span class="p">]</span>
</span><span id="Clustering-385"><a href="#Clustering-385"><span class="linenos"> 385</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="Clustering-386"><a href="#Clustering-386"><span class="linenos"> 386</span></a>            <span class="k">pass</span>
</span><span id="Clustering-387"><a href="#Clustering-387"><span class="linenos"> 387</span></a>
</span><span id="Clustering-388"><a href="#Clustering-388"><span class="linenos"> 388</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="Clustering-389"><a href="#Clustering-389"><span class="linenos"> 389</span></a>
</span><span id="Clustering-390"><a href="#Clustering-390"><span class="linenos"> 390</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">perform_UMAP</span><span class="p">(</span>
</span><span id="Clustering-391"><a href="#Clustering-391"><span class="linenos"> 391</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Clustering-392"><a href="#Clustering-392"><span class="linenos"> 392</span></a>        <span class="n">factorize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Clustering-393"><a href="#Clustering-393"><span class="linenos"> 393</span></a>        <span class="n">umap_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
</span><span id="Clustering-394"><a href="#Clustering-394"><span class="linenos"> 394</span></a>        <span class="n">pc_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Clustering-395"><a href="#Clustering-395"><span class="linenos"> 395</span></a>        <span class="n">harmonized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Clustering-396"><a href="#Clustering-396"><span class="linenos"> 396</span></a>        <span class="n">n_neighbors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="Clustering-397"><a href="#Clustering-397"><span class="linenos"> 397</span></a>        <span class="n">min_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="Clustering-398"><a href="#Clustering-398"><span class="linenos"> 398</span></a>        <span class="n">spread</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="Clustering-399"><a href="#Clustering-399"><span class="linenos"> 399</span></a>        <span class="n">set_op_mix_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="Clustering-400"><a href="#Clustering-400"><span class="linenos"> 400</span></a>        <span class="n">local_connectivity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Clustering-401"><a href="#Clustering-401"><span class="linenos"> 401</span></a>        <span class="n">repulsion_strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="Clustering-402"><a href="#Clustering-402"><span class="linenos"> 402</span></a>        <span class="n">negative_sample_rate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="Clustering-403"><a href="#Clustering-403"><span class="linenos"> 403</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="Clustering-404"><a href="#Clustering-404"><span class="linenos"> 404</span></a>        <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="Clustering-405"><a href="#Clustering-405"><span class="linenos"> 405</span></a>    <span class="p">):</span>
</span><span id="Clustering-406"><a href="#Clustering-406"><span class="linenos"> 406</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering-407"><a href="#Clustering-407"><span class="linenos"> 407</span></a><span class="sd">        Compute and visualize UMAP embeddings of the dataset.</span>
</span><span id="Clustering-408"><a href="#Clustering-408"><span class="linenos"> 408</span></a>
</span><span id="Clustering-409"><a href="#Clustering-409"><span class="linenos"> 409</span></a><span class="sd">        This method applies Uniform Manifold Approximation and Projection (UMAP)</span>
</span><span id="Clustering-410"><a href="#Clustering-410"><span class="linenos"> 410</span></a><span class="sd">        for dimensionality reduction on either raw, PCA, or harmonized PCA data.</span>
</span><span id="Clustering-411"><a href="#Clustering-411"><span class="linenos"> 411</span></a><span class="sd">        Results are stored as a DataFrame (`self.umap`) and a scatter plot figure</span>
</span><span id="Clustering-412"><a href="#Clustering-412"><span class="linenos"> 412</span></a><span class="sd">        (`self.UMAP_plot`).</span>
</span><span id="Clustering-413"><a href="#Clustering-413"><span class="linenos"> 413</span></a>
</span><span id="Clustering-414"><a href="#Clustering-414"><span class="linenos"> 414</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering-415"><a href="#Clustering-415"><span class="linenos"> 415</span></a><span class="sd">        ----------</span>
</span><span id="Clustering-416"><a href="#Clustering-416"><span class="linenos"> 416</span></a><span class="sd">        factorize : bool, default False</span>
</span><span id="Clustering-417"><a href="#Clustering-417"><span class="linenos"> 417</span></a><span class="sd">            If True, categorical sample labels (from column names) are factorized</span>
</span><span id="Clustering-418"><a href="#Clustering-418"><span class="linenos"> 418</span></a><span class="sd">            and used as supervision in UMAP fitting.</span>
</span><span id="Clustering-419"><a href="#Clustering-419"><span class="linenos"> 419</span></a>
</span><span id="Clustering-420"><a href="#Clustering-420"><span class="linenos"> 420</span></a><span class="sd">        umap_num : int, default 100</span>
</span><span id="Clustering-421"><a href="#Clustering-421"><span class="linenos"> 421</span></a><span class="sd">            Number of UMAP dimensions to compute. If 0, matches the input dimension.</span>
</span><span id="Clustering-422"><a href="#Clustering-422"><span class="linenos"> 422</span></a>
</span><span id="Clustering-423"><a href="#Clustering-423"><span class="linenos"> 423</span></a><span class="sd">        pc_num : int, default 0</span>
</span><span id="Clustering-424"><a href="#Clustering-424"><span class="linenos"> 424</span></a><span class="sd">            Number of principal components to use as UMAP input.</span>
</span><span id="Clustering-425"><a href="#Clustering-425"><span class="linenos"> 425</span></a><span class="sd">            If 0, use all available components or raw data.</span>
</span><span id="Clustering-426"><a href="#Clustering-426"><span class="linenos"> 426</span></a>
</span><span id="Clustering-427"><a href="#Clustering-427"><span class="linenos"> 427</span></a><span class="sd">        harmonized : bool, default False</span>
</span><span id="Clustering-428"><a href="#Clustering-428"><span class="linenos"> 428</span></a><span class="sd">            If True, use harmonized PCA embeddings (`self.harmonized_pca`).</span>
</span><span id="Clustering-429"><a href="#Clustering-429"><span class="linenos"> 429</span></a><span class="sd">            If False, use standard PCA or raw scaled data.</span>
</span><span id="Clustering-430"><a href="#Clustering-430"><span class="linenos"> 430</span></a>
</span><span id="Clustering-431"><a href="#Clustering-431"><span class="linenos"> 431</span></a><span class="sd">        n_neighbors : int, default 5</span>
</span><span id="Clustering-432"><a href="#Clustering-432"><span class="linenos"> 432</span></a><span class="sd">            UMAP parameter controlling the size of the local neighborhood.</span>
</span><span id="Clustering-433"><a href="#Clustering-433"><span class="linenos"> 433</span></a>
</span><span id="Clustering-434"><a href="#Clustering-434"><span class="linenos"> 434</span></a><span class="sd">        min_dist : float, default 0.1</span>
</span><span id="Clustering-435"><a href="#Clustering-435"><span class="linenos"> 435</span></a><span class="sd">            UMAP parameter controlling minimum allowed distance between embedded points.</span>
</span><span id="Clustering-436"><a href="#Clustering-436"><span class="linenos"> 436</span></a>
</span><span id="Clustering-437"><a href="#Clustering-437"><span class="linenos"> 437</span></a><span class="sd">        spread : int | float, default 1.0</span>
</span><span id="Clustering-438"><a href="#Clustering-438"><span class="linenos"> 438</span></a><span class="sd">            Effective scale of embedded space (UMAP parameter).</span>
</span><span id="Clustering-439"><a href="#Clustering-439"><span class="linenos"> 439</span></a>
</span><span id="Clustering-440"><a href="#Clustering-440"><span class="linenos"> 440</span></a><span class="sd">        set_op_mix_ratio : int | float, default 1.0</span>
</span><span id="Clustering-441"><a href="#Clustering-441"><span class="linenos"> 441</span></a><span class="sd">            Interpolation parameter between union and intersection in fuzzy sets.</span>
</span><span id="Clustering-442"><a href="#Clustering-442"><span class="linenos"> 442</span></a>
</span><span id="Clustering-443"><a href="#Clustering-443"><span class="linenos"> 443</span></a><span class="sd">        local_connectivity : int, default 1</span>
</span><span id="Clustering-444"><a href="#Clustering-444"><span class="linenos"> 444</span></a><span class="sd">            Number of nearest neighbors assumed for each point.</span>
</span><span id="Clustering-445"><a href="#Clustering-445"><span class="linenos"> 445</span></a>
</span><span id="Clustering-446"><a href="#Clustering-446"><span class="linenos"> 446</span></a><span class="sd">        repulsion_strength : int | float, default 1.0</span>
</span><span id="Clustering-447"><a href="#Clustering-447"><span class="linenos"> 447</span></a><span class="sd">            Weighting applied to negative samples during optimization.</span>
</span><span id="Clustering-448"><a href="#Clustering-448"><span class="linenos"> 448</span></a>
</span><span id="Clustering-449"><a href="#Clustering-449"><span class="linenos"> 449</span></a><span class="sd">        negative_sample_rate : int, default 5</span>
</span><span id="Clustering-450"><a href="#Clustering-450"><span class="linenos"> 450</span></a><span class="sd">            Number of negative samples per positive sample in optimization.</span>
</span><span id="Clustering-451"><a href="#Clustering-451"><span class="linenos"> 451</span></a>
</span><span id="Clustering-452"><a href="#Clustering-452"><span class="linenos"> 452</span></a><span class="sd">        width : int, default 8</span>
</span><span id="Clustering-453"><a href="#Clustering-453"><span class="linenos"> 453</span></a><span class="sd">            Width of the output scatter plot.</span>
</span><span id="Clustering-454"><a href="#Clustering-454"><span class="linenos"> 454</span></a>
</span><span id="Clustering-455"><a href="#Clustering-455"><span class="linenos"> 455</span></a><span class="sd">        height : int, default 6</span>
</span><span id="Clustering-456"><a href="#Clustering-456"><span class="linenos"> 456</span></a><span class="sd">            Height of the output scatter plot.</span>
</span><span id="Clustering-457"><a href="#Clustering-457"><span class="linenos"> 457</span></a>
</span><span id="Clustering-458"><a href="#Clustering-458"><span class="linenos"> 458</span></a><span class="sd">        Updates</span>
</span><span id="Clustering-459"><a href="#Clustering-459"><span class="linenos"> 459</span></a><span class="sd">        -------</span>
</span><span id="Clustering-460"><a href="#Clustering-460"><span class="linenos"> 460</span></a><span class="sd">        self.umap : pandas.DataFrame</span>
</span><span id="Clustering-461"><a href="#Clustering-461"><span class="linenos"> 461</span></a><span class="sd">            Table of UMAP embeddings with columns `UMAP1 ... UMAPn`.</span>
</span><span id="Clustering-462"><a href="#Clustering-462"><span class="linenos"> 462</span></a>
</span><span id="Clustering-463"><a href="#Clustering-463"><span class="linenos"> 463</span></a><span class="sd">        Notes</span>
</span><span id="Clustering-464"><a href="#Clustering-464"><span class="linenos"> 464</span></a><span class="sd">        -----</span>
</span><span id="Clustering-465"><a href="#Clustering-465"><span class="linenos"> 465</span></a><span class="sd">        For supervised UMAP (`factorize=True`), categorical codes from column</span>
</span><span id="Clustering-466"><a href="#Clustering-466"><span class="linenos"> 466</span></a><span class="sd">        names of the dataset are used as labels.</span>
</span><span id="Clustering-467"><a href="#Clustering-467"><span class="linenos"> 467</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering-468"><a href="#Clustering-468"><span class="linenos"> 468</span></a>
</span><span id="Clustering-469"><a href="#Clustering-469"><span class="linenos"> 469</span></a>        <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
</span><span id="Clustering-470"><a href="#Clustering-470"><span class="linenos"> 470</span></a>
</span><span id="Clustering-471"><a href="#Clustering-471"><span class="linenos"> 471</span></a>        <span class="k">if</span> <span class="n">pc_num</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">harmonized</span><span class="p">:</span>
</span><span id="Clustering-472"><a href="#Clustering-472"><span class="linenos"> 472</span></a>            <span class="n">data_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span>
</span><span id="Clustering-473"><a href="#Clustering-473"><span class="linenos"> 473</span></a>
</span><span id="Clustering-474"><a href="#Clustering-474"><span class="linenos"> 474</span></a>        <span class="k">elif</span> <span class="n">pc_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Clustering-475"><a href="#Clustering-475"><span class="linenos"> 475</span></a>            <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clustering_data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="Clustering-476"><a href="#Clustering-476"><span class="linenos"> 476</span></a>
</span><span id="Clustering-477"><a href="#Clustering-477"><span class="linenos"> 477</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering-478"><a href="#Clustering-478"><span class="linenos"> 478</span></a>            <span class="k">if</span> <span class="n">harmonized</span><span class="p">:</span>
</span><span id="Clustering-479"><a href="#Clustering-479"><span class="linenos"> 479</span></a>
</span><span id="Clustering-480"><a href="#Clustering-480"><span class="linenos"> 480</span></a>                <span class="n">data_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">pc_num</span><span class="p">]</span>
</span><span id="Clustering-481"><a href="#Clustering-481"><span class="linenos"> 481</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering-482"><a href="#Clustering-482"><span class="linenos"> 482</span></a>
</span><span id="Clustering-483"><a href="#Clustering-483"><span class="linenos"> 483</span></a>                <span class="n">data_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">pc_num</span><span class="p">]</span>
</span><span id="Clustering-484"><a href="#Clustering-484"><span class="linenos"> 484</span></a>
</span><span id="Clustering-485"><a href="#Clustering-485"><span class="linenos"> 485</span></a>        <span class="k">if</span> <span class="n">umap_num</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">umap_num</span> <span class="o">&gt;</span> <span class="n">data_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="Clustering-486"><a href="#Clustering-486"><span class="linenos"> 486</span></a>
</span><span id="Clustering-487"><a href="#Clustering-487"><span class="linenos"> 487</span></a>            <span class="n">umap_num</span> <span class="o">=</span> <span class="n">data_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Clustering-488"><a href="#Clustering-488"><span class="linenos"> 488</span></a>
</span><span id="Clustering-489"><a href="#Clustering-489"><span class="linenos"> 489</span></a>            <span class="n">reducer</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">UMAP</span><span class="p">(</span>
</span><span id="Clustering-490"><a href="#Clustering-490"><span class="linenos"> 490</span></a>                <span class="n">n_components</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data_scaled</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
</span><span id="Clustering-491"><a href="#Clustering-491"><span class="linenos"> 491</span></a>                <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
</span><span id="Clustering-492"><a href="#Clustering-492"><span class="linenos"> 492</span></a>                <span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">,</span>
</span><span id="Clustering-493"><a href="#Clustering-493"><span class="linenos"> 493</span></a>                <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span>
</span><span id="Clustering-494"><a href="#Clustering-494"><span class="linenos"> 494</span></a>                <span class="n">spread</span><span class="o">=</span><span class="n">spread</span><span class="p">,</span>
</span><span id="Clustering-495"><a href="#Clustering-495"><span class="linenos"> 495</span></a>                <span class="n">set_op_mix_ratio</span><span class="o">=</span><span class="n">set_op_mix_ratio</span><span class="p">,</span>
</span><span id="Clustering-496"><a href="#Clustering-496"><span class="linenos"> 496</span></a>                <span class="n">local_connectivity</span><span class="o">=</span><span class="n">local_connectivity</span><span class="p">,</span>
</span><span id="Clustering-497"><a href="#Clustering-497"><span class="linenos"> 497</span></a>                <span class="n">repulsion_strength</span><span class="o">=</span><span class="n">repulsion_strength</span><span class="p">,</span>
</span><span id="Clustering-498"><a href="#Clustering-498"><span class="linenos"> 498</span></a>                <span class="n">negative_sample_rate</span><span class="o">=</span><span class="n">negative_sample_rate</span><span class="p">,</span>
</span><span id="Clustering-499"><a href="#Clustering-499"><span class="linenos"> 499</span></a>                <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Clustering-500"><a href="#Clustering-500"><span class="linenos"> 500</span></a>            <span class="p">)</span>
</span><span id="Clustering-501"><a href="#Clustering-501"><span class="linenos"> 501</span></a>
</span><span id="Clustering-502"><a href="#Clustering-502"><span class="linenos"> 502</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering-503"><a href="#Clustering-503"><span class="linenos"> 503</span></a>
</span><span id="Clustering-504"><a href="#Clustering-504"><span class="linenos"> 504</span></a>            <span class="n">reducer</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">UMAP</span><span class="p">(</span>
</span><span id="Clustering-505"><a href="#Clustering-505"><span class="linenos"> 505</span></a>                <span class="n">n_components</span><span class="o">=</span><span class="n">umap_num</span><span class="p">,</span>
</span><span id="Clustering-506"><a href="#Clustering-506"><span class="linenos"> 506</span></a>                <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
</span><span id="Clustering-507"><a href="#Clustering-507"><span class="linenos"> 507</span></a>                <span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">,</span>
</span><span id="Clustering-508"><a href="#Clustering-508"><span class="linenos"> 508</span></a>                <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span>
</span><span id="Clustering-509"><a href="#Clustering-509"><span class="linenos"> 509</span></a>                <span class="n">spread</span><span class="o">=</span><span class="n">spread</span><span class="p">,</span>
</span><span id="Clustering-510"><a href="#Clustering-510"><span class="linenos"> 510</span></a>                <span class="n">set_op_mix_ratio</span><span class="o">=</span><span class="n">set_op_mix_ratio</span><span class="p">,</span>
</span><span id="Clustering-511"><a href="#Clustering-511"><span class="linenos"> 511</span></a>                <span class="n">local_connectivity</span><span class="o">=</span><span class="n">local_connectivity</span><span class="p">,</span>
</span><span id="Clustering-512"><a href="#Clustering-512"><span class="linenos"> 512</span></a>                <span class="n">repulsion_strength</span><span class="o">=</span><span class="n">repulsion_strength</span><span class="p">,</span>
</span><span id="Clustering-513"><a href="#Clustering-513"><span class="linenos"> 513</span></a>                <span class="n">negative_sample_rate</span><span class="o">=</span><span class="n">negative_sample_rate</span><span class="p">,</span>
</span><span id="Clustering-514"><a href="#Clustering-514"><span class="linenos"> 514</span></a>                <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Clustering-515"><a href="#Clustering-515"><span class="linenos"> 515</span></a>            <span class="p">)</span>
</span><span id="Clustering-516"><a href="#Clustering-516"><span class="linenos"> 516</span></a>
</span><span id="Clustering-517"><a href="#Clustering-517"><span class="linenos"> 517</span></a>        <span class="k">if</span> <span class="n">factorize</span><span class="p">:</span>
</span><span id="Clustering-518"><a href="#Clustering-518"><span class="linenos"> 518</span></a>            <span class="n">embedding</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
</span><span id="Clustering-519"><a href="#Clustering-519"><span class="linenos"> 519</span></a>                <span class="n">X</span><span class="o">=</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clustering_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">codes</span>
</span><span id="Clustering-520"><a href="#Clustering-520"><span class="linenos"> 520</span></a>            <span class="p">)</span>
</span><span id="Clustering-521"><a href="#Clustering-521"><span class="linenos"> 521</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering-522"><a href="#Clustering-522"><span class="linenos"> 522</span></a>            <span class="n">embedding</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">data_scaled</span><span class="p">)</span>
</span><span id="Clustering-523"><a href="#Clustering-523"><span class="linenos"> 523</span></a>
</span><span id="Clustering-524"><a href="#Clustering-524"><span class="linenos"> 524</span></a>        <span class="n">umap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="Clustering-525"><a href="#Clustering-525"><span class="linenos"> 525</span></a>            <span class="n">embedding</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;UMAP&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">umap_num</span><span class="p">)]</span>
</span><span id="Clustering-526"><a href="#Clustering-526"><span class="linenos"> 526</span></a>        <span class="p">)</span>
</span><span id="Clustering-527"><a href="#Clustering-527"><span class="linenos"> 527</span></a>
</span><span id="Clustering-528"><a href="#Clustering-528"><span class="linenos"> 528</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="Clustering-529"><a href="#Clustering-529"><span class="linenos"> 529</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;UMAP1&quot;</span><span class="p">],</span> <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;UMAP2&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="Clustering-530"><a href="#Clustering-530"><span class="linenos"> 530</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">)</span>
</span><span id="Clustering-531"><a href="#Clustering-531"><span class="linenos"> 531</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">)</span>
</span><span id="Clustering-532"><a href="#Clustering-532"><span class="linenos"> 532</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Clustering-533"><a href="#Clustering-533"><span class="linenos"> 533</span></a>
</span><span id="Clustering-534"><a href="#Clustering-534"><span class="linenos"> 534</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="Clustering-535"><a href="#Clustering-535"><span class="linenos"> 535</span></a>
</span><span id="Clustering-536"><a href="#Clustering-536"><span class="linenos"> 536</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">umap</span> <span class="o">=</span> <span class="n">umap_df</span>
</span><span id="Clustering-537"><a href="#Clustering-537"><span class="linenos"> 537</span></a>
</span><span id="Clustering-538"><a href="#Clustering-538"><span class="linenos"> 538</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">knee_plot_umap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">min_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
</span><span id="Clustering-539"><a href="#Clustering-539"><span class="linenos"> 539</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering-540"><a href="#Clustering-540"><span class="linenos"> 540</span></a><span class="sd">        Plot silhouette scores for different UMAP dimensions to determine optimal n_components.</span>
</span><span id="Clustering-541"><a href="#Clustering-541"><span class="linenos"> 541</span></a>
</span><span id="Clustering-542"><a href="#Clustering-542"><span class="linenos"> 542</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering-543"><a href="#Clustering-543"><span class="linenos"> 543</span></a><span class="sd">        ----------</span>
</span><span id="Clustering-544"><a href="#Clustering-544"><span class="linenos"> 544</span></a><span class="sd">        eps : float, default 0.5</span>
</span><span id="Clustering-545"><a href="#Clustering-545"><span class="linenos"> 545</span></a><span class="sd">            DBSCAN eps parameter for clustering each UMAP dimension.</span>
</span><span id="Clustering-546"><a href="#Clustering-546"><span class="linenos"> 546</span></a>
</span><span id="Clustering-547"><a href="#Clustering-547"><span class="linenos"> 547</span></a><span class="sd">        min_samples : int, default 10</span>
</span><span id="Clustering-548"><a href="#Clustering-548"><span class="linenos"> 548</span></a><span class="sd">            Minimum number of samples to form a cluster in DBSCAN.</span>
</span><span id="Clustering-549"><a href="#Clustering-549"><span class="linenos"> 549</span></a>
</span><span id="Clustering-550"><a href="#Clustering-550"><span class="linenos"> 550</span></a><span class="sd">        Returns</span>
</span><span id="Clustering-551"><a href="#Clustering-551"><span class="linenos"> 551</span></a><span class="sd">        -------</span>
</span><span id="Clustering-552"><a href="#Clustering-552"><span class="linenos"> 552</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="Clustering-553"><a href="#Clustering-553"><span class="linenos"> 553</span></a><span class="sd">            Silhouette score plot across UMAP dimensions.</span>
</span><span id="Clustering-554"><a href="#Clustering-554"><span class="linenos"> 554</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering-555"><a href="#Clustering-555"><span class="linenos"> 555</span></a>
</span><span id="Clustering-556"><a href="#Clustering-556"><span class="linenos"> 556</span></a>        <span class="n">umap_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">umap</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Clustering-557"><a href="#Clustering-557"><span class="linenos"> 557</span></a>
</span><span id="Clustering-558"><a href="#Clustering-558"><span class="linenos"> 558</span></a>        <span class="n">silhouette_scores</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Clustering-559"><a href="#Clustering-559"><span class="linenos"> 559</span></a>        <span class="n">component</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Clustering-560"><a href="#Clustering-560"><span class="linenos"> 560</span></a>        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">umap_range</span><span class="p">:</span>
</span><span id="Clustering-561"><a href="#Clustering-561"><span class="linenos"> 561</span></a>
</span><span id="Clustering-562"><a href="#Clustering-562"><span class="linenos"> 562</span></a>            <span class="n">db</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="n">min_samples</span><span class="p">)</span>
</span><span id="Clustering-563"><a href="#Clustering-563"><span class="linenos"> 563</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">umap</span><span class="p">)[:,</span> <span class="p">:</span><span class="n">n</span><span class="p">])</span>
</span><span id="Clustering-564"><a href="#Clustering-564"><span class="linenos"> 564</span></a>
</span><span id="Clustering-565"><a href="#Clustering-565"><span class="linenos"> 565</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="Clustering-566"><a href="#Clustering-566"><span class="linenos"> 566</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Clustering-567"><a href="#Clustering-567"><span class="linenos"> 567</span></a>                <span class="n">score</span> <span class="o">=</span> <span class="n">silhouette_score</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">umap</span><span class="p">)[:,</span> <span class="p">:</span><span class="n">n</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
</span><span id="Clustering-568"><a href="#Clustering-568"><span class="linenos"> 568</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering-569"><a href="#Clustering-569"><span class="linenos"> 569</span></a>                <span class="n">score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="Clustering-570"><a href="#Clustering-570"><span class="linenos"> 570</span></a>
</span><span id="Clustering-571"><a href="#Clustering-571"><span class="linenos"> 571</span></a>            <span class="n">silhouette_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
</span><span id="Clustering-572"><a href="#Clustering-572"><span class="linenos"> 572</span></a>            <span class="n">component</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span id="Clustering-573"><a href="#Clustering-573"><span class="linenos"> 573</span></a>
</span><span id="Clustering-574"><a href="#Clustering-574"><span class="linenos"> 574</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="Clustering-575"><a href="#Clustering-575"><span class="linenos"> 575</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">silhouette_scores</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
</span><span id="Clustering-576"><a href="#Clustering-576"><span class="linenos"> 576</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP (n_components)&quot;</span><span class="p">)</span>
</span><span id="Clustering-577"><a href="#Clustering-577"><span class="linenos"> 577</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Silhouette Score&quot;</span><span class="p">)</span>
</span><span id="Clustering-578"><a href="#Clustering-578"><span class="linenos"> 578</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Clustering-579"><a href="#Clustering-579"><span class="linenos"> 579</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">component</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">component</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="Clustering-580"><a href="#Clustering-580"><span class="linenos"> 580</span></a>
</span><span id="Clustering-581"><a href="#Clustering-581"><span class="linenos"> 581</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="Clustering-582"><a href="#Clustering-582"><span class="linenos"> 582</span></a>
</span><span id="Clustering-583"><a href="#Clustering-583"><span class="linenos"> 583</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="Clustering-584"><a href="#Clustering-584"><span class="linenos"> 584</span></a>
</span><span id="Clustering-585"><a href="#Clustering-585"><span class="linenos"> 585</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_clusters_UMAP</span><span class="p">(</span>
</span><span id="Clustering-586"><a href="#Clustering-586"><span class="linenos"> 586</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Clustering-587"><a href="#Clustering-587"><span class="linenos"> 587</span></a>        <span class="n">umap_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="Clustering-588"><a href="#Clustering-588"><span class="linenos"> 588</span></a>        <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="Clustering-589"><a href="#Clustering-589"><span class="linenos"> 589</span></a>        <span class="n">min_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="Clustering-590"><a href="#Clustering-590"><span class="linenos"> 590</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="Clustering-591"><a href="#Clustering-591"><span class="linenos"> 591</span></a>        <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="Clustering-592"><a href="#Clustering-592"><span class="linenos"> 592</span></a>    <span class="p">):</span>
</span><span id="Clustering-593"><a href="#Clustering-593"><span class="linenos"> 593</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering-594"><a href="#Clustering-594"><span class="linenos"> 594</span></a><span class="sd">        Apply DBSCAN clustering on UMAP embeddings and visualize clusters.</span>
</span><span id="Clustering-595"><a href="#Clustering-595"><span class="linenos"> 595</span></a>
</span><span id="Clustering-596"><a href="#Clustering-596"><span class="linenos"> 596</span></a><span class="sd">        This method performs density-based clustering (DBSCAN) on the UMAP-reduced</span>
</span><span id="Clustering-597"><a href="#Clustering-597"><span class="linenos"> 597</span></a><span class="sd">        dataset. Cluster labels are stored in the object&#39;s metadata, and a scatter</span>
</span><span id="Clustering-598"><a href="#Clustering-598"><span class="linenos"> 598</span></a><span class="sd">        plot of the first two UMAP components with cluster annotations is returned.</span>
</span><span id="Clustering-599"><a href="#Clustering-599"><span class="linenos"> 599</span></a>
</span><span id="Clustering-600"><a href="#Clustering-600"><span class="linenos"> 600</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering-601"><a href="#Clustering-601"><span class="linenos"> 601</span></a><span class="sd">        ----------</span>
</span><span id="Clustering-602"><a href="#Clustering-602"><span class="linenos"> 602</span></a><span class="sd">        umap_n : int, default 5</span>
</span><span id="Clustering-603"><a href="#Clustering-603"><span class="linenos"> 603</span></a><span class="sd">            Number of UMAP dimensions to use for DBSCAN clustering.</span>
</span><span id="Clustering-604"><a href="#Clustering-604"><span class="linenos"> 604</span></a><span class="sd">            Must be &lt;= number of columns in `self.umap`.</span>
</span><span id="Clustering-605"><a href="#Clustering-605"><span class="linenos"> 605</span></a>
</span><span id="Clustering-606"><a href="#Clustering-606"><span class="linenos"> 606</span></a><span class="sd">        eps : float | int, default 0.5</span>
</span><span id="Clustering-607"><a href="#Clustering-607"><span class="linenos"> 607</span></a><span class="sd">            Maximum neighborhood distance between two samples for them to be considered</span>
</span><span id="Clustering-608"><a href="#Clustering-608"><span class="linenos"> 608</span></a><span class="sd">            as in the same cluster (DBSCAN parameter).</span>
</span><span id="Clustering-609"><a href="#Clustering-609"><span class="linenos"> 609</span></a>
</span><span id="Clustering-610"><a href="#Clustering-610"><span class="linenos"> 610</span></a><span class="sd">        min_samples : int, default 10</span>
</span><span id="Clustering-611"><a href="#Clustering-611"><span class="linenos"> 611</span></a><span class="sd">            Minimum number of samples in a neighborhood to form a cluster (DBSCAN parameter).</span>
</span><span id="Clustering-612"><a href="#Clustering-612"><span class="linenos"> 612</span></a>
</span><span id="Clustering-613"><a href="#Clustering-613"><span class="linenos"> 613</span></a><span class="sd">        width : int, default 8</span>
</span><span id="Clustering-614"><a href="#Clustering-614"><span class="linenos"> 614</span></a><span class="sd">            Figure width.</span>
</span><span id="Clustering-615"><a href="#Clustering-615"><span class="linenos"> 615</span></a>
</span><span id="Clustering-616"><a href="#Clustering-616"><span class="linenos"> 616</span></a><span class="sd">        height : int, default 6</span>
</span><span id="Clustering-617"><a href="#Clustering-617"><span class="linenos"> 617</span></a><span class="sd">            Figure height.</span>
</span><span id="Clustering-618"><a href="#Clustering-618"><span class="linenos"> 618</span></a>
</span><span id="Clustering-619"><a href="#Clustering-619"><span class="linenos"> 619</span></a><span class="sd">        Returns</span>
</span><span id="Clustering-620"><a href="#Clustering-620"><span class="linenos"> 620</span></a><span class="sd">        -------</span>
</span><span id="Clustering-621"><a href="#Clustering-621"><span class="linenos"> 621</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="Clustering-622"><a href="#Clustering-622"><span class="linenos"> 622</span></a><span class="sd">            Scatter plot of the first two UMAP components colored by</span>
</span><span id="Clustering-623"><a href="#Clustering-623"><span class="linenos"> 623</span></a><span class="sd">            cluster assignments.</span>
</span><span id="Clustering-624"><a href="#Clustering-624"><span class="linenos"> 624</span></a>
</span><span id="Clustering-625"><a href="#Clustering-625"><span class="linenos"> 625</span></a><span class="sd">        Updates</span>
</span><span id="Clustering-626"><a href="#Clustering-626"><span class="linenos"> 626</span></a><span class="sd">        -------</span>
</span><span id="Clustering-627"><a href="#Clustering-627"><span class="linenos"> 627</span></a><span class="sd">        self.clustering_metadata[&#39;UMAP_clusters&#39;] : list</span>
</span><span id="Clustering-628"><a href="#Clustering-628"><span class="linenos"> 628</span></a><span class="sd">            Cluster labels assigned to each cell/sample.</span>
</span><span id="Clustering-629"><a href="#Clustering-629"><span class="linenos"> 629</span></a>
</span><span id="Clustering-630"><a href="#Clustering-630"><span class="linenos"> 630</span></a><span class="sd">        self.input_metadata[&#39;UMAP_clusters&#39;] : list, optional</span>
</span><span id="Clustering-631"><a href="#Clustering-631"><span class="linenos"> 631</span></a><span class="sd">            Cluster labels stored in input metadata (if available).</span>
</span><span id="Clustering-632"><a href="#Clustering-632"><span class="linenos"> 632</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering-633"><a href="#Clustering-633"><span class="linenos"> 633</span></a>
</span><span id="Clustering-634"><a href="#Clustering-634"><span class="linenos"> 634</span></a>        <span class="n">dbscan</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="n">min_samples</span><span class="p">)</span>
</span><span id="Clustering-635"><a href="#Clustering-635"><span class="linenos"> 635</span></a>        <span class="n">dbscan_labels</span> <span class="o">=</span> <span class="n">dbscan</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">umap</span><span class="p">)[:,</span> <span class="p">:</span><span class="n">umap_n</span><span class="p">])</span>
</span><span id="Clustering-636"><a href="#Clustering-636"><span class="linenos"> 636</span></a>
</span><span id="Clustering-637"><a href="#Clustering-637"><span class="linenos"> 637</span></a>        <span class="n">umap_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">umap</span>
</span><span id="Clustering-638"><a href="#Clustering-638"><span class="linenos"> 638</span></a>        <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbscan_labels</span>
</span><span id="Clustering-639"><a href="#Clustering-639"><span class="linenos"> 639</span></a>
</span><span id="Clustering-640"><a href="#Clustering-640"><span class="linenos"> 640</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="Clustering-641"><a href="#Clustering-641"><span class="linenos"> 641</span></a>
</span><span id="Clustering-642"><a href="#Clustering-642"><span class="linenos"> 642</span></a>        <span class="k">for</span> <span class="n">cluster_id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
</span><span id="Clustering-643"><a href="#Clustering-643"><span class="linenos"> 643</span></a>            <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">umap_df</span><span class="p">[</span><span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cluster_id</span><span class="p">]</span>
</span><span id="Clustering-644"><a href="#Clustering-644"><span class="linenos"> 644</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="Clustering-645"><a href="#Clustering-645"><span class="linenos"> 645</span></a>                <span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;UMAP1&quot;</span><span class="p">],</span>
</span><span id="Clustering-646"><a href="#Clustering-646"><span class="linenos"> 646</span></a>                <span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;UMAP2&quot;</span><span class="p">],</span>
</span><span id="Clustering-647"><a href="#Clustering-647"><span class="linenos"> 647</span></a>                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cluster </span><span class="si">{</span><span class="n">cluster_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Clustering-648"><a href="#Clustering-648"><span class="linenos"> 648</span></a>                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span><span id="Clustering-649"><a href="#Clustering-649"><span class="linenos"> 649</span></a>            <span class="p">)</span>
</span><span id="Clustering-650"><a href="#Clustering-650"><span class="linenos"> 650</span></a>
</span><span id="Clustering-651"><a href="#Clustering-651"><span class="linenos"> 651</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">)</span>
</span><span id="Clustering-652"><a href="#Clustering-652"><span class="linenos"> 652</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">)</span>
</span><span id="Clustering-653"><a href="#Clustering-653"><span class="linenos"> 653</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Clusters&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
</span><span id="Clustering-654"><a href="#Clustering-654"><span class="linenos"> 654</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Clustering-655"><a href="#Clustering-655"><span class="linenos"> 655</span></a>
</span><span id="Clustering-656"><a href="#Clustering-656"><span class="linenos"> 656</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;UMAP_clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dbscan_labels</span><span class="p">]</span>
</span><span id="Clustering-657"><a href="#Clustering-657"><span class="linenos"> 657</span></a>
</span><span id="Clustering-658"><a href="#Clustering-658"><span class="linenos"> 658</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Clustering-659"><a href="#Clustering-659"><span class="linenos"> 659</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;UMAP_clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dbscan_labels</span><span class="p">]</span>
</span><span id="Clustering-660"><a href="#Clustering-660"><span class="linenos"> 660</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="Clustering-661"><a href="#Clustering-661"><span class="linenos"> 661</span></a>            <span class="k">pass</span>
</span><span id="Clustering-662"><a href="#Clustering-662"><span class="linenos"> 662</span></a>
</span><span id="Clustering-663"><a href="#Clustering-663"><span class="linenos"> 663</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="Clustering-664"><a href="#Clustering-664"><span class="linenos"> 664</span></a>
</span><span id="Clustering-665"><a href="#Clustering-665"><span class="linenos"> 665</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">UMAP_vis</span><span class="p">(</span>
</span><span id="Clustering-666"><a href="#Clustering-666"><span class="linenos"> 666</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Clustering-667"><a href="#Clustering-667"><span class="linenos"> 667</span></a>        <span class="n">names_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="Clustering-668"><a href="#Clustering-668"><span class="linenos"> 668</span></a>        <span class="n">set_sep</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Clustering-669"><a href="#Clustering-669"><span class="linenos"> 669</span></a>        <span class="n">point_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
</span><span id="Clustering-670"><a href="#Clustering-670"><span class="linenos"> 670</span></a>        <span class="n">font_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="Clustering-671"><a href="#Clustering-671"><span class="linenos"> 671</span></a>        <span class="n">legend_split_col</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="Clustering-672"><a href="#Clustering-672"><span class="linenos"> 672</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="Clustering-673"><a href="#Clustering-673"><span class="linenos"> 673</span></a>        <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="Clustering-674"><a href="#Clustering-674"><span class="linenos"> 674</span></a>        <span class="n">inc_num</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Clustering-675"><a href="#Clustering-675"><span class="linenos"> 675</span></a>    <span class="p">):</span>
</span><span id="Clustering-676"><a href="#Clustering-676"><span class="linenos"> 676</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering-677"><a href="#Clustering-677"><span class="linenos"> 677</span></a><span class="sd">        Visualize UMAP embeddings with sample labels based on specyfic metadata slot.</span>
</span><span id="Clustering-678"><a href="#Clustering-678"><span class="linenos"> 678</span></a>
</span><span id="Clustering-679"><a href="#Clustering-679"><span class="linenos"> 679</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering-680"><a href="#Clustering-680"><span class="linenos"> 680</span></a><span class="sd">        ----------</span>
</span><span id="Clustering-681"><a href="#Clustering-681"><span class="linenos"> 681</span></a><span class="sd">        names_slot : str, default &#39;cell_names&#39;</span>
</span><span id="Clustering-682"><a href="#Clustering-682"><span class="linenos"> 682</span></a><span class="sd">            Column in metadata to use as sample labels.</span>
</span><span id="Clustering-683"><a href="#Clustering-683"><span class="linenos"> 683</span></a>
</span><span id="Clustering-684"><a href="#Clustering-684"><span class="linenos"> 684</span></a><span class="sd">        set_sep : bool, default True</span>
</span><span id="Clustering-685"><a href="#Clustering-685"><span class="linenos"> 685</span></a><span class="sd">            If True, separate points by dataset.</span>
</span><span id="Clustering-686"><a href="#Clustering-686"><span class="linenos"> 686</span></a>
</span><span id="Clustering-687"><a href="#Clustering-687"><span class="linenos"> 687</span></a><span class="sd">        point_size : float, default 0.6</span>
</span><span id="Clustering-688"><a href="#Clustering-688"><span class="linenos"> 688</span></a><span class="sd">            Size of scatter points.</span>
</span><span id="Clustering-689"><a href="#Clustering-689"><span class="linenos"> 689</span></a>
</span><span id="Clustering-690"><a href="#Clustering-690"><span class="linenos"> 690</span></a><span class="sd">        font_size : int, default 6</span>
</span><span id="Clustering-691"><a href="#Clustering-691"><span class="linenos"> 691</span></a><span class="sd">            Font size for numbers on points.</span>
</span><span id="Clustering-692"><a href="#Clustering-692"><span class="linenos"> 692</span></a>
</span><span id="Clustering-693"><a href="#Clustering-693"><span class="linenos"> 693</span></a><span class="sd">        legend_split_col : int, default 2</span>
</span><span id="Clustering-694"><a href="#Clustering-694"><span class="linenos"> 694</span></a><span class="sd">            Number of columns in legend.</span>
</span><span id="Clustering-695"><a href="#Clustering-695"><span class="linenos"> 695</span></a>
</span><span id="Clustering-696"><a href="#Clustering-696"><span class="linenos"> 696</span></a><span class="sd">        width : int, default 8</span>
</span><span id="Clustering-697"><a href="#Clustering-697"><span class="linenos"> 697</span></a><span class="sd">            Figure width.</span>
</span><span id="Clustering-698"><a href="#Clustering-698"><span class="linenos"> 698</span></a>
</span><span id="Clustering-699"><a href="#Clustering-699"><span class="linenos"> 699</span></a><span class="sd">        height : int, default 6</span>
</span><span id="Clustering-700"><a href="#Clustering-700"><span class="linenos"> 700</span></a><span class="sd">            Figure height.</span>
</span><span id="Clustering-701"><a href="#Clustering-701"><span class="linenos"> 701</span></a>
</span><span id="Clustering-702"><a href="#Clustering-702"><span class="linenos"> 702</span></a><span class="sd">        inc_num : bool, default True</span>
</span><span id="Clustering-703"><a href="#Clustering-703"><span class="linenos"> 703</span></a><span class="sd">            If True, annotate points with numeric labels.</span>
</span><span id="Clustering-704"><a href="#Clustering-704"><span class="linenos"> 704</span></a>
</span><span id="Clustering-705"><a href="#Clustering-705"><span class="linenos"> 705</span></a><span class="sd">        Returns</span>
</span><span id="Clustering-706"><a href="#Clustering-706"><span class="linenos"> 706</span></a><span class="sd">        -------</span>
</span><span id="Clustering-707"><a href="#Clustering-707"><span class="linenos"> 707</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="Clustering-708"><a href="#Clustering-708"><span class="linenos"> 708</span></a><span class="sd">            UMAP scatter plot figure.</span>
</span><span id="Clustering-709"><a href="#Clustering-709"><span class="linenos"> 709</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering-710"><a href="#Clustering-710"><span class="linenos"> 710</span></a>
</span><span id="Clustering-711"><a href="#Clustering-711"><span class="linenos"> 711</span></a>        <span class="n">umap_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">umap</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Clustering-712"><a href="#Clustering-712"><span class="linenos"> 712</span></a>        <span class="n">umap_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="n">names_slot</span><span class="p">]</span>
</span><span id="Clustering-713"><a href="#Clustering-713"><span class="linenos"> 713</span></a>
</span><span id="Clustering-714"><a href="#Clustering-714"><span class="linenos"> 714</span></a>        <span class="k">if</span> <span class="n">set_sep</span><span class="p">:</span>
</span><span id="Clustering-715"><a href="#Clustering-715"><span class="linenos"> 715</span></a>
</span><span id="Clustering-716"><a href="#Clustering-716"><span class="linenos"> 716</span></a>            <span class="k">if</span> <span class="s2">&quot;sets&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="Clustering-717"><a href="#Clustering-717"><span class="linenos"> 717</span></a>                <span class="n">umap_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="Clustering-718"><a href="#Clustering-718"><span class="linenos"> 718</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering-719"><a href="#Clustering-719"><span class="linenos"> 719</span></a>                <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
</span><span id="Clustering-720"><a href="#Clustering-720"><span class="linenos"> 720</span></a>
</span><span id="Clustering-721"><a href="#Clustering-721"><span class="linenos"> 721</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering-722"><a href="#Clustering-722"><span class="linenos"> 722</span></a>            <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
</span><span id="Clustering-723"><a href="#Clustering-723"><span class="linenos"> 723</span></a>
</span><span id="Clustering-724"><a href="#Clustering-724"><span class="linenos"> 724</span></a>        <span class="n">umap_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;tmp_nam&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span>
</span><span id="Clustering-725"><a href="#Clustering-725"><span class="linenos"> 725</span></a>
</span><span id="Clustering-726"><a href="#Clustering-726"><span class="linenos"> 726</span></a>        <span class="n">umap_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;tmp_nam&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
</span><span id="Clustering-727"><a href="#Clustering-727"><span class="linenos"> 727</span></a>            <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;tmp_nam&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</span><span id="Clustering-728"><a href="#Clustering-728"><span class="linenos"> 728</span></a>        <span class="p">)</span>
</span><span id="Clustering-729"><a href="#Clustering-729"><span class="linenos"> 729</span></a>
</span><span id="Clustering-730"><a href="#Clustering-730"><span class="linenos"> 730</span></a>        <span class="n">numeric_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Clustering-731"><a href="#Clustering-731"><span class="linenos"> 731</span></a>            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">umap_df</span><span class="p">[[</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="s2">&quot;tmp_nam&quot;</span><span class="p">,</span> <span class="s2">&quot;names&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</span><span id="Clustering-732"><a href="#Clustering-732"><span class="linenos"> 732</span></a>            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
</span><span id="Clustering-733"><a href="#Clustering-733"><span class="linenos"> 733</span></a>            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Clustering-734"><a href="#Clustering-734"><span class="linenos"> 734</span></a>        <span class="p">)</span>
</span><span id="Clustering-735"><a href="#Clustering-735"><span class="linenos"> 735</span></a>        <span class="n">numeric_df</span><span class="p">[</span><span class="s2">&quot;numeric_values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numeric_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Clustering-736"><a href="#Clustering-736"><span class="linenos"> 736</span></a>
</span><span id="Clustering-737"><a href="#Clustering-737"><span class="linenos"> 737</span></a>        <span class="n">umap_df</span> <span class="o">=</span> <span class="n">umap_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
</span><span id="Clustering-738"><a href="#Clustering-738"><span class="linenos"> 738</span></a>            <span class="n">numeric_df</span><span class="p">[[</span><span class="s2">&quot;tmp_nam&quot;</span><span class="p">,</span> <span class="s2">&quot;numeric_values&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;tmp_nam&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
</span><span id="Clustering-739"><a href="#Clustering-739"><span class="linenos"> 739</span></a>        <span class="p">)</span>
</span><span id="Clustering-740"><a href="#Clustering-740"><span class="linenos"> 740</span></a>
</span><span id="Clustering-741"><a href="#Clustering-741"><span class="linenos"> 741</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="Clustering-742"><a href="#Clustering-742"><span class="linenos"> 742</span></a>
</span><span id="Clustering-743"><a href="#Clustering-743"><span class="linenos"> 743</span></a>        <span class="n">markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">]</span>
</span><span id="Clustering-744"><a href="#Clustering-744"><span class="linenos"> 744</span></a>        <span class="n">marker_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Clustering-745"><a href="#Clustering-745"><span class="linenos"> 745</span></a>            <span class="n">ds</span><span class="p">:</span> <span class="n">markers</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">markers</span><span class="p">)]</span>
</span><span id="Clustering-746"><a href="#Clustering-746"><span class="linenos"> 746</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</span><span id="Clustering-747"><a href="#Clustering-747"><span class="linenos"> 747</span></a>        <span class="p">}</span>
</span><span id="Clustering-748"><a href="#Clustering-748"><span class="linenos"> 748</span></a>
</span><span id="Clustering-749"><a href="#Clustering-749"><span class="linenos"> 749</span></a>        <span class="n">cord_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Clustering-750"><a href="#Clustering-750"><span class="linenos"> 750</span></a>
</span><span id="Clustering-751"><a href="#Clustering-751"><span class="linenos"> 751</span></a>        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">nam</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">numeric_df</span><span class="p">[</span><span class="s2">&quot;numeric_values&quot;</span><span class="p">],</span> <span class="n">numeric_df</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]):</span>
</span><span id="Clustering-752"><a href="#Clustering-752"><span class="linenos"> 752</span></a>
</span><span id="Clustering-753"><a href="#Clustering-753"><span class="linenos"> 753</span></a>            <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">umap_df</span><span class="p">[</span><span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;numeric_values&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">num</span><span class="p">]</span>
</span><span id="Clustering-754"><a href="#Clustering-754"><span class="linenos"> 754</span></a>
</span><span id="Clustering-755"><a href="#Clustering-755"><span class="linenos"> 755</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="Clustering-756"><a href="#Clustering-756"><span class="linenos"> 756</span></a>                <span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;UMAP1&quot;</span><span class="p">],</span>
</span><span id="Clustering-757"><a href="#Clustering-757"><span class="linenos"> 757</span></a>                <span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;UMAP2&quot;</span><span class="p">],</span>
</span><span id="Clustering-758"><a href="#Clustering-758"><span class="linenos"> 758</span></a>                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">nam</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Clustering-759"><a href="#Clustering-759"><span class="linenos"> 759</span></a>                <span class="n">marker</span><span class="o">=</span><span class="n">marker_map</span><span class="p">[</span><span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="Clustering-760"><a href="#Clustering-760"><span class="linenos"> 760</span></a>                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
</span><span id="Clustering-761"><a href="#Clustering-761"><span class="linenos"> 761</span></a>                <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span>
</span><span id="Clustering-762"><a href="#Clustering-762"><span class="linenos"> 762</span></a>            <span class="p">)</span>
</span><span id="Clustering-763"><a href="#Clustering-763"><span class="linenos"> 763</span></a>
</span><span id="Clustering-764"><a href="#Clustering-764"><span class="linenos"> 764</span></a>            <span class="n">coords</span> <span class="o">=</span> <span class="n">cluster_data</span><span class="p">[[</span><span class="s2">&quot;UMAP1&quot;</span><span class="p">,</span> <span class="s2">&quot;UMAP2&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="Clustering-765"><a href="#Clustering-765"><span class="linenos"> 765</span></a>
</span><span id="Clustering-766"><a href="#Clustering-766"><span class="linenos"> 766</span></a>            <span class="n">dists</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</span><span id="Clustering-767"><a href="#Clustering-767"><span class="linenos"> 767</span></a>
</span><span id="Clustering-768"><a href="#Clustering-768"><span class="linenos"> 768</span></a>            <span class="n">sum_dists</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Clustering-769"><a href="#Clustering-769"><span class="linenos"> 769</span></a>
</span><span id="Clustering-770"><a href="#Clustering-770"><span class="linenos"> 770</span></a>            <span class="n">center_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">sum_dists</span><span class="p">)</span>
</span><span id="Clustering-771"><a href="#Clustering-771"><span class="linenos"> 771</span></a>            <span class="n">center_point</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">center_idx</span><span class="p">]</span>
</span><span id="Clustering-772"><a href="#Clustering-772"><span class="linenos"> 772</span></a>
</span><span id="Clustering-773"><a href="#Clustering-773"><span class="linenos"> 773</span></a>            <span class="n">cord_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">center_point</span><span class="p">)</span>
</span><span id="Clustering-774"><a href="#Clustering-774"><span class="linenos"> 774</span></a>
</span><span id="Clustering-775"><a href="#Clustering-775"><span class="linenos"> 775</span></a>        <span class="k">if</span> <span class="n">inc_num</span><span class="p">:</span>
</span><span id="Clustering-776"><a href="#Clustering-776"><span class="linenos"> 776</span></a>            <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Clustering-777"><a href="#Clustering-777"><span class="linenos"> 777</span></a>            <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cord_list</span><span class="p">,</span> <span class="n">numeric_df</span><span class="p">[</span><span class="s2">&quot;numeric_values&quot;</span><span class="p">]):</span>
</span><span id="Clustering-778"><a href="#Clustering-778"><span class="linenos"> 778</span></a>                <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Clustering-779"><a href="#Clustering-779"><span class="linenos"> 779</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="Clustering-780"><a href="#Clustering-780"><span class="linenos"> 780</span></a>                        <span class="n">x</span><span class="p">,</span>
</span><span id="Clustering-781"><a href="#Clustering-781"><span class="linenos"> 781</span></a>                        <span class="n">y</span><span class="p">,</span>
</span><span id="Clustering-782"><a href="#Clustering-782"><span class="linenos"> 782</span></a>                        <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">),</span>
</span><span id="Clustering-783"><a href="#Clustering-783"><span class="linenos"> 783</span></a>                        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="Clustering-784"><a href="#Clustering-784"><span class="linenos"> 784</span></a>                        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="Clustering-785"><a href="#Clustering-785"><span class="linenos"> 785</span></a>                        <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
</span><span id="Clustering-786"><a href="#Clustering-786"><span class="linenos"> 786</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="Clustering-787"><a href="#Clustering-787"><span class="linenos"> 787</span></a>                    <span class="p">)</span>
</span><span id="Clustering-788"><a href="#Clustering-788"><span class="linenos"> 788</span></a>                <span class="p">)</span>
</span><span id="Clustering-789"><a href="#Clustering-789"><span class="linenos"> 789</span></a>
</span><span id="Clustering-790"><a href="#Clustering-790"><span class="linenos"> 790</span></a>            <span class="n">adjust_text</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>
</span><span id="Clustering-791"><a href="#Clustering-791"><span class="linenos"> 791</span></a>
</span><span id="Clustering-792"><a href="#Clustering-792"><span class="linenos"> 792</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">)</span>
</span><span id="Clustering-793"><a href="#Clustering-793"><span class="linenos"> 793</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">)</span>
</span><span id="Clustering-794"><a href="#Clustering-794"><span class="linenos"> 794</span></a>
</span><span id="Clustering-795"><a href="#Clustering-795"><span class="linenos"> 795</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="Clustering-796"><a href="#Clustering-796"><span class="linenos"> 796</span></a>            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Clusters&quot;</span><span class="p">,</span>
</span><span id="Clustering-797"><a href="#Clustering-797"><span class="linenos"> 797</span></a>            <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span>
</span><span id="Clustering-798"><a href="#Clustering-798"><span class="linenos"> 798</span></a>            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
</span><span id="Clustering-799"><a href="#Clustering-799"><span class="linenos"> 799</span></a>            <span class="n">ncol</span><span class="o">=</span><span class="n">legend_split_col</span><span class="p">,</span>
</span><span id="Clustering-800"><a href="#Clustering-800"><span class="linenos"> 800</span></a>            <span class="n">markerscale</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="Clustering-801"><a href="#Clustering-801"><span class="linenos"> 801</span></a>        <span class="p">)</span>
</span><span id="Clustering-802"><a href="#Clustering-802"><span class="linenos"> 802</span></a>
</span><span id="Clustering-803"><a href="#Clustering-803"><span class="linenos"> 803</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Clustering-804"><a href="#Clustering-804"><span class="linenos"> 804</span></a>
</span><span id="Clustering-805"><a href="#Clustering-805"><span class="linenos"> 805</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="Clustering-806"><a href="#Clustering-806"><span class="linenos"> 806</span></a>
</span><span id="Clustering-807"><a href="#Clustering-807"><span class="linenos"> 807</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="Clustering-808"><a href="#Clustering-808"><span class="linenos"> 808</span></a>
</span><span id="Clustering-809"><a href="#Clustering-809"><span class="linenos"> 809</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">UMAP_feature</span><span class="p">(</span>
</span><span id="Clustering-810"><a href="#Clustering-810"><span class="linenos"> 810</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Clustering-811"><a href="#Clustering-811"><span class="linenos"> 811</span></a>        <span class="n">feature_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Clustering-812"><a href="#Clustering-812"><span class="linenos"> 812</span></a>        <span class="n">features_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Clustering-813"><a href="#Clustering-813"><span class="linenos"> 813</span></a>        <span class="n">point_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
</span><span id="Clustering-814"><a href="#Clustering-814"><span class="linenos"> 814</span></a>        <span class="n">font_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="Clustering-815"><a href="#Clustering-815"><span class="linenos"> 815</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="Clustering-816"><a href="#Clustering-816"><span class="linenos"> 816</span></a>        <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="Clustering-817"><a href="#Clustering-817"><span class="linenos"> 817</span></a>        <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;light&quot;</span><span class="p">,</span>
</span><span id="Clustering-818"><a href="#Clustering-818"><span class="linenos"> 818</span></a>    <span class="p">):</span>
</span><span id="Clustering-819"><a href="#Clustering-819"><span class="linenos"> 819</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering-820"><a href="#Clustering-820"><span class="linenos"> 820</span></a><span class="sd">        Visualize UMAP embedding with expression levels of a selected feature.</span>
</span><span id="Clustering-821"><a href="#Clustering-821"><span class="linenos"> 821</span></a>
</span><span id="Clustering-822"><a href="#Clustering-822"><span class="linenos"> 822</span></a><span class="sd">        Each point (cell) in the UMAP plot is colored according to the expression</span>
</span><span id="Clustering-823"><a href="#Clustering-823"><span class="linenos"> 823</span></a><span class="sd">        value of the chosen feature, enabling interpretation of spatial patterns</span>
</span><span id="Clustering-824"><a href="#Clustering-824"><span class="linenos"> 824</span></a><span class="sd">        of gene activity or metadata distribution in low-dimensional space.</span>
</span><span id="Clustering-825"><a href="#Clustering-825"><span class="linenos"> 825</span></a>
</span><span id="Clustering-826"><a href="#Clustering-826"><span class="linenos"> 826</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering-827"><a href="#Clustering-827"><span class="linenos"> 827</span></a><span class="sd">        ----------</span>
</span><span id="Clustering-828"><a href="#Clustering-828"><span class="linenos"> 828</span></a><span class="sd">        feature_name : str</span>
</span><span id="Clustering-829"><a href="#Clustering-829"><span class="linenos"> 829</span></a><span class="sd">           Name of the feature to plot.</span>
</span><span id="Clustering-830"><a href="#Clustering-830"><span class="linenos"> 830</span></a>
</span><span id="Clustering-831"><a href="#Clustering-831"><span class="linenos"> 831</span></a><span class="sd">        features_data : pandas.DataFrame or None, default None</span>
</span><span id="Clustering-832"><a href="#Clustering-832"><span class="linenos"> 832</span></a><span class="sd">            If None, the function uses the DataFrame containing the clustering data.</span>
</span><span id="Clustering-833"><a href="#Clustering-833"><span class="linenos"> 833</span></a><span class="sd">            To plot features not used in clustering, provide a wider DataFrame</span>
</span><span id="Clustering-834"><a href="#Clustering-834"><span class="linenos"> 834</span></a><span class="sd">            containing the original feature values.</span>
</span><span id="Clustering-835"><a href="#Clustering-835"><span class="linenos"> 835</span></a>
</span><span id="Clustering-836"><a href="#Clustering-836"><span class="linenos"> 836</span></a><span class="sd">        point_size : float, default 0.6</span>
</span><span id="Clustering-837"><a href="#Clustering-837"><span class="linenos"> 837</span></a><span class="sd">            Size of scatter points in the plot.</span>
</span><span id="Clustering-838"><a href="#Clustering-838"><span class="linenos"> 838</span></a>
</span><span id="Clustering-839"><a href="#Clustering-839"><span class="linenos"> 839</span></a><span class="sd">        font_size : int, default 6</span>
</span><span id="Clustering-840"><a href="#Clustering-840"><span class="linenos"> 840</span></a><span class="sd">            Font size for axis labels and annotations.</span>
</span><span id="Clustering-841"><a href="#Clustering-841"><span class="linenos"> 841</span></a>
</span><span id="Clustering-842"><a href="#Clustering-842"><span class="linenos"> 842</span></a><span class="sd">        width : int, default 8</span>
</span><span id="Clustering-843"><a href="#Clustering-843"><span class="linenos"> 843</span></a><span class="sd">            Width of the matplotlib figure.</span>
</span><span id="Clustering-844"><a href="#Clustering-844"><span class="linenos"> 844</span></a>
</span><span id="Clustering-845"><a href="#Clustering-845"><span class="linenos"> 845</span></a><span class="sd">        height : int, default 6</span>
</span><span id="Clustering-846"><a href="#Clustering-846"><span class="linenos"> 846</span></a><span class="sd">            Height of the matplotlib figure.</span>
</span><span id="Clustering-847"><a href="#Clustering-847"><span class="linenos"> 847</span></a>
</span><span id="Clustering-848"><a href="#Clustering-848"><span class="linenos"> 848</span></a><span class="sd">        palette : str, default &#39;light&#39;</span>
</span><span id="Clustering-849"><a href="#Clustering-849"><span class="linenos"> 849</span></a><span class="sd">            Color palette for expression visualization. Options are:</span>
</span><span id="Clustering-850"><a href="#Clustering-850"><span class="linenos"> 850</span></a><span class="sd">            - &#39;light&#39;</span>
</span><span id="Clustering-851"><a href="#Clustering-851"><span class="linenos"> 851</span></a><span class="sd">            - &#39;dark&#39;</span>
</span><span id="Clustering-852"><a href="#Clustering-852"><span class="linenos"> 852</span></a><span class="sd">            - &#39;green&#39;</span>
</span><span id="Clustering-853"><a href="#Clustering-853"><span class="linenos"> 853</span></a><span class="sd">            - &#39;gray&#39;</span>
</span><span id="Clustering-854"><a href="#Clustering-854"><span class="linenos"> 854</span></a>
</span><span id="Clustering-855"><a href="#Clustering-855"><span class="linenos"> 855</span></a><span class="sd">        Returns</span>
</span><span id="Clustering-856"><a href="#Clustering-856"><span class="linenos"> 856</span></a><span class="sd">        -------</span>
</span><span id="Clustering-857"><a href="#Clustering-857"><span class="linenos"> 857</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="Clustering-858"><a href="#Clustering-858"><span class="linenos"> 858</span></a><span class="sd">            UMAP scatter plot colored by feature values.</span>
</span><span id="Clustering-859"><a href="#Clustering-859"><span class="linenos"> 859</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering-860"><a href="#Clustering-860"><span class="linenos"> 860</span></a>
</span><span id="Clustering-861"><a href="#Clustering-861"><span class="linenos"> 861</span></a>        <span class="n">umap_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">umap</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Clustering-862"><a href="#Clustering-862"><span class="linenos"> 862</span></a>
</span><span id="Clustering-863"><a href="#Clustering-863"><span class="linenos"> 863</span></a>        <span class="k">if</span> <span class="n">features_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Clustering-864"><a href="#Clustering-864"><span class="linenos"> 864</span></a>
</span><span id="Clustering-865"><a href="#Clustering-865"><span class="linenos"> 865</span></a>            <span class="n">features_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_data</span>
</span><span id="Clustering-866"><a href="#Clustering-866"><span class="linenos"> 866</span></a>
</span><span id="Clustering-867"><a href="#Clustering-867"><span class="linenos"> 867</span></a>        <span class="k">if</span> <span class="n">features_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">umap_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="Clustering-868"><a href="#Clustering-868"><span class="linenos"> 868</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Clustering-869"><a href="#Clustering-869"><span class="linenos"> 869</span></a>                <span class="s2">&quot;Imputed &#39;features_data&#39; shape does not match the number of UMAP cells&quot;</span>
</span><span id="Clustering-870"><a href="#Clustering-870"><span class="linenos"> 870</span></a>            <span class="p">)</span>
</span><span id="Clustering-871"><a href="#Clustering-871"><span class="linenos"> 871</span></a>
</span><span id="Clustering-872"><a href="#Clustering-872"><span class="linenos"> 872</span></a>        <span class="n">blist</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Clustering-873"><a href="#Clustering-873"><span class="linenos"> 873</span></a>            <span class="kc">True</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">feature_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
</span><span id="Clustering-874"><a href="#Clustering-874"><span class="linenos"> 874</span></a>            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">features_data</span><span class="o">.</span><span class="n">index</span>
</span><span id="Clustering-875"><a href="#Clustering-875"><span class="linenos"> 875</span></a>        <span class="p">]</span>
</span><span id="Clustering-876"><a href="#Clustering-876"><span class="linenos"> 876</span></a>
</span><span id="Clustering-877"><a href="#Clustering-877"><span class="linenos"> 877</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">blist</span><span class="p">):</span>
</span><span id="Clustering-878"><a href="#Clustering-878"><span class="linenos"> 878</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Imputed feature_name is not included in the data&quot;</span><span class="p">)</span>
</span><span id="Clustering-879"><a href="#Clustering-879"><span class="linenos"> 879</span></a>
</span><span id="Clustering-880"><a href="#Clustering-880"><span class="linenos"> 880</span></a>        <span class="n">umap_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;feature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Clustering-881"><a href="#Clustering-881"><span class="linenos"> 881</span></a>            <span class="n">features_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">blist</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="Clustering-882"><a href="#Clustering-882"><span class="linenos"> 882</span></a>            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Clustering-883"><a href="#Clustering-883"><span class="linenos"> 883</span></a>            <span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Clustering-884"><a href="#Clustering-884"><span class="linenos"> 884</span></a>        <span class="p">)</span>
</span><span id="Clustering-885"><a href="#Clustering-885"><span class="linenos"> 885</span></a>
</span><span id="Clustering-886"><a href="#Clustering-886"><span class="linenos"> 886</span></a>        <span class="n">umap_df</span> <span class="o">=</span> <span class="n">umap_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;feature&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Clustering-887"><a href="#Clustering-887"><span class="linenos"> 887</span></a>
</span><span id="Clustering-888"><a href="#Clustering-888"><span class="linenos"> 888</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mcolors</span>
</span><span id="Clustering-889"><a href="#Clustering-889"><span class="linenos"> 889</span></a>
</span><span id="Clustering-890"><a href="#Clustering-890"><span class="linenos"> 890</span></a>        <span class="k">if</span> <span class="n">palette</span> <span class="o">==</span> <span class="s2">&quot;light&quot;</span><span class="p">:</span>
</span><span id="Clustering-891"><a href="#Clustering-891"><span class="linenos"> 891</span></a>            <span class="n">palette</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">sequential</span><span class="o">.</span><span class="n">Sunsetdark</span>
</span><span id="Clustering-892"><a href="#Clustering-892"><span class="linenos"> 892</span></a>
</span><span id="Clustering-893"><a href="#Clustering-893"><span class="linenos"> 893</span></a>        <span class="k">elif</span> <span class="n">palette</span> <span class="o">==</span> <span class="s2">&quot;dark&quot;</span><span class="p">:</span>
</span><span id="Clustering-894"><a href="#Clustering-894"><span class="linenos"> 894</span></a>            <span class="n">palette</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">sequential</span><span class="o">.</span><span class="n">thermal</span>
</span><span id="Clustering-895"><a href="#Clustering-895"><span class="linenos"> 895</span></a>
</span><span id="Clustering-896"><a href="#Clustering-896"><span class="linenos"> 896</span></a>        <span class="k">elif</span> <span class="n">palette</span> <span class="o">==</span> <span class="s2">&quot;green&quot;</span><span class="p">:</span>
</span><span id="Clustering-897"><a href="#Clustering-897"><span class="linenos"> 897</span></a>            <span class="n">palette</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">sequential</span><span class="o">.</span><span class="n">Aggrnyl</span>
</span><span id="Clustering-898"><a href="#Clustering-898"><span class="linenos"> 898</span></a>
</span><span id="Clustering-899"><a href="#Clustering-899"><span class="linenos"> 899</span></a>        <span class="k">elif</span> <span class="n">palette</span> <span class="o">==</span> <span class="s2">&quot;gray&quot;</span><span class="p">:</span>
</span><span id="Clustering-900"><a href="#Clustering-900"><span class="linenos"> 900</span></a>            <span class="n">palette</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">sequential</span><span class="o">.</span><span class="n">gray</span>
</span><span id="Clustering-901"><a href="#Clustering-901"><span class="linenos"> 901</span></a>            <span class="n">palette</span> <span class="o">=</span> <span class="n">palette</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Clustering-902"><a href="#Clustering-902"><span class="linenos"> 902</span></a>
</span><span id="Clustering-903"><a href="#Clustering-903"><span class="linenos"> 903</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering-904"><a href="#Clustering-904"><span class="linenos"> 904</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Clustering-905"><a href="#Clustering-905"><span class="linenos"> 905</span></a>                <span class="s1">&#39;Palette not found. Use: &quot;light&quot;, &quot;dark&quot;, &quot;gray&quot;, or &quot;green&quot;&#39;</span>
</span><span id="Clustering-906"><a href="#Clustering-906"><span class="linenos"> 906</span></a>            <span class="p">)</span>
</span><span id="Clustering-907"><a href="#Clustering-907"><span class="linenos"> 907</span></a>
</span><span id="Clustering-908"><a href="#Clustering-908"><span class="linenos"> 908</span></a>        <span class="n">converted</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Clustering-909"><a href="#Clustering-909"><span class="linenos"> 909</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">palette</span><span class="p">:</span>
</span><span id="Clustering-910"><a href="#Clustering-910"><span class="linenos"> 910</span></a>            <span class="n">rgb_255</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">unlabel_rgb</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span id="Clustering-911"><a href="#Clustering-911"><span class="linenos"> 911</span></a>            <span class="n">rgb_01</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span> <span class="o">/</span> <span class="mf">255.0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rgb_255</span><span class="p">)</span>
</span><span id="Clustering-912"><a href="#Clustering-912"><span class="linenos"> 912</span></a>            <span class="n">converted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rgb_01</span><span class="p">)</span>
</span><span id="Clustering-913"><a href="#Clustering-913"><span class="linenos"> 913</span></a>
</span><span id="Clustering-914"><a href="#Clustering-914"><span class="linenos"> 914</span></a>        <span class="n">my_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">converted</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;custom&quot;</span><span class="p">)</span>
</span><span id="Clustering-915"><a href="#Clustering-915"><span class="linenos"> 915</span></a>
</span><span id="Clustering-916"><a href="#Clustering-916"><span class="linenos"> 916</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="Clustering-917"><a href="#Clustering-917"><span class="linenos"> 917</span></a>        <span class="n">sc</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="Clustering-918"><a href="#Clustering-918"><span class="linenos"> 918</span></a>            <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;UMAP1&quot;</span><span class="p">],</span>
</span><span id="Clustering-919"><a href="#Clustering-919"><span class="linenos"> 919</span></a>            <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;UMAP2&quot;</span><span class="p">],</span>
</span><span id="Clustering-920"><a href="#Clustering-920"><span class="linenos"> 920</span></a>            <span class="n">c</span><span class="o">=</span><span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">],</span>
</span><span id="Clustering-921"><a href="#Clustering-921"><span class="linenos"> 921</span></a>            <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span>
</span><span id="Clustering-922"><a href="#Clustering-922"><span class="linenos"> 922</span></a>            <span class="n">cmap</span><span class="o">=</span><span class="n">my_cmap</span><span class="p">,</span>
</span><span id="Clustering-923"><a href="#Clustering-923"><span class="linenos"> 923</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="Clustering-924"><a href="#Clustering-924"><span class="linenos"> 924</span></a>            <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="Clustering-925"><a href="#Clustering-925"><span class="linenos"> 925</span></a>            <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="Clustering-926"><a href="#Clustering-926"><span class="linenos"> 926</span></a>        <span class="p">)</span>
</span><span id="Clustering-927"><a href="#Clustering-927"><span class="linenos"> 927</span></a>
</span><span id="Clustering-928"><a href="#Clustering-928"><span class="linenos"> 928</span></a>        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</span><span id="Clustering-929"><a href="#Clustering-929"><span class="linenos"> 929</span></a>        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feature_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Clustering-930"><a href="#Clustering-930"><span class="linenos"> 930</span></a>
</span><span id="Clustering-931"><a href="#Clustering-931"><span class="linenos"> 931</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">)</span>
</span><span id="Clustering-932"><a href="#Clustering-932"><span class="linenos"> 932</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">)</span>
</span><span id="Clustering-933"><a href="#Clustering-933"><span class="linenos"> 933</span></a>
</span><span id="Clustering-934"><a href="#Clustering-934"><span class="linenos"> 934</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Clustering-935"><a href="#Clustering-935"><span class="linenos"> 935</span></a>
</span><span id="Clustering-936"><a href="#Clustering-936"><span class="linenos"> 936</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="Clustering-937"><a href="#Clustering-937"><span class="linenos"> 937</span></a>
</span><span id="Clustering-938"><a href="#Clustering-938"><span class="linenos"> 938</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="Clustering-939"><a href="#Clustering-939"><span class="linenos"> 939</span></a>
</span><span id="Clustering-940"><a href="#Clustering-940"><span class="linenos"> 940</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_umap_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Clustering-941"><a href="#Clustering-941"><span class="linenos"> 941</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering-942"><a href="#Clustering-942"><span class="linenos"> 942</span></a><span class="sd">        Retrieve UMAP embedding data with optional cluster labels.</span>
</span><span id="Clustering-943"><a href="#Clustering-943"><span class="linenos"> 943</span></a>
</span><span id="Clustering-944"><a href="#Clustering-944"><span class="linenos"> 944</span></a><span class="sd">        Returns the UMAP coordinates stored in `self.umap`. If clustering</span>
</span><span id="Clustering-945"><a href="#Clustering-945"><span class="linenos"> 945</span></a><span class="sd">        metadata is available (specifically `UMAP_clusters`), the corresponding</span>
</span><span id="Clustering-946"><a href="#Clustering-946"><span class="linenos"> 946</span></a><span class="sd">        cluster assignments are appended as an additional column.</span>
</span><span id="Clustering-947"><a href="#Clustering-947"><span class="linenos"> 947</span></a>
</span><span id="Clustering-948"><a href="#Clustering-948"><span class="linenos"> 948</span></a><span class="sd">        Returns</span>
</span><span id="Clustering-949"><a href="#Clustering-949"><span class="linenos"> 949</span></a><span class="sd">        -------</span>
</span><span id="Clustering-950"><a href="#Clustering-950"><span class="linenos"> 950</span></a><span class="sd">        pandas.DataFrame</span>
</span><span id="Clustering-951"><a href="#Clustering-951"><span class="linenos"> 951</span></a><span class="sd">            DataFrame containing UMAP coordinates (columns: &#39;UMAP1&#39;, &#39;UMAP2&#39;, ...).</span>
</span><span id="Clustering-952"><a href="#Clustering-952"><span class="linenos"> 952</span></a><span class="sd">            If available, includes an extra column &#39;clusters&#39; with cluster labels.</span>
</span><span id="Clustering-953"><a href="#Clustering-953"><span class="linenos"> 953</span></a>
</span><span id="Clustering-954"><a href="#Clustering-954"><span class="linenos"> 954</span></a><span class="sd">        Notes</span>
</span><span id="Clustering-955"><a href="#Clustering-955"><span class="linenos"> 955</span></a><span class="sd">        -----</span>
</span><span id="Clustering-956"><a href="#Clustering-956"><span class="linenos"> 956</span></a><span class="sd">        - UMAP embeddings must be computed beforehand (e.g., using `perform_UMAP`).</span>
</span><span id="Clustering-957"><a href="#Clustering-957"><span class="linenos"> 957</span></a><span class="sd">        - Cluster labels are added only if present in `self.clustering_metadata`.</span>
</span><span id="Clustering-958"><a href="#Clustering-958"><span class="linenos"> 958</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering-959"><a href="#Clustering-959"><span class="linenos"> 959</span></a>
</span><span id="Clustering-960"><a href="#Clustering-960"><span class="linenos"> 960</span></a>        <span class="n">umap_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">umap</span>
</span><span id="Clustering-961"><a href="#Clustering-961"><span class="linenos"> 961</span></a>
</span><span id="Clustering-962"><a href="#Clustering-962"><span class="linenos"> 962</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Clustering-963"><a href="#Clustering-963"><span class="linenos"> 963</span></a>            <span class="n">umap_data</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;UMAP_clusters&quot;</span><span class="p">]</span>
</span><span id="Clustering-964"><a href="#Clustering-964"><span class="linenos"> 964</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="Clustering-965"><a href="#Clustering-965"><span class="linenos"> 965</span></a>            <span class="k">pass</span>
</span><span id="Clustering-966"><a href="#Clustering-966"><span class="linenos"> 966</span></a>
</span><span id="Clustering-967"><a href="#Clustering-967"><span class="linenos"> 967</span></a>        <span class="k">return</span> <span class="n">umap_data</span>
</span><span id="Clustering-968"><a href="#Clustering-968"><span class="linenos"> 968</span></a>
</span><span id="Clustering-969"><a href="#Clustering-969"><span class="linenos"> 969</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_pca_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Clustering-970"><a href="#Clustering-970"><span class="linenos"> 970</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering-971"><a href="#Clustering-971"><span class="linenos"> 971</span></a><span class="sd">        Retrieve PCA embedding data with optional cluster labels.</span>
</span><span id="Clustering-972"><a href="#Clustering-972"><span class="linenos"> 972</span></a>
</span><span id="Clustering-973"><a href="#Clustering-973"><span class="linenos"> 973</span></a><span class="sd">        Returns the principal component scores stored in `self.pca`. If clustering</span>
</span><span id="Clustering-974"><a href="#Clustering-974"><span class="linenos"> 974</span></a><span class="sd">        metadata is available (specifically `PCA_clusters`), the corresponding</span>
</span><span id="Clustering-975"><a href="#Clustering-975"><span class="linenos"> 975</span></a><span class="sd">        cluster assignments are appended as an additional column.</span>
</span><span id="Clustering-976"><a href="#Clustering-976"><span class="linenos"> 976</span></a>
</span><span id="Clustering-977"><a href="#Clustering-977"><span class="linenos"> 977</span></a><span class="sd">        Returns</span>
</span><span id="Clustering-978"><a href="#Clustering-978"><span class="linenos"> 978</span></a><span class="sd">        -------</span>
</span><span id="Clustering-979"><a href="#Clustering-979"><span class="linenos"> 979</span></a><span class="sd">        pandas.DataFrame</span>
</span><span id="Clustering-980"><a href="#Clustering-980"><span class="linenos"> 980</span></a><span class="sd">            DataFrame containing PCA coordinates (columns: &#39;PC1&#39;, &#39;PC2&#39;, ...).</span>
</span><span id="Clustering-981"><a href="#Clustering-981"><span class="linenos"> 981</span></a><span class="sd">            If available, includes an extra column &#39;clusters&#39; with cluster labels.</span>
</span><span id="Clustering-982"><a href="#Clustering-982"><span class="linenos"> 982</span></a>
</span><span id="Clustering-983"><a href="#Clustering-983"><span class="linenos"> 983</span></a><span class="sd">        Notes</span>
</span><span id="Clustering-984"><a href="#Clustering-984"><span class="linenos"> 984</span></a><span class="sd">        -----</span>
</span><span id="Clustering-985"><a href="#Clustering-985"><span class="linenos"> 985</span></a><span class="sd">        - PCA must be computed beforehand (e.g., using `perform_PCA`).</span>
</span><span id="Clustering-986"><a href="#Clustering-986"><span class="linenos"> 986</span></a><span class="sd">        - Cluster labels are added only if present in `self.clustering_metadata`.</span>
</span><span id="Clustering-987"><a href="#Clustering-987"><span class="linenos"> 987</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering-988"><a href="#Clustering-988"><span class="linenos"> 988</span></a>
</span><span id="Clustering-989"><a href="#Clustering-989"><span class="linenos"> 989</span></a>        <span class="n">pca_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca</span>
</span><span id="Clustering-990"><a href="#Clustering-990"><span class="linenos"> 990</span></a>
</span><span id="Clustering-991"><a href="#Clustering-991"><span class="linenos"> 991</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Clustering-992"><a href="#Clustering-992"><span class="linenos"> 992</span></a>            <span class="n">pca_data</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;PCA_clusters&quot;</span><span class="p">]</span>
</span><span id="Clustering-993"><a href="#Clustering-993"><span class="linenos"> 993</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="Clustering-994"><a href="#Clustering-994"><span class="linenos"> 994</span></a>            <span class="k">pass</span>
</span><span id="Clustering-995"><a href="#Clustering-995"><span class="linenos"> 995</span></a>
</span><span id="Clustering-996"><a href="#Clustering-996"><span class="linenos"> 996</span></a>        <span class="k">return</span> <span class="n">pca_data</span>
</span><span id="Clustering-997"><a href="#Clustering-997"><span class="linenos"> 997</span></a>
</span><span id="Clustering-998"><a href="#Clustering-998"><span class="linenos"> 998</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">return_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clusters</span><span class="o">=</span><span class="s2">&quot;umap&quot;</span><span class="p">):</span>
</span><span id="Clustering-999"><a href="#Clustering-999"><span class="linenos"> 999</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering-1000"><a href="#Clustering-1000"><span class="linenos">1000</span></a><span class="sd">        Retrieve cluster labels from UMAP or PCA clustering results.</span>
</span><span id="Clustering-1001"><a href="#Clustering-1001"><span class="linenos">1001</span></a>
</span><span id="Clustering-1002"><a href="#Clustering-1002"><span class="linenos">1002</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering-1003"><a href="#Clustering-1003"><span class="linenos">1003</span></a><span class="sd">        ----------</span>
</span><span id="Clustering-1004"><a href="#Clustering-1004"><span class="linenos">1004</span></a><span class="sd">        clusters : str, default &#39;umap&#39;</span>
</span><span id="Clustering-1005"><a href="#Clustering-1005"><span class="linenos">1005</span></a><span class="sd">            Source of cluster labels to return. Must be one of:</span>
</span><span id="Clustering-1006"><a href="#Clustering-1006"><span class="linenos">1006</span></a><span class="sd">            - &#39;umap&#39;: return cluster labels from UMAP embeddings.</span>
</span><span id="Clustering-1007"><a href="#Clustering-1007"><span class="linenos">1007</span></a><span class="sd">            - &#39;pca&#39; : return cluster labels from PCA embeddings.</span>
</span><span id="Clustering-1008"><a href="#Clustering-1008"><span class="linenos">1008</span></a>
</span><span id="Clustering-1009"><a href="#Clustering-1009"><span class="linenos">1009</span></a><span class="sd">        Returns</span>
</span><span id="Clustering-1010"><a href="#Clustering-1010"><span class="linenos">1010</span></a><span class="sd">        -------</span>
</span><span id="Clustering-1011"><a href="#Clustering-1011"><span class="linenos">1011</span></a><span class="sd">        list</span>
</span><span id="Clustering-1012"><a href="#Clustering-1012"><span class="linenos">1012</span></a><span class="sd">            Cluster labels corresponding to the selected embedding method.</span>
</span><span id="Clustering-1013"><a href="#Clustering-1013"><span class="linenos">1013</span></a>
</span><span id="Clustering-1014"><a href="#Clustering-1014"><span class="linenos">1014</span></a><span class="sd">        Raises</span>
</span><span id="Clustering-1015"><a href="#Clustering-1015"><span class="linenos">1015</span></a><span class="sd">        ------</span>
</span><span id="Clustering-1016"><a href="#Clustering-1016"><span class="linenos">1016</span></a><span class="sd">        ValueError</span>
</span><span id="Clustering-1017"><a href="#Clustering-1017"><span class="linenos">1017</span></a><span class="sd">            If `clusters` is not &#39;umap&#39; or &#39;pca&#39;.</span>
</span><span id="Clustering-1018"><a href="#Clustering-1018"><span class="linenos">1018</span></a>
</span><span id="Clustering-1019"><a href="#Clustering-1019"><span class="linenos">1019</span></a><span class="sd">        Notes</span>
</span><span id="Clustering-1020"><a href="#Clustering-1020"><span class="linenos">1020</span></a><span class="sd">        -----</span>
</span><span id="Clustering-1021"><a href="#Clustering-1021"><span class="linenos">1021</span></a><span class="sd">        Requires that clustering has already been performed</span>
</span><span id="Clustering-1022"><a href="#Clustering-1022"><span class="linenos">1022</span></a><span class="sd">        (e.g., using `find_clusters_UMAP` or `find_clusters_PCA`).</span>
</span><span id="Clustering-1023"><a href="#Clustering-1023"><span class="linenos">1023</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering-1024"><a href="#Clustering-1024"><span class="linenos">1024</span></a>
</span><span id="Clustering-1025"><a href="#Clustering-1025"><span class="linenos">1025</span></a>        <span class="k">if</span> <span class="n">clusters</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;umap&quot;</span><span class="p">:</span>
</span><span id="Clustering-1026"><a href="#Clustering-1026"><span class="linenos">1026</span></a>            <span class="n">clusters_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;UMAP_clusters&quot;</span><span class="p">]</span>
</span><span id="Clustering-1027"><a href="#Clustering-1027"><span class="linenos">1027</span></a>        <span class="k">elif</span> <span class="n">clusters</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;pca&quot;</span><span class="p">:</span>
</span><span id="Clustering-1028"><a href="#Clustering-1028"><span class="linenos">1028</span></a>            <span class="n">clusters_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;PCA_clusters&quot;</span><span class="p">]</span>
</span><span id="Clustering-1029"><a href="#Clustering-1029"><span class="linenos">1029</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering-1030"><a href="#Clustering-1030"><span class="linenos">1030</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parameter &#39;clusters&#39; must be either &#39;umap&#39; or &#39;pca&#39;.&quot;</span><span class="p">)</span>
</span><span id="Clustering-1031"><a href="#Clustering-1031"><span class="linenos">1031</span></a>
</span><span id="Clustering-1032"><a href="#Clustering-1032"><span class="linenos">1032</span></a>        <span class="k">return</span> <span class="n">clusters_vector</span>
</span></pre></div>


            <div class="docstring"><p>A class for performing dimensionality reduction, clustering, and visualization
on high-dimensional data (e.g., single-cell gene expression).</p>

<p>The class provides methods for:</p>

<ul>
<li>Normalizing and extracting subsets of data</li>
<li>Principal Component Analysis (PCA) and related clustering</li>
<li>Uniform Manifold Approximation and Projection (UMAP) and clustering</li>
<li>Visualization of PCA and UMAP embeddings</li>
<li>Harmonization of batch effects</li>
<li>Accessing processed data and cluster labels</li>
</ul>

<h2 id="methods">Methods</h2>

<p>add_data_frame(data, metadata)
    Class method to create a Clustering instance from a DataFrame and metadata.</p>

<p>harmonize_sets()
    Perform batch effect harmonization on PCA data.</p>

<p>perform_PCA(pc_num=100, width=8, height=6)
    Perform PCA on the dataset and visualize the first two PCs.</p>

<p>knee_plot_PCA(width=8, height=6)
    Plot the cumulative variance explained by PCs to determine optimal dimensionality.</p>

<p>find_clusters_PCA(pc_num=0, eps=0.5, min_samples=10, width=8, height=6, harmonized=False)
    Apply DBSCAN clustering to PCA embeddings and visualize results.</p>

<p>perform_UMAP(factorize=False, umap_num=100, pc_num=0, harmonized=False, ...)
    Compute UMAP embeddings with optional parameter tuning.</p>

<p>knee_plot_umap(eps=0.5, min_samples=10)
    Determine optimal UMAP dimensionality using silhouette scores.</p>

<p>find_clusters_UMAP(umap_n=5, eps=0.5, min_samples=10, width=8, height=6)
    Apply DBSCAN clustering on UMAP embeddings and visualize clusters.</p>

<p>UMAP_vis(names_slot='cell_names', set_sep=True, point_size=0.6, ...)
    Visualize UMAP embeddings with labels and optional cluster numbering.</p>

<p>UMAP_feature(feature_name, features_data=None, point_size=0.6, ...)
    Plot a single feature over UMAP coordinates with customizable colormap.</p>

<p>get_umap_data()
    Return the UMAP embeddings along with cluster labels if available.</p>

<p>get_pca_data()
    Return the PCA results along with cluster labels if available.</p>

<p>return_clusters(clusters='umap')
    Return the cluster labels for UMAP or PCA embeddings.</p>

<h2 id="raises">Raises</h2>

<p>ValueError
    For invalid parameters, mismatched dimensions, or missing metadata.</p>
</div>


                            <div id="Clustering.__init__" class="classattr">
                                        <input id="Clustering.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Clustering</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">data</span>, </span><span class="param"><span class="n">metadata</span></span>)</span>

                <label class="view-source-button" for="Clustering.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Clustering.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Clustering.__init__-91"><a href="#Clustering.__init__-91"><span class="linenos"> 91</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
</span><span id="Clustering.__init__-92"><a href="#Clustering.__init__-92"><span class="linenos"> 92</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering.__init__-93"><a href="#Clustering.__init__-93"><span class="linenos"> 93</span></a><span class="sd">        Initialize the clustering class with data and optional metadata.</span>
</span><span id="Clustering.__init__-94"><a href="#Clustering.__init__-94"><span class="linenos"> 94</span></a>
</span><span id="Clustering.__init__-95"><a href="#Clustering.__init__-95"><span class="linenos"> 95</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering.__init__-96"><a href="#Clustering.__init__-96"><span class="linenos"> 96</span></a><span class="sd">        ----------</span>
</span><span id="Clustering.__init__-97"><a href="#Clustering.__init__-97"><span class="linenos"> 97</span></a><span class="sd">        data : pandas.DataFrame</span>
</span><span id="Clustering.__init__-98"><a href="#Clustering.__init__-98"><span class="linenos"> 98</span></a><span class="sd">            Input data for clustering. Columns are considered as samples.</span>
</span><span id="Clustering.__init__-99"><a href="#Clustering.__init__-99"><span class="linenos"> 99</span></a>
</span><span id="Clustering.__init__-100"><a href="#Clustering.__init__-100"><span class="linenos">100</span></a><span class="sd">        metadata : pandas.DataFrame, optional</span>
</span><span id="Clustering.__init__-101"><a href="#Clustering.__init__-101"><span class="linenos">101</span></a><span class="sd">            Metadata for the samples. If None, a default DataFrame with column</span>
</span><span id="Clustering.__init__-102"><a href="#Clustering.__init__-102"><span class="linenos">102</span></a><span class="sd">            names as &#39;cell_names&#39; is created.</span>
</span><span id="Clustering.__init__-103"><a href="#Clustering.__init__-103"><span class="linenos">103</span></a>
</span><span id="Clustering.__init__-104"><a href="#Clustering.__init__-104"><span class="linenos">104</span></a><span class="sd">        Attributes</span>
</span><span id="Clustering.__init__-105"><a href="#Clustering.__init__-105"><span class="linenos">105</span></a><span class="sd">        ----------</span>
</span><span id="Clustering.__init__-106"><a href="#Clustering.__init__-106"><span class="linenos">106</span></a><span class="sd">        -clustering_data : pandas.DataFrame</span>
</span><span id="Clustering.__init__-107"><a href="#Clustering.__init__-107"><span class="linenos">107</span></a><span class="sd">        -clustering_metadata : pandas.DataFrame</span>
</span><span id="Clustering.__init__-108"><a href="#Clustering.__init__-108"><span class="linenos">108</span></a><span class="sd">        -subclusters : None or dict</span>
</span><span id="Clustering.__init__-109"><a href="#Clustering.__init__-109"><span class="linenos">109</span></a><span class="sd">        -explained_var : None or numpy.ndarray</span>
</span><span id="Clustering.__init__-110"><a href="#Clustering.__init__-110"><span class="linenos">110</span></a><span class="sd">        -cumulative_var : None or numpy.ndarray</span>
</span><span id="Clustering.__init__-111"><a href="#Clustering.__init__-111"><span class="linenos">111</span></a><span class="sd">        -pca : None or pandas.DataFrame</span>
</span><span id="Clustering.__init__-112"><a href="#Clustering.__init__-112"><span class="linenos">112</span></a><span class="sd">        -harmonized_pca : None or pandas.DataFrame</span>
</span><span id="Clustering.__init__-113"><a href="#Clustering.__init__-113"><span class="linenos">113</span></a><span class="sd">        -umap : None or pandas.DataFrame</span>
</span><span id="Clustering.__init__-114"><a href="#Clustering.__init__-114"><span class="linenos">114</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering.__init__-115"><a href="#Clustering.__init__-115"><span class="linenos">115</span></a>
</span><span id="Clustering.__init__-116"><a href="#Clustering.__init__-116"><span class="linenos">116</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_data</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="Clustering.__init__-117"><a href="#Clustering.__init__-117"><span class="linenos">117</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The input data used for clustering.&quot;&quot;&quot;</span>
</span><span id="Clustering.__init__-118"><a href="#Clustering.__init__-118"><span class="linenos">118</span></a>
</span><span id="Clustering.__init__-119"><a href="#Clustering.__init__-119"><span class="linenos">119</span></a>        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Clustering.__init__-120"><a href="#Clustering.__init__-120"><span class="linenos">120</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;cell_names&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)})</span>
</span><span id="Clustering.__init__-121"><a href="#Clustering.__init__-121"><span class="linenos">121</span></a>
</span><span id="Clustering.__init__-122"><a href="#Clustering.__init__-122"><span class="linenos">122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span> <span class="o">=</span> <span class="n">metadata</span>
</span><span id="Clustering.__init__-123"><a href="#Clustering.__init__-123"><span class="linenos">123</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Metadata associated with the samples.&quot;&quot;&quot;</span>
</span><span id="Clustering.__init__-124"><a href="#Clustering.__init__-124"><span class="linenos">124</span></a>
</span><span id="Clustering.__init__-125"><a href="#Clustering.__init__-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Clustering.__init__-126"><a href="#Clustering.__init__-126"><span class="linenos">126</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Placeholder for storing subcluster information.&quot;&quot;&quot;</span>
</span><span id="Clustering.__init__-127"><a href="#Clustering.__init__-127"><span class="linenos">127</span></a>
</span><span id="Clustering.__init__-128"><a href="#Clustering.__init__-128"><span class="linenos">128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">explained_var</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Clustering.__init__-129"><a href="#Clustering.__init__-129"><span class="linenos">129</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Explained variance from PCA, initialized as None.&quot;&quot;&quot;</span>
</span><span id="Clustering.__init__-130"><a href="#Clustering.__init__-130"><span class="linenos">130</span></a>
</span><span id="Clustering.__init__-131"><a href="#Clustering.__init__-131"><span class="linenos">131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_var</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Clustering.__init__-132"><a href="#Clustering.__init__-132"><span class="linenos">132</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Cumulative explained variance from PCA, initialized as None.&quot;&quot;&quot;</span>
</span><span id="Clustering.__init__-133"><a href="#Clustering.__init__-133"><span class="linenos">133</span></a>
</span><span id="Clustering.__init__-134"><a href="#Clustering.__init__-134"><span class="linenos">134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pca</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Clustering.__init__-135"><a href="#Clustering.__init__-135"><span class="linenos">135</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;PCA-transformed data, initialized as None.&quot;&quot;&quot;</span>
</span><span id="Clustering.__init__-136"><a href="#Clustering.__init__-136"><span class="linenos">136</span></a>
</span><span id="Clustering.__init__-137"><a href="#Clustering.__init__-137"><span class="linenos">137</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Clustering.__init__-138"><a href="#Clustering.__init__-138"><span class="linenos">138</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;PCA data after batch effect harmonization, initialized as None.&quot;&quot;&quot;</span>
</span><span id="Clustering.__init__-139"><a href="#Clustering.__init__-139"><span class="linenos">139</span></a>
</span><span id="Clustering.__init__-140"><a href="#Clustering.__init__-140"><span class="linenos">140</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">umap</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Clustering.__init__-141"><a href="#Clustering.__init__-141"><span class="linenos">141</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;UMAP embeddings, initialized as None.&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the clustering class with data and optional metadata.</p>

<h2 id="parameters">Parameters</h2>

<p>data : pandas.DataFrame
    Input data for clustering. Columns are considered as samples.</p>

<p>metadata : pandas.DataFrame, optional
    Metadata for the samples. If None, a default DataFrame with column
    names as 'cell_names' is created.</p>

<h2 id="attributes">Attributes</h2>

<p>-clustering_data : pandas.DataFrame
-clustering_metadata : pandas.DataFrame
-subclusters : None or dict
-explained_var : None or numpy.ndarray
-cumulative_var : None or numpy.ndarray
-pca : None or pandas.DataFrame
-harmonized_pca : None or pandas.DataFrame
-umap : None or pandas.DataFrame</p>
</div>


                            </div>
                            <div id="Clustering.clustering_data" class="classattr">
                                <div class="attr variable">
            <span class="name">clustering_data</span>

        
    </div>
    <a class="headerlink" href="#Clustering.clustering_data"></a>
    
            <div class="docstring"><p>The input data used for clustering.</p>
</div>


                            </div>
                            <div id="Clustering.clustering_metadata" class="classattr">
                                <div class="attr variable">
            <span class="name">clustering_metadata</span>

        
    </div>
    <a class="headerlink" href="#Clustering.clustering_metadata"></a>
    
            <div class="docstring"><p>Metadata associated with the samples.</p>
</div>


                            </div>
                            <div id="Clustering.subclusters" class="classattr">
                                <div class="attr variable">
            <span class="name">subclusters</span>

        
    </div>
    <a class="headerlink" href="#Clustering.subclusters"></a>
    
            <div class="docstring"><p>Placeholder for storing subcluster information.</p>
</div>


                            </div>
                            <div id="Clustering.explained_var" class="classattr">
                                <div class="attr variable">
            <span class="name">explained_var</span>

        
    </div>
    <a class="headerlink" href="#Clustering.explained_var"></a>
    
            <div class="docstring"><p>Explained variance from PCA, initialized as None.</p>
</div>


                            </div>
                            <div id="Clustering.cumulative_var" class="classattr">
                                <div class="attr variable">
            <span class="name">cumulative_var</span>

        
    </div>
    <a class="headerlink" href="#Clustering.cumulative_var"></a>
    
            <div class="docstring"><p>Cumulative explained variance from PCA, initialized as None.</p>
</div>


                            </div>
                            <div id="Clustering.pca" class="classattr">
                                <div class="attr variable">
            <span class="name">pca</span>

        
    </div>
    <a class="headerlink" href="#Clustering.pca"></a>
    
            <div class="docstring"><p>PCA-transformed data, initialized as None.</p>
</div>


                            </div>
                            <div id="Clustering.harmonized_pca" class="classattr">
                                <div class="attr variable">
            <span class="name">harmonized_pca</span>

        
    </div>
    <a class="headerlink" href="#Clustering.harmonized_pca"></a>
    
            <div class="docstring"><p>PCA data after batch effect harmonization, initialized as None.</p>
</div>


                            </div>
                            <div id="Clustering.umap" class="classattr">
                                <div class="attr variable">
            <span class="name">umap</span>

        
    </div>
    <a class="headerlink" href="#Clustering.umap"></a>
    
            <div class="docstring"><p>UMAP embeddings, initialized as None.</p>
</div>


                            </div>
                            <div id="Clustering.add_data_frame" class="classattr">
                                        <input id="Clustering.add_data_frame-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">add_data_frame</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>,</span><span class="param">	<span class="n">metadata</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Clustering.add_data_frame-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Clustering.add_data_frame"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Clustering.add_data_frame-143"><a href="#Clustering.add_data_frame-143"><span class="linenos">143</span></a>    <span class="nd">@classmethod</span>
</span><span id="Clustering.add_data_frame-144"><a href="#Clustering.add_data_frame-144"><span class="linenos">144</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_data_frame</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Clustering.add_data_frame-145"><a href="#Clustering.add_data_frame-145"><span class="linenos">145</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering.add_data_frame-146"><a href="#Clustering.add_data_frame-146"><span class="linenos">146</span></a><span class="sd">        Create a Clustering instance from a DataFrame and optional metadata.</span>
</span><span id="Clustering.add_data_frame-147"><a href="#Clustering.add_data_frame-147"><span class="linenos">147</span></a>
</span><span id="Clustering.add_data_frame-148"><a href="#Clustering.add_data_frame-148"><span class="linenos">148</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering.add_data_frame-149"><a href="#Clustering.add_data_frame-149"><span class="linenos">149</span></a><span class="sd">        ----------</span>
</span><span id="Clustering.add_data_frame-150"><a href="#Clustering.add_data_frame-150"><span class="linenos">150</span></a><span class="sd">        data : pandas.DataFrame</span>
</span><span id="Clustering.add_data_frame-151"><a href="#Clustering.add_data_frame-151"><span class="linenos">151</span></a><span class="sd">            Input data with features as rows and samples/cells as columns.</span>
</span><span id="Clustering.add_data_frame-152"><a href="#Clustering.add_data_frame-152"><span class="linenos">152</span></a>
</span><span id="Clustering.add_data_frame-153"><a href="#Clustering.add_data_frame-153"><span class="linenos">153</span></a><span class="sd">        metadata : pandas.DataFrame or None</span>
</span><span id="Clustering.add_data_frame-154"><a href="#Clustering.add_data_frame-154"><span class="linenos">154</span></a><span class="sd">            Optional metadata for the samples.</span>
</span><span id="Clustering.add_data_frame-155"><a href="#Clustering.add_data_frame-155"><span class="linenos">155</span></a><span class="sd">            Each row corresponds to a sample/cell, and column names in this DataFrame</span>
</span><span id="Clustering.add_data_frame-156"><a href="#Clustering.add_data_frame-156"><span class="linenos">156</span></a><span class="sd">            should match the sample/cell names in `data`. Columns can contain additional</span>
</span><span id="Clustering.add_data_frame-157"><a href="#Clustering.add_data_frame-157"><span class="linenos">157</span></a><span class="sd">            information such as cell type, experimental condition, batch, sets, etc.</span>
</span><span id="Clustering.add_data_frame-158"><a href="#Clustering.add_data_frame-158"><span class="linenos">158</span></a>
</span><span id="Clustering.add_data_frame-159"><a href="#Clustering.add_data_frame-159"><span class="linenos">159</span></a><span class="sd">        Returns</span>
</span><span id="Clustering.add_data_frame-160"><a href="#Clustering.add_data_frame-160"><span class="linenos">160</span></a><span class="sd">        -------</span>
</span><span id="Clustering.add_data_frame-161"><a href="#Clustering.add_data_frame-161"><span class="linenos">161</span></a><span class="sd">        Clustering</span>
</span><span id="Clustering.add_data_frame-162"><a href="#Clustering.add_data_frame-162"><span class="linenos">162</span></a><span class="sd">            A new instance of the Clustering class.</span>
</span><span id="Clustering.add_data_frame-163"><a href="#Clustering.add_data_frame-163"><span class="linenos">163</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering.add_data_frame-164"><a href="#Clustering.add_data_frame-164"><span class="linenos">164</span></a>
</span><span id="Clustering.add_data_frame-165"><a href="#Clustering.add_data_frame-165"><span class="linenos">165</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create a Clustering instance from a DataFrame and optional metadata.</p>

<h2 id="parameters">Parameters</h2>

<p>data : pandas.DataFrame
    Input data with features as rows and samples/cells as columns.</p>

<p>metadata : pandas.DataFrame or None
    Optional metadata for the samples.
    Each row corresponds to a sample/cell, and column names in this DataFrame
    should match the sample/cell names in <code>data</code>. Columns can contain additional
    information such as cell type, experimental condition, batch, sets, etc.</p>

<h2 id="returns">Returns</h2>

<p>Clustering
    A new instance of the Clustering class.</p>
</div>


                            </div>
                            <div id="Clustering.harmonize_sets" class="classattr">
                                        <input id="Clustering.harmonize_sets-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">harmonize_sets</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">batch_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;sets&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Clustering.harmonize_sets-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Clustering.harmonize_sets"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Clustering.harmonize_sets-167"><a href="#Clustering.harmonize_sets-167"><span class="linenos">167</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">harmonize_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sets&quot;</span><span class="p">):</span>
</span><span id="Clustering.harmonize_sets-168"><a href="#Clustering.harmonize_sets-168"><span class="linenos">168</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering.harmonize_sets-169"><a href="#Clustering.harmonize_sets-169"><span class="linenos">169</span></a><span class="sd">        Perform batch effect harmonization on PCA embeddings.</span>
</span><span id="Clustering.harmonize_sets-170"><a href="#Clustering.harmonize_sets-170"><span class="linenos">170</span></a>
</span><span id="Clustering.harmonize_sets-171"><a href="#Clustering.harmonize_sets-171"><span class="linenos">171</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering.harmonize_sets-172"><a href="#Clustering.harmonize_sets-172"><span class="linenos">172</span></a><span class="sd">        ----------</span>
</span><span id="Clustering.harmonize_sets-173"><a href="#Clustering.harmonize_sets-173"><span class="linenos">173</span></a><span class="sd">        batch_col : str, default &#39;sets&#39;</span>
</span><span id="Clustering.harmonize_sets-174"><a href="#Clustering.harmonize_sets-174"><span class="linenos">174</span></a><span class="sd">            Name of the column in `metadata` that contains batch information for the samples/cells.</span>
</span><span id="Clustering.harmonize_sets-175"><a href="#Clustering.harmonize_sets-175"><span class="linenos">175</span></a>
</span><span id="Clustering.harmonize_sets-176"><a href="#Clustering.harmonize_sets-176"><span class="linenos">176</span></a><span class="sd">        Returns</span>
</span><span id="Clustering.harmonize_sets-177"><a href="#Clustering.harmonize_sets-177"><span class="linenos">177</span></a><span class="sd">        -------</span>
</span><span id="Clustering.harmonize_sets-178"><a href="#Clustering.harmonize_sets-178"><span class="linenos">178</span></a><span class="sd">        None</span>
</span><span id="Clustering.harmonize_sets-179"><a href="#Clustering.harmonize_sets-179"><span class="linenos">179</span></a><span class="sd">            Updates the `harmonized_pca` attribute with harmonized data.</span>
</span><span id="Clustering.harmonize_sets-180"><a href="#Clustering.harmonize_sets-180"><span class="linenos">180</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering.harmonize_sets-181"><a href="#Clustering.harmonize_sets-181"><span class="linenos">181</span></a>
</span><span id="Clustering.harmonize_sets-182"><a href="#Clustering.harmonize_sets-182"><span class="linenos">182</span></a>        <span class="n">data_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="p">)</span>
</span><span id="Clustering.harmonize_sets-183"><a href="#Clustering.harmonize_sets-183"><span class="linenos">183</span></a>
</span><span id="Clustering.harmonize_sets-184"><a href="#Clustering.harmonize_sets-184"><span class="linenos">184</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span>
</span><span id="Clustering.harmonize_sets-185"><a href="#Clustering.harmonize_sets-185"><span class="linenos">185</span></a>
</span><span id="Clustering.harmonize_sets-186"><a href="#Clustering.harmonize_sets-186"><span class="linenos">186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="Clustering.harmonize_sets-187"><a href="#Clustering.harmonize_sets-187"><span class="linenos">187</span></a>            <span class="n">harmonize</span><span class="o">.</span><span class="n">run_harmony</span><span class="p">(</span><span class="n">data_mat</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">vars_use</span><span class="o">=</span><span class="n">batch_col</span><span class="p">)</span><span class="o">.</span><span class="n">Z_corr</span>
</span><span id="Clustering.harmonize_sets-188"><a href="#Clustering.harmonize_sets-188"><span class="linenos">188</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span id="Clustering.harmonize_sets-189"><a href="#Clustering.harmonize_sets-189"><span class="linenos">189</span></a>
</span><span id="Clustering.harmonize_sets-190"><a href="#Clustering.harmonize_sets-190"><span class="linenos">190</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="o">.</span><span class="n">columns</span>
</span></pre></div>


            <div class="docstring"><p>Perform batch effect harmonization on PCA embeddings.</p>

<h2 id="parameters">Parameters</h2>

<p>batch_col : str, default 'sets'
    Name of the column in <code>metadata</code> that contains batch information for the samples/cells.</p>

<h2 id="returns">Returns</h2>

<p>None
    Updates the <code><a href="#Clustering.harmonized_pca">harmonized_pca</a></code> attribute with harmonized data.</p>
</div>


                            </div>
                            <div id="Clustering.perform_PCA" class="classattr">
                                        <input id="Clustering.perform_PCA-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">perform_PCA</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">pc_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>, </span><span class="param"><span class="n">width</span><span class="o">=</span><span class="mi">8</span>, </span><span class="param"><span class="n">height</span><span class="o">=</span><span class="mi">6</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Clustering.perform_PCA-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Clustering.perform_PCA"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Clustering.perform_PCA-192"><a href="#Clustering.perform_PCA-192"><span class="linenos">192</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">perform_PCA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pc_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
</span><span id="Clustering.perform_PCA-193"><a href="#Clustering.perform_PCA-193"><span class="linenos">193</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering.perform_PCA-194"><a href="#Clustering.perform_PCA-194"><span class="linenos">194</span></a><span class="sd">        Perform Principal Component Analysis (PCA) on the dataset.</span>
</span><span id="Clustering.perform_PCA-195"><a href="#Clustering.perform_PCA-195"><span class="linenos">195</span></a>
</span><span id="Clustering.perform_PCA-196"><a href="#Clustering.perform_PCA-196"><span class="linenos">196</span></a><span class="sd">        This method standardizes the data, applies PCA, stores results as attributes,</span>
</span><span id="Clustering.perform_PCA-197"><a href="#Clustering.perform_PCA-197"><span class="linenos">197</span></a><span class="sd">        and generates a scatter plot of the first two principal components.</span>
</span><span id="Clustering.perform_PCA-198"><a href="#Clustering.perform_PCA-198"><span class="linenos">198</span></a>
</span><span id="Clustering.perform_PCA-199"><a href="#Clustering.perform_PCA-199"><span class="linenos">199</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering.perform_PCA-200"><a href="#Clustering.perform_PCA-200"><span class="linenos">200</span></a><span class="sd">        ----------</span>
</span><span id="Clustering.perform_PCA-201"><a href="#Clustering.perform_PCA-201"><span class="linenos">201</span></a><span class="sd">        pc_num : int, default 100</span>
</span><span id="Clustering.perform_PCA-202"><a href="#Clustering.perform_PCA-202"><span class="linenos">202</span></a><span class="sd">            Number of principal components to compute.</span>
</span><span id="Clustering.perform_PCA-203"><a href="#Clustering.perform_PCA-203"><span class="linenos">203</span></a><span class="sd">            If 0, computes all available components.</span>
</span><span id="Clustering.perform_PCA-204"><a href="#Clustering.perform_PCA-204"><span class="linenos">204</span></a>
</span><span id="Clustering.perform_PCA-205"><a href="#Clustering.perform_PCA-205"><span class="linenos">205</span></a><span class="sd">        width : int or float, default 8</span>
</span><span id="Clustering.perform_PCA-206"><a href="#Clustering.perform_PCA-206"><span class="linenos">206</span></a><span class="sd">            Width of the PCA figure.</span>
</span><span id="Clustering.perform_PCA-207"><a href="#Clustering.perform_PCA-207"><span class="linenos">207</span></a>
</span><span id="Clustering.perform_PCA-208"><a href="#Clustering.perform_PCA-208"><span class="linenos">208</span></a><span class="sd">        height : int or float, default 6</span>
</span><span id="Clustering.perform_PCA-209"><a href="#Clustering.perform_PCA-209"><span class="linenos">209</span></a><span class="sd">            Height of the PCA figure.</span>
</span><span id="Clustering.perform_PCA-210"><a href="#Clustering.perform_PCA-210"><span class="linenos">210</span></a>
</span><span id="Clustering.perform_PCA-211"><a href="#Clustering.perform_PCA-211"><span class="linenos">211</span></a><span class="sd">        Returns</span>
</span><span id="Clustering.perform_PCA-212"><a href="#Clustering.perform_PCA-212"><span class="linenos">212</span></a><span class="sd">        -------</span>
</span><span id="Clustering.perform_PCA-213"><a href="#Clustering.perform_PCA-213"><span class="linenos">213</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="Clustering.perform_PCA-214"><a href="#Clustering.perform_PCA-214"><span class="linenos">214</span></a><span class="sd">            Scatter plot showing the first two principal components.</span>
</span><span id="Clustering.perform_PCA-215"><a href="#Clustering.perform_PCA-215"><span class="linenos">215</span></a>
</span><span id="Clustering.perform_PCA-216"><a href="#Clustering.perform_PCA-216"><span class="linenos">216</span></a><span class="sd">        Updates</span>
</span><span id="Clustering.perform_PCA-217"><a href="#Clustering.perform_PCA-217"><span class="linenos">217</span></a><span class="sd">        -------</span>
</span><span id="Clustering.perform_PCA-218"><a href="#Clustering.perform_PCA-218"><span class="linenos">218</span></a><span class="sd">        self.pca : pandas.DataFrame</span>
</span><span id="Clustering.perform_PCA-219"><a href="#Clustering.perform_PCA-219"><span class="linenos">219</span></a><span class="sd">            DataFrame with principal component scores for each sample.</span>
</span><span id="Clustering.perform_PCA-220"><a href="#Clustering.perform_PCA-220"><span class="linenos">220</span></a>
</span><span id="Clustering.perform_PCA-221"><a href="#Clustering.perform_PCA-221"><span class="linenos">221</span></a><span class="sd">        self.explained_var : numpy.ndarray</span>
</span><span id="Clustering.perform_PCA-222"><a href="#Clustering.perform_PCA-222"><span class="linenos">222</span></a><span class="sd">            Percentage of variance explained by each principal component.</span>
</span><span id="Clustering.perform_PCA-223"><a href="#Clustering.perform_PCA-223"><span class="linenos">223</span></a>
</span><span id="Clustering.perform_PCA-224"><a href="#Clustering.perform_PCA-224"><span class="linenos">224</span></a><span class="sd">        self.cumulative_var : numpy.ndarray</span>
</span><span id="Clustering.perform_PCA-225"><a href="#Clustering.perform_PCA-225"><span class="linenos">225</span></a><span class="sd">            Cumulative explained variance.</span>
</span><span id="Clustering.perform_PCA-226"><a href="#Clustering.perform_PCA-226"><span class="linenos">226</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering.perform_PCA-227"><a href="#Clustering.perform_PCA-227"><span class="linenos">227</span></a>
</span><span id="Clustering.perform_PCA-228"><a href="#Clustering.perform_PCA-228"><span class="linenos">228</span></a>        <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
</span><span id="Clustering.perform_PCA-229"><a href="#Clustering.perform_PCA-229"><span class="linenos">229</span></a>        <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clustering_data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="Clustering.perform_PCA-230"><a href="#Clustering.perform_PCA-230"><span class="linenos">230</span></a>
</span><span id="Clustering.perform_PCA-231"><a href="#Clustering.perform_PCA-231"><span class="linenos">231</span></a>        <span class="k">if</span> <span class="n">pc_num</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pc_num</span> <span class="o">&gt;</span> <span class="n">data_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="Clustering.perform_PCA-232"><a href="#Clustering.perform_PCA-232"><span class="linenos">232</span></a>            <span class="n">pc_num</span> <span class="o">=</span> <span class="n">data_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Clustering.perform_PCA-233"><a href="#Clustering.perform_PCA-233"><span class="linenos">233</span></a>
</span><span id="Clustering.perform_PCA-234"><a href="#Clustering.perform_PCA-234"><span class="linenos">234</span></a>        <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">pc_num</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</span><span id="Clustering.perform_PCA-235"><a href="#Clustering.perform_PCA-235"><span class="linenos">235</span></a>
</span><span id="Clustering.perform_PCA-236"><a href="#Clustering.perform_PCA-236"><span class="linenos">236</span></a>        <span class="n">principal_components</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">)</span>
</span><span id="Clustering.perform_PCA-237"><a href="#Clustering.perform_PCA-237"><span class="linenos">237</span></a>
</span><span id="Clustering.perform_PCA-238"><a href="#Clustering.perform_PCA-238"><span class="linenos">238</span></a>        <span class="n">pca_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="Clustering.perform_PCA-239"><a href="#Clustering.perform_PCA-239"><span class="linenos">239</span></a>            <span class="n">data</span><span class="o">=</span><span class="n">principal_components</span><span class="p">,</span>
</span><span id="Clustering.perform_PCA-240"><a href="#Clustering.perform_PCA-240"><span class="linenos">240</span></a>            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;PC&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pc_num</span><span class="p">)],</span>
</span><span id="Clustering.perform_PCA-241"><a href="#Clustering.perform_PCA-241"><span class="linenos">241</span></a>        <span class="p">)</span>
</span><span id="Clustering.perform_PCA-242"><a href="#Clustering.perform_PCA-242"><span class="linenos">242</span></a>
</span><span id="Clustering.perform_PCA-243"><a href="#Clustering.perform_PCA-243"><span class="linenos">243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">explained_var</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="Clustering.perform_PCA-244"><a href="#Clustering.perform_PCA-244"><span class="linenos">244</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explained_var</span><span class="p">)</span>
</span><span id="Clustering.perform_PCA-245"><a href="#Clustering.perform_PCA-245"><span class="linenos">245</span></a>
</span><span id="Clustering.perform_PCA-246"><a href="#Clustering.perform_PCA-246"><span class="linenos">246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pca</span> <span class="o">=</span> <span class="n">pca_df</span>
</span><span id="Clustering.perform_PCA-247"><a href="#Clustering.perform_PCA-247"><span class="linenos">247</span></a>
</span><span id="Clustering.perform_PCA-248"><a href="#Clustering.perform_PCA-248"><span class="linenos">248</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="Clustering.perform_PCA-249"><a href="#Clustering.perform_PCA-249"><span class="linenos">249</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pca_df</span><span class="p">[</span><span class="s2">&quot;PC1&quot;</span><span class="p">],</span> <span class="n">pca_df</span><span class="p">[</span><span class="s2">&quot;PC2&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="Clustering.perform_PCA-250"><a href="#Clustering.perform_PCA-250"><span class="linenos">250</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;PC 1&quot;</span><span class="p">)</span>
</span><span id="Clustering.perform_PCA-251"><a href="#Clustering.perform_PCA-251"><span class="linenos">251</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;PC 2&quot;</span><span class="p">)</span>
</span><span id="Clustering.perform_PCA-252"><a href="#Clustering.perform_PCA-252"><span class="linenos">252</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Clustering.perform_PCA-253"><a href="#Clustering.perform_PCA-253"><span class="linenos">253</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="Clustering.perform_PCA-254"><a href="#Clustering.perform_PCA-254"><span class="linenos">254</span></a>
</span><span id="Clustering.perform_PCA-255"><a href="#Clustering.perform_PCA-255"><span class="linenos">255</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span></pre></div>


            <div class="docstring"><p>Perform Principal Component Analysis (PCA) on the dataset.</p>

<p>This method standardizes the data, applies PCA, stores results as attributes,
and generates a scatter plot of the first two principal components.</p>

<h2 id="parameters">Parameters</h2>

<p>pc_num : int, default 100
    Number of principal components to compute.
    If 0, computes all available components.</p>

<p>width : int or float, default 8
    Width of the PCA figure.</p>

<p>height : int or float, default 6
    Height of the PCA figure.</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.figure.Figure
    Scatter plot showing the first two principal components.</p>

<h2 id="updates">Updates</h2>

<p>self.pca : pandas.DataFrame
    DataFrame with principal component scores for each sample.</p>

<p>self.explained_var : numpy.ndarray
    Percentage of variance explained by each principal component.</p>

<p>self.cumulative_var : numpy.ndarray
    Cumulative explained variance.</p>
</div>


                            </div>
                            <div id="Clustering.knee_plot_PCA" class="classattr">
                                        <input id="Clustering.knee_plot_PCA-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">knee_plot_PCA</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>, </span><span class="param"><span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Clustering.knee_plot_PCA-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Clustering.knee_plot_PCA"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Clustering.knee_plot_PCA-257"><a href="#Clustering.knee_plot_PCA-257"><span class="linenos">257</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">knee_plot_PCA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">):</span>
</span><span id="Clustering.knee_plot_PCA-258"><a href="#Clustering.knee_plot_PCA-258"><span class="linenos">258</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering.knee_plot_PCA-259"><a href="#Clustering.knee_plot_PCA-259"><span class="linenos">259</span></a><span class="sd">        Plot cumulative explained variance to determine the optimal number of PCs.</span>
</span><span id="Clustering.knee_plot_PCA-260"><a href="#Clustering.knee_plot_PCA-260"><span class="linenos">260</span></a>
</span><span id="Clustering.knee_plot_PCA-261"><a href="#Clustering.knee_plot_PCA-261"><span class="linenos">261</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering.knee_plot_PCA-262"><a href="#Clustering.knee_plot_PCA-262"><span class="linenos">262</span></a><span class="sd">        ----------</span>
</span><span id="Clustering.knee_plot_PCA-263"><a href="#Clustering.knee_plot_PCA-263"><span class="linenos">263</span></a><span class="sd">        width : int, default 8</span>
</span><span id="Clustering.knee_plot_PCA-264"><a href="#Clustering.knee_plot_PCA-264"><span class="linenos">264</span></a><span class="sd">            Width of the figure.</span>
</span><span id="Clustering.knee_plot_PCA-265"><a href="#Clustering.knee_plot_PCA-265"><span class="linenos">265</span></a>
</span><span id="Clustering.knee_plot_PCA-266"><a href="#Clustering.knee_plot_PCA-266"><span class="linenos">266</span></a><span class="sd">        height : int or, default 6</span>
</span><span id="Clustering.knee_plot_PCA-267"><a href="#Clustering.knee_plot_PCA-267"><span class="linenos">267</span></a><span class="sd">            Height of the figure.</span>
</span><span id="Clustering.knee_plot_PCA-268"><a href="#Clustering.knee_plot_PCA-268"><span class="linenos">268</span></a>
</span><span id="Clustering.knee_plot_PCA-269"><a href="#Clustering.knee_plot_PCA-269"><span class="linenos">269</span></a><span class="sd">        Returns</span>
</span><span id="Clustering.knee_plot_PCA-270"><a href="#Clustering.knee_plot_PCA-270"><span class="linenos">270</span></a><span class="sd">        -------</span>
</span><span id="Clustering.knee_plot_PCA-271"><a href="#Clustering.knee_plot_PCA-271"><span class="linenos">271</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="Clustering.knee_plot_PCA-272"><a href="#Clustering.knee_plot_PCA-272"><span class="linenos">272</span></a><span class="sd">            Line plot showing cumulative variance explained by each PC.</span>
</span><span id="Clustering.knee_plot_PCA-273"><a href="#Clustering.knee_plot_PCA-273"><span class="linenos">273</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering.knee_plot_PCA-274"><a href="#Clustering.knee_plot_PCA-274"><span class="linenos">274</span></a>
</span><span id="Clustering.knee_plot_PCA-275"><a href="#Clustering.knee_plot_PCA-275"><span class="linenos">275</span></a>        <span class="n">fig_knee</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="Clustering.knee_plot_PCA-276"><a href="#Clustering.knee_plot_PCA-276"><span class="linenos">276</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explained_var</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_var</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
</span><span id="Clustering.knee_plot_PCA-277"><a href="#Clustering.knee_plot_PCA-277"><span class="linenos">277</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;PC (n components)&quot;</span><span class="p">)</span>
</span><span id="Clustering.knee_plot_PCA-278"><a href="#Clustering.knee_plot_PCA-278"><span class="linenos">278</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative explained variance (%)&quot;</span><span class="p">)</span>
</span><span id="Clustering.knee_plot_PCA-279"><a href="#Clustering.knee_plot_PCA-279"><span class="linenos">279</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Clustering.knee_plot_PCA-280"><a href="#Clustering.knee_plot_PCA-280"><span class="linenos">280</span></a>
</span><span id="Clustering.knee_plot_PCA-281"><a href="#Clustering.knee_plot_PCA-281"><span class="linenos">281</span></a>        <span class="n">xticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explained_var</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="Clustering.knee_plot_PCA-282"><a href="#Clustering.knee_plot_PCA-282"><span class="linenos">282</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="Clustering.knee_plot_PCA-283"><a href="#Clustering.knee_plot_PCA-283"><span class="linenos">283</span></a>
</span><span id="Clustering.knee_plot_PCA-284"><a href="#Clustering.knee_plot_PCA-284"><span class="linenos">284</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="Clustering.knee_plot_PCA-285"><a href="#Clustering.knee_plot_PCA-285"><span class="linenos">285</span></a>
</span><span id="Clustering.knee_plot_PCA-286"><a href="#Clustering.knee_plot_PCA-286"><span class="linenos">286</span></a>        <span class="k">return</span> <span class="n">fig_knee</span>
</span></pre></div>


            <div class="docstring"><p>Plot cumulative explained variance to determine the optimal number of PCs.</p>

<h2 id="parameters">Parameters</h2>

<p>width : int, default 8
    Width of the figure.</p>

<p>height : int or, default 6
    Height of the figure.</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.figure.Figure
    Line plot showing cumulative variance explained by each PC.</p>
</div>


                            </div>
                            <div id="Clustering.find_clusters_PCA" class="classattr">
                                        <input id="Clustering.find_clusters_PCA-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">find_clusters_PCA</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">pc_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>,</span><span class="param">	<span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span>,</span><span class="param">	<span class="n">min_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>,</span><span class="param">	<span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span>,</span><span class="param">	<span class="n">harmonized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Clustering.find_clusters_PCA-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Clustering.find_clusters_PCA"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Clustering.find_clusters_PCA-288"><a href="#Clustering.find_clusters_PCA-288"><span class="linenos">288</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_clusters_PCA</span><span class="p">(</span>
</span><span id="Clustering.find_clusters_PCA-289"><a href="#Clustering.find_clusters_PCA-289"><span class="linenos">289</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Clustering.find_clusters_PCA-290"><a href="#Clustering.find_clusters_PCA-290"><span class="linenos">290</span></a>        <span class="n">pc_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="Clustering.find_clusters_PCA-291"><a href="#Clustering.find_clusters_PCA-291"><span class="linenos">291</span></a>        <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="Clustering.find_clusters_PCA-292"><a href="#Clustering.find_clusters_PCA-292"><span class="linenos">292</span></a>        <span class="n">min_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="Clustering.find_clusters_PCA-293"><a href="#Clustering.find_clusters_PCA-293"><span class="linenos">293</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="Clustering.find_clusters_PCA-294"><a href="#Clustering.find_clusters_PCA-294"><span class="linenos">294</span></a>        <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="Clustering.find_clusters_PCA-295"><a href="#Clustering.find_clusters_PCA-295"><span class="linenos">295</span></a>        <span class="n">harmonized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Clustering.find_clusters_PCA-296"><a href="#Clustering.find_clusters_PCA-296"><span class="linenos">296</span></a>    <span class="p">):</span>
</span><span id="Clustering.find_clusters_PCA-297"><a href="#Clustering.find_clusters_PCA-297"><span class="linenos">297</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering.find_clusters_PCA-298"><a href="#Clustering.find_clusters_PCA-298"><span class="linenos">298</span></a><span class="sd">        Apply DBSCAN clustering to PCA embeddings and visualize the results.</span>
</span><span id="Clustering.find_clusters_PCA-299"><a href="#Clustering.find_clusters_PCA-299"><span class="linenos">299</span></a>
</span><span id="Clustering.find_clusters_PCA-300"><a href="#Clustering.find_clusters_PCA-300"><span class="linenos">300</span></a><span class="sd">        This method performs density-based clustering (DBSCAN) on the PCA-reduced</span>
</span><span id="Clustering.find_clusters_PCA-301"><a href="#Clustering.find_clusters_PCA-301"><span class="linenos">301</span></a><span class="sd">        dataset. Cluster labels are stored in the object&#39;s metadata, and a scatter</span>
</span><span id="Clustering.find_clusters_PCA-302"><a href="#Clustering.find_clusters_PCA-302"><span class="linenos">302</span></a><span class="sd">        plot of the first two principal components with cluster annotations is returned.</span>
</span><span id="Clustering.find_clusters_PCA-303"><a href="#Clustering.find_clusters_PCA-303"><span class="linenos">303</span></a>
</span><span id="Clustering.find_clusters_PCA-304"><a href="#Clustering.find_clusters_PCA-304"><span class="linenos">304</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering.find_clusters_PCA-305"><a href="#Clustering.find_clusters_PCA-305"><span class="linenos">305</span></a><span class="sd">        ----------</span>
</span><span id="Clustering.find_clusters_PCA-306"><a href="#Clustering.find_clusters_PCA-306"><span class="linenos">306</span></a><span class="sd">        pc_num : int, default 2</span>
</span><span id="Clustering.find_clusters_PCA-307"><a href="#Clustering.find_clusters_PCA-307"><span class="linenos">307</span></a><span class="sd">            Number of principal components to use for clustering.</span>
</span><span id="Clustering.find_clusters_PCA-308"><a href="#Clustering.find_clusters_PCA-308"><span class="linenos">308</span></a><span class="sd">            If 0, uses all available components.</span>
</span><span id="Clustering.find_clusters_PCA-309"><a href="#Clustering.find_clusters_PCA-309"><span class="linenos">309</span></a>
</span><span id="Clustering.find_clusters_PCA-310"><a href="#Clustering.find_clusters_PCA-310"><span class="linenos">310</span></a><span class="sd">        eps : float, default 0.5</span>
</span><span id="Clustering.find_clusters_PCA-311"><a href="#Clustering.find_clusters_PCA-311"><span class="linenos">311</span></a><span class="sd">            Maximum distance between two points for them to be considered</span>
</span><span id="Clustering.find_clusters_PCA-312"><a href="#Clustering.find_clusters_PCA-312"><span class="linenos">312</span></a><span class="sd">            as neighbors (DBSCAN parameter).</span>
</span><span id="Clustering.find_clusters_PCA-313"><a href="#Clustering.find_clusters_PCA-313"><span class="linenos">313</span></a>
</span><span id="Clustering.find_clusters_PCA-314"><a href="#Clustering.find_clusters_PCA-314"><span class="linenos">314</span></a><span class="sd">        min_samples : int, default 10</span>
</span><span id="Clustering.find_clusters_PCA-315"><a href="#Clustering.find_clusters_PCA-315"><span class="linenos">315</span></a><span class="sd">            Minimum number of samples required to form a cluster (DBSCAN parameter).</span>
</span><span id="Clustering.find_clusters_PCA-316"><a href="#Clustering.find_clusters_PCA-316"><span class="linenos">316</span></a>
</span><span id="Clustering.find_clusters_PCA-317"><a href="#Clustering.find_clusters_PCA-317"><span class="linenos">317</span></a><span class="sd">        width : int, default 8</span>
</span><span id="Clustering.find_clusters_PCA-318"><a href="#Clustering.find_clusters_PCA-318"><span class="linenos">318</span></a><span class="sd">            Width of the output scatter plot.</span>
</span><span id="Clustering.find_clusters_PCA-319"><a href="#Clustering.find_clusters_PCA-319"><span class="linenos">319</span></a>
</span><span id="Clustering.find_clusters_PCA-320"><a href="#Clustering.find_clusters_PCA-320"><span class="linenos">320</span></a><span class="sd">        height : int, default 6</span>
</span><span id="Clustering.find_clusters_PCA-321"><a href="#Clustering.find_clusters_PCA-321"><span class="linenos">321</span></a><span class="sd">            Height of the output scatter plot.</span>
</span><span id="Clustering.find_clusters_PCA-322"><a href="#Clustering.find_clusters_PCA-322"><span class="linenos">322</span></a>
</span><span id="Clustering.find_clusters_PCA-323"><a href="#Clustering.find_clusters_PCA-323"><span class="linenos">323</span></a><span class="sd">        harmonized : bool, default False</span>
</span><span id="Clustering.find_clusters_PCA-324"><a href="#Clustering.find_clusters_PCA-324"><span class="linenos">324</span></a><span class="sd">            If True, use harmonized PCA data (`self.harmonized_pca`).</span>
</span><span id="Clustering.find_clusters_PCA-325"><a href="#Clustering.find_clusters_PCA-325"><span class="linenos">325</span></a><span class="sd">            If False, use standard PCA results (`self.pca`).</span>
</span><span id="Clustering.find_clusters_PCA-326"><a href="#Clustering.find_clusters_PCA-326"><span class="linenos">326</span></a>
</span><span id="Clustering.find_clusters_PCA-327"><a href="#Clustering.find_clusters_PCA-327"><span class="linenos">327</span></a><span class="sd">        Returns</span>
</span><span id="Clustering.find_clusters_PCA-328"><a href="#Clustering.find_clusters_PCA-328"><span class="linenos">328</span></a><span class="sd">        -------</span>
</span><span id="Clustering.find_clusters_PCA-329"><a href="#Clustering.find_clusters_PCA-329"><span class="linenos">329</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="Clustering.find_clusters_PCA-330"><a href="#Clustering.find_clusters_PCA-330"><span class="linenos">330</span></a><span class="sd">            Scatter plot of the first two principal components colored by</span>
</span><span id="Clustering.find_clusters_PCA-331"><a href="#Clustering.find_clusters_PCA-331"><span class="linenos">331</span></a><span class="sd">            cluster assignments.</span>
</span><span id="Clustering.find_clusters_PCA-332"><a href="#Clustering.find_clusters_PCA-332"><span class="linenos">332</span></a>
</span><span id="Clustering.find_clusters_PCA-333"><a href="#Clustering.find_clusters_PCA-333"><span class="linenos">333</span></a><span class="sd">        Updates</span>
</span><span id="Clustering.find_clusters_PCA-334"><a href="#Clustering.find_clusters_PCA-334"><span class="linenos">334</span></a><span class="sd">        -------</span>
</span><span id="Clustering.find_clusters_PCA-335"><a href="#Clustering.find_clusters_PCA-335"><span class="linenos">335</span></a><span class="sd">        self.clustering_metadata[&#39;PCA_clusters&#39;] : list</span>
</span><span id="Clustering.find_clusters_PCA-336"><a href="#Clustering.find_clusters_PCA-336"><span class="linenos">336</span></a><span class="sd">            Cluster labels assigned to each cell/sample.</span>
</span><span id="Clustering.find_clusters_PCA-337"><a href="#Clustering.find_clusters_PCA-337"><span class="linenos">337</span></a>
</span><span id="Clustering.find_clusters_PCA-338"><a href="#Clustering.find_clusters_PCA-338"><span class="linenos">338</span></a><span class="sd">        self.input_metadata[&#39;PCA_clusters&#39;] : list, optional</span>
</span><span id="Clustering.find_clusters_PCA-339"><a href="#Clustering.find_clusters_PCA-339"><span class="linenos">339</span></a><span class="sd">            Cluster labels stored in input metadata (if available).</span>
</span><span id="Clustering.find_clusters_PCA-340"><a href="#Clustering.find_clusters_PCA-340"><span class="linenos">340</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering.find_clusters_PCA-341"><a href="#Clustering.find_clusters_PCA-341"><span class="linenos">341</span></a>
</span><span id="Clustering.find_clusters_PCA-342"><a href="#Clustering.find_clusters_PCA-342"><span class="linenos">342</span></a>        <span class="n">dbscan</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="n">min_samples</span><span class="p">)</span>
</span><span id="Clustering.find_clusters_PCA-343"><a href="#Clustering.find_clusters_PCA-343"><span class="linenos">343</span></a>
</span><span id="Clustering.find_clusters_PCA-344"><a href="#Clustering.find_clusters_PCA-344"><span class="linenos">344</span></a>        <span class="k">if</span> <span class="n">pc_num</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">harmonized</span><span class="p">:</span>
</span><span id="Clustering.find_clusters_PCA-345"><a href="#Clustering.find_clusters_PCA-345"><span class="linenos">345</span></a>            <span class="n">PCA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span>
</span><span id="Clustering.find_clusters_PCA-346"><a href="#Clustering.find_clusters_PCA-346"><span class="linenos">346</span></a>
</span><span id="Clustering.find_clusters_PCA-347"><a href="#Clustering.find_clusters_PCA-347"><span class="linenos">347</span></a>        <span class="k">elif</span> <span class="n">pc_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Clustering.find_clusters_PCA-348"><a href="#Clustering.find_clusters_PCA-348"><span class="linenos">348</span></a>            <span class="n">PCA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca</span>
</span><span id="Clustering.find_clusters_PCA-349"><a href="#Clustering.find_clusters_PCA-349"><span class="linenos">349</span></a>
</span><span id="Clustering.find_clusters_PCA-350"><a href="#Clustering.find_clusters_PCA-350"><span class="linenos">350</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering.find_clusters_PCA-351"><a href="#Clustering.find_clusters_PCA-351"><span class="linenos">351</span></a>            <span class="k">if</span> <span class="n">harmonized</span><span class="p">:</span>
</span><span id="Clustering.find_clusters_PCA-352"><a href="#Clustering.find_clusters_PCA-352"><span class="linenos">352</span></a>
</span><span id="Clustering.find_clusters_PCA-353"><a href="#Clustering.find_clusters_PCA-353"><span class="linenos">353</span></a>                <span class="n">PCA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">pc_num</span><span class="p">]</span>
</span><span id="Clustering.find_clusters_PCA-354"><a href="#Clustering.find_clusters_PCA-354"><span class="linenos">354</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering.find_clusters_PCA-355"><a href="#Clustering.find_clusters_PCA-355"><span class="linenos">355</span></a>
</span><span id="Clustering.find_clusters_PCA-356"><a href="#Clustering.find_clusters_PCA-356"><span class="linenos">356</span></a>                <span class="n">PCA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">pc_num</span><span class="p">]</span>
</span><span id="Clustering.find_clusters_PCA-357"><a href="#Clustering.find_clusters_PCA-357"><span class="linenos">357</span></a>
</span><span id="Clustering.find_clusters_PCA-358"><a href="#Clustering.find_clusters_PCA-358"><span class="linenos">358</span></a>        <span class="n">dbscan_labels</span> <span class="o">=</span> <span class="n">dbscan</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">PCA</span><span class="p">)</span>
</span><span id="Clustering.find_clusters_PCA-359"><a href="#Clustering.find_clusters_PCA-359"><span class="linenos">359</span></a>
</span><span id="Clustering.find_clusters_PCA-360"><a href="#Clustering.find_clusters_PCA-360"><span class="linenos">360</span></a>        <span class="n">pca_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">PCA</span><span class="p">)</span>
</span><span id="Clustering.find_clusters_PCA-361"><a href="#Clustering.find_clusters_PCA-361"><span class="linenos">361</span></a>        <span class="n">pca_df</span><span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbscan_labels</span>
</span><span id="Clustering.find_clusters_PCA-362"><a href="#Clustering.find_clusters_PCA-362"><span class="linenos">362</span></a>
</span><span id="Clustering.find_clusters_PCA-363"><a href="#Clustering.find_clusters_PCA-363"><span class="linenos">363</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="Clustering.find_clusters_PCA-364"><a href="#Clustering.find_clusters_PCA-364"><span class="linenos">364</span></a>
</span><span id="Clustering.find_clusters_PCA-365"><a href="#Clustering.find_clusters_PCA-365"><span class="linenos">365</span></a>        <span class="k">for</span> <span class="n">cluster_id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pca_df</span><span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
</span><span id="Clustering.find_clusters_PCA-366"><a href="#Clustering.find_clusters_PCA-366"><span class="linenos">366</span></a>            <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">pca_df</span><span class="p">[</span><span class="n">pca_df</span><span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cluster_id</span><span class="p">]</span>
</span><span id="Clustering.find_clusters_PCA-367"><a href="#Clustering.find_clusters_PCA-367"><span class="linenos">367</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="Clustering.find_clusters_PCA-368"><a href="#Clustering.find_clusters_PCA-368"><span class="linenos">368</span></a>                <span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;PC1&quot;</span><span class="p">],</span>
</span><span id="Clustering.find_clusters_PCA-369"><a href="#Clustering.find_clusters_PCA-369"><span class="linenos">369</span></a>                <span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;PC2&quot;</span><span class="p">],</span>
</span><span id="Clustering.find_clusters_PCA-370"><a href="#Clustering.find_clusters_PCA-370"><span class="linenos">370</span></a>                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cluster </span><span class="si">{</span><span class="n">cluster_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Clustering.find_clusters_PCA-371"><a href="#Clustering.find_clusters_PCA-371"><span class="linenos">371</span></a>                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span><span id="Clustering.find_clusters_PCA-372"><a href="#Clustering.find_clusters_PCA-372"><span class="linenos">372</span></a>            <span class="p">)</span>
</span><span id="Clustering.find_clusters_PCA-373"><a href="#Clustering.find_clusters_PCA-373"><span class="linenos">373</span></a>
</span><span id="Clustering.find_clusters_PCA-374"><a href="#Clustering.find_clusters_PCA-374"><span class="linenos">374</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;PC 1&quot;</span><span class="p">)</span>
</span><span id="Clustering.find_clusters_PCA-375"><a href="#Clustering.find_clusters_PCA-375"><span class="linenos">375</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;PC 2&quot;</span><span class="p">)</span>
</span><span id="Clustering.find_clusters_PCA-376"><a href="#Clustering.find_clusters_PCA-376"><span class="linenos">376</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Clusters&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
</span><span id="Clustering.find_clusters_PCA-377"><a href="#Clustering.find_clusters_PCA-377"><span class="linenos">377</span></a>
</span><span id="Clustering.find_clusters_PCA-378"><a href="#Clustering.find_clusters_PCA-378"><span class="linenos">378</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Clustering.find_clusters_PCA-379"><a href="#Clustering.find_clusters_PCA-379"><span class="linenos">379</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="Clustering.find_clusters_PCA-380"><a href="#Clustering.find_clusters_PCA-380"><span class="linenos">380</span></a>
</span><span id="Clustering.find_clusters_PCA-381"><a href="#Clustering.find_clusters_PCA-381"><span class="linenos">381</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;PCA_clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dbscan_labels</span><span class="p">]</span>
</span><span id="Clustering.find_clusters_PCA-382"><a href="#Clustering.find_clusters_PCA-382"><span class="linenos">382</span></a>
</span><span id="Clustering.find_clusters_PCA-383"><a href="#Clustering.find_clusters_PCA-383"><span class="linenos">383</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Clustering.find_clusters_PCA-384"><a href="#Clustering.find_clusters_PCA-384"><span class="linenos">384</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;PCA_clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dbscan_labels</span><span class="p">]</span>
</span><span id="Clustering.find_clusters_PCA-385"><a href="#Clustering.find_clusters_PCA-385"><span class="linenos">385</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="Clustering.find_clusters_PCA-386"><a href="#Clustering.find_clusters_PCA-386"><span class="linenos">386</span></a>            <span class="k">pass</span>
</span><span id="Clustering.find_clusters_PCA-387"><a href="#Clustering.find_clusters_PCA-387"><span class="linenos">387</span></a>
</span><span id="Clustering.find_clusters_PCA-388"><a href="#Clustering.find_clusters_PCA-388"><span class="linenos">388</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span></pre></div>


            <div class="docstring"><p>Apply DBSCAN clustering to PCA embeddings and visualize the results.</p>

<p>This method performs density-based clustering (DBSCAN) on the PCA-reduced
dataset. Cluster labels are stored in the object's metadata, and a scatter
plot of the first two principal components with cluster annotations is returned.</p>

<h2 id="parameters">Parameters</h2>

<p>pc_num : int, default 2
    Number of principal components to use for clustering.
    If 0, uses all available components.</p>

<p>eps : float, default 0.5
    Maximum distance between two points for them to be considered
    as neighbors (DBSCAN parameter).</p>

<p>min_samples : int, default 10
    Minimum number of samples required to form a cluster (DBSCAN parameter).</p>

<p>width : int, default 8
    Width of the output scatter plot.</p>

<p>height : int, default 6
    Height of the output scatter plot.</p>

<p>harmonized : bool, default False
    If True, use harmonized PCA data (<code>self.harmonized_pca</code>).
    If False, use standard PCA results (<code>self.pca</code>).</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.figure.Figure
    Scatter plot of the first two principal components colored by
    cluster assignments.</p>

<h2 id="updates">Updates</h2>

<p>self.clustering_metadata['PCA_clusters'] : list
    Cluster labels assigned to each cell/sample.</p>

<p>self.input_metadata['PCA_clusters'] : list, optional
    Cluster labels stored in input metadata (if available).</p>
</div>


                            </div>
                            <div id="Clustering.perform_UMAP" class="classattr">
                                        <input id="Clustering.perform_UMAP-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">perform_UMAP</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">factorize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">umap_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>,</span><span class="param">	<span class="n">pc_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">harmonized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">n_neighbors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>,</span><span class="param">	<span class="n">min_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">0.1</span>,</span><span class="param">	<span class="n">spread</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">set_op_mix_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">local_connectivity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">repulsion_strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">negative_sample_rate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>,</span><span class="param">	<span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>,</span><span class="param">	<span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Clustering.perform_UMAP-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Clustering.perform_UMAP"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Clustering.perform_UMAP-390"><a href="#Clustering.perform_UMAP-390"><span class="linenos">390</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">perform_UMAP</span><span class="p">(</span>
</span><span id="Clustering.perform_UMAP-391"><a href="#Clustering.perform_UMAP-391"><span class="linenos">391</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-392"><a href="#Clustering.perform_UMAP-392"><span class="linenos">392</span></a>        <span class="n">factorize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-393"><a href="#Clustering.perform_UMAP-393"><span class="linenos">393</span></a>        <span class="n">umap_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-394"><a href="#Clustering.perform_UMAP-394"><span class="linenos">394</span></a>        <span class="n">pc_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-395"><a href="#Clustering.perform_UMAP-395"><span class="linenos">395</span></a>        <span class="n">harmonized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-396"><a href="#Clustering.perform_UMAP-396"><span class="linenos">396</span></a>        <span class="n">n_neighbors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-397"><a href="#Clustering.perform_UMAP-397"><span class="linenos">397</span></a>        <span class="n">min_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-398"><a href="#Clustering.perform_UMAP-398"><span class="linenos">398</span></a>        <span class="n">spread</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-399"><a href="#Clustering.perform_UMAP-399"><span class="linenos">399</span></a>        <span class="n">set_op_mix_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-400"><a href="#Clustering.perform_UMAP-400"><span class="linenos">400</span></a>        <span class="n">local_connectivity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-401"><a href="#Clustering.perform_UMAP-401"><span class="linenos">401</span></a>        <span class="n">repulsion_strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-402"><a href="#Clustering.perform_UMAP-402"><span class="linenos">402</span></a>        <span class="n">negative_sample_rate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-403"><a href="#Clustering.perform_UMAP-403"><span class="linenos">403</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-404"><a href="#Clustering.perform_UMAP-404"><span class="linenos">404</span></a>        <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-405"><a href="#Clustering.perform_UMAP-405"><span class="linenos">405</span></a>    <span class="p">):</span>
</span><span id="Clustering.perform_UMAP-406"><a href="#Clustering.perform_UMAP-406"><span class="linenos">406</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering.perform_UMAP-407"><a href="#Clustering.perform_UMAP-407"><span class="linenos">407</span></a><span class="sd">        Compute and visualize UMAP embeddings of the dataset.</span>
</span><span id="Clustering.perform_UMAP-408"><a href="#Clustering.perform_UMAP-408"><span class="linenos">408</span></a>
</span><span id="Clustering.perform_UMAP-409"><a href="#Clustering.perform_UMAP-409"><span class="linenos">409</span></a><span class="sd">        This method applies Uniform Manifold Approximation and Projection (UMAP)</span>
</span><span id="Clustering.perform_UMAP-410"><a href="#Clustering.perform_UMAP-410"><span class="linenos">410</span></a><span class="sd">        for dimensionality reduction on either raw, PCA, or harmonized PCA data.</span>
</span><span id="Clustering.perform_UMAP-411"><a href="#Clustering.perform_UMAP-411"><span class="linenos">411</span></a><span class="sd">        Results are stored as a DataFrame (`self.umap`) and a scatter plot figure</span>
</span><span id="Clustering.perform_UMAP-412"><a href="#Clustering.perform_UMAP-412"><span class="linenos">412</span></a><span class="sd">        (`self.UMAP_plot`).</span>
</span><span id="Clustering.perform_UMAP-413"><a href="#Clustering.perform_UMAP-413"><span class="linenos">413</span></a>
</span><span id="Clustering.perform_UMAP-414"><a href="#Clustering.perform_UMAP-414"><span class="linenos">414</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering.perform_UMAP-415"><a href="#Clustering.perform_UMAP-415"><span class="linenos">415</span></a><span class="sd">        ----------</span>
</span><span id="Clustering.perform_UMAP-416"><a href="#Clustering.perform_UMAP-416"><span class="linenos">416</span></a><span class="sd">        factorize : bool, default False</span>
</span><span id="Clustering.perform_UMAP-417"><a href="#Clustering.perform_UMAP-417"><span class="linenos">417</span></a><span class="sd">            If True, categorical sample labels (from column names) are factorized</span>
</span><span id="Clustering.perform_UMAP-418"><a href="#Clustering.perform_UMAP-418"><span class="linenos">418</span></a><span class="sd">            and used as supervision in UMAP fitting.</span>
</span><span id="Clustering.perform_UMAP-419"><a href="#Clustering.perform_UMAP-419"><span class="linenos">419</span></a>
</span><span id="Clustering.perform_UMAP-420"><a href="#Clustering.perform_UMAP-420"><span class="linenos">420</span></a><span class="sd">        umap_num : int, default 100</span>
</span><span id="Clustering.perform_UMAP-421"><a href="#Clustering.perform_UMAP-421"><span class="linenos">421</span></a><span class="sd">            Number of UMAP dimensions to compute. If 0, matches the input dimension.</span>
</span><span id="Clustering.perform_UMAP-422"><a href="#Clustering.perform_UMAP-422"><span class="linenos">422</span></a>
</span><span id="Clustering.perform_UMAP-423"><a href="#Clustering.perform_UMAP-423"><span class="linenos">423</span></a><span class="sd">        pc_num : int, default 0</span>
</span><span id="Clustering.perform_UMAP-424"><a href="#Clustering.perform_UMAP-424"><span class="linenos">424</span></a><span class="sd">            Number of principal components to use as UMAP input.</span>
</span><span id="Clustering.perform_UMAP-425"><a href="#Clustering.perform_UMAP-425"><span class="linenos">425</span></a><span class="sd">            If 0, use all available components or raw data.</span>
</span><span id="Clustering.perform_UMAP-426"><a href="#Clustering.perform_UMAP-426"><span class="linenos">426</span></a>
</span><span id="Clustering.perform_UMAP-427"><a href="#Clustering.perform_UMAP-427"><span class="linenos">427</span></a><span class="sd">        harmonized : bool, default False</span>
</span><span id="Clustering.perform_UMAP-428"><a href="#Clustering.perform_UMAP-428"><span class="linenos">428</span></a><span class="sd">            If True, use harmonized PCA embeddings (`self.harmonized_pca`).</span>
</span><span id="Clustering.perform_UMAP-429"><a href="#Clustering.perform_UMAP-429"><span class="linenos">429</span></a><span class="sd">            If False, use standard PCA or raw scaled data.</span>
</span><span id="Clustering.perform_UMAP-430"><a href="#Clustering.perform_UMAP-430"><span class="linenos">430</span></a>
</span><span id="Clustering.perform_UMAP-431"><a href="#Clustering.perform_UMAP-431"><span class="linenos">431</span></a><span class="sd">        n_neighbors : int, default 5</span>
</span><span id="Clustering.perform_UMAP-432"><a href="#Clustering.perform_UMAP-432"><span class="linenos">432</span></a><span class="sd">            UMAP parameter controlling the size of the local neighborhood.</span>
</span><span id="Clustering.perform_UMAP-433"><a href="#Clustering.perform_UMAP-433"><span class="linenos">433</span></a>
</span><span id="Clustering.perform_UMAP-434"><a href="#Clustering.perform_UMAP-434"><span class="linenos">434</span></a><span class="sd">        min_dist : float, default 0.1</span>
</span><span id="Clustering.perform_UMAP-435"><a href="#Clustering.perform_UMAP-435"><span class="linenos">435</span></a><span class="sd">            UMAP parameter controlling minimum allowed distance between embedded points.</span>
</span><span id="Clustering.perform_UMAP-436"><a href="#Clustering.perform_UMAP-436"><span class="linenos">436</span></a>
</span><span id="Clustering.perform_UMAP-437"><a href="#Clustering.perform_UMAP-437"><span class="linenos">437</span></a><span class="sd">        spread : int | float, default 1.0</span>
</span><span id="Clustering.perform_UMAP-438"><a href="#Clustering.perform_UMAP-438"><span class="linenos">438</span></a><span class="sd">            Effective scale of embedded space (UMAP parameter).</span>
</span><span id="Clustering.perform_UMAP-439"><a href="#Clustering.perform_UMAP-439"><span class="linenos">439</span></a>
</span><span id="Clustering.perform_UMAP-440"><a href="#Clustering.perform_UMAP-440"><span class="linenos">440</span></a><span class="sd">        set_op_mix_ratio : int | float, default 1.0</span>
</span><span id="Clustering.perform_UMAP-441"><a href="#Clustering.perform_UMAP-441"><span class="linenos">441</span></a><span class="sd">            Interpolation parameter between union and intersection in fuzzy sets.</span>
</span><span id="Clustering.perform_UMAP-442"><a href="#Clustering.perform_UMAP-442"><span class="linenos">442</span></a>
</span><span id="Clustering.perform_UMAP-443"><a href="#Clustering.perform_UMAP-443"><span class="linenos">443</span></a><span class="sd">        local_connectivity : int, default 1</span>
</span><span id="Clustering.perform_UMAP-444"><a href="#Clustering.perform_UMAP-444"><span class="linenos">444</span></a><span class="sd">            Number of nearest neighbors assumed for each point.</span>
</span><span id="Clustering.perform_UMAP-445"><a href="#Clustering.perform_UMAP-445"><span class="linenos">445</span></a>
</span><span id="Clustering.perform_UMAP-446"><a href="#Clustering.perform_UMAP-446"><span class="linenos">446</span></a><span class="sd">        repulsion_strength : int | float, default 1.0</span>
</span><span id="Clustering.perform_UMAP-447"><a href="#Clustering.perform_UMAP-447"><span class="linenos">447</span></a><span class="sd">            Weighting applied to negative samples during optimization.</span>
</span><span id="Clustering.perform_UMAP-448"><a href="#Clustering.perform_UMAP-448"><span class="linenos">448</span></a>
</span><span id="Clustering.perform_UMAP-449"><a href="#Clustering.perform_UMAP-449"><span class="linenos">449</span></a><span class="sd">        negative_sample_rate : int, default 5</span>
</span><span id="Clustering.perform_UMAP-450"><a href="#Clustering.perform_UMAP-450"><span class="linenos">450</span></a><span class="sd">            Number of negative samples per positive sample in optimization.</span>
</span><span id="Clustering.perform_UMAP-451"><a href="#Clustering.perform_UMAP-451"><span class="linenos">451</span></a>
</span><span id="Clustering.perform_UMAP-452"><a href="#Clustering.perform_UMAP-452"><span class="linenos">452</span></a><span class="sd">        width : int, default 8</span>
</span><span id="Clustering.perform_UMAP-453"><a href="#Clustering.perform_UMAP-453"><span class="linenos">453</span></a><span class="sd">            Width of the output scatter plot.</span>
</span><span id="Clustering.perform_UMAP-454"><a href="#Clustering.perform_UMAP-454"><span class="linenos">454</span></a>
</span><span id="Clustering.perform_UMAP-455"><a href="#Clustering.perform_UMAP-455"><span class="linenos">455</span></a><span class="sd">        height : int, default 6</span>
</span><span id="Clustering.perform_UMAP-456"><a href="#Clustering.perform_UMAP-456"><span class="linenos">456</span></a><span class="sd">            Height of the output scatter plot.</span>
</span><span id="Clustering.perform_UMAP-457"><a href="#Clustering.perform_UMAP-457"><span class="linenos">457</span></a>
</span><span id="Clustering.perform_UMAP-458"><a href="#Clustering.perform_UMAP-458"><span class="linenos">458</span></a><span class="sd">        Updates</span>
</span><span id="Clustering.perform_UMAP-459"><a href="#Clustering.perform_UMAP-459"><span class="linenos">459</span></a><span class="sd">        -------</span>
</span><span id="Clustering.perform_UMAP-460"><a href="#Clustering.perform_UMAP-460"><span class="linenos">460</span></a><span class="sd">        self.umap : pandas.DataFrame</span>
</span><span id="Clustering.perform_UMAP-461"><a href="#Clustering.perform_UMAP-461"><span class="linenos">461</span></a><span class="sd">            Table of UMAP embeddings with columns `UMAP1 ... UMAPn`.</span>
</span><span id="Clustering.perform_UMAP-462"><a href="#Clustering.perform_UMAP-462"><span class="linenos">462</span></a>
</span><span id="Clustering.perform_UMAP-463"><a href="#Clustering.perform_UMAP-463"><span class="linenos">463</span></a><span class="sd">        Notes</span>
</span><span id="Clustering.perform_UMAP-464"><a href="#Clustering.perform_UMAP-464"><span class="linenos">464</span></a><span class="sd">        -----</span>
</span><span id="Clustering.perform_UMAP-465"><a href="#Clustering.perform_UMAP-465"><span class="linenos">465</span></a><span class="sd">        For supervised UMAP (`factorize=True`), categorical codes from column</span>
</span><span id="Clustering.perform_UMAP-466"><a href="#Clustering.perform_UMAP-466"><span class="linenos">466</span></a><span class="sd">        names of the dataset are used as labels.</span>
</span><span id="Clustering.perform_UMAP-467"><a href="#Clustering.perform_UMAP-467"><span class="linenos">467</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering.perform_UMAP-468"><a href="#Clustering.perform_UMAP-468"><span class="linenos">468</span></a>
</span><span id="Clustering.perform_UMAP-469"><a href="#Clustering.perform_UMAP-469"><span class="linenos">469</span></a>        <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
</span><span id="Clustering.perform_UMAP-470"><a href="#Clustering.perform_UMAP-470"><span class="linenos">470</span></a>
</span><span id="Clustering.perform_UMAP-471"><a href="#Clustering.perform_UMAP-471"><span class="linenos">471</span></a>        <span class="k">if</span> <span class="n">pc_num</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">harmonized</span><span class="p">:</span>
</span><span id="Clustering.perform_UMAP-472"><a href="#Clustering.perform_UMAP-472"><span class="linenos">472</span></a>            <span class="n">data_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span>
</span><span id="Clustering.perform_UMAP-473"><a href="#Clustering.perform_UMAP-473"><span class="linenos">473</span></a>
</span><span id="Clustering.perform_UMAP-474"><a href="#Clustering.perform_UMAP-474"><span class="linenos">474</span></a>        <span class="k">elif</span> <span class="n">pc_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Clustering.perform_UMAP-475"><a href="#Clustering.perform_UMAP-475"><span class="linenos">475</span></a>            <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clustering_data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="Clustering.perform_UMAP-476"><a href="#Clustering.perform_UMAP-476"><span class="linenos">476</span></a>
</span><span id="Clustering.perform_UMAP-477"><a href="#Clustering.perform_UMAP-477"><span class="linenos">477</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering.perform_UMAP-478"><a href="#Clustering.perform_UMAP-478"><span class="linenos">478</span></a>            <span class="k">if</span> <span class="n">harmonized</span><span class="p">:</span>
</span><span id="Clustering.perform_UMAP-479"><a href="#Clustering.perform_UMAP-479"><span class="linenos">479</span></a>
</span><span id="Clustering.perform_UMAP-480"><a href="#Clustering.perform_UMAP-480"><span class="linenos">480</span></a>                <span class="n">data_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">harmonized_pca</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">pc_num</span><span class="p">]</span>
</span><span id="Clustering.perform_UMAP-481"><a href="#Clustering.perform_UMAP-481"><span class="linenos">481</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering.perform_UMAP-482"><a href="#Clustering.perform_UMAP-482"><span class="linenos">482</span></a>
</span><span id="Clustering.perform_UMAP-483"><a href="#Clustering.perform_UMAP-483"><span class="linenos">483</span></a>                <span class="n">data_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">pc_num</span><span class="p">]</span>
</span><span id="Clustering.perform_UMAP-484"><a href="#Clustering.perform_UMAP-484"><span class="linenos">484</span></a>
</span><span id="Clustering.perform_UMAP-485"><a href="#Clustering.perform_UMAP-485"><span class="linenos">485</span></a>        <span class="k">if</span> <span class="n">umap_num</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">umap_num</span> <span class="o">&gt;</span> <span class="n">data_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="Clustering.perform_UMAP-486"><a href="#Clustering.perform_UMAP-486"><span class="linenos">486</span></a>
</span><span id="Clustering.perform_UMAP-487"><a href="#Clustering.perform_UMAP-487"><span class="linenos">487</span></a>            <span class="n">umap_num</span> <span class="o">=</span> <span class="n">data_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Clustering.perform_UMAP-488"><a href="#Clustering.perform_UMAP-488"><span class="linenos">488</span></a>
</span><span id="Clustering.perform_UMAP-489"><a href="#Clustering.perform_UMAP-489"><span class="linenos">489</span></a>            <span class="n">reducer</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">UMAP</span><span class="p">(</span>
</span><span id="Clustering.perform_UMAP-490"><a href="#Clustering.perform_UMAP-490"><span class="linenos">490</span></a>                <span class="n">n_components</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data_scaled</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
</span><span id="Clustering.perform_UMAP-491"><a href="#Clustering.perform_UMAP-491"><span class="linenos">491</span></a>                <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-492"><a href="#Clustering.perform_UMAP-492"><span class="linenos">492</span></a>                <span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-493"><a href="#Clustering.perform_UMAP-493"><span class="linenos">493</span></a>                <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-494"><a href="#Clustering.perform_UMAP-494"><span class="linenos">494</span></a>                <span class="n">spread</span><span class="o">=</span><span class="n">spread</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-495"><a href="#Clustering.perform_UMAP-495"><span class="linenos">495</span></a>                <span class="n">set_op_mix_ratio</span><span class="o">=</span><span class="n">set_op_mix_ratio</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-496"><a href="#Clustering.perform_UMAP-496"><span class="linenos">496</span></a>                <span class="n">local_connectivity</span><span class="o">=</span><span class="n">local_connectivity</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-497"><a href="#Clustering.perform_UMAP-497"><span class="linenos">497</span></a>                <span class="n">repulsion_strength</span><span class="o">=</span><span class="n">repulsion_strength</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-498"><a href="#Clustering.perform_UMAP-498"><span class="linenos">498</span></a>                <span class="n">negative_sample_rate</span><span class="o">=</span><span class="n">negative_sample_rate</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-499"><a href="#Clustering.perform_UMAP-499"><span class="linenos">499</span></a>                <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-500"><a href="#Clustering.perform_UMAP-500"><span class="linenos">500</span></a>            <span class="p">)</span>
</span><span id="Clustering.perform_UMAP-501"><a href="#Clustering.perform_UMAP-501"><span class="linenos">501</span></a>
</span><span id="Clustering.perform_UMAP-502"><a href="#Clustering.perform_UMAP-502"><span class="linenos">502</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering.perform_UMAP-503"><a href="#Clustering.perform_UMAP-503"><span class="linenos">503</span></a>
</span><span id="Clustering.perform_UMAP-504"><a href="#Clustering.perform_UMAP-504"><span class="linenos">504</span></a>            <span class="n">reducer</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">UMAP</span><span class="p">(</span>
</span><span id="Clustering.perform_UMAP-505"><a href="#Clustering.perform_UMAP-505"><span class="linenos">505</span></a>                <span class="n">n_components</span><span class="o">=</span><span class="n">umap_num</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-506"><a href="#Clustering.perform_UMAP-506"><span class="linenos">506</span></a>                <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-507"><a href="#Clustering.perform_UMAP-507"><span class="linenos">507</span></a>                <span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-508"><a href="#Clustering.perform_UMAP-508"><span class="linenos">508</span></a>                <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-509"><a href="#Clustering.perform_UMAP-509"><span class="linenos">509</span></a>                <span class="n">spread</span><span class="o">=</span><span class="n">spread</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-510"><a href="#Clustering.perform_UMAP-510"><span class="linenos">510</span></a>                <span class="n">set_op_mix_ratio</span><span class="o">=</span><span class="n">set_op_mix_ratio</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-511"><a href="#Clustering.perform_UMAP-511"><span class="linenos">511</span></a>                <span class="n">local_connectivity</span><span class="o">=</span><span class="n">local_connectivity</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-512"><a href="#Clustering.perform_UMAP-512"><span class="linenos">512</span></a>                <span class="n">repulsion_strength</span><span class="o">=</span><span class="n">repulsion_strength</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-513"><a href="#Clustering.perform_UMAP-513"><span class="linenos">513</span></a>                <span class="n">negative_sample_rate</span><span class="o">=</span><span class="n">negative_sample_rate</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-514"><a href="#Clustering.perform_UMAP-514"><span class="linenos">514</span></a>                <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Clustering.perform_UMAP-515"><a href="#Clustering.perform_UMAP-515"><span class="linenos">515</span></a>            <span class="p">)</span>
</span><span id="Clustering.perform_UMAP-516"><a href="#Clustering.perform_UMAP-516"><span class="linenos">516</span></a>
</span><span id="Clustering.perform_UMAP-517"><a href="#Clustering.perform_UMAP-517"><span class="linenos">517</span></a>        <span class="k">if</span> <span class="n">factorize</span><span class="p">:</span>
</span><span id="Clustering.perform_UMAP-518"><a href="#Clustering.perform_UMAP-518"><span class="linenos">518</span></a>            <span class="n">embedding</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
</span><span id="Clustering.perform_UMAP-519"><a href="#Clustering.perform_UMAP-519"><span class="linenos">519</span></a>                <span class="n">X</span><span class="o">=</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clustering_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">codes</span>
</span><span id="Clustering.perform_UMAP-520"><a href="#Clustering.perform_UMAP-520"><span class="linenos">520</span></a>            <span class="p">)</span>
</span><span id="Clustering.perform_UMAP-521"><a href="#Clustering.perform_UMAP-521"><span class="linenos">521</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering.perform_UMAP-522"><a href="#Clustering.perform_UMAP-522"><span class="linenos">522</span></a>            <span class="n">embedding</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">data_scaled</span><span class="p">)</span>
</span><span id="Clustering.perform_UMAP-523"><a href="#Clustering.perform_UMAP-523"><span class="linenos">523</span></a>
</span><span id="Clustering.perform_UMAP-524"><a href="#Clustering.perform_UMAP-524"><span class="linenos">524</span></a>        <span class="n">umap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="Clustering.perform_UMAP-525"><a href="#Clustering.perform_UMAP-525"><span class="linenos">525</span></a>            <span class="n">embedding</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;UMAP&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">umap_num</span><span class="p">)]</span>
</span><span id="Clustering.perform_UMAP-526"><a href="#Clustering.perform_UMAP-526"><span class="linenos">526</span></a>        <span class="p">)</span>
</span><span id="Clustering.perform_UMAP-527"><a href="#Clustering.perform_UMAP-527"><span class="linenos">527</span></a>
</span><span id="Clustering.perform_UMAP-528"><a href="#Clustering.perform_UMAP-528"><span class="linenos">528</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="Clustering.perform_UMAP-529"><a href="#Clustering.perform_UMAP-529"><span class="linenos">529</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;UMAP1&quot;</span><span class="p">],</span> <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;UMAP2&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="Clustering.perform_UMAP-530"><a href="#Clustering.perform_UMAP-530"><span class="linenos">530</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">)</span>
</span><span id="Clustering.perform_UMAP-531"><a href="#Clustering.perform_UMAP-531"><span class="linenos">531</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">)</span>
</span><span id="Clustering.perform_UMAP-532"><a href="#Clustering.perform_UMAP-532"><span class="linenos">532</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Clustering.perform_UMAP-533"><a href="#Clustering.perform_UMAP-533"><span class="linenos">533</span></a>
</span><span id="Clustering.perform_UMAP-534"><a href="#Clustering.perform_UMAP-534"><span class="linenos">534</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="Clustering.perform_UMAP-535"><a href="#Clustering.perform_UMAP-535"><span class="linenos">535</span></a>
</span><span id="Clustering.perform_UMAP-536"><a href="#Clustering.perform_UMAP-536"><span class="linenos">536</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">umap</span> <span class="o">=</span> <span class="n">umap_df</span>
</span></pre></div>


            <div class="docstring"><p>Compute and visualize UMAP embeddings of the dataset.</p>

<p>This method applies Uniform Manifold Approximation and Projection (UMAP)
for dimensionality reduction on either raw, PCA, or harmonized PCA data.
Results are stored as a DataFrame (<code>self.umap</code>) and a scatter plot figure
(<code>self.UMAP_plot</code>).</p>

<h2 id="parameters">Parameters</h2>

<p>factorize : bool, default False
    If True, categorical sample labels (from column names) are factorized
    and used as supervision in UMAP fitting.</p>

<p>umap_num : int, default 100
    Number of UMAP dimensions to compute. If 0, matches the input dimension.</p>

<p>pc_num : int, default 0
    Number of principal components to use as UMAP input.
    If 0, use all available components or raw data.</p>

<p>harmonized : bool, default False
    If True, use harmonized PCA embeddings (<code>self.harmonized_pca</code>).
    If False, use standard PCA or raw scaled data.</p>

<p>n_neighbors : int, default 5
    UMAP parameter controlling the size of the local neighborhood.</p>

<p>min_dist : float, default 0.1
    UMAP parameter controlling minimum allowed distance between embedded points.</p>

<p>spread : int | float, default 1.0
    Effective scale of embedded space (UMAP parameter).</p>

<p>set_op_mix_ratio : int | float, default 1.0
    Interpolation parameter between union and intersection in fuzzy sets.</p>

<p>local_connectivity : int, default 1
    Number of nearest neighbors assumed for each point.</p>

<p>repulsion_strength : int | float, default 1.0
    Weighting applied to negative samples during optimization.</p>

<p>negative_sample_rate : int, default 5
    Number of negative samples per positive sample in optimization.</p>

<p>width : int, default 8
    Width of the output scatter plot.</p>

<p>height : int, default 6
    Height of the output scatter plot.</p>

<h2 id="updates">Updates</h2>

<p>self.umap : pandas.DataFrame
    Table of UMAP embeddings with columns <code>UMAP1 ... UMAPn</code>.</p>

<h2 id="notes">Notes</h2>

<p>For supervised UMAP (<code>factorize=True</code>), categorical codes from column
names of the dataset are used as labels.</p>
</div>


                            </div>
                            <div id="Clustering.knee_plot_umap" class="classattr">
                                        <input id="Clustering.knee_plot_umap-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">knee_plot_umap</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">eps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span>, </span><span class="param"><span class="n">min_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Clustering.knee_plot_umap-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Clustering.knee_plot_umap"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Clustering.knee_plot_umap-538"><a href="#Clustering.knee_plot_umap-538"><span class="linenos">538</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">knee_plot_umap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">min_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
</span><span id="Clustering.knee_plot_umap-539"><a href="#Clustering.knee_plot_umap-539"><span class="linenos">539</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering.knee_plot_umap-540"><a href="#Clustering.knee_plot_umap-540"><span class="linenos">540</span></a><span class="sd">        Plot silhouette scores for different UMAP dimensions to determine optimal n_components.</span>
</span><span id="Clustering.knee_plot_umap-541"><a href="#Clustering.knee_plot_umap-541"><span class="linenos">541</span></a>
</span><span id="Clustering.knee_plot_umap-542"><a href="#Clustering.knee_plot_umap-542"><span class="linenos">542</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering.knee_plot_umap-543"><a href="#Clustering.knee_plot_umap-543"><span class="linenos">543</span></a><span class="sd">        ----------</span>
</span><span id="Clustering.knee_plot_umap-544"><a href="#Clustering.knee_plot_umap-544"><span class="linenos">544</span></a><span class="sd">        eps : float, default 0.5</span>
</span><span id="Clustering.knee_plot_umap-545"><a href="#Clustering.knee_plot_umap-545"><span class="linenos">545</span></a><span class="sd">            DBSCAN eps parameter for clustering each UMAP dimension.</span>
</span><span id="Clustering.knee_plot_umap-546"><a href="#Clustering.knee_plot_umap-546"><span class="linenos">546</span></a>
</span><span id="Clustering.knee_plot_umap-547"><a href="#Clustering.knee_plot_umap-547"><span class="linenos">547</span></a><span class="sd">        min_samples : int, default 10</span>
</span><span id="Clustering.knee_plot_umap-548"><a href="#Clustering.knee_plot_umap-548"><span class="linenos">548</span></a><span class="sd">            Minimum number of samples to form a cluster in DBSCAN.</span>
</span><span id="Clustering.knee_plot_umap-549"><a href="#Clustering.knee_plot_umap-549"><span class="linenos">549</span></a>
</span><span id="Clustering.knee_plot_umap-550"><a href="#Clustering.knee_plot_umap-550"><span class="linenos">550</span></a><span class="sd">        Returns</span>
</span><span id="Clustering.knee_plot_umap-551"><a href="#Clustering.knee_plot_umap-551"><span class="linenos">551</span></a><span class="sd">        -------</span>
</span><span id="Clustering.knee_plot_umap-552"><a href="#Clustering.knee_plot_umap-552"><span class="linenos">552</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="Clustering.knee_plot_umap-553"><a href="#Clustering.knee_plot_umap-553"><span class="linenos">553</span></a><span class="sd">            Silhouette score plot across UMAP dimensions.</span>
</span><span id="Clustering.knee_plot_umap-554"><a href="#Clustering.knee_plot_umap-554"><span class="linenos">554</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering.knee_plot_umap-555"><a href="#Clustering.knee_plot_umap-555"><span class="linenos">555</span></a>
</span><span id="Clustering.knee_plot_umap-556"><a href="#Clustering.knee_plot_umap-556"><span class="linenos">556</span></a>        <span class="n">umap_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">umap</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Clustering.knee_plot_umap-557"><a href="#Clustering.knee_plot_umap-557"><span class="linenos">557</span></a>
</span><span id="Clustering.knee_plot_umap-558"><a href="#Clustering.knee_plot_umap-558"><span class="linenos">558</span></a>        <span class="n">silhouette_scores</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Clustering.knee_plot_umap-559"><a href="#Clustering.knee_plot_umap-559"><span class="linenos">559</span></a>        <span class="n">component</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Clustering.knee_plot_umap-560"><a href="#Clustering.knee_plot_umap-560"><span class="linenos">560</span></a>        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">umap_range</span><span class="p">:</span>
</span><span id="Clustering.knee_plot_umap-561"><a href="#Clustering.knee_plot_umap-561"><span class="linenos">561</span></a>
</span><span id="Clustering.knee_plot_umap-562"><a href="#Clustering.knee_plot_umap-562"><span class="linenos">562</span></a>            <span class="n">db</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="n">min_samples</span><span class="p">)</span>
</span><span id="Clustering.knee_plot_umap-563"><a href="#Clustering.knee_plot_umap-563"><span class="linenos">563</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">umap</span><span class="p">)[:,</span> <span class="p">:</span><span class="n">n</span><span class="p">])</span>
</span><span id="Clustering.knee_plot_umap-564"><a href="#Clustering.knee_plot_umap-564"><span class="linenos">564</span></a>
</span><span id="Clustering.knee_plot_umap-565"><a href="#Clustering.knee_plot_umap-565"><span class="linenos">565</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="Clustering.knee_plot_umap-566"><a href="#Clustering.knee_plot_umap-566"><span class="linenos">566</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Clustering.knee_plot_umap-567"><a href="#Clustering.knee_plot_umap-567"><span class="linenos">567</span></a>                <span class="n">score</span> <span class="o">=</span> <span class="n">silhouette_score</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">umap</span><span class="p">)[:,</span> <span class="p">:</span><span class="n">n</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
</span><span id="Clustering.knee_plot_umap-568"><a href="#Clustering.knee_plot_umap-568"><span class="linenos">568</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering.knee_plot_umap-569"><a href="#Clustering.knee_plot_umap-569"><span class="linenos">569</span></a>                <span class="n">score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="Clustering.knee_plot_umap-570"><a href="#Clustering.knee_plot_umap-570"><span class="linenos">570</span></a>
</span><span id="Clustering.knee_plot_umap-571"><a href="#Clustering.knee_plot_umap-571"><span class="linenos">571</span></a>            <span class="n">silhouette_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
</span><span id="Clustering.knee_plot_umap-572"><a href="#Clustering.knee_plot_umap-572"><span class="linenos">572</span></a>            <span class="n">component</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span id="Clustering.knee_plot_umap-573"><a href="#Clustering.knee_plot_umap-573"><span class="linenos">573</span></a>
</span><span id="Clustering.knee_plot_umap-574"><a href="#Clustering.knee_plot_umap-574"><span class="linenos">574</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="Clustering.knee_plot_umap-575"><a href="#Clustering.knee_plot_umap-575"><span class="linenos">575</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">silhouette_scores</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
</span><span id="Clustering.knee_plot_umap-576"><a href="#Clustering.knee_plot_umap-576"><span class="linenos">576</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP (n_components)&quot;</span><span class="p">)</span>
</span><span id="Clustering.knee_plot_umap-577"><a href="#Clustering.knee_plot_umap-577"><span class="linenos">577</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Silhouette Score&quot;</span><span class="p">)</span>
</span><span id="Clustering.knee_plot_umap-578"><a href="#Clustering.knee_plot_umap-578"><span class="linenos">578</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Clustering.knee_plot_umap-579"><a href="#Clustering.knee_plot_umap-579"><span class="linenos">579</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">component</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">component</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="Clustering.knee_plot_umap-580"><a href="#Clustering.knee_plot_umap-580"><span class="linenos">580</span></a>
</span><span id="Clustering.knee_plot_umap-581"><a href="#Clustering.knee_plot_umap-581"><span class="linenos">581</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="Clustering.knee_plot_umap-582"><a href="#Clustering.knee_plot_umap-582"><span class="linenos">582</span></a>
</span><span id="Clustering.knee_plot_umap-583"><a href="#Clustering.knee_plot_umap-583"><span class="linenos">583</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span></pre></div>


            <div class="docstring"><p>Plot silhouette scores for different UMAP dimensions to determine optimal n_components.</p>

<h2 id="parameters">Parameters</h2>

<p>eps : float, default 0.5
    DBSCAN eps parameter for clustering each UMAP dimension.</p>

<p>min_samples : int, default 10
    Minimum number of samples to form a cluster in DBSCAN.</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.figure.Figure
    Silhouette score plot across UMAP dimensions.</p>
</div>


                            </div>
                            <div id="Clustering.find_clusters_UMAP" class="classattr">
                                        <input id="Clustering.find_clusters_UMAP-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">find_clusters_UMAP</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">umap_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>,</span><span class="param">	<span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span>,</span><span class="param">	<span class="n">min_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>,</span><span class="param">	<span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Clustering.find_clusters_UMAP-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Clustering.find_clusters_UMAP"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Clustering.find_clusters_UMAP-585"><a href="#Clustering.find_clusters_UMAP-585"><span class="linenos">585</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_clusters_UMAP</span><span class="p">(</span>
</span><span id="Clustering.find_clusters_UMAP-586"><a href="#Clustering.find_clusters_UMAP-586"><span class="linenos">586</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Clustering.find_clusters_UMAP-587"><a href="#Clustering.find_clusters_UMAP-587"><span class="linenos">587</span></a>        <span class="n">umap_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="Clustering.find_clusters_UMAP-588"><a href="#Clustering.find_clusters_UMAP-588"><span class="linenos">588</span></a>        <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="Clustering.find_clusters_UMAP-589"><a href="#Clustering.find_clusters_UMAP-589"><span class="linenos">589</span></a>        <span class="n">min_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="Clustering.find_clusters_UMAP-590"><a href="#Clustering.find_clusters_UMAP-590"><span class="linenos">590</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="Clustering.find_clusters_UMAP-591"><a href="#Clustering.find_clusters_UMAP-591"><span class="linenos">591</span></a>        <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="Clustering.find_clusters_UMAP-592"><a href="#Clustering.find_clusters_UMAP-592"><span class="linenos">592</span></a>    <span class="p">):</span>
</span><span id="Clustering.find_clusters_UMAP-593"><a href="#Clustering.find_clusters_UMAP-593"><span class="linenos">593</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering.find_clusters_UMAP-594"><a href="#Clustering.find_clusters_UMAP-594"><span class="linenos">594</span></a><span class="sd">        Apply DBSCAN clustering on UMAP embeddings and visualize clusters.</span>
</span><span id="Clustering.find_clusters_UMAP-595"><a href="#Clustering.find_clusters_UMAP-595"><span class="linenos">595</span></a>
</span><span id="Clustering.find_clusters_UMAP-596"><a href="#Clustering.find_clusters_UMAP-596"><span class="linenos">596</span></a><span class="sd">        This method performs density-based clustering (DBSCAN) on the UMAP-reduced</span>
</span><span id="Clustering.find_clusters_UMAP-597"><a href="#Clustering.find_clusters_UMAP-597"><span class="linenos">597</span></a><span class="sd">        dataset. Cluster labels are stored in the object&#39;s metadata, and a scatter</span>
</span><span id="Clustering.find_clusters_UMAP-598"><a href="#Clustering.find_clusters_UMAP-598"><span class="linenos">598</span></a><span class="sd">        plot of the first two UMAP components with cluster annotations is returned.</span>
</span><span id="Clustering.find_clusters_UMAP-599"><a href="#Clustering.find_clusters_UMAP-599"><span class="linenos">599</span></a>
</span><span id="Clustering.find_clusters_UMAP-600"><a href="#Clustering.find_clusters_UMAP-600"><span class="linenos">600</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering.find_clusters_UMAP-601"><a href="#Clustering.find_clusters_UMAP-601"><span class="linenos">601</span></a><span class="sd">        ----------</span>
</span><span id="Clustering.find_clusters_UMAP-602"><a href="#Clustering.find_clusters_UMAP-602"><span class="linenos">602</span></a><span class="sd">        umap_n : int, default 5</span>
</span><span id="Clustering.find_clusters_UMAP-603"><a href="#Clustering.find_clusters_UMAP-603"><span class="linenos">603</span></a><span class="sd">            Number of UMAP dimensions to use for DBSCAN clustering.</span>
</span><span id="Clustering.find_clusters_UMAP-604"><a href="#Clustering.find_clusters_UMAP-604"><span class="linenos">604</span></a><span class="sd">            Must be &lt;= number of columns in `self.umap`.</span>
</span><span id="Clustering.find_clusters_UMAP-605"><a href="#Clustering.find_clusters_UMAP-605"><span class="linenos">605</span></a>
</span><span id="Clustering.find_clusters_UMAP-606"><a href="#Clustering.find_clusters_UMAP-606"><span class="linenos">606</span></a><span class="sd">        eps : float | int, default 0.5</span>
</span><span id="Clustering.find_clusters_UMAP-607"><a href="#Clustering.find_clusters_UMAP-607"><span class="linenos">607</span></a><span class="sd">            Maximum neighborhood distance between two samples for them to be considered</span>
</span><span id="Clustering.find_clusters_UMAP-608"><a href="#Clustering.find_clusters_UMAP-608"><span class="linenos">608</span></a><span class="sd">            as in the same cluster (DBSCAN parameter).</span>
</span><span id="Clustering.find_clusters_UMAP-609"><a href="#Clustering.find_clusters_UMAP-609"><span class="linenos">609</span></a>
</span><span id="Clustering.find_clusters_UMAP-610"><a href="#Clustering.find_clusters_UMAP-610"><span class="linenos">610</span></a><span class="sd">        min_samples : int, default 10</span>
</span><span id="Clustering.find_clusters_UMAP-611"><a href="#Clustering.find_clusters_UMAP-611"><span class="linenos">611</span></a><span class="sd">            Minimum number of samples in a neighborhood to form a cluster (DBSCAN parameter).</span>
</span><span id="Clustering.find_clusters_UMAP-612"><a href="#Clustering.find_clusters_UMAP-612"><span class="linenos">612</span></a>
</span><span id="Clustering.find_clusters_UMAP-613"><a href="#Clustering.find_clusters_UMAP-613"><span class="linenos">613</span></a><span class="sd">        width : int, default 8</span>
</span><span id="Clustering.find_clusters_UMAP-614"><a href="#Clustering.find_clusters_UMAP-614"><span class="linenos">614</span></a><span class="sd">            Figure width.</span>
</span><span id="Clustering.find_clusters_UMAP-615"><a href="#Clustering.find_clusters_UMAP-615"><span class="linenos">615</span></a>
</span><span id="Clustering.find_clusters_UMAP-616"><a href="#Clustering.find_clusters_UMAP-616"><span class="linenos">616</span></a><span class="sd">        height : int, default 6</span>
</span><span id="Clustering.find_clusters_UMAP-617"><a href="#Clustering.find_clusters_UMAP-617"><span class="linenos">617</span></a><span class="sd">            Figure height.</span>
</span><span id="Clustering.find_clusters_UMAP-618"><a href="#Clustering.find_clusters_UMAP-618"><span class="linenos">618</span></a>
</span><span id="Clustering.find_clusters_UMAP-619"><a href="#Clustering.find_clusters_UMAP-619"><span class="linenos">619</span></a><span class="sd">        Returns</span>
</span><span id="Clustering.find_clusters_UMAP-620"><a href="#Clustering.find_clusters_UMAP-620"><span class="linenos">620</span></a><span class="sd">        -------</span>
</span><span id="Clustering.find_clusters_UMAP-621"><a href="#Clustering.find_clusters_UMAP-621"><span class="linenos">621</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="Clustering.find_clusters_UMAP-622"><a href="#Clustering.find_clusters_UMAP-622"><span class="linenos">622</span></a><span class="sd">            Scatter plot of the first two UMAP components colored by</span>
</span><span id="Clustering.find_clusters_UMAP-623"><a href="#Clustering.find_clusters_UMAP-623"><span class="linenos">623</span></a><span class="sd">            cluster assignments.</span>
</span><span id="Clustering.find_clusters_UMAP-624"><a href="#Clustering.find_clusters_UMAP-624"><span class="linenos">624</span></a>
</span><span id="Clustering.find_clusters_UMAP-625"><a href="#Clustering.find_clusters_UMAP-625"><span class="linenos">625</span></a><span class="sd">        Updates</span>
</span><span id="Clustering.find_clusters_UMAP-626"><a href="#Clustering.find_clusters_UMAP-626"><span class="linenos">626</span></a><span class="sd">        -------</span>
</span><span id="Clustering.find_clusters_UMAP-627"><a href="#Clustering.find_clusters_UMAP-627"><span class="linenos">627</span></a><span class="sd">        self.clustering_metadata[&#39;UMAP_clusters&#39;] : list</span>
</span><span id="Clustering.find_clusters_UMAP-628"><a href="#Clustering.find_clusters_UMAP-628"><span class="linenos">628</span></a><span class="sd">            Cluster labels assigned to each cell/sample.</span>
</span><span id="Clustering.find_clusters_UMAP-629"><a href="#Clustering.find_clusters_UMAP-629"><span class="linenos">629</span></a>
</span><span id="Clustering.find_clusters_UMAP-630"><a href="#Clustering.find_clusters_UMAP-630"><span class="linenos">630</span></a><span class="sd">        self.input_metadata[&#39;UMAP_clusters&#39;] : list, optional</span>
</span><span id="Clustering.find_clusters_UMAP-631"><a href="#Clustering.find_clusters_UMAP-631"><span class="linenos">631</span></a><span class="sd">            Cluster labels stored in input metadata (if available).</span>
</span><span id="Clustering.find_clusters_UMAP-632"><a href="#Clustering.find_clusters_UMAP-632"><span class="linenos">632</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering.find_clusters_UMAP-633"><a href="#Clustering.find_clusters_UMAP-633"><span class="linenos">633</span></a>
</span><span id="Clustering.find_clusters_UMAP-634"><a href="#Clustering.find_clusters_UMAP-634"><span class="linenos">634</span></a>        <span class="n">dbscan</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="n">min_samples</span><span class="p">)</span>
</span><span id="Clustering.find_clusters_UMAP-635"><a href="#Clustering.find_clusters_UMAP-635"><span class="linenos">635</span></a>        <span class="n">dbscan_labels</span> <span class="o">=</span> <span class="n">dbscan</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">umap</span><span class="p">)[:,</span> <span class="p">:</span><span class="n">umap_n</span><span class="p">])</span>
</span><span id="Clustering.find_clusters_UMAP-636"><a href="#Clustering.find_clusters_UMAP-636"><span class="linenos">636</span></a>
</span><span id="Clustering.find_clusters_UMAP-637"><a href="#Clustering.find_clusters_UMAP-637"><span class="linenos">637</span></a>        <span class="n">umap_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">umap</span>
</span><span id="Clustering.find_clusters_UMAP-638"><a href="#Clustering.find_clusters_UMAP-638"><span class="linenos">638</span></a>        <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbscan_labels</span>
</span><span id="Clustering.find_clusters_UMAP-639"><a href="#Clustering.find_clusters_UMAP-639"><span class="linenos">639</span></a>
</span><span id="Clustering.find_clusters_UMAP-640"><a href="#Clustering.find_clusters_UMAP-640"><span class="linenos">640</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="Clustering.find_clusters_UMAP-641"><a href="#Clustering.find_clusters_UMAP-641"><span class="linenos">641</span></a>
</span><span id="Clustering.find_clusters_UMAP-642"><a href="#Clustering.find_clusters_UMAP-642"><span class="linenos">642</span></a>        <span class="k">for</span> <span class="n">cluster_id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
</span><span id="Clustering.find_clusters_UMAP-643"><a href="#Clustering.find_clusters_UMAP-643"><span class="linenos">643</span></a>            <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">umap_df</span><span class="p">[</span><span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cluster_id</span><span class="p">]</span>
</span><span id="Clustering.find_clusters_UMAP-644"><a href="#Clustering.find_clusters_UMAP-644"><span class="linenos">644</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="Clustering.find_clusters_UMAP-645"><a href="#Clustering.find_clusters_UMAP-645"><span class="linenos">645</span></a>                <span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;UMAP1&quot;</span><span class="p">],</span>
</span><span id="Clustering.find_clusters_UMAP-646"><a href="#Clustering.find_clusters_UMAP-646"><span class="linenos">646</span></a>                <span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;UMAP2&quot;</span><span class="p">],</span>
</span><span id="Clustering.find_clusters_UMAP-647"><a href="#Clustering.find_clusters_UMAP-647"><span class="linenos">647</span></a>                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cluster </span><span class="si">{</span><span class="n">cluster_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Clustering.find_clusters_UMAP-648"><a href="#Clustering.find_clusters_UMAP-648"><span class="linenos">648</span></a>                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span><span id="Clustering.find_clusters_UMAP-649"><a href="#Clustering.find_clusters_UMAP-649"><span class="linenos">649</span></a>            <span class="p">)</span>
</span><span id="Clustering.find_clusters_UMAP-650"><a href="#Clustering.find_clusters_UMAP-650"><span class="linenos">650</span></a>
</span><span id="Clustering.find_clusters_UMAP-651"><a href="#Clustering.find_clusters_UMAP-651"><span class="linenos">651</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">)</span>
</span><span id="Clustering.find_clusters_UMAP-652"><a href="#Clustering.find_clusters_UMAP-652"><span class="linenos">652</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">)</span>
</span><span id="Clustering.find_clusters_UMAP-653"><a href="#Clustering.find_clusters_UMAP-653"><span class="linenos">653</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Clusters&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
</span><span id="Clustering.find_clusters_UMAP-654"><a href="#Clustering.find_clusters_UMAP-654"><span class="linenos">654</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Clustering.find_clusters_UMAP-655"><a href="#Clustering.find_clusters_UMAP-655"><span class="linenos">655</span></a>
</span><span id="Clustering.find_clusters_UMAP-656"><a href="#Clustering.find_clusters_UMAP-656"><span class="linenos">656</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;UMAP_clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dbscan_labels</span><span class="p">]</span>
</span><span id="Clustering.find_clusters_UMAP-657"><a href="#Clustering.find_clusters_UMAP-657"><span class="linenos">657</span></a>
</span><span id="Clustering.find_clusters_UMAP-658"><a href="#Clustering.find_clusters_UMAP-658"><span class="linenos">658</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Clustering.find_clusters_UMAP-659"><a href="#Clustering.find_clusters_UMAP-659"><span class="linenos">659</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;UMAP_clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dbscan_labels</span><span class="p">]</span>
</span><span id="Clustering.find_clusters_UMAP-660"><a href="#Clustering.find_clusters_UMAP-660"><span class="linenos">660</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="Clustering.find_clusters_UMAP-661"><a href="#Clustering.find_clusters_UMAP-661"><span class="linenos">661</span></a>            <span class="k">pass</span>
</span><span id="Clustering.find_clusters_UMAP-662"><a href="#Clustering.find_clusters_UMAP-662"><span class="linenos">662</span></a>
</span><span id="Clustering.find_clusters_UMAP-663"><a href="#Clustering.find_clusters_UMAP-663"><span class="linenos">663</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span></pre></div>


            <div class="docstring"><p>Apply DBSCAN clustering on UMAP embeddings and visualize clusters.</p>

<p>This method performs density-based clustering (DBSCAN) on the UMAP-reduced
dataset. Cluster labels are stored in the object's metadata, and a scatter
plot of the first two UMAP components with cluster annotations is returned.</p>

<h2 id="parameters">Parameters</h2>

<p>umap_n : int, default 5
    Number of UMAP dimensions to use for DBSCAN clustering.
    Must be &lt;= number of columns in <code>self.umap</code>.</p>

<p>eps : float | int, default 0.5
    Maximum neighborhood distance between two samples for them to be considered
    as in the same cluster (DBSCAN parameter).</p>

<p>min_samples : int, default 10
    Minimum number of samples in a neighborhood to form a cluster (DBSCAN parameter).</p>

<p>width : int, default 8
    Figure width.</p>

<p>height : int, default 6
    Figure height.</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.figure.Figure
    Scatter plot of the first two UMAP components colored by
    cluster assignments.</p>

<h2 id="updates">Updates</h2>

<p>self.clustering_metadata['UMAP_clusters'] : list
    Cluster labels assigned to each cell/sample.</p>

<p>self.input_metadata['UMAP_clusters'] : list, optional
    Cluster labels stored in input metadata (if available).</p>
</div>


                            </div>
                            <div id="Clustering.UMAP_vis" class="classattr">
                                        <input id="Clustering.UMAP_vis-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">UMAP_vis</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">names_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cell_names&#39;</span>,</span><span class="param">	<span class="n">set_sep</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">point_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span>,</span><span class="param">	<span class="n">font_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">6</span>,</span><span class="param">	<span class="n">legend_split_col</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>,</span><span class="param">	<span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>,</span><span class="param">	<span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span>,</span><span class="param">	<span class="n">inc_num</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Clustering.UMAP_vis-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Clustering.UMAP_vis"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Clustering.UMAP_vis-665"><a href="#Clustering.UMAP_vis-665"><span class="linenos">665</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">UMAP_vis</span><span class="p">(</span>
</span><span id="Clustering.UMAP_vis-666"><a href="#Clustering.UMAP_vis-666"><span class="linenos">666</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-667"><a href="#Clustering.UMAP_vis-667"><span class="linenos">667</span></a>        <span class="n">names_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-668"><a href="#Clustering.UMAP_vis-668"><span class="linenos">668</span></a>        <span class="n">set_sep</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-669"><a href="#Clustering.UMAP_vis-669"><span class="linenos">669</span></a>        <span class="n">point_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-670"><a href="#Clustering.UMAP_vis-670"><span class="linenos">670</span></a>        <span class="n">font_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-671"><a href="#Clustering.UMAP_vis-671"><span class="linenos">671</span></a>        <span class="n">legend_split_col</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-672"><a href="#Clustering.UMAP_vis-672"><span class="linenos">672</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-673"><a href="#Clustering.UMAP_vis-673"><span class="linenos">673</span></a>        <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-674"><a href="#Clustering.UMAP_vis-674"><span class="linenos">674</span></a>        <span class="n">inc_num</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-675"><a href="#Clustering.UMAP_vis-675"><span class="linenos">675</span></a>    <span class="p">):</span>
</span><span id="Clustering.UMAP_vis-676"><a href="#Clustering.UMAP_vis-676"><span class="linenos">676</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering.UMAP_vis-677"><a href="#Clustering.UMAP_vis-677"><span class="linenos">677</span></a><span class="sd">        Visualize UMAP embeddings with sample labels based on specyfic metadata slot.</span>
</span><span id="Clustering.UMAP_vis-678"><a href="#Clustering.UMAP_vis-678"><span class="linenos">678</span></a>
</span><span id="Clustering.UMAP_vis-679"><a href="#Clustering.UMAP_vis-679"><span class="linenos">679</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering.UMAP_vis-680"><a href="#Clustering.UMAP_vis-680"><span class="linenos">680</span></a><span class="sd">        ----------</span>
</span><span id="Clustering.UMAP_vis-681"><a href="#Clustering.UMAP_vis-681"><span class="linenos">681</span></a><span class="sd">        names_slot : str, default &#39;cell_names&#39;</span>
</span><span id="Clustering.UMAP_vis-682"><a href="#Clustering.UMAP_vis-682"><span class="linenos">682</span></a><span class="sd">            Column in metadata to use as sample labels.</span>
</span><span id="Clustering.UMAP_vis-683"><a href="#Clustering.UMAP_vis-683"><span class="linenos">683</span></a>
</span><span id="Clustering.UMAP_vis-684"><a href="#Clustering.UMAP_vis-684"><span class="linenos">684</span></a><span class="sd">        set_sep : bool, default True</span>
</span><span id="Clustering.UMAP_vis-685"><a href="#Clustering.UMAP_vis-685"><span class="linenos">685</span></a><span class="sd">            If True, separate points by dataset.</span>
</span><span id="Clustering.UMAP_vis-686"><a href="#Clustering.UMAP_vis-686"><span class="linenos">686</span></a>
</span><span id="Clustering.UMAP_vis-687"><a href="#Clustering.UMAP_vis-687"><span class="linenos">687</span></a><span class="sd">        point_size : float, default 0.6</span>
</span><span id="Clustering.UMAP_vis-688"><a href="#Clustering.UMAP_vis-688"><span class="linenos">688</span></a><span class="sd">            Size of scatter points.</span>
</span><span id="Clustering.UMAP_vis-689"><a href="#Clustering.UMAP_vis-689"><span class="linenos">689</span></a>
</span><span id="Clustering.UMAP_vis-690"><a href="#Clustering.UMAP_vis-690"><span class="linenos">690</span></a><span class="sd">        font_size : int, default 6</span>
</span><span id="Clustering.UMAP_vis-691"><a href="#Clustering.UMAP_vis-691"><span class="linenos">691</span></a><span class="sd">            Font size for numbers on points.</span>
</span><span id="Clustering.UMAP_vis-692"><a href="#Clustering.UMAP_vis-692"><span class="linenos">692</span></a>
</span><span id="Clustering.UMAP_vis-693"><a href="#Clustering.UMAP_vis-693"><span class="linenos">693</span></a><span class="sd">        legend_split_col : int, default 2</span>
</span><span id="Clustering.UMAP_vis-694"><a href="#Clustering.UMAP_vis-694"><span class="linenos">694</span></a><span class="sd">            Number of columns in legend.</span>
</span><span id="Clustering.UMAP_vis-695"><a href="#Clustering.UMAP_vis-695"><span class="linenos">695</span></a>
</span><span id="Clustering.UMAP_vis-696"><a href="#Clustering.UMAP_vis-696"><span class="linenos">696</span></a><span class="sd">        width : int, default 8</span>
</span><span id="Clustering.UMAP_vis-697"><a href="#Clustering.UMAP_vis-697"><span class="linenos">697</span></a><span class="sd">            Figure width.</span>
</span><span id="Clustering.UMAP_vis-698"><a href="#Clustering.UMAP_vis-698"><span class="linenos">698</span></a>
</span><span id="Clustering.UMAP_vis-699"><a href="#Clustering.UMAP_vis-699"><span class="linenos">699</span></a><span class="sd">        height : int, default 6</span>
</span><span id="Clustering.UMAP_vis-700"><a href="#Clustering.UMAP_vis-700"><span class="linenos">700</span></a><span class="sd">            Figure height.</span>
</span><span id="Clustering.UMAP_vis-701"><a href="#Clustering.UMAP_vis-701"><span class="linenos">701</span></a>
</span><span id="Clustering.UMAP_vis-702"><a href="#Clustering.UMAP_vis-702"><span class="linenos">702</span></a><span class="sd">        inc_num : bool, default True</span>
</span><span id="Clustering.UMAP_vis-703"><a href="#Clustering.UMAP_vis-703"><span class="linenos">703</span></a><span class="sd">            If True, annotate points with numeric labels.</span>
</span><span id="Clustering.UMAP_vis-704"><a href="#Clustering.UMAP_vis-704"><span class="linenos">704</span></a>
</span><span id="Clustering.UMAP_vis-705"><a href="#Clustering.UMAP_vis-705"><span class="linenos">705</span></a><span class="sd">        Returns</span>
</span><span id="Clustering.UMAP_vis-706"><a href="#Clustering.UMAP_vis-706"><span class="linenos">706</span></a><span class="sd">        -------</span>
</span><span id="Clustering.UMAP_vis-707"><a href="#Clustering.UMAP_vis-707"><span class="linenos">707</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="Clustering.UMAP_vis-708"><a href="#Clustering.UMAP_vis-708"><span class="linenos">708</span></a><span class="sd">            UMAP scatter plot figure.</span>
</span><span id="Clustering.UMAP_vis-709"><a href="#Clustering.UMAP_vis-709"><span class="linenos">709</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering.UMAP_vis-710"><a href="#Clustering.UMAP_vis-710"><span class="linenos">710</span></a>
</span><span id="Clustering.UMAP_vis-711"><a href="#Clustering.UMAP_vis-711"><span class="linenos">711</span></a>        <span class="n">umap_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">umap</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Clustering.UMAP_vis-712"><a href="#Clustering.UMAP_vis-712"><span class="linenos">712</span></a>        <span class="n">umap_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="n">names_slot</span><span class="p">]</span>
</span><span id="Clustering.UMAP_vis-713"><a href="#Clustering.UMAP_vis-713"><span class="linenos">713</span></a>
</span><span id="Clustering.UMAP_vis-714"><a href="#Clustering.UMAP_vis-714"><span class="linenos">714</span></a>        <span class="k">if</span> <span class="n">set_sep</span><span class="p">:</span>
</span><span id="Clustering.UMAP_vis-715"><a href="#Clustering.UMAP_vis-715"><span class="linenos">715</span></a>
</span><span id="Clustering.UMAP_vis-716"><a href="#Clustering.UMAP_vis-716"><span class="linenos">716</span></a>            <span class="k">if</span> <span class="s2">&quot;sets&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="Clustering.UMAP_vis-717"><a href="#Clustering.UMAP_vis-717"><span class="linenos">717</span></a>                <span class="n">umap_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="Clustering.UMAP_vis-718"><a href="#Clustering.UMAP_vis-718"><span class="linenos">718</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering.UMAP_vis-719"><a href="#Clustering.UMAP_vis-719"><span class="linenos">719</span></a>                <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
</span><span id="Clustering.UMAP_vis-720"><a href="#Clustering.UMAP_vis-720"><span class="linenos">720</span></a>
</span><span id="Clustering.UMAP_vis-721"><a href="#Clustering.UMAP_vis-721"><span class="linenos">721</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering.UMAP_vis-722"><a href="#Clustering.UMAP_vis-722"><span class="linenos">722</span></a>            <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
</span><span id="Clustering.UMAP_vis-723"><a href="#Clustering.UMAP_vis-723"><span class="linenos">723</span></a>
</span><span id="Clustering.UMAP_vis-724"><a href="#Clustering.UMAP_vis-724"><span class="linenos">724</span></a>        <span class="n">umap_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;tmp_nam&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span>
</span><span id="Clustering.UMAP_vis-725"><a href="#Clustering.UMAP_vis-725"><span class="linenos">725</span></a>
</span><span id="Clustering.UMAP_vis-726"><a href="#Clustering.UMAP_vis-726"><span class="linenos">726</span></a>        <span class="n">umap_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;tmp_nam&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
</span><span id="Clustering.UMAP_vis-727"><a href="#Clustering.UMAP_vis-727"><span class="linenos">727</span></a>            <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;tmp_nam&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</span><span id="Clustering.UMAP_vis-728"><a href="#Clustering.UMAP_vis-728"><span class="linenos">728</span></a>        <span class="p">)</span>
</span><span id="Clustering.UMAP_vis-729"><a href="#Clustering.UMAP_vis-729"><span class="linenos">729</span></a>
</span><span id="Clustering.UMAP_vis-730"><a href="#Clustering.UMAP_vis-730"><span class="linenos">730</span></a>        <span class="n">numeric_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Clustering.UMAP_vis-731"><a href="#Clustering.UMAP_vis-731"><span class="linenos">731</span></a>            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">umap_df</span><span class="p">[[</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="s2">&quot;tmp_nam&quot;</span><span class="p">,</span> <span class="s2">&quot;names&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</span><span id="Clustering.UMAP_vis-732"><a href="#Clustering.UMAP_vis-732"><span class="linenos">732</span></a>            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
</span><span id="Clustering.UMAP_vis-733"><a href="#Clustering.UMAP_vis-733"><span class="linenos">733</span></a>            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Clustering.UMAP_vis-734"><a href="#Clustering.UMAP_vis-734"><span class="linenos">734</span></a>        <span class="p">)</span>
</span><span id="Clustering.UMAP_vis-735"><a href="#Clustering.UMAP_vis-735"><span class="linenos">735</span></a>        <span class="n">numeric_df</span><span class="p">[</span><span class="s2">&quot;numeric_values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numeric_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Clustering.UMAP_vis-736"><a href="#Clustering.UMAP_vis-736"><span class="linenos">736</span></a>
</span><span id="Clustering.UMAP_vis-737"><a href="#Clustering.UMAP_vis-737"><span class="linenos">737</span></a>        <span class="n">umap_df</span> <span class="o">=</span> <span class="n">umap_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
</span><span id="Clustering.UMAP_vis-738"><a href="#Clustering.UMAP_vis-738"><span class="linenos">738</span></a>            <span class="n">numeric_df</span><span class="p">[[</span><span class="s2">&quot;tmp_nam&quot;</span><span class="p">,</span> <span class="s2">&quot;numeric_values&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;tmp_nam&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
</span><span id="Clustering.UMAP_vis-739"><a href="#Clustering.UMAP_vis-739"><span class="linenos">739</span></a>        <span class="p">)</span>
</span><span id="Clustering.UMAP_vis-740"><a href="#Clustering.UMAP_vis-740"><span class="linenos">740</span></a>
</span><span id="Clustering.UMAP_vis-741"><a href="#Clustering.UMAP_vis-741"><span class="linenos">741</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="Clustering.UMAP_vis-742"><a href="#Clustering.UMAP_vis-742"><span class="linenos">742</span></a>
</span><span id="Clustering.UMAP_vis-743"><a href="#Clustering.UMAP_vis-743"><span class="linenos">743</span></a>        <span class="n">markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">]</span>
</span><span id="Clustering.UMAP_vis-744"><a href="#Clustering.UMAP_vis-744"><span class="linenos">744</span></a>        <span class="n">marker_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Clustering.UMAP_vis-745"><a href="#Clustering.UMAP_vis-745"><span class="linenos">745</span></a>            <span class="n">ds</span><span class="p">:</span> <span class="n">markers</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">markers</span><span class="p">)]</span>
</span><span id="Clustering.UMAP_vis-746"><a href="#Clustering.UMAP_vis-746"><span class="linenos">746</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</span><span id="Clustering.UMAP_vis-747"><a href="#Clustering.UMAP_vis-747"><span class="linenos">747</span></a>        <span class="p">}</span>
</span><span id="Clustering.UMAP_vis-748"><a href="#Clustering.UMAP_vis-748"><span class="linenos">748</span></a>
</span><span id="Clustering.UMAP_vis-749"><a href="#Clustering.UMAP_vis-749"><span class="linenos">749</span></a>        <span class="n">cord_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Clustering.UMAP_vis-750"><a href="#Clustering.UMAP_vis-750"><span class="linenos">750</span></a>
</span><span id="Clustering.UMAP_vis-751"><a href="#Clustering.UMAP_vis-751"><span class="linenos">751</span></a>        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">nam</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">numeric_df</span><span class="p">[</span><span class="s2">&quot;numeric_values&quot;</span><span class="p">],</span> <span class="n">numeric_df</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]):</span>
</span><span id="Clustering.UMAP_vis-752"><a href="#Clustering.UMAP_vis-752"><span class="linenos">752</span></a>
</span><span id="Clustering.UMAP_vis-753"><a href="#Clustering.UMAP_vis-753"><span class="linenos">753</span></a>            <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">umap_df</span><span class="p">[</span><span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;numeric_values&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">num</span><span class="p">]</span>
</span><span id="Clustering.UMAP_vis-754"><a href="#Clustering.UMAP_vis-754"><span class="linenos">754</span></a>
</span><span id="Clustering.UMAP_vis-755"><a href="#Clustering.UMAP_vis-755"><span class="linenos">755</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="Clustering.UMAP_vis-756"><a href="#Clustering.UMAP_vis-756"><span class="linenos">756</span></a>                <span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;UMAP1&quot;</span><span class="p">],</span>
</span><span id="Clustering.UMAP_vis-757"><a href="#Clustering.UMAP_vis-757"><span class="linenos">757</span></a>                <span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;UMAP2&quot;</span><span class="p">],</span>
</span><span id="Clustering.UMAP_vis-758"><a href="#Clustering.UMAP_vis-758"><span class="linenos">758</span></a>                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">nam</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-759"><a href="#Clustering.UMAP_vis-759"><span class="linenos">759</span></a>                <span class="n">marker</span><span class="o">=</span><span class="n">marker_map</span><span class="p">[</span><span class="n">cluster_data</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="Clustering.UMAP_vis-760"><a href="#Clustering.UMAP_vis-760"><span class="linenos">760</span></a>                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-761"><a href="#Clustering.UMAP_vis-761"><span class="linenos">761</span></a>                <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-762"><a href="#Clustering.UMAP_vis-762"><span class="linenos">762</span></a>            <span class="p">)</span>
</span><span id="Clustering.UMAP_vis-763"><a href="#Clustering.UMAP_vis-763"><span class="linenos">763</span></a>
</span><span id="Clustering.UMAP_vis-764"><a href="#Clustering.UMAP_vis-764"><span class="linenos">764</span></a>            <span class="n">coords</span> <span class="o">=</span> <span class="n">cluster_data</span><span class="p">[[</span><span class="s2">&quot;UMAP1&quot;</span><span class="p">,</span> <span class="s2">&quot;UMAP2&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="Clustering.UMAP_vis-765"><a href="#Clustering.UMAP_vis-765"><span class="linenos">765</span></a>
</span><span id="Clustering.UMAP_vis-766"><a href="#Clustering.UMAP_vis-766"><span class="linenos">766</span></a>            <span class="n">dists</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</span><span id="Clustering.UMAP_vis-767"><a href="#Clustering.UMAP_vis-767"><span class="linenos">767</span></a>
</span><span id="Clustering.UMAP_vis-768"><a href="#Clustering.UMAP_vis-768"><span class="linenos">768</span></a>            <span class="n">sum_dists</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Clustering.UMAP_vis-769"><a href="#Clustering.UMAP_vis-769"><span class="linenos">769</span></a>
</span><span id="Clustering.UMAP_vis-770"><a href="#Clustering.UMAP_vis-770"><span class="linenos">770</span></a>            <span class="n">center_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">sum_dists</span><span class="p">)</span>
</span><span id="Clustering.UMAP_vis-771"><a href="#Clustering.UMAP_vis-771"><span class="linenos">771</span></a>            <span class="n">center_point</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">center_idx</span><span class="p">]</span>
</span><span id="Clustering.UMAP_vis-772"><a href="#Clustering.UMAP_vis-772"><span class="linenos">772</span></a>
</span><span id="Clustering.UMAP_vis-773"><a href="#Clustering.UMAP_vis-773"><span class="linenos">773</span></a>            <span class="n">cord_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">center_point</span><span class="p">)</span>
</span><span id="Clustering.UMAP_vis-774"><a href="#Clustering.UMAP_vis-774"><span class="linenos">774</span></a>
</span><span id="Clustering.UMAP_vis-775"><a href="#Clustering.UMAP_vis-775"><span class="linenos">775</span></a>        <span class="k">if</span> <span class="n">inc_num</span><span class="p">:</span>
</span><span id="Clustering.UMAP_vis-776"><a href="#Clustering.UMAP_vis-776"><span class="linenos">776</span></a>            <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Clustering.UMAP_vis-777"><a href="#Clustering.UMAP_vis-777"><span class="linenos">777</span></a>            <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cord_list</span><span class="p">,</span> <span class="n">numeric_df</span><span class="p">[</span><span class="s2">&quot;numeric_values&quot;</span><span class="p">]):</span>
</span><span id="Clustering.UMAP_vis-778"><a href="#Clustering.UMAP_vis-778"><span class="linenos">778</span></a>                <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Clustering.UMAP_vis-779"><a href="#Clustering.UMAP_vis-779"><span class="linenos">779</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="Clustering.UMAP_vis-780"><a href="#Clustering.UMAP_vis-780"><span class="linenos">780</span></a>                        <span class="n">x</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-781"><a href="#Clustering.UMAP_vis-781"><span class="linenos">781</span></a>                        <span class="n">y</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-782"><a href="#Clustering.UMAP_vis-782"><span class="linenos">782</span></a>                        <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">),</span>
</span><span id="Clustering.UMAP_vis-783"><a href="#Clustering.UMAP_vis-783"><span class="linenos">783</span></a>                        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-784"><a href="#Clustering.UMAP_vis-784"><span class="linenos">784</span></a>                        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-785"><a href="#Clustering.UMAP_vis-785"><span class="linenos">785</span></a>                        <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-786"><a href="#Clustering.UMAP_vis-786"><span class="linenos">786</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-787"><a href="#Clustering.UMAP_vis-787"><span class="linenos">787</span></a>                    <span class="p">)</span>
</span><span id="Clustering.UMAP_vis-788"><a href="#Clustering.UMAP_vis-788"><span class="linenos">788</span></a>                <span class="p">)</span>
</span><span id="Clustering.UMAP_vis-789"><a href="#Clustering.UMAP_vis-789"><span class="linenos">789</span></a>
</span><span id="Clustering.UMAP_vis-790"><a href="#Clustering.UMAP_vis-790"><span class="linenos">790</span></a>            <span class="n">adjust_text</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>
</span><span id="Clustering.UMAP_vis-791"><a href="#Clustering.UMAP_vis-791"><span class="linenos">791</span></a>
</span><span id="Clustering.UMAP_vis-792"><a href="#Clustering.UMAP_vis-792"><span class="linenos">792</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">)</span>
</span><span id="Clustering.UMAP_vis-793"><a href="#Clustering.UMAP_vis-793"><span class="linenos">793</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">)</span>
</span><span id="Clustering.UMAP_vis-794"><a href="#Clustering.UMAP_vis-794"><span class="linenos">794</span></a>
</span><span id="Clustering.UMAP_vis-795"><a href="#Clustering.UMAP_vis-795"><span class="linenos">795</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="Clustering.UMAP_vis-796"><a href="#Clustering.UMAP_vis-796"><span class="linenos">796</span></a>            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Clusters&quot;</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-797"><a href="#Clustering.UMAP_vis-797"><span class="linenos">797</span></a>            <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-798"><a href="#Clustering.UMAP_vis-798"><span class="linenos">798</span></a>            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
</span><span id="Clustering.UMAP_vis-799"><a href="#Clustering.UMAP_vis-799"><span class="linenos">799</span></a>            <span class="n">ncol</span><span class="o">=</span><span class="n">legend_split_col</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-800"><a href="#Clustering.UMAP_vis-800"><span class="linenos">800</span></a>            <span class="n">markerscale</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="Clustering.UMAP_vis-801"><a href="#Clustering.UMAP_vis-801"><span class="linenos">801</span></a>        <span class="p">)</span>
</span><span id="Clustering.UMAP_vis-802"><a href="#Clustering.UMAP_vis-802"><span class="linenos">802</span></a>
</span><span id="Clustering.UMAP_vis-803"><a href="#Clustering.UMAP_vis-803"><span class="linenos">803</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Clustering.UMAP_vis-804"><a href="#Clustering.UMAP_vis-804"><span class="linenos">804</span></a>
</span><span id="Clustering.UMAP_vis-805"><a href="#Clustering.UMAP_vis-805"><span class="linenos">805</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="Clustering.UMAP_vis-806"><a href="#Clustering.UMAP_vis-806"><span class="linenos">806</span></a>
</span><span id="Clustering.UMAP_vis-807"><a href="#Clustering.UMAP_vis-807"><span class="linenos">807</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span></pre></div>


            <div class="docstring"><p>Visualize UMAP embeddings with sample labels based on specyfic metadata slot.</p>

<h2 id="parameters">Parameters</h2>

<p>names_slot : str, default 'cell_names'
    Column in metadata to use as sample labels.</p>

<p>set_sep : bool, default True
    If True, separate points by dataset.</p>

<p>point_size : float, default 0.6
    Size of scatter points.</p>

<p>font_size : int, default 6
    Font size for numbers on points.</p>

<p>legend_split_col : int, default 2
    Number of columns in legend.</p>

<p>width : int, default 8
    Figure width.</p>

<p>height : int, default 6
    Figure height.</p>

<p>inc_num : bool, default True
    If True, annotate points with numeric labels.</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.figure.Figure
    UMAP scatter plot figure.</p>
</div>


                            </div>
                            <div id="Clustering.UMAP_feature" class="classattr">
                                        <input id="Clustering.UMAP_feature-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">UMAP_feature</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">feature_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">features_data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">point_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span>,</span><span class="param">	<span class="n">font_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">6</span>,</span><span class="param">	<span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>,</span><span class="param">	<span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span>,</span><span class="param">	<span class="n">palette</span><span class="o">=</span><span class="s1">&#39;light&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Clustering.UMAP_feature-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Clustering.UMAP_feature"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Clustering.UMAP_feature-809"><a href="#Clustering.UMAP_feature-809"><span class="linenos">809</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">UMAP_feature</span><span class="p">(</span>
</span><span id="Clustering.UMAP_feature-810"><a href="#Clustering.UMAP_feature-810"><span class="linenos">810</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Clustering.UMAP_feature-811"><a href="#Clustering.UMAP_feature-811"><span class="linenos">811</span></a>        <span class="n">feature_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Clustering.UMAP_feature-812"><a href="#Clustering.UMAP_feature-812"><span class="linenos">812</span></a>        <span class="n">features_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Clustering.UMAP_feature-813"><a href="#Clustering.UMAP_feature-813"><span class="linenos">813</span></a>        <span class="n">point_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
</span><span id="Clustering.UMAP_feature-814"><a href="#Clustering.UMAP_feature-814"><span class="linenos">814</span></a>        <span class="n">font_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="Clustering.UMAP_feature-815"><a href="#Clustering.UMAP_feature-815"><span class="linenos">815</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="Clustering.UMAP_feature-816"><a href="#Clustering.UMAP_feature-816"><span class="linenos">816</span></a>        <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="Clustering.UMAP_feature-817"><a href="#Clustering.UMAP_feature-817"><span class="linenos">817</span></a>        <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;light&quot;</span><span class="p">,</span>
</span><span id="Clustering.UMAP_feature-818"><a href="#Clustering.UMAP_feature-818"><span class="linenos">818</span></a>    <span class="p">):</span>
</span><span id="Clustering.UMAP_feature-819"><a href="#Clustering.UMAP_feature-819"><span class="linenos">819</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering.UMAP_feature-820"><a href="#Clustering.UMAP_feature-820"><span class="linenos">820</span></a><span class="sd">        Visualize UMAP embedding with expression levels of a selected feature.</span>
</span><span id="Clustering.UMAP_feature-821"><a href="#Clustering.UMAP_feature-821"><span class="linenos">821</span></a>
</span><span id="Clustering.UMAP_feature-822"><a href="#Clustering.UMAP_feature-822"><span class="linenos">822</span></a><span class="sd">        Each point (cell) in the UMAP plot is colored according to the expression</span>
</span><span id="Clustering.UMAP_feature-823"><a href="#Clustering.UMAP_feature-823"><span class="linenos">823</span></a><span class="sd">        value of the chosen feature, enabling interpretation of spatial patterns</span>
</span><span id="Clustering.UMAP_feature-824"><a href="#Clustering.UMAP_feature-824"><span class="linenos">824</span></a><span class="sd">        of gene activity or metadata distribution in low-dimensional space.</span>
</span><span id="Clustering.UMAP_feature-825"><a href="#Clustering.UMAP_feature-825"><span class="linenos">825</span></a>
</span><span id="Clustering.UMAP_feature-826"><a href="#Clustering.UMAP_feature-826"><span class="linenos">826</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering.UMAP_feature-827"><a href="#Clustering.UMAP_feature-827"><span class="linenos">827</span></a><span class="sd">        ----------</span>
</span><span id="Clustering.UMAP_feature-828"><a href="#Clustering.UMAP_feature-828"><span class="linenos">828</span></a><span class="sd">        feature_name : str</span>
</span><span id="Clustering.UMAP_feature-829"><a href="#Clustering.UMAP_feature-829"><span class="linenos">829</span></a><span class="sd">           Name of the feature to plot.</span>
</span><span id="Clustering.UMAP_feature-830"><a href="#Clustering.UMAP_feature-830"><span class="linenos">830</span></a>
</span><span id="Clustering.UMAP_feature-831"><a href="#Clustering.UMAP_feature-831"><span class="linenos">831</span></a><span class="sd">        features_data : pandas.DataFrame or None, default None</span>
</span><span id="Clustering.UMAP_feature-832"><a href="#Clustering.UMAP_feature-832"><span class="linenos">832</span></a><span class="sd">            If None, the function uses the DataFrame containing the clustering data.</span>
</span><span id="Clustering.UMAP_feature-833"><a href="#Clustering.UMAP_feature-833"><span class="linenos">833</span></a><span class="sd">            To plot features not used in clustering, provide a wider DataFrame</span>
</span><span id="Clustering.UMAP_feature-834"><a href="#Clustering.UMAP_feature-834"><span class="linenos">834</span></a><span class="sd">            containing the original feature values.</span>
</span><span id="Clustering.UMAP_feature-835"><a href="#Clustering.UMAP_feature-835"><span class="linenos">835</span></a>
</span><span id="Clustering.UMAP_feature-836"><a href="#Clustering.UMAP_feature-836"><span class="linenos">836</span></a><span class="sd">        point_size : float, default 0.6</span>
</span><span id="Clustering.UMAP_feature-837"><a href="#Clustering.UMAP_feature-837"><span class="linenos">837</span></a><span class="sd">            Size of scatter points in the plot.</span>
</span><span id="Clustering.UMAP_feature-838"><a href="#Clustering.UMAP_feature-838"><span class="linenos">838</span></a>
</span><span id="Clustering.UMAP_feature-839"><a href="#Clustering.UMAP_feature-839"><span class="linenos">839</span></a><span class="sd">        font_size : int, default 6</span>
</span><span id="Clustering.UMAP_feature-840"><a href="#Clustering.UMAP_feature-840"><span class="linenos">840</span></a><span class="sd">            Font size for axis labels and annotations.</span>
</span><span id="Clustering.UMAP_feature-841"><a href="#Clustering.UMAP_feature-841"><span class="linenos">841</span></a>
</span><span id="Clustering.UMAP_feature-842"><a href="#Clustering.UMAP_feature-842"><span class="linenos">842</span></a><span class="sd">        width : int, default 8</span>
</span><span id="Clustering.UMAP_feature-843"><a href="#Clustering.UMAP_feature-843"><span class="linenos">843</span></a><span class="sd">            Width of the matplotlib figure.</span>
</span><span id="Clustering.UMAP_feature-844"><a href="#Clustering.UMAP_feature-844"><span class="linenos">844</span></a>
</span><span id="Clustering.UMAP_feature-845"><a href="#Clustering.UMAP_feature-845"><span class="linenos">845</span></a><span class="sd">        height : int, default 6</span>
</span><span id="Clustering.UMAP_feature-846"><a href="#Clustering.UMAP_feature-846"><span class="linenos">846</span></a><span class="sd">            Height of the matplotlib figure.</span>
</span><span id="Clustering.UMAP_feature-847"><a href="#Clustering.UMAP_feature-847"><span class="linenos">847</span></a>
</span><span id="Clustering.UMAP_feature-848"><a href="#Clustering.UMAP_feature-848"><span class="linenos">848</span></a><span class="sd">        palette : str, default &#39;light&#39;</span>
</span><span id="Clustering.UMAP_feature-849"><a href="#Clustering.UMAP_feature-849"><span class="linenos">849</span></a><span class="sd">            Color palette for expression visualization. Options are:</span>
</span><span id="Clustering.UMAP_feature-850"><a href="#Clustering.UMAP_feature-850"><span class="linenos">850</span></a><span class="sd">            - &#39;light&#39;</span>
</span><span id="Clustering.UMAP_feature-851"><a href="#Clustering.UMAP_feature-851"><span class="linenos">851</span></a><span class="sd">            - &#39;dark&#39;</span>
</span><span id="Clustering.UMAP_feature-852"><a href="#Clustering.UMAP_feature-852"><span class="linenos">852</span></a><span class="sd">            - &#39;green&#39;</span>
</span><span id="Clustering.UMAP_feature-853"><a href="#Clustering.UMAP_feature-853"><span class="linenos">853</span></a><span class="sd">            - &#39;gray&#39;</span>
</span><span id="Clustering.UMAP_feature-854"><a href="#Clustering.UMAP_feature-854"><span class="linenos">854</span></a>
</span><span id="Clustering.UMAP_feature-855"><a href="#Clustering.UMAP_feature-855"><span class="linenos">855</span></a><span class="sd">        Returns</span>
</span><span id="Clustering.UMAP_feature-856"><a href="#Clustering.UMAP_feature-856"><span class="linenos">856</span></a><span class="sd">        -------</span>
</span><span id="Clustering.UMAP_feature-857"><a href="#Clustering.UMAP_feature-857"><span class="linenos">857</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="Clustering.UMAP_feature-858"><a href="#Clustering.UMAP_feature-858"><span class="linenos">858</span></a><span class="sd">            UMAP scatter plot colored by feature values.</span>
</span><span id="Clustering.UMAP_feature-859"><a href="#Clustering.UMAP_feature-859"><span class="linenos">859</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering.UMAP_feature-860"><a href="#Clustering.UMAP_feature-860"><span class="linenos">860</span></a>
</span><span id="Clustering.UMAP_feature-861"><a href="#Clustering.UMAP_feature-861"><span class="linenos">861</span></a>        <span class="n">umap_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">umap</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Clustering.UMAP_feature-862"><a href="#Clustering.UMAP_feature-862"><span class="linenos">862</span></a>
</span><span id="Clustering.UMAP_feature-863"><a href="#Clustering.UMAP_feature-863"><span class="linenos">863</span></a>        <span class="k">if</span> <span class="n">features_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Clustering.UMAP_feature-864"><a href="#Clustering.UMAP_feature-864"><span class="linenos">864</span></a>
</span><span id="Clustering.UMAP_feature-865"><a href="#Clustering.UMAP_feature-865"><span class="linenos">865</span></a>            <span class="n">features_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_data</span>
</span><span id="Clustering.UMAP_feature-866"><a href="#Clustering.UMAP_feature-866"><span class="linenos">866</span></a>
</span><span id="Clustering.UMAP_feature-867"><a href="#Clustering.UMAP_feature-867"><span class="linenos">867</span></a>        <span class="k">if</span> <span class="n">features_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">umap_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="Clustering.UMAP_feature-868"><a href="#Clustering.UMAP_feature-868"><span class="linenos">868</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Clustering.UMAP_feature-869"><a href="#Clustering.UMAP_feature-869"><span class="linenos">869</span></a>                <span class="s2">&quot;Imputed &#39;features_data&#39; shape does not match the number of UMAP cells&quot;</span>
</span><span id="Clustering.UMAP_feature-870"><a href="#Clustering.UMAP_feature-870"><span class="linenos">870</span></a>            <span class="p">)</span>
</span><span id="Clustering.UMAP_feature-871"><a href="#Clustering.UMAP_feature-871"><span class="linenos">871</span></a>
</span><span id="Clustering.UMAP_feature-872"><a href="#Clustering.UMAP_feature-872"><span class="linenos">872</span></a>        <span class="n">blist</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Clustering.UMAP_feature-873"><a href="#Clustering.UMAP_feature-873"><span class="linenos">873</span></a>            <span class="kc">True</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">feature_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
</span><span id="Clustering.UMAP_feature-874"><a href="#Clustering.UMAP_feature-874"><span class="linenos">874</span></a>            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">features_data</span><span class="o">.</span><span class="n">index</span>
</span><span id="Clustering.UMAP_feature-875"><a href="#Clustering.UMAP_feature-875"><span class="linenos">875</span></a>        <span class="p">]</span>
</span><span id="Clustering.UMAP_feature-876"><a href="#Clustering.UMAP_feature-876"><span class="linenos">876</span></a>
</span><span id="Clustering.UMAP_feature-877"><a href="#Clustering.UMAP_feature-877"><span class="linenos">877</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">blist</span><span class="p">):</span>
</span><span id="Clustering.UMAP_feature-878"><a href="#Clustering.UMAP_feature-878"><span class="linenos">878</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Imputed feature_name is not included in the data&quot;</span><span class="p">)</span>
</span><span id="Clustering.UMAP_feature-879"><a href="#Clustering.UMAP_feature-879"><span class="linenos">879</span></a>
</span><span id="Clustering.UMAP_feature-880"><a href="#Clustering.UMAP_feature-880"><span class="linenos">880</span></a>        <span class="n">umap_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;feature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Clustering.UMAP_feature-881"><a href="#Clustering.UMAP_feature-881"><span class="linenos">881</span></a>            <span class="n">features_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">blist</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="Clustering.UMAP_feature-882"><a href="#Clustering.UMAP_feature-882"><span class="linenos">882</span></a>            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Clustering.UMAP_feature-883"><a href="#Clustering.UMAP_feature-883"><span class="linenos">883</span></a>            <span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Clustering.UMAP_feature-884"><a href="#Clustering.UMAP_feature-884"><span class="linenos">884</span></a>        <span class="p">)</span>
</span><span id="Clustering.UMAP_feature-885"><a href="#Clustering.UMAP_feature-885"><span class="linenos">885</span></a>
</span><span id="Clustering.UMAP_feature-886"><a href="#Clustering.UMAP_feature-886"><span class="linenos">886</span></a>        <span class="n">umap_df</span> <span class="o">=</span> <span class="n">umap_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;feature&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Clustering.UMAP_feature-887"><a href="#Clustering.UMAP_feature-887"><span class="linenos">887</span></a>
</span><span id="Clustering.UMAP_feature-888"><a href="#Clustering.UMAP_feature-888"><span class="linenos">888</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mcolors</span>
</span><span id="Clustering.UMAP_feature-889"><a href="#Clustering.UMAP_feature-889"><span class="linenos">889</span></a>
</span><span id="Clustering.UMAP_feature-890"><a href="#Clustering.UMAP_feature-890"><span class="linenos">890</span></a>        <span class="k">if</span> <span class="n">palette</span> <span class="o">==</span> <span class="s2">&quot;light&quot;</span><span class="p">:</span>
</span><span id="Clustering.UMAP_feature-891"><a href="#Clustering.UMAP_feature-891"><span class="linenos">891</span></a>            <span class="n">palette</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">sequential</span><span class="o">.</span><span class="n">Sunsetdark</span>
</span><span id="Clustering.UMAP_feature-892"><a href="#Clustering.UMAP_feature-892"><span class="linenos">892</span></a>
</span><span id="Clustering.UMAP_feature-893"><a href="#Clustering.UMAP_feature-893"><span class="linenos">893</span></a>        <span class="k">elif</span> <span class="n">palette</span> <span class="o">==</span> <span class="s2">&quot;dark&quot;</span><span class="p">:</span>
</span><span id="Clustering.UMAP_feature-894"><a href="#Clustering.UMAP_feature-894"><span class="linenos">894</span></a>            <span class="n">palette</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">sequential</span><span class="o">.</span><span class="n">thermal</span>
</span><span id="Clustering.UMAP_feature-895"><a href="#Clustering.UMAP_feature-895"><span class="linenos">895</span></a>
</span><span id="Clustering.UMAP_feature-896"><a href="#Clustering.UMAP_feature-896"><span class="linenos">896</span></a>        <span class="k">elif</span> <span class="n">palette</span> <span class="o">==</span> <span class="s2">&quot;green&quot;</span><span class="p">:</span>
</span><span id="Clustering.UMAP_feature-897"><a href="#Clustering.UMAP_feature-897"><span class="linenos">897</span></a>            <span class="n">palette</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">sequential</span><span class="o">.</span><span class="n">Aggrnyl</span>
</span><span id="Clustering.UMAP_feature-898"><a href="#Clustering.UMAP_feature-898"><span class="linenos">898</span></a>
</span><span id="Clustering.UMAP_feature-899"><a href="#Clustering.UMAP_feature-899"><span class="linenos">899</span></a>        <span class="k">elif</span> <span class="n">palette</span> <span class="o">==</span> <span class="s2">&quot;gray&quot;</span><span class="p">:</span>
</span><span id="Clustering.UMAP_feature-900"><a href="#Clustering.UMAP_feature-900"><span class="linenos">900</span></a>            <span class="n">palette</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">sequential</span><span class="o">.</span><span class="n">gray</span>
</span><span id="Clustering.UMAP_feature-901"><a href="#Clustering.UMAP_feature-901"><span class="linenos">901</span></a>            <span class="n">palette</span> <span class="o">=</span> <span class="n">palette</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Clustering.UMAP_feature-902"><a href="#Clustering.UMAP_feature-902"><span class="linenos">902</span></a>
</span><span id="Clustering.UMAP_feature-903"><a href="#Clustering.UMAP_feature-903"><span class="linenos">903</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering.UMAP_feature-904"><a href="#Clustering.UMAP_feature-904"><span class="linenos">904</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Clustering.UMAP_feature-905"><a href="#Clustering.UMAP_feature-905"><span class="linenos">905</span></a>                <span class="s1">&#39;Palette not found. Use: &quot;light&quot;, &quot;dark&quot;, &quot;gray&quot;, or &quot;green&quot;&#39;</span>
</span><span id="Clustering.UMAP_feature-906"><a href="#Clustering.UMAP_feature-906"><span class="linenos">906</span></a>            <span class="p">)</span>
</span><span id="Clustering.UMAP_feature-907"><a href="#Clustering.UMAP_feature-907"><span class="linenos">907</span></a>
</span><span id="Clustering.UMAP_feature-908"><a href="#Clustering.UMAP_feature-908"><span class="linenos">908</span></a>        <span class="n">converted</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Clustering.UMAP_feature-909"><a href="#Clustering.UMAP_feature-909"><span class="linenos">909</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">palette</span><span class="p">:</span>
</span><span id="Clustering.UMAP_feature-910"><a href="#Clustering.UMAP_feature-910"><span class="linenos">910</span></a>            <span class="n">rgb_255</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">unlabel_rgb</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span id="Clustering.UMAP_feature-911"><a href="#Clustering.UMAP_feature-911"><span class="linenos">911</span></a>            <span class="n">rgb_01</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span> <span class="o">/</span> <span class="mf">255.0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rgb_255</span><span class="p">)</span>
</span><span id="Clustering.UMAP_feature-912"><a href="#Clustering.UMAP_feature-912"><span class="linenos">912</span></a>            <span class="n">converted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rgb_01</span><span class="p">)</span>
</span><span id="Clustering.UMAP_feature-913"><a href="#Clustering.UMAP_feature-913"><span class="linenos">913</span></a>
</span><span id="Clustering.UMAP_feature-914"><a href="#Clustering.UMAP_feature-914"><span class="linenos">914</span></a>        <span class="n">my_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">converted</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;custom&quot;</span><span class="p">)</span>
</span><span id="Clustering.UMAP_feature-915"><a href="#Clustering.UMAP_feature-915"><span class="linenos">915</span></a>
</span><span id="Clustering.UMAP_feature-916"><a href="#Clustering.UMAP_feature-916"><span class="linenos">916</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="Clustering.UMAP_feature-917"><a href="#Clustering.UMAP_feature-917"><span class="linenos">917</span></a>        <span class="n">sc</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="Clustering.UMAP_feature-918"><a href="#Clustering.UMAP_feature-918"><span class="linenos">918</span></a>            <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;UMAP1&quot;</span><span class="p">],</span>
</span><span id="Clustering.UMAP_feature-919"><a href="#Clustering.UMAP_feature-919"><span class="linenos">919</span></a>            <span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;UMAP2&quot;</span><span class="p">],</span>
</span><span id="Clustering.UMAP_feature-920"><a href="#Clustering.UMAP_feature-920"><span class="linenos">920</span></a>            <span class="n">c</span><span class="o">=</span><span class="n">umap_df</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">],</span>
</span><span id="Clustering.UMAP_feature-921"><a href="#Clustering.UMAP_feature-921"><span class="linenos">921</span></a>            <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span>
</span><span id="Clustering.UMAP_feature-922"><a href="#Clustering.UMAP_feature-922"><span class="linenos">922</span></a>            <span class="n">cmap</span><span class="o">=</span><span class="n">my_cmap</span><span class="p">,</span>
</span><span id="Clustering.UMAP_feature-923"><a href="#Clustering.UMAP_feature-923"><span class="linenos">923</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="Clustering.UMAP_feature-924"><a href="#Clustering.UMAP_feature-924"><span class="linenos">924</span></a>            <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="Clustering.UMAP_feature-925"><a href="#Clustering.UMAP_feature-925"><span class="linenos">925</span></a>            <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="Clustering.UMAP_feature-926"><a href="#Clustering.UMAP_feature-926"><span class="linenos">926</span></a>        <span class="p">)</span>
</span><span id="Clustering.UMAP_feature-927"><a href="#Clustering.UMAP_feature-927"><span class="linenos">927</span></a>
</span><span id="Clustering.UMAP_feature-928"><a href="#Clustering.UMAP_feature-928"><span class="linenos">928</span></a>        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</span><span id="Clustering.UMAP_feature-929"><a href="#Clustering.UMAP_feature-929"><span class="linenos">929</span></a>        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feature_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Clustering.UMAP_feature-930"><a href="#Clustering.UMAP_feature-930"><span class="linenos">930</span></a>
</span><span id="Clustering.UMAP_feature-931"><a href="#Clustering.UMAP_feature-931"><span class="linenos">931</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">)</span>
</span><span id="Clustering.UMAP_feature-932"><a href="#Clustering.UMAP_feature-932"><span class="linenos">932</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">)</span>
</span><span id="Clustering.UMAP_feature-933"><a href="#Clustering.UMAP_feature-933"><span class="linenos">933</span></a>
</span><span id="Clustering.UMAP_feature-934"><a href="#Clustering.UMAP_feature-934"><span class="linenos">934</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Clustering.UMAP_feature-935"><a href="#Clustering.UMAP_feature-935"><span class="linenos">935</span></a>
</span><span id="Clustering.UMAP_feature-936"><a href="#Clustering.UMAP_feature-936"><span class="linenos">936</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="Clustering.UMAP_feature-937"><a href="#Clustering.UMAP_feature-937"><span class="linenos">937</span></a>
</span><span id="Clustering.UMAP_feature-938"><a href="#Clustering.UMAP_feature-938"><span class="linenos">938</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span></pre></div>


            <div class="docstring"><p>Visualize UMAP embedding with expression levels of a selected feature.</p>

<p>Each point (cell) in the UMAP plot is colored according to the expression
value of the chosen feature, enabling interpretation of spatial patterns
of gene activity or metadata distribution in low-dimensional space.</p>

<h2 id="parameters">Parameters</h2>

<p>feature_name : str
   Name of the feature to plot.</p>

<p>features_data : pandas.DataFrame or None, default None
    If None, the function uses the DataFrame containing the clustering data.
    To plot features not used in clustering, provide a wider DataFrame
    containing the original feature values.</p>

<p>point_size : float, default 0.6
    Size of scatter points in the plot.</p>

<p>font_size : int, default 6
    Font size for axis labels and annotations.</p>

<p>width : int, default 8
    Width of the matplotlib figure.</p>

<p>height : int, default 6
    Height of the matplotlib figure.</p>

<p>palette : str, default 'light'
    Color palette for expression visualization. Options are:
    - 'light'
    - 'dark'
    - 'green'
    - 'gray'</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.figure.Figure
    UMAP scatter plot colored by feature values.</p>
</div>


                            </div>
                            <div id="Clustering.get_umap_data" class="classattr">
                                        <input id="Clustering.get_umap_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_umap_data</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Clustering.get_umap_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Clustering.get_umap_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Clustering.get_umap_data-940"><a href="#Clustering.get_umap_data-940"><span class="linenos">940</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_umap_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Clustering.get_umap_data-941"><a href="#Clustering.get_umap_data-941"><span class="linenos">941</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering.get_umap_data-942"><a href="#Clustering.get_umap_data-942"><span class="linenos">942</span></a><span class="sd">        Retrieve UMAP embedding data with optional cluster labels.</span>
</span><span id="Clustering.get_umap_data-943"><a href="#Clustering.get_umap_data-943"><span class="linenos">943</span></a>
</span><span id="Clustering.get_umap_data-944"><a href="#Clustering.get_umap_data-944"><span class="linenos">944</span></a><span class="sd">        Returns the UMAP coordinates stored in `self.umap`. If clustering</span>
</span><span id="Clustering.get_umap_data-945"><a href="#Clustering.get_umap_data-945"><span class="linenos">945</span></a><span class="sd">        metadata is available (specifically `UMAP_clusters`), the corresponding</span>
</span><span id="Clustering.get_umap_data-946"><a href="#Clustering.get_umap_data-946"><span class="linenos">946</span></a><span class="sd">        cluster assignments are appended as an additional column.</span>
</span><span id="Clustering.get_umap_data-947"><a href="#Clustering.get_umap_data-947"><span class="linenos">947</span></a>
</span><span id="Clustering.get_umap_data-948"><a href="#Clustering.get_umap_data-948"><span class="linenos">948</span></a><span class="sd">        Returns</span>
</span><span id="Clustering.get_umap_data-949"><a href="#Clustering.get_umap_data-949"><span class="linenos">949</span></a><span class="sd">        -------</span>
</span><span id="Clustering.get_umap_data-950"><a href="#Clustering.get_umap_data-950"><span class="linenos">950</span></a><span class="sd">        pandas.DataFrame</span>
</span><span id="Clustering.get_umap_data-951"><a href="#Clustering.get_umap_data-951"><span class="linenos">951</span></a><span class="sd">            DataFrame containing UMAP coordinates (columns: &#39;UMAP1&#39;, &#39;UMAP2&#39;, ...).</span>
</span><span id="Clustering.get_umap_data-952"><a href="#Clustering.get_umap_data-952"><span class="linenos">952</span></a><span class="sd">            If available, includes an extra column &#39;clusters&#39; with cluster labels.</span>
</span><span id="Clustering.get_umap_data-953"><a href="#Clustering.get_umap_data-953"><span class="linenos">953</span></a>
</span><span id="Clustering.get_umap_data-954"><a href="#Clustering.get_umap_data-954"><span class="linenos">954</span></a><span class="sd">        Notes</span>
</span><span id="Clustering.get_umap_data-955"><a href="#Clustering.get_umap_data-955"><span class="linenos">955</span></a><span class="sd">        -----</span>
</span><span id="Clustering.get_umap_data-956"><a href="#Clustering.get_umap_data-956"><span class="linenos">956</span></a><span class="sd">        - UMAP embeddings must be computed beforehand (e.g., using `perform_UMAP`).</span>
</span><span id="Clustering.get_umap_data-957"><a href="#Clustering.get_umap_data-957"><span class="linenos">957</span></a><span class="sd">        - Cluster labels are added only if present in `self.clustering_metadata`.</span>
</span><span id="Clustering.get_umap_data-958"><a href="#Clustering.get_umap_data-958"><span class="linenos">958</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering.get_umap_data-959"><a href="#Clustering.get_umap_data-959"><span class="linenos">959</span></a>
</span><span id="Clustering.get_umap_data-960"><a href="#Clustering.get_umap_data-960"><span class="linenos">960</span></a>        <span class="n">umap_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">umap</span>
</span><span id="Clustering.get_umap_data-961"><a href="#Clustering.get_umap_data-961"><span class="linenos">961</span></a>
</span><span id="Clustering.get_umap_data-962"><a href="#Clustering.get_umap_data-962"><span class="linenos">962</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Clustering.get_umap_data-963"><a href="#Clustering.get_umap_data-963"><span class="linenos">963</span></a>            <span class="n">umap_data</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;UMAP_clusters&quot;</span><span class="p">]</span>
</span><span id="Clustering.get_umap_data-964"><a href="#Clustering.get_umap_data-964"><span class="linenos">964</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="Clustering.get_umap_data-965"><a href="#Clustering.get_umap_data-965"><span class="linenos">965</span></a>            <span class="k">pass</span>
</span><span id="Clustering.get_umap_data-966"><a href="#Clustering.get_umap_data-966"><span class="linenos">966</span></a>
</span><span id="Clustering.get_umap_data-967"><a href="#Clustering.get_umap_data-967"><span class="linenos">967</span></a>        <span class="k">return</span> <span class="n">umap_data</span>
</span></pre></div>


            <div class="docstring"><p>Retrieve UMAP embedding data with optional cluster labels.</p>

<p>Returns the UMAP coordinates stored in <code>self.umap</code>. If clustering
metadata is available (specifically <code>UMAP_clusters</code>), the corresponding
cluster assignments are appended as an additional column.</p>

<h2 id="returns">Returns</h2>

<p>pandas.DataFrame
    DataFrame containing UMAP coordinates (columns: 'UMAP1', 'UMAP2', ...).
    If available, includes an extra column 'clusters' with cluster labels.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>UMAP embeddings must be computed beforehand (e.g., using <code><a href="#Clustering.perform_UMAP">perform_UMAP</a></code>).</li>
<li>Cluster labels are added only if present in <code>self.clustering_metadata</code>.</li>
</ul>
</div>


                            </div>
                            <div id="Clustering.get_pca_data" class="classattr">
                                        <input id="Clustering.get_pca_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_pca_data</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Clustering.get_pca_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Clustering.get_pca_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Clustering.get_pca_data-969"><a href="#Clustering.get_pca_data-969"><span class="linenos">969</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_pca_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Clustering.get_pca_data-970"><a href="#Clustering.get_pca_data-970"><span class="linenos">970</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering.get_pca_data-971"><a href="#Clustering.get_pca_data-971"><span class="linenos">971</span></a><span class="sd">        Retrieve PCA embedding data with optional cluster labels.</span>
</span><span id="Clustering.get_pca_data-972"><a href="#Clustering.get_pca_data-972"><span class="linenos">972</span></a>
</span><span id="Clustering.get_pca_data-973"><a href="#Clustering.get_pca_data-973"><span class="linenos">973</span></a><span class="sd">        Returns the principal component scores stored in `self.pca`. If clustering</span>
</span><span id="Clustering.get_pca_data-974"><a href="#Clustering.get_pca_data-974"><span class="linenos">974</span></a><span class="sd">        metadata is available (specifically `PCA_clusters`), the corresponding</span>
</span><span id="Clustering.get_pca_data-975"><a href="#Clustering.get_pca_data-975"><span class="linenos">975</span></a><span class="sd">        cluster assignments are appended as an additional column.</span>
</span><span id="Clustering.get_pca_data-976"><a href="#Clustering.get_pca_data-976"><span class="linenos">976</span></a>
</span><span id="Clustering.get_pca_data-977"><a href="#Clustering.get_pca_data-977"><span class="linenos">977</span></a><span class="sd">        Returns</span>
</span><span id="Clustering.get_pca_data-978"><a href="#Clustering.get_pca_data-978"><span class="linenos">978</span></a><span class="sd">        -------</span>
</span><span id="Clustering.get_pca_data-979"><a href="#Clustering.get_pca_data-979"><span class="linenos">979</span></a><span class="sd">        pandas.DataFrame</span>
</span><span id="Clustering.get_pca_data-980"><a href="#Clustering.get_pca_data-980"><span class="linenos">980</span></a><span class="sd">            DataFrame containing PCA coordinates (columns: &#39;PC1&#39;, &#39;PC2&#39;, ...).</span>
</span><span id="Clustering.get_pca_data-981"><a href="#Clustering.get_pca_data-981"><span class="linenos">981</span></a><span class="sd">            If available, includes an extra column &#39;clusters&#39; with cluster labels.</span>
</span><span id="Clustering.get_pca_data-982"><a href="#Clustering.get_pca_data-982"><span class="linenos">982</span></a>
</span><span id="Clustering.get_pca_data-983"><a href="#Clustering.get_pca_data-983"><span class="linenos">983</span></a><span class="sd">        Notes</span>
</span><span id="Clustering.get_pca_data-984"><a href="#Clustering.get_pca_data-984"><span class="linenos">984</span></a><span class="sd">        -----</span>
</span><span id="Clustering.get_pca_data-985"><a href="#Clustering.get_pca_data-985"><span class="linenos">985</span></a><span class="sd">        - PCA must be computed beforehand (e.g., using `perform_PCA`).</span>
</span><span id="Clustering.get_pca_data-986"><a href="#Clustering.get_pca_data-986"><span class="linenos">986</span></a><span class="sd">        - Cluster labels are added only if present in `self.clustering_metadata`.</span>
</span><span id="Clustering.get_pca_data-987"><a href="#Clustering.get_pca_data-987"><span class="linenos">987</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering.get_pca_data-988"><a href="#Clustering.get_pca_data-988"><span class="linenos">988</span></a>
</span><span id="Clustering.get_pca_data-989"><a href="#Clustering.get_pca_data-989"><span class="linenos">989</span></a>        <span class="n">pca_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca</span>
</span><span id="Clustering.get_pca_data-990"><a href="#Clustering.get_pca_data-990"><span class="linenos">990</span></a>
</span><span id="Clustering.get_pca_data-991"><a href="#Clustering.get_pca_data-991"><span class="linenos">991</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Clustering.get_pca_data-992"><a href="#Clustering.get_pca_data-992"><span class="linenos">992</span></a>            <span class="n">pca_data</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;PCA_clusters&quot;</span><span class="p">]</span>
</span><span id="Clustering.get_pca_data-993"><a href="#Clustering.get_pca_data-993"><span class="linenos">993</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="Clustering.get_pca_data-994"><a href="#Clustering.get_pca_data-994"><span class="linenos">994</span></a>            <span class="k">pass</span>
</span><span id="Clustering.get_pca_data-995"><a href="#Clustering.get_pca_data-995"><span class="linenos">995</span></a>
</span><span id="Clustering.get_pca_data-996"><a href="#Clustering.get_pca_data-996"><span class="linenos">996</span></a>        <span class="k">return</span> <span class="n">pca_data</span>
</span></pre></div>


            <div class="docstring"><p>Retrieve PCA embedding data with optional cluster labels.</p>

<p>Returns the principal component scores stored in <code>self.pca</code>. If clustering
metadata is available (specifically <code>PCA_clusters</code>), the corresponding
cluster assignments are appended as an additional column.</p>

<h2 id="returns">Returns</h2>

<p>pandas.DataFrame
    DataFrame containing PCA coordinates (columns: 'PC1', 'PC2', ...).
    If available, includes an extra column 'clusters' with cluster labels.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>PCA must be computed beforehand (e.g., using <code><a href="#Clustering.perform_PCA">perform_PCA</a></code>).</li>
<li>Cluster labels are added only if present in <code>self.clustering_metadata</code>.</li>
</ul>
</div>


                            </div>
                            <div id="Clustering.return_clusters" class="classattr">
                                        <input id="Clustering.return_clusters-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">return_clusters</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">clusters</span><span class="o">=</span><span class="s1">&#39;umap&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Clustering.return_clusters-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Clustering.return_clusters"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Clustering.return_clusters-998"><a href="#Clustering.return_clusters-998"><span class="linenos"> 998</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">return_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clusters</span><span class="o">=</span><span class="s2">&quot;umap&quot;</span><span class="p">):</span>
</span><span id="Clustering.return_clusters-999"><a href="#Clustering.return_clusters-999"><span class="linenos"> 999</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Clustering.return_clusters-1000"><a href="#Clustering.return_clusters-1000"><span class="linenos">1000</span></a><span class="sd">        Retrieve cluster labels from UMAP or PCA clustering results.</span>
</span><span id="Clustering.return_clusters-1001"><a href="#Clustering.return_clusters-1001"><span class="linenos">1001</span></a>
</span><span id="Clustering.return_clusters-1002"><a href="#Clustering.return_clusters-1002"><span class="linenos">1002</span></a><span class="sd">        Parameters</span>
</span><span id="Clustering.return_clusters-1003"><a href="#Clustering.return_clusters-1003"><span class="linenos">1003</span></a><span class="sd">        ----------</span>
</span><span id="Clustering.return_clusters-1004"><a href="#Clustering.return_clusters-1004"><span class="linenos">1004</span></a><span class="sd">        clusters : str, default &#39;umap&#39;</span>
</span><span id="Clustering.return_clusters-1005"><a href="#Clustering.return_clusters-1005"><span class="linenos">1005</span></a><span class="sd">            Source of cluster labels to return. Must be one of:</span>
</span><span id="Clustering.return_clusters-1006"><a href="#Clustering.return_clusters-1006"><span class="linenos">1006</span></a><span class="sd">            - &#39;umap&#39;: return cluster labels from UMAP embeddings.</span>
</span><span id="Clustering.return_clusters-1007"><a href="#Clustering.return_clusters-1007"><span class="linenos">1007</span></a><span class="sd">            - &#39;pca&#39; : return cluster labels from PCA embeddings.</span>
</span><span id="Clustering.return_clusters-1008"><a href="#Clustering.return_clusters-1008"><span class="linenos">1008</span></a>
</span><span id="Clustering.return_clusters-1009"><a href="#Clustering.return_clusters-1009"><span class="linenos">1009</span></a><span class="sd">        Returns</span>
</span><span id="Clustering.return_clusters-1010"><a href="#Clustering.return_clusters-1010"><span class="linenos">1010</span></a><span class="sd">        -------</span>
</span><span id="Clustering.return_clusters-1011"><a href="#Clustering.return_clusters-1011"><span class="linenos">1011</span></a><span class="sd">        list</span>
</span><span id="Clustering.return_clusters-1012"><a href="#Clustering.return_clusters-1012"><span class="linenos">1012</span></a><span class="sd">            Cluster labels corresponding to the selected embedding method.</span>
</span><span id="Clustering.return_clusters-1013"><a href="#Clustering.return_clusters-1013"><span class="linenos">1013</span></a>
</span><span id="Clustering.return_clusters-1014"><a href="#Clustering.return_clusters-1014"><span class="linenos">1014</span></a><span class="sd">        Raises</span>
</span><span id="Clustering.return_clusters-1015"><a href="#Clustering.return_clusters-1015"><span class="linenos">1015</span></a><span class="sd">        ------</span>
</span><span id="Clustering.return_clusters-1016"><a href="#Clustering.return_clusters-1016"><span class="linenos">1016</span></a><span class="sd">        ValueError</span>
</span><span id="Clustering.return_clusters-1017"><a href="#Clustering.return_clusters-1017"><span class="linenos">1017</span></a><span class="sd">            If `clusters` is not &#39;umap&#39; or &#39;pca&#39;.</span>
</span><span id="Clustering.return_clusters-1018"><a href="#Clustering.return_clusters-1018"><span class="linenos">1018</span></a>
</span><span id="Clustering.return_clusters-1019"><a href="#Clustering.return_clusters-1019"><span class="linenos">1019</span></a><span class="sd">        Notes</span>
</span><span id="Clustering.return_clusters-1020"><a href="#Clustering.return_clusters-1020"><span class="linenos">1020</span></a><span class="sd">        -----</span>
</span><span id="Clustering.return_clusters-1021"><a href="#Clustering.return_clusters-1021"><span class="linenos">1021</span></a><span class="sd">        Requires that clustering has already been performed</span>
</span><span id="Clustering.return_clusters-1022"><a href="#Clustering.return_clusters-1022"><span class="linenos">1022</span></a><span class="sd">        (e.g., using `find_clusters_UMAP` or `find_clusters_PCA`).</span>
</span><span id="Clustering.return_clusters-1023"><a href="#Clustering.return_clusters-1023"><span class="linenos">1023</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Clustering.return_clusters-1024"><a href="#Clustering.return_clusters-1024"><span class="linenos">1024</span></a>
</span><span id="Clustering.return_clusters-1025"><a href="#Clustering.return_clusters-1025"><span class="linenos">1025</span></a>        <span class="k">if</span> <span class="n">clusters</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;umap&quot;</span><span class="p">:</span>
</span><span id="Clustering.return_clusters-1026"><a href="#Clustering.return_clusters-1026"><span class="linenos">1026</span></a>            <span class="n">clusters_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;UMAP_clusters&quot;</span><span class="p">]</span>
</span><span id="Clustering.return_clusters-1027"><a href="#Clustering.return_clusters-1027"><span class="linenos">1027</span></a>        <span class="k">elif</span> <span class="n">clusters</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;pca&quot;</span><span class="p">:</span>
</span><span id="Clustering.return_clusters-1028"><a href="#Clustering.return_clusters-1028"><span class="linenos">1028</span></a>            <span class="n">clusters_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span><span class="p">[</span><span class="s2">&quot;PCA_clusters&quot;</span><span class="p">]</span>
</span><span id="Clustering.return_clusters-1029"><a href="#Clustering.return_clusters-1029"><span class="linenos">1029</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Clustering.return_clusters-1030"><a href="#Clustering.return_clusters-1030"><span class="linenos">1030</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parameter &#39;clusters&#39; must be either &#39;umap&#39; or &#39;pca&#39;.&quot;</span><span class="p">)</span>
</span><span id="Clustering.return_clusters-1031"><a href="#Clustering.return_clusters-1031"><span class="linenos">1031</span></a>
</span><span id="Clustering.return_clusters-1032"><a href="#Clustering.return_clusters-1032"><span class="linenos">1032</span></a>        <span class="k">return</span> <span class="n">clusters_vector</span>
</span></pre></div>


            <div class="docstring"><p>Retrieve cluster labels from UMAP or PCA clustering results.</p>

<h2 id="parameters">Parameters</h2>

<p>clusters : str, default 'umap'
    Source of cluster labels to return. Must be one of:
    - 'umap': return cluster labels from UMAP embeddings.
    - 'pca' : return cluster labels from PCA embeddings.</p>

<h2 id="returns">Returns</h2>

<p>list
    Cluster labels corresponding to the selected embedding method.</p>

<h2 id="raises">Raises</h2>

<p>ValueError
    If <code>clusters</code> is not 'umap' or 'pca'.</p>

<h2 id="notes">Notes</h2>

<p>Requires that clustering has already been performed
(e.g., using <code><a href="#Clustering.find_clusters_UMAP">find_clusters_UMAP</a></code> or <code><a href="#Clustering.find_clusters_PCA">find_clusters_PCA</a></code>).</p>
</div>


                            </div>
                </section>
                <section id="COMPsc">
                            <input id="COMPsc-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">COMPsc</span><wbr>(<span class="base"><a href="#Clustering">Clustering</a></span>):

                <label class="view-source-button" for="COMPsc-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc-1035"><a href="#COMPsc-1035"><span class="linenos">1035</span></a><span class="k">class</span><span class="w"> </span><span class="nc">COMPsc</span><span class="p">(</span><span class="n">Clustering</span><span class="p">):</span>
</span><span id="COMPsc-1036"><a href="#COMPsc-1036"><span class="linenos">1036</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-1037"><a href="#COMPsc-1037"><span class="linenos">1037</span></a><span class="sd">    A class `COMPsc` (Comparison of single-cell data) designed for the integration,</span>
</span><span id="COMPsc-1038"><a href="#COMPsc-1038"><span class="linenos">1038</span></a><span class="sd">    analysis, and visualization of single-cell datasets.</span>
</span><span id="COMPsc-1039"><a href="#COMPsc-1039"><span class="linenos">1039</span></a><span class="sd">    The class supports independent dataset integration, subclustering of existing clusters,</span>
</span><span id="COMPsc-1040"><a href="#COMPsc-1040"><span class="linenos">1040</span></a><span class="sd">    marker detection, and multiple visualization strategies.</span>
</span><span id="COMPsc-1041"><a href="#COMPsc-1041"><span class="linenos">1041</span></a>
</span><span id="COMPsc-1042"><a href="#COMPsc-1042"><span class="linenos">1042</span></a><span class="sd">    The COMPsc class provides methods for:</span>
</span><span id="COMPsc-1043"><a href="#COMPsc-1043"><span class="linenos">1043</span></a>
</span><span id="COMPsc-1044"><a href="#COMPsc-1044"><span class="linenos">1044</span></a><span class="sd">        - Normalizing and filtering single-cell data</span>
</span><span id="COMPsc-1045"><a href="#COMPsc-1045"><span class="linenos">1045</span></a><span class="sd">        - Loading and saving sparse 10x-style datasets</span>
</span><span id="COMPsc-1046"><a href="#COMPsc-1046"><span class="linenos">1046</span></a><span class="sd">        - Computing differential expression and marker genes</span>
</span><span id="COMPsc-1047"><a href="#COMPsc-1047"><span class="linenos">1047</span></a><span class="sd">        - Clustering and subclustering analysis</span>
</span><span id="COMPsc-1048"><a href="#COMPsc-1048"><span class="linenos">1048</span></a><span class="sd">        - Visualizing similarity and spatial relationships</span>
</span><span id="COMPsc-1049"><a href="#COMPsc-1049"><span class="linenos">1049</span></a><span class="sd">        - Aggregating data by cell and set annotations</span>
</span><span id="COMPsc-1050"><a href="#COMPsc-1050"><span class="linenos">1050</span></a><span class="sd">        - Managing metadata and renaming labels</span>
</span><span id="COMPsc-1051"><a href="#COMPsc-1051"><span class="linenos">1051</span></a><span class="sd">        - Plotting gene detection histograms and feature scatters</span>
</span><span id="COMPsc-1052"><a href="#COMPsc-1052"><span class="linenos">1052</span></a>
</span><span id="COMPsc-1053"><a href="#COMPsc-1053"><span class="linenos">1053</span></a><span class="sd">    Methods</span>
</span><span id="COMPsc-1054"><a href="#COMPsc-1054"><span class="linenos">1054</span></a><span class="sd">    -------</span>
</span><span id="COMPsc-1055"><a href="#COMPsc-1055"><span class="linenos">1055</span></a><span class="sd">    project_dir(path_to_directory, project_list)</span>
</span><span id="COMPsc-1056"><a href="#COMPsc-1056"><span class="linenos">1056</span></a><span class="sd">        Scans a directory to create a COMPsc instance mapping project names to their paths.</span>
</span><span id="COMPsc-1057"><a href="#COMPsc-1057"><span class="linenos">1057</span></a>
</span><span id="COMPsc-1058"><a href="#COMPsc-1058"><span class="linenos">1058</span></a><span class="sd">    save_project(name, path=os.getcwd())</span>
</span><span id="COMPsc-1059"><a href="#COMPsc-1059"><span class="linenos">1059</span></a><span class="sd">        Saves the COMPsc object to a pickle file on disk.</span>
</span><span id="COMPsc-1060"><a href="#COMPsc-1060"><span class="linenos">1060</span></a>
</span><span id="COMPsc-1061"><a href="#COMPsc-1061"><span class="linenos">1061</span></a><span class="sd">    load_project(path)</span>
</span><span id="COMPsc-1062"><a href="#COMPsc-1062"><span class="linenos">1062</span></a><span class="sd">        Loads a previously saved COMPsc object from a pickle file.</span>
</span><span id="COMPsc-1063"><a href="#COMPsc-1063"><span class="linenos">1063</span></a>
</span><span id="COMPsc-1064"><a href="#COMPsc-1064"><span class="linenos">1064</span></a><span class="sd">    reduce_cols(reg, inc_set=False)</span>
</span><span id="COMPsc-1065"><a href="#COMPsc-1065"><span class="linenos">1065</span></a><span class="sd">        Removes columns from data tables where column names contain a specified name or partial substring.</span>
</span><span id="COMPsc-1066"><a href="#COMPsc-1066"><span class="linenos">1066</span></a>
</span><span id="COMPsc-1067"><a href="#COMPsc-1067"><span class="linenos">1067</span></a><span class="sd">    reduce_rows(reg, inc_set=False)</span>
</span><span id="COMPsc-1068"><a href="#COMPsc-1068"><span class="linenos">1068</span></a><span class="sd">        Removes rows from data tables where column names contain a specified feature (gene) name.</span>
</span><span id="COMPsc-1069"><a href="#COMPsc-1069"><span class="linenos">1069</span></a>
</span><span id="COMPsc-1070"><a href="#COMPsc-1070"><span class="linenos">1070</span></a><span class="sd">    get_data(set_info=False)</span>
</span><span id="COMPsc-1071"><a href="#COMPsc-1071"><span class="linenos">1071</span></a><span class="sd">        Returns normalized data with optional set annotations in column names.</span>
</span><span id="COMPsc-1072"><a href="#COMPsc-1072"><span class="linenos">1072</span></a>
</span><span id="COMPsc-1073"><a href="#COMPsc-1073"><span class="linenos">1073</span></a><span class="sd">    get_metadata()</span>
</span><span id="COMPsc-1074"><a href="#COMPsc-1074"><span class="linenos">1074</span></a><span class="sd">        Returns the stored input metadata.</span>
</span><span id="COMPsc-1075"><a href="#COMPsc-1075"><span class="linenos">1075</span></a>
</span><span id="COMPsc-1076"><a href="#COMPsc-1076"><span class="linenos">1076</span></a><span class="sd">    get_partial_data(names=None, features=None, name_slot=&#39;cell_names&#39;)</span>
</span><span id="COMPsc-1077"><a href="#COMPsc-1077"><span class="linenos">1077</span></a><span class="sd">        Return a subset of the data by sample names and/or features.</span>
</span><span id="COMPsc-1078"><a href="#COMPsc-1078"><span class="linenos">1078</span></a>
</span><span id="COMPsc-1079"><a href="#COMPsc-1079"><span class="linenos">1079</span></a><span class="sd">    gene_calculation()</span>
</span><span id="COMPsc-1080"><a href="#COMPsc-1080"><span class="linenos">1080</span></a><span class="sd">        Calculates and stores per-cell gene detection counts as a pandas Series.</span>
</span><span id="COMPsc-1081"><a href="#COMPsc-1081"><span class="linenos">1081</span></a>
</span><span id="COMPsc-1082"><a href="#COMPsc-1082"><span class="linenos">1082</span></a><span class="sd">    gene_histograme(bins=100)</span>
</span><span id="COMPsc-1083"><a href="#COMPsc-1083"><span class="linenos">1083</span></a><span class="sd">        Plots a histogram of genes detected per cell with an overlaid normal distribution.</span>
</span><span id="COMPsc-1084"><a href="#COMPsc-1084"><span class="linenos">1084</span></a>
</span><span id="COMPsc-1085"><a href="#COMPsc-1085"><span class="linenos">1085</span></a><span class="sd">    gene_threshold(min_n=None, max_n=None)</span>
</span><span id="COMPsc-1086"><a href="#COMPsc-1086"><span class="linenos">1086</span></a><span class="sd">        Filters cells based on minimum and/or maximum gene detection thresholds.</span>
</span><span id="COMPsc-1087"><a href="#COMPsc-1087"><span class="linenos">1087</span></a>
</span><span id="COMPsc-1088"><a href="#COMPsc-1088"><span class="linenos">1088</span></a><span class="sd">    load_sparse_from_projects(normalized_data=False)</span>
</span><span id="COMPsc-1089"><a href="#COMPsc-1089"><span class="linenos">1089</span></a><span class="sd">        Loads and concatenates sparse 10x-style datasets from project paths into count or normalized data.</span>
</span><span id="COMPsc-1090"><a href="#COMPsc-1090"><span class="linenos">1090</span></a>
</span><span id="COMPsc-1091"><a href="#COMPsc-1091"><span class="linenos">1091</span></a><span class="sd">    rename_names(mapping, slot=&#39;cell_names&#39;)</span>
</span><span id="COMPsc-1092"><a href="#COMPsc-1092"><span class="linenos">1092</span></a><span class="sd">        Renames entries in a specified metadata column using a provided mapping dictionary.</span>
</span><span id="COMPsc-1093"><a href="#COMPsc-1093"><span class="linenos">1093</span></a>
</span><span id="COMPsc-1094"><a href="#COMPsc-1094"><span class="linenos">1094</span></a><span class="sd">    rename_subclusters(mapping)</span>
</span><span id="COMPsc-1095"><a href="#COMPsc-1095"><span class="linenos">1095</span></a><span class="sd">        Renames subcluster labels using a provided mapping dictionary.</span>
</span><span id="COMPsc-1096"><a href="#COMPsc-1096"><span class="linenos">1096</span></a>
</span><span id="COMPsc-1097"><a href="#COMPsc-1097"><span class="linenos">1097</span></a><span class="sd">    save_sparse(path_to_save=os.getcwd(), name_slot=&#39;cell_names&#39;, data_slot=&#39;normalized&#39;)</span>
</span><span id="COMPsc-1098"><a href="#COMPsc-1098"><span class="linenos">1098</span></a><span class="sd">        Exports data as 10x-compatible sparse files (matrix.mtx, barcodes.tsv, genes.tsv).</span>
</span><span id="COMPsc-1099"><a href="#COMPsc-1099"><span class="linenos">1099</span></a>
</span><span id="COMPsc-1100"><a href="#COMPsc-1100"><span class="linenos">1100</span></a><span class="sd">    normalize_data(normalize=True, normalize_factor=100000)</span>
</span><span id="COMPsc-1101"><a href="#COMPsc-1101"><span class="linenos">1101</span></a><span class="sd">        Normalizes raw counts to counts-per-specified factor (e.g., CPM-like).</span>
</span><span id="COMPsc-1102"><a href="#COMPsc-1102"><span class="linenos">1102</span></a>
</span><span id="COMPsc-1103"><a href="#COMPsc-1103"><span class="linenos">1103</span></a><span class="sd">    statistic(cells=None, sets=None, min_exp=0.01, min_pct=0.1, n_proc=10)</span>
</span><span id="COMPsc-1104"><a href="#COMPsc-1104"><span class="linenos">1104</span></a><span class="sd">        Computes per-feature differential expression statistics (Mann-Whitney U) comparing target vs. rest groups.</span>
</span><span id="COMPsc-1105"><a href="#COMPsc-1105"><span class="linenos">1105</span></a>
</span><span id="COMPsc-1106"><a href="#COMPsc-1106"><span class="linenos">1106</span></a><span class="sd">    calculate_difference_markers(min_exp=0, min_pct=0.25, n_proc=10, force=False)</span>
</span><span id="COMPsc-1107"><a href="#COMPsc-1107"><span class="linenos">1107</span></a><span class="sd">        Computes and caches differential markers using the statistic method.</span>
</span><span id="COMPsc-1108"><a href="#COMPsc-1108"><span class="linenos">1108</span></a>
</span><span id="COMPsc-1109"><a href="#COMPsc-1109"><span class="linenos">1109</span></a><span class="sd">    clustering_features(features_list=None, name_slot=&#39;cell_names&#39;, p_val=0.05, top_n=25, adj_mean=True, beta=0.4)</span>
</span><span id="COMPsc-1110"><a href="#COMPsc-1110"><span class="linenos">1110</span></a><span class="sd">        Prepares clustering input by selecting marker features and optionally smoothing cell values.</span>
</span><span id="COMPsc-1111"><a href="#COMPsc-1111"><span class="linenos">1111</span></a>
</span><span id="COMPsc-1112"><a href="#COMPsc-1112"><span class="linenos">1112</span></a><span class="sd">    average()</span>
</span><span id="COMPsc-1113"><a href="#COMPsc-1113"><span class="linenos">1113</span></a><span class="sd">        Aggregates normalized data by averaging across (cell_name, set) pairs.</span>
</span><span id="COMPsc-1114"><a href="#COMPsc-1114"><span class="linenos">1114</span></a>
</span><span id="COMPsc-1115"><a href="#COMPsc-1115"><span class="linenos">1115</span></a><span class="sd">    estimating_similarity(method=&#39;pearson&#39;, p_val=0.05, top_n=25)</span>
</span><span id="COMPsc-1116"><a href="#COMPsc-1116"><span class="linenos">1116</span></a><span class="sd">        Computes pairwise correlation and Euclidean distance between aggregated samples.</span>
</span><span id="COMPsc-1117"><a href="#COMPsc-1117"><span class="linenos">1117</span></a>
</span><span id="COMPsc-1118"><a href="#COMPsc-1118"><span class="linenos">1118</span></a><span class="sd">    similarity_plot(split_sets=True, set_info=True, cmap=&#39;seismic&#39;, width=12, height=10)</span>
</span><span id="COMPsc-1119"><a href="#COMPsc-1119"><span class="linenos">1119</span></a><span class="sd">        Visualizes pairwise similarity as a scatter plot with correlation as hue and scaled distance as point size.</span>
</span><span id="COMPsc-1120"><a href="#COMPsc-1120"><span class="linenos">1120</span></a>
</span><span id="COMPsc-1121"><a href="#COMPsc-1121"><span class="linenos">1121</span></a><span class="sd">    spatial_similarity(set_info=True, bandwidth=1, n_neighbors=5, min_dist=0.1, legend_split=2, point_size=20, ...)</span>
</span><span id="COMPsc-1122"><a href="#COMPsc-1122"><span class="linenos">1122</span></a><span class="sd">        Creates a UMAP-like visualization of similarity relationships with cluster hulls and nearest-neighbor arrows.</span>
</span><span id="COMPsc-1123"><a href="#COMPsc-1123"><span class="linenos">1123</span></a>
</span><span id="COMPsc-1124"><a href="#COMPsc-1124"><span class="linenos">1124</span></a><span class="sd">    subcluster_prepare(features, cluster)</span>
</span><span id="COMPsc-1125"><a href="#COMPsc-1125"><span class="linenos">1125</span></a><span class="sd">        Initializes a Clustering object for subcluster analysis on a selected parent cluster.</span>
</span><span id="COMPsc-1126"><a href="#COMPsc-1126"><span class="linenos">1126</span></a>
</span><span id="COMPsc-1127"><a href="#COMPsc-1127"><span class="linenos">1127</span></a><span class="sd">    define_subclusters(umap_num=2, eps=0.5, min_samples=10, bandwidth=1, n_neighbors=5, min_dist=0.1, ...)</span>
</span><span id="COMPsc-1128"><a href="#COMPsc-1128"><span class="linenos">1128</span></a><span class="sd">        Performs UMAP and DBSCAN clustering on prepared subcluster data and stores cluster labels.</span>
</span><span id="COMPsc-1129"><a href="#COMPsc-1129"><span class="linenos">1129</span></a>
</span><span id="COMPsc-1130"><a href="#COMPsc-1130"><span class="linenos">1130</span></a><span class="sd">    subcluster_features_scatter(colors=&#39;viridis&#39;, hclust=&#39;complete&#39;, img_width=3, img_high=5, label_size=6, ...)</span>
</span><span id="COMPsc-1131"><a href="#COMPsc-1131"><span class="linenos">1131</span></a><span class="sd">        Visualizes averaged expression and occurrence of features for subclusters as a scatter plot.</span>
</span><span id="COMPsc-1132"><a href="#COMPsc-1132"><span class="linenos">1132</span></a>
</span><span id="COMPsc-1133"><a href="#COMPsc-1133"><span class="linenos">1133</span></a><span class="sd">    subcluster_DEG_scatter(top_n=3, min_exp=0, min_pct=0.25, p_val=0.05, colors=&#39;viridis&#39;, ...)</span>
</span><span id="COMPsc-1134"><a href="#COMPsc-1134"><span class="linenos">1134</span></a><span class="sd">        Plots top differential features for subclusters as a features-scatter visualization.</span>
</span><span id="COMPsc-1135"><a href="#COMPsc-1135"><span class="linenos">1135</span></a>
</span><span id="COMPsc-1136"><a href="#COMPsc-1136"><span class="linenos">1136</span></a><span class="sd">    accept_subclusters()</span>
</span><span id="COMPsc-1137"><a href="#COMPsc-1137"><span class="linenos">1137</span></a><span class="sd">        Commits subcluster labels to main metadata by renaming cell names and clears subcluster data.</span>
</span><span id="COMPsc-1138"><a href="#COMPsc-1138"><span class="linenos">1138</span></a>
</span><span id="COMPsc-1139"><a href="#COMPsc-1139"><span class="linenos">1139</span></a><span class="sd">    Raises</span>
</span><span id="COMPsc-1140"><a href="#COMPsc-1140"><span class="linenos">1140</span></a><span class="sd">    ------</span>
</span><span id="COMPsc-1141"><a href="#COMPsc-1141"><span class="linenos">1141</span></a><span class="sd">    ValueError</span>
</span><span id="COMPsc-1142"><a href="#COMPsc-1142"><span class="linenos">1142</span></a><span class="sd">        For invalid parameters, mismatched dimensions, or missing metadata.</span>
</span><span id="COMPsc-1143"><a href="#COMPsc-1143"><span class="linenos">1143</span></a>
</span><span id="COMPsc-1144"><a href="#COMPsc-1144"><span class="linenos">1144</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="COMPsc-1145"><a href="#COMPsc-1145"><span class="linenos">1145</span></a>
</span><span id="COMPsc-1146"><a href="#COMPsc-1146"><span class="linenos">1146</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="COMPsc-1147"><a href="#COMPsc-1147"><span class="linenos">1147</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc-1148"><a href="#COMPsc-1148"><span class="linenos">1148</span></a>        <span class="n">objects</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-1149"><a href="#COMPsc-1149"><span class="linenos">1149</span></a>    <span class="p">):</span>
</span><span id="COMPsc-1150"><a href="#COMPsc-1150"><span class="linenos">1150</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-1151"><a href="#COMPsc-1151"><span class="linenos">1151</span></a><span class="sd">        Initialize the COMPsc class for single-cell data integration and analysis.</span>
</span><span id="COMPsc-1152"><a href="#COMPsc-1152"><span class="linenos">1152</span></a>
</span><span id="COMPsc-1153"><a href="#COMPsc-1153"><span class="linenos">1153</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-1154"><a href="#COMPsc-1154"><span class="linenos">1154</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-1155"><a href="#COMPsc-1155"><span class="linenos">1155</span></a><span class="sd">        objects : list or None, optional</span>
</span><span id="COMPsc-1156"><a href="#COMPsc-1156"><span class="linenos">1156</span></a><span class="sd">            Optional list of data objects to initialize the instance with.</span>
</span><span id="COMPsc-1157"><a href="#COMPsc-1157"><span class="linenos">1157</span></a>
</span><span id="COMPsc-1158"><a href="#COMPsc-1158"><span class="linenos">1158</span></a><span class="sd">        Attributes</span>
</span><span id="COMPsc-1159"><a href="#COMPsc-1159"><span class="linenos">1159</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-1160"><a href="#COMPsc-1160"><span class="linenos">1160</span></a><span class="sd">        -objects : list or None</span>
</span><span id="COMPsc-1161"><a href="#COMPsc-1161"><span class="linenos">1161</span></a><span class="sd">        -input_data : pandas.DataFrame or None</span>
</span><span id="COMPsc-1162"><a href="#COMPsc-1162"><span class="linenos">1162</span></a><span class="sd">        -input_metadata : pandas.DataFrame or None</span>
</span><span id="COMPsc-1163"><a href="#COMPsc-1163"><span class="linenos">1163</span></a><span class="sd">        -normalized_data : pandas.DataFrame or None</span>
</span><span id="COMPsc-1164"><a href="#COMPsc-1164"><span class="linenos">1164</span></a><span class="sd">        -agg_metadata : pandas.DataFrame or None</span>
</span><span id="COMPsc-1165"><a href="#COMPsc-1165"><span class="linenos">1165</span></a><span class="sd">        -agg_normalized_data : pandas.DataFrame or None</span>
</span><span id="COMPsc-1166"><a href="#COMPsc-1166"><span class="linenos">1166</span></a><span class="sd">        -similarity : pandas.DataFrame or None</span>
</span><span id="COMPsc-1167"><a href="#COMPsc-1167"><span class="linenos">1167</span></a><span class="sd">        -var_data : pandas.DataFrame or None</span>
</span><span id="COMPsc-1168"><a href="#COMPsc-1168"><span class="linenos">1168</span></a><span class="sd">        -subclusters_ : instance of Clustering class or None</span>
</span><span id="COMPsc-1169"><a href="#COMPsc-1169"><span class="linenos">1169</span></a><span class="sd">        -cells_calc : pandas.Series or None</span>
</span><span id="COMPsc-1170"><a href="#COMPsc-1170"><span class="linenos">1170</span></a><span class="sd">        -gene_calc : pandas.Series or None</span>
</span><span id="COMPsc-1171"><a href="#COMPsc-1171"><span class="linenos">1171</span></a><span class="sd">        -composition_data : pandas.DataFrame or None</span>
</span><span id="COMPsc-1172"><a href="#COMPsc-1172"><span class="linenos">1172</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-1173"><a href="#COMPsc-1173"><span class="linenos">1173</span></a>
</span><span id="COMPsc-1174"><a href="#COMPsc-1174"><span class="linenos">1174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="n">objects</span>
</span><span id="COMPsc-1175"><a href="#COMPsc-1175"><span class="linenos">1175</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Stores the input data objects.&quot;&quot;&quot;</span>
</span><span id="COMPsc-1176"><a href="#COMPsc-1176"><span class="linenos">1176</span></a>
</span><span id="COMPsc-1177"><a href="#COMPsc-1177"><span class="linenos">1177</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc-1178"><a href="#COMPsc-1178"><span class="linenos">1178</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Raw input data for clustering or integration analysis.&quot;&quot;&quot;</span>
</span><span id="COMPsc-1179"><a href="#COMPsc-1179"><span class="linenos">1179</span></a>
</span><span id="COMPsc-1180"><a href="#COMPsc-1180"><span class="linenos">1180</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc-1181"><a href="#COMPsc-1181"><span class="linenos">1181</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Metadata associated with the input data.&quot;&quot;&quot;</span>
</span><span id="COMPsc-1182"><a href="#COMPsc-1182"><span class="linenos">1182</span></a>
</span><span id="COMPsc-1183"><a href="#COMPsc-1183"><span class="linenos">1183</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc-1184"><a href="#COMPsc-1184"><span class="linenos">1184</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalized version of the input data.&quot;&quot;&quot;</span>
</span><span id="COMPsc-1185"><a href="#COMPsc-1185"><span class="linenos">1185</span></a>
</span><span id="COMPsc-1186"><a href="#COMPsc-1186"><span class="linenos">1186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc-1187"><a href="#COMPsc-1187"><span class="linenos">1187</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Aggregated metadata for all sets in object related to &quot;agg_normalized_data&quot;&#39;&#39;&#39;</span>
</span><span id="COMPsc-1188"><a href="#COMPsc-1188"><span class="linenos">1188</span></a>
</span><span id="COMPsc-1189"><a href="#COMPsc-1189"><span class="linenos">1189</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc-1190"><a href="#COMPsc-1190"><span class="linenos">1190</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregated and normalized data across multiple sets.&quot;&quot;&quot;</span>
</span><span id="COMPsc-1191"><a href="#COMPsc-1191"><span class="linenos">1191</span></a>
</span><span id="COMPsc-1192"><a href="#COMPsc-1192"><span class="linenos">1192</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc-1193"><a href="#COMPsc-1193"><span class="linenos">1193</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Similarity data between cells across all samples. and sets&quot;&quot;&quot;</span>
</span><span id="COMPsc-1194"><a href="#COMPsc-1194"><span class="linenos">1194</span></a>
</span><span id="COMPsc-1195"><a href="#COMPsc-1195"><span class="linenos">1195</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc-1196"><a href="#COMPsc-1196"><span class="linenos">1196</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;DEG analysis results summarizing variance across all samples in the object.&quot;&quot;&quot;</span>
</span><span id="COMPsc-1197"><a href="#COMPsc-1197"><span class="linenos">1197</span></a>
</span><span id="COMPsc-1198"><a href="#COMPsc-1198"><span class="linenos">1198</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc-1199"><a href="#COMPsc-1199"><span class="linenos">1199</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Placeholder for information about subclusters analysis; if computed.&quot;&quot;&quot;</span>
</span><span id="COMPsc-1200"><a href="#COMPsc-1200"><span class="linenos">1200</span></a>
</span><span id="COMPsc-1201"><a href="#COMPsc-1201"><span class="linenos">1201</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc-1202"><a href="#COMPsc-1202"><span class="linenos">1202</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of cells detected per sample (grouped by lineage, e.g., cluster or name), reflecting data composition.&quot;&quot;&quot;</span>
</span><span id="COMPsc-1203"><a href="#COMPsc-1203"><span class="linenos">1203</span></a>
</span><span id="COMPsc-1204"><a href="#COMPsc-1204"><span class="linenos">1204</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc-1205"><a href="#COMPsc-1205"><span class="linenos">1205</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of genes detected per sample (cell), reflecting the sequencing depth.&quot;&quot;&quot;</span>
</span><span id="COMPsc-1206"><a href="#COMPsc-1206"><span class="linenos">1206</span></a>
</span><span id="COMPsc-1207"><a href="#COMPsc-1207"><span class="linenos">1207</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">composition_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc-1208"><a href="#COMPsc-1208"><span class="linenos">1208</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Data describing composition of cells across clusters or sets.&quot;&quot;&quot;</span>
</span><span id="COMPsc-1209"><a href="#COMPsc-1209"><span class="linenos">1209</span></a>
</span><span id="COMPsc-1210"><a href="#COMPsc-1210"><span class="linenos">1210</span></a>    <span class="nd">@classmethod</span>
</span><span id="COMPsc-1211"><a href="#COMPsc-1211"><span class="linenos">1211</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">project_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path_to_directory</span><span class="p">,</span> <span class="n">project_list</span><span class="p">):</span>
</span><span id="COMPsc-1212"><a href="#COMPsc-1212"><span class="linenos">1212</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-1213"><a href="#COMPsc-1213"><span class="linenos">1213</span></a><span class="sd">        Scan a directory and build a COMPsc instance mapping provided project names</span>
</span><span id="COMPsc-1214"><a href="#COMPsc-1214"><span class="linenos">1214</span></a><span class="sd">        to their paths.</span>
</span><span id="COMPsc-1215"><a href="#COMPsc-1215"><span class="linenos">1215</span></a>
</span><span id="COMPsc-1216"><a href="#COMPsc-1216"><span class="linenos">1216</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-1217"><a href="#COMPsc-1217"><span class="linenos">1217</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-1218"><a href="#COMPsc-1218"><span class="linenos">1218</span></a><span class="sd">        path_to_directory : str</span>
</span><span id="COMPsc-1219"><a href="#COMPsc-1219"><span class="linenos">1219</span></a><span class="sd">            Path containing project subfolders.</span>
</span><span id="COMPsc-1220"><a href="#COMPsc-1220"><span class="linenos">1220</span></a>
</span><span id="COMPsc-1221"><a href="#COMPsc-1221"><span class="linenos">1221</span></a><span class="sd">        project_list : list[str]</span>
</span><span id="COMPsc-1222"><a href="#COMPsc-1222"><span class="linenos">1222</span></a><span class="sd">            List of filenames (folder names) to include in the returned object map.</span>
</span><span id="COMPsc-1223"><a href="#COMPsc-1223"><span class="linenos">1223</span></a>
</span><span id="COMPsc-1224"><a href="#COMPsc-1224"><span class="linenos">1224</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc-1225"><a href="#COMPsc-1225"><span class="linenos">1225</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-1226"><a href="#COMPsc-1226"><span class="linenos">1226</span></a><span class="sd">        COMPsc</span>
</span><span id="COMPsc-1227"><a href="#COMPsc-1227"><span class="linenos">1227</span></a><span class="sd">            New COMPsc instance with `objects` populated.</span>
</span><span id="COMPsc-1228"><a href="#COMPsc-1228"><span class="linenos">1228</span></a>
</span><span id="COMPsc-1229"><a href="#COMPsc-1229"><span class="linenos">1229</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc-1230"><a href="#COMPsc-1230"><span class="linenos">1230</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-1231"><a href="#COMPsc-1231"><span class="linenos">1231</span></a><span class="sd">        Exception</span>
</span><span id="COMPsc-1232"><a href="#COMPsc-1232"><span class="linenos">1232</span></a><span class="sd">            A generic exception is caught and a message printed if scanning fails.</span>
</span><span id="COMPsc-1233"><a href="#COMPsc-1233"><span class="linenos">1233</span></a>
</span><span id="COMPsc-1234"><a href="#COMPsc-1234"><span class="linenos">1234</span></a><span class="sd">        Notes</span>
</span><span id="COMPsc-1235"><a href="#COMPsc-1235"><span class="linenos">1235</span></a><span class="sd">        -----</span>
</span><span id="COMPsc-1236"><a href="#COMPsc-1236"><span class="linenos">1236</span></a><span class="sd">        Function attempts to match entries in `project_list` to directory</span>
</span><span id="COMPsc-1237"><a href="#COMPsc-1237"><span class="linenos">1237</span></a><span class="sd">        names and constructs a simplified object key from the folder name.</span>
</span><span id="COMPsc-1238"><a href="#COMPsc-1238"><span class="linenos">1238</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-1239"><a href="#COMPsc-1239"><span class="linenos">1239</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="COMPsc-1240"><a href="#COMPsc-1240"><span class="linenos">1240</span></a>            <span class="n">objects</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="COMPsc-1241"><a href="#COMPsc-1241"><span class="linenos">1241</span></a>            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path_to_directory</span><span class="p">)):</span>
</span><span id="COMPsc-1242"><a href="#COMPsc-1242"><span class="linenos">1242</span></a>                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">project_list</span><span class="p">:</span>
</span><span id="COMPsc-1243"><a href="#COMPsc-1243"><span class="linenos">1243</span></a>                    <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="COMPsc-1244"><a href="#COMPsc-1244"><span class="linenos">1244</span></a>                    <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">filename</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span><span id="COMPsc-1245"><a href="#COMPsc-1245"><span class="linenos">1245</span></a>                        <span class="n">objects</span><span class="p">[</span>
</span><span id="COMPsc-1246"><a href="#COMPsc-1246"><span class="linenos">1246</span></a>                            <span class="nb">str</span><span class="p">(</span>
</span><span id="COMPsc-1247"><a href="#COMPsc-1247"><span class="linenos">1247</span></a>                                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
</span><span id="COMPsc-1248"><a href="#COMPsc-1248"><span class="linenos">1248</span></a>                                    <span class="s2">&quot;_count&quot;</span><span class="p">,</span>
</span><span id="COMPsc-1249"><a href="#COMPsc-1249"><span class="linenos">1249</span></a>                                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="COMPsc-1250"><a href="#COMPsc-1250"><span class="linenos">1250</span></a>                                    <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
</span><span id="COMPsc-1251"><a href="#COMPsc-1251"><span class="linenos">1251</span></a>                                        <span class="s2">&quot;_fq&quot;</span><span class="p">,</span>
</span><span id="COMPsc-1252"><a href="#COMPsc-1252"><span class="linenos">1252</span></a>                                        <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="COMPsc-1253"><a href="#COMPsc-1253"><span class="linenos">1253</span></a>                                        <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
</span><span id="COMPsc-1254"><a href="#COMPsc-1254"><span class="linenos">1254</span></a>                                            <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;_.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
</span><span id="COMPsc-1255"><a href="#COMPsc-1255"><span class="linenos">1255</span></a>                                            <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="COMPsc-1256"><a href="#COMPsc-1256"><span class="linenos">1256</span></a>                                            <span class="n">filename</span><span class="p">,</span>
</span><span id="COMPsc-1257"><a href="#COMPsc-1257"><span class="linenos">1257</span></a>                                        <span class="p">),</span>
</span><span id="COMPsc-1258"><a href="#COMPsc-1258"><span class="linenos">1258</span></a>                                    <span class="p">),</span>
</span><span id="COMPsc-1259"><a href="#COMPsc-1259"><span class="linenos">1259</span></a>                                <span class="p">)</span>
</span><span id="COMPsc-1260"><a href="#COMPsc-1260"><span class="linenos">1260</span></a>                            <span class="p">)</span>
</span><span id="COMPsc-1261"><a href="#COMPsc-1261"><span class="linenos">1261</span></a>                        <span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
</span><span id="COMPsc-1262"><a href="#COMPsc-1262"><span class="linenos">1262</span></a>
</span><span id="COMPsc-1263"><a href="#COMPsc-1263"><span class="linenos">1263</span></a>            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
</span><span id="COMPsc-1264"><a href="#COMPsc-1264"><span class="linenos">1264</span></a>
</span><span id="COMPsc-1265"><a href="#COMPsc-1265"><span class="linenos">1265</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="COMPsc-1266"><a href="#COMPsc-1266"><span class="linenos">1266</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1267"><a href="#COMPsc-1267"><span class="linenos">1267</span></a>
</span><span id="COMPsc-1268"><a href="#COMPsc-1268"><span class="linenos">1268</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()):</span>
</span><span id="COMPsc-1269"><a href="#COMPsc-1269"><span class="linenos">1269</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-1270"><a href="#COMPsc-1270"><span class="linenos">1270</span></a><span class="sd">        Save the COMPsc object to disk using pickle.</span>
</span><span id="COMPsc-1271"><a href="#COMPsc-1271"><span class="linenos">1271</span></a>
</span><span id="COMPsc-1272"><a href="#COMPsc-1272"><span class="linenos">1272</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-1273"><a href="#COMPsc-1273"><span class="linenos">1273</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-1274"><a href="#COMPsc-1274"><span class="linenos">1274</span></a><span class="sd">        name : str</span>
</span><span id="COMPsc-1275"><a href="#COMPsc-1275"><span class="linenos">1275</span></a><span class="sd">            Base filename (without extension) to use when saving.</span>
</span><span id="COMPsc-1276"><a href="#COMPsc-1276"><span class="linenos">1276</span></a>
</span><span id="COMPsc-1277"><a href="#COMPsc-1277"><span class="linenos">1277</span></a><span class="sd">        path : str, default os.getcwd()</span>
</span><span id="COMPsc-1278"><a href="#COMPsc-1278"><span class="linenos">1278</span></a><span class="sd">            Directory in which to save the project file.</span>
</span><span id="COMPsc-1279"><a href="#COMPsc-1279"><span class="linenos">1279</span></a>
</span><span id="COMPsc-1280"><a href="#COMPsc-1280"><span class="linenos">1280</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc-1281"><a href="#COMPsc-1281"><span class="linenos">1281</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-1282"><a href="#COMPsc-1282"><span class="linenos">1282</span></a><span class="sd">        None</span>
</span><span id="COMPsc-1283"><a href="#COMPsc-1283"><span class="linenos">1283</span></a>
</span><span id="COMPsc-1284"><a href="#COMPsc-1284"><span class="linenos">1284</span></a><span class="sd">        Side Effects</span>
</span><span id="COMPsc-1285"><a href="#COMPsc-1285"><span class="linenos">1285</span></a><span class="sd">        ------------</span>
</span><span id="COMPsc-1286"><a href="#COMPsc-1286"><span class="linenos">1286</span></a><span class="sd">        - Writes a file `&lt;path&gt;/&lt;name&gt;.jpkl` containing the pickled object.</span>
</span><span id="COMPsc-1287"><a href="#COMPsc-1287"><span class="linenos">1287</span></a><span class="sd">        - Prints a confirmation message with saved path.</span>
</span><span id="COMPsc-1288"><a href="#COMPsc-1288"><span class="linenos">1288</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-1289"><a href="#COMPsc-1289"><span class="linenos">1289</span></a>
</span><span id="COMPsc-1290"><a href="#COMPsc-1290"><span class="linenos">1290</span></a>        <span class="n">full</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.jpkl&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1291"><a href="#COMPsc-1291"><span class="linenos">1291</span></a>
</span><span id="COMPsc-1292"><a href="#COMPsc-1292"><span class="linenos">1292</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="COMPsc-1293"><a href="#COMPsc-1293"><span class="linenos">1293</span></a>            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="COMPsc-1294"><a href="#COMPsc-1294"><span class="linenos">1294</span></a>
</span><span id="COMPsc-1295"><a href="#COMPsc-1295"><span class="linenos">1295</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project saved as </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1296"><a href="#COMPsc-1296"><span class="linenos">1296</span></a>
</span><span id="COMPsc-1297"><a href="#COMPsc-1297"><span class="linenos">1297</span></a>    <span class="nd">@classmethod</span>
</span><span id="COMPsc-1298"><a href="#COMPsc-1298"><span class="linenos">1298</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_project</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
</span><span id="COMPsc-1299"><a href="#COMPsc-1299"><span class="linenos">1299</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-1300"><a href="#COMPsc-1300"><span class="linenos">1300</span></a><span class="sd">        Load a previously saved COMPsc project from a pickle file.</span>
</span><span id="COMPsc-1301"><a href="#COMPsc-1301"><span class="linenos">1301</span></a>
</span><span id="COMPsc-1302"><a href="#COMPsc-1302"><span class="linenos">1302</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-1303"><a href="#COMPsc-1303"><span class="linenos">1303</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-1304"><a href="#COMPsc-1304"><span class="linenos">1304</span></a><span class="sd">        path : str</span>
</span><span id="COMPsc-1305"><a href="#COMPsc-1305"><span class="linenos">1305</span></a><span class="sd">            Full path to the pickled project file.</span>
</span><span id="COMPsc-1306"><a href="#COMPsc-1306"><span class="linenos">1306</span></a>
</span><span id="COMPsc-1307"><a href="#COMPsc-1307"><span class="linenos">1307</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc-1308"><a href="#COMPsc-1308"><span class="linenos">1308</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-1309"><a href="#COMPsc-1309"><span class="linenos">1309</span></a><span class="sd">        COMPsc</span>
</span><span id="COMPsc-1310"><a href="#COMPsc-1310"><span class="linenos">1310</span></a><span class="sd">            The unpickled COMPsc object.</span>
</span><span id="COMPsc-1311"><a href="#COMPsc-1311"><span class="linenos">1311</span></a>
</span><span id="COMPsc-1312"><a href="#COMPsc-1312"><span class="linenos">1312</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc-1313"><a href="#COMPsc-1313"><span class="linenos">1313</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-1314"><a href="#COMPsc-1314"><span class="linenos">1314</span></a><span class="sd">        FileNotFoundError</span>
</span><span id="COMPsc-1315"><a href="#COMPsc-1315"><span class="linenos">1315</span></a><span class="sd">            If the provided path does not exist.</span>
</span><span id="COMPsc-1316"><a href="#COMPsc-1316"><span class="linenos">1316</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-1317"><a href="#COMPsc-1317"><span class="linenos">1317</span></a>
</span><span id="COMPsc-1318"><a href="#COMPsc-1318"><span class="linenos">1318</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="COMPsc-1319"><a href="#COMPsc-1319"><span class="linenos">1319</span></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;File does not exist!&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1320"><a href="#COMPsc-1320"><span class="linenos">1320</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="COMPsc-1321"><a href="#COMPsc-1321"><span class="linenos">1321</span></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="COMPsc-1322"><a href="#COMPsc-1322"><span class="linenos">1322</span></a>        <span class="k">return</span> <span class="n">obj</span>
</span><span id="COMPsc-1323"><a href="#COMPsc-1323"><span class="linenos">1323</span></a>
</span><span id="COMPsc-1324"><a href="#COMPsc-1324"><span class="linenos">1324</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reduce_cols</span><span class="p">(</span>
</span><span id="COMPsc-1325"><a href="#COMPsc-1325"><span class="linenos">1325</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc-1326"><a href="#COMPsc-1326"><span class="linenos">1326</span></a>        <span class="n">reg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-1327"><a href="#COMPsc-1327"><span class="linenos">1327</span></a>        <span class="n">full</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-1328"><a href="#COMPsc-1328"><span class="linenos">1328</span></a>        <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="COMPsc-1329"><a href="#COMPsc-1329"><span class="linenos">1329</span></a>        <span class="n">inc_set</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="COMPsc-1330"><a href="#COMPsc-1330"><span class="linenos">1330</span></a>    <span class="p">):</span>
</span><span id="COMPsc-1331"><a href="#COMPsc-1331"><span class="linenos">1331</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-1332"><a href="#COMPsc-1332"><span class="linenos">1332</span></a><span class="sd">        Remove columns (cells) whose names contain a substring `reg` or</span>
</span><span id="COMPsc-1333"><a href="#COMPsc-1333"><span class="linenos">1333</span></a><span class="sd">        full name `full` from available tables.</span>
</span><span id="COMPsc-1334"><a href="#COMPsc-1334"><span class="linenos">1334</span></a>
</span><span id="COMPsc-1335"><a href="#COMPsc-1335"><span class="linenos">1335</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-1336"><a href="#COMPsc-1336"><span class="linenos">1336</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-1337"><a href="#COMPsc-1337"><span class="linenos">1337</span></a><span class="sd">        reg : str | None</span>
</span><span id="COMPsc-1338"><a href="#COMPsc-1338"><span class="linenos">1338</span></a><span class="sd">            Substring to search for in column/cell names; matching columns will be removed.</span>
</span><span id="COMPsc-1339"><a href="#COMPsc-1339"><span class="linenos">1339</span></a><span class="sd">            If not None, `full` must be None.</span>
</span><span id="COMPsc-1340"><a href="#COMPsc-1340"><span class="linenos">1340</span></a>
</span><span id="COMPsc-1341"><a href="#COMPsc-1341"><span class="linenos">1341</span></a><span class="sd">        full : str | None</span>
</span><span id="COMPsc-1342"><a href="#COMPsc-1342"><span class="linenos">1342</span></a><span class="sd">            Full name to search for in column/cell names; matching columns will be removed.</span>
</span><span id="COMPsc-1343"><a href="#COMPsc-1343"><span class="linenos">1343</span></a><span class="sd">            If not None, `reg` must be None.</span>
</span><span id="COMPsc-1344"><a href="#COMPsc-1344"><span class="linenos">1344</span></a>
</span><span id="COMPsc-1345"><a href="#COMPsc-1345"><span class="linenos">1345</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="COMPsc-1346"><a href="#COMPsc-1346"><span class="linenos">1346</span></a><span class="sd">            Column in metadata to use as sample names.</span>
</span><span id="COMPsc-1347"><a href="#COMPsc-1347"><span class="linenos">1347</span></a>
</span><span id="COMPsc-1348"><a href="#COMPsc-1348"><span class="linenos">1348</span></a><span class="sd">        inc_set : bool, default False</span>
</span><span id="COMPsc-1349"><a href="#COMPsc-1349"><span class="linenos">1349</span></a><span class="sd">            If True, column names are interpreted as &#39;cell_name # set&#39; when matching.</span>
</span><span id="COMPsc-1350"><a href="#COMPsc-1350"><span class="linenos">1350</span></a>
</span><span id="COMPsc-1351"><a href="#COMPsc-1351"><span class="linenos">1351</span></a><span class="sd">        Update</span>
</span><span id="COMPsc-1352"><a href="#COMPsc-1352"><span class="linenos">1352</span></a><span class="sd">        ------------</span>
</span><span id="COMPsc-1353"><a href="#COMPsc-1353"><span class="linenos">1353</span></a><span class="sd">        Mutates `self.input_data`, `self.normalized_data`, `self.input_metadata`,</span>
</span><span id="COMPsc-1354"><a href="#COMPsc-1354"><span class="linenos">1354</span></a><span class="sd">        `self.agg_normalized_data`, and `self.agg_metadata` (if they exist),</span>
</span><span id="COMPsc-1355"><a href="#COMPsc-1355"><span class="linenos">1355</span></a><span class="sd">        removing columns/rows that match `reg`.</span>
</span><span id="COMPsc-1356"><a href="#COMPsc-1356"><span class="linenos">1356</span></a>
</span><span id="COMPsc-1357"><a href="#COMPsc-1357"><span class="linenos">1357</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc-1358"><a href="#COMPsc-1358"><span class="linenos">1358</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-1359"><a href="#COMPsc-1359"><span class="linenos">1359</span></a><span class="sd">        Raises ValueError if nothing matches the reduction mask.</span>
</span><span id="COMPsc-1360"><a href="#COMPsc-1360"><span class="linenos">1360</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-1361"><a href="#COMPsc-1361"><span class="linenos">1361</span></a>
</span><span id="COMPsc-1362"><a href="#COMPsc-1362"><span class="linenos">1362</span></a>        <span class="k">if</span> <span class="n">reg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">full</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1363"><a href="#COMPsc-1363"><span class="linenos">1363</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc-1364"><a href="#COMPsc-1364"><span class="linenos">1364</span></a>                <span class="s2">&quot;Both &#39;reg&#39; and &#39;full&#39; arguments not provided. Please provide at least one of them!&quot;</span>
</span><span id="COMPsc-1365"><a href="#COMPsc-1365"><span class="linenos">1365</span></a>            <span class="p">)</span>
</span><span id="COMPsc-1366"><a href="#COMPsc-1366"><span class="linenos">1366</span></a>
</span><span id="COMPsc-1367"><a href="#COMPsc-1367"><span class="linenos">1367</span></a>        <span class="k">if</span> <span class="n">reg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">full</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1368"><a href="#COMPsc-1368"><span class="linenos">1368</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc-1369"><a href="#COMPsc-1369"><span class="linenos">1369</span></a>                <span class="s2">&quot;Both &#39;reg&#39; and &#39;full&#39; arguments are provided. &quot;</span>
</span><span id="COMPsc-1370"><a href="#COMPsc-1370"><span class="linenos">1370</span></a>                <span class="s2">&quot;Please provide only one of them!</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="COMPsc-1371"><a href="#COMPsc-1371"><span class="linenos">1371</span></a>                <span class="s2">&quot;&#39;reg&#39; is used when only part of the name must be detected.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="COMPsc-1372"><a href="#COMPsc-1372"><span class="linenos">1372</span></a>                <span class="s2">&quot;&#39;full&#39; is used if the full name must be detected.&quot;</span>
</span><span id="COMPsc-1373"><a href="#COMPsc-1373"><span class="linenos">1373</span></a>            <span class="p">)</span>
</span><span id="COMPsc-1374"><a href="#COMPsc-1374"><span class="linenos">1374</span></a>
</span><span id="COMPsc-1375"><a href="#COMPsc-1375"><span class="linenos">1375</span></a>        <span class="k">if</span> <span class="n">reg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1376"><a href="#COMPsc-1376"><span class="linenos">1376</span></a>
</span><span id="COMPsc-1377"><a href="#COMPsc-1377"><span class="linenos">1377</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1378"><a href="#COMPsc-1378"><span class="linenos">1378</span></a>
</span><span id="COMPsc-1379"><a href="#COMPsc-1379"><span class="linenos">1379</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc-1380"><a href="#COMPsc-1380"><span class="linenos">1380</span></a>
</span><span id="COMPsc-1381"><a href="#COMPsc-1381"><span class="linenos">1381</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc-1382"><a href="#COMPsc-1382"><span class="linenos">1382</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1383"><a href="#COMPsc-1383"><span class="linenos">1383</span></a>                        <span class="o">+</span> <span class="s2">&quot; # &quot;</span>
</span><span id="COMPsc-1384"><a href="#COMPsc-1384"><span class="linenos">1384</span></a>                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc-1385"><a href="#COMPsc-1385"><span class="linenos">1385</span></a>                    <span class="p">)</span>
</span><span id="COMPsc-1386"><a href="#COMPsc-1386"><span class="linenos">1386</span></a>
</span><span id="COMPsc-1387"><a href="#COMPsc-1387"><span class="linenos">1387</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-1388"><a href="#COMPsc-1388"><span class="linenos">1388</span></a>
</span><span id="COMPsc-1389"><a href="#COMPsc-1389"><span class="linenos">1389</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1390"><a href="#COMPsc-1390"><span class="linenos">1390</span></a>
</span><span id="COMPsc-1391"><a href="#COMPsc-1391"><span class="linenos">1391</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">reg</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc-1392"><a href="#COMPsc-1392"><span class="linenos">1392</span></a>
</span><span id="COMPsc-1393"><a href="#COMPsc-1393"><span class="linenos">1393</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-1394"><a href="#COMPsc-1394"><span class="linenos">1394</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1395"><a href="#COMPsc-1395"><span class="linenos">1395</span></a>
</span><span id="COMPsc-1396"><a href="#COMPsc-1396"><span class="linenos">1396</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="COMPsc-1397"><a href="#COMPsc-1397"><span class="linenos">1397</span></a>
</span><span id="COMPsc-1398"><a href="#COMPsc-1398"><span class="linenos">1398</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1399"><a href="#COMPsc-1399"><span class="linenos">1399</span></a>
</span><span id="COMPsc-1400"><a href="#COMPsc-1400"><span class="linenos">1400</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc-1401"><a href="#COMPsc-1401"><span class="linenos">1401</span></a>
</span><span id="COMPsc-1402"><a href="#COMPsc-1402"><span class="linenos">1402</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc-1403"><a href="#COMPsc-1403"><span class="linenos">1403</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1404"><a href="#COMPsc-1404"><span class="linenos">1404</span></a>                        <span class="o">+</span> <span class="s2">&quot; # &quot;</span>
</span><span id="COMPsc-1405"><a href="#COMPsc-1405"><span class="linenos">1405</span></a>                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc-1406"><a href="#COMPsc-1406"><span class="linenos">1406</span></a>                    <span class="p">)</span>
</span><span id="COMPsc-1407"><a href="#COMPsc-1407"><span class="linenos">1407</span></a>
</span><span id="COMPsc-1408"><a href="#COMPsc-1408"><span class="linenos">1408</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-1409"><a href="#COMPsc-1409"><span class="linenos">1409</span></a>
</span><span id="COMPsc-1410"><a href="#COMPsc-1410"><span class="linenos">1410</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1411"><a href="#COMPsc-1411"><span class="linenos">1411</span></a>
</span><span id="COMPsc-1412"><a href="#COMPsc-1412"><span class="linenos">1412</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc-1413"><a href="#COMPsc-1413"><span class="linenos">1413</span></a>                    <span class="n">reg</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="COMPsc-1414"><a href="#COMPsc-1414"><span class="linenos">1414</span></a>                <span class="p">]</span>
</span><span id="COMPsc-1415"><a href="#COMPsc-1415"><span class="linenos">1415</span></a>
</span><span id="COMPsc-1416"><a href="#COMPsc-1416"><span class="linenos">1416</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-1417"><a href="#COMPsc-1417"><span class="linenos">1417</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1418"><a href="#COMPsc-1418"><span class="linenos">1418</span></a>
</span><span id="COMPsc-1419"><a href="#COMPsc-1419"><span class="linenos">1419</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="COMPsc-1420"><a href="#COMPsc-1420"><span class="linenos">1420</span></a>
</span><span id="COMPsc-1421"><a href="#COMPsc-1421"><span class="linenos">1421</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1422"><a href="#COMPsc-1422"><span class="linenos">1422</span></a>
</span><span id="COMPsc-1423"><a href="#COMPsc-1423"><span class="linenos">1423</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc-1424"><a href="#COMPsc-1424"><span class="linenos">1424</span></a>
</span><span id="COMPsc-1425"><a href="#COMPsc-1425"><span class="linenos">1425</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc-1426"><a href="#COMPsc-1426"><span class="linenos">1426</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1427"><a href="#COMPsc-1427"><span class="linenos">1427</span></a>                        <span class="o">+</span> <span class="s2">&quot; # &quot;</span>
</span><span id="COMPsc-1428"><a href="#COMPsc-1428"><span class="linenos">1428</span></a>                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc-1429"><a href="#COMPsc-1429"><span class="linenos">1429</span></a>                    <span class="p">)</span>
</span><span id="COMPsc-1430"><a href="#COMPsc-1430"><span class="linenos">1430</span></a>
</span><span id="COMPsc-1431"><a href="#COMPsc-1431"><span class="linenos">1431</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-1432"><a href="#COMPsc-1432"><span class="linenos">1432</span></a>
</span><span id="COMPsc-1433"><a href="#COMPsc-1433"><span class="linenos">1433</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1434"><a href="#COMPsc-1434"><span class="linenos">1434</span></a>
</span><span id="COMPsc-1435"><a href="#COMPsc-1435"><span class="linenos">1435</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc-1436"><a href="#COMPsc-1436"><span class="linenos">1436</span></a>                    <span class="n">reg</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="COMPsc-1437"><a href="#COMPsc-1437"><span class="linenos">1437</span></a>                <span class="p">]</span>
</span><span id="COMPsc-1438"><a href="#COMPsc-1438"><span class="linenos">1438</span></a>
</span><span id="COMPsc-1439"><a href="#COMPsc-1439"><span class="linenos">1439</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-1440"><a href="#COMPsc-1440"><span class="linenos">1440</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1441"><a href="#COMPsc-1441"><span class="linenos">1441</span></a>
</span><span id="COMPsc-1442"><a href="#COMPsc-1442"><span class="linenos">1442</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="COMPsc-1443"><a href="#COMPsc-1443"><span class="linenos">1443</span></a>                    <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="COMPsc-1444"><a href="#COMPsc-1444"><span class="linenos">1444</span></a>                <span class="p">)</span>
</span><span id="COMPsc-1445"><a href="#COMPsc-1445"><span class="linenos">1445</span></a>
</span><span id="COMPsc-1446"><a href="#COMPsc-1446"><span class="linenos">1446</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="COMPsc-1447"><a href="#COMPsc-1447"><span class="linenos">1447</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="COMPsc-1448"><a href="#COMPsc-1448"><span class="linenos">1448</span></a>                <span class="p">)</span>
</span><span id="COMPsc-1449"><a href="#COMPsc-1449"><span class="linenos">1449</span></a>
</span><span id="COMPsc-1450"><a href="#COMPsc-1450"><span class="linenos">1450</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1451"><a href="#COMPsc-1451"><span class="linenos">1451</span></a>
</span><span id="COMPsc-1452"><a href="#COMPsc-1452"><span class="linenos">1452</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc-1453"><a href="#COMPsc-1453"><span class="linenos">1453</span></a>
</span><span id="COMPsc-1454"><a href="#COMPsc-1454"><span class="linenos">1454</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc-1455"><a href="#COMPsc-1455"><span class="linenos">1455</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc-1456"><a href="#COMPsc-1456"><span class="linenos">1456</span></a>                    <span class="p">)</span>
</span><span id="COMPsc-1457"><a href="#COMPsc-1457"><span class="linenos">1457</span></a>
</span><span id="COMPsc-1458"><a href="#COMPsc-1458"><span class="linenos">1458</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-1459"><a href="#COMPsc-1459"><span class="linenos">1459</span></a>
</span><span id="COMPsc-1460"><a href="#COMPsc-1460"><span class="linenos">1460</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1461"><a href="#COMPsc-1461"><span class="linenos">1461</span></a>
</span><span id="COMPsc-1462"><a href="#COMPsc-1462"><span class="linenos">1462</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc-1463"><a href="#COMPsc-1463"><span class="linenos">1463</span></a>                    <span class="n">reg</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="COMPsc-1464"><a href="#COMPsc-1464"><span class="linenos">1464</span></a>                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="COMPsc-1465"><a href="#COMPsc-1465"><span class="linenos">1465</span></a>                <span class="p">]</span>
</span><span id="COMPsc-1466"><a href="#COMPsc-1466"><span class="linenos">1466</span></a>
</span><span id="COMPsc-1467"><a href="#COMPsc-1467"><span class="linenos">1467</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-1468"><a href="#COMPsc-1468"><span class="linenos">1468</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1469"><a href="#COMPsc-1469"><span class="linenos">1469</span></a>
</span><span id="COMPsc-1470"><a href="#COMPsc-1470"><span class="linenos">1470</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="COMPsc-1471"><a href="#COMPsc-1471"><span class="linenos">1471</span></a>
</span><span id="COMPsc-1472"><a href="#COMPsc-1472"><span class="linenos">1472</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1473"><a href="#COMPsc-1473"><span class="linenos">1473</span></a>
</span><span id="COMPsc-1474"><a href="#COMPsc-1474"><span class="linenos">1474</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc-1475"><a href="#COMPsc-1475"><span class="linenos">1475</span></a>
</span><span id="COMPsc-1476"><a href="#COMPsc-1476"><span class="linenos">1476</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc-1477"><a href="#COMPsc-1477"><span class="linenos">1477</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc-1478"><a href="#COMPsc-1478"><span class="linenos">1478</span></a>                    <span class="p">)</span>
</span><span id="COMPsc-1479"><a href="#COMPsc-1479"><span class="linenos">1479</span></a>
</span><span id="COMPsc-1480"><a href="#COMPsc-1480"><span class="linenos">1480</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-1481"><a href="#COMPsc-1481"><span class="linenos">1481</span></a>
</span><span id="COMPsc-1482"><a href="#COMPsc-1482"><span class="linenos">1482</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1483"><a href="#COMPsc-1483"><span class="linenos">1483</span></a>
</span><span id="COMPsc-1484"><a href="#COMPsc-1484"><span class="linenos">1484</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">reg</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]]</span>
</span><span id="COMPsc-1485"><a href="#COMPsc-1485"><span class="linenos">1485</span></a>
</span><span id="COMPsc-1486"><a href="#COMPsc-1486"><span class="linenos">1486</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-1487"><a href="#COMPsc-1487"><span class="linenos">1487</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1488"><a href="#COMPsc-1488"><span class="linenos">1488</span></a>
</span><span id="COMPsc-1489"><a href="#COMPsc-1489"><span class="linenos">1489</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="COMPsc-1490"><a href="#COMPsc-1490"><span class="linenos">1490</span></a>                    <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="COMPsc-1491"><a href="#COMPsc-1491"><span class="linenos">1491</span></a>                <span class="p">)</span>
</span><span id="COMPsc-1492"><a href="#COMPsc-1492"><span class="linenos">1492</span></a>
</span><span id="COMPsc-1493"><a href="#COMPsc-1493"><span class="linenos">1493</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="COMPsc-1494"><a href="#COMPsc-1494"><span class="linenos">1494</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="COMPsc-1495"><a href="#COMPsc-1495"><span class="linenos">1495</span></a>                <span class="p">)</span>
</span><span id="COMPsc-1496"><a href="#COMPsc-1496"><span class="linenos">1496</span></a>
</span><span id="COMPsc-1497"><a href="#COMPsc-1497"><span class="linenos">1497</span></a>        <span class="k">elif</span> <span class="n">full</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1498"><a href="#COMPsc-1498"><span class="linenos">1498</span></a>
</span><span id="COMPsc-1499"><a href="#COMPsc-1499"><span class="linenos">1499</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1500"><a href="#COMPsc-1500"><span class="linenos">1500</span></a>
</span><span id="COMPsc-1501"><a href="#COMPsc-1501"><span class="linenos">1501</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc-1502"><a href="#COMPsc-1502"><span class="linenos">1502</span></a>
</span><span id="COMPsc-1503"><a href="#COMPsc-1503"><span class="linenos">1503</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc-1504"><a href="#COMPsc-1504"><span class="linenos">1504</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1505"><a href="#COMPsc-1505"><span class="linenos">1505</span></a>                        <span class="o">+</span> <span class="s2">&quot; # &quot;</span>
</span><span id="COMPsc-1506"><a href="#COMPsc-1506"><span class="linenos">1506</span></a>                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc-1507"><a href="#COMPsc-1507"><span class="linenos">1507</span></a>                    <span class="p">)</span>
</span><span id="COMPsc-1508"><a href="#COMPsc-1508"><span class="linenos">1508</span></a>
</span><span id="COMPsc-1509"><a href="#COMPsc-1509"><span class="linenos">1509</span></a>                    <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">full</span><span class="p">:</span>
</span><span id="COMPsc-1510"><a href="#COMPsc-1510"><span class="linenos">1510</span></a>
</span><span id="COMPsc-1511"><a href="#COMPsc-1511"><span class="linenos">1511</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1512"><a href="#COMPsc-1512"><span class="linenos">1512</span></a>
</span><span id="COMPsc-1513"><a href="#COMPsc-1513"><span class="linenos">1513</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="COMPsc-1514"><a href="#COMPsc-1514"><span class="linenos">1514</span></a>                            <span class="s2">&quot;Not include the set info (name # set) in the &#39;full&#39; argument, where &#39;inc_set&#39; is True&quot;</span>
</span><span id="COMPsc-1515"><a href="#COMPsc-1515"><span class="linenos">1515</span></a>                            <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="COMPsc-1516"><a href="#COMPsc-1516"><span class="linenos">1516</span></a>                        <span class="p">)</span>
</span><span id="COMPsc-1517"><a href="#COMPsc-1517"><span class="linenos">1517</span></a>
</span><span id="COMPsc-1518"><a href="#COMPsc-1518"><span class="linenos">1518</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-1519"><a href="#COMPsc-1519"><span class="linenos">1519</span></a>
</span><span id="COMPsc-1520"><a href="#COMPsc-1520"><span class="linenos">1520</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1521"><a href="#COMPsc-1521"><span class="linenos">1521</span></a>
</span><span id="COMPsc-1522"><a href="#COMPsc-1522"><span class="linenos">1522</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">full</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc-1523"><a href="#COMPsc-1523"><span class="linenos">1523</span></a>
</span><span id="COMPsc-1524"><a href="#COMPsc-1524"><span class="linenos">1524</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-1525"><a href="#COMPsc-1525"><span class="linenos">1525</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1526"><a href="#COMPsc-1526"><span class="linenos">1526</span></a>
</span><span id="COMPsc-1527"><a href="#COMPsc-1527"><span class="linenos">1527</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="COMPsc-1528"><a href="#COMPsc-1528"><span class="linenos">1528</span></a>
</span><span id="COMPsc-1529"><a href="#COMPsc-1529"><span class="linenos">1529</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1530"><a href="#COMPsc-1530"><span class="linenos">1530</span></a>
</span><span id="COMPsc-1531"><a href="#COMPsc-1531"><span class="linenos">1531</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc-1532"><a href="#COMPsc-1532"><span class="linenos">1532</span></a>
</span><span id="COMPsc-1533"><a href="#COMPsc-1533"><span class="linenos">1533</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc-1534"><a href="#COMPsc-1534"><span class="linenos">1534</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1535"><a href="#COMPsc-1535"><span class="linenos">1535</span></a>                        <span class="o">+</span> <span class="s2">&quot; # &quot;</span>
</span><span id="COMPsc-1536"><a href="#COMPsc-1536"><span class="linenos">1536</span></a>                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc-1537"><a href="#COMPsc-1537"><span class="linenos">1537</span></a>                    <span class="p">)</span>
</span><span id="COMPsc-1538"><a href="#COMPsc-1538"><span class="linenos">1538</span></a>
</span><span id="COMPsc-1539"><a href="#COMPsc-1539"><span class="linenos">1539</span></a>                    <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">full</span><span class="p">:</span>
</span><span id="COMPsc-1540"><a href="#COMPsc-1540"><span class="linenos">1540</span></a>
</span><span id="COMPsc-1541"><a href="#COMPsc-1541"><span class="linenos">1541</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1542"><a href="#COMPsc-1542"><span class="linenos">1542</span></a>
</span><span id="COMPsc-1543"><a href="#COMPsc-1543"><span class="linenos">1543</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="COMPsc-1544"><a href="#COMPsc-1544"><span class="linenos">1544</span></a>                            <span class="s2">&quot;Not include the set info (name # set) in the &#39;full&#39; argument, where &#39;inc_set&#39; is True&quot;</span>
</span><span id="COMPsc-1545"><a href="#COMPsc-1545"><span class="linenos">1545</span></a>                            <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="COMPsc-1546"><a href="#COMPsc-1546"><span class="linenos">1546</span></a>                        <span class="p">)</span>
</span><span id="COMPsc-1547"><a href="#COMPsc-1547"><span class="linenos">1547</span></a>
</span><span id="COMPsc-1548"><a href="#COMPsc-1548"><span class="linenos">1548</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-1549"><a href="#COMPsc-1549"><span class="linenos">1549</span></a>
</span><span id="COMPsc-1550"><a href="#COMPsc-1550"><span class="linenos">1550</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1551"><a href="#COMPsc-1551"><span class="linenos">1551</span></a>
</span><span id="COMPsc-1552"><a href="#COMPsc-1552"><span class="linenos">1552</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">full</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc-1553"><a href="#COMPsc-1553"><span class="linenos">1553</span></a>
</span><span id="COMPsc-1554"><a href="#COMPsc-1554"><span class="linenos">1554</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-1555"><a href="#COMPsc-1555"><span class="linenos">1555</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1556"><a href="#COMPsc-1556"><span class="linenos">1556</span></a>
</span><span id="COMPsc-1557"><a href="#COMPsc-1557"><span class="linenos">1557</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="COMPsc-1558"><a href="#COMPsc-1558"><span class="linenos">1558</span></a>
</span><span id="COMPsc-1559"><a href="#COMPsc-1559"><span class="linenos">1559</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1560"><a href="#COMPsc-1560"><span class="linenos">1560</span></a>
</span><span id="COMPsc-1561"><a href="#COMPsc-1561"><span class="linenos">1561</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc-1562"><a href="#COMPsc-1562"><span class="linenos">1562</span></a>
</span><span id="COMPsc-1563"><a href="#COMPsc-1563"><span class="linenos">1563</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc-1564"><a href="#COMPsc-1564"><span class="linenos">1564</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1565"><a href="#COMPsc-1565"><span class="linenos">1565</span></a>                        <span class="o">+</span> <span class="s2">&quot; # &quot;</span>
</span><span id="COMPsc-1566"><a href="#COMPsc-1566"><span class="linenos">1566</span></a>                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc-1567"><a href="#COMPsc-1567"><span class="linenos">1567</span></a>                    <span class="p">)</span>
</span><span id="COMPsc-1568"><a href="#COMPsc-1568"><span class="linenos">1568</span></a>
</span><span id="COMPsc-1569"><a href="#COMPsc-1569"><span class="linenos">1569</span></a>                    <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">full</span><span class="p">:</span>
</span><span id="COMPsc-1570"><a href="#COMPsc-1570"><span class="linenos">1570</span></a>
</span><span id="COMPsc-1571"><a href="#COMPsc-1571"><span class="linenos">1571</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1572"><a href="#COMPsc-1572"><span class="linenos">1572</span></a>
</span><span id="COMPsc-1573"><a href="#COMPsc-1573"><span class="linenos">1573</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="COMPsc-1574"><a href="#COMPsc-1574"><span class="linenos">1574</span></a>                            <span class="s2">&quot;Not include the set info (name # set) in the &#39;full&#39; argument, where &#39;inc_set&#39; is True&quot;</span>
</span><span id="COMPsc-1575"><a href="#COMPsc-1575"><span class="linenos">1575</span></a>                            <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="COMPsc-1576"><a href="#COMPsc-1576"><span class="linenos">1576</span></a>                        <span class="p">)</span>
</span><span id="COMPsc-1577"><a href="#COMPsc-1577"><span class="linenos">1577</span></a>
</span><span id="COMPsc-1578"><a href="#COMPsc-1578"><span class="linenos">1578</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-1579"><a href="#COMPsc-1579"><span class="linenos">1579</span></a>
</span><span id="COMPsc-1580"><a href="#COMPsc-1580"><span class="linenos">1580</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1581"><a href="#COMPsc-1581"><span class="linenos">1581</span></a>
</span><span id="COMPsc-1582"><a href="#COMPsc-1582"><span class="linenos">1582</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">full</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]]</span>
</span><span id="COMPsc-1583"><a href="#COMPsc-1583"><span class="linenos">1583</span></a>
</span><span id="COMPsc-1584"><a href="#COMPsc-1584"><span class="linenos">1584</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-1585"><a href="#COMPsc-1585"><span class="linenos">1585</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1586"><a href="#COMPsc-1586"><span class="linenos">1586</span></a>
</span><span id="COMPsc-1587"><a href="#COMPsc-1587"><span class="linenos">1587</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="COMPsc-1588"><a href="#COMPsc-1588"><span class="linenos">1588</span></a>                    <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="COMPsc-1589"><a href="#COMPsc-1589"><span class="linenos">1589</span></a>                <span class="p">)</span>
</span><span id="COMPsc-1590"><a href="#COMPsc-1590"><span class="linenos">1590</span></a>
</span><span id="COMPsc-1591"><a href="#COMPsc-1591"><span class="linenos">1591</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="COMPsc-1592"><a href="#COMPsc-1592"><span class="linenos">1592</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="COMPsc-1593"><a href="#COMPsc-1593"><span class="linenos">1593</span></a>                <span class="p">)</span>
</span><span id="COMPsc-1594"><a href="#COMPsc-1594"><span class="linenos">1594</span></a>
</span><span id="COMPsc-1595"><a href="#COMPsc-1595"><span class="linenos">1595</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1596"><a href="#COMPsc-1596"><span class="linenos">1596</span></a>
</span><span id="COMPsc-1597"><a href="#COMPsc-1597"><span class="linenos">1597</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc-1598"><a href="#COMPsc-1598"><span class="linenos">1598</span></a>
</span><span id="COMPsc-1599"><a href="#COMPsc-1599"><span class="linenos">1599</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc-1600"><a href="#COMPsc-1600"><span class="linenos">1600</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc-1601"><a href="#COMPsc-1601"><span class="linenos">1601</span></a>                    <span class="p">)</span>
</span><span id="COMPsc-1602"><a href="#COMPsc-1602"><span class="linenos">1602</span></a>
</span><span id="COMPsc-1603"><a href="#COMPsc-1603"><span class="linenos">1603</span></a>                    <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">full</span><span class="p">:</span>
</span><span id="COMPsc-1604"><a href="#COMPsc-1604"><span class="linenos">1604</span></a>
</span><span id="COMPsc-1605"><a href="#COMPsc-1605"><span class="linenos">1605</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1606"><a href="#COMPsc-1606"><span class="linenos">1606</span></a>
</span><span id="COMPsc-1607"><a href="#COMPsc-1607"><span class="linenos">1607</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="COMPsc-1608"><a href="#COMPsc-1608"><span class="linenos">1608</span></a>                            <span class="s2">&quot;Not include the set info (name # set) in the &#39;full&#39; argument, where &#39;inc_set&#39; is True&quot;</span>
</span><span id="COMPsc-1609"><a href="#COMPsc-1609"><span class="linenos">1609</span></a>                            <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="COMPsc-1610"><a href="#COMPsc-1610"><span class="linenos">1610</span></a>                        <span class="p">)</span>
</span><span id="COMPsc-1611"><a href="#COMPsc-1611"><span class="linenos">1611</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-1612"><a href="#COMPsc-1612"><span class="linenos">1612</span></a>
</span><span id="COMPsc-1613"><a href="#COMPsc-1613"><span class="linenos">1613</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1614"><a href="#COMPsc-1614"><span class="linenos">1614</span></a>
</span><span id="COMPsc-1615"><a href="#COMPsc-1615"><span class="linenos">1615</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc-1616"><a href="#COMPsc-1616"><span class="linenos">1616</span></a>                    <span class="n">full</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="COMPsc-1617"><a href="#COMPsc-1617"><span class="linenos">1617</span></a>                <span class="p">]</span>
</span><span id="COMPsc-1618"><a href="#COMPsc-1618"><span class="linenos">1618</span></a>
</span><span id="COMPsc-1619"><a href="#COMPsc-1619"><span class="linenos">1619</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-1620"><a href="#COMPsc-1620"><span class="linenos">1620</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1621"><a href="#COMPsc-1621"><span class="linenos">1621</span></a>
</span><span id="COMPsc-1622"><a href="#COMPsc-1622"><span class="linenos">1622</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="COMPsc-1623"><a href="#COMPsc-1623"><span class="linenos">1623</span></a>
</span><span id="COMPsc-1624"><a href="#COMPsc-1624"><span class="linenos">1624</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1625"><a href="#COMPsc-1625"><span class="linenos">1625</span></a>
</span><span id="COMPsc-1626"><a href="#COMPsc-1626"><span class="linenos">1626</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc-1627"><a href="#COMPsc-1627"><span class="linenos">1627</span></a>
</span><span id="COMPsc-1628"><a href="#COMPsc-1628"><span class="linenos">1628</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc-1629"><a href="#COMPsc-1629"><span class="linenos">1629</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc-1630"><a href="#COMPsc-1630"><span class="linenos">1630</span></a>                    <span class="p">)</span>
</span><span id="COMPsc-1631"><a href="#COMPsc-1631"><span class="linenos">1631</span></a>
</span><span id="COMPsc-1632"><a href="#COMPsc-1632"><span class="linenos">1632</span></a>                    <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">full</span><span class="p">:</span>
</span><span id="COMPsc-1633"><a href="#COMPsc-1633"><span class="linenos">1633</span></a>
</span><span id="COMPsc-1634"><a href="#COMPsc-1634"><span class="linenos">1634</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1635"><a href="#COMPsc-1635"><span class="linenos">1635</span></a>
</span><span id="COMPsc-1636"><a href="#COMPsc-1636"><span class="linenos">1636</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="COMPsc-1637"><a href="#COMPsc-1637"><span class="linenos">1637</span></a>                            <span class="s2">&quot;Not include the set info (name # set) in the &#39;full&#39; argument, where &#39;inc_set&#39; is True&quot;</span>
</span><span id="COMPsc-1638"><a href="#COMPsc-1638"><span class="linenos">1638</span></a>                            <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="COMPsc-1639"><a href="#COMPsc-1639"><span class="linenos">1639</span></a>                        <span class="p">)</span>
</span><span id="COMPsc-1640"><a href="#COMPsc-1640"><span class="linenos">1640</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-1641"><a href="#COMPsc-1641"><span class="linenos">1641</span></a>
</span><span id="COMPsc-1642"><a href="#COMPsc-1642"><span class="linenos">1642</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1643"><a href="#COMPsc-1643"><span class="linenos">1643</span></a>
</span><span id="COMPsc-1644"><a href="#COMPsc-1644"><span class="linenos">1644</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">full</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]]</span>
</span><span id="COMPsc-1645"><a href="#COMPsc-1645"><span class="linenos">1645</span></a>
</span><span id="COMPsc-1646"><a href="#COMPsc-1646"><span class="linenos">1646</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-1647"><a href="#COMPsc-1647"><span class="linenos">1647</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1648"><a href="#COMPsc-1648"><span class="linenos">1648</span></a>
</span><span id="COMPsc-1649"><a href="#COMPsc-1649"><span class="linenos">1649</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="COMPsc-1650"><a href="#COMPsc-1650"><span class="linenos">1650</span></a>                    <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="COMPsc-1651"><a href="#COMPsc-1651"><span class="linenos">1651</span></a>                <span class="p">)</span>
</span><span id="COMPsc-1652"><a href="#COMPsc-1652"><span class="linenos">1652</span></a>
</span><span id="COMPsc-1653"><a href="#COMPsc-1653"><span class="linenos">1653</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="COMPsc-1654"><a href="#COMPsc-1654"><span class="linenos">1654</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="COMPsc-1655"><a href="#COMPsc-1655"><span class="linenos">1655</span></a>                <span class="p">)</span>
</span><span id="COMPsc-1656"><a href="#COMPsc-1656"><span class="linenos">1656</span></a>
</span><span id="COMPsc-1657"><a href="#COMPsc-1657"><span class="linenos">1657</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_calculation</span><span class="p">()</span>
</span><span id="COMPsc-1658"><a href="#COMPsc-1658"><span class="linenos">1658</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">()</span>
</span><span id="COMPsc-1659"><a href="#COMPsc-1659"><span class="linenos">1659</span></a>
</span><span id="COMPsc-1660"><a href="#COMPsc-1660"><span class="linenos">1660</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reduce_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="COMPsc-1661"><a href="#COMPsc-1661"><span class="linenos">1661</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-1662"><a href="#COMPsc-1662"><span class="linenos">1662</span></a><span class="sd">        Remove rows (features) whose names are included in features_list.</span>
</span><span id="COMPsc-1663"><a href="#COMPsc-1663"><span class="linenos">1663</span></a>
</span><span id="COMPsc-1664"><a href="#COMPsc-1664"><span class="linenos">1664</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-1665"><a href="#COMPsc-1665"><span class="linenos">1665</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-1666"><a href="#COMPsc-1666"><span class="linenos">1666</span></a><span class="sd">        features_list : list</span>
</span><span id="COMPsc-1667"><a href="#COMPsc-1667"><span class="linenos">1667</span></a><span class="sd">            List of features to search for in index/gene names; matching entries will be removed.</span>
</span><span id="COMPsc-1668"><a href="#COMPsc-1668"><span class="linenos">1668</span></a>
</span><span id="COMPsc-1669"><a href="#COMPsc-1669"><span class="linenos">1669</span></a><span class="sd">        Update</span>
</span><span id="COMPsc-1670"><a href="#COMPsc-1670"><span class="linenos">1670</span></a><span class="sd">        ------------</span>
</span><span id="COMPsc-1671"><a href="#COMPsc-1671"><span class="linenos">1671</span></a><span class="sd">        Mutates `self.input_data`, `self.normalized_data`, `self.input_metadata`,</span>
</span><span id="COMPsc-1672"><a href="#COMPsc-1672"><span class="linenos">1672</span></a><span class="sd">        `self.agg_normalized_data`, and `self.agg_metadata` (if they exist),</span>
</span><span id="COMPsc-1673"><a href="#COMPsc-1673"><span class="linenos">1673</span></a><span class="sd">        removing columns/rows that match `reg`.</span>
</span><span id="COMPsc-1674"><a href="#COMPsc-1674"><span class="linenos">1674</span></a>
</span><span id="COMPsc-1675"><a href="#COMPsc-1675"><span class="linenos">1675</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc-1676"><a href="#COMPsc-1676"><span class="linenos">1676</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-1677"><a href="#COMPsc-1677"><span class="linenos">1677</span></a><span class="sd">        Prints a message listing features that are not found in the data.</span>
</span><span id="COMPsc-1678"><a href="#COMPsc-1678"><span class="linenos">1678</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-1679"><a href="#COMPsc-1679"><span class="linenos">1679</span></a>
</span><span id="COMPsc-1680"><a href="#COMPsc-1680"><span class="linenos">1680</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1681"><a href="#COMPsc-1681"><span class="linenos">1681</span></a>
</span><span id="COMPsc-1682"><a href="#COMPsc-1682"><span class="linenos">1682</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">find_features</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features_list</span><span class="p">)</span>
</span><span id="COMPsc-1683"><a href="#COMPsc-1683"><span class="linenos">1683</span></a>
</span><span id="COMPsc-1684"><a href="#COMPsc-1684"><span class="linenos">1684</span></a>            <span class="n">res_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;included&quot;</span><span class="p">]]</span>
</span><span id="COMPsc-1685"><a href="#COMPsc-1685"><span class="linenos">1685</span></a>
</span><span id="COMPsc-1686"><a href="#COMPsc-1686"><span class="linenos">1686</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res_list</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="COMPsc-1687"><a href="#COMPsc-1687"><span class="linenos">1687</span></a>
</span><span id="COMPsc-1688"><a href="#COMPsc-1688"><span class="linenos">1688</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-1689"><a href="#COMPsc-1689"><span class="linenos">1689</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1690"><a href="#COMPsc-1690"><span class="linenos">1690</span></a>
</span><span id="COMPsc-1691"><a href="#COMPsc-1691"><span class="linenos">1691</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="COMPsc-1692"><a href="#COMPsc-1692"><span class="linenos">1692</span></a>
</span><span id="COMPsc-1693"><a href="#COMPsc-1693"><span class="linenos">1693</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1694"><a href="#COMPsc-1694"><span class="linenos">1694</span></a>
</span><span id="COMPsc-1695"><a href="#COMPsc-1695"><span class="linenos">1695</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">find_features</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features_list</span><span class="p">)</span>
</span><span id="COMPsc-1696"><a href="#COMPsc-1696"><span class="linenos">1696</span></a>
</span><span id="COMPsc-1697"><a href="#COMPsc-1697"><span class="linenos">1697</span></a>            <span class="n">res_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;included&quot;</span><span class="p">]]</span>
</span><span id="COMPsc-1698"><a href="#COMPsc-1698"><span class="linenos">1698</span></a>
</span><span id="COMPsc-1699"><a href="#COMPsc-1699"><span class="linenos">1699</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res_list</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="COMPsc-1700"><a href="#COMPsc-1700"><span class="linenos">1700</span></a>
</span><span id="COMPsc-1701"><a href="#COMPsc-1701"><span class="linenos">1701</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-1702"><a href="#COMPsc-1702"><span class="linenos">1702</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1703"><a href="#COMPsc-1703"><span class="linenos">1703</span></a>
</span><span id="COMPsc-1704"><a href="#COMPsc-1704"><span class="linenos">1704</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="COMPsc-1705"><a href="#COMPsc-1705"><span class="linenos">1705</span></a>
</span><span id="COMPsc-1706"><a href="#COMPsc-1706"><span class="linenos">1706</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1707"><a href="#COMPsc-1707"><span class="linenos">1707</span></a>
</span><span id="COMPsc-1708"><a href="#COMPsc-1708"><span class="linenos">1708</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">find_features</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features_list</span><span class="p">)</span>
</span><span id="COMPsc-1709"><a href="#COMPsc-1709"><span class="linenos">1709</span></a>
</span><span id="COMPsc-1710"><a href="#COMPsc-1710"><span class="linenos">1710</span></a>            <span class="n">res_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;included&quot;</span><span class="p">]]</span>
</span><span id="COMPsc-1711"><a href="#COMPsc-1711"><span class="linenos">1711</span></a>
</span><span id="COMPsc-1712"><a href="#COMPsc-1712"><span class="linenos">1712</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res_list</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="COMPsc-1713"><a href="#COMPsc-1713"><span class="linenos">1713</span></a>
</span><span id="COMPsc-1714"><a href="#COMPsc-1714"><span class="linenos">1714</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-1715"><a href="#COMPsc-1715"><span class="linenos">1715</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1716"><a href="#COMPsc-1716"><span class="linenos">1716</span></a>
</span><span id="COMPsc-1717"><a href="#COMPsc-1717"><span class="linenos">1717</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="COMPsc-1718"><a href="#COMPsc-1718"><span class="linenos">1718</span></a>
</span><span id="COMPsc-1719"><a href="#COMPsc-1719"><span class="linenos">1719</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;not_included&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-1720"><a href="#COMPsc-1720"><span class="linenos">1720</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Features not found:&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1721"><a href="#COMPsc-1721"><span class="linenos">1721</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;not_included&quot;</span><span class="p">]:</span>
</span><span id="COMPsc-1722"><a href="#COMPsc-1722"><span class="linenos">1722</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="COMPsc-1723"><a href="#COMPsc-1723"><span class="linenos">1723</span></a>
</span><span id="COMPsc-1724"><a href="#COMPsc-1724"><span class="linenos">1724</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_calculation</span><span class="p">()</span>
</span><span id="COMPsc-1725"><a href="#COMPsc-1725"><span class="linenos">1725</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">()</span>
</span><span id="COMPsc-1726"><a href="#COMPsc-1726"><span class="linenos">1726</span></a>
</span><span id="COMPsc-1727"><a href="#COMPsc-1727"><span class="linenos">1727</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_info</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="COMPsc-1728"><a href="#COMPsc-1728"><span class="linenos">1728</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-1729"><a href="#COMPsc-1729"><span class="linenos">1729</span></a><span class="sd">        Return normalized data with optional set annotation appended to column names.</span>
</span><span id="COMPsc-1730"><a href="#COMPsc-1730"><span class="linenos">1730</span></a>
</span><span id="COMPsc-1731"><a href="#COMPsc-1731"><span class="linenos">1731</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-1732"><a href="#COMPsc-1732"><span class="linenos">1732</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-1733"><a href="#COMPsc-1733"><span class="linenos">1733</span></a><span class="sd">        set_info : bool, default False</span>
</span><span id="COMPsc-1734"><a href="#COMPsc-1734"><span class="linenos">1734</span></a><span class="sd">            If True, column names are returned as &quot;cell_name # set&quot;; otherwise</span>
</span><span id="COMPsc-1735"><a href="#COMPsc-1735"><span class="linenos">1735</span></a><span class="sd">            only the `cell_name` is used.</span>
</span><span id="COMPsc-1736"><a href="#COMPsc-1736"><span class="linenos">1736</span></a>
</span><span id="COMPsc-1737"><a href="#COMPsc-1737"><span class="linenos">1737</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc-1738"><a href="#COMPsc-1738"><span class="linenos">1738</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-1739"><a href="#COMPsc-1739"><span class="linenos">1739</span></a><span class="sd">        pandas.DataFrame</span>
</span><span id="COMPsc-1740"><a href="#COMPsc-1740"><span class="linenos">1740</span></a><span class="sd">            The `self.normalized_data` table with columns renamed according to `set_info`.</span>
</span><span id="COMPsc-1741"><a href="#COMPsc-1741"><span class="linenos">1741</span></a>
</span><span id="COMPsc-1742"><a href="#COMPsc-1742"><span class="linenos">1742</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc-1743"><a href="#COMPsc-1743"><span class="linenos">1743</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-1744"><a href="#COMPsc-1744"><span class="linenos">1744</span></a><span class="sd">        AttributeError</span>
</span><span id="COMPsc-1745"><a href="#COMPsc-1745"><span class="linenos">1745</span></a><span class="sd">            If `self.normalized_data` or `self.input_metadata` is missing.</span>
</span><span id="COMPsc-1746"><a href="#COMPsc-1746"><span class="linenos">1746</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-1747"><a href="#COMPsc-1747"><span class="linenos">1747</span></a>
</span><span id="COMPsc-1748"><a href="#COMPsc-1748"><span class="linenos">1748</span></a>        <span class="n">to_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span>
</span><span id="COMPsc-1749"><a href="#COMPsc-1749"><span class="linenos">1749</span></a>
</span><span id="COMPsc-1750"><a href="#COMPsc-1750"><span class="linenos">1750</span></a>        <span class="k">if</span> <span class="n">set_info</span><span class="p">:</span>
</span><span id="COMPsc-1751"><a href="#COMPsc-1751"><span class="linenos">1751</span></a>            <span class="n">to_return</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc-1752"><a href="#COMPsc-1752"><span class="linenos">1752</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc-1753"><a href="#COMPsc-1753"><span class="linenos">1753</span></a>            <span class="p">)</span>
</span><span id="COMPsc-1754"><a href="#COMPsc-1754"><span class="linenos">1754</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-1755"><a href="#COMPsc-1755"><span class="linenos">1755</span></a>            <span class="n">to_return</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span>
</span><span id="COMPsc-1756"><a href="#COMPsc-1756"><span class="linenos">1756</span></a>
</span><span id="COMPsc-1757"><a href="#COMPsc-1757"><span class="linenos">1757</span></a>        <span class="k">return</span> <span class="n">to_return</span>
</span><span id="COMPsc-1758"><a href="#COMPsc-1758"><span class="linenos">1758</span></a>
</span><span id="COMPsc-1759"><a href="#COMPsc-1759"><span class="linenos">1759</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_partial_data</span><span class="p">(</span>
</span><span id="COMPsc-1760"><a href="#COMPsc-1760"><span class="linenos">1760</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc-1761"><a href="#COMPsc-1761"><span class="linenos">1761</span></a>        <span class="n">names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-1762"><a href="#COMPsc-1762"><span class="linenos">1762</span></a>        <span class="n">features</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-1763"><a href="#COMPsc-1763"><span class="linenos">1763</span></a>        <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="COMPsc-1764"><a href="#COMPsc-1764"><span class="linenos">1764</span></a>        <span class="n">inc_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="COMPsc-1765"><a href="#COMPsc-1765"><span class="linenos">1765</span></a>    <span class="p">):</span>
</span><span id="COMPsc-1766"><a href="#COMPsc-1766"><span class="linenos">1766</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-1767"><a href="#COMPsc-1767"><span class="linenos">1767</span></a><span class="sd">        Return a subset of the data filtered by sample names and/or feature names.</span>
</span><span id="COMPsc-1768"><a href="#COMPsc-1768"><span class="linenos">1768</span></a>
</span><span id="COMPsc-1769"><a href="#COMPsc-1769"><span class="linenos">1769</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-1770"><a href="#COMPsc-1770"><span class="linenos">1770</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-1771"><a href="#COMPsc-1771"><span class="linenos">1771</span></a><span class="sd">        names : list, str, or None</span>
</span><span id="COMPsc-1772"><a href="#COMPsc-1772"><span class="linenos">1772</span></a><span class="sd">            Names of samples to include. If None, all samples are considered.</span>
</span><span id="COMPsc-1773"><a href="#COMPsc-1773"><span class="linenos">1773</span></a>
</span><span id="COMPsc-1774"><a href="#COMPsc-1774"><span class="linenos">1774</span></a><span class="sd">        features : list, str, or None</span>
</span><span id="COMPsc-1775"><a href="#COMPsc-1775"><span class="linenos">1775</span></a><span class="sd">            Names of features to include. If None, all features are considered.</span>
</span><span id="COMPsc-1776"><a href="#COMPsc-1776"><span class="linenos">1776</span></a>
</span><span id="COMPsc-1777"><a href="#COMPsc-1777"><span class="linenos">1777</span></a><span class="sd">        name_slot : str</span>
</span><span id="COMPsc-1778"><a href="#COMPsc-1778"><span class="linenos">1778</span></a><span class="sd">            Column in metadata to use as sample names.</span>
</span><span id="COMPsc-1779"><a href="#COMPsc-1779"><span class="linenos">1779</span></a>
</span><span id="COMPsc-1780"><a href="#COMPsc-1780"><span class="linenos">1780</span></a><span class="sd">        inc_metadata : bool</span>
</span><span id="COMPsc-1781"><a href="#COMPsc-1781"><span class="linenos">1781</span></a><span class="sd">            If True return tuple (data, metadata)</span>
</span><span id="COMPsc-1782"><a href="#COMPsc-1782"><span class="linenos">1782</span></a>
</span><span id="COMPsc-1783"><a href="#COMPsc-1783"><span class="linenos">1783</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc-1784"><a href="#COMPsc-1784"><span class="linenos">1784</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-1785"><a href="#COMPsc-1785"><span class="linenos">1785</span></a><span class="sd">        pandas.DataFrame</span>
</span><span id="COMPsc-1786"><a href="#COMPsc-1786"><span class="linenos">1786</span></a><span class="sd">            Subset of the normalized data based on the specified names and features.</span>
</span><span id="COMPsc-1787"><a href="#COMPsc-1787"><span class="linenos">1787</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-1788"><a href="#COMPsc-1788"><span class="linenos">1788</span></a>
</span><span id="COMPsc-1789"><a href="#COMPsc-1789"><span class="linenos">1789</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="COMPsc-1790"><a href="#COMPsc-1790"><span class="linenos">1790</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span>
</span><span id="COMPsc-1791"><a href="#COMPsc-1791"><span class="linenos">1791</span></a>
</span><span id="COMPsc-1792"><a href="#COMPsc-1792"><span class="linenos">1792</span></a>        <span class="k">if</span> <span class="n">name_slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="COMPsc-1793"><a href="#COMPsc-1793"><span class="linenos">1793</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-1794"><a href="#COMPsc-1794"><span class="linenos">1794</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-1795"><a href="#COMPsc-1795"><span class="linenos">1795</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;name_slot&#39; not occured in data!&#39;&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1796"><a href="#COMPsc-1796"><span class="linenos">1796</span></a>
</span><span id="COMPsc-1797"><a href="#COMPsc-1797"><span class="linenos">1797</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="COMPsc-1798"><a href="#COMPsc-1798"><span class="linenos">1798</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">features</span><span class="p">]</span>
</span><span id="COMPsc-1799"><a href="#COMPsc-1799"><span class="linenos">1799</span></a>        <span class="k">elif</span> <span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1800"><a href="#COMPsc-1800"><span class="linenos">1800</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc-1801"><a href="#COMPsc-1801"><span class="linenos">1801</span></a>
</span><span id="COMPsc-1802"><a href="#COMPsc-1802"><span class="linenos">1802</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="COMPsc-1803"><a href="#COMPsc-1803"><span class="linenos">1803</span></a>            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">names</span><span class="p">]</span>
</span><span id="COMPsc-1804"><a href="#COMPsc-1804"><span class="linenos">1804</span></a>        <span class="k">elif</span> <span class="n">names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1805"><a href="#COMPsc-1805"><span class="linenos">1805</span></a>            <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc-1806"><a href="#COMPsc-1806"><span class="linenos">1806</span></a>
</span><span id="COMPsc-1807"><a href="#COMPsc-1807"><span class="linenos">1807</span></a>        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">features</span><span class="p">]</span>
</span><span id="COMPsc-1808"><a href="#COMPsc-1808"><span class="linenos">1808</span></a>        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
</span><span id="COMPsc-1809"><a href="#COMPsc-1809"><span class="linenos">1809</span></a>
</span><span id="COMPsc-1810"><a href="#COMPsc-1810"><span class="linenos">1810</span></a>        <span class="n">columns_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc-1811"><a href="#COMPsc-1811"><span class="linenos">1811</span></a>        <span class="n">features_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="COMPsc-1812"><a href="#COMPsc-1812"><span class="linenos">1812</span></a>
</span><span id="COMPsc-1813"><a href="#COMPsc-1813"><span class="linenos">1813</span></a>        <span class="n">columns_bool</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">columns_names</span><span class="p">]</span>
</span><span id="COMPsc-1814"><a href="#COMPsc-1814"><span class="linenos">1814</span></a>        <span class="n">features_bool</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">features</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">features_names</span><span class="p">]</span>
</span><span id="COMPsc-1815"><a href="#COMPsc-1815"><span class="linenos">1815</span></a>
</span><span id="COMPsc-1816"><a href="#COMPsc-1816"><span class="linenos">1816</span></a>        <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns_bool</span> <span class="ow">and</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">features_bool</span><span class="p">:</span>
</span><span id="COMPsc-1817"><a href="#COMPsc-1817"><span class="linenos">1817</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Missing &#39;names&#39; and/or &#39;features&#39;. Returning full dataset instead.&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1818"><a href="#COMPsc-1818"><span class="linenos">1818</span></a>            <span class="k">if</span> <span class="n">inc_metadata</span><span class="p">:</span>
</span><span id="COMPsc-1819"><a href="#COMPsc-1819"><span class="linenos">1819</span></a>                <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span>
</span><span id="COMPsc-1820"><a href="#COMPsc-1820"><span class="linenos">1820</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-1821"><a href="#COMPsc-1821"><span class="linenos">1821</span></a>                <span class="k">return</span> <span class="n">data</span>
</span><span id="COMPsc-1822"><a href="#COMPsc-1822"><span class="linenos">1822</span></a>
</span><span id="COMPsc-1823"><a href="#COMPsc-1823"><span class="linenos">1823</span></a>        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">columns_bool</span><span class="p">:</span>
</span><span id="COMPsc-1824"><a href="#COMPsc-1824"><span class="linenos">1824</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">columns_bool</span><span class="p">]</span>
</span><span id="COMPsc-1825"><a href="#COMPsc-1825"><span class="linenos">1825</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">columns_bool</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="COMPsc-1826"><a href="#COMPsc-1826"><span class="linenos">1826</span></a>
</span><span id="COMPsc-1827"><a href="#COMPsc-1827"><span class="linenos">1827</span></a>            <span class="k">if</span> <span class="n">inc_metadata</span><span class="p">:</span>
</span><span id="COMPsc-1828"><a href="#COMPsc-1828"><span class="linenos">1828</span></a>                <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span>
</span><span id="COMPsc-1829"><a href="#COMPsc-1829"><span class="linenos">1829</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-1830"><a href="#COMPsc-1830"><span class="linenos">1830</span></a>                <span class="k">return</span> <span class="n">data</span>
</span><span id="COMPsc-1831"><a href="#COMPsc-1831"><span class="linenos">1831</span></a>
</span><span id="COMPsc-1832"><a href="#COMPsc-1832"><span class="linenos">1832</span></a>        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">features_bool</span><span class="p">:</span>
</span><span id="COMPsc-1833"><a href="#COMPsc-1833"><span class="linenos">1833</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">features_bool</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="COMPsc-1834"><a href="#COMPsc-1834"><span class="linenos">1834</span></a>
</span><span id="COMPsc-1835"><a href="#COMPsc-1835"><span class="linenos">1835</span></a>            <span class="k">if</span> <span class="n">inc_metadata</span><span class="p">:</span>
</span><span id="COMPsc-1836"><a href="#COMPsc-1836"><span class="linenos">1836</span></a>                <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span>
</span><span id="COMPsc-1837"><a href="#COMPsc-1837"><span class="linenos">1837</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-1838"><a href="#COMPsc-1838"><span class="linenos">1838</span></a>                <span class="k">return</span> <span class="n">data</span>
</span><span id="COMPsc-1839"><a href="#COMPsc-1839"><span class="linenos">1839</span></a>
</span><span id="COMPsc-1840"><a href="#COMPsc-1840"><span class="linenos">1840</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="COMPsc-1841"><a href="#COMPsc-1841"><span class="linenos">1841</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-1842"><a href="#COMPsc-1842"><span class="linenos">1842</span></a><span class="sd">        Return the stored input metadata.</span>
</span><span id="COMPsc-1843"><a href="#COMPsc-1843"><span class="linenos">1843</span></a>
</span><span id="COMPsc-1844"><a href="#COMPsc-1844"><span class="linenos">1844</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc-1845"><a href="#COMPsc-1845"><span class="linenos">1845</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-1846"><a href="#COMPsc-1846"><span class="linenos">1846</span></a><span class="sd">        pandas.DataFrame</span>
</span><span id="COMPsc-1847"><a href="#COMPsc-1847"><span class="linenos">1847</span></a><span class="sd">            `self.input_metadata` (may be None if not set).</span>
</span><span id="COMPsc-1848"><a href="#COMPsc-1848"><span class="linenos">1848</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-1849"><a href="#COMPsc-1849"><span class="linenos">1849</span></a>
</span><span id="COMPsc-1850"><a href="#COMPsc-1850"><span class="linenos">1850</span></a>        <span class="n">to_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span>
</span><span id="COMPsc-1851"><a href="#COMPsc-1851"><span class="linenos">1851</span></a>
</span><span id="COMPsc-1852"><a href="#COMPsc-1852"><span class="linenos">1852</span></a>        <span class="k">return</span> <span class="n">to_return</span>
</span><span id="COMPsc-1853"><a href="#COMPsc-1853"><span class="linenos">1853</span></a>
</span><span id="COMPsc-1854"><a href="#COMPsc-1854"><span class="linenos">1854</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gene_calculation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="COMPsc-1855"><a href="#COMPsc-1855"><span class="linenos">1855</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-1856"><a href="#COMPsc-1856"><span class="linenos">1856</span></a><span class="sd">        Calculate and store per-cell counts (e.g., number of detected genes).</span>
</span><span id="COMPsc-1857"><a href="#COMPsc-1857"><span class="linenos">1857</span></a>
</span><span id="COMPsc-1858"><a href="#COMPsc-1858"><span class="linenos">1858</span></a><span class="sd">        The method computes a binary (presence/absence) per cell and sums across</span>
</span><span id="COMPsc-1859"><a href="#COMPsc-1859"><span class="linenos">1859</span></a><span class="sd">        features to produce `self.gene_calc`.</span>
</span><span id="COMPsc-1860"><a href="#COMPsc-1860"><span class="linenos">1860</span></a>
</span><span id="COMPsc-1861"><a href="#COMPsc-1861"><span class="linenos">1861</span></a><span class="sd">        Update</span>
</span><span id="COMPsc-1862"><a href="#COMPsc-1862"><span class="linenos">1862</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-1863"><a href="#COMPsc-1863"><span class="linenos">1863</span></a><span class="sd">        Sets `self.gene_calc` as a pandas.Series.</span>
</span><span id="COMPsc-1864"><a href="#COMPsc-1864"><span class="linenos">1864</span></a>
</span><span id="COMPsc-1865"><a href="#COMPsc-1865"><span class="linenos">1865</span></a><span class="sd">        Side Effects</span>
</span><span id="COMPsc-1866"><a href="#COMPsc-1866"><span class="linenos">1866</span></a><span class="sd">        ------------</span>
</span><span id="COMPsc-1867"><a href="#COMPsc-1867"><span class="linenos">1867</span></a><span class="sd">        Uses `self.input_data` when available, otherwise `self.normalized_data`.</span>
</span><span id="COMPsc-1868"><a href="#COMPsc-1868"><span class="linenos">1868</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-1869"><a href="#COMPsc-1869"><span class="linenos">1869</span></a>
</span><span id="COMPsc-1870"><a href="#COMPsc-1870"><span class="linenos">1870</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1871"><a href="#COMPsc-1871"><span class="linenos">1871</span></a>
</span><span id="COMPsc-1872"><a href="#COMPsc-1872"><span class="linenos">1872</span></a>            <span class="n">bin_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="COMPsc-1873"><a href="#COMPsc-1873"><span class="linenos">1873</span></a>
</span><span id="COMPsc-1874"><a href="#COMPsc-1874"><span class="linenos">1874</span></a>            <span class="n">bin_col</span> <span class="o">=</span> <span class="n">bin_col</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bin_col</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc-1875"><a href="#COMPsc-1875"><span class="linenos">1875</span></a>
</span><span id="COMPsc-1876"><a href="#COMPsc-1876"><span class="linenos">1876</span></a>            <span class="n">sum_data</span> <span class="o">=</span> <span class="n">bin_col</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="COMPsc-1877"><a href="#COMPsc-1877"><span class="linenos">1877</span></a>
</span><span id="COMPsc-1878"><a href="#COMPsc-1878"><span class="linenos">1878</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">=</span> <span class="n">sum_data</span>
</span><span id="COMPsc-1879"><a href="#COMPsc-1879"><span class="linenos">1879</span></a>
</span><span id="COMPsc-1880"><a href="#COMPsc-1880"><span class="linenos">1880</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1881"><a href="#COMPsc-1881"><span class="linenos">1881</span></a>
</span><span id="COMPsc-1882"><a href="#COMPsc-1882"><span class="linenos">1882</span></a>            <span class="n">bin_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="COMPsc-1883"><a href="#COMPsc-1883"><span class="linenos">1883</span></a>
</span><span id="COMPsc-1884"><a href="#COMPsc-1884"><span class="linenos">1884</span></a>            <span class="n">bin_col</span> <span class="o">=</span> <span class="n">bin_col</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bin_col</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc-1885"><a href="#COMPsc-1885"><span class="linenos">1885</span></a>
</span><span id="COMPsc-1886"><a href="#COMPsc-1886"><span class="linenos">1886</span></a>            <span class="n">sum_data</span> <span class="o">=</span> <span class="n">bin_col</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="COMPsc-1887"><a href="#COMPsc-1887"><span class="linenos">1887</span></a>
</span><span id="COMPsc-1888"><a href="#COMPsc-1888"><span class="linenos">1888</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">=</span> <span class="n">sum_data</span>
</span><span id="COMPsc-1889"><a href="#COMPsc-1889"><span class="linenos">1889</span></a>
</span><span id="COMPsc-1890"><a href="#COMPsc-1890"><span class="linenos">1890</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gene_histograme</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="COMPsc-1891"><a href="#COMPsc-1891"><span class="linenos">1891</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-1892"><a href="#COMPsc-1892"><span class="linenos">1892</span></a><span class="sd">        Plot a histogram of the number of genes detected per cell.</span>
</span><span id="COMPsc-1893"><a href="#COMPsc-1893"><span class="linenos">1893</span></a>
</span><span id="COMPsc-1894"><a href="#COMPsc-1894"><span class="linenos">1894</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-1895"><a href="#COMPsc-1895"><span class="linenos">1895</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-1896"><a href="#COMPsc-1896"><span class="linenos">1896</span></a><span class="sd">        bins : int, default 100</span>
</span><span id="COMPsc-1897"><a href="#COMPsc-1897"><span class="linenos">1897</span></a><span class="sd">            Number of histogram bins.</span>
</span><span id="COMPsc-1898"><a href="#COMPsc-1898"><span class="linenos">1898</span></a>
</span><span id="COMPsc-1899"><a href="#COMPsc-1899"><span class="linenos">1899</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc-1900"><a href="#COMPsc-1900"><span class="linenos">1900</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-1901"><a href="#COMPsc-1901"><span class="linenos">1901</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc-1902"><a href="#COMPsc-1902"><span class="linenos">1902</span></a><span class="sd">            Figure containing the histogram of gene contents.</span>
</span><span id="COMPsc-1903"><a href="#COMPsc-1903"><span class="linenos">1903</span></a>
</span><span id="COMPsc-1904"><a href="#COMPsc-1904"><span class="linenos">1904</span></a><span class="sd">        Notes</span>
</span><span id="COMPsc-1905"><a href="#COMPsc-1905"><span class="linenos">1905</span></a><span class="sd">        -----</span>
</span><span id="COMPsc-1906"><a href="#COMPsc-1906"><span class="linenos">1906</span></a><span class="sd">        Requires `self.gene_calc` to be computed prior to calling.</span>
</span><span id="COMPsc-1907"><a href="#COMPsc-1907"><span class="linenos">1907</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-1908"><a href="#COMPsc-1908"><span class="linenos">1908</span></a>
</span><span id="COMPsc-1909"><a href="#COMPsc-1909"><span class="linenos">1909</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="COMPsc-1910"><a href="#COMPsc-1910"><span class="linenos">1910</span></a>
</span><span id="COMPsc-1911"><a href="#COMPsc-1911"><span class="linenos">1911</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
</span><span id="COMPsc-1912"><a href="#COMPsc-1912"><span class="linenos">1912</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span>
</span><span id="COMPsc-1913"><a href="#COMPsc-1913"><span class="linenos">1913</span></a>        <span class="p">)</span>
</span><span id="COMPsc-1914"><a href="#COMPsc-1914"><span class="linenos">1914</span></a>
</span><span id="COMPsc-1915"><a href="#COMPsc-1915"><span class="linenos">1915</span></a>        <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">)</span>
</span><span id="COMPsc-1916"><a href="#COMPsc-1916"><span class="linenos">1916</span></a>
</span><span id="COMPsc-1917"><a href="#COMPsc-1917"><span class="linenos">1917</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="COMPsc-1918"><a href="#COMPsc-1918"><span class="linenos">1918</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="COMPsc-1919"><a href="#COMPsc-1919"><span class="linenos">1919</span></a>
</span><span id="COMPsc-1920"><a href="#COMPsc-1920"><span class="linenos">1920</span></a>        <span class="n">y_scaled</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="COMPsc-1921"><a href="#COMPsc-1921"><span class="linenos">1921</span></a>
</span><span id="COMPsc-1922"><a href="#COMPsc-1922"><span class="linenos">1922</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="COMPsc-1923"><a href="#COMPsc-1923"><span class="linenos">1923</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y_scaled</span><span class="p">,</span> <span class="s2">&quot;r-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Normal(μ=</span><span class="si">{</span><span class="n">mu</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, σ=</span><span class="si">{</span><span class="n">sigma</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="COMPsc-1924"><a href="#COMPsc-1924"><span class="linenos">1924</span></a>        <span class="p">)</span>
</span><span id="COMPsc-1925"><a href="#COMPsc-1925"><span class="linenos">1925</span></a>
</span><span id="COMPsc-1926"><a href="#COMPsc-1926"><span class="linenos">1926</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1927"><a href="#COMPsc-1927"><span class="linenos">1927</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1928"><a href="#COMPsc-1928"><span class="linenos">1928</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Histogram of genes detected per cell&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1929"><a href="#COMPsc-1929"><span class="linenos">1929</span></a>
</span><span id="COMPsc-1930"><a href="#COMPsc-1930"><span class="linenos">1930</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">),</span> <span class="mi">20</span><span class="p">))</span>
</span><span id="COMPsc-1931"><a href="#COMPsc-1931"><span class="linenos">1931</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
</span><span id="COMPsc-1932"><a href="#COMPsc-1932"><span class="linenos">1932</span></a>
</span><span id="COMPsc-1933"><a href="#COMPsc-1933"><span class="linenos">1933</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="COMPsc-1934"><a href="#COMPsc-1934"><span class="linenos">1934</span></a>
</span><span id="COMPsc-1935"><a href="#COMPsc-1935"><span class="linenos">1935</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="COMPsc-1936"><a href="#COMPsc-1936"><span class="linenos">1936</span></a>
</span><span id="COMPsc-1937"><a href="#COMPsc-1937"><span class="linenos">1937</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gene_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">max_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="COMPsc-1938"><a href="#COMPsc-1938"><span class="linenos">1938</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-1939"><a href="#COMPsc-1939"><span class="linenos">1939</span></a><span class="sd">        Filter cells by gene-detection thresholds (min and/or max).</span>
</span><span id="COMPsc-1940"><a href="#COMPsc-1940"><span class="linenos">1940</span></a>
</span><span id="COMPsc-1941"><a href="#COMPsc-1941"><span class="linenos">1941</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-1942"><a href="#COMPsc-1942"><span class="linenos">1942</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-1943"><a href="#COMPsc-1943"><span class="linenos">1943</span></a><span class="sd">        min_n : int or None</span>
</span><span id="COMPsc-1944"><a href="#COMPsc-1944"><span class="linenos">1944</span></a><span class="sd">            Minimum number of detected genes required to keep a cell.</span>
</span><span id="COMPsc-1945"><a href="#COMPsc-1945"><span class="linenos">1945</span></a>
</span><span id="COMPsc-1946"><a href="#COMPsc-1946"><span class="linenos">1946</span></a><span class="sd">        max_n : int or None</span>
</span><span id="COMPsc-1947"><a href="#COMPsc-1947"><span class="linenos">1947</span></a><span class="sd">            Maximum number of detected genes allowed to keep a cell.</span>
</span><span id="COMPsc-1948"><a href="#COMPsc-1948"><span class="linenos">1948</span></a>
</span><span id="COMPsc-1949"><a href="#COMPsc-1949"><span class="linenos">1949</span></a><span class="sd">        Update</span>
</span><span id="COMPsc-1950"><a href="#COMPsc-1950"><span class="linenos">1950</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-1951"><a href="#COMPsc-1951"><span class="linenos">1951</span></a><span class="sd">        Filters `self.input_data`, `self.normalized_data`, `self.input_metadata`</span>
</span><span id="COMPsc-1952"><a href="#COMPsc-1952"><span class="linenos">1952</span></a><span class="sd">        (and calls `average()` if `self.agg_normalized_data` exists).</span>
</span><span id="COMPsc-1953"><a href="#COMPsc-1953"><span class="linenos">1953</span></a>
</span><span id="COMPsc-1954"><a href="#COMPsc-1954"><span class="linenos">1954</span></a><span class="sd">        Side Effects</span>
</span><span id="COMPsc-1955"><a href="#COMPsc-1955"><span class="linenos">1955</span></a><span class="sd">        ------------</span>
</span><span id="COMPsc-1956"><a href="#COMPsc-1956"><span class="linenos">1956</span></a><span class="sd">        Raises ValueError if both bounds are None or if filtering removes all cells.</span>
</span><span id="COMPsc-1957"><a href="#COMPsc-1957"><span class="linenos">1957</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-1958"><a href="#COMPsc-1958"><span class="linenos">1958</span></a>
</span><span id="COMPsc-1959"><a href="#COMPsc-1959"><span class="linenos">1959</span></a>        <span class="k">if</span> <span class="n">min_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1960"><a href="#COMPsc-1960"><span class="linenos">1960</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">&gt;</span> <span class="n">min_n</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">&lt;</span> <span class="n">max_n</span><span class="p">)</span>
</span><span id="COMPsc-1961"><a href="#COMPsc-1961"><span class="linenos">1961</span></a>        <span class="k">elif</span> <span class="n">min_n</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1962"><a href="#COMPsc-1962"><span class="linenos">1962</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">&lt;</span> <span class="n">max_n</span>
</span><span id="COMPsc-1963"><a href="#COMPsc-1963"><span class="linenos">1963</span></a>        <span class="k">elif</span> <span class="n">min_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1964"><a href="#COMPsc-1964"><span class="linenos">1964</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">&gt;</span> <span class="n">min_n</span>
</span><span id="COMPsc-1965"><a href="#COMPsc-1965"><span class="linenos">1965</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-1966"><a href="#COMPsc-1966"><span class="linenos">1966</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lack of both min_n and max_n values&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1967"><a href="#COMPsc-1967"><span class="linenos">1967</span></a>
</span><span id="COMPsc-1968"><a href="#COMPsc-1968"><span class="linenos">1968</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1969"><a href="#COMPsc-1969"><span class="linenos">1969</span></a>
</span><span id="COMPsc-1970"><a href="#COMPsc-1970"><span class="linenos">1970</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-1971"><a href="#COMPsc-1971"><span class="linenos">1971</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1972"><a href="#COMPsc-1972"><span class="linenos">1972</span></a>
</span><span id="COMPsc-1973"><a href="#COMPsc-1973"><span class="linenos">1973</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
</span><span id="COMPsc-1974"><a href="#COMPsc-1974"><span class="linenos">1974</span></a>
</span><span id="COMPsc-1975"><a href="#COMPsc-1975"><span class="linenos">1975</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1976"><a href="#COMPsc-1976"><span class="linenos">1976</span></a>
</span><span id="COMPsc-1977"><a href="#COMPsc-1977"><span class="linenos">1977</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-1978"><a href="#COMPsc-1978"><span class="linenos">1978</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1979"><a href="#COMPsc-1979"><span class="linenos">1979</span></a>
</span><span id="COMPsc-1980"><a href="#COMPsc-1980"><span class="linenos">1980</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
</span><span id="COMPsc-1981"><a href="#COMPsc-1981"><span class="linenos">1981</span></a>
</span><span id="COMPsc-1982"><a href="#COMPsc-1982"><span class="linenos">1982</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1983"><a href="#COMPsc-1983"><span class="linenos">1983</span></a>
</span><span id="COMPsc-1984"><a href="#COMPsc-1984"><span class="linenos">1984</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-1985"><a href="#COMPsc-1985"><span class="linenos">1985</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc-1986"><a href="#COMPsc-1986"><span class="linenos">1986</span></a>
</span><span id="COMPsc-1987"><a href="#COMPsc-1987"><span class="linenos">1987</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="COMPsc-1988"><a href="#COMPsc-1988"><span class="linenos">1988</span></a>                <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="COMPsc-1989"><a href="#COMPsc-1989"><span class="linenos">1989</span></a>            <span class="p">)</span>
</span><span id="COMPsc-1990"><a href="#COMPsc-1990"><span class="linenos">1990</span></a>
</span><span id="COMPsc-1991"><a href="#COMPsc-1991"><span class="linenos">1991</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="COMPsc-1992"><a href="#COMPsc-1992"><span class="linenos">1992</span></a>                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="COMPsc-1993"><a href="#COMPsc-1993"><span class="linenos">1993</span></a>            <span class="p">)</span>
</span><span id="COMPsc-1994"><a href="#COMPsc-1994"><span class="linenos">1994</span></a>
</span><span id="COMPsc-1995"><a href="#COMPsc-1995"><span class="linenos">1995</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-1996"><a href="#COMPsc-1996"><span class="linenos">1996</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
</span><span id="COMPsc-1997"><a href="#COMPsc-1997"><span class="linenos">1997</span></a>
</span><span id="COMPsc-1998"><a href="#COMPsc-1998"><span class="linenos">1998</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_calculation</span><span class="p">()</span>
</span><span id="COMPsc-1999"><a href="#COMPsc-1999"><span class="linenos">1999</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">()</span>
</span><span id="COMPsc-2000"><a href="#COMPsc-2000"><span class="linenos">2000</span></a>
</span><span id="COMPsc-2001"><a href="#COMPsc-2001"><span class="linenos">2001</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cells_calculation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_slot</span><span class="o">=</span><span class="s2">&quot;cell_names&quot;</span><span class="p">):</span>
</span><span id="COMPsc-2002"><a href="#COMPsc-2002"><span class="linenos">2002</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-2003"><a href="#COMPsc-2003"><span class="linenos">2003</span></a><span class="sd">        Calculate number of cells per  call name / cluster.</span>
</span><span id="COMPsc-2004"><a href="#COMPsc-2004"><span class="linenos">2004</span></a>
</span><span id="COMPsc-2005"><a href="#COMPsc-2005"><span class="linenos">2005</span></a><span class="sd">        The method computes a binary (presence/absence) per cell name / cluster and sums across</span>
</span><span id="COMPsc-2006"><a href="#COMPsc-2006"><span class="linenos">2006</span></a><span class="sd">        cells.</span>
</span><span id="COMPsc-2007"><a href="#COMPsc-2007"><span class="linenos">2007</span></a>
</span><span id="COMPsc-2008"><a href="#COMPsc-2008"><span class="linenos">2008</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-2009"><a href="#COMPsc-2009"><span class="linenos">2009</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-2010"><a href="#COMPsc-2010"><span class="linenos">2010</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="COMPsc-2011"><a href="#COMPsc-2011"><span class="linenos">2011</span></a><span class="sd">            Column in metadata to use as sample names.</span>
</span><span id="COMPsc-2012"><a href="#COMPsc-2012"><span class="linenos">2012</span></a>
</span><span id="COMPsc-2013"><a href="#COMPsc-2013"><span class="linenos">2013</span></a><span class="sd">        Update</span>
</span><span id="COMPsc-2014"><a href="#COMPsc-2014"><span class="linenos">2014</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-2015"><a href="#COMPsc-2015"><span class="linenos">2015</span></a><span class="sd">        Sets `self.cells_calc` as a pd.DataFrame.</span>
</span><span id="COMPsc-2016"><a href="#COMPsc-2016"><span class="linenos">2016</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-2017"><a href="#COMPsc-2017"><span class="linenos">2017</span></a>
</span><span id="COMPsc-2018"><a href="#COMPsc-2018"><span class="linenos">2018</span></a>        <span class="n">ls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">])</span>
</span><span id="COMPsc-2019"><a href="#COMPsc-2019"><span class="linenos">2019</span></a>
</span><span id="COMPsc-2020"><a href="#COMPsc-2020"><span class="linenos">2020</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="COMPsc-2021"><a href="#COMPsc-2021"><span class="linenos">2021</span></a>            <span class="p">{</span>
</span><span id="COMPsc-2022"><a href="#COMPsc-2022"><span class="linenos">2022</span></a>                <span class="s2">&quot;cluster&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
</span><span id="COMPsc-2023"><a href="#COMPsc-2023"><span class="linenos">2023</span></a>                <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
</span><span id="COMPsc-2024"><a href="#COMPsc-2024"><span class="linenos">2024</span></a>            <span class="p">}</span>
</span><span id="COMPsc-2025"><a href="#COMPsc-2025"><span class="linenos">2025</span></a>        <span class="p">)</span>
</span><span id="COMPsc-2026"><a href="#COMPsc-2026"><span class="linenos">2026</span></a>
</span><span id="COMPsc-2027"><a href="#COMPsc-2027"><span class="linenos">2027</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span> <span class="o">=</span> <span class="n">df</span>
</span><span id="COMPsc-2028"><a href="#COMPsc-2028"><span class="linenos">2028</span></a>
</span><span id="COMPsc-2029"><a href="#COMPsc-2029"><span class="linenos">2029</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cell_histograme</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">):</span>
</span><span id="COMPsc-2030"><a href="#COMPsc-2030"><span class="linenos">2030</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-2031"><a href="#COMPsc-2031"><span class="linenos">2031</span></a><span class="sd">        Plot a histogram of the number of cells detected per cell name (cluster).</span>
</span><span id="COMPsc-2032"><a href="#COMPsc-2032"><span class="linenos">2032</span></a>
</span><span id="COMPsc-2033"><a href="#COMPsc-2033"><span class="linenos">2033</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-2034"><a href="#COMPsc-2034"><span class="linenos">2034</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-2035"><a href="#COMPsc-2035"><span class="linenos">2035</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="COMPsc-2036"><a href="#COMPsc-2036"><span class="linenos">2036</span></a><span class="sd">            Column in metadata to use as sample names.</span>
</span><span id="COMPsc-2037"><a href="#COMPsc-2037"><span class="linenos">2037</span></a>
</span><span id="COMPsc-2038"><a href="#COMPsc-2038"><span class="linenos">2038</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc-2039"><a href="#COMPsc-2039"><span class="linenos">2039</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-2040"><a href="#COMPsc-2040"><span class="linenos">2040</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc-2041"><a href="#COMPsc-2041"><span class="linenos">2041</span></a><span class="sd">            Figure containing the histogram of cell contents.</span>
</span><span id="COMPsc-2042"><a href="#COMPsc-2042"><span class="linenos">2042</span></a>
</span><span id="COMPsc-2043"><a href="#COMPsc-2043"><span class="linenos">2043</span></a><span class="sd">        Notes</span>
</span><span id="COMPsc-2044"><a href="#COMPsc-2044"><span class="linenos">2044</span></a><span class="sd">        -----</span>
</span><span id="COMPsc-2045"><a href="#COMPsc-2045"><span class="linenos">2045</span></a><span class="sd">        Requires `self.cells_calc` to be computed prior to calling.</span>
</span><span id="COMPsc-2046"><a href="#COMPsc-2046"><span class="linenos">2046</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-2047"><a href="#COMPsc-2047"><span class="linenos">2047</span></a>
</span><span id="COMPsc-2048"><a href="#COMPsc-2048"><span class="linenos">2048</span></a>        <span class="k">if</span> <span class="n">name_slot</span> <span class="o">!=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">:</span>
</span><span id="COMPsc-2049"><a href="#COMPsc-2049"><span class="linenos">2049</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">(</span><span class="n">name_slot</span><span class="o">=</span><span class="n">name_slot</span><span class="p">)</span>
</span><span id="COMPsc-2050"><a href="#COMPsc-2050"><span class="linenos">2050</span></a>
</span><span id="COMPsc-2051"><a href="#COMPsc-2051"><span class="linenos">2051</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="COMPsc-2052"><a href="#COMPsc-2052"><span class="linenos">2052</span></a>
</span><span id="COMPsc-2053"><a href="#COMPsc-2053"><span class="linenos">2053</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
</span><span id="COMPsc-2054"><a href="#COMPsc-2054"><span class="linenos">2054</span></a>            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]),</span>
</span><span id="COMPsc-2055"><a href="#COMPsc-2055"><span class="linenos">2055</span></a>            <span class="n">bins</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">])),</span>
</span><span id="COMPsc-2056"><a href="#COMPsc-2056"><span class="linenos">2056</span></a>            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="COMPsc-2057"><a href="#COMPsc-2057"><span class="linenos">2057</span></a>            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
</span><span id="COMPsc-2058"><a href="#COMPsc-2058"><span class="linenos">2058</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
</span><span id="COMPsc-2059"><a href="#COMPsc-2059"><span class="linenos">2059</span></a>        <span class="p">)</span>
</span><span id="COMPsc-2060"><a href="#COMPsc-2060"><span class="linenos">2060</span></a>
</span><span id="COMPsc-2061"><a href="#COMPsc-2061"><span class="linenos">2061</span></a>        <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
</span><span id="COMPsc-2062"><a href="#COMPsc-2062"><span class="linenos">2062</span></a>            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])</span>
</span><span id="COMPsc-2063"><a href="#COMPsc-2063"><span class="linenos">2063</span></a>        <span class="p">)</span>
</span><span id="COMPsc-2064"><a href="#COMPsc-2064"><span class="linenos">2064</span></a>
</span><span id="COMPsc-2065"><a href="#COMPsc-2065"><span class="linenos">2065</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
</span><span id="COMPsc-2066"><a href="#COMPsc-2066"><span class="linenos">2066</span></a>            <span class="nb">min</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])),</span> <span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])),</span> <span class="mi">1000</span>
</span><span id="COMPsc-2067"><a href="#COMPsc-2067"><span class="linenos">2067</span></a>        <span class="p">)</span>
</span><span id="COMPsc-2068"><a href="#COMPsc-2068"><span class="linenos">2068</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="COMPsc-2069"><a href="#COMPsc-2069"><span class="linenos">2069</span></a>
</span><span id="COMPsc-2070"><a href="#COMPsc-2070"><span class="linenos">2070</span></a>        <span class="n">y_scaled</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]))</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="COMPsc-2071"><a href="#COMPsc-2071"><span class="linenos">2071</span></a>
</span><span id="COMPsc-2072"><a href="#COMPsc-2072"><span class="linenos">2072</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="COMPsc-2073"><a href="#COMPsc-2073"><span class="linenos">2073</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y_scaled</span><span class="p">,</span> <span class="s2">&quot;r-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Normal(μ=</span><span class="si">{</span><span class="n">mu</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, σ=</span><span class="si">{</span><span class="n">sigma</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="COMPsc-2074"><a href="#COMPsc-2074"><span class="linenos">2074</span></a>        <span class="p">)</span>
</span><span id="COMPsc-2075"><a href="#COMPsc-2075"><span class="linenos">2075</span></a>
</span><span id="COMPsc-2076"><a href="#COMPsc-2076"><span class="linenos">2076</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2077"><a href="#COMPsc-2077"><span class="linenos">2077</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2078"><a href="#COMPsc-2078"><span class="linenos">2078</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Histogram of cells detected per cell name / cluster&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2079"><a href="#COMPsc-2079"><span class="linenos">2079</span></a>
</span><span id="COMPsc-2080"><a href="#COMPsc-2080"><span class="linenos">2080</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span>
</span><span id="COMPsc-2081"><a href="#COMPsc-2081"><span class="linenos">2081</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
</span><span id="COMPsc-2082"><a href="#COMPsc-2082"><span class="linenos">2082</span></a>                <span class="nb">min</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])),</span> <span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])),</span> <span class="mi">20</span>
</span><span id="COMPsc-2083"><a href="#COMPsc-2083"><span class="linenos">2083</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2084"><a href="#COMPsc-2084"><span class="linenos">2084</span></a>        <span class="p">)</span>
</span><span id="COMPsc-2085"><a href="#COMPsc-2085"><span class="linenos">2085</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
</span><span id="COMPsc-2086"><a href="#COMPsc-2086"><span class="linenos">2086</span></a>
</span><span id="COMPsc-2087"><a href="#COMPsc-2087"><span class="linenos">2087</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="COMPsc-2088"><a href="#COMPsc-2088"><span class="linenos">2088</span></a>
</span><span id="COMPsc-2089"><a href="#COMPsc-2089"><span class="linenos">2089</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="COMPsc-2090"><a href="#COMPsc-2090"><span class="linenos">2090</span></a>
</span><span id="COMPsc-2091"><a href="#COMPsc-2091"><span class="linenos">2091</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cluster_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">):</span>
</span><span id="COMPsc-2092"><a href="#COMPsc-2092"><span class="linenos">2092</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-2093"><a href="#COMPsc-2093"><span class="linenos">2093</span></a><span class="sd">        Filter cell names / clusters by cell-detection threshold.</span>
</span><span id="COMPsc-2094"><a href="#COMPsc-2094"><span class="linenos">2094</span></a>
</span><span id="COMPsc-2095"><a href="#COMPsc-2095"><span class="linenos">2095</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-2096"><a href="#COMPsc-2096"><span class="linenos">2096</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-2097"><a href="#COMPsc-2097"><span class="linenos">2097</span></a><span class="sd">        min_n : int or None</span>
</span><span id="COMPsc-2098"><a href="#COMPsc-2098"><span class="linenos">2098</span></a><span class="sd">            Minimum number of detected genes required to keep a cell.</span>
</span><span id="COMPsc-2099"><a href="#COMPsc-2099"><span class="linenos">2099</span></a>
</span><span id="COMPsc-2100"><a href="#COMPsc-2100"><span class="linenos">2100</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="COMPsc-2101"><a href="#COMPsc-2101"><span class="linenos">2101</span></a><span class="sd">            Column in metadata to use as sample names.</span>
</span><span id="COMPsc-2102"><a href="#COMPsc-2102"><span class="linenos">2102</span></a>
</span><span id="COMPsc-2103"><a href="#COMPsc-2103"><span class="linenos">2103</span></a>
</span><span id="COMPsc-2104"><a href="#COMPsc-2104"><span class="linenos">2104</span></a><span class="sd">        Update</span>
</span><span id="COMPsc-2105"><a href="#COMPsc-2105"><span class="linenos">2105</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-2106"><a href="#COMPsc-2106"><span class="linenos">2106</span></a><span class="sd">        Filters `self.input_data`, `self.normalized_data`, `self.input_metadata`</span>
</span><span id="COMPsc-2107"><a href="#COMPsc-2107"><span class="linenos">2107</span></a><span class="sd">        (and calls `average()` if `self.agg_normalized_data` exists).</span>
</span><span id="COMPsc-2108"><a href="#COMPsc-2108"><span class="linenos">2108</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-2109"><a href="#COMPsc-2109"><span class="linenos">2109</span></a>
</span><span id="COMPsc-2110"><a href="#COMPsc-2110"><span class="linenos">2110</span></a>        <span class="k">if</span> <span class="n">name_slot</span> <span class="o">!=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">:</span>
</span><span id="COMPsc-2111"><a href="#COMPsc-2111"><span class="linenos">2111</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">(</span><span class="n">name_slot</span><span class="o">=</span><span class="n">name_slot</span><span class="p">)</span>
</span><span id="COMPsc-2112"><a href="#COMPsc-2112"><span class="linenos">2112</span></a>
</span><span id="COMPsc-2113"><a href="#COMPsc-2113"><span class="linenos">2113</span></a>        <span class="k">if</span> <span class="n">min_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-2114"><a href="#COMPsc-2114"><span class="linenos">2114</span></a>            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_n</span><span class="p">]</span>
</span><span id="COMPsc-2115"><a href="#COMPsc-2115"><span class="linenos">2115</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-2116"><a href="#COMPsc-2116"><span class="linenos">2116</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lack of min_n value&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2117"><a href="#COMPsc-2117"><span class="linenos">2117</span></a>
</span><span id="COMPsc-2118"><a href="#COMPsc-2118"><span class="linenos">2118</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-2119"><a href="#COMPsc-2119"><span class="linenos">2119</span></a>
</span><span id="COMPsc-2120"><a href="#COMPsc-2120"><span class="linenos">2120</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-2121"><a href="#COMPsc-2121"><span class="linenos">2121</span></a>
</span><span id="COMPsc-2122"><a href="#COMPsc-2122"><span class="linenos">2122</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-2123"><a href="#COMPsc-2123"><span class="linenos">2123</span></a>
</span><span id="COMPsc-2124"><a href="#COMPsc-2124"><span class="linenos">2124</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc-2125"><a href="#COMPsc-2125"><span class="linenos">2125</span></a>
</span><span id="COMPsc-2126"><a href="#COMPsc-2126"><span class="linenos">2126</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-2127"><a href="#COMPsc-2127"><span class="linenos">2127</span></a>
</span><span id="COMPsc-2128"><a href="#COMPsc-2128"><span class="linenos">2128</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="COMPsc-2129"><a href="#COMPsc-2129"><span class="linenos">2129</span></a>
</span><span id="COMPsc-2130"><a href="#COMPsc-2130"><span class="linenos">2130</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-2131"><a href="#COMPsc-2131"><span class="linenos">2131</span></a>
</span><span id="COMPsc-2132"><a href="#COMPsc-2132"><span class="linenos">2132</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-2133"><a href="#COMPsc-2133"><span class="linenos">2133</span></a>
</span><span id="COMPsc-2134"><a href="#COMPsc-2134"><span class="linenos">2134</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc-2135"><a href="#COMPsc-2135"><span class="linenos">2135</span></a>                    <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="COMPsc-2136"><a href="#COMPsc-2136"><span class="linenos">2136</span></a>                <span class="p">]</span>
</span><span id="COMPsc-2137"><a href="#COMPsc-2137"><span class="linenos">2137</span></a>
</span><span id="COMPsc-2138"><a href="#COMPsc-2138"><span class="linenos">2138</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-2139"><a href="#COMPsc-2139"><span class="linenos">2139</span></a>
</span><span id="COMPsc-2140"><a href="#COMPsc-2140"><span class="linenos">2140</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="COMPsc-2141"><a href="#COMPsc-2141"><span class="linenos">2141</span></a>
</span><span id="COMPsc-2142"><a href="#COMPsc-2142"><span class="linenos">2142</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-2143"><a href="#COMPsc-2143"><span class="linenos">2143</span></a>
</span><span id="COMPsc-2144"><a href="#COMPsc-2144"><span class="linenos">2144</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-2145"><a href="#COMPsc-2145"><span class="linenos">2145</span></a>
</span><span id="COMPsc-2146"><a href="#COMPsc-2146"><span class="linenos">2146</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc-2147"><a href="#COMPsc-2147"><span class="linenos">2147</span></a>                    <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2148"><a href="#COMPsc-2148"><span class="linenos">2148</span></a>                <span class="p">]</span>
</span><span id="COMPsc-2149"><a href="#COMPsc-2149"><span class="linenos">2149</span></a>
</span><span id="COMPsc-2150"><a href="#COMPsc-2150"><span class="linenos">2150</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-2151"><a href="#COMPsc-2151"><span class="linenos">2151</span></a>
</span><span id="COMPsc-2152"><a href="#COMPsc-2152"><span class="linenos">2152</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="COMPsc-2153"><a href="#COMPsc-2153"><span class="linenos">2153</span></a>                        <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="COMPsc-2154"><a href="#COMPsc-2154"><span class="linenos">2154</span></a>                    <span class="p">)</span>
</span><span id="COMPsc-2155"><a href="#COMPsc-2155"><span class="linenos">2155</span></a>
</span><span id="COMPsc-2156"><a href="#COMPsc-2156"><span class="linenos">2156</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="COMPsc-2157"><a href="#COMPsc-2157"><span class="linenos">2157</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="COMPsc-2158"><a href="#COMPsc-2158"><span class="linenos">2158</span></a>                <span class="p">)</span>
</span><span id="COMPsc-2159"><a href="#COMPsc-2159"><span class="linenos">2159</span></a>
</span><span id="COMPsc-2160"><a href="#COMPsc-2160"><span class="linenos">2160</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-2161"><a href="#COMPsc-2161"><span class="linenos">2161</span></a>
</span><span id="COMPsc-2162"><a href="#COMPsc-2162"><span class="linenos">2162</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-2163"><a href="#COMPsc-2163"><span class="linenos">2163</span></a>
</span><span id="COMPsc-2164"><a href="#COMPsc-2164"><span class="linenos">2164</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc-2165"><a href="#COMPsc-2165"><span class="linenos">2165</span></a>                    <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
</span><span id="COMPsc-2166"><a href="#COMPsc-2166"><span class="linenos">2166</span></a>                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="COMPsc-2167"><a href="#COMPsc-2167"><span class="linenos">2167</span></a>                <span class="p">]</span>
</span><span id="COMPsc-2168"><a href="#COMPsc-2168"><span class="linenos">2168</span></a>
</span><span id="COMPsc-2169"><a href="#COMPsc-2169"><span class="linenos">2169</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-2170"><a href="#COMPsc-2170"><span class="linenos">2170</span></a>
</span><span id="COMPsc-2171"><a href="#COMPsc-2171"><span class="linenos">2171</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="COMPsc-2172"><a href="#COMPsc-2172"><span class="linenos">2172</span></a>
</span><span id="COMPsc-2173"><a href="#COMPsc-2173"><span class="linenos">2173</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-2174"><a href="#COMPsc-2174"><span class="linenos">2174</span></a>
</span><span id="COMPsc-2175"><a href="#COMPsc-2175"><span class="linenos">2175</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-2176"><a href="#COMPsc-2176"><span class="linenos">2176</span></a>
</span><span id="COMPsc-2177"><a href="#COMPsc-2177"><span class="linenos">2177</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc-2178"><a href="#COMPsc-2178"><span class="linenos">2178</span></a>                    <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2179"><a href="#COMPsc-2179"><span class="linenos">2179</span></a>                <span class="p">]</span>
</span><span id="COMPsc-2180"><a href="#COMPsc-2180"><span class="linenos">2180</span></a>
</span><span id="COMPsc-2181"><a href="#COMPsc-2181"><span class="linenos">2181</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-2182"><a href="#COMPsc-2182"><span class="linenos">2182</span></a>
</span><span id="COMPsc-2183"><a href="#COMPsc-2183"><span class="linenos">2183</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="COMPsc-2184"><a href="#COMPsc-2184"><span class="linenos">2184</span></a>                        <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="COMPsc-2185"><a href="#COMPsc-2185"><span class="linenos">2185</span></a>                    <span class="p">)</span>
</span><span id="COMPsc-2186"><a href="#COMPsc-2186"><span class="linenos">2186</span></a>
</span><span id="COMPsc-2187"><a href="#COMPsc-2187"><span class="linenos">2187</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="COMPsc-2188"><a href="#COMPsc-2188"><span class="linenos">2188</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="COMPsc-2189"><a href="#COMPsc-2189"><span class="linenos">2189</span></a>                <span class="p">)</span>
</span><span id="COMPsc-2190"><a href="#COMPsc-2190"><span class="linenos">2190</span></a>
</span><span id="COMPsc-2191"><a href="#COMPsc-2191"><span class="linenos">2191</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gene_calculation</span><span class="p">()</span>
</span><span id="COMPsc-2192"><a href="#COMPsc-2192"><span class="linenos">2192</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">()</span>
</span><span id="COMPsc-2193"><a href="#COMPsc-2193"><span class="linenos">2193</span></a>
</span><span id="COMPsc-2194"><a href="#COMPsc-2194"><span class="linenos">2194</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_sparse_from_projects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalized_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="COMPsc-2195"><a href="#COMPsc-2195"><span class="linenos">2195</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-2196"><a href="#COMPsc-2196"><span class="linenos">2196</span></a><span class="sd">        Load sparse 10x-style datasets from stored project paths, concatenate them,</span>
</span><span id="COMPsc-2197"><a href="#COMPsc-2197"><span class="linenos">2197</span></a><span class="sd">        and populate `input_data` / `normalized_data` and `input_metadata`.</span>
</span><span id="COMPsc-2198"><a href="#COMPsc-2198"><span class="linenos">2198</span></a>
</span><span id="COMPsc-2199"><a href="#COMPsc-2199"><span class="linenos">2199</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-2200"><a href="#COMPsc-2200"><span class="linenos">2200</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-2201"><a href="#COMPsc-2201"><span class="linenos">2201</span></a><span class="sd">        normalized_data : bool, default False</span>
</span><span id="COMPsc-2202"><a href="#COMPsc-2202"><span class="linenos">2202</span></a><span class="sd">            If True, store concatenated tables in `self.normalized_data`.</span>
</span><span id="COMPsc-2203"><a href="#COMPsc-2203"><span class="linenos">2203</span></a><span class="sd">            If False, store them in `self.input_data` and normalization</span>
</span><span id="COMPsc-2204"><a href="#COMPsc-2204"><span class="linenos">2204</span></a><span class="sd">            is needed using normalize_data() method.</span>
</span><span id="COMPsc-2205"><a href="#COMPsc-2205"><span class="linenos">2205</span></a>
</span><span id="COMPsc-2206"><a href="#COMPsc-2206"><span class="linenos">2206</span></a><span class="sd">        Side Effects</span>
</span><span id="COMPsc-2207"><a href="#COMPsc-2207"><span class="linenos">2207</span></a><span class="sd">        ------------</span>
</span><span id="COMPsc-2208"><a href="#COMPsc-2208"><span class="linenos">2208</span></a><span class="sd">        - Reads each project using `load_sparse(...)` (expects matrix.mtx, genes.tsv, barcodes.tsv).</span>
</span><span id="COMPsc-2209"><a href="#COMPsc-2209"><span class="linenos">2209</span></a><span class="sd">        - Concatenates all projects column-wise and sets `self.input_metadata`.</span>
</span><span id="COMPsc-2210"><a href="#COMPsc-2210"><span class="linenos">2210</span></a><span class="sd">        - Replaces NaNs with zeros and updates `self.gene_calc`.</span>
</span><span id="COMPsc-2211"><a href="#COMPsc-2211"><span class="linenos">2211</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-2212"><a href="#COMPsc-2212"><span class="linenos">2212</span></a>
</span><span id="COMPsc-2213"><a href="#COMPsc-2213"><span class="linenos">2213</span></a>        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span>
</span><span id="COMPsc-2214"><a href="#COMPsc-2214"><span class="linenos">2214</span></a>
</span><span id="COMPsc-2215"><a href="#COMPsc-2215"><span class="linenos">2215</span></a>        <span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span><span id="COMPsc-2216"><a href="#COMPsc-2216"><span class="linenos">2216</span></a>        <span class="n">full_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span><span id="COMPsc-2217"><a href="#COMPsc-2217"><span class="linenos">2217</span></a>
</span><span id="COMPsc-2218"><a href="#COMPsc-2218"><span class="linenos">2218</span></a>        <span class="k">for</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="COMPsc-2219"><a href="#COMPsc-2219"><span class="linenos">2219</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
</span><span id="COMPsc-2220"><a href="#COMPsc-2220"><span class="linenos">2220</span></a>
</span><span id="COMPsc-2221"><a href="#COMPsc-2221"><span class="linenos">2221</span></a>            <span class="n">dt</span><span class="p">,</span> <span class="n">met</span> <span class="o">=</span> <span class="n">load_sparse</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">obj</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">ke</span><span class="p">)</span>
</span><span id="COMPsc-2222"><a href="#COMPsc-2222"><span class="linenos">2222</span></a>
</span><span id="COMPsc-2223"><a href="#COMPsc-2223"><span class="linenos">2223</span></a>            <span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">full_data</span><span class="p">,</span> <span class="n">dt</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc-2224"><a href="#COMPsc-2224"><span class="linenos">2224</span></a>            <span class="n">full_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">full_metadata</span><span class="p">,</span> <span class="n">met</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="COMPsc-2225"><a href="#COMPsc-2225"><span class="linenos">2225</span></a>
</span><span id="COMPsc-2226"><a href="#COMPsc-2226"><span class="linenos">2226</span></a>        <span class="n">full_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">full_data</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="COMPsc-2227"><a href="#COMPsc-2227"><span class="linenos">2227</span></a>
</span><span id="COMPsc-2228"><a href="#COMPsc-2228"><span class="linenos">2228</span></a>        <span class="k">if</span> <span class="n">normalized_data</span><span class="p">:</span>
</span><span id="COMPsc-2229"><a href="#COMPsc-2229"><span class="linenos">2229</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="n">full_data</span>
</span><span id="COMPsc-2230"><a href="#COMPsc-2230"><span class="linenos">2230</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="n">full_metadata</span>
</span><span id="COMPsc-2231"><a href="#COMPsc-2231"><span class="linenos">2231</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-2232"><a href="#COMPsc-2232"><span class="linenos">2232</span></a>
</span><span id="COMPsc-2233"><a href="#COMPsc-2233"><span class="linenos">2233</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="n">full_data</span>
</span><span id="COMPsc-2234"><a href="#COMPsc-2234"><span class="linenos">2234</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="n">full_metadata</span>
</span><span id="COMPsc-2235"><a href="#COMPsc-2235"><span class="linenos">2235</span></a>
</span><span id="COMPsc-2236"><a href="#COMPsc-2236"><span class="linenos">2236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_calculation</span><span class="p">()</span>
</span><span id="COMPsc-2237"><a href="#COMPsc-2237"><span class="linenos">2237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">()</span>
</span><span id="COMPsc-2238"><a href="#COMPsc-2238"><span class="linenos">2238</span></a>
</span><span id="COMPsc-2239"><a href="#COMPsc-2239"><span class="linenos">2239</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rename_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">):</span>
</span><span id="COMPsc-2240"><a href="#COMPsc-2240"><span class="linenos">2240</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-2241"><a href="#COMPsc-2241"><span class="linenos">2241</span></a><span class="sd">        Rename entries in `self.input_metadata[slot]` according to a provided mapping.</span>
</span><span id="COMPsc-2242"><a href="#COMPsc-2242"><span class="linenos">2242</span></a>
</span><span id="COMPsc-2243"><a href="#COMPsc-2243"><span class="linenos">2243</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-2244"><a href="#COMPsc-2244"><span class="linenos">2244</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-2245"><a href="#COMPsc-2245"><span class="linenos">2245</span></a><span class="sd">        mapping : dict</span>
</span><span id="COMPsc-2246"><a href="#COMPsc-2246"><span class="linenos">2246</span></a><span class="sd">            Dictionary with keys &#39;old_name&#39; and &#39;new_name&#39;, each mapping to a list</span>
</span><span id="COMPsc-2247"><a href="#COMPsc-2247"><span class="linenos">2247</span></a><span class="sd">            of equal length describing replacements.</span>
</span><span id="COMPsc-2248"><a href="#COMPsc-2248"><span class="linenos">2248</span></a>
</span><span id="COMPsc-2249"><a href="#COMPsc-2249"><span class="linenos">2249</span></a><span class="sd">        slot : str, default &#39;cell_names&#39;</span>
</span><span id="COMPsc-2250"><a href="#COMPsc-2250"><span class="linenos">2250</span></a><span class="sd">            Metadata column to operate on.</span>
</span><span id="COMPsc-2251"><a href="#COMPsc-2251"><span class="linenos">2251</span></a>
</span><span id="COMPsc-2252"><a href="#COMPsc-2252"><span class="linenos">2252</span></a><span class="sd">        Update</span>
</span><span id="COMPsc-2253"><a href="#COMPsc-2253"><span class="linenos">2253</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-2254"><a href="#COMPsc-2254"><span class="linenos">2254</span></a><span class="sd">        Updates `self.input_metadata[slot]` in-place with renamed values.</span>
</span><span id="COMPsc-2255"><a href="#COMPsc-2255"><span class="linenos">2255</span></a>
</span><span id="COMPsc-2256"><a href="#COMPsc-2256"><span class="linenos">2256</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc-2257"><a href="#COMPsc-2257"><span class="linenos">2257</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-2258"><a href="#COMPsc-2258"><span class="linenos">2258</span></a><span class="sd">        ValueError</span>
</span><span id="COMPsc-2259"><a href="#COMPsc-2259"><span class="linenos">2259</span></a><span class="sd">            If mapping keys are incorrect, lengths differ, or some &#39;old_name&#39; values</span>
</span><span id="COMPsc-2260"><a href="#COMPsc-2260"><span class="linenos">2260</span></a><span class="sd">            are not present in the metadata column.</span>
</span><span id="COMPsc-2261"><a href="#COMPsc-2261"><span class="linenos">2261</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-2262"><a href="#COMPsc-2262"><span class="linenos">2262</span></a>
</span><span id="COMPsc-2263"><a href="#COMPsc-2263"><span class="linenos">2263</span></a>        <span class="k">if</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;old_name&quot;</span><span class="p">,</span> <span class="s2">&quot;new_name&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="COMPsc-2264"><a href="#COMPsc-2264"><span class="linenos">2264</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc-2265"><a href="#COMPsc-2265"><span class="linenos">2265</span></a>                <span class="s2">&quot;Mapping dictionary must contain keys &#39;old_name&#39; and &#39;new_name&#39;, &quot;</span>
</span><span id="COMPsc-2266"><a href="#COMPsc-2266"><span class="linenos">2266</span></a>                <span class="s2">&quot;each with a list of names to change.&quot;</span>
</span><span id="COMPsc-2267"><a href="#COMPsc-2267"><span class="linenos">2267</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2268"><a href="#COMPsc-2268"><span class="linenos">2268</span></a>
</span><span id="COMPsc-2269"><a href="#COMPsc-2269"><span class="linenos">2269</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;old_name&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;new_name&quot;</span><span class="p">]):</span>
</span><span id="COMPsc-2270"><a href="#COMPsc-2270"><span class="linenos">2270</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc-2271"><a href="#COMPsc-2271"><span class="linenos">2271</span></a>                <span class="s2">&quot;Mapping dictionary lists &#39;old_name&#39; and &#39;new_name&#39; &quot;</span>
</span><span id="COMPsc-2272"><a href="#COMPsc-2272"><span class="linenos">2272</span></a>                <span class="s2">&quot;must have the same length!&quot;</span>
</span><span id="COMPsc-2273"><a href="#COMPsc-2273"><span class="linenos">2273</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2274"><a href="#COMPsc-2274"><span class="linenos">2274</span></a>
</span><span id="COMPsc-2275"><a href="#COMPsc-2275"><span class="linenos">2275</span></a>        <span class="n">names_vector</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span>
</span><span id="COMPsc-2276"><a href="#COMPsc-2276"><span class="linenos">2276</span></a>
</span><span id="COMPsc-2277"><a href="#COMPsc-2277"><span class="linenos">2277</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">elem</span> <span class="ow">in</span> <span class="n">names_vector</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;old_name&quot;</span><span class="p">])):</span>
</span><span id="COMPsc-2278"><a href="#COMPsc-2278"><span class="linenos">2278</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc-2279"><a href="#COMPsc-2279"><span class="linenos">2279</span></a>                <span class="sa">f</span><span class="s2">&quot;Some entries from &#39;old_name&#39; do not exist in the names of slot </span><span class="si">{</span><span class="n">slot</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="COMPsc-2280"><a href="#COMPsc-2280"><span class="linenos">2280</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2281"><a href="#COMPsc-2281"><span class="linenos">2281</span></a>
</span><span id="COMPsc-2282"><a href="#COMPsc-2282"><span class="linenos">2282</span></a>        <span class="n">replace_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;old_name&quot;</span><span class="p">],</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;new_name&quot;</span><span class="p">]))</span>
</span><span id="COMPsc-2283"><a href="#COMPsc-2283"><span class="linenos">2283</span></a>
</span><span id="COMPsc-2284"><a href="#COMPsc-2284"><span class="linenos">2284</span></a>        <span class="n">names_vector_ret</span> <span class="o">=</span> <span class="p">[</span><span class="n">replace_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">names_vector</span><span class="p">]</span>
</span><span id="COMPsc-2285"><a href="#COMPsc-2285"><span class="linenos">2285</span></a>
</span><span id="COMPsc-2286"><a href="#COMPsc-2286"><span class="linenos">2286</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">names_vector_ret</span>
</span><span id="COMPsc-2287"><a href="#COMPsc-2287"><span class="linenos">2287</span></a>
</span><span id="COMPsc-2288"><a href="#COMPsc-2288"><span class="linenos">2288</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rename_subclusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
</span><span id="COMPsc-2289"><a href="#COMPsc-2289"><span class="linenos">2289</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-2290"><a href="#COMPsc-2290"><span class="linenos">2290</span></a><span class="sd">        Rename labels stored in `self.subclusters_.subclusters` according to mapping.</span>
</span><span id="COMPsc-2291"><a href="#COMPsc-2291"><span class="linenos">2291</span></a>
</span><span id="COMPsc-2292"><a href="#COMPsc-2292"><span class="linenos">2292</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-2293"><a href="#COMPsc-2293"><span class="linenos">2293</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-2294"><a href="#COMPsc-2294"><span class="linenos">2294</span></a><span class="sd">        mapping : dict</span>
</span><span id="COMPsc-2295"><a href="#COMPsc-2295"><span class="linenos">2295</span></a><span class="sd">            Mapping with keys &#39;old_name&#39; and &#39;new_name&#39; (lists of equal length).</span>
</span><span id="COMPsc-2296"><a href="#COMPsc-2296"><span class="linenos">2296</span></a>
</span><span id="COMPsc-2297"><a href="#COMPsc-2297"><span class="linenos">2297</span></a><span class="sd">        Update</span>
</span><span id="COMPsc-2298"><a href="#COMPsc-2298"><span class="linenos">2298</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-2299"><a href="#COMPsc-2299"><span class="linenos">2299</span></a><span class="sd">        Updates `self.subclusters_.subclusters` with renamed labels.</span>
</span><span id="COMPsc-2300"><a href="#COMPsc-2300"><span class="linenos">2300</span></a>
</span><span id="COMPsc-2301"><a href="#COMPsc-2301"><span class="linenos">2301</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc-2302"><a href="#COMPsc-2302"><span class="linenos">2302</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-2303"><a href="#COMPsc-2303"><span class="linenos">2303</span></a><span class="sd">        ValueError</span>
</span><span id="COMPsc-2304"><a href="#COMPsc-2304"><span class="linenos">2304</span></a><span class="sd">            If mapping is invalid or old names are not present.</span>
</span><span id="COMPsc-2305"><a href="#COMPsc-2305"><span class="linenos">2305</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-2306"><a href="#COMPsc-2306"><span class="linenos">2306</span></a>
</span><span id="COMPsc-2307"><a href="#COMPsc-2307"><span class="linenos">2307</span></a>        <span class="k">if</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;old_name&quot;</span><span class="p">,</span> <span class="s2">&quot;new_name&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="COMPsc-2308"><a href="#COMPsc-2308"><span class="linenos">2308</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc-2309"><a href="#COMPsc-2309"><span class="linenos">2309</span></a>                <span class="s2">&quot;Mapping dictionary must contain keys &#39;old_name&#39; and &#39;new_name&#39;, &quot;</span>
</span><span id="COMPsc-2310"><a href="#COMPsc-2310"><span class="linenos">2310</span></a>                <span class="s2">&quot;each with a list of names to change.&quot;</span>
</span><span id="COMPsc-2311"><a href="#COMPsc-2311"><span class="linenos">2311</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2312"><a href="#COMPsc-2312"><span class="linenos">2312</span></a>
</span><span id="COMPsc-2313"><a href="#COMPsc-2313"><span class="linenos">2313</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;old_name&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;new_name&quot;</span><span class="p">]):</span>
</span><span id="COMPsc-2314"><a href="#COMPsc-2314"><span class="linenos">2314</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc-2315"><a href="#COMPsc-2315"><span class="linenos">2315</span></a>                <span class="s2">&quot;Mapping dictionary lists &#39;old_name&#39; and &#39;new_name&#39; &quot;</span>
</span><span id="COMPsc-2316"><a href="#COMPsc-2316"><span class="linenos">2316</span></a>                <span class="s2">&quot;must have the same length!&quot;</span>
</span><span id="COMPsc-2317"><a href="#COMPsc-2317"><span class="linenos">2317</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2318"><a href="#COMPsc-2318"><span class="linenos">2318</span></a>
</span><span id="COMPsc-2319"><a href="#COMPsc-2319"><span class="linenos">2319</span></a>        <span class="n">names_vector</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span><span class="p">)</span>
</span><span id="COMPsc-2320"><a href="#COMPsc-2320"><span class="linenos">2320</span></a>
</span><span id="COMPsc-2321"><a href="#COMPsc-2321"><span class="linenos">2321</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">elem</span> <span class="ow">in</span> <span class="n">names_vector</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;old_name&quot;</span><span class="p">])):</span>
</span><span id="COMPsc-2322"><a href="#COMPsc-2322"><span class="linenos">2322</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc-2323"><a href="#COMPsc-2323"><span class="linenos">2323</span></a>                <span class="s2">&quot;Some entries from &#39;old_name&#39; do not exist in the subcluster names.&quot;</span>
</span><span id="COMPsc-2324"><a href="#COMPsc-2324"><span class="linenos">2324</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2325"><a href="#COMPsc-2325"><span class="linenos">2325</span></a>
</span><span id="COMPsc-2326"><a href="#COMPsc-2326"><span class="linenos">2326</span></a>        <span class="n">replace_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;old_name&quot;</span><span class="p">],</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;new_name&quot;</span><span class="p">]))</span>
</span><span id="COMPsc-2327"><a href="#COMPsc-2327"><span class="linenos">2327</span></a>
</span><span id="COMPsc-2328"><a href="#COMPsc-2328"><span class="linenos">2328</span></a>        <span class="n">names_vector_ret</span> <span class="o">=</span> <span class="p">[</span><span class="n">replace_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">names_vector</span><span class="p">]</span>
</span><span id="COMPsc-2329"><a href="#COMPsc-2329"><span class="linenos">2329</span></a>
</span><span id="COMPsc-2330"><a href="#COMPsc-2330"><span class="linenos">2330</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span> <span class="o">=</span> <span class="n">names_vector_ret</span>
</span><span id="COMPsc-2331"><a href="#COMPsc-2331"><span class="linenos">2331</span></a>
</span><span id="COMPsc-2332"><a href="#COMPsc-2332"><span class="linenos">2332</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_sparse</span><span class="p">(</span>
</span><span id="COMPsc-2333"><a href="#COMPsc-2333"><span class="linenos">2333</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc-2334"><a href="#COMPsc-2334"><span class="linenos">2334</span></a>        <span class="n">path_to_save</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
</span><span id="COMPsc-2335"><a href="#COMPsc-2335"><span class="linenos">2335</span></a>        <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="COMPsc-2336"><a href="#COMPsc-2336"><span class="linenos">2336</span></a>        <span class="n">data_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;normalized&quot;</span><span class="p">,</span>
</span><span id="COMPsc-2337"><a href="#COMPsc-2337"><span class="linenos">2337</span></a>    <span class="p">):</span>
</span><span id="COMPsc-2338"><a href="#COMPsc-2338"><span class="linenos">2338</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-2339"><a href="#COMPsc-2339"><span class="linenos">2339</span></a><span class="sd">        Export data as 10x-compatible sparse files (matrix.mtx, barcodes.tsv, genes.tsv).</span>
</span><span id="COMPsc-2340"><a href="#COMPsc-2340"><span class="linenos">2340</span></a>
</span><span id="COMPsc-2341"><a href="#COMPsc-2341"><span class="linenos">2341</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-2342"><a href="#COMPsc-2342"><span class="linenos">2342</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-2343"><a href="#COMPsc-2343"><span class="linenos">2343</span></a><span class="sd">        path_to_save : str, default current working directory</span>
</span><span id="COMPsc-2344"><a href="#COMPsc-2344"><span class="linenos">2344</span></a><span class="sd">            Directory where files will be written.</span>
</span><span id="COMPsc-2345"><a href="#COMPsc-2345"><span class="linenos">2345</span></a>
</span><span id="COMPsc-2346"><a href="#COMPsc-2346"><span class="linenos">2346</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="COMPsc-2347"><a href="#COMPsc-2347"><span class="linenos">2347</span></a><span class="sd">            Metadata column providing cell names for barcodes.tsv.</span>
</span><span id="COMPsc-2348"><a href="#COMPsc-2348"><span class="linenos">2348</span></a>
</span><span id="COMPsc-2349"><a href="#COMPsc-2349"><span class="linenos">2349</span></a><span class="sd">        data_slot : str, default &#39;normalized&#39;</span>
</span><span id="COMPsc-2350"><a href="#COMPsc-2350"><span class="linenos">2350</span></a><span class="sd">            Either &#39;normalized&#39; (uses self.normalized_data) or &#39;count&#39; (uses self.input_data).</span>
</span><span id="COMPsc-2351"><a href="#COMPsc-2351"><span class="linenos">2351</span></a>
</span><span id="COMPsc-2352"><a href="#COMPsc-2352"><span class="linenos">2352</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc-2353"><a href="#COMPsc-2353"><span class="linenos">2353</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-2354"><a href="#COMPsc-2354"><span class="linenos">2354</span></a><span class="sd">        ValueError</span>
</span><span id="COMPsc-2355"><a href="#COMPsc-2355"><span class="linenos">2355</span></a><span class="sd">            If `data_slot` is not &#39;normalized&#39; or &#39;count&#39;.</span>
</span><span id="COMPsc-2356"><a href="#COMPsc-2356"><span class="linenos">2356</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-2357"><a href="#COMPsc-2357"><span class="linenos">2357</span></a>
</span><span id="COMPsc-2358"><a href="#COMPsc-2358"><span class="linenos">2358</span></a>        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc-2359"><a href="#COMPsc-2359"><span class="linenos">2359</span></a>
</span><span id="COMPsc-2360"><a href="#COMPsc-2360"><span class="linenos">2360</span></a>        <span class="k">if</span> <span class="n">data_slot</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;normalized&quot;</span><span class="p">:</span>
</span><span id="COMPsc-2361"><a href="#COMPsc-2361"><span class="linenos">2361</span></a>
</span><span id="COMPsc-2362"><a href="#COMPsc-2362"><span class="linenos">2362</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="COMPsc-2363"><a href="#COMPsc-2363"><span class="linenos">2363</span></a>            <span class="n">mtx</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="p">)</span>
</span><span id="COMPsc-2364"><a href="#COMPsc-2364"><span class="linenos">2364</span></a>
</span><span id="COMPsc-2365"><a href="#COMPsc-2365"><span class="linenos">2365</span></a>        <span class="k">elif</span> <span class="n">data_slot</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span>
</span><span id="COMPsc-2366"><a href="#COMPsc-2366"><span class="linenos">2366</span></a>
</span><span id="COMPsc-2367"><a href="#COMPsc-2367"><span class="linenos">2367</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="COMPsc-2368"><a href="#COMPsc-2368"><span class="linenos">2368</span></a>            <span class="n">mtx</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">)</span>
</span><span id="COMPsc-2369"><a href="#COMPsc-2369"><span class="linenos">2369</span></a>
</span><span id="COMPsc-2370"><a href="#COMPsc-2370"><span class="linenos">2370</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-2371"><a href="#COMPsc-2371"><span class="linenos">2371</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;data_slot&#39; must be included in &#39;normalized&#39; or &#39;count&#39;&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2372"><a href="#COMPsc-2372"><span class="linenos">2372</span></a>
</span><span id="COMPsc-2373"><a href="#COMPsc-2373"><span class="linenos">2373</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="COMPsc-2374"><a href="#COMPsc-2374"><span class="linenos">2374</span></a>
</span><span id="COMPsc-2375"><a href="#COMPsc-2375"><span class="linenos">2375</span></a>        <span class="n">mmwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s2">&quot;matrix.mtx&quot;</span><span class="p">),</span> <span class="n">mtx</span><span class="p">)</span>
</span><span id="COMPsc-2376"><a href="#COMPsc-2376"><span class="linenos">2376</span></a>
</span><span id="COMPsc-2377"><a href="#COMPsc-2377"><span class="linenos">2377</span></a>        <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">names</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
</span><span id="COMPsc-2378"><a href="#COMPsc-2378"><span class="linenos">2378</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s2">&quot;barcodes.tsv&quot;</span><span class="p">),</span>
</span><span id="COMPsc-2379"><a href="#COMPsc-2379"><span class="linenos">2379</span></a>            <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="COMPsc-2380"><a href="#COMPsc-2380"><span class="linenos">2380</span></a>            <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="COMPsc-2381"><a href="#COMPsc-2381"><span class="linenos">2381</span></a>            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="COMPsc-2382"><a href="#COMPsc-2382"><span class="linenos">2382</span></a>        <span class="p">)</span>
</span><span id="COMPsc-2383"><a href="#COMPsc-2383"><span class="linenos">2383</span></a>
</span><span id="COMPsc-2384"><a href="#COMPsc-2384"><span class="linenos">2384</span></a>        <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">features</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
</span><span id="COMPsc-2385"><a href="#COMPsc-2385"><span class="linenos">2385</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s2">&quot;genes.tsv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
</span><span id="COMPsc-2386"><a href="#COMPsc-2386"><span class="linenos">2386</span></a>        <span class="p">)</span>
</span><span id="COMPsc-2387"><a href="#COMPsc-2387"><span class="linenos">2387</span></a>
</span><span id="COMPsc-2388"><a href="#COMPsc-2388"><span class="linenos">2388</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">normalize_counts</span><span class="p">(</span>
</span><span id="COMPsc-2389"><a href="#COMPsc-2389"><span class="linenos">2389</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">normalize_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">log_transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="COMPsc-2390"><a href="#COMPsc-2390"><span class="linenos">2390</span></a>    <span class="p">):</span>
</span><span id="COMPsc-2391"><a href="#COMPsc-2391"><span class="linenos">2391</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-2392"><a href="#COMPsc-2392"><span class="linenos">2392</span></a><span class="sd">        Normalize raw counts to counts-per-(normalize_factor)</span>
</span><span id="COMPsc-2393"><a href="#COMPsc-2393"><span class="linenos">2393</span></a><span class="sd">        (e.g., CPM, TPM - depending on normalize_factor).</span>
</span><span id="COMPsc-2394"><a href="#COMPsc-2394"><span class="linenos">2394</span></a>
</span><span id="COMPsc-2395"><a href="#COMPsc-2395"><span class="linenos">2395</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-2396"><a href="#COMPsc-2396"><span class="linenos">2396</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-2397"><a href="#COMPsc-2397"><span class="linenos">2397</span></a><span class="sd">        normalize_factor : int, default 100000</span>
</span><span id="COMPsc-2398"><a href="#COMPsc-2398"><span class="linenos">2398</span></a><span class="sd">            Scaling factor used after dividing by column sums.</span>
</span><span id="COMPsc-2399"><a href="#COMPsc-2399"><span class="linenos">2399</span></a>
</span><span id="COMPsc-2400"><a href="#COMPsc-2400"><span class="linenos">2400</span></a><span class="sd">        log_transform : bool, default True</span>
</span><span id="COMPsc-2401"><a href="#COMPsc-2401"><span class="linenos">2401</span></a><span class="sd">            If True, apply log2(x+1) transformation to normalized values.</span>
</span><span id="COMPsc-2402"><a href="#COMPsc-2402"><span class="linenos">2402</span></a>
</span><span id="COMPsc-2403"><a href="#COMPsc-2403"><span class="linenos">2403</span></a><span class="sd">        Update</span>
</span><span id="COMPsc-2404"><a href="#COMPsc-2404"><span class="linenos">2404</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-2405"><a href="#COMPsc-2405"><span class="linenos">2405</span></a><span class="sd">            Sets `self.normalized_data` to normalized values (fills NaNs with 0).</span>
</span><span id="COMPsc-2406"><a href="#COMPsc-2406"><span class="linenos">2406</span></a>
</span><span id="COMPsc-2407"><a href="#COMPsc-2407"><span class="linenos">2407</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc-2408"><a href="#COMPsc-2408"><span class="linenos">2408</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-2409"><a href="#COMPsc-2409"><span class="linenos">2409</span></a><span class="sd">        ValueError</span>
</span><span id="COMPsc-2410"><a href="#COMPsc-2410"><span class="linenos">2410</span></a><span class="sd">            If `self.input_data` is missing (cannot normalize).</span>
</span><span id="COMPsc-2411"><a href="#COMPsc-2411"><span class="linenos">2411</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-2412"><a href="#COMPsc-2412"><span class="linenos">2412</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-2413"><a href="#COMPsc-2413"><span class="linenos">2413</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input data is missing, cannot normalize.&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2414"><a href="#COMPsc-2414"><span class="linenos">2414</span></a>
</span><span id="COMPsc-2415"><a href="#COMPsc-2415"><span class="linenos">2415</span></a>        <span class="n">sum_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="COMPsc-2416"><a href="#COMPsc-2416"><span class="linenos">2416</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">sum_col</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">normalize_factor</span>
</span><span id="COMPsc-2417"><a href="#COMPsc-2417"><span class="linenos">2417</span></a>
</span><span id="COMPsc-2418"><a href="#COMPsc-2418"><span class="linenos">2418</span></a>        <span class="k">if</span> <span class="n">log_transform</span><span class="p">:</span>
</span><span id="COMPsc-2419"><a href="#COMPsc-2419"><span class="linenos">2419</span></a>            <span class="c1"># log2(x + 1) to avoid -inf for zeros</span>
</span><span id="COMPsc-2420"><a href="#COMPsc-2420"><span class="linenos">2420</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc-2421"><a href="#COMPsc-2421"><span class="linenos">2421</span></a>
</span><span id="COMPsc-2422"><a href="#COMPsc-2422"><span class="linenos">2422</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">statistic</span><span class="p">(</span>
</span><span id="COMPsc-2423"><a href="#COMPsc-2423"><span class="linenos">2423</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc-2424"><a href="#COMPsc-2424"><span class="linenos">2424</span></a>        <span class="n">cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-2425"><a href="#COMPsc-2425"><span class="linenos">2425</span></a>        <span class="n">sets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-2426"><a href="#COMPsc-2426"><span class="linenos">2426</span></a>        <span class="n">min_exp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
</span><span id="COMPsc-2427"><a href="#COMPsc-2427"><span class="linenos">2427</span></a>        <span class="n">min_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="COMPsc-2428"><a href="#COMPsc-2428"><span class="linenos">2428</span></a>        <span class="n">n_proc</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="COMPsc-2429"><a href="#COMPsc-2429"><span class="linenos">2429</span></a>    <span class="p">):</span>
</span><span id="COMPsc-2430"><a href="#COMPsc-2430"><span class="linenos">2430</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-2431"><a href="#COMPsc-2431"><span class="linenos">2431</span></a><span class="sd">        Compute per-feature statistics (Mann–Whitney U) comparing target vs rest.</span>
</span><span id="COMPsc-2432"><a href="#COMPsc-2432"><span class="linenos">2432</span></a>
</span><span id="COMPsc-2433"><a href="#COMPsc-2433"><span class="linenos">2433</span></a><span class="sd">        This is a wrapper similar to `calc_DEG` tailored to use `self.normalized_data`</span>
</span><span id="COMPsc-2434"><a href="#COMPsc-2434"><span class="linenos">2434</span></a><span class="sd">        and `self.input_metadata`. It returns per-feature statistics including p-values,</span>
</span><span id="COMPsc-2435"><a href="#COMPsc-2435"><span class="linenos">2435</span></a><span class="sd">        adjusted p-values, means, variances, effect-size measures and fold-changes.</span>
</span><span id="COMPsc-2436"><a href="#COMPsc-2436"><span class="linenos">2436</span></a>
</span><span id="COMPsc-2437"><a href="#COMPsc-2437"><span class="linenos">2437</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-2438"><a href="#COMPsc-2438"><span class="linenos">2438</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-2439"><a href="#COMPsc-2439"><span class="linenos">2439</span></a><span class="sd">        cells : list, &#39;All&#39;, dict, or None</span>
</span><span id="COMPsc-2440"><a href="#COMPsc-2440"><span class="linenos">2440</span></a><span class="sd">            Defines the target cells or groups for comparison (several modes supported).</span>
</span><span id="COMPsc-2441"><a href="#COMPsc-2441"><span class="linenos">2441</span></a>
</span><span id="COMPsc-2442"><a href="#COMPsc-2442"><span class="linenos">2442</span></a><span class="sd">        sets : &#39;All&#39;, dict, or None</span>
</span><span id="COMPsc-2443"><a href="#COMPsc-2443"><span class="linenos">2443</span></a><span class="sd">            Alternative grouping mode (operate on `self.input_metadata[&#39;sets&#39;]`).</span>
</span><span id="COMPsc-2444"><a href="#COMPsc-2444"><span class="linenos">2444</span></a>
</span><span id="COMPsc-2445"><a href="#COMPsc-2445"><span class="linenos">2445</span></a><span class="sd">        min_exp : float, default 0.01</span>
</span><span id="COMPsc-2446"><a href="#COMPsc-2446"><span class="linenos">2446</span></a><span class="sd">            Minimum expression threshold used when filtering features.</span>
</span><span id="COMPsc-2447"><a href="#COMPsc-2447"><span class="linenos">2447</span></a>
</span><span id="COMPsc-2448"><a href="#COMPsc-2448"><span class="linenos">2448</span></a><span class="sd">        min_pct : float, default 0.1</span>
</span><span id="COMPsc-2449"><a href="#COMPsc-2449"><span class="linenos">2449</span></a><span class="sd">            Minimum proportion of expressing cells in the target group required to test a feature.</span>
</span><span id="COMPsc-2450"><a href="#COMPsc-2450"><span class="linenos">2450</span></a>
</span><span id="COMPsc-2451"><a href="#COMPsc-2451"><span class="linenos">2451</span></a><span class="sd">        n_proc : int, default 10</span>
</span><span id="COMPsc-2452"><a href="#COMPsc-2452"><span class="linenos">2452</span></a><span class="sd">            Number of parallel jobs to use.</span>
</span><span id="COMPsc-2453"><a href="#COMPsc-2453"><span class="linenos">2453</span></a>
</span><span id="COMPsc-2454"><a href="#COMPsc-2454"><span class="linenos">2454</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc-2455"><a href="#COMPsc-2455"><span class="linenos">2455</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-2456"><a href="#COMPsc-2456"><span class="linenos">2456</span></a><span class="sd">        pandas.DataFrame or dict</span>
</span><span id="COMPsc-2457"><a href="#COMPsc-2457"><span class="linenos">2457</span></a><span class="sd">            Results DataFrame (or dict containing valid/control cells + DataFrame),</span>
</span><span id="COMPsc-2458"><a href="#COMPsc-2458"><span class="linenos">2458</span></a><span class="sd">            similar to `calc_DEG` interface.</span>
</span><span id="COMPsc-2459"><a href="#COMPsc-2459"><span class="linenos">2459</span></a>
</span><span id="COMPsc-2460"><a href="#COMPsc-2460"><span class="linenos">2460</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc-2461"><a href="#COMPsc-2461"><span class="linenos">2461</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-2462"><a href="#COMPsc-2462"><span class="linenos">2462</span></a><span class="sd">        ValueError</span>
</span><span id="COMPsc-2463"><a href="#COMPsc-2463"><span class="linenos">2463</span></a><span class="sd">            If neither `cells` nor `sets` is provided, or input metadata mismatch occurs.</span>
</span><span id="COMPsc-2464"><a href="#COMPsc-2464"><span class="linenos">2464</span></a>
</span><span id="COMPsc-2465"><a href="#COMPsc-2465"><span class="linenos">2465</span></a><span class="sd">        Notes</span>
</span><span id="COMPsc-2466"><a href="#COMPsc-2466"><span class="linenos">2466</span></a><span class="sd">        -----</span>
</span><span id="COMPsc-2467"><a href="#COMPsc-2467"><span class="linenos">2467</span></a><span class="sd">        Multiple modes supported: single-list entities, &#39;All&#39;, pairwise dicts, etc.</span>
</span><span id="COMPsc-2468"><a href="#COMPsc-2468"><span class="linenos">2468</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-2469"><a href="#COMPsc-2469"><span class="linenos">2469</span></a>
</span><span id="COMPsc-2470"><a href="#COMPsc-2470"><span class="linenos">2470</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">stat_calc</span><span class="p">(</span><span class="n">choose</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">):</span>
</span><span id="COMPsc-2471"><a href="#COMPsc-2471"><span class="linenos">2471</span></a>            <span class="n">target_values</span> <span class="o">=</span> <span class="n">choose</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">]</span>
</span><span id="COMPsc-2472"><a href="#COMPsc-2472"><span class="linenos">2472</span></a>            <span class="n">rest_values</span> <span class="o">=</span> <span class="n">choose</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rest&quot;</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">]</span>
</span><span id="COMPsc-2473"><a href="#COMPsc-2473"><span class="linenos">2473</span></a>
</span><span id="COMPsc-2474"><a href="#COMPsc-2474"><span class="linenos">2474</span></a>            <span class="n">pct_valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_values</span><span class="p">)</span>
</span><span id="COMPsc-2475"><a href="#COMPsc-2475"><span class="linenos">2475</span></a>            <span class="n">pct_rest</span> <span class="o">=</span> <span class="p">(</span><span class="n">rest_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest_values</span><span class="p">)</span>
</span><span id="COMPsc-2476"><a href="#COMPsc-2476"><span class="linenos">2476</span></a>
</span><span id="COMPsc-2477"><a href="#COMPsc-2477"><span class="linenos">2477</span></a>            <span class="n">avg_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_values</span><span class="p">)</span>
</span><span id="COMPsc-2478"><a href="#COMPsc-2478"><span class="linenos">2478</span></a>            <span class="n">avg_ctrl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rest_values</span><span class="p">)</span>
</span><span id="COMPsc-2479"><a href="#COMPsc-2479"><span class="linenos">2479</span></a>            <span class="n">sd_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">target_values</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc-2480"><a href="#COMPsc-2480"><span class="linenos">2480</span></a>            <span class="n">sd_ctrl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">rest_values</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc-2481"><a href="#COMPsc-2481"><span class="linenos">2481</span></a>            <span class="n">esm</span> <span class="o">=</span> <span class="p">(</span><span class="n">avg_valid</span> <span class="o">-</span> <span class="n">avg_ctrl</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">sd_valid</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sd_ctrl</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="COMPsc-2482"><a href="#COMPsc-2482"><span class="linenos">2482</span></a>
</span><span id="COMPsc-2483"><a href="#COMPsc-2483"><span class="linenos">2483</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">target_values</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rest_values</span><span class="p">):</span>
</span><span id="COMPsc-2484"><a href="#COMPsc-2484"><span class="linenos">2484</span></a>                <span class="n">p_val</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="COMPsc-2485"><a href="#COMPsc-2485"><span class="linenos">2485</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-2486"><a href="#COMPsc-2486"><span class="linenos">2486</span></a>                <span class="n">_</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span>
</span><span id="COMPsc-2487"><a href="#COMPsc-2487"><span class="linenos">2487</span></a>                    <span class="n">target_values</span><span class="p">,</span> <span class="n">rest_values</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s2">&quot;two-sided&quot;</span>
</span><span id="COMPsc-2488"><a href="#COMPsc-2488"><span class="linenos">2488</span></a>                <span class="p">)</span>
</span><span id="COMPsc-2489"><a href="#COMPsc-2489"><span class="linenos">2489</span></a>
</span><span id="COMPsc-2490"><a href="#COMPsc-2490"><span class="linenos">2490</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="COMPsc-2491"><a href="#COMPsc-2491"><span class="linenos">2491</span></a>                <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="n">feature_name</span><span class="p">,</span>
</span><span id="COMPsc-2492"><a href="#COMPsc-2492"><span class="linenos">2492</span></a>                <span class="s2">&quot;p_val&quot;</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
</span><span id="COMPsc-2493"><a href="#COMPsc-2493"><span class="linenos">2493</span></a>                <span class="s2">&quot;pct_valid&quot;</span><span class="p">:</span> <span class="n">pct_valid</span><span class="p">,</span>
</span><span id="COMPsc-2494"><a href="#COMPsc-2494"><span class="linenos">2494</span></a>                <span class="s2">&quot;pct_ctrl&quot;</span><span class="p">:</span> <span class="n">pct_rest</span><span class="p">,</span>
</span><span id="COMPsc-2495"><a href="#COMPsc-2495"><span class="linenos">2495</span></a>                <span class="s2">&quot;avg_valid&quot;</span><span class="p">:</span> <span class="n">avg_valid</span><span class="p">,</span>
</span><span id="COMPsc-2496"><a href="#COMPsc-2496"><span class="linenos">2496</span></a>                <span class="s2">&quot;avg_ctrl&quot;</span><span class="p">:</span> <span class="n">avg_ctrl</span><span class="p">,</span>
</span><span id="COMPsc-2497"><a href="#COMPsc-2497"><span class="linenos">2497</span></a>                <span class="s2">&quot;sd_valid&quot;</span><span class="p">:</span> <span class="n">sd_valid</span><span class="p">,</span>
</span><span id="COMPsc-2498"><a href="#COMPsc-2498"><span class="linenos">2498</span></a>                <span class="s2">&quot;sd_ctrl&quot;</span><span class="p">:</span> <span class="n">sd_ctrl</span><span class="p">,</span>
</span><span id="COMPsc-2499"><a href="#COMPsc-2499"><span class="linenos">2499</span></a>                <span class="s2">&quot;esm&quot;</span><span class="p">:</span> <span class="n">esm</span><span class="p">,</span>
</span><span id="COMPsc-2500"><a href="#COMPsc-2500"><span class="linenos">2500</span></a>            <span class="p">}</span>
</span><span id="COMPsc-2501"><a href="#COMPsc-2501"><span class="linenos">2501</span></a>
</span><span id="COMPsc-2502"><a href="#COMPsc-2502"><span class="linenos">2502</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">prepare_and_run_stat</span><span class="p">(</span>
</span><span id="COMPsc-2503"><a href="#COMPsc-2503"><span class="linenos">2503</span></a>            <span class="n">choose</span><span class="p">,</span> <span class="n">valid_group</span><span class="p">,</span> <span class="n">min_exp</span><span class="p">,</span> <span class="n">min_pct</span><span class="p">,</span> <span class="n">n_proc</span><span class="p">,</span> <span class="n">factors</span>
</span><span id="COMPsc-2504"><a href="#COMPsc-2504"><span class="linenos">2504</span></a>        <span class="p">):</span>
</span><span id="COMPsc-2505"><a href="#COMPsc-2505"><span class="linenos">2505</span></a>
</span><span id="COMPsc-2506"><a href="#COMPsc-2506"><span class="linenos">2506</span></a>            <span class="n">tmp_dat</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2507"><a href="#COMPsc-2507"><span class="linenos">2507</span></a>            <span class="n">tmp_dat</span> <span class="o">=</span> <span class="n">tmp_dat</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;DEG&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc-2508"><a href="#COMPsc-2508"><span class="linenos">2508</span></a>
</span><span id="COMPsc-2509"><a href="#COMPsc-2509"><span class="linenos">2509</span></a>            <span class="n">counts</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp_dat</span> <span class="o">&gt;</span> <span class="n">min_exp</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="COMPsc-2510"><a href="#COMPsc-2510"><span class="linenos">2510</span></a>
</span><span id="COMPsc-2511"><a href="#COMPsc-2511"><span class="linenos">2511</span></a>            <span class="n">total_count</span> <span class="o">=</span> <span class="n">tmp_dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="COMPsc-2512"><a href="#COMPsc-2512"><span class="linenos">2512</span></a>
</span><span id="COMPsc-2513"><a href="#COMPsc-2513"><span class="linenos">2513</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="COMPsc-2514"><a href="#COMPsc-2514"><span class="linenos">2514</span></a>                <span class="p">{</span><span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmp_dat</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="s2">&quot;pct&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">counts</span> <span class="o">/</span> <span class="n">total_count</span><span class="p">)}</span>
</span><span id="COMPsc-2515"><a href="#COMPsc-2515"><span class="linenos">2515</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2516"><a href="#COMPsc-2516"><span class="linenos">2516</span></a>
</span><span id="COMPsc-2517"><a href="#COMPsc-2517"><span class="linenos">2517</span></a>            <span class="k">del</span> <span class="n">tmp_dat</span>
</span><span id="COMPsc-2518"><a href="#COMPsc-2518"><span class="linenos">2518</span></a>
</span><span id="COMPsc-2519"><a href="#COMPsc-2519"><span class="linenos">2519</span></a>            <span class="n">drop_col</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">][</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">min_pct</span><span class="p">]</span>
</span><span id="COMPsc-2520"><a href="#COMPsc-2520"><span class="linenos">2520</span></a>
</span><span id="COMPsc-2521"><a href="#COMPsc-2521"><span class="linenos">2521</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">drop_col</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
</span><span id="COMPsc-2522"><a href="#COMPsc-2522"><span class="linenos">2522</span></a>                <span class="n">drop_col</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">][</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="COMPsc-2523"><a href="#COMPsc-2523"><span class="linenos">2523</span></a>
</span><span id="COMPsc-2524"><a href="#COMPsc-2524"><span class="linenos">2524</span></a>            <span class="k">del</span> <span class="n">info</span>
</span><span id="COMPsc-2525"><a href="#COMPsc-2525"><span class="linenos">2525</span></a>
</span><span id="COMPsc-2526"><a href="#COMPsc-2526"><span class="linenos">2526</span></a>            <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">drop_col</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc-2527"><a href="#COMPsc-2527"><span class="linenos">2527</span></a>
</span><span id="COMPsc-2528"><a href="#COMPsc-2528"><span class="linenos">2528</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_proc</span><span class="p">)(</span>
</span><span id="COMPsc-2529"><a href="#COMPsc-2529"><span class="linenos">2529</span></a>                <span class="n">delayed</span><span class="p">(</span><span class="n">stat_calc</span><span class="p">)(</span><span class="n">choose</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>
</span><span id="COMPsc-2530"><a href="#COMPsc-2530"><span class="linenos">2530</span></a>                <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">choose</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="s2">&quot;DEG&quot;</span><span class="p">])</span>
</span><span id="COMPsc-2531"><a href="#COMPsc-2531"><span class="linenos">2531</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2532"><a href="#COMPsc-2532"><span class="linenos">2532</span></a>
</span><span id="COMPsc-2533"><a href="#COMPsc-2533"><span class="linenos">2533</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="COMPsc-2534"><a href="#COMPsc-2534"><span class="linenos">2534</span></a>            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_group</span>
</span><span id="COMPsc-2535"><a href="#COMPsc-2535"><span class="linenos">2535</span></a>            <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;p_val&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="COMPsc-2536"><a href="#COMPsc-2536"><span class="linenos">2536</span></a>
</span><span id="COMPsc-2537"><a href="#COMPsc-2537"><span class="linenos">2537</span></a>            <span class="n">num_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="COMPsc-2538"><a href="#COMPsc-2538"><span class="linenos">2538</span></a>            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;adj_pval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
</span><span id="COMPsc-2539"><a href="#COMPsc-2539"><span class="linenos">2539</span></a>                <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;p_val&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_tests</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_tests</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc-2540"><a href="#COMPsc-2540"><span class="linenos">2540</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2541"><a href="#COMPsc-2541"><span class="linenos">2541</span></a>
</span><span id="COMPsc-2542"><a href="#COMPsc-2542"><span class="linenos">2542</span></a>            <span class="n">factors_df</span> <span class="o">=</span> <span class="n">factors</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;factor&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2543"><a href="#COMPsc-2543"><span class="linenos">2543</span></a>
</span><span id="COMPsc-2544"><a href="#COMPsc-2544"><span class="linenos">2544</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">factors_df</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;feature&quot;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2545"><a href="#COMPsc-2545"><span class="linenos">2545</span></a>
</span><span id="COMPsc-2546"><a href="#COMPsc-2546"><span class="linenos">2546</span></a>            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;FC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;factor&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
</span><span id="COMPsc-2547"><a href="#COMPsc-2547"><span class="linenos">2547</span></a>                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;factor&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2548"><a href="#COMPsc-2548"><span class="linenos">2548</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2549"><a href="#COMPsc-2549"><span class="linenos">2549</span></a>            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;log(FC)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;FC&quot;</span><span class="p">])</span>
</span><span id="COMPsc-2550"><a href="#COMPsc-2550"><span class="linenos">2550</span></a>            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;norm_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2551"><a href="#COMPsc-2551"><span class="linenos">2551</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;factor&quot;</span><span class="p">])</span>
</span><span id="COMPsc-2552"><a href="#COMPsc-2552"><span class="linenos">2552</span></a>
</span><span id="COMPsc-2553"><a href="#COMPsc-2553"><span class="linenos">2553</span></a>            <span class="k">return</span> <span class="n">df</span>
</span><span id="COMPsc-2554"><a href="#COMPsc-2554"><span class="linenos">2554</span></a>
</span><span id="COMPsc-2555"><a href="#COMPsc-2555"><span class="linenos">2555</span></a>        <span class="n">choose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</span><span id="COMPsc-2556"><a href="#COMPsc-2556"><span class="linenos">2556</span></a>        <span class="n">factors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc-2557"><a href="#COMPsc-2557"><span class="linenos">2557</span></a>        <span class="n">factors</span><span class="p">[</span><span class="n">factors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">factors</span><span class="p">[</span><span class="n">factors</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="COMPsc-2558"><a href="#COMPsc-2558"><span class="linenos">2558</span></a>
</span><span id="COMPsc-2559"><a href="#COMPsc-2559"><span class="linenos">2559</span></a>        <span class="n">final_results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc-2560"><a href="#COMPsc-2560"><span class="linenos">2560</span></a>
</span><span id="COMPsc-2561"><a href="#COMPsc-2561"><span class="linenos">2561</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cells</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-2562"><a href="#COMPsc-2562"><span class="linenos">2562</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis started...</span><span class="se">\n</span><span class="s2">Comparing selected cells to the whole set...&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2563"><a href="#COMPsc-2563"><span class="linenos">2563</span></a>            <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc-2564"><a href="#COMPsc-2564"><span class="linenos">2564</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2565"><a href="#COMPsc-2565"><span class="linenos">2565</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2566"><a href="#COMPsc-2566"><span class="linenos">2566</span></a>
</span><span id="COMPsc-2567"><a href="#COMPsc-2567"><span class="linenos">2567</span></a>            <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="COMPsc-2568"><a href="#COMPsc-2568"><span class="linenos">2568</span></a>                <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2569"><a href="#COMPsc-2569"><span class="linenos">2569</span></a>
</span><span id="COMPsc-2570"><a href="#COMPsc-2570"><span class="linenos">2570</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="COMPsc-2571"><a href="#COMPsc-2571"><span class="linenos">2571</span></a>                    <span class="s2">&quot;Not include the set info (name # set) in the &#39;cells&#39; list. &quot;</span>
</span><span id="COMPsc-2572"><a href="#COMPsc-2572"><span class="linenos">2572</span></a>                    <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="COMPsc-2573"><a href="#COMPsc-2573"><span class="linenos">2573</span></a>                <span class="p">)</span>
</span><span id="COMPsc-2574"><a href="#COMPsc-2574"><span class="linenos">2574</span></a>
</span><span id="COMPsc-2575"><a href="#COMPsc-2575"><span class="linenos">2575</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;target&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">cells</span> <span class="k">else</span> <span class="s2">&quot;rest&quot;</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="COMPsc-2576"><a href="#COMPsc-2576"><span class="linenos">2576</span></a>            <span class="n">valid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="COMPsc-2577"><a href="#COMPsc-2577"><span class="linenos">2577</span></a>                <span class="nb">set</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">]])</span>
</span><span id="COMPsc-2578"><a href="#COMPsc-2578"><span class="linenos">2578</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2579"><a href="#COMPsc-2579"><span class="linenos">2579</span></a>
</span><span id="COMPsc-2580"><a href="#COMPsc-2580"><span class="linenos">2580</span></a>            <span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span id="COMPsc-2581"><a href="#COMPsc-2581"><span class="linenos">2581</span></a>            <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2582"><a href="#COMPsc-2582"><span class="linenos">2582</span></a>
</span><span id="COMPsc-2583"><a href="#COMPsc-2583"><span class="linenos">2583</span></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="n">prepare_and_run_stat</span><span class="p">(</span>
</span><span id="COMPsc-2584"><a href="#COMPsc-2584"><span class="linenos">2584</span></a>                <span class="n">choose</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="COMPsc-2585"><a href="#COMPsc-2585"><span class="linenos">2585</span></a>                <span class="n">valid_group</span><span class="o">=</span><span class="n">valid</span><span class="p">,</span>
</span><span id="COMPsc-2586"><a href="#COMPsc-2586"><span class="linenos">2586</span></a>                <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span>
</span><span id="COMPsc-2587"><a href="#COMPsc-2587"><span class="linenos">2587</span></a>                <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span>
</span><span id="COMPsc-2588"><a href="#COMPsc-2588"><span class="linenos">2588</span></a>                <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span>
</span><span id="COMPsc-2589"><a href="#COMPsc-2589"><span class="linenos">2589</span></a>                <span class="n">factors</span><span class="o">=</span><span class="n">factors</span><span class="p">,</span>
</span><span id="COMPsc-2590"><a href="#COMPsc-2590"><span class="linenos">2590</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2591"><a href="#COMPsc-2591"><span class="linenos">2591</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;valid_cells&quot;</span><span class="p">:</span> <span class="n">valid</span><span class="p">,</span> <span class="s2">&quot;control_cells&quot;</span><span class="p">:</span> <span class="s2">&quot;rest&quot;</span><span class="p">,</span> <span class="s2">&quot;DEG&quot;</span><span class="p">:</span> <span class="n">result_df</span><span class="p">}</span>
</span><span id="COMPsc-2592"><a href="#COMPsc-2592"><span class="linenos">2592</span></a>
</span><span id="COMPsc-2593"><a href="#COMPsc-2593"><span class="linenos">2593</span></a>        <span class="k">elif</span> <span class="n">cells</span> <span class="o">==</span> <span class="s2">&quot;All&quot;</span> <span class="ow">and</span> <span class="n">sets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-2594"><a href="#COMPsc-2594"><span class="linenos">2594</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis started...</span><span class="se">\n</span><span class="s2">Comparing each type of cell to others...&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2595"><a href="#COMPsc-2595"><span class="linenos">2595</span></a>            <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc-2596"><a href="#COMPsc-2596"><span class="linenos">2596</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2597"><a href="#COMPsc-2597"><span class="linenos">2597</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2598"><a href="#COMPsc-2598"><span class="linenos">2598</span></a>            <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="COMPsc-2599"><a href="#COMPsc-2599"><span class="linenos">2599</span></a>
</span><span id="COMPsc-2600"><a href="#COMPsc-2600"><span class="linenos">2600</span></a>            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">):</span>
</span><span id="COMPsc-2601"><a href="#COMPsc-2601"><span class="linenos">2601</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calculating statistics for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2602"><a href="#COMPsc-2602"><span class="linenos">2602</span></a>                <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;target&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">label</span> <span class="k">else</span> <span class="s2">&quot;rest&quot;</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="COMPsc-2603"><a href="#COMPsc-2603"><span class="linenos">2603</span></a>                <span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span id="COMPsc-2604"><a href="#COMPsc-2604"><span class="linenos">2604</span></a>                <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2605"><a href="#COMPsc-2605"><span class="linenos">2605</span></a>                <span class="n">result_df</span> <span class="o">=</span> <span class="n">prepare_and_run_stat</span><span class="p">(</span>
</span><span id="COMPsc-2606"><a href="#COMPsc-2606"><span class="linenos">2606</span></a>                    <span class="n">choose</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
</span><span id="COMPsc-2607"><a href="#COMPsc-2607"><span class="linenos">2607</span></a>                    <span class="n">valid_group</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
</span><span id="COMPsc-2608"><a href="#COMPsc-2608"><span class="linenos">2608</span></a>                    <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span>
</span><span id="COMPsc-2609"><a href="#COMPsc-2609"><span class="linenos">2609</span></a>                    <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span>
</span><span id="COMPsc-2610"><a href="#COMPsc-2610"><span class="linenos">2610</span></a>                    <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span>
</span><span id="COMPsc-2611"><a href="#COMPsc-2611"><span class="linenos">2611</span></a>                    <span class="n">factors</span><span class="o">=</span><span class="n">factors</span><span class="p">,</span>
</span><span id="COMPsc-2612"><a href="#COMPsc-2612"><span class="linenos">2612</span></a>                <span class="p">)</span>
</span><span id="COMPsc-2613"><a href="#COMPsc-2613"><span class="linenos">2613</span></a>                <span class="n">final_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_df</span><span class="p">)</span>
</span><span id="COMPsc-2614"><a href="#COMPsc-2614"><span class="linenos">2614</span></a>
</span><span id="COMPsc-2615"><a href="#COMPsc-2615"><span class="linenos">2615</span></a>            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">final_results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="COMPsc-2616"><a href="#COMPsc-2616"><span class="linenos">2616</span></a>
</span><span id="COMPsc-2617"><a href="#COMPsc-2617"><span class="linenos">2617</span></a>        <span class="k">elif</span> <span class="n">cells</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sets</span> <span class="o">==</span> <span class="s2">&quot;All&quot;</span><span class="p">:</span>
</span><span id="COMPsc-2618"><a href="#COMPsc-2618"><span class="linenos">2618</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis started...</span><span class="se">\n</span><span class="s2">Comparing each set/group to others...&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2619"><a href="#COMPsc-2619"><span class="linenos">2619</span></a>            <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2620"><a href="#COMPsc-2620"><span class="linenos">2620</span></a>            <span class="n">unique_sets</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="COMPsc-2621"><a href="#COMPsc-2621"><span class="linenos">2621</span></a>
</span><span id="COMPsc-2622"><a href="#COMPsc-2622"><span class="linenos">2622</span></a>            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">unique_sets</span><span class="p">):</span>
</span><span id="COMPsc-2623"><a href="#COMPsc-2623"><span class="linenos">2623</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calculating statistics for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2624"><a href="#COMPsc-2624"><span class="linenos">2624</span></a>                <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;target&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">label</span> <span class="k">else</span> <span class="s2">&quot;rest&quot;</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="COMPsc-2625"><a href="#COMPsc-2625"><span class="linenos">2625</span></a>
</span><span id="COMPsc-2626"><a href="#COMPsc-2626"><span class="linenos">2626</span></a>                <span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span id="COMPsc-2627"><a href="#COMPsc-2627"><span class="linenos">2627</span></a>                <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2628"><a href="#COMPsc-2628"><span class="linenos">2628</span></a>                <span class="n">result_df</span> <span class="o">=</span> <span class="n">prepare_and_run_stat</span><span class="p">(</span>
</span><span id="COMPsc-2629"><a href="#COMPsc-2629"><span class="linenos">2629</span></a>                    <span class="n">choose</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
</span><span id="COMPsc-2630"><a href="#COMPsc-2630"><span class="linenos">2630</span></a>                    <span class="n">valid_group</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
</span><span id="COMPsc-2631"><a href="#COMPsc-2631"><span class="linenos">2631</span></a>                    <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span>
</span><span id="COMPsc-2632"><a href="#COMPsc-2632"><span class="linenos">2632</span></a>                    <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span>
</span><span id="COMPsc-2633"><a href="#COMPsc-2633"><span class="linenos">2633</span></a>                    <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span>
</span><span id="COMPsc-2634"><a href="#COMPsc-2634"><span class="linenos">2634</span></a>                    <span class="n">factors</span><span class="o">=</span><span class="n">factors</span><span class="p">,</span>
</span><span id="COMPsc-2635"><a href="#COMPsc-2635"><span class="linenos">2635</span></a>                <span class="p">)</span>
</span><span id="COMPsc-2636"><a href="#COMPsc-2636"><span class="linenos">2636</span></a>                <span class="n">final_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_df</span><span class="p">)</span>
</span><span id="COMPsc-2637"><a href="#COMPsc-2637"><span class="linenos">2637</span></a>
</span><span id="COMPsc-2638"><a href="#COMPsc-2638"><span class="linenos">2638</span></a>            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">final_results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="COMPsc-2639"><a href="#COMPsc-2639"><span class="linenos">2639</span></a>
</span><span id="COMPsc-2640"><a href="#COMPsc-2640"><span class="linenos">2640</span></a>        <span class="k">elif</span> <span class="n">cells</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sets</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="COMPsc-2641"><a href="#COMPsc-2641"><span class="linenos">2641</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis started...</span><span class="se">\n</span><span class="s2">Comparing groups...&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2642"><a href="#COMPsc-2642"><span class="linenos">2642</span></a>
</span><span id="COMPsc-2643"><a href="#COMPsc-2643"><span class="linenos">2643</span></a>            <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2644"><a href="#COMPsc-2644"><span class="linenos">2644</span></a>
</span><span id="COMPsc-2645"><a href="#COMPsc-2645"><span class="linenos">2645</span></a>            <span class="n">group_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="COMPsc-2646"><a href="#COMPsc-2646"><span class="linenos">2646</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="COMPsc-2647"><a href="#COMPsc-2647"><span class="linenos">2647</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only pairwise group comparison is supported.&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2648"><a href="#COMPsc-2648"><span class="linenos">2648</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="COMPsc-2649"><a href="#COMPsc-2649"><span class="linenos">2649</span></a>
</span><span id="COMPsc-2650"><a href="#COMPsc-2650"><span class="linenos">2650</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc-2651"><a href="#COMPsc-2651"><span class="linenos">2651</span></a>                <span class="p">(</span>
</span><span id="COMPsc-2652"><a href="#COMPsc-2652"><span class="linenos">2652</span></a>                    <span class="s2">&quot;target&quot;</span>
</span><span id="COMPsc-2653"><a href="#COMPsc-2653"><span class="linenos">2653</span></a>                    <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">[</span><span class="n">group_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="COMPsc-2654"><a href="#COMPsc-2654"><span class="linenos">2654</span></a>                    <span class="k">else</span> <span class="s2">&quot;rest&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">[</span><span class="n">group_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">else</span> <span class="s2">&quot;drop&quot;</span>
</span><span id="COMPsc-2655"><a href="#COMPsc-2655"><span class="linenos">2655</span></a>                <span class="p">)</span>
</span><span id="COMPsc-2656"><a href="#COMPsc-2656"><span class="linenos">2656</span></a>                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">choose</span><span class="o">.</span><span class="n">index</span>
</span><span id="COMPsc-2657"><a href="#COMPsc-2657"><span class="linenos">2657</span></a>            <span class="p">]</span>
</span><span id="COMPsc-2658"><a href="#COMPsc-2658"><span class="linenos">2658</span></a>            <span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span id="COMPsc-2659"><a href="#COMPsc-2659"><span class="linenos">2659</span></a>            <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2660"><a href="#COMPsc-2660"><span class="linenos">2660</span></a>
</span><span id="COMPsc-2661"><a href="#COMPsc-2661"><span class="linenos">2661</span></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="n">prepare_and_run_stat</span><span class="p">(</span>
</span><span id="COMPsc-2662"><a href="#COMPsc-2662"><span class="linenos">2662</span></a>                <span class="n">choose</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="COMPsc-2663"><a href="#COMPsc-2663"><span class="linenos">2663</span></a>                <span class="n">valid_group</span><span class="o">=</span><span class="n">group_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="COMPsc-2664"><a href="#COMPsc-2664"><span class="linenos">2664</span></a>                <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span>
</span><span id="COMPsc-2665"><a href="#COMPsc-2665"><span class="linenos">2665</span></a>                <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span>
</span><span id="COMPsc-2666"><a href="#COMPsc-2666"><span class="linenos">2666</span></a>                <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span>
</span><span id="COMPsc-2667"><a href="#COMPsc-2667"><span class="linenos">2667</span></a>                <span class="n">factors</span><span class="o">=</span><span class="n">factors</span><span class="p">,</span>
</span><span id="COMPsc-2668"><a href="#COMPsc-2668"><span class="linenos">2668</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2669"><a href="#COMPsc-2669"><span class="linenos">2669</span></a>            <span class="k">return</span> <span class="n">result_df</span>
</span><span id="COMPsc-2670"><a href="#COMPsc-2670"><span class="linenos">2670</span></a>
</span><span id="COMPsc-2671"><a href="#COMPsc-2671"><span class="linenos">2671</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cells</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-2672"><a href="#COMPsc-2672"><span class="linenos">2672</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis started...</span><span class="se">\n</span><span class="s2">Comparing groups...&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2673"><a href="#COMPsc-2673"><span class="linenos">2673</span></a>            <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc-2674"><a href="#COMPsc-2674"><span class="linenos">2674</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2675"><a href="#COMPsc-2675"><span class="linenos">2675</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2676"><a href="#COMPsc-2676"><span class="linenos">2676</span></a>
</span><span id="COMPsc-2677"><a href="#COMPsc-2677"><span class="linenos">2677</span></a>            <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">cells</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="COMPsc-2678"><a href="#COMPsc-2678"><span class="linenos">2678</span></a>                <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2679"><a href="#COMPsc-2679"><span class="linenos">2679</span></a>
</span><span id="COMPsc-2680"><a href="#COMPsc-2680"><span class="linenos">2680</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="COMPsc-2681"><a href="#COMPsc-2681"><span class="linenos">2681</span></a>                    <span class="s2">&quot;Not include the set info (name # set) in the &#39;cells&#39; dict. &quot;</span>
</span><span id="COMPsc-2682"><a href="#COMPsc-2682"><span class="linenos">2682</span></a>                    <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="COMPsc-2683"><a href="#COMPsc-2683"><span class="linenos">2683</span></a>                <span class="p">)</span>
</span><span id="COMPsc-2684"><a href="#COMPsc-2684"><span class="linenos">2684</span></a>
</span><span id="COMPsc-2685"><a href="#COMPsc-2685"><span class="linenos">2685</span></a>            <span class="n">group_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cells</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="COMPsc-2686"><a href="#COMPsc-2686"><span class="linenos">2686</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="COMPsc-2687"><a href="#COMPsc-2687"><span class="linenos">2687</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only pairwise group comparison is supported.&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2688"><a href="#COMPsc-2688"><span class="linenos">2688</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="COMPsc-2689"><a href="#COMPsc-2689"><span class="linenos">2689</span></a>
</span><span id="COMPsc-2690"><a href="#COMPsc-2690"><span class="linenos">2690</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc-2691"><a href="#COMPsc-2691"><span class="linenos">2691</span></a>                <span class="p">(</span>
</span><span id="COMPsc-2692"><a href="#COMPsc-2692"><span class="linenos">2692</span></a>                    <span class="s2">&quot;target&quot;</span>
</span><span id="COMPsc-2693"><a href="#COMPsc-2693"><span class="linenos">2693</span></a>                    <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">[</span><span class="n">group_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="COMPsc-2694"><a href="#COMPsc-2694"><span class="linenos">2694</span></a>                    <span class="k">else</span> <span class="s2">&quot;rest&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">[</span><span class="n">group_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">else</span> <span class="s2">&quot;drop&quot;</span>
</span><span id="COMPsc-2695"><a href="#COMPsc-2695"><span class="linenos">2695</span></a>                <span class="p">)</span>
</span><span id="COMPsc-2696"><a href="#COMPsc-2696"><span class="linenos">2696</span></a>                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">choose</span><span class="o">.</span><span class="n">index</span>
</span><span id="COMPsc-2697"><a href="#COMPsc-2697"><span class="linenos">2697</span></a>            <span class="p">]</span>
</span><span id="COMPsc-2698"><a href="#COMPsc-2698"><span class="linenos">2698</span></a>
</span><span id="COMPsc-2699"><a href="#COMPsc-2699"><span class="linenos">2699</span></a>            <span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span id="COMPsc-2700"><a href="#COMPsc-2700"><span class="linenos">2700</span></a>            <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2701"><a href="#COMPsc-2701"><span class="linenos">2701</span></a>
</span><span id="COMPsc-2702"><a href="#COMPsc-2702"><span class="linenos">2702</span></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="n">prepare_and_run_stat</span><span class="p">(</span>
</span><span id="COMPsc-2703"><a href="#COMPsc-2703"><span class="linenos">2703</span></a>                <span class="n">choose</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="COMPsc-2704"><a href="#COMPsc-2704"><span class="linenos">2704</span></a>                <span class="n">valid_group</span><span class="o">=</span><span class="n">group_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="COMPsc-2705"><a href="#COMPsc-2705"><span class="linenos">2705</span></a>                <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span>
</span><span id="COMPsc-2706"><a href="#COMPsc-2706"><span class="linenos">2706</span></a>                <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span>
</span><span id="COMPsc-2707"><a href="#COMPsc-2707"><span class="linenos">2707</span></a>                <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span>
</span><span id="COMPsc-2708"><a href="#COMPsc-2708"><span class="linenos">2708</span></a>                <span class="n">factors</span><span class="o">=</span><span class="n">factors</span><span class="p">,</span>
</span><span id="COMPsc-2709"><a href="#COMPsc-2709"><span class="linenos">2709</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2710"><a href="#COMPsc-2710"><span class="linenos">2710</span></a>
</span><span id="COMPsc-2711"><a href="#COMPsc-2711"><span class="linenos">2711</span></a>            <span class="k">return</span> <span class="n">result_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="COMPsc-2712"><a href="#COMPsc-2712"><span class="linenos">2712</span></a>
</span><span id="COMPsc-2713"><a href="#COMPsc-2713"><span class="linenos">2713</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-2714"><a href="#COMPsc-2714"><span class="linenos">2714</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc-2715"><a href="#COMPsc-2715"><span class="linenos">2715</span></a>                <span class="s2">&quot;You must specify either &#39;cells&#39; or &#39;sets&#39; (or both). None were provided, which is not allowed for this analysis.&quot;</span>
</span><span id="COMPsc-2716"><a href="#COMPsc-2716"><span class="linenos">2716</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2717"><a href="#COMPsc-2717"><span class="linenos">2717</span></a>
</span><span id="COMPsc-2718"><a href="#COMPsc-2718"><span class="linenos">2718</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_difference_markers</span><span class="p">(</span>
</span><span id="COMPsc-2719"><a href="#COMPsc-2719"><span class="linenos">2719</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">min_exp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_pct</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="COMPsc-2720"><a href="#COMPsc-2720"><span class="linenos">2720</span></a>    <span class="p">):</span>
</span><span id="COMPsc-2721"><a href="#COMPsc-2721"><span class="linenos">2721</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-2722"><a href="#COMPsc-2722"><span class="linenos">2722</span></a><span class="sd">        Compute differential markers (var_data) if not already present.</span>
</span><span id="COMPsc-2723"><a href="#COMPsc-2723"><span class="linenos">2723</span></a>
</span><span id="COMPsc-2724"><a href="#COMPsc-2724"><span class="linenos">2724</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-2725"><a href="#COMPsc-2725"><span class="linenos">2725</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-2726"><a href="#COMPsc-2726"><span class="linenos">2726</span></a><span class="sd">        min_exp : float, default 0</span>
</span><span id="COMPsc-2727"><a href="#COMPsc-2727"><span class="linenos">2727</span></a><span class="sd">            Minimum expression threshold passed to `statistic`.</span>
</span><span id="COMPsc-2728"><a href="#COMPsc-2728"><span class="linenos">2728</span></a>
</span><span id="COMPsc-2729"><a href="#COMPsc-2729"><span class="linenos">2729</span></a><span class="sd">        min_pct : float, default 0.25</span>
</span><span id="COMPsc-2730"><a href="#COMPsc-2730"><span class="linenos">2730</span></a><span class="sd">            Minimum percent expressed in target group.</span>
</span><span id="COMPsc-2731"><a href="#COMPsc-2731"><span class="linenos">2731</span></a>
</span><span id="COMPsc-2732"><a href="#COMPsc-2732"><span class="linenos">2732</span></a><span class="sd">        n_proc : int, default 10</span>
</span><span id="COMPsc-2733"><a href="#COMPsc-2733"><span class="linenos">2733</span></a><span class="sd">            Parallel jobs.</span>
</span><span id="COMPsc-2734"><a href="#COMPsc-2734"><span class="linenos">2734</span></a>
</span><span id="COMPsc-2735"><a href="#COMPsc-2735"><span class="linenos">2735</span></a><span class="sd">        force : bool, default False</span>
</span><span id="COMPsc-2736"><a href="#COMPsc-2736"><span class="linenos">2736</span></a><span class="sd">            If True, recompute even if `self.var_data` is present.</span>
</span><span id="COMPsc-2737"><a href="#COMPsc-2737"><span class="linenos">2737</span></a>
</span><span id="COMPsc-2738"><a href="#COMPsc-2738"><span class="linenos">2738</span></a><span class="sd">        Update</span>
</span><span id="COMPsc-2739"><a href="#COMPsc-2739"><span class="linenos">2739</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-2740"><a href="#COMPsc-2740"><span class="linenos">2740</span></a><span class="sd">        Sets `self.var_data` to the result of `self.statistic(...)`.</span>
</span><span id="COMPsc-2741"><a href="#COMPsc-2741"><span class="linenos">2741</span></a>
</span><span id="COMPsc-2742"><a href="#COMPsc-2742"><span class="linenos">2742</span></a><span class="sd">        Raise</span>
</span><span id="COMPsc-2743"><a href="#COMPsc-2743"><span class="linenos">2743</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-2744"><a href="#COMPsc-2744"><span class="linenos">2744</span></a><span class="sd">        ValueError if already computed and `force` is False.</span>
</span><span id="COMPsc-2745"><a href="#COMPsc-2745"><span class="linenos">2745</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-2746"><a href="#COMPsc-2746"><span class="linenos">2746</span></a>
</span><span id="COMPsc-2747"><a href="#COMPsc-2747"><span class="linenos">2747</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
</span><span id="COMPsc-2748"><a href="#COMPsc-2748"><span class="linenos">2748</span></a>
</span><span id="COMPsc-2749"><a href="#COMPsc-2749"><span class="linenos">2749</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="p">(</span>
</span><span id="COMPsc-2750"><a href="#COMPsc-2750"><span class="linenos">2750</span></a>                <span class="n">cells</span><span class="o">=</span><span class="s2">&quot;All&quot;</span><span class="p">,</span> <span class="n">sets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span> <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span>
</span><span id="COMPsc-2751"><a href="#COMPsc-2751"><span class="linenos">2751</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2752"><a href="#COMPsc-2752"><span class="linenos">2752</span></a>
</span><span id="COMPsc-2753"><a href="#COMPsc-2753"><span class="linenos">2753</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-2754"><a href="#COMPsc-2754"><span class="linenos">2754</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc-2755"><a href="#COMPsc-2755"><span class="linenos">2755</span></a>                <span class="s2">&quot;self.calculate_difference_markers() has already been executed. &quot;</span>
</span><span id="COMPsc-2756"><a href="#COMPsc-2756"><span class="linenos">2756</span></a>                <span class="s2">&quot;The results are stored in self.var. &quot;</span>
</span><span id="COMPsc-2757"><a href="#COMPsc-2757"><span class="linenos">2757</span></a>                <span class="s2">&quot;If you want to recalculate with different statistics, please rerun the method with force=True.&quot;</span>
</span><span id="COMPsc-2758"><a href="#COMPsc-2758"><span class="linenos">2758</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2759"><a href="#COMPsc-2759"><span class="linenos">2759</span></a>
</span><span id="COMPsc-2760"><a href="#COMPsc-2760"><span class="linenos">2760</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clustering_features</span><span class="p">(</span>
</span><span id="COMPsc-2761"><a href="#COMPsc-2761"><span class="linenos">2761</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc-2762"><a href="#COMPsc-2762"><span class="linenos">2762</span></a>        <span class="n">features_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-2763"><a href="#COMPsc-2763"><span class="linenos">2763</span></a>        <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="COMPsc-2764"><a href="#COMPsc-2764"><span class="linenos">2764</span></a>        <span class="n">p_val</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
</span><span id="COMPsc-2765"><a href="#COMPsc-2765"><span class="linenos">2765</span></a>        <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
</span><span id="COMPsc-2766"><a href="#COMPsc-2766"><span class="linenos">2766</span></a>        <span class="n">adj_mean</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="COMPsc-2767"><a href="#COMPsc-2767"><span class="linenos">2767</span></a>        <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
</span><span id="COMPsc-2768"><a href="#COMPsc-2768"><span class="linenos">2768</span></a>    <span class="p">):</span>
</span><span id="COMPsc-2769"><a href="#COMPsc-2769"><span class="linenos">2769</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-2770"><a href="#COMPsc-2770"><span class="linenos">2770</span></a><span class="sd">        Prepare clustering input by selecting marker features and optionally smoothing cell values</span>
</span><span id="COMPsc-2771"><a href="#COMPsc-2771"><span class="linenos">2771</span></a><span class="sd">        toward group means.</span>
</span><span id="COMPsc-2772"><a href="#COMPsc-2772"><span class="linenos">2772</span></a>
</span><span id="COMPsc-2773"><a href="#COMPsc-2773"><span class="linenos">2773</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-2774"><a href="#COMPsc-2774"><span class="linenos">2774</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-2775"><a href="#COMPsc-2775"><span class="linenos">2775</span></a><span class="sd">        features_list : list or None</span>
</span><span id="COMPsc-2776"><a href="#COMPsc-2776"><span class="linenos">2776</span></a><span class="sd">            If provided, use this list of features. If None, features are selected</span>
</span><span id="COMPsc-2777"><a href="#COMPsc-2777"><span class="linenos">2777</span></a><span class="sd">            from `self.var_data` (adj_pval &lt;= p_val, positive logFC) picking `top_n` per group.</span>
</span><span id="COMPsc-2778"><a href="#COMPsc-2778"><span class="linenos">2778</span></a>
</span><span id="COMPsc-2779"><a href="#COMPsc-2779"><span class="linenos">2779</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="COMPsc-2780"><a href="#COMPsc-2780"><span class="linenos">2780</span></a><span class="sd">            Metadata column used for naming.</span>
</span><span id="COMPsc-2781"><a href="#COMPsc-2781"><span class="linenos">2781</span></a>
</span><span id="COMPsc-2782"><a href="#COMPsc-2782"><span class="linenos">2782</span></a><span class="sd">        p_val : float, default 0.05</span>
</span><span id="COMPsc-2783"><a href="#COMPsc-2783"><span class="linenos">2783</span></a><span class="sd">            Adjusted p-value cutoff when selecting features automatically.</span>
</span><span id="COMPsc-2784"><a href="#COMPsc-2784"><span class="linenos">2784</span></a>
</span><span id="COMPsc-2785"><a href="#COMPsc-2785"><span class="linenos">2785</span></a><span class="sd">        top_n : int, default 25</span>
</span><span id="COMPsc-2786"><a href="#COMPsc-2786"><span class="linenos">2786</span></a><span class="sd">            Number of top features per valid group to keep if `features_list` is None.</span>
</span><span id="COMPsc-2787"><a href="#COMPsc-2787"><span class="linenos">2787</span></a>
</span><span id="COMPsc-2788"><a href="#COMPsc-2788"><span class="linenos">2788</span></a><span class="sd">        adj_mean : bool, default True</span>
</span><span id="COMPsc-2789"><a href="#COMPsc-2789"><span class="linenos">2789</span></a><span class="sd">            If True, adjust cell values toward group means using `beta`.</span>
</span><span id="COMPsc-2790"><a href="#COMPsc-2790"><span class="linenos">2790</span></a>
</span><span id="COMPsc-2791"><a href="#COMPsc-2791"><span class="linenos">2791</span></a><span class="sd">        beta : float, default 0.2</span>
</span><span id="COMPsc-2792"><a href="#COMPsc-2792"><span class="linenos">2792</span></a><span class="sd">            Adjustment strength toward group mean.</span>
</span><span id="COMPsc-2793"><a href="#COMPsc-2793"><span class="linenos">2793</span></a>
</span><span id="COMPsc-2794"><a href="#COMPsc-2794"><span class="linenos">2794</span></a><span class="sd">        Update</span>
</span><span id="COMPsc-2795"><a href="#COMPsc-2795"><span class="linenos">2795</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-2796"><a href="#COMPsc-2796"><span class="linenos">2796</span></a><span class="sd">        Sets `self.clustering_data` and `self.clustering_metadata` to the selected subset,</span>
</span><span id="COMPsc-2797"><a href="#COMPsc-2797"><span class="linenos">2797</span></a><span class="sd">        ready for PCA/UMAP/clustering.</span>
</span><span id="COMPsc-2798"><a href="#COMPsc-2798"><span class="linenos">2798</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-2799"><a href="#COMPsc-2799"><span class="linenos">2799</span></a>
</span><span id="COMPsc-2800"><a href="#COMPsc-2800"><span class="linenos">2800</span></a>        <span class="k">if</span> <span class="n">features_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">features_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-2801"><a href="#COMPsc-2801"><span class="linenos">2801</span></a>
</span><span id="COMPsc-2802"><a href="#COMPsc-2802"><span class="linenos">2802</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-2803"><a href="#COMPsc-2803"><span class="linenos">2803</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc-2804"><a href="#COMPsc-2804"><span class="linenos">2804</span></a>                    <span class="s2">&quot;Lack of &#39;self.var_data&#39;. Use self.calculate_difference_markers() method first.&quot;</span>
</span><span id="COMPsc-2805"><a href="#COMPsc-2805"><span class="linenos">2805</span></a>                <span class="p">)</span>
</span><span id="COMPsc-2806"><a href="#COMPsc-2806"><span class="linenos">2806</span></a>
</span><span id="COMPsc-2807"><a href="#COMPsc-2807"><span class="linenos">2807</span></a>            <span class="n">df_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;adj_pval&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_val</span><span class="p">]</span>
</span><span id="COMPsc-2808"><a href="#COMPsc-2808"><span class="linenos">2808</span></a>            <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">df_tmp</span><span class="p">[</span><span class="n">df_tmp</span><span class="p">[</span><span class="s2">&quot;log(FC)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="COMPsc-2809"><a href="#COMPsc-2809"><span class="linenos">2809</span></a>            <span class="n">df_tmp</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc-2810"><a href="#COMPsc-2810"><span class="linenos">2810</span></a>                <span class="n">df_tmp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
</span><span id="COMPsc-2811"><a href="#COMPsc-2811"><span class="linenos">2811</span></a>                    <span class="p">[</span><span class="s2">&quot;valid_group&quot;</span><span class="p">,</span> <span class="s2">&quot;esm&quot;</span><span class="p">,</span> <span class="s2">&quot;log(FC)&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
</span><span id="COMPsc-2812"><a href="#COMPsc-2812"><span class="linenos">2812</span></a>                <span class="p">)</span>
</span><span id="COMPsc-2813"><a href="#COMPsc-2813"><span class="linenos">2813</span></a>                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;valid_group&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2814"><a href="#COMPsc-2814"><span class="linenos">2814</span></a>                <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">top_n</span><span class="p">)</span>
</span><span id="COMPsc-2815"><a href="#COMPsc-2815"><span class="linenos">2815</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2816"><a href="#COMPsc-2816"><span class="linenos">2816</span></a>
</span><span id="COMPsc-2817"><a href="#COMPsc-2817"><span class="linenos">2817</span></a>            <span class="n">feaures_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df_tmp</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">]))</span>
</span><span id="COMPsc-2818"><a href="#COMPsc-2818"><span class="linenos">2818</span></a>
</span><span id="COMPsc-2819"><a href="#COMPsc-2819"><span class="linenos">2819</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_partial_data</span><span class="p">(</span>
</span><span id="COMPsc-2820"><a href="#COMPsc-2820"><span class="linenos">2820</span></a>            <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">feaures_list</span><span class="p">,</span> <span class="n">name_slot</span><span class="o">=</span><span class="n">name_slot</span>
</span><span id="COMPsc-2821"><a href="#COMPsc-2821"><span class="linenos">2821</span></a>        <span class="p">)</span>
</span><span id="COMPsc-2822"><a href="#COMPsc-2822"><span class="linenos">2822</span></a>        <span class="n">data_avg</span> <span class="o">=</span> <span class="n">average</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="COMPsc-2823"><a href="#COMPsc-2823"><span class="linenos">2823</span></a>
</span><span id="COMPsc-2824"><a href="#COMPsc-2824"><span class="linenos">2824</span></a>        <span class="k">if</span> <span class="n">adj_mean</span><span class="p">:</span>
</span><span id="COMPsc-2825"><a href="#COMPsc-2825"><span class="linenos">2825</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">adjust_cells_to_group_mean</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">data_avg</span><span class="o">=</span><span class="n">data_avg</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">)</span>
</span><span id="COMPsc-2826"><a href="#COMPsc-2826"><span class="linenos">2826</span></a>
</span><span id="COMPsc-2827"><a href="#COMPsc-2827"><span class="linenos">2827</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_data</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="COMPsc-2828"><a href="#COMPsc-2828"><span class="linenos">2828</span></a>
</span><span id="COMPsc-2829"><a href="#COMPsc-2829"><span class="linenos">2829</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span>
</span><span id="COMPsc-2830"><a href="#COMPsc-2830"><span class="linenos">2830</span></a>
</span><span id="COMPsc-2831"><a href="#COMPsc-2831"><span class="linenos">2831</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">average</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="COMPsc-2832"><a href="#COMPsc-2832"><span class="linenos">2832</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-2833"><a href="#COMPsc-2833"><span class="linenos">2833</span></a><span class="sd">        Aggregate normalized data by (cell_name, set) pairs computing the mean per group.</span>
</span><span id="COMPsc-2834"><a href="#COMPsc-2834"><span class="linenos">2834</span></a>
</span><span id="COMPsc-2835"><a href="#COMPsc-2835"><span class="linenos">2835</span></a><span class="sd">        The method constructs new column names as &quot;cell_name # set&quot;, averages columns</span>
</span><span id="COMPsc-2836"><a href="#COMPsc-2836"><span class="linenos">2836</span></a><span class="sd">        sharing identical labels, and populates `self.agg_normalized_data` and `self.agg_metadata`.</span>
</span><span id="COMPsc-2837"><a href="#COMPsc-2837"><span class="linenos">2837</span></a>
</span><span id="COMPsc-2838"><a href="#COMPsc-2838"><span class="linenos">2838</span></a><span class="sd">        Update</span>
</span><span id="COMPsc-2839"><a href="#COMPsc-2839"><span class="linenos">2839</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-2840"><a href="#COMPsc-2840"><span class="linenos">2840</span></a><span class="sd">        Sets `self.agg_normalized_data` (features x aggregated samples) and</span>
</span><span id="COMPsc-2841"><a href="#COMPsc-2841"><span class="linenos">2841</span></a><span class="sd">        `self.agg_metadata` (DataFrame with &#39;cell_names&#39; and &#39;sets&#39;).</span>
</span><span id="COMPsc-2842"><a href="#COMPsc-2842"><span class="linenos">2842</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-2843"><a href="#COMPsc-2843"><span class="linenos">2843</span></a>
</span><span id="COMPsc-2844"><a href="#COMPsc-2844"><span class="linenos">2844</span></a>        <span class="n">wide_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span>
</span><span id="COMPsc-2845"><a href="#COMPsc-2845"><span class="linenos">2845</span></a>
</span><span id="COMPsc-2846"><a href="#COMPsc-2846"><span class="linenos">2846</span></a>        <span class="n">wide_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span>
</span><span id="COMPsc-2847"><a href="#COMPsc-2847"><span class="linenos">2847</span></a>
</span><span id="COMPsc-2848"><a href="#COMPsc-2848"><span class="linenos">2848</span></a>        <span class="n">new_names</span> <span class="o">=</span> <span class="n">wide_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="n">wide_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2849"><a href="#COMPsc-2849"><span class="linenos">2849</span></a>
</span><span id="COMPsc-2850"><a href="#COMPsc-2850"><span class="linenos">2850</span></a>        <span class="n">wide_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_names</span><span class="p">)</span>
</span><span id="COMPsc-2851"><a href="#COMPsc-2851"><span class="linenos">2851</span></a>
</span><span id="COMPsc-2852"><a href="#COMPsc-2852"><span class="linenos">2852</span></a>        <span class="n">aggregated_df</span> <span class="o">=</span> <span class="n">wide_data</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">wide_data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</span><span id="COMPsc-2853"><a href="#COMPsc-2853"><span class="linenos">2853</span></a>
</span><span id="COMPsc-2854"><a href="#COMPsc-2854"><span class="linenos">2854</span></a>        <span class="n">sets</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*# &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">aggregated_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc-2855"><a href="#COMPsc-2855"><span class="linenos">2855</span></a>        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; #.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">aggregated_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc-2856"><a href="#COMPsc-2856"><span class="linenos">2856</span></a>
</span><span id="COMPsc-2857"><a href="#COMPsc-2857"><span class="linenos">2857</span></a>        <span class="n">aggregated_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">names</span>
</span><span id="COMPsc-2858"><a href="#COMPsc-2858"><span class="linenos">2858</span></a>        <span class="n">aggregated_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;cell_names&quot;</span><span class="p">:</span> <span class="n">names</span><span class="p">,</span> <span class="s2">&quot;sets&quot;</span><span class="p">:</span> <span class="n">sets</span><span class="p">})</span>
</span><span id="COMPsc-2859"><a href="#COMPsc-2859"><span class="linenos">2859</span></a>
</span><span id="COMPsc-2860"><a href="#COMPsc-2860"><span class="linenos">2860</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="n">aggregated_metadata</span>
</span><span id="COMPsc-2861"><a href="#COMPsc-2861"><span class="linenos">2861</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="o">=</span> <span class="n">aggregated_df</span>
</span><span id="COMPsc-2862"><a href="#COMPsc-2862"><span class="linenos">2862</span></a>
</span><span id="COMPsc-2863"><a href="#COMPsc-2863"><span class="linenos">2863</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">estimating_similarity</span><span class="p">(</span>
</span><span id="COMPsc-2864"><a href="#COMPsc-2864"><span class="linenos">2864</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;pearson&quot;</span><span class="p">,</span> <span class="n">p_val</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span>
</span><span id="COMPsc-2865"><a href="#COMPsc-2865"><span class="linenos">2865</span></a>    <span class="p">):</span>
</span><span id="COMPsc-2866"><a href="#COMPsc-2866"><span class="linenos">2866</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-2867"><a href="#COMPsc-2867"><span class="linenos">2867</span></a><span class="sd">        Estimate pairwise similarity and Euclidean distance between aggregated samples.</span>
</span><span id="COMPsc-2868"><a href="#COMPsc-2868"><span class="linenos">2868</span></a>
</span><span id="COMPsc-2869"><a href="#COMPsc-2869"><span class="linenos">2869</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-2870"><a href="#COMPsc-2870"><span class="linenos">2870</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-2871"><a href="#COMPsc-2871"><span class="linenos">2871</span></a><span class="sd">        method : str, default &#39;pearson&#39;</span>
</span><span id="COMPsc-2872"><a href="#COMPsc-2872"><span class="linenos">2872</span></a><span class="sd">            Correlation method to use (passed to pandas.DataFrame.corr()).</span>
</span><span id="COMPsc-2873"><a href="#COMPsc-2873"><span class="linenos">2873</span></a>
</span><span id="COMPsc-2874"><a href="#COMPsc-2874"><span class="linenos">2874</span></a><span class="sd">        p_val : float, default 0.05</span>
</span><span id="COMPsc-2875"><a href="#COMPsc-2875"><span class="linenos">2875</span></a><span class="sd">            Adjusted p-value cutoff used to select marker features from `self.var_data`.</span>
</span><span id="COMPsc-2876"><a href="#COMPsc-2876"><span class="linenos">2876</span></a>
</span><span id="COMPsc-2877"><a href="#COMPsc-2877"><span class="linenos">2877</span></a><span class="sd">        top_n : int, default 25</span>
</span><span id="COMPsc-2878"><a href="#COMPsc-2878"><span class="linenos">2878</span></a><span class="sd">            Number of top features per valid group to include.</span>
</span><span id="COMPsc-2879"><a href="#COMPsc-2879"><span class="linenos">2879</span></a>
</span><span id="COMPsc-2880"><a href="#COMPsc-2880"><span class="linenos">2880</span></a><span class="sd">        Update</span>
</span><span id="COMPsc-2881"><a href="#COMPsc-2881"><span class="linenos">2881</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-2882"><a href="#COMPsc-2882"><span class="linenos">2882</span></a><span class="sd">        Computes a combined table with per-pair correlation and euclidean distance</span>
</span><span id="COMPsc-2883"><a href="#COMPsc-2883"><span class="linenos">2883</span></a><span class="sd">        and stores it in `self.similarity`.</span>
</span><span id="COMPsc-2884"><a href="#COMPsc-2884"><span class="linenos">2884</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-2885"><a href="#COMPsc-2885"><span class="linenos">2885</span></a>
</span><span id="COMPsc-2886"><a href="#COMPsc-2886"><span class="linenos">2886</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-2887"><a href="#COMPsc-2887"><span class="linenos">2887</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc-2888"><a href="#COMPsc-2888"><span class="linenos">2888</span></a>                <span class="s2">&quot;Lack of &#39;self.var_data&#39;. Use self.calculate_difference_markers() method first.&quot;</span>
</span><span id="COMPsc-2889"><a href="#COMPsc-2889"><span class="linenos">2889</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2890"><a href="#COMPsc-2890"><span class="linenos">2890</span></a>
</span><span id="COMPsc-2891"><a href="#COMPsc-2891"><span class="linenos">2891</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-2892"><a href="#COMPsc-2892"><span class="linenos">2892</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
</span><span id="COMPsc-2893"><a href="#COMPsc-2893"><span class="linenos">2893</span></a>
</span><span id="COMPsc-2894"><a href="#COMPsc-2894"><span class="linenos">2894</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span>
</span><span id="COMPsc-2895"><a href="#COMPsc-2895"><span class="linenos">2895</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span>
</span><span id="COMPsc-2896"><a href="#COMPsc-2896"><span class="linenos">2896</span></a>
</span><span id="COMPsc-2897"><a href="#COMPsc-2897"><span class="linenos">2897</span></a>        <span class="n">df_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;adj_pval&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_val</span><span class="p">]</span>
</span><span id="COMPsc-2898"><a href="#COMPsc-2898"><span class="linenos">2898</span></a>        <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">df_tmp</span><span class="p">[</span><span class="n">df_tmp</span><span class="p">[</span><span class="s2">&quot;log(FC)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="COMPsc-2899"><a href="#COMPsc-2899"><span class="linenos">2899</span></a>        <span class="n">df_tmp</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc-2900"><a href="#COMPsc-2900"><span class="linenos">2900</span></a>            <span class="n">df_tmp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
</span><span id="COMPsc-2901"><a href="#COMPsc-2901"><span class="linenos">2901</span></a>                <span class="p">[</span><span class="s2">&quot;valid_group&quot;</span><span class="p">,</span> <span class="s2">&quot;esm&quot;</span><span class="p">,</span> <span class="s2">&quot;log(FC)&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
</span><span id="COMPsc-2902"><a href="#COMPsc-2902"><span class="linenos">2902</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2903"><a href="#COMPsc-2903"><span class="linenos">2903</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;valid_group&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2904"><a href="#COMPsc-2904"><span class="linenos">2904</span></a>            <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">top_n</span><span class="p">)</span>
</span><span id="COMPsc-2905"><a href="#COMPsc-2905"><span class="linenos">2905</span></a>        <span class="p">)</span>
</span><span id="COMPsc-2906"><a href="#COMPsc-2906"><span class="linenos">2906</span></a>
</span><span id="COMPsc-2907"><a href="#COMPsc-2907"><span class="linenos">2907</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df_tmp</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">]))]</span>
</span><span id="COMPsc-2908"><a href="#COMPsc-2908"><span class="linenos">2908</span></a>
</span><span id="COMPsc-2909"><a href="#COMPsc-2909"><span class="linenos">2909</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="COMPsc-2910"><a href="#COMPsc-2910"><span class="linenos">2910</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]]</span>
</span><span id="COMPsc-2911"><a href="#COMPsc-2911"><span class="linenos">2911</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-2912"><a href="#COMPsc-2912"><span class="linenos">2912</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="COMPsc-2913"><a href="#COMPsc-2913"><span class="linenos">2913</span></a>
</span><span id="COMPsc-2914"><a href="#COMPsc-2914"><span class="linenos">2914</span></a>        <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
</span><span id="COMPsc-2915"><a href="#COMPsc-2915"><span class="linenos">2915</span></a>
</span><span id="COMPsc-2916"><a href="#COMPsc-2916"><span class="linenos">2916</span></a>        <span class="n">scaled_data</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="COMPsc-2917"><a href="#COMPsc-2917"><span class="linenos">2917</span></a>
</span><span id="COMPsc-2918"><a href="#COMPsc-2918"><span class="linenos">2918</span></a>        <span class="n">scaled_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scaled_data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</span><span id="COMPsc-2919"><a href="#COMPsc-2919"><span class="linenos">2919</span></a>
</span><span id="COMPsc-2920"><a href="#COMPsc-2920"><span class="linenos">2920</span></a>        <span class="n">cor</span> <span class="o">=</span> <span class="n">scaled_df</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
</span><span id="COMPsc-2921"><a href="#COMPsc-2921"><span class="linenos">2921</span></a>        <span class="n">cor_df</span> <span class="o">=</span> <span class="n">cor</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="COMPsc-2922"><a href="#COMPsc-2922"><span class="linenos">2922</span></a>        <span class="n">cor_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">,</span> <span class="s2">&quot;cell2&quot;</span><span class="p">,</span> <span class="s2">&quot;correlation&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2923"><a href="#COMPsc-2923"><span class="linenos">2923</span></a>
</span><span id="COMPsc-2924"><a href="#COMPsc-2924"><span class="linenos">2924</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="n">pdist</span><span class="p">(</span><span class="n">scaled_df</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;euclidean&quot;</span><span class="p">)</span>
</span><span id="COMPsc-2925"><a href="#COMPsc-2925"><span class="linenos">2925</span></a>        <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="COMPsc-2926"><a href="#COMPsc-2926"><span class="linenos">2926</span></a>            <span class="n">squareform</span><span class="p">(</span><span class="n">distances</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">scaled_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">scaled_df</span><span class="o">.</span><span class="n">columns</span>
</span><span id="COMPsc-2927"><a href="#COMPsc-2927"><span class="linenos">2927</span></a>        <span class="p">)</span>
</span><span id="COMPsc-2928"><a href="#COMPsc-2928"><span class="linenos">2928</span></a>        <span class="n">dist_df</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="COMPsc-2929"><a href="#COMPsc-2929"><span class="linenos">2929</span></a>        <span class="n">dist_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">,</span> <span class="s2">&quot;cell2&quot;</span><span class="p">,</span> <span class="s2">&quot;euclidean_dist&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2930"><a href="#COMPsc-2930"><span class="linenos">2930</span></a>
</span><span id="COMPsc-2931"><a href="#COMPsc-2931"><span class="linenos">2931</span></a>        <span class="n">full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cor_df</span><span class="p">,</span> <span class="n">dist_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">,</span> <span class="s2">&quot;cell2&quot;</span><span class="p">])</span>
</span><span id="COMPsc-2932"><a href="#COMPsc-2932"><span class="linenos">2932</span></a>
</span><span id="COMPsc-2933"><a href="#COMPsc-2933"><span class="linenos">2933</span></a>        <span class="n">full</span> <span class="o">=</span> <span class="n">full</span><span class="p">[</span><span class="n">full</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">full</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]]</span>
</span><span id="COMPsc-2934"><a href="#COMPsc-2934"><span class="linenos">2934</span></a>        <span class="n">full</span> <span class="o">=</span> <span class="n">full</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="COMPsc-2935"><a href="#COMPsc-2935"><span class="linenos">2935</span></a>
</span><span id="COMPsc-2936"><a href="#COMPsc-2936"><span class="linenos">2936</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="o">=</span> <span class="n">full</span>
</span><span id="COMPsc-2937"><a href="#COMPsc-2937"><span class="linenos">2937</span></a>
</span><span id="COMPsc-2938"><a href="#COMPsc-2938"><span class="linenos">2938</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">similarity_plot</span><span class="p">(</span>
</span><span id="COMPsc-2939"><a href="#COMPsc-2939"><span class="linenos">2939</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc-2940"><a href="#COMPsc-2940"><span class="linenos">2940</span></a>        <span class="n">split_sets</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="COMPsc-2941"><a href="#COMPsc-2941"><span class="linenos">2941</span></a>        <span class="n">set_info</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="COMPsc-2942"><a href="#COMPsc-2942"><span class="linenos">2942</span></a>        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;seismic&quot;</span><span class="p">,</span>
</span><span id="COMPsc-2943"><a href="#COMPsc-2943"><span class="linenos">2943</span></a>        <span class="n">width</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="COMPsc-2944"><a href="#COMPsc-2944"><span class="linenos">2944</span></a>        <span class="n">height</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="COMPsc-2945"><a href="#COMPsc-2945"><span class="linenos">2945</span></a>    <span class="p">):</span>
</span><span id="COMPsc-2946"><a href="#COMPsc-2946"><span class="linenos">2946</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-2947"><a href="#COMPsc-2947"><span class="linenos">2947</span></a><span class="sd">        Visualize pairwise similarity as a scatter plot.</span>
</span><span id="COMPsc-2948"><a href="#COMPsc-2948"><span class="linenos">2948</span></a>
</span><span id="COMPsc-2949"><a href="#COMPsc-2949"><span class="linenos">2949</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-2950"><a href="#COMPsc-2950"><span class="linenos">2950</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-2951"><a href="#COMPsc-2951"><span class="linenos">2951</span></a><span class="sd">        split_sets : bool, default True</span>
</span><span id="COMPsc-2952"><a href="#COMPsc-2952"><span class="linenos">2952</span></a><span class="sd">            If True and set information is present, split plotting area roughly into two halves to visualize cross-set pairs.</span>
</span><span id="COMPsc-2953"><a href="#COMPsc-2953"><span class="linenos">2953</span></a>
</span><span id="COMPsc-2954"><a href="#COMPsc-2954"><span class="linenos">2954</span></a><span class="sd">        set_info : bool, default True</span>
</span><span id="COMPsc-2955"><a href="#COMPsc-2955"><span class="linenos">2955</span></a><span class="sd">            If True, keep the &#39; # set&#39; annotation in labels; otherwise strip it.</span>
</span><span id="COMPsc-2956"><a href="#COMPsc-2956"><span class="linenos">2956</span></a>
</span><span id="COMPsc-2957"><a href="#COMPsc-2957"><span class="linenos">2957</span></a><span class="sd">        cmap : str, default &#39;seismic&#39;</span>
</span><span id="COMPsc-2958"><a href="#COMPsc-2958"><span class="linenos">2958</span></a><span class="sd">            Color map for correlation (hue).</span>
</span><span id="COMPsc-2959"><a href="#COMPsc-2959"><span class="linenos">2959</span></a>
</span><span id="COMPsc-2960"><a href="#COMPsc-2960"><span class="linenos">2960</span></a><span class="sd">        width : int, default 12</span>
</span><span id="COMPsc-2961"><a href="#COMPsc-2961"><span class="linenos">2961</span></a><span class="sd">            Figure width.</span>
</span><span id="COMPsc-2962"><a href="#COMPsc-2962"><span class="linenos">2962</span></a>
</span><span id="COMPsc-2963"><a href="#COMPsc-2963"><span class="linenos">2963</span></a><span class="sd">        height : int, default 10</span>
</span><span id="COMPsc-2964"><a href="#COMPsc-2964"><span class="linenos">2964</span></a><span class="sd">            Figure height.</span>
</span><span id="COMPsc-2965"><a href="#COMPsc-2965"><span class="linenos">2965</span></a>
</span><span id="COMPsc-2966"><a href="#COMPsc-2966"><span class="linenos">2966</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc-2967"><a href="#COMPsc-2967"><span class="linenos">2967</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-2968"><a href="#COMPsc-2968"><span class="linenos">2968</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc-2969"><a href="#COMPsc-2969"><span class="linenos">2969</span></a>
</span><span id="COMPsc-2970"><a href="#COMPsc-2970"><span class="linenos">2970</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc-2971"><a href="#COMPsc-2971"><span class="linenos">2971</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-2972"><a href="#COMPsc-2972"><span class="linenos">2972</span></a><span class="sd">        ValueError</span>
</span><span id="COMPsc-2973"><a href="#COMPsc-2973"><span class="linenos">2973</span></a><span class="sd">            If `self.similarity` is None.</span>
</span><span id="COMPsc-2974"><a href="#COMPsc-2974"><span class="linenos">2974</span></a>
</span><span id="COMPsc-2975"><a href="#COMPsc-2975"><span class="linenos">2975</span></a><span class="sd">        Notes</span>
</span><span id="COMPsc-2976"><a href="#COMPsc-2976"><span class="linenos">2976</span></a><span class="sd">        -----</span>
</span><span id="COMPsc-2977"><a href="#COMPsc-2977"><span class="linenos">2977</span></a><span class="sd">        The function filters pairs by z-scored euclidean distance &gt; 0 to focus on closer pairs.</span>
</span><span id="COMPsc-2978"><a href="#COMPsc-2978"><span class="linenos">2978</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-2979"><a href="#COMPsc-2979"><span class="linenos">2979</span></a>
</span><span id="COMPsc-2980"><a href="#COMPsc-2980"><span class="linenos">2980</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-2981"><a href="#COMPsc-2981"><span class="linenos">2981</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc-2982"><a href="#COMPsc-2982"><span class="linenos">2982</span></a>                <span class="s2">&quot;Similarity data is missing. Please calculate similarity using self.estimating_similarity.&quot;</span>
</span><span id="COMPsc-2983"><a href="#COMPsc-2983"><span class="linenos">2983</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2984"><a href="#COMPsc-2984"><span class="linenos">2984</span></a>
</span><span id="COMPsc-2985"><a href="#COMPsc-2985"><span class="linenos">2985</span></a>        <span class="n">similarity_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span>
</span><span id="COMPsc-2986"><a href="#COMPsc-2986"><span class="linenos">2986</span></a>
</span><span id="COMPsc-2987"><a href="#COMPsc-2987"><span class="linenos">2987</span></a>        <span class="k">if</span> <span class="s2">&quot; # &quot;</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="COMPsc-2988"><a href="#COMPsc-2988"><span class="linenos">2988</span></a>            <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;set1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc-2989"><a href="#COMPsc-2989"><span class="linenos">2989</span></a>                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*# &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2990"><a href="#COMPsc-2990"><span class="linenos">2990</span></a>            <span class="p">]</span>
</span><span id="COMPsc-2991"><a href="#COMPsc-2991"><span class="linenos">2991</span></a>            <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;set2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc-2992"><a href="#COMPsc-2992"><span class="linenos">2992</span></a>                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*# &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]</span>
</span><span id="COMPsc-2993"><a href="#COMPsc-2993"><span class="linenos">2993</span></a>            <span class="p">]</span>
</span><span id="COMPsc-2994"><a href="#COMPsc-2994"><span class="linenos">2994</span></a>
</span><span id="COMPsc-2995"><a href="#COMPsc-2995"><span class="linenos">2995</span></a>        <span class="k">if</span> <span class="n">split_sets</span> <span class="ow">and</span> <span class="s2">&quot; # &quot;</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="COMPsc-2996"><a href="#COMPsc-2996"><span class="linenos">2996</span></a>            <span class="n">sets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="COMPsc-2997"><a href="#COMPsc-2997"><span class="linenos">2997</span></a>                <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;set1&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;set2&quot;</span><span class="p">]))</span>
</span><span id="COMPsc-2998"><a href="#COMPsc-2998"><span class="linenos">2998</span></a>            <span class="p">)</span>
</span><span id="COMPsc-2999"><a href="#COMPsc-2999"><span class="linenos">2999</span></a>
</span><span id="COMPsc-3000"><a href="#COMPsc-3000"><span class="linenos">3000</span></a>            <span class="n">mm</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="COMPsc-3001"><a href="#COMPsc-3001"><span class="linenos">3001</span></a>
</span><span id="COMPsc-3002"><a href="#COMPsc-3002"><span class="linenos">3002</span></a>            <span class="n">x_s</span> <span class="o">=</span> <span class="n">sets</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">mm</span><span class="p">]</span>
</span><span id="COMPsc-3003"><a href="#COMPsc-3003"><span class="linenos">3003</span></a>            <span class="n">y_s</span> <span class="o">=</span> <span class="n">sets</span><span class="p">[</span><span class="n">mm</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)]</span>
</span><span id="COMPsc-3004"><a href="#COMPsc-3004"><span class="linenos">3004</span></a>
</span><span id="COMPsc-3005"><a href="#COMPsc-3005"><span class="linenos">3005</span></a>            <span class="n">similarity_data</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="p">[</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;set1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">x_s</span><span class="p">)]</span>
</span><span id="COMPsc-3006"><a href="#COMPsc-3006"><span class="linenos">3006</span></a>            <span class="n">similarity_data</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="p">[</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;set2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">y_s</span><span class="p">)]</span>
</span><span id="COMPsc-3007"><a href="#COMPsc-3007"><span class="linenos">3007</span></a>
</span><span id="COMPsc-3008"><a href="#COMPsc-3008"><span class="linenos">3008</span></a>            <span class="n">similarity_data</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;set1&quot;</span><span class="p">,</span> <span class="s2">&quot;set2&quot;</span><span class="p">])</span>
</span><span id="COMPsc-3009"><a href="#COMPsc-3009"><span class="linenos">3009</span></a>
</span><span id="COMPsc-3010"><a href="#COMPsc-3010"><span class="linenos">3010</span></a>        <span class="k">if</span> <span class="n">set_info</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="s2">&quot; # &quot;</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="COMPsc-3011"><a href="#COMPsc-3011"><span class="linenos">3011</span></a>            <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc-3012"><a href="#COMPsc-3012"><span class="linenos">3012</span></a>                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; #.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">]</span>
</span><span id="COMPsc-3013"><a href="#COMPsc-3013"><span class="linenos">3013</span></a>            <span class="p">]</span>
</span><span id="COMPsc-3014"><a href="#COMPsc-3014"><span class="linenos">3014</span></a>            <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc-3015"><a href="#COMPsc-3015"><span class="linenos">3015</span></a>                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; #.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]</span>
</span><span id="COMPsc-3016"><a href="#COMPsc-3016"><span class="linenos">3016</span></a>            <span class="p">]</span>
</span><span id="COMPsc-3017"><a href="#COMPsc-3017"><span class="linenos">3017</span></a>
</span><span id="COMPsc-3018"><a href="#COMPsc-3018"><span class="linenos">3018</span></a>        <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;-euclidean_zscore&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">zscore</span><span class="p">(</span>
</span><span id="COMPsc-3019"><a href="#COMPsc-3019"><span class="linenos">3019</span></a>            <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;euclidean_dist&quot;</span><span class="p">]</span>
</span><span id="COMPsc-3020"><a href="#COMPsc-3020"><span class="linenos">3020</span></a>        <span class="p">)</span>
</span><span id="COMPsc-3021"><a href="#COMPsc-3021"><span class="linenos">3021</span></a>
</span><span id="COMPsc-3022"><a href="#COMPsc-3022"><span class="linenos">3022</span></a>        <span class="n">similarity_data</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="p">[</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;-euclidean_zscore&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="COMPsc-3023"><a href="#COMPsc-3023"><span class="linenos">3023</span></a>
</span><span id="COMPsc-3024"><a href="#COMPsc-3024"><span class="linenos">3024</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="COMPsc-3025"><a href="#COMPsc-3025"><span class="linenos">3025</span></a>        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
</span><span id="COMPsc-3026"><a href="#COMPsc-3026"><span class="linenos">3026</span></a>            <span class="n">data</span><span class="o">=</span><span class="n">similarity_data</span><span class="p">,</span>
</span><span id="COMPsc-3027"><a href="#COMPsc-3027"><span class="linenos">3027</span></a>            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;cell1&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3028"><a href="#COMPsc-3028"><span class="linenos">3028</span></a>            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;cell2&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3029"><a href="#COMPsc-3029"><span class="linenos">3029</span></a>            <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;correlation&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3030"><a href="#COMPsc-3030"><span class="linenos">3030</span></a>            <span class="n">size</span><span class="o">=</span><span class="s2">&quot;-euclidean_zscore&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3031"><a href="#COMPsc-3031"><span class="linenos">3031</span></a>            <span class="n">sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
</span><span id="COMPsc-3032"><a href="#COMPsc-3032"><span class="linenos">3032</span></a>            <span class="n">palette</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="COMPsc-3033"><a href="#COMPsc-3033"><span class="linenos">3033</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc-3034"><a href="#COMPsc-3034"><span class="linenos">3034</span></a>            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3035"><a href="#COMPsc-3035"><span class="linenos">3035</span></a>        <span class="p">)</span>
</span><span id="COMPsc-3036"><a href="#COMPsc-3036"><span class="linenos">3036</span></a>
</span><span id="COMPsc-3037"><a href="#COMPsc-3037"><span class="linenos">3037</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
</span><span id="COMPsc-3038"><a href="#COMPsc-3038"><span class="linenos">3038</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="COMPsc-3039"><a href="#COMPsc-3039"><span class="linenos">3039</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Cell 1&quot;</span><span class="p">)</span>
</span><span id="COMPsc-3040"><a href="#COMPsc-3040"><span class="linenos">3040</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cell 2&quot;</span><span class="p">)</span>
</span><span id="COMPsc-3041"><a href="#COMPsc-3041"><span class="linenos">3041</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
</span><span id="COMPsc-3042"><a href="#COMPsc-3042"><span class="linenos">3042</span></a>
</span><span id="COMPsc-3043"><a href="#COMPsc-3043"><span class="linenos">3043</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
</span><span id="COMPsc-3044"><a href="#COMPsc-3044"><span class="linenos">3044</span></a>
</span><span id="COMPsc-3045"><a href="#COMPsc-3045"><span class="linenos">3045</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="COMPsc-3046"><a href="#COMPsc-3046"><span class="linenos">3046</span></a>
</span><span id="COMPsc-3047"><a href="#COMPsc-3047"><span class="linenos">3047</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="COMPsc-3048"><a href="#COMPsc-3048"><span class="linenos">3048</span></a>
</span><span id="COMPsc-3049"><a href="#COMPsc-3049"><span class="linenos">3049</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">spatial_similarity</span><span class="p">(</span>
</span><span id="COMPsc-3050"><a href="#COMPsc-3050"><span class="linenos">3050</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc-3051"><a href="#COMPsc-3051"><span class="linenos">3051</span></a>        <span class="n">set_info</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="COMPsc-3052"><a href="#COMPsc-3052"><span class="linenos">3052</span></a>        <span class="n">bandwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc-3053"><a href="#COMPsc-3053"><span class="linenos">3053</span></a>        <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="COMPsc-3054"><a href="#COMPsc-3054"><span class="linenos">3054</span></a>        <span class="n">min_dist</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="COMPsc-3055"><a href="#COMPsc-3055"><span class="linenos">3055</span></a>        <span class="n">legend_split</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="COMPsc-3056"><a href="#COMPsc-3056"><span class="linenos">3056</span></a>        <span class="n">point_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
</span><span id="COMPsc-3057"><a href="#COMPsc-3057"><span class="linenos">3057</span></a>        <span class="n">spread</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="COMPsc-3058"><a href="#COMPsc-3058"><span class="linenos">3058</span></a>        <span class="n">set_op_mix_ratio</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="COMPsc-3059"><a href="#COMPsc-3059"><span class="linenos">3059</span></a>        <span class="n">local_connectivity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc-3060"><a href="#COMPsc-3060"><span class="linenos">3060</span></a>        <span class="n">repulsion_strength</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="COMPsc-3061"><a href="#COMPsc-3061"><span class="linenos">3061</span></a>        <span class="n">negative_sample_rate</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="COMPsc-3062"><a href="#COMPsc-3062"><span class="linenos">3062</span></a>        <span class="n">threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="COMPsc-3063"><a href="#COMPsc-3063"><span class="linenos">3063</span></a>        <span class="n">width</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="COMPsc-3064"><a href="#COMPsc-3064"><span class="linenos">3064</span></a>        <span class="n">height</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="COMPsc-3065"><a href="#COMPsc-3065"><span class="linenos">3065</span></a>    <span class="p">):</span>
</span><span id="COMPsc-3066"><a href="#COMPsc-3066"><span class="linenos">3066</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-3067"><a href="#COMPsc-3067"><span class="linenos">3067</span></a><span class="sd">        Create a spatial UMAP-like visualization of similarity relationships between samples.</span>
</span><span id="COMPsc-3068"><a href="#COMPsc-3068"><span class="linenos">3068</span></a>
</span><span id="COMPsc-3069"><a href="#COMPsc-3069"><span class="linenos">3069</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-3070"><a href="#COMPsc-3070"><span class="linenos">3070</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-3071"><a href="#COMPsc-3071"><span class="linenos">3071</span></a><span class="sd">        set_info : bool, default True</span>
</span><span id="COMPsc-3072"><a href="#COMPsc-3072"><span class="linenos">3072</span></a><span class="sd">            If True, retain set information in labels.</span>
</span><span id="COMPsc-3073"><a href="#COMPsc-3073"><span class="linenos">3073</span></a>
</span><span id="COMPsc-3074"><a href="#COMPsc-3074"><span class="linenos">3074</span></a><span class="sd">        bandwidth : float, default 1</span>
</span><span id="COMPsc-3075"><a href="#COMPsc-3075"><span class="linenos">3075</span></a><span class="sd">            Bandwidth used by MeanShift for clustering polygons.</span>
</span><span id="COMPsc-3076"><a href="#COMPsc-3076"><span class="linenos">3076</span></a>
</span><span id="COMPsc-3077"><a href="#COMPsc-3077"><span class="linenos">3077</span></a><span class="sd">        point_size : float, default 100</span>
</span><span id="COMPsc-3078"><a href="#COMPsc-3078"><span class="linenos">3078</span></a><span class="sd">            Size of scatter points.</span>
</span><span id="COMPsc-3079"><a href="#COMPsc-3079"><span class="linenos">3079</span></a>
</span><span id="COMPsc-3080"><a href="#COMPsc-3080"><span class="linenos">3080</span></a><span class="sd">        legend_split : int, default 2</span>
</span><span id="COMPsc-3081"><a href="#COMPsc-3081"><span class="linenos">3081</span></a><span class="sd">            Number of columns in legend.</span>
</span><span id="COMPsc-3082"><a href="#COMPsc-3082"><span class="linenos">3082</span></a>
</span><span id="COMPsc-3083"><a href="#COMPsc-3083"><span class="linenos">3083</span></a><span class="sd">        n_neighbors, min_dist, spread, set_op_mix_ratio, local_connectivity, repulsion_strength, negative_sample_rate : parameters passed to UMAP.</span>
</span><span id="COMPsc-3084"><a href="#COMPsc-3084"><span class="linenos">3084</span></a>
</span><span id="COMPsc-3085"><a href="#COMPsc-3085"><span class="linenos">3085</span></a><span class="sd">        threshold : float, default 0.1</span>
</span><span id="COMPsc-3086"><a href="#COMPsc-3086"><span class="linenos">3086</span></a><span class="sd">            Minimum text distance for label adjustment to avoid overlap.</span>
</span><span id="COMPsc-3087"><a href="#COMPsc-3087"><span class="linenos">3087</span></a>
</span><span id="COMPsc-3088"><a href="#COMPsc-3088"><span class="linenos">3088</span></a><span class="sd">        width : int, default 12</span>
</span><span id="COMPsc-3089"><a href="#COMPsc-3089"><span class="linenos">3089</span></a><span class="sd">            Figure width.</span>
</span><span id="COMPsc-3090"><a href="#COMPsc-3090"><span class="linenos">3090</span></a>
</span><span id="COMPsc-3091"><a href="#COMPsc-3091"><span class="linenos">3091</span></a><span class="sd">        height : int, default 10</span>
</span><span id="COMPsc-3092"><a href="#COMPsc-3092"><span class="linenos">3092</span></a><span class="sd">            Figure height.</span>
</span><span id="COMPsc-3093"><a href="#COMPsc-3093"><span class="linenos">3093</span></a>
</span><span id="COMPsc-3094"><a href="#COMPsc-3094"><span class="linenos">3094</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc-3095"><a href="#COMPsc-3095"><span class="linenos">3095</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-3096"><a href="#COMPsc-3096"><span class="linenos">3096</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc-3097"><a href="#COMPsc-3097"><span class="linenos">3097</span></a>
</span><span id="COMPsc-3098"><a href="#COMPsc-3098"><span class="linenos">3098</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc-3099"><a href="#COMPsc-3099"><span class="linenos">3099</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-3100"><a href="#COMPsc-3100"><span class="linenos">3100</span></a><span class="sd">        ValueError</span>
</span><span id="COMPsc-3101"><a href="#COMPsc-3101"><span class="linenos">3101</span></a><span class="sd">            If `self.similarity` is None.</span>
</span><span id="COMPsc-3102"><a href="#COMPsc-3102"><span class="linenos">3102</span></a>
</span><span id="COMPsc-3103"><a href="#COMPsc-3103"><span class="linenos">3103</span></a><span class="sd">        Notes</span>
</span><span id="COMPsc-3104"><a href="#COMPsc-3104"><span class="linenos">3104</span></a><span class="sd">        -----</span>
</span><span id="COMPsc-3105"><a href="#COMPsc-3105"><span class="linenos">3105</span></a><span class="sd">        Builds a precomputed distance matrix combining correlation and euclidean distance,</span>
</span><span id="COMPsc-3106"><a href="#COMPsc-3106"><span class="linenos">3106</span></a><span class="sd">        runs UMAP with metric=&#39;precomputed&#39;, then overlays cluster hulls (MeanShift + convex hull)</span>
</span><span id="COMPsc-3107"><a href="#COMPsc-3107"><span class="linenos">3107</span></a><span class="sd">        and arrows to indicate nearest neighbors (minimal combined distance).</span>
</span><span id="COMPsc-3108"><a href="#COMPsc-3108"><span class="linenos">3108</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-3109"><a href="#COMPsc-3109"><span class="linenos">3109</span></a>
</span><span id="COMPsc-3110"><a href="#COMPsc-3110"><span class="linenos">3110</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-3111"><a href="#COMPsc-3111"><span class="linenos">3111</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc-3112"><a href="#COMPsc-3112"><span class="linenos">3112</span></a>                <span class="s2">&quot;Similarity data is missing. Please calculate similarity using self.estimating_similarity.&quot;</span>
</span><span id="COMPsc-3113"><a href="#COMPsc-3113"><span class="linenos">3113</span></a>            <span class="p">)</span>
</span><span id="COMPsc-3114"><a href="#COMPsc-3114"><span class="linenos">3114</span></a>
</span><span id="COMPsc-3115"><a href="#COMPsc-3115"><span class="linenos">3115</span></a>        <span class="n">similarity_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span>
</span><span id="COMPsc-3116"><a href="#COMPsc-3116"><span class="linenos">3116</span></a>
</span><span id="COMPsc-3117"><a href="#COMPsc-3117"><span class="linenos">3117</span></a>        <span class="n">sim</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;correlation&quot;</span><span class="p">]</span>
</span><span id="COMPsc-3118"><a href="#COMPsc-3118"><span class="linenos">3118</span></a>        <span class="n">sim_scaled</span> <span class="o">=</span> <span class="p">(</span><span class="n">sim</span> <span class="o">-</span> <span class="n">sim</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">sim</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</span><span id="COMPsc-3119"><a href="#COMPsc-3119"><span class="linenos">3119</span></a>        <span class="n">eu_dist</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;euclidean_dist&quot;</span><span class="p">]</span>
</span><span id="COMPsc-3120"><a href="#COMPsc-3120"><span class="linenos">3120</span></a>        <span class="n">eu_dist_scaled</span> <span class="o">=</span> <span class="p">(</span><span class="n">eu_dist</span> <span class="o">-</span> <span class="n">eu_dist</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">eu_dist</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">eu_dist</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</span><span id="COMPsc-3121"><a href="#COMPsc-3121"><span class="linenos">3121</span></a>
</span><span id="COMPsc-3122"><a href="#COMPsc-3122"><span class="linenos">3122</span></a>        <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;combo_dist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sim_scaled</span><span class="p">)</span> <span class="o">*</span> <span class="n">eu_dist_scaled</span>
</span><span id="COMPsc-3123"><a href="#COMPsc-3123"><span class="linenos">3123</span></a>
</span><span id="COMPsc-3124"><a href="#COMPsc-3124"><span class="linenos">3124</span></a>        <span class="c1"># for nn target</span>
</span><span id="COMPsc-3125"><a href="#COMPsc-3125"><span class="linenos">3125</span></a>        <span class="n">arrow_df</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="COMPsc-3126"><a href="#COMPsc-3126"><span class="linenos">3126</span></a>        <span class="n">arrow_df</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
</span><span id="COMPsc-3127"><a href="#COMPsc-3127"><span class="linenos">3127</span></a>            <span class="n">similarity_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;cell1&quot;</span><span class="p">)[</span><span class="s2">&quot;combo_dist&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
</span><span id="COMPsc-3128"><a href="#COMPsc-3128"><span class="linenos">3128</span></a>        <span class="p">]</span>
</span><span id="COMPsc-3129"><a href="#COMPsc-3129"><span class="linenos">3129</span></a>
</span><span id="COMPsc-3130"><a href="#COMPsc-3130"><span class="linenos">3130</span></a>        <span class="n">cells</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">])</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]))</span>
</span><span id="COMPsc-3131"><a href="#COMPsc-3131"><span class="linenos">3131</span></a>        <span class="n">combo_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">cells</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cells</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="COMPsc-3132"><a href="#COMPsc-3132"><span class="linenos">3132</span></a>
</span><span id="COMPsc-3133"><a href="#COMPsc-3133"><span class="linenos">3133</span></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="COMPsc-3134"><a href="#COMPsc-3134"><span class="linenos">3134</span></a>            <span class="n">combo_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;combo_dist&quot;</span><span class="p">]</span>
</span><span id="COMPsc-3135"><a href="#COMPsc-3135"><span class="linenos">3135</span></a>            <span class="n">combo_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;combo_dist&quot;</span><span class="p">]</span>
</span><span id="COMPsc-3136"><a href="#COMPsc-3136"><span class="linenos">3136</span></a>
</span><span id="COMPsc-3137"><a href="#COMPsc-3137"><span class="linenos">3137</span></a>        <span class="n">umap_model</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">UMAP</span><span class="p">(</span>
</span><span id="COMPsc-3138"><a href="#COMPsc-3138"><span class="linenos">3138</span></a>            <span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="COMPsc-3139"><a href="#COMPsc-3139"><span class="linenos">3139</span></a>            <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;precomputed&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3140"><a href="#COMPsc-3140"><span class="linenos">3140</span></a>            <span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">,</span>
</span><span id="COMPsc-3141"><a href="#COMPsc-3141"><span class="linenos">3141</span></a>            <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span>
</span><span id="COMPsc-3142"><a href="#COMPsc-3142"><span class="linenos">3142</span></a>            <span class="n">spread</span><span class="o">=</span><span class="n">spread</span><span class="p">,</span>
</span><span id="COMPsc-3143"><a href="#COMPsc-3143"><span class="linenos">3143</span></a>            <span class="n">set_op_mix_ratio</span><span class="o">=</span><span class="n">set_op_mix_ratio</span><span class="p">,</span>
</span><span id="COMPsc-3144"><a href="#COMPsc-3144"><span class="linenos">3144</span></a>            <span class="n">local_connectivity</span><span class="o">=</span><span class="n">set_op_mix_ratio</span><span class="p">,</span>
</span><span id="COMPsc-3145"><a href="#COMPsc-3145"><span class="linenos">3145</span></a>            <span class="n">repulsion_strength</span><span class="o">=</span><span class="n">repulsion_strength</span><span class="p">,</span>
</span><span id="COMPsc-3146"><a href="#COMPsc-3146"><span class="linenos">3146</span></a>            <span class="n">negative_sample_rate</span><span class="o">=</span><span class="n">negative_sample_rate</span><span class="p">,</span>
</span><span id="COMPsc-3147"><a href="#COMPsc-3147"><span class="linenos">3147</span></a>            <span class="n">transform_seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
</span><span id="COMPsc-3148"><a href="#COMPsc-3148"><span class="linenos">3148</span></a>            <span class="n">init</span><span class="o">=</span><span class="s2">&quot;spectral&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3149"><a href="#COMPsc-3149"><span class="linenos">3149</span></a>            <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
</span><span id="COMPsc-3150"><a href="#COMPsc-3150"><span class="linenos">3150</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="COMPsc-3151"><a href="#COMPsc-3151"><span class="linenos">3151</span></a>        <span class="p">)</span>
</span><span id="COMPsc-3152"><a href="#COMPsc-3152"><span class="linenos">3152</span></a>
</span><span id="COMPsc-3153"><a href="#COMPsc-3153"><span class="linenos">3153</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">umap_model</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">combo_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="COMPsc-3154"><a href="#COMPsc-3154"><span class="linenos">3154</span></a>        <span class="n">cell_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combo_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="COMPsc-3155"><a href="#COMPsc-3155"><span class="linenos">3155</span></a>        <span class="n">num_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_names</span><span class="p">)</span>
</span><span id="COMPsc-3156"><a href="#COMPsc-3156"><span class="linenos">3156</span></a>        <span class="n">palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;tab20c&quot;</span><span class="p">,</span> <span class="n">num_cells</span><span class="p">)</span>
</span><span id="COMPsc-3157"><a href="#COMPsc-3157"><span class="linenos">3157</span></a>
</span><span id="COMPsc-3158"><a href="#COMPsc-3158"><span class="linenos">3158</span></a>        <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">in</span> <span class="n">cell_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="COMPsc-3159"><a href="#COMPsc-3159"><span class="linenos">3159</span></a>            <span class="n">avsets</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
</span><span id="COMPsc-3160"><a href="#COMPsc-3160"><span class="linenos">3160</span></a>                <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*# &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">]]</span>
</span><span id="COMPsc-3161"><a href="#COMPsc-3161"><span class="linenos">3161</span></a>                <span class="o">+</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*# &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]]</span>
</span><span id="COMPsc-3162"><a href="#COMPsc-3162"><span class="linenos">3162</span></a>            <span class="p">)</span>
</span><span id="COMPsc-3163"><a href="#COMPsc-3163"><span class="linenos">3163</span></a>            <span class="n">num_sets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">avsets</span><span class="p">)</span>
</span><span id="COMPsc-3164"><a href="#COMPsc-3164"><span class="linenos">3164</span></a>            <span class="n">color_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span> <span class="o">//</span> <span class="n">num_sets</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sets</span><span class="p">)]</span>
</span><span id="COMPsc-3165"><a href="#COMPsc-3165"><span class="linenos">3165</span></a>            <span class="n">color_mapping_sets</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="COMPsc-3166"><a href="#COMPsc-3166"><span class="linenos">3166</span></a>                <span class="n">set_name</span><span class="p">:</span> <span class="n">palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">set_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">color_indices</span><span class="p">,</span> <span class="n">avsets</span><span class="p">)</span>
</span><span id="COMPsc-3167"><a href="#COMPsc-3167"><span class="linenos">3167</span></a>            <span class="p">}</span>
</span><span id="COMPsc-3168"><a href="#COMPsc-3168"><span class="linenos">3168</span></a>            <span class="n">color_mapping</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="COMPsc-3169"><a href="#COMPsc-3169"><span class="linenos">3169</span></a>                <span class="n">name</span><span class="p">:</span> <span class="n">color_mapping_sets</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*# &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)]</span>
</span><span id="COMPsc-3170"><a href="#COMPsc-3170"><span class="linenos">3170</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cell_names</span><span class="p">)</span>
</span><span id="COMPsc-3171"><a href="#COMPsc-3171"><span class="linenos">3171</span></a>            <span class="p">}</span>
</span><span id="COMPsc-3172"><a href="#COMPsc-3172"><span class="linenos">3172</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-3173"><a href="#COMPsc-3173"><span class="linenos">3173</span></a>            <span class="n">color_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cell_names</span><span class="p">)}</span>
</span><span id="COMPsc-3174"><a href="#COMPsc-3174"><span class="linenos">3174</span></a>
</span><span id="COMPsc-3175"><a href="#COMPsc-3175"><span class="linenos">3175</span></a>        <span class="n">meanshift</span> <span class="o">=</span> <span class="n">MeanShift</span><span class="p">(</span><span class="n">bandwidth</span><span class="o">=</span><span class="n">bandwidth</span><span class="p">)</span>
</span><span id="COMPsc-3176"><a href="#COMPsc-3176"><span class="linenos">3176</span></a>        <span class="n">labels</span> <span class="o">=</span> <span class="n">meanshift</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</span><span id="COMPsc-3177"><a href="#COMPsc-3177"><span class="linenos">3177</span></a>
</span><span id="COMPsc-3178"><a href="#COMPsc-3178"><span class="linenos">3178</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="COMPsc-3179"><a href="#COMPsc-3179"><span class="linenos">3179</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
</span><span id="COMPsc-3180"><a href="#COMPsc-3180"><span class="linenos">3180</span></a>
</span><span id="COMPsc-3181"><a href="#COMPsc-3181"><span class="linenos">3181</span></a>        <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
</span><span id="COMPsc-3182"><a href="#COMPsc-3182"><span class="linenos">3182</span></a>        <span class="n">cluster_palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;hls&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">))</span>
</span><span id="COMPsc-3183"><a href="#COMPsc-3183"><span class="linenos">3183</span></a>
</span><span id="COMPsc-3184"><a href="#COMPsc-3184"><span class="linenos">3184</span></a>        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
</span><span id="COMPsc-3185"><a href="#COMPsc-3185"><span class="linenos">3185</span></a>            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="COMPsc-3186"><a href="#COMPsc-3186"><span class="linenos">3186</span></a>                <span class="k">continue</span>
</span><span id="COMPsc-3187"><a href="#COMPsc-3187"><span class="linenos">3187</span></a>            <span class="n">cluster_coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">label</span><span class="p">]</span>
</span><span id="COMPsc-3188"><a href="#COMPsc-3188"><span class="linenos">3188</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_coords</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="COMPsc-3189"><a href="#COMPsc-3189"><span class="linenos">3189</span></a>                <span class="k">continue</span>
</span><span id="COMPsc-3190"><a href="#COMPsc-3190"><span class="linenos">3190</span></a>
</span><span id="COMPsc-3191"><a href="#COMPsc-3191"><span class="linenos">3191</span></a>            <span class="n">hull</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">(</span><span class="n">cluster_coords</span><span class="p">)</span>
</span><span id="COMPsc-3192"><a href="#COMPsc-3192"><span class="linenos">3192</span></a>            <span class="n">hull_points</span> <span class="o">=</span> <span class="n">cluster_coords</span><span class="p">[</span><span class="n">hull</span><span class="o">.</span><span class="n">vertices</span><span class="p">]</span>
</span><span id="COMPsc-3193"><a href="#COMPsc-3193"><span class="linenos">3193</span></a>
</span><span id="COMPsc-3194"><a href="#COMPsc-3194"><span class="linenos">3194</span></a>            <span class="n">centroid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hull_points</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="COMPsc-3195"><a href="#COMPsc-3195"><span class="linenos">3195</span></a>            <span class="n">expanded</span> <span class="o">=</span> <span class="n">hull_points</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="n">hull_points</span> <span class="o">-</span> <span class="n">centroid</span><span class="p">)</span>
</span><span id="COMPsc-3196"><a href="#COMPsc-3196"><span class="linenos">3196</span></a>
</span><span id="COMPsc-3197"><a href="#COMPsc-3197"><span class="linenos">3197</span></a>            <span class="n">poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span>
</span><span id="COMPsc-3198"><a href="#COMPsc-3198"><span class="linenos">3198</span></a>                <span class="n">expanded</span><span class="p">,</span>
</span><span id="COMPsc-3199"><a href="#COMPsc-3199"><span class="linenos">3199</span></a>                <span class="n">closed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="COMPsc-3200"><a href="#COMPsc-3200"><span class="linenos">3200</span></a>                <span class="n">facecolor</span><span class="o">=</span><span class="n">cluster_palette</span><span class="p">[</span><span class="n">label</span><span class="p">],</span>
</span><span id="COMPsc-3201"><a href="#COMPsc-3201"><span class="linenos">3201</span></a>                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3202"><a href="#COMPsc-3202"><span class="linenos">3202</span></a>                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span><span id="COMPsc-3203"><a href="#COMPsc-3203"><span class="linenos">3203</span></a>                <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc-3204"><a href="#COMPsc-3204"><span class="linenos">3204</span></a>            <span class="p">)</span>
</span><span id="COMPsc-3205"><a href="#COMPsc-3205"><span class="linenos">3205</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
</span><span id="COMPsc-3206"><a href="#COMPsc-3206"><span class="linenos">3206</span></a>
</span><span id="COMPsc-3207"><a href="#COMPsc-3207"><span class="linenos">3207</span></a>        <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc-3208"><a href="#COMPsc-3208"><span class="linenos">3208</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
</span><span id="COMPsc-3209"><a href="#COMPsc-3209"><span class="linenos">3209</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="COMPsc-3210"><a href="#COMPsc-3210"><span class="linenos">3210</span></a>                <span class="n">x</span><span class="p">,</span>
</span><span id="COMPsc-3211"><a href="#COMPsc-3211"><span class="linenos">3211</span></a>                <span class="n">y</span><span class="p">,</span>
</span><span id="COMPsc-3212"><a href="#COMPsc-3212"><span class="linenos">3212</span></a>                <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span>
</span><span id="COMPsc-3213"><a href="#COMPsc-3213"><span class="linenos">3213</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">color_mapping</span><span class="p">[</span><span class="n">cell_names</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
</span><span id="COMPsc-3214"><a href="#COMPsc-3214"><span class="linenos">3214</span></a>                <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3215"><a href="#COMPsc-3215"><span class="linenos">3215</span></a>                <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="COMPsc-3216"><a href="#COMPsc-3216"><span class="linenos">3216</span></a>                <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="COMPsc-3217"><a href="#COMPsc-3217"><span class="linenos">3217</span></a>            <span class="p">)</span>
</span><span id="COMPsc-3218"><a href="#COMPsc-3218"><span class="linenos">3218</span></a>            <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="COMPsc-3219"><a href="#COMPsc-3219"><span class="linenos">3219</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="COMPsc-3220"><a href="#COMPsc-3220"><span class="linenos">3220</span></a>                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span>
</span><span id="COMPsc-3221"><a href="#COMPsc-3221"><span class="linenos">3221</span></a>                <span class="p">)</span>
</span><span id="COMPsc-3222"><a href="#COMPsc-3222"><span class="linenos">3222</span></a>            <span class="p">)</span>
</span><span id="COMPsc-3223"><a href="#COMPsc-3223"><span class="linenos">3223</span></a>
</span><span id="COMPsc-3224"><a href="#COMPsc-3224"><span class="linenos">3224</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">dist</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
</span><span id="COMPsc-3225"><a href="#COMPsc-3225"><span class="linenos">3225</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="COMPsc-3226"><a href="#COMPsc-3226"><span class="linenos">3226</span></a>
</span><span id="COMPsc-3227"><a href="#COMPsc-3227"><span class="linenos">3227</span></a>        <span class="n">texts_to_adjust</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc-3228"><a href="#COMPsc-3228"><span class="linenos">3228</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
</span><span id="COMPsc-3229"><a href="#COMPsc-3229"><span class="linenos">3229</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">t2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
</span><span id="COMPsc-3230"><a href="#COMPsc-3230"><span class="linenos">3230</span></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">j</span><span class="p">:</span>
</span><span id="COMPsc-3231"><a href="#COMPsc-3231"><span class="linenos">3231</span></a>                    <span class="k">continue</span>
</span><span id="COMPsc-3232"><a href="#COMPsc-3232"><span class="linenos">3232</span></a>                <span class="n">d</span> <span class="o">=</span> <span class="n">dist</span><span class="p">(</span>
</span><span id="COMPsc-3233"><a href="#COMPsc-3233"><span class="linenos">3233</span></a>                    <span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">get_position</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t1</span><span class="o">.</span><span class="n">get_position</span><span class="p">()[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="COMPsc-3234"><a href="#COMPsc-3234"><span class="linenos">3234</span></a>                    <span class="p">(</span><span class="n">t2</span><span class="o">.</span><span class="n">get_position</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t2</span><span class="o">.</span><span class="n">get_position</span><span class="p">()[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="COMPsc-3235"><a href="#COMPsc-3235"><span class="linenos">3235</span></a>                <span class="p">)</span>
</span><span id="COMPsc-3236"><a href="#COMPsc-3236"><span class="linenos">3236</span></a>                <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="COMPsc-3237"><a href="#COMPsc-3237"><span class="linenos">3237</span></a>                    <span class="k">if</span> <span class="n">t1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">texts_to_adjust</span><span class="p">:</span>
</span><span id="COMPsc-3238"><a href="#COMPsc-3238"><span class="linenos">3238</span></a>                        <span class="n">texts_to_adjust</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
</span><span id="COMPsc-3239"><a href="#COMPsc-3239"><span class="linenos">3239</span></a>                    <span class="k">if</span> <span class="n">t2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">texts_to_adjust</span><span class="p">:</span>
</span><span id="COMPsc-3240"><a href="#COMPsc-3240"><span class="linenos">3240</span></a>                        <span class="n">texts_to_adjust</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
</span><span id="COMPsc-3241"><a href="#COMPsc-3241"><span class="linenos">3241</span></a>
</span><span id="COMPsc-3242"><a href="#COMPsc-3242"><span class="linenos">3242</span></a>        <span class="n">adjust_text</span><span class="p">(</span>
</span><span id="COMPsc-3243"><a href="#COMPsc-3243"><span class="linenos">3243</span></a>            <span class="n">texts_to_adjust</span><span class="p">,</span>
</span><span id="COMPsc-3244"><a href="#COMPsc-3244"><span class="linenos">3244</span></a>            <span class="n">expand_text</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
</span><span id="COMPsc-3245"><a href="#COMPsc-3245"><span class="linenos">3245</span></a>            <span class="n">force_text</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
</span><span id="COMPsc-3246"><a href="#COMPsc-3246"><span class="linenos">3246</span></a>            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span>
</span><span id="COMPsc-3247"><a href="#COMPsc-3247"><span class="linenos">3247</span></a>            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
</span><span id="COMPsc-3248"><a href="#COMPsc-3248"><span class="linenos">3248</span></a>        <span class="p">)</span>
</span><span id="COMPsc-3249"><a href="#COMPsc-3249"><span class="linenos">3249</span></a>
</span><span id="COMPsc-3250"><a href="#COMPsc-3250"><span class="linenos">3250</span></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">arrow_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="COMPsc-3251"><a href="#COMPsc-3251"><span class="linenos">3251</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="COMPsc-3252"><a href="#COMPsc-3252"><span class="linenos">3252</span></a>                <span class="n">idx1</span> <span class="o">=</span> <span class="n">cell_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">])</span>
</span><span id="COMPsc-3253"><a href="#COMPsc-3253"><span class="linenos">3253</span></a>                <span class="n">idx2</span> <span class="o">=</span> <span class="n">cell_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">])</span>
</span><span id="COMPsc-3254"><a href="#COMPsc-3254"><span class="linenos">3254</span></a>            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="COMPsc-3255"><a href="#COMPsc-3255"><span class="linenos">3255</span></a>                <span class="k">continue</span>
</span><span id="COMPsc-3256"><a href="#COMPsc-3256"><span class="linenos">3256</span></a>            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span>
</span><span id="COMPsc-3257"><a href="#COMPsc-3257"><span class="linenos">3257</span></a>            <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span>
</span><span id="COMPsc-3258"><a href="#COMPsc-3258"><span class="linenos">3258</span></a>            <span class="n">arrow</span> <span class="o">=</span> <span class="n">FancyArrowPatch</span><span class="p">(</span>
</span><span id="COMPsc-3259"><a href="#COMPsc-3259"><span class="linenos">3259</span></a>                <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span>
</span><span id="COMPsc-3260"><a href="#COMPsc-3260"><span class="linenos">3260</span></a>                <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span>
</span><span id="COMPsc-3261"><a href="#COMPsc-3261"><span class="linenos">3261</span></a>                <span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3262"><a href="#COMPsc-3262"><span class="linenos">3262</span></a>                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3263"><a href="#COMPsc-3263"><span class="linenos">3263</span></a>                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
</span><span id="COMPsc-3264"><a href="#COMPsc-3264"><span class="linenos">3264</span></a>                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="COMPsc-3265"><a href="#COMPsc-3265"><span class="linenos">3265</span></a>                <span class="n">mutation_scale</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="COMPsc-3266"><a href="#COMPsc-3266"><span class="linenos">3266</span></a>                <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="COMPsc-3267"><a href="#COMPsc-3267"><span class="linenos">3267</span></a>            <span class="p">)</span>
</span><span id="COMPsc-3268"><a href="#COMPsc-3268"><span class="linenos">3268</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">arrow</span><span class="p">)</span>
</span><span id="COMPsc-3269"><a href="#COMPsc-3269"><span class="linenos">3269</span></a>
</span><span id="COMPsc-3270"><a href="#COMPsc-3270"><span class="linenos">3270</span></a>        <span class="k">if</span> <span class="n">set_info</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="s2">&quot; # &quot;</span> <span class="ow">in</span> <span class="n">cell_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="COMPsc-3271"><a href="#COMPsc-3271"><span class="linenos">3271</span></a>
</span><span id="COMPsc-3272"><a href="#COMPsc-3272"><span class="linenos">3272</span></a>            <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc-3273"><a href="#COMPsc-3273"><span class="linenos">3273</span></a>                <span class="n">Patch</span><span class="p">(</span>
</span><span id="COMPsc-3274"><a href="#COMPsc-3274"><span class="linenos">3274</span></a>                    <span class="n">facecolor</span><span class="o">=</span><span class="n">color_mapping</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
</span><span id="COMPsc-3275"><a href="#COMPsc-3275"><span class="linenos">3275</span></a>                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3276"><a href="#COMPsc-3276"><span class="linenos">3276</span></a>                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> – </span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; #.*&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3277"><a href="#COMPsc-3277"><span class="linenos">3277</span></a>                <span class="p">)</span>
</span><span id="COMPsc-3278"><a href="#COMPsc-3278"><span class="linenos">3278</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cell_names</span><span class="p">)</span>
</span><span id="COMPsc-3279"><a href="#COMPsc-3279"><span class="linenos">3279</span></a>            <span class="p">]</span>
</span><span id="COMPsc-3280"><a href="#COMPsc-3280"><span class="linenos">3280</span></a>
</span><span id="COMPsc-3281"><a href="#COMPsc-3281"><span class="linenos">3281</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-3282"><a href="#COMPsc-3282"><span class="linenos">3282</span></a>
</span><span id="COMPsc-3283"><a href="#COMPsc-3283"><span class="linenos">3283</span></a>            <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc-3284"><a href="#COMPsc-3284"><span class="linenos">3284</span></a>                <span class="n">Patch</span><span class="p">(</span>
</span><span id="COMPsc-3285"><a href="#COMPsc-3285"><span class="linenos">3285</span></a>                    <span class="n">facecolor</span><span class="o">=</span><span class="n">color_mapping</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
</span><span id="COMPsc-3286"><a href="#COMPsc-3286"><span class="linenos">3286</span></a>                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3287"><a href="#COMPsc-3287"><span class="linenos">3287</span></a>                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> – </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3288"><a href="#COMPsc-3288"><span class="linenos">3288</span></a>                <span class="p">)</span>
</span><span id="COMPsc-3289"><a href="#COMPsc-3289"><span class="linenos">3289</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cell_names</span><span class="p">)</span>
</span><span id="COMPsc-3290"><a href="#COMPsc-3290"><span class="linenos">3290</span></a>            <span class="p">]</span>
</span><span id="COMPsc-3291"><a href="#COMPsc-3291"><span class="linenos">3291</span></a>
</span><span id="COMPsc-3292"><a href="#COMPsc-3292"><span class="linenos">3292</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="COMPsc-3293"><a href="#COMPsc-3293"><span class="linenos">3293</span></a>            <span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span>
</span><span id="COMPsc-3294"><a href="#COMPsc-3294"><span class="linenos">3294</span></a>            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Cells&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3295"><a href="#COMPsc-3295"><span class="linenos">3295</span></a>            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="COMPsc-3296"><a href="#COMPsc-3296"><span class="linenos">3296</span></a>            <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3297"><a href="#COMPsc-3297"><span class="linenos">3297</span></a>            <span class="n">ncol</span><span class="o">=</span><span class="n">legend_split</span><span class="p">,</span>
</span><span id="COMPsc-3298"><a href="#COMPsc-3298"><span class="linenos">3298</span></a>        <span class="p">)</span>
</span><span id="COMPsc-3299"><a href="#COMPsc-3299"><span class="linenos">3299</span></a>
</span><span id="COMPsc-3300"><a href="#COMPsc-3300"><span class="linenos">3300</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">)</span>
</span><span id="COMPsc-3301"><a href="#COMPsc-3301"><span class="linenos">3301</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">)</span>
</span><span id="COMPsc-3302"><a href="#COMPsc-3302"><span class="linenos">3302</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="COMPsc-3303"><a href="#COMPsc-3303"><span class="linenos">3303</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="COMPsc-3304"><a href="#COMPsc-3304"><span class="linenos">3304</span></a>
</span><span id="COMPsc-3305"><a href="#COMPsc-3305"><span class="linenos">3305</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="COMPsc-3306"><a href="#COMPsc-3306"><span class="linenos">3306</span></a>
</span><span id="COMPsc-3307"><a href="#COMPsc-3307"><span class="linenos">3307</span></a>    <span class="c1"># subclusters part</span>
</span><span id="COMPsc-3308"><a href="#COMPsc-3308"><span class="linenos">3308</span></a>
</span><span id="COMPsc-3309"><a href="#COMPsc-3309"><span class="linenos">3309</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">subcluster_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">cluster</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="COMPsc-3310"><a href="#COMPsc-3310"><span class="linenos">3310</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-3311"><a href="#COMPsc-3311"><span class="linenos">3311</span></a><span class="sd">        Prepare a `Clustering` object for subcluster analysis on a selected parent cluster.</span>
</span><span id="COMPsc-3312"><a href="#COMPsc-3312"><span class="linenos">3312</span></a>
</span><span id="COMPsc-3313"><a href="#COMPsc-3313"><span class="linenos">3313</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-3314"><a href="#COMPsc-3314"><span class="linenos">3314</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-3315"><a href="#COMPsc-3315"><span class="linenos">3315</span></a><span class="sd">        features : list</span>
</span><span id="COMPsc-3316"><a href="#COMPsc-3316"><span class="linenos">3316</span></a><span class="sd">            Features to include for subcluster analysis.</span>
</span><span id="COMPsc-3317"><a href="#COMPsc-3317"><span class="linenos">3317</span></a>
</span><span id="COMPsc-3318"><a href="#COMPsc-3318"><span class="linenos">3318</span></a><span class="sd">        cluster : str</span>
</span><span id="COMPsc-3319"><a href="#COMPsc-3319"><span class="linenos">3319</span></a><span class="sd">            Parent cluster name (used to select matching cells).</span>
</span><span id="COMPsc-3320"><a href="#COMPsc-3320"><span class="linenos">3320</span></a>
</span><span id="COMPsc-3321"><a href="#COMPsc-3321"><span class="linenos">3321</span></a><span class="sd">        Update</span>
</span><span id="COMPsc-3322"><a href="#COMPsc-3322"><span class="linenos">3322</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-3323"><a href="#COMPsc-3323"><span class="linenos">3323</span></a><span class="sd">        Initializes `self.subclusters_` as a new `Clustering` instance containing the</span>
</span><span id="COMPsc-3324"><a href="#COMPsc-3324"><span class="linenos">3324</span></a><span class="sd">        reduced data for the given cluster and stores `current_features` and `current_cluster`.</span>
</span><span id="COMPsc-3325"><a href="#COMPsc-3325"><span class="linenos">3325</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-3326"><a href="#COMPsc-3326"><span class="linenos">3326</span></a>
</span><span id="COMPsc-3327"><a href="#COMPsc-3327"><span class="linenos">3327</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span>
</span><span id="COMPsc-3328"><a href="#COMPsc-3328"><span class="linenos">3328</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">])</span>
</span><span id="COMPsc-3329"><a href="#COMPsc-3329"><span class="linenos">3329</span></a>
</span><span id="COMPsc-3330"><a href="#COMPsc-3330"><span class="linenos">3330</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="n">reduce_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="n">cluster</span><span class="p">])</span>
</span><span id="COMPsc-3331"><a href="#COMPsc-3331"><span class="linenos">3331</span></a>
</span><span id="COMPsc-3332"><a href="#COMPsc-3332"><span class="linenos">3332</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="o">=</span> <span class="n">Clustering</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="COMPsc-3333"><a href="#COMPsc-3333"><span class="linenos">3333</span></a>
</span><span id="COMPsc-3334"><a href="#COMPsc-3334"><span class="linenos">3334</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">current_features</span> <span class="o">=</span> <span class="n">features</span>
</span><span id="COMPsc-3335"><a href="#COMPsc-3335"><span class="linenos">3335</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">current_cluster</span> <span class="o">=</span> <span class="n">cluster</span>
</span><span id="COMPsc-3336"><a href="#COMPsc-3336"><span class="linenos">3336</span></a>
</span><span id="COMPsc-3337"><a href="#COMPsc-3337"><span class="linenos">3337</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_subclusters</span><span class="p">(</span>
</span><span id="COMPsc-3338"><a href="#COMPsc-3338"><span class="linenos">3338</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc-3339"><a href="#COMPsc-3339"><span class="linenos">3339</span></a>        <span class="n">umap_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="COMPsc-3340"><a href="#COMPsc-3340"><span class="linenos">3340</span></a>        <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="COMPsc-3341"><a href="#COMPsc-3341"><span class="linenos">3341</span></a>        <span class="n">min_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="COMPsc-3342"><a href="#COMPsc-3342"><span class="linenos">3342</span></a>        <span class="n">n_neighbors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="COMPsc-3343"><a href="#COMPsc-3343"><span class="linenos">3343</span></a>        <span class="n">min_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="COMPsc-3344"><a href="#COMPsc-3344"><span class="linenos">3344</span></a>        <span class="n">spread</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="COMPsc-3345"><a href="#COMPsc-3345"><span class="linenos">3345</span></a>        <span class="n">set_op_mix_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="COMPsc-3346"><a href="#COMPsc-3346"><span class="linenos">3346</span></a>        <span class="n">local_connectivity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc-3347"><a href="#COMPsc-3347"><span class="linenos">3347</span></a>        <span class="n">repulsion_strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="COMPsc-3348"><a href="#COMPsc-3348"><span class="linenos">3348</span></a>        <span class="n">negative_sample_rate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="COMPsc-3349"><a href="#COMPsc-3349"><span class="linenos">3349</span></a>        <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="COMPsc-3350"><a href="#COMPsc-3350"><span class="linenos">3350</span></a>        <span class="n">height</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="COMPsc-3351"><a href="#COMPsc-3351"><span class="linenos">3351</span></a>    <span class="p">):</span>
</span><span id="COMPsc-3352"><a href="#COMPsc-3352"><span class="linenos">3352</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-3353"><a href="#COMPsc-3353"><span class="linenos">3353</span></a><span class="sd">        Compute UMAP and DBSCAN clustering within a previously prepared subcluster dataset.</span>
</span><span id="COMPsc-3354"><a href="#COMPsc-3354"><span class="linenos">3354</span></a>
</span><span id="COMPsc-3355"><a href="#COMPsc-3355"><span class="linenos">3355</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-3356"><a href="#COMPsc-3356"><span class="linenos">3356</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-3357"><a href="#COMPsc-3357"><span class="linenos">3357</span></a><span class="sd">        umap_num : int, default 2</span>
</span><span id="COMPsc-3358"><a href="#COMPsc-3358"><span class="linenos">3358</span></a><span class="sd">            Number of UMAP dimensions to compute.</span>
</span><span id="COMPsc-3359"><a href="#COMPsc-3359"><span class="linenos">3359</span></a>
</span><span id="COMPsc-3360"><a href="#COMPsc-3360"><span class="linenos">3360</span></a><span class="sd">        eps : float, default 0.5</span>
</span><span id="COMPsc-3361"><a href="#COMPsc-3361"><span class="linenos">3361</span></a><span class="sd">            DBSCAN eps parameter.</span>
</span><span id="COMPsc-3362"><a href="#COMPsc-3362"><span class="linenos">3362</span></a>
</span><span id="COMPsc-3363"><a href="#COMPsc-3363"><span class="linenos">3363</span></a><span class="sd">        min_samples : int, default 10</span>
</span><span id="COMPsc-3364"><a href="#COMPsc-3364"><span class="linenos">3364</span></a><span class="sd">            DBSCAN min_samples parameter.</span>
</span><span id="COMPsc-3365"><a href="#COMPsc-3365"><span class="linenos">3365</span></a>
</span><span id="COMPsc-3366"><a href="#COMPsc-3366"><span class="linenos">3366</span></a><span class="sd">        n_neighbors, min_dist, spread, set_op_mix_ratio, local_connectivity, repulsion_strength, negative_sample_rate, width, height :</span>
</span><span id="COMPsc-3367"><a href="#COMPsc-3367"><span class="linenos">3367</span></a><span class="sd">            Additional parameters passed to UMAP / plotting / MeanShift as appropriate.</span>
</span><span id="COMPsc-3368"><a href="#COMPsc-3368"><span class="linenos">3368</span></a>
</span><span id="COMPsc-3369"><a href="#COMPsc-3369"><span class="linenos">3369</span></a><span class="sd">        Update</span>
</span><span id="COMPsc-3370"><a href="#COMPsc-3370"><span class="linenos">3370</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-3371"><a href="#COMPsc-3371"><span class="linenos">3371</span></a><span class="sd">        Stores cluster labels in `self.subclusters_.subclusters`.</span>
</span><span id="COMPsc-3372"><a href="#COMPsc-3372"><span class="linenos">3372</span></a>
</span><span id="COMPsc-3373"><a href="#COMPsc-3373"><span class="linenos">3373</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc-3374"><a href="#COMPsc-3374"><span class="linenos">3374</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-3375"><a href="#COMPsc-3375"><span class="linenos">3375</span></a><span class="sd">        RuntimeError</span>
</span><span id="COMPsc-3376"><a href="#COMPsc-3376"><span class="linenos">3376</span></a><span class="sd">            If `self.subclusters_` has not been prepared.</span>
</span><span id="COMPsc-3377"><a href="#COMPsc-3377"><span class="linenos">3377</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-3378"><a href="#COMPsc-3378"><span class="linenos">3378</span></a>
</span><span id="COMPsc-3379"><a href="#COMPsc-3379"><span class="linenos">3379</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-3380"><a href="#COMPsc-3380"><span class="linenos">3380</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="COMPsc-3381"><a href="#COMPsc-3381"><span class="linenos">3381</span></a>                <span class="s2">&quot;Nothing to return. &#39;self.subcluster_prepare&#39; was not conducted!&quot;</span>
</span><span id="COMPsc-3382"><a href="#COMPsc-3382"><span class="linenos">3382</span></a>            <span class="p">)</span>
</span><span id="COMPsc-3383"><a href="#COMPsc-3383"><span class="linenos">3383</span></a>
</span><span id="COMPsc-3384"><a href="#COMPsc-3384"><span class="linenos">3384</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">perform_UMAP</span><span class="p">(</span>
</span><span id="COMPsc-3385"><a href="#COMPsc-3385"><span class="linenos">3385</span></a>            <span class="n">factorize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="COMPsc-3386"><a href="#COMPsc-3386"><span class="linenos">3386</span></a>            <span class="n">umap_num</span><span class="o">=</span><span class="n">umap_num</span><span class="p">,</span>
</span><span id="COMPsc-3387"><a href="#COMPsc-3387"><span class="linenos">3387</span></a>            <span class="n">pc_num</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="COMPsc-3388"><a href="#COMPsc-3388"><span class="linenos">3388</span></a>            <span class="n">harmonized</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="COMPsc-3389"><a href="#COMPsc-3389"><span class="linenos">3389</span></a>            <span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">,</span>
</span><span id="COMPsc-3390"><a href="#COMPsc-3390"><span class="linenos">3390</span></a>            <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span>
</span><span id="COMPsc-3391"><a href="#COMPsc-3391"><span class="linenos">3391</span></a>            <span class="n">spread</span><span class="o">=</span><span class="n">spread</span><span class="p">,</span>
</span><span id="COMPsc-3392"><a href="#COMPsc-3392"><span class="linenos">3392</span></a>            <span class="n">set_op_mix_ratio</span><span class="o">=</span><span class="n">set_op_mix_ratio</span><span class="p">,</span>
</span><span id="COMPsc-3393"><a href="#COMPsc-3393"><span class="linenos">3393</span></a>            <span class="n">local_connectivity</span><span class="o">=</span><span class="n">local_connectivity</span><span class="p">,</span>
</span><span id="COMPsc-3394"><a href="#COMPsc-3394"><span class="linenos">3394</span></a>            <span class="n">repulsion_strength</span><span class="o">=</span><span class="n">repulsion_strength</span><span class="p">,</span>
</span><span id="COMPsc-3395"><a href="#COMPsc-3395"><span class="linenos">3395</span></a>            <span class="n">negative_sample_rate</span><span class="o">=</span><span class="n">negative_sample_rate</span><span class="p">,</span>
</span><span id="COMPsc-3396"><a href="#COMPsc-3396"><span class="linenos">3396</span></a>            <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
</span><span id="COMPsc-3397"><a href="#COMPsc-3397"><span class="linenos">3397</span></a>            <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
</span><span id="COMPsc-3398"><a href="#COMPsc-3398"><span class="linenos">3398</span></a>        <span class="p">)</span>
</span><span id="COMPsc-3399"><a href="#COMPsc-3399"><span class="linenos">3399</span></a>
</span><span id="COMPsc-3400"><a href="#COMPsc-3400"><span class="linenos">3400</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">find_clusters_UMAP</span><span class="p">(</span>
</span><span id="COMPsc-3401"><a href="#COMPsc-3401"><span class="linenos">3401</span></a>            <span class="n">umap_n</span><span class="o">=</span><span class="n">umap_num</span><span class="p">,</span>
</span><span id="COMPsc-3402"><a href="#COMPsc-3402"><span class="linenos">3402</span></a>            <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span>
</span><span id="COMPsc-3403"><a href="#COMPsc-3403"><span class="linenos">3403</span></a>            <span class="n">min_samples</span><span class="o">=</span><span class="n">min_samples</span><span class="p">,</span>
</span><span id="COMPsc-3404"><a href="#COMPsc-3404"><span class="linenos">3404</span></a>            <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
</span><span id="COMPsc-3405"><a href="#COMPsc-3405"><span class="linenos">3405</span></a>            <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
</span><span id="COMPsc-3406"><a href="#COMPsc-3406"><span class="linenos">3406</span></a>        <span class="p">)</span>
</span><span id="COMPsc-3407"><a href="#COMPsc-3407"><span class="linenos">3407</span></a>
</span><span id="COMPsc-3408"><a href="#COMPsc-3408"><span class="linenos">3408</span></a>        <span class="n">clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">return_clusters</span><span class="p">(</span><span class="n">clusters</span><span class="o">=</span><span class="s2">&quot;umap&quot;</span><span class="p">)</span>
</span><span id="COMPsc-3409"><a href="#COMPsc-3409"><span class="linenos">3409</span></a>
</span><span id="COMPsc-3410"><a href="#COMPsc-3410"><span class="linenos">3410</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">clusters</span><span class="p">)]</span>
</span><span id="COMPsc-3411"><a href="#COMPsc-3411"><span class="linenos">3411</span></a>
</span><span id="COMPsc-3412"><a href="#COMPsc-3412"><span class="linenos">3412</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="COMPsc-3413"><a href="#COMPsc-3413"><span class="linenos">3413</span></a>
</span><span id="COMPsc-3414"><a href="#COMPsc-3414"><span class="linenos">3414</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">subcluster_features_scatter</span><span class="p">(</span>
</span><span id="COMPsc-3415"><a href="#COMPsc-3415"><span class="linenos">3415</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc-3416"><a href="#COMPsc-3416"><span class="linenos">3416</span></a>        <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3417"><a href="#COMPsc-3417"><span class="linenos">3417</span></a>        <span class="n">hclust</span><span class="o">=</span><span class="s2">&quot;complete&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3418"><a href="#COMPsc-3418"><span class="linenos">3418</span></a>        <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="COMPsc-3419"><a href="#COMPsc-3419"><span class="linenos">3419</span></a>        <span class="n">img_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="COMPsc-3420"><a href="#COMPsc-3420"><span class="linenos">3420</span></a>        <span class="n">img_high</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="COMPsc-3421"><a href="#COMPsc-3421"><span class="linenos">3421</span></a>        <span class="n">label_size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="COMPsc-3422"><a href="#COMPsc-3422"><span class="linenos">3422</span></a>        <span class="n">size_scale</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span>
</span><span id="COMPsc-3423"><a href="#COMPsc-3423"><span class="linenos">3423</span></a>        <span class="n">y_lab</span><span class="o">=</span><span class="s2">&quot;Genes&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3424"><a href="#COMPsc-3424"><span class="linenos">3424</span></a>        <span class="n">legend_lab</span><span class="o">=</span><span class="s2">&quot;normalized&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3425"><a href="#COMPsc-3425"><span class="linenos">3425</span></a>        <span class="n">bbox_to_anchor_scale</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
</span><span id="COMPsc-3426"><a href="#COMPsc-3426"><span class="linenos">3426</span></a>        <span class="n">bbox_to_anchor_perc</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.91</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">),</span>
</span><span id="COMPsc-3427"><a href="#COMPsc-3427"><span class="linenos">3427</span></a>    <span class="p">):</span>
</span><span id="COMPsc-3428"><a href="#COMPsc-3428"><span class="linenos">3428</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-3429"><a href="#COMPsc-3429"><span class="linenos">3429</span></a><span class="sd">        Create a features-scatter visualization for the subclusters (averaged and occurrence).</span>
</span><span id="COMPsc-3430"><a href="#COMPsc-3430"><span class="linenos">3430</span></a>
</span><span id="COMPsc-3431"><a href="#COMPsc-3431"><span class="linenos">3431</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-3432"><a href="#COMPsc-3432"><span class="linenos">3432</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-3433"><a href="#COMPsc-3433"><span class="linenos">3433</span></a><span class="sd">        colors : str, default &#39;viridis&#39;</span>
</span><span id="COMPsc-3434"><a href="#COMPsc-3434"><span class="linenos">3434</span></a><span class="sd">            Colormap name passed to `features_scatter`.</span>
</span><span id="COMPsc-3435"><a href="#COMPsc-3435"><span class="linenos">3435</span></a>
</span><span id="COMPsc-3436"><a href="#COMPsc-3436"><span class="linenos">3436</span></a><span class="sd">        hclust : str or None</span>
</span><span id="COMPsc-3437"><a href="#COMPsc-3437"><span class="linenos">3437</span></a><span class="sd">            Hierarchical clustering linkage to order rows/columns.</span>
</span><span id="COMPsc-3438"><a href="#COMPsc-3438"><span class="linenos">3438</span></a>
</span><span id="COMPsc-3439"><a href="#COMPsc-3439"><span class="linenos">3439</span></a><span class="sd">        scale: bool, default False</span>
</span><span id="COMPsc-3440"><a href="#COMPsc-3440"><span class="linenos">3440</span></a><span class="sd">            If True, expression data will be scaled (0–1) across the rows (features).</span>
</span><span id="COMPsc-3441"><a href="#COMPsc-3441"><span class="linenos">3441</span></a>
</span><span id="COMPsc-3442"><a href="#COMPsc-3442"><span class="linenos">3442</span></a><span class="sd">        img_width, img_high : float</span>
</span><span id="COMPsc-3443"><a href="#COMPsc-3443"><span class="linenos">3443</span></a><span class="sd">            Figure size.</span>
</span><span id="COMPsc-3444"><a href="#COMPsc-3444"><span class="linenos">3444</span></a>
</span><span id="COMPsc-3445"><a href="#COMPsc-3445"><span class="linenos">3445</span></a><span class="sd">        label_size : int</span>
</span><span id="COMPsc-3446"><a href="#COMPsc-3446"><span class="linenos">3446</span></a><span class="sd">            Font size for labels.</span>
</span><span id="COMPsc-3447"><a href="#COMPsc-3447"><span class="linenos">3447</span></a>
</span><span id="COMPsc-3448"><a href="#COMPsc-3448"><span class="linenos">3448</span></a><span class="sd">        size_scale : int</span>
</span><span id="COMPsc-3449"><a href="#COMPsc-3449"><span class="linenos">3449</span></a><span class="sd">            Bubble size scaling.</span>
</span><span id="COMPsc-3450"><a href="#COMPsc-3450"><span class="linenos">3450</span></a>
</span><span id="COMPsc-3451"><a href="#COMPsc-3451"><span class="linenos">3451</span></a><span class="sd">        y_lab : str</span>
</span><span id="COMPsc-3452"><a href="#COMPsc-3452"><span class="linenos">3452</span></a><span class="sd">            X axis label.</span>
</span><span id="COMPsc-3453"><a href="#COMPsc-3453"><span class="linenos">3453</span></a>
</span><span id="COMPsc-3454"><a href="#COMPsc-3454"><span class="linenos">3454</span></a><span class="sd">        legend_lab : str</span>
</span><span id="COMPsc-3455"><a href="#COMPsc-3455"><span class="linenos">3455</span></a><span class="sd">            Colorbar label.</span>
</span><span id="COMPsc-3456"><a href="#COMPsc-3456"><span class="linenos">3456</span></a>
</span><span id="COMPsc-3457"><a href="#COMPsc-3457"><span class="linenos">3457</span></a><span class="sd">        bbox_to_anchor_scale : int, default=25</span>
</span><span id="COMPsc-3458"><a href="#COMPsc-3458"><span class="linenos">3458</span></a><span class="sd">            Vertical scale (percentage) for positioning the colorbar.</span>
</span><span id="COMPsc-3459"><a href="#COMPsc-3459"><span class="linenos">3459</span></a>
</span><span id="COMPsc-3460"><a href="#COMPsc-3460"><span class="linenos">3460</span></a><span class="sd">        bbox_to_anchor_perc : tuple, default=(0.91, 0.63)</span>
</span><span id="COMPsc-3461"><a href="#COMPsc-3461"><span class="linenos">3461</span></a><span class="sd">            Anchor position for the size legend (percent bubble legend).</span>
</span><span id="COMPsc-3462"><a href="#COMPsc-3462"><span class="linenos">3462</span></a>
</span><span id="COMPsc-3463"><a href="#COMPsc-3463"><span class="linenos">3463</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc-3464"><a href="#COMPsc-3464"><span class="linenos">3464</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-3465"><a href="#COMPsc-3465"><span class="linenos">3465</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc-3466"><a href="#COMPsc-3466"><span class="linenos">3466</span></a>
</span><span id="COMPsc-3467"><a href="#COMPsc-3467"><span class="linenos">3467</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc-3468"><a href="#COMPsc-3468"><span class="linenos">3468</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-3469"><a href="#COMPsc-3469"><span class="linenos">3469</span></a><span class="sd">        RuntimeError</span>
</span><span id="COMPsc-3470"><a href="#COMPsc-3470"><span class="linenos">3470</span></a><span class="sd">            If subcluster preparation/definition has not been run.</span>
</span><span id="COMPsc-3471"><a href="#COMPsc-3471"><span class="linenos">3471</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-3472"><a href="#COMPsc-3472"><span class="linenos">3472</span></a>
</span><span id="COMPsc-3473"><a href="#COMPsc-3473"><span class="linenos">3473</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-3474"><a href="#COMPsc-3474"><span class="linenos">3474</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="COMPsc-3475"><a href="#COMPsc-3475"><span class="linenos">3475</span></a>                <span class="s2">&quot;Nothing to return. &#39;self.subcluster_prepare&#39; -&gt; &#39;self.define_subclusters&#39; pip was not conducted!&quot;</span>
</span><span id="COMPsc-3476"><a href="#COMPsc-3476"><span class="linenos">3476</span></a>            <span class="p">)</span>
</span><span id="COMPsc-3477"><a href="#COMPsc-3477"><span class="linenos">3477</span></a>
</span><span id="COMPsc-3478"><a href="#COMPsc-3478"><span class="linenos">3478</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span>
</span><span id="COMPsc-3479"><a href="#COMPsc-3479"><span class="linenos">3479</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">])</span>
</span><span id="COMPsc-3480"><a href="#COMPsc-3480"><span class="linenos">3480</span></a>
</span><span id="COMPsc-3481"><a href="#COMPsc-3481"><span class="linenos">3481</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="n">reduce_data</span><span class="p">(</span>
</span><span id="COMPsc-3482"><a href="#COMPsc-3482"><span class="linenos">3482</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="p">,</span>
</span><span id="COMPsc-3483"><a href="#COMPsc-3483"><span class="linenos">3483</span></a>            <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">current_features</span><span class="p">,</span>
</span><span id="COMPsc-3484"><a href="#COMPsc-3484"><span class="linenos">3484</span></a>            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">current_cluster</span><span class="p">],</span>
</span><span id="COMPsc-3485"><a href="#COMPsc-3485"><span class="linenos">3485</span></a>        <span class="p">)</span>
</span><span id="COMPsc-3486"><a href="#COMPsc-3486"><span class="linenos">3486</span></a>
</span><span id="COMPsc-3487"><a href="#COMPsc-3487"><span class="linenos">3487</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span>
</span><span id="COMPsc-3488"><a href="#COMPsc-3488"><span class="linenos">3488</span></a>
</span><span id="COMPsc-3489"><a href="#COMPsc-3489"><span class="linenos">3489</span></a>        <span class="n">avg</span> <span class="o">=</span> <span class="n">average</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="COMPsc-3490"><a href="#COMPsc-3490"><span class="linenos">3490</span></a>        <span class="n">occ</span> <span class="o">=</span> <span class="n">occurrence</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="COMPsc-3491"><a href="#COMPsc-3491"><span class="linenos">3491</span></a>
</span><span id="COMPsc-3492"><a href="#COMPsc-3492"><span class="linenos">3492</span></a>        <span class="n">scatter</span> <span class="o">=</span> <span class="n">features_scatter</span><span class="p">(</span>
</span><span id="COMPsc-3493"><a href="#COMPsc-3493"><span class="linenos">3493</span></a>            <span class="n">expression_data</span><span class="o">=</span><span class="n">avg</span><span class="p">,</span>
</span><span id="COMPsc-3494"><a href="#COMPsc-3494"><span class="linenos">3494</span></a>            <span class="n">occurence_data</span><span class="o">=</span><span class="n">occ</span><span class="p">,</span>
</span><span id="COMPsc-3495"><a href="#COMPsc-3495"><span class="linenos">3495</span></a>            <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-3496"><a href="#COMPsc-3496"><span class="linenos">3496</span></a>            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
</span><span id="COMPsc-3497"><a href="#COMPsc-3497"><span class="linenos">3497</span></a>            <span class="n">metadata_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-3498"><a href="#COMPsc-3498"><span class="linenos">3498</span></a>            <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
</span><span id="COMPsc-3499"><a href="#COMPsc-3499"><span class="linenos">3499</span></a>            <span class="n">hclust</span><span class="o">=</span><span class="n">hclust</span><span class="p">,</span>
</span><span id="COMPsc-3500"><a href="#COMPsc-3500"><span class="linenos">3500</span></a>            <span class="n">img_width</span><span class="o">=</span><span class="n">img_width</span><span class="p">,</span>
</span><span id="COMPsc-3501"><a href="#COMPsc-3501"><span class="linenos">3501</span></a>            <span class="n">img_high</span><span class="o">=</span><span class="n">img_high</span><span class="p">,</span>
</span><span id="COMPsc-3502"><a href="#COMPsc-3502"><span class="linenos">3502</span></a>            <span class="n">label_size</span><span class="o">=</span><span class="n">label_size</span><span class="p">,</span>
</span><span id="COMPsc-3503"><a href="#COMPsc-3503"><span class="linenos">3503</span></a>            <span class="n">size_scale</span><span class="o">=</span><span class="n">size_scale</span><span class="p">,</span>
</span><span id="COMPsc-3504"><a href="#COMPsc-3504"><span class="linenos">3504</span></a>            <span class="n">y_lab</span><span class="o">=</span><span class="n">y_lab</span><span class="p">,</span>
</span><span id="COMPsc-3505"><a href="#COMPsc-3505"><span class="linenos">3505</span></a>            <span class="n">legend_lab</span><span class="o">=</span><span class="n">legend_lab</span><span class="p">,</span>
</span><span id="COMPsc-3506"><a href="#COMPsc-3506"><span class="linenos">3506</span></a>            <span class="n">bbox_to_anchor_scale</span><span class="o">=</span><span class="n">bbox_to_anchor_scale</span><span class="p">,</span>
</span><span id="COMPsc-3507"><a href="#COMPsc-3507"><span class="linenos">3507</span></a>            <span class="n">bbox_to_anchor_perc</span><span class="o">=</span><span class="n">bbox_to_anchor_perc</span><span class="p">,</span>
</span><span id="COMPsc-3508"><a href="#COMPsc-3508"><span class="linenos">3508</span></a>        <span class="p">)</span>
</span><span id="COMPsc-3509"><a href="#COMPsc-3509"><span class="linenos">3509</span></a>
</span><span id="COMPsc-3510"><a href="#COMPsc-3510"><span class="linenos">3510</span></a>        <span class="k">return</span> <span class="n">scatter</span>
</span><span id="COMPsc-3511"><a href="#COMPsc-3511"><span class="linenos">3511</span></a>
</span><span id="COMPsc-3512"><a href="#COMPsc-3512"><span class="linenos">3512</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">subcluster_DEG_scatter</span><span class="p">(</span>
</span><span id="COMPsc-3513"><a href="#COMPsc-3513"><span class="linenos">3513</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc-3514"><a href="#COMPsc-3514"><span class="linenos">3514</span></a>        <span class="n">top_n</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="COMPsc-3515"><a href="#COMPsc-3515"><span class="linenos">3515</span></a>        <span class="n">min_exp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="COMPsc-3516"><a href="#COMPsc-3516"><span class="linenos">3516</span></a>        <span class="n">min_pct</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
</span><span id="COMPsc-3517"><a href="#COMPsc-3517"><span class="linenos">3517</span></a>        <span class="n">p_val</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
</span><span id="COMPsc-3518"><a href="#COMPsc-3518"><span class="linenos">3518</span></a>        <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3519"><a href="#COMPsc-3519"><span class="linenos">3519</span></a>        <span class="n">hclust</span><span class="o">=</span><span class="s2">&quot;complete&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3520"><a href="#COMPsc-3520"><span class="linenos">3520</span></a>        <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="COMPsc-3521"><a href="#COMPsc-3521"><span class="linenos">3521</span></a>        <span class="n">img_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="COMPsc-3522"><a href="#COMPsc-3522"><span class="linenos">3522</span></a>        <span class="n">img_high</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="COMPsc-3523"><a href="#COMPsc-3523"><span class="linenos">3523</span></a>        <span class="n">label_size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="COMPsc-3524"><a href="#COMPsc-3524"><span class="linenos">3524</span></a>        <span class="n">size_scale</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span>
</span><span id="COMPsc-3525"><a href="#COMPsc-3525"><span class="linenos">3525</span></a>        <span class="n">y_lab</span><span class="o">=</span><span class="s2">&quot;Genes&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3526"><a href="#COMPsc-3526"><span class="linenos">3526</span></a>        <span class="n">legend_lab</span><span class="o">=</span><span class="s2">&quot;normalized&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3527"><a href="#COMPsc-3527"><span class="linenos">3527</span></a>        <span class="n">bbox_to_anchor_scale</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
</span><span id="COMPsc-3528"><a href="#COMPsc-3528"><span class="linenos">3528</span></a>        <span class="n">bbox_to_anchor_perc</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.91</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">),</span>
</span><span id="COMPsc-3529"><a href="#COMPsc-3529"><span class="linenos">3529</span></a>        <span class="n">n_proc</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="COMPsc-3530"><a href="#COMPsc-3530"><span class="linenos">3530</span></a>    <span class="p">):</span>
</span><span id="COMPsc-3531"><a href="#COMPsc-3531"><span class="linenos">3531</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-3532"><a href="#COMPsc-3532"><span class="linenos">3532</span></a><span class="sd">        Plot top differential features (DEGs) for subclusters as a features-scatter.</span>
</span><span id="COMPsc-3533"><a href="#COMPsc-3533"><span class="linenos">3533</span></a>
</span><span id="COMPsc-3534"><a href="#COMPsc-3534"><span class="linenos">3534</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-3535"><a href="#COMPsc-3535"><span class="linenos">3535</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-3536"><a href="#COMPsc-3536"><span class="linenos">3536</span></a><span class="sd">        top_n : int, default 3</span>
</span><span id="COMPsc-3537"><a href="#COMPsc-3537"><span class="linenos">3537</span></a><span class="sd">            Number of top features per subcluster to show.</span>
</span><span id="COMPsc-3538"><a href="#COMPsc-3538"><span class="linenos">3538</span></a>
</span><span id="COMPsc-3539"><a href="#COMPsc-3539"><span class="linenos">3539</span></a><span class="sd">        min_exp : float, default 0</span>
</span><span id="COMPsc-3540"><a href="#COMPsc-3540"><span class="linenos">3540</span></a><span class="sd">            Minimum expression threshold passed to `statistic`.</span>
</span><span id="COMPsc-3541"><a href="#COMPsc-3541"><span class="linenos">3541</span></a>
</span><span id="COMPsc-3542"><a href="#COMPsc-3542"><span class="linenos">3542</span></a><span class="sd">        min_pct : float, default 0.25</span>
</span><span id="COMPsc-3543"><a href="#COMPsc-3543"><span class="linenos">3543</span></a><span class="sd">            Minimum percent expressed in target group.</span>
</span><span id="COMPsc-3544"><a href="#COMPsc-3544"><span class="linenos">3544</span></a>
</span><span id="COMPsc-3545"><a href="#COMPsc-3545"><span class="linenos">3545</span></a><span class="sd">        p_val: float, default 0.05</span>
</span><span id="COMPsc-3546"><a href="#COMPsc-3546"><span class="linenos">3546</span></a><span class="sd">            Maximum p-value for visualizing features.</span>
</span><span id="COMPsc-3547"><a href="#COMPsc-3547"><span class="linenos">3547</span></a>
</span><span id="COMPsc-3548"><a href="#COMPsc-3548"><span class="linenos">3548</span></a><span class="sd">        n_proc : int, default 10</span>
</span><span id="COMPsc-3549"><a href="#COMPsc-3549"><span class="linenos">3549</span></a><span class="sd">            Parallel jobs used for DEG calculation.</span>
</span><span id="COMPsc-3550"><a href="#COMPsc-3550"><span class="linenos">3550</span></a>
</span><span id="COMPsc-3551"><a href="#COMPsc-3551"><span class="linenos">3551</span></a><span class="sd">        scale: bool, default False</span>
</span><span id="COMPsc-3552"><a href="#COMPsc-3552"><span class="linenos">3552</span></a><span class="sd">            If True, expression_data will be scaled (0–1) across the rows (features).</span>
</span><span id="COMPsc-3553"><a href="#COMPsc-3553"><span class="linenos">3553</span></a>
</span><span id="COMPsc-3554"><a href="#COMPsc-3554"><span class="linenos">3554</span></a><span class="sd">        colors : str, default=&#39;viridis&#39;</span>
</span><span id="COMPsc-3555"><a href="#COMPsc-3555"><span class="linenos">3555</span></a><span class="sd">            Colormap for expression values.</span>
</span><span id="COMPsc-3556"><a href="#COMPsc-3556"><span class="linenos">3556</span></a>
</span><span id="COMPsc-3557"><a href="#COMPsc-3557"><span class="linenos">3557</span></a><span class="sd">        hclust : str or None, default=&#39;complete&#39;</span>
</span><span id="COMPsc-3558"><a href="#COMPsc-3558"><span class="linenos">3558</span></a><span class="sd">            Linkage method for hierarchical clustering. If None, no clustering</span>
</span><span id="COMPsc-3559"><a href="#COMPsc-3559"><span class="linenos">3559</span></a><span class="sd">            is performed.</span>
</span><span id="COMPsc-3560"><a href="#COMPsc-3560"><span class="linenos">3560</span></a>
</span><span id="COMPsc-3561"><a href="#COMPsc-3561"><span class="linenos">3561</span></a><span class="sd">        img_width : int or float, default=8</span>
</span><span id="COMPsc-3562"><a href="#COMPsc-3562"><span class="linenos">3562</span></a><span class="sd">            Width of the plot in inches.</span>
</span><span id="COMPsc-3563"><a href="#COMPsc-3563"><span class="linenos">3563</span></a>
</span><span id="COMPsc-3564"><a href="#COMPsc-3564"><span class="linenos">3564</span></a><span class="sd">        img_high : int or float, default=5</span>
</span><span id="COMPsc-3565"><a href="#COMPsc-3565"><span class="linenos">3565</span></a><span class="sd">            Height of the plot in inches.</span>
</span><span id="COMPsc-3566"><a href="#COMPsc-3566"><span class="linenos">3566</span></a>
</span><span id="COMPsc-3567"><a href="#COMPsc-3567"><span class="linenos">3567</span></a><span class="sd">        label_size : int, default=10</span>
</span><span id="COMPsc-3568"><a href="#COMPsc-3568"><span class="linenos">3568</span></a><span class="sd">            Font size for axis labels and ticks.</span>
</span><span id="COMPsc-3569"><a href="#COMPsc-3569"><span class="linenos">3569</span></a>
</span><span id="COMPsc-3570"><a href="#COMPsc-3570"><span class="linenos">3570</span></a><span class="sd">        size_scale : int or float, default=100</span>
</span><span id="COMPsc-3571"><a href="#COMPsc-3571"><span class="linenos">3571</span></a><span class="sd">            Scaling factor for bubble sizes.</span>
</span><span id="COMPsc-3572"><a href="#COMPsc-3572"><span class="linenos">3572</span></a>
</span><span id="COMPsc-3573"><a href="#COMPsc-3573"><span class="linenos">3573</span></a><span class="sd">        y_lab : str, default=&#39;Genes&#39;</span>
</span><span id="COMPsc-3574"><a href="#COMPsc-3574"><span class="linenos">3574</span></a><span class="sd">            Label for the x-axis.</span>
</span><span id="COMPsc-3575"><a href="#COMPsc-3575"><span class="linenos">3575</span></a>
</span><span id="COMPsc-3576"><a href="#COMPsc-3576"><span class="linenos">3576</span></a><span class="sd">        legend_lab : str, default=&#39;normalized&#39;</span>
</span><span id="COMPsc-3577"><a href="#COMPsc-3577"><span class="linenos">3577</span></a><span class="sd">            Label for the colorbar legend.</span>
</span><span id="COMPsc-3578"><a href="#COMPsc-3578"><span class="linenos">3578</span></a>
</span><span id="COMPsc-3579"><a href="#COMPsc-3579"><span class="linenos">3579</span></a><span class="sd">        bbox_to_anchor_scale : int, default=25</span>
</span><span id="COMPsc-3580"><a href="#COMPsc-3580"><span class="linenos">3580</span></a><span class="sd">            Vertical scale (percentage) for positioning the colorbar.</span>
</span><span id="COMPsc-3581"><a href="#COMPsc-3581"><span class="linenos">3581</span></a>
</span><span id="COMPsc-3582"><a href="#COMPsc-3582"><span class="linenos">3582</span></a><span class="sd">        bbox_to_anchor_perc : tuple, default=(0.91, 0.63)</span>
</span><span id="COMPsc-3583"><a href="#COMPsc-3583"><span class="linenos">3583</span></a><span class="sd">            Anchor position for the size legend (percent bubble legend).</span>
</span><span id="COMPsc-3584"><a href="#COMPsc-3584"><span class="linenos">3584</span></a>
</span><span id="COMPsc-3585"><a href="#COMPsc-3585"><span class="linenos">3585</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc-3586"><a href="#COMPsc-3586"><span class="linenos">3586</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-3587"><a href="#COMPsc-3587"><span class="linenos">3587</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc-3588"><a href="#COMPsc-3588"><span class="linenos">3588</span></a>
</span><span id="COMPsc-3589"><a href="#COMPsc-3589"><span class="linenos">3589</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc-3590"><a href="#COMPsc-3590"><span class="linenos">3590</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-3591"><a href="#COMPsc-3591"><span class="linenos">3591</span></a><span class="sd">        RuntimeError</span>
</span><span id="COMPsc-3592"><a href="#COMPsc-3592"><span class="linenos">3592</span></a><span class="sd">            If subcluster preparation/definition has not been run.</span>
</span><span id="COMPsc-3593"><a href="#COMPsc-3593"><span class="linenos">3593</span></a>
</span><span id="COMPsc-3594"><a href="#COMPsc-3594"><span class="linenos">3594</span></a><span class="sd">        Notes</span>
</span><span id="COMPsc-3595"><a href="#COMPsc-3595"><span class="linenos">3595</span></a><span class="sd">        -----</span>
</span><span id="COMPsc-3596"><a href="#COMPsc-3596"><span class="linenos">3596</span></a><span class="sd">        Internally calls `calc_DEG` (or equivalent) to obtain statistics, filters</span>
</span><span id="COMPsc-3597"><a href="#COMPsc-3597"><span class="linenos">3597</span></a><span class="sd">        by p-value and effect-size, selects top features per valid group and plots them.</span>
</span><span id="COMPsc-3598"><a href="#COMPsc-3598"><span class="linenos">3598</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-3599"><a href="#COMPsc-3599"><span class="linenos">3599</span></a>
</span><span id="COMPsc-3600"><a href="#COMPsc-3600"><span class="linenos">3600</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-3601"><a href="#COMPsc-3601"><span class="linenos">3601</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="COMPsc-3602"><a href="#COMPsc-3602"><span class="linenos">3602</span></a>                <span class="s2">&quot;Nothing to return. &#39;self.subcluster_prepare&#39; -&gt; &#39;self.define_subclusters&#39; pip was not conducted!&quot;</span>
</span><span id="COMPsc-3603"><a href="#COMPsc-3603"><span class="linenos">3603</span></a>            <span class="p">)</span>
</span><span id="COMPsc-3604"><a href="#COMPsc-3604"><span class="linenos">3604</span></a>
</span><span id="COMPsc-3605"><a href="#COMPsc-3605"><span class="linenos">3605</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span>
</span><span id="COMPsc-3606"><a href="#COMPsc-3606"><span class="linenos">3606</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">])</span>
</span><span id="COMPsc-3607"><a href="#COMPsc-3607"><span class="linenos">3607</span></a>
</span><span id="COMPsc-3608"><a href="#COMPsc-3608"><span class="linenos">3608</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="n">reduce_data</span><span class="p">(</span>
</span><span id="COMPsc-3609"><a href="#COMPsc-3609"><span class="linenos">3609</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">current_cluster</span><span class="p">]</span>
</span><span id="COMPsc-3610"><a href="#COMPsc-3610"><span class="linenos">3610</span></a>        <span class="p">)</span>
</span><span id="COMPsc-3611"><a href="#COMPsc-3611"><span class="linenos">3611</span></a>
</span><span id="COMPsc-3612"><a href="#COMPsc-3612"><span class="linenos">3612</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span>
</span><span id="COMPsc-3613"><a href="#COMPsc-3613"><span class="linenos">3613</span></a>
</span><span id="COMPsc-3614"><a href="#COMPsc-3614"><span class="linenos">3614</span></a>        <span class="n">deg_stats</span> <span class="o">=</span> <span class="n">calc_DEG</span><span class="p">(</span>
</span><span id="COMPsc-3615"><a href="#COMPsc-3615"><span class="linenos">3615</span></a>            <span class="n">dat</span><span class="p">,</span>
</span><span id="COMPsc-3616"><a href="#COMPsc-3616"><span class="linenos">3616</span></a>            <span class="n">metadata_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-3617"><a href="#COMPsc-3617"><span class="linenos">3617</span></a>            <span class="n">entities</span><span class="o">=</span><span class="s2">&quot;All&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3618"><a href="#COMPsc-3618"><span class="linenos">3618</span></a>            <span class="n">sets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-3619"><a href="#COMPsc-3619"><span class="linenos">3619</span></a>            <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span>
</span><span id="COMPsc-3620"><a href="#COMPsc-3620"><span class="linenos">3620</span></a>            <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span>
</span><span id="COMPsc-3621"><a href="#COMPsc-3621"><span class="linenos">3621</span></a>            <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span>
</span><span id="COMPsc-3622"><a href="#COMPsc-3622"><span class="linenos">3622</span></a>        <span class="p">)</span>
</span><span id="COMPsc-3623"><a href="#COMPsc-3623"><span class="linenos">3623</span></a>
</span><span id="COMPsc-3624"><a href="#COMPsc-3624"><span class="linenos">3624</span></a>        <span class="n">deg_stats</span> <span class="o">=</span> <span class="n">deg_stats</span><span class="p">[</span><span class="n">deg_stats</span><span class="p">[</span><span class="s2">&quot;p_val&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_val</span><span class="p">]</span>
</span><span id="COMPsc-3625"><a href="#COMPsc-3625"><span class="linenos">3625</span></a>        <span class="n">deg_stats</span> <span class="o">=</span> <span class="n">deg_stats</span><span class="p">[</span><span class="n">deg_stats</span><span class="p">[</span><span class="s2">&quot;log(FC)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="COMPsc-3626"><a href="#COMPsc-3626"><span class="linenos">3626</span></a>
</span><span id="COMPsc-3627"><a href="#COMPsc-3627"><span class="linenos">3627</span></a>        <span class="n">deg_stats</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc-3628"><a href="#COMPsc-3628"><span class="linenos">3628</span></a>            <span class="n">deg_stats</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
</span><span id="COMPsc-3629"><a href="#COMPsc-3629"><span class="linenos">3629</span></a>                <span class="p">[</span><span class="s2">&quot;valid_group&quot;</span><span class="p">,</span> <span class="s2">&quot;esm&quot;</span><span class="p">,</span> <span class="s2">&quot;log(FC)&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
</span><span id="COMPsc-3630"><a href="#COMPsc-3630"><span class="linenos">3630</span></a>            <span class="p">)</span>
</span><span id="COMPsc-3631"><a href="#COMPsc-3631"><span class="linenos">3631</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;valid_group&quot;</span><span class="p">)</span>
</span><span id="COMPsc-3632"><a href="#COMPsc-3632"><span class="linenos">3632</span></a>            <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">top_n</span><span class="p">)</span>
</span><span id="COMPsc-3633"><a href="#COMPsc-3633"><span class="linenos">3633</span></a>        <span class="p">)</span>
</span><span id="COMPsc-3634"><a href="#COMPsc-3634"><span class="linenos">3634</span></a>
</span><span id="COMPsc-3635"><a href="#COMPsc-3635"><span class="linenos">3635</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="n">reduce_data</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">deg_stats</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">])))</span>
</span><span id="COMPsc-3636"><a href="#COMPsc-3636"><span class="linenos">3636</span></a>
</span><span id="COMPsc-3637"><a href="#COMPsc-3637"><span class="linenos">3637</span></a>        <span class="n">avg</span> <span class="o">=</span> <span class="n">average</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="COMPsc-3638"><a href="#COMPsc-3638"><span class="linenos">3638</span></a>        <span class="n">occ</span> <span class="o">=</span> <span class="n">occurrence</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="COMPsc-3639"><a href="#COMPsc-3639"><span class="linenos">3639</span></a>
</span><span id="COMPsc-3640"><a href="#COMPsc-3640"><span class="linenos">3640</span></a>        <span class="n">scatter</span> <span class="o">=</span> <span class="n">features_scatter</span><span class="p">(</span>
</span><span id="COMPsc-3641"><a href="#COMPsc-3641"><span class="linenos">3641</span></a>            <span class="n">expression_data</span><span class="o">=</span><span class="n">avg</span><span class="p">,</span>
</span><span id="COMPsc-3642"><a href="#COMPsc-3642"><span class="linenos">3642</span></a>            <span class="n">occurence_data</span><span class="o">=</span><span class="n">occ</span><span class="p">,</span>
</span><span id="COMPsc-3643"><a href="#COMPsc-3643"><span class="linenos">3643</span></a>            <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-3644"><a href="#COMPsc-3644"><span class="linenos">3644</span></a>            <span class="n">metadata_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-3645"><a href="#COMPsc-3645"><span class="linenos">3645</span></a>            <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
</span><span id="COMPsc-3646"><a href="#COMPsc-3646"><span class="linenos">3646</span></a>            <span class="n">hclust</span><span class="o">=</span><span class="n">hclust</span><span class="p">,</span>
</span><span id="COMPsc-3647"><a href="#COMPsc-3647"><span class="linenos">3647</span></a>            <span class="n">img_width</span><span class="o">=</span><span class="n">img_width</span><span class="p">,</span>
</span><span id="COMPsc-3648"><a href="#COMPsc-3648"><span class="linenos">3648</span></a>            <span class="n">img_high</span><span class="o">=</span><span class="n">img_high</span><span class="p">,</span>
</span><span id="COMPsc-3649"><a href="#COMPsc-3649"><span class="linenos">3649</span></a>            <span class="n">label_size</span><span class="o">=</span><span class="n">label_size</span><span class="p">,</span>
</span><span id="COMPsc-3650"><a href="#COMPsc-3650"><span class="linenos">3650</span></a>            <span class="n">size_scale</span><span class="o">=</span><span class="n">size_scale</span><span class="p">,</span>
</span><span id="COMPsc-3651"><a href="#COMPsc-3651"><span class="linenos">3651</span></a>            <span class="n">y_lab</span><span class="o">=</span><span class="n">y_lab</span><span class="p">,</span>
</span><span id="COMPsc-3652"><a href="#COMPsc-3652"><span class="linenos">3652</span></a>            <span class="n">legend_lab</span><span class="o">=</span><span class="n">legend_lab</span><span class="p">,</span>
</span><span id="COMPsc-3653"><a href="#COMPsc-3653"><span class="linenos">3653</span></a>            <span class="n">bbox_to_anchor_scale</span><span class="o">=</span><span class="n">bbox_to_anchor_scale</span><span class="p">,</span>
</span><span id="COMPsc-3654"><a href="#COMPsc-3654"><span class="linenos">3654</span></a>            <span class="n">bbox_to_anchor_perc</span><span class="o">=</span><span class="n">bbox_to_anchor_perc</span><span class="p">,</span>
</span><span id="COMPsc-3655"><a href="#COMPsc-3655"><span class="linenos">3655</span></a>        <span class="p">)</span>
</span><span id="COMPsc-3656"><a href="#COMPsc-3656"><span class="linenos">3656</span></a>
</span><span id="COMPsc-3657"><a href="#COMPsc-3657"><span class="linenos">3657</span></a>        <span class="k">return</span> <span class="n">scatter</span>
</span><span id="COMPsc-3658"><a href="#COMPsc-3658"><span class="linenos">3658</span></a>
</span><span id="COMPsc-3659"><a href="#COMPsc-3659"><span class="linenos">3659</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">accept_subclusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="COMPsc-3660"><a href="#COMPsc-3660"><span class="linenos">3660</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-3661"><a href="#COMPsc-3661"><span class="linenos">3661</span></a><span class="sd">        Commit subcluster labels into the main `input_metadata` by renaming cell names.</span>
</span><span id="COMPsc-3662"><a href="#COMPsc-3662"><span class="linenos">3662</span></a>
</span><span id="COMPsc-3663"><a href="#COMPsc-3663"><span class="linenos">3663</span></a><span class="sd">        The method replaces occurrences of the parent cluster name in `self.input_metadata[&#39;cell_names&#39;]`</span>
</span><span id="COMPsc-3664"><a href="#COMPsc-3664"><span class="linenos">3664</span></a><span class="sd">        with the expanded names that include subcluster suffixes (via `add_subnames`),</span>
</span><span id="COMPsc-3665"><a href="#COMPsc-3665"><span class="linenos">3665</span></a><span class="sd">        then clears `self.subclusters_`.</span>
</span><span id="COMPsc-3666"><a href="#COMPsc-3666"><span class="linenos">3666</span></a>
</span><span id="COMPsc-3667"><a href="#COMPsc-3667"><span class="linenos">3667</span></a><span class="sd">        Update</span>
</span><span id="COMPsc-3668"><a href="#COMPsc-3668"><span class="linenos">3668</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-3669"><a href="#COMPsc-3669"><span class="linenos">3669</span></a><span class="sd">        Modifies `self.input_metadata[&#39;cell_names&#39;]`.</span>
</span><span id="COMPsc-3670"><a href="#COMPsc-3670"><span class="linenos">3670</span></a>
</span><span id="COMPsc-3671"><a href="#COMPsc-3671"><span class="linenos">3671</span></a><span class="sd">        Resets `self.subclusters_` to None.</span>
</span><span id="COMPsc-3672"><a href="#COMPsc-3672"><span class="linenos">3672</span></a>
</span><span id="COMPsc-3673"><a href="#COMPsc-3673"><span class="linenos">3673</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc-3674"><a href="#COMPsc-3674"><span class="linenos">3674</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-3675"><a href="#COMPsc-3675"><span class="linenos">3675</span></a><span class="sd">        RuntimeError</span>
</span><span id="COMPsc-3676"><a href="#COMPsc-3676"><span class="linenos">3676</span></a><span class="sd">            If `self.subclusters_` is not defined or subclusters were not computed.</span>
</span><span id="COMPsc-3677"><a href="#COMPsc-3677"><span class="linenos">3677</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-3678"><a href="#COMPsc-3678"><span class="linenos">3678</span></a>
</span><span id="COMPsc-3679"><a href="#COMPsc-3679"><span class="linenos">3679</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-3680"><a href="#COMPsc-3680"><span class="linenos">3680</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="COMPsc-3681"><a href="#COMPsc-3681"><span class="linenos">3681</span></a>                <span class="s2">&quot;Nothing to return. &#39;self.subcluster_prepare&#39; -&gt; &#39;self.define_subclusters&#39; pip was not conducted!&quot;</span>
</span><span id="COMPsc-3682"><a href="#COMPsc-3682"><span class="linenos">3682</span></a>            <span class="p">)</span>
</span><span id="COMPsc-3683"><a href="#COMPsc-3683"><span class="linenos">3683</span></a>
</span><span id="COMPsc-3684"><a href="#COMPsc-3684"><span class="linenos">3684</span></a>        <span class="n">new_meta</span> <span class="o">=</span> <span class="n">add_subnames</span><span class="p">(</span>
</span><span id="COMPsc-3685"><a href="#COMPsc-3685"><span class="linenos">3685</span></a>            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]),</span>
</span><span id="COMPsc-3686"><a href="#COMPsc-3686"><span class="linenos">3686</span></a>            <span class="n">parent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">current_cluster</span><span class="p">,</span>
</span><span id="COMPsc-3687"><a href="#COMPsc-3687"><span class="linenos">3687</span></a>            <span class="n">new_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span><span class="p">,</span>
</span><span id="COMPsc-3688"><a href="#COMPsc-3688"><span class="linenos">3688</span></a>        <span class="p">)</span>
</span><span id="COMPsc-3689"><a href="#COMPsc-3689"><span class="linenos">3689</span></a>
</span><span id="COMPsc-3690"><a href="#COMPsc-3690"><span class="linenos">3690</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_meta</span>
</span><span id="COMPsc-3691"><a href="#COMPsc-3691"><span class="linenos">3691</span></a>
</span><span id="COMPsc-3692"><a href="#COMPsc-3692"><span class="linenos">3692</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc-3693"><a href="#COMPsc-3693"><span class="linenos">3693</span></a>
</span><span id="COMPsc-3694"><a href="#COMPsc-3694"><span class="linenos">3694</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">scatter_plot</span><span class="p">(</span>
</span><span id="COMPsc-3695"><a href="#COMPsc-3695"><span class="linenos">3695</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc-3696"><a href="#COMPsc-3696"><span class="linenos">3696</span></a>        <span class="n">names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-3697"><a href="#COMPsc-3697"><span class="linenos">3697</span></a>        <span class="n">features</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-3698"><a href="#COMPsc-3698"><span class="linenos">3698</span></a>        <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3699"><a href="#COMPsc-3699"><span class="linenos">3699</span></a>        <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="COMPsc-3700"><a href="#COMPsc-3700"><span class="linenos">3700</span></a>        <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3701"><a href="#COMPsc-3701"><span class="linenos">3701</span></a>        <span class="n">hclust</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-3702"><a href="#COMPsc-3702"><span class="linenos">3702</span></a>        <span class="n">img_width</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="COMPsc-3703"><a href="#COMPsc-3703"><span class="linenos">3703</span></a>        <span class="n">img_high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc-3704"><a href="#COMPsc-3704"><span class="linenos">3704</span></a>        <span class="n">label_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="COMPsc-3705"><a href="#COMPsc-3705"><span class="linenos">3705</span></a>        <span class="n">size_scale</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
</span><span id="COMPsc-3706"><a href="#COMPsc-3706"><span class="linenos">3706</span></a>        <span class="n">y_lab</span><span class="o">=</span><span class="s2">&quot;Genes&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3707"><a href="#COMPsc-3707"><span class="linenos">3707</span></a>        <span class="n">legend_lab</span><span class="o">=</span><span class="s2">&quot;log(CPM + 1)&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3708"><a href="#COMPsc-3708"><span class="linenos">3708</span></a>        <span class="n">set_box_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="COMPsc-3709"><a href="#COMPsc-3709"><span class="linenos">3709</span></a>        <span class="n">set_box_high</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="COMPsc-3710"><a href="#COMPsc-3710"><span class="linenos">3710</span></a>        <span class="n">bbox_to_anchor_scale</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
</span><span id="COMPsc-3711"><a href="#COMPsc-3711"><span class="linenos">3711</span></a>        <span class="n">bbox_to_anchor_perc</span><span class="o">=</span><span class="p">(</span><span class="mf">0.90</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.24</span><span class="p">),</span>
</span><span id="COMPsc-3712"><a href="#COMPsc-3712"><span class="linenos">3712</span></a>        <span class="n">bbox_to_anchor_group</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">),</span>
</span><span id="COMPsc-3713"><a href="#COMPsc-3713"><span class="linenos">3713</span></a>    <span class="p">):</span>
</span><span id="COMPsc-3714"><a href="#COMPsc-3714"><span class="linenos">3714</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-3715"><a href="#COMPsc-3715"><span class="linenos">3715</span></a><span class="sd">        Create a bubble scatter plot of selected features across samples inside project.</span>
</span><span id="COMPsc-3716"><a href="#COMPsc-3716"><span class="linenos">3716</span></a>
</span><span id="COMPsc-3717"><a href="#COMPsc-3717"><span class="linenos">3717</span></a><span class="sd">        Each point represents a feature-sample pair, where the color encodes the</span>
</span><span id="COMPsc-3718"><a href="#COMPsc-3718"><span class="linenos">3718</span></a><span class="sd">        expression value and the size encodes occurrence or relative abundance.</span>
</span><span id="COMPsc-3719"><a href="#COMPsc-3719"><span class="linenos">3719</span></a><span class="sd">        Optionally, hierarchical clustering can be applied to order rows and columns.</span>
</span><span id="COMPsc-3720"><a href="#COMPsc-3720"><span class="linenos">3720</span></a>
</span><span id="COMPsc-3721"><a href="#COMPsc-3721"><span class="linenos">3721</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-3722"><a href="#COMPsc-3722"><span class="linenos">3722</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-3723"><a href="#COMPsc-3723"><span class="linenos">3723</span></a><span class="sd">        names : list, str, or None</span>
</span><span id="COMPsc-3724"><a href="#COMPsc-3724"><span class="linenos">3724</span></a><span class="sd">            Names of samples to include. If None, all samples are considered.</span>
</span><span id="COMPsc-3725"><a href="#COMPsc-3725"><span class="linenos">3725</span></a>
</span><span id="COMPsc-3726"><a href="#COMPsc-3726"><span class="linenos">3726</span></a><span class="sd">        features : list, str, or None</span>
</span><span id="COMPsc-3727"><a href="#COMPsc-3727"><span class="linenos">3727</span></a><span class="sd">            Names of features to include. If None, all features are considered.</span>
</span><span id="COMPsc-3728"><a href="#COMPsc-3728"><span class="linenos">3728</span></a>
</span><span id="COMPsc-3729"><a href="#COMPsc-3729"><span class="linenos">3729</span></a><span class="sd">        name_slot : str</span>
</span><span id="COMPsc-3730"><a href="#COMPsc-3730"><span class="linenos">3730</span></a><span class="sd">            Column in metadata to use as sample names.</span>
</span><span id="COMPsc-3731"><a href="#COMPsc-3731"><span class="linenos">3731</span></a>
</span><span id="COMPsc-3732"><a href="#COMPsc-3732"><span class="linenos">3732</span></a><span class="sd">        scale: bool, default False</span>
</span><span id="COMPsc-3733"><a href="#COMPsc-3733"><span class="linenos">3733</span></a><span class="sd">            If True, expression_data will be scaled (0–1) across the rows (features).</span>
</span><span id="COMPsc-3734"><a href="#COMPsc-3734"><span class="linenos">3734</span></a>
</span><span id="COMPsc-3735"><a href="#COMPsc-3735"><span class="linenos">3735</span></a><span class="sd">        colors : str, default=&#39;viridis&#39;</span>
</span><span id="COMPsc-3736"><a href="#COMPsc-3736"><span class="linenos">3736</span></a><span class="sd">            Colormap for expression values.</span>
</span><span id="COMPsc-3737"><a href="#COMPsc-3737"><span class="linenos">3737</span></a>
</span><span id="COMPsc-3738"><a href="#COMPsc-3738"><span class="linenos">3738</span></a><span class="sd">        hclust : str or None, default=&#39;complete&#39;</span>
</span><span id="COMPsc-3739"><a href="#COMPsc-3739"><span class="linenos">3739</span></a><span class="sd">            Linkage method for hierarchical clustering. If None, no clustering</span>
</span><span id="COMPsc-3740"><a href="#COMPsc-3740"><span class="linenos">3740</span></a><span class="sd">            is performed.</span>
</span><span id="COMPsc-3741"><a href="#COMPsc-3741"><span class="linenos">3741</span></a>
</span><span id="COMPsc-3742"><a href="#COMPsc-3742"><span class="linenos">3742</span></a><span class="sd">        img_width : int or float, default=8</span>
</span><span id="COMPsc-3743"><a href="#COMPsc-3743"><span class="linenos">3743</span></a><span class="sd">            Width of the plot in inches.</span>
</span><span id="COMPsc-3744"><a href="#COMPsc-3744"><span class="linenos">3744</span></a>
</span><span id="COMPsc-3745"><a href="#COMPsc-3745"><span class="linenos">3745</span></a><span class="sd">        img_high : int or float, default=5</span>
</span><span id="COMPsc-3746"><a href="#COMPsc-3746"><span class="linenos">3746</span></a><span class="sd">            Height of the plot in inches.</span>
</span><span id="COMPsc-3747"><a href="#COMPsc-3747"><span class="linenos">3747</span></a>
</span><span id="COMPsc-3748"><a href="#COMPsc-3748"><span class="linenos">3748</span></a><span class="sd">        label_size : int, default=10</span>
</span><span id="COMPsc-3749"><a href="#COMPsc-3749"><span class="linenos">3749</span></a><span class="sd">            Font size for axis labels and ticks.</span>
</span><span id="COMPsc-3750"><a href="#COMPsc-3750"><span class="linenos">3750</span></a>
</span><span id="COMPsc-3751"><a href="#COMPsc-3751"><span class="linenos">3751</span></a><span class="sd">        size_scale : int or float, default=100</span>
</span><span id="COMPsc-3752"><a href="#COMPsc-3752"><span class="linenos">3752</span></a><span class="sd">            Scaling factor for bubble sizes.</span>
</span><span id="COMPsc-3753"><a href="#COMPsc-3753"><span class="linenos">3753</span></a>
</span><span id="COMPsc-3754"><a href="#COMPsc-3754"><span class="linenos">3754</span></a><span class="sd">        y_lab : str, default=&#39;Genes&#39;</span>
</span><span id="COMPsc-3755"><a href="#COMPsc-3755"><span class="linenos">3755</span></a><span class="sd">            Label for the x-axis.</span>
</span><span id="COMPsc-3756"><a href="#COMPsc-3756"><span class="linenos">3756</span></a>
</span><span id="COMPsc-3757"><a href="#COMPsc-3757"><span class="linenos">3757</span></a><span class="sd">        legend_lab : str, default=&#39;log(CPM + 1)&#39;</span>
</span><span id="COMPsc-3758"><a href="#COMPsc-3758"><span class="linenos">3758</span></a><span class="sd">            Label for the colorbar legend.</span>
</span><span id="COMPsc-3759"><a href="#COMPsc-3759"><span class="linenos">3759</span></a>
</span><span id="COMPsc-3760"><a href="#COMPsc-3760"><span class="linenos">3760</span></a><span class="sd">        bbox_to_anchor_scale : int, default=25</span>
</span><span id="COMPsc-3761"><a href="#COMPsc-3761"><span class="linenos">3761</span></a><span class="sd">            Vertical scale (percentage) for positioning the colorbar.</span>
</span><span id="COMPsc-3762"><a href="#COMPsc-3762"><span class="linenos">3762</span></a>
</span><span id="COMPsc-3763"><a href="#COMPsc-3763"><span class="linenos">3763</span></a><span class="sd">        bbox_to_anchor_perc : tuple, default=(0.91, 0.63)</span>
</span><span id="COMPsc-3764"><a href="#COMPsc-3764"><span class="linenos">3764</span></a><span class="sd">            Anchor position for the size legend (percent bubble legend).</span>
</span><span id="COMPsc-3765"><a href="#COMPsc-3765"><span class="linenos">3765</span></a>
</span><span id="COMPsc-3766"><a href="#COMPsc-3766"><span class="linenos">3766</span></a><span class="sd">        bbox_to_anchor_group : tuple, default=(1.01, 0.4)</span>
</span><span id="COMPsc-3767"><a href="#COMPsc-3767"><span class="linenos">3767</span></a><span class="sd">            Anchor position for the group legend.</span>
</span><span id="COMPsc-3768"><a href="#COMPsc-3768"><span class="linenos">3768</span></a>
</span><span id="COMPsc-3769"><a href="#COMPsc-3769"><span class="linenos">3769</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc-3770"><a href="#COMPsc-3770"><span class="linenos">3770</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-3771"><a href="#COMPsc-3771"><span class="linenos">3771</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc-3772"><a href="#COMPsc-3772"><span class="linenos">3772</span></a><span class="sd">            The generated scatter plot figure.</span>
</span><span id="COMPsc-3773"><a href="#COMPsc-3773"><span class="linenos">3773</span></a>
</span><span id="COMPsc-3774"><a href="#COMPsc-3774"><span class="linenos">3774</span></a><span class="sd">        Notes</span>
</span><span id="COMPsc-3775"><a href="#COMPsc-3775"><span class="linenos">3775</span></a><span class="sd">        -----</span>
</span><span id="COMPsc-3776"><a href="#COMPsc-3776"><span class="linenos">3776</span></a><span class="sd">        Colors represent expression values normalized to the colormap.</span>
</span><span id="COMPsc-3777"><a href="#COMPsc-3777"><span class="linenos">3777</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-3778"><a href="#COMPsc-3778"><span class="linenos">3778</span></a>
</span><span id="COMPsc-3779"><a href="#COMPsc-3779"><span class="linenos">3779</span></a>        <span class="n">prtd</span><span class="p">,</span> <span class="n">met</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_partial_data</span><span class="p">(</span>
</span><span id="COMPsc-3780"><a href="#COMPsc-3780"><span class="linenos">3780</span></a>            <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">name_slot</span><span class="o">=</span><span class="n">name_slot</span><span class="p">,</span> <span class="n">inc_metadata</span><span class="o">=</span><span class="kc">True</span>
</span><span id="COMPsc-3781"><a href="#COMPsc-3781"><span class="linenos">3781</span></a>        <span class="p">)</span>
</span><span id="COMPsc-3782"><a href="#COMPsc-3782"><span class="linenos">3782</span></a>
</span><span id="COMPsc-3783"><a href="#COMPsc-3783"><span class="linenos">3783</span></a>        <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
</span><span id="COMPsc-3784"><a href="#COMPsc-3784"><span class="linenos">3784</span></a>
</span><span id="COMPsc-3785"><a href="#COMPsc-3785"><span class="linenos">3785</span></a>            <span class="n">legend_lab</span> <span class="o">=</span> <span class="s2">&quot;Scaled</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">legend_lab</span>
</span><span id="COMPsc-3786"><a href="#COMPsc-3786"><span class="linenos">3786</span></a>
</span><span id="COMPsc-3787"><a href="#COMPsc-3787"><span class="linenos">3787</span></a>            <span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="COMPsc-3788"><a href="#COMPsc-3788"><span class="linenos">3788</span></a>            <span class="n">prtd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="COMPsc-3789"><a href="#COMPsc-3789"><span class="linenos">3789</span></a>                <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">prtd</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
</span><span id="COMPsc-3790"><a href="#COMPsc-3790"><span class="linenos">3790</span></a>                <span class="n">index</span><span class="o">=</span><span class="n">prtd</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
</span><span id="COMPsc-3791"><a href="#COMPsc-3791"><span class="linenos">3791</span></a>                <span class="n">columns</span><span class="o">=</span><span class="n">prtd</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
</span><span id="COMPsc-3792"><a href="#COMPsc-3792"><span class="linenos">3792</span></a>            <span class="p">)</span>
</span><span id="COMPsc-3793"><a href="#COMPsc-3793"><span class="linenos">3793</span></a>
</span><span id="COMPsc-3794"><a href="#COMPsc-3794"><span class="linenos">3794</span></a>        <span class="n">prtd</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">prtd</span><span class="o">.</span><span class="n">columns</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">met</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc-3795"><a href="#COMPsc-3795"><span class="linenos">3795</span></a>
</span><span id="COMPsc-3796"><a href="#COMPsc-3796"><span class="linenos">3796</span></a>        <span class="n">prtd_avg</span> <span class="o">=</span> <span class="n">average</span><span class="p">(</span><span class="n">prtd</span><span class="p">)</span>
</span><span id="COMPsc-3797"><a href="#COMPsc-3797"><span class="linenos">3797</span></a>
</span><span id="COMPsc-3798"><a href="#COMPsc-3798"><span class="linenos">3798</span></a>        <span class="n">meta_sets</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*#&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prtd_avg</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc-3799"><a href="#COMPsc-3799"><span class="linenos">3799</span></a>
</span><span id="COMPsc-3800"><a href="#COMPsc-3800"><span class="linenos">3800</span></a>        <span class="n">prtd_avg</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;#.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prtd_avg</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc-3801"><a href="#COMPsc-3801"><span class="linenos">3801</span></a>
</span><span id="COMPsc-3802"><a href="#COMPsc-3802"><span class="linenos">3802</span></a>        <span class="n">prtd_occ</span> <span class="o">=</span> <span class="n">occurrence</span><span class="p">(</span><span class="n">prtd</span><span class="p">)</span>
</span><span id="COMPsc-3803"><a href="#COMPsc-3803"><span class="linenos">3803</span></a>
</span><span id="COMPsc-3804"><a href="#COMPsc-3804"><span class="linenos">3804</span></a>        <span class="n">prtd_occ</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;#.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prtd_occ</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc-3805"><a href="#COMPsc-3805"><span class="linenos">3805</span></a>
</span><span id="COMPsc-3806"><a href="#COMPsc-3806"><span class="linenos">3806</span></a>        <span class="n">fig_scatter</span> <span class="o">=</span> <span class="n">features_scatter</span><span class="p">(</span>
</span><span id="COMPsc-3807"><a href="#COMPsc-3807"><span class="linenos">3807</span></a>            <span class="n">expression_data</span><span class="o">=</span><span class="n">prtd_avg</span><span class="p">,</span>
</span><span id="COMPsc-3808"><a href="#COMPsc-3808"><span class="linenos">3808</span></a>            <span class="n">occurence_data</span><span class="o">=</span><span class="n">prtd_occ</span><span class="p">,</span>
</span><span id="COMPsc-3809"><a href="#COMPsc-3809"><span class="linenos">3809</span></a>            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
</span><span id="COMPsc-3810"><a href="#COMPsc-3810"><span class="linenos">3810</span></a>            <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-3811"><a href="#COMPsc-3811"><span class="linenos">3811</span></a>            <span class="n">metadata_list</span><span class="o">=</span><span class="n">meta_sets</span><span class="p">,</span>
</span><span id="COMPsc-3812"><a href="#COMPsc-3812"><span class="linenos">3812</span></a>            <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
</span><span id="COMPsc-3813"><a href="#COMPsc-3813"><span class="linenos">3813</span></a>            <span class="n">hclust</span><span class="o">=</span><span class="n">hclust</span><span class="p">,</span>
</span><span id="COMPsc-3814"><a href="#COMPsc-3814"><span class="linenos">3814</span></a>            <span class="n">img_width</span><span class="o">=</span><span class="n">img_width</span><span class="p">,</span>
</span><span id="COMPsc-3815"><a href="#COMPsc-3815"><span class="linenos">3815</span></a>            <span class="n">img_high</span><span class="o">=</span><span class="n">img_high</span><span class="p">,</span>
</span><span id="COMPsc-3816"><a href="#COMPsc-3816"><span class="linenos">3816</span></a>            <span class="n">label_size</span><span class="o">=</span><span class="n">label_size</span><span class="p">,</span>
</span><span id="COMPsc-3817"><a href="#COMPsc-3817"><span class="linenos">3817</span></a>            <span class="n">size_scale</span><span class="o">=</span><span class="n">size_scale</span><span class="p">,</span>
</span><span id="COMPsc-3818"><a href="#COMPsc-3818"><span class="linenos">3818</span></a>            <span class="n">y_lab</span><span class="o">=</span><span class="n">y_lab</span><span class="p">,</span>
</span><span id="COMPsc-3819"><a href="#COMPsc-3819"><span class="linenos">3819</span></a>            <span class="n">legend_lab</span><span class="o">=</span><span class="n">legend_lab</span><span class="p">,</span>
</span><span id="COMPsc-3820"><a href="#COMPsc-3820"><span class="linenos">3820</span></a>            <span class="n">set_box_size</span><span class="o">=</span><span class="n">set_box_size</span><span class="p">,</span>
</span><span id="COMPsc-3821"><a href="#COMPsc-3821"><span class="linenos">3821</span></a>            <span class="n">set_box_high</span><span class="o">=</span><span class="n">set_box_high</span><span class="p">,</span>
</span><span id="COMPsc-3822"><a href="#COMPsc-3822"><span class="linenos">3822</span></a>            <span class="n">bbox_to_anchor_scale</span><span class="o">=</span><span class="n">bbox_to_anchor_scale</span><span class="p">,</span>
</span><span id="COMPsc-3823"><a href="#COMPsc-3823"><span class="linenos">3823</span></a>            <span class="n">bbox_to_anchor_perc</span><span class="o">=</span><span class="n">bbox_to_anchor_perc</span><span class="p">,</span>
</span><span id="COMPsc-3824"><a href="#COMPsc-3824"><span class="linenos">3824</span></a>            <span class="n">bbox_to_anchor_group</span><span class="o">=</span><span class="n">bbox_to_anchor_group</span><span class="p">,</span>
</span><span id="COMPsc-3825"><a href="#COMPsc-3825"><span class="linenos">3825</span></a>        <span class="p">)</span>
</span><span id="COMPsc-3826"><a href="#COMPsc-3826"><span class="linenos">3826</span></a>
</span><span id="COMPsc-3827"><a href="#COMPsc-3827"><span class="linenos">3827</span></a>        <span class="k">return</span> <span class="n">fig_scatter</span>
</span><span id="COMPsc-3828"><a href="#COMPsc-3828"><span class="linenos">3828</span></a>
</span><span id="COMPsc-3829"><a href="#COMPsc-3829"><span class="linenos">3829</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">data_composition</span><span class="p">(</span>
</span><span id="COMPsc-3830"><a href="#COMPsc-3830"><span class="linenos">3830</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc-3831"><a href="#COMPsc-3831"><span class="linenos">3831</span></a>        <span class="n">features_count</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-3832"><a href="#COMPsc-3832"><span class="linenos">3832</span></a>        <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3833"><a href="#COMPsc-3833"><span class="linenos">3833</span></a>        <span class="n">set_sep</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="COMPsc-3834"><a href="#COMPsc-3834"><span class="linenos">3834</span></a>    <span class="p">):</span>
</span><span id="COMPsc-3835"><a href="#COMPsc-3835"><span class="linenos">3835</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-3836"><a href="#COMPsc-3836"><span class="linenos">3836</span></a><span class="sd">        Compute composition of cell types in data set.</span>
</span><span id="COMPsc-3837"><a href="#COMPsc-3837"><span class="linenos">3837</span></a>
</span><span id="COMPsc-3838"><a href="#COMPsc-3838"><span class="linenos">3838</span></a><span class="sd">        This function counts the occurrences of specific cells (e.g., cell types, subtypes)</span>
</span><span id="COMPsc-3839"><a href="#COMPsc-3839"><span class="linenos">3839</span></a><span class="sd">        within metadata entries, calculates their relative percentages, and stores</span>
</span><span id="COMPsc-3840"><a href="#COMPsc-3840"><span class="linenos">3840</span></a><span class="sd">        the results in `self.composition_data`.</span>
</span><span id="COMPsc-3841"><a href="#COMPsc-3841"><span class="linenos">3841</span></a>
</span><span id="COMPsc-3842"><a href="#COMPsc-3842"><span class="linenos">3842</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-3843"><a href="#COMPsc-3843"><span class="linenos">3843</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-3844"><a href="#COMPsc-3844"><span class="linenos">3844</span></a><span class="sd">        features_count : list or None</span>
</span><span id="COMPsc-3845"><a href="#COMPsc-3845"><span class="linenos">3845</span></a><span class="sd">            List of features (part or full names) to be counted.</span>
</span><span id="COMPsc-3846"><a href="#COMPsc-3846"><span class="linenos">3846</span></a><span class="sd">            If None, all unique elements from the specified `name_slot` metadata field are used.</span>
</span><span id="COMPsc-3847"><a href="#COMPsc-3847"><span class="linenos">3847</span></a>
</span><span id="COMPsc-3848"><a href="#COMPsc-3848"><span class="linenos">3848</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="COMPsc-3849"><a href="#COMPsc-3849"><span class="linenos">3849</span></a><span class="sd">            Metadata field containing sample identifiers or labels.</span>
</span><span id="COMPsc-3850"><a href="#COMPsc-3850"><span class="linenos">3850</span></a>
</span><span id="COMPsc-3851"><a href="#COMPsc-3851"><span class="linenos">3851</span></a><span class="sd">        set_sep : bool, default True</span>
</span><span id="COMPsc-3852"><a href="#COMPsc-3852"><span class="linenos">3852</span></a><span class="sd">            If True and multiple sets are present in metadata, compute composition</span>
</span><span id="COMPsc-3853"><a href="#COMPsc-3853"><span class="linenos">3853</span></a><span class="sd">            separately for each set.</span>
</span><span id="COMPsc-3854"><a href="#COMPsc-3854"><span class="linenos">3854</span></a>
</span><span id="COMPsc-3855"><a href="#COMPsc-3855"><span class="linenos">3855</span></a><span class="sd">        Update</span>
</span><span id="COMPsc-3856"><a href="#COMPsc-3856"><span class="linenos">3856</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-3857"><a href="#COMPsc-3857"><span class="linenos">3857</span></a><span class="sd">        Stores results in `self.composition_data` as a pandas DataFrame with:</span>
</span><span id="COMPsc-3858"><a href="#COMPsc-3858"><span class="linenos">3858</span></a><span class="sd">        - &#39;name&#39;: feature name</span>
</span><span id="COMPsc-3859"><a href="#COMPsc-3859"><span class="linenos">3859</span></a><span class="sd">        - &#39;n&#39;: number of occurrences</span>
</span><span id="COMPsc-3860"><a href="#COMPsc-3860"><span class="linenos">3860</span></a><span class="sd">        - &#39;pct&#39;: percentage of occurrences</span>
</span><span id="COMPsc-3861"><a href="#COMPsc-3861"><span class="linenos">3861</span></a><span class="sd">        - &#39;set&#39; (if applicable): dataset identifier</span>
</span><span id="COMPsc-3862"><a href="#COMPsc-3862"><span class="linenos">3862</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-3863"><a href="#COMPsc-3863"><span class="linenos">3863</span></a>
</span><span id="COMPsc-3864"><a href="#COMPsc-3864"><span class="linenos">3864</span></a>        <span class="n">validated_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">])</span>
</span><span id="COMPsc-3865"><a href="#COMPsc-3865"><span class="linenos">3865</span></a>        <span class="n">sets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">])</span>
</span><span id="COMPsc-3866"><a href="#COMPsc-3866"><span class="linenos">3866</span></a>
</span><span id="COMPsc-3867"><a href="#COMPsc-3867"><span class="linenos">3867</span></a>        <span class="k">if</span> <span class="n">features_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-3868"><a href="#COMPsc-3868"><span class="linenos">3868</span></a>            <span class="n">features_count</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]))</span>
</span><span id="COMPsc-3869"><a href="#COMPsc-3869"><span class="linenos">3869</span></a>
</span><span id="COMPsc-3870"><a href="#COMPsc-3870"><span class="linenos">3870</span></a>        <span class="k">if</span> <span class="n">set_sep</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sets</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="COMPsc-3871"><a href="#COMPsc-3871"><span class="linenos">3871</span></a>
</span><span id="COMPsc-3872"><a href="#COMPsc-3872"><span class="linenos">3872</span></a>            <span class="n">final_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span><span id="COMPsc-3873"><a href="#COMPsc-3873"><span class="linenos">3873</span></a>
</span><span id="COMPsc-3874"><a href="#COMPsc-3874"><span class="linenos">3874</span></a>            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">sets</span><span class="p">):</span>
</span><span id="COMPsc-3875"><a href="#COMPsc-3875"><span class="linenos">3875</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="COMPsc-3876"><a href="#COMPsc-3876"><span class="linenos">3876</span></a>
</span><span id="COMPsc-3877"><a href="#COMPsc-3877"><span class="linenos">3877</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span> <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">x</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">]</span>
</span><span id="COMPsc-3878"><a href="#COMPsc-3878"><span class="linenos">3878</span></a>
</span><span id="COMPsc-3879"><a href="#COMPsc-3879"><span class="linenos">3879</span></a>                <span class="n">tmp_val_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">validated_list</span><span class="p">)</span>
</span><span id="COMPsc-3880"><a href="#COMPsc-3880"><span class="linenos">3880</span></a>
</span><span id="COMPsc-3881"><a href="#COMPsc-3881"><span class="linenos">3881</span></a>                <span class="n">tmp_val_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmp_val_list</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
</span><span id="COMPsc-3882"><a href="#COMPsc-3882"><span class="linenos">3882</span></a>
</span><span id="COMPsc-3883"><a href="#COMPsc-3883"><span class="linenos">3883</span></a>                <span class="n">res_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;set&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="COMPsc-3884"><a href="#COMPsc-3884"><span class="linenos">3884</span></a>
</span><span id="COMPsc-3885"><a href="#COMPsc-3885"><span class="linenos">3885</span></a>                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">features_count</span><span class="p">):</span>
</span><span id="COMPsc-3886"><a href="#COMPsc-3886"><span class="linenos">3886</span></a>                    <span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="COMPsc-3887"><a href="#COMPsc-3887"><span class="linenos">3887</span></a>                        <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">tmp_val_list</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">element</span><span class="p">)</span>
</span><span id="COMPsc-3888"><a href="#COMPsc-3888"><span class="linenos">3888</span></a>                    <span class="p">)</span>
</span><span id="COMPsc-3889"><a href="#COMPsc-3889"><span class="linenos">3889</span></a>                    <span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="COMPsc-3890"><a href="#COMPsc-3890"><span class="linenos">3890</span></a>                    <span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="COMPsc-3891"><a href="#COMPsc-3891"><span class="linenos">3891</span></a>                    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res_dict</span><span class="p">)</span>
</span><span id="COMPsc-3892"><a href="#COMPsc-3892"><span class="linenos">3892</span></a>                    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="COMPsc-3893"><a href="#COMPsc-3893"><span class="linenos">3893</span></a>                    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="COMPsc-3894"><a href="#COMPsc-3894"><span class="linenos">3894</span></a>
</span><span id="COMPsc-3895"><a href="#COMPsc-3895"><span class="linenos">3895</span></a>                <span class="n">final_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">final_res</span><span class="p">,</span> <span class="n">res</span><span class="p">])</span>
</span><span id="COMPsc-3896"><a href="#COMPsc-3896"><span class="linenos">3896</span></a>
</span><span id="COMPsc-3897"><a href="#COMPsc-3897"><span class="linenos">3897</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">final_res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="s2">&quot;pct&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
</span><span id="COMPsc-3898"><a href="#COMPsc-3898"><span class="linenos">3898</span></a>
</span><span id="COMPsc-3899"><a href="#COMPsc-3899"><span class="linenos">3899</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-3900"><a href="#COMPsc-3900"><span class="linenos">3900</span></a>
</span><span id="COMPsc-3901"><a href="#COMPsc-3901"><span class="linenos">3901</span></a>            <span class="n">res_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="COMPsc-3902"><a href="#COMPsc-3902"><span class="linenos">3902</span></a>
</span><span id="COMPsc-3903"><a href="#COMPsc-3903"><span class="linenos">3903</span></a>            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">features_count</span><span class="p">):</span>
</span><span id="COMPsc-3904"><a href="#COMPsc-3904"><span class="linenos">3904</span></a>                <span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="COMPsc-3905"><a href="#COMPsc-3905"><span class="linenos">3905</span></a>                    <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">validated_list</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">element</span><span class="p">)</span>
</span><span id="COMPsc-3906"><a href="#COMPsc-3906"><span class="linenos">3906</span></a>                <span class="p">)</span>
</span><span id="COMPsc-3907"><a href="#COMPsc-3907"><span class="linenos">3907</span></a>                <span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="COMPsc-3908"><a href="#COMPsc-3908"><span class="linenos">3908</span></a>
</span><span id="COMPsc-3909"><a href="#COMPsc-3909"><span class="linenos">3909</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res_dict</span><span class="p">)</span>
</span><span id="COMPsc-3910"><a href="#COMPsc-3910"><span class="linenos">3910</span></a>            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="COMPsc-3911"><a href="#COMPsc-3911"><span class="linenos">3911</span></a>            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="COMPsc-3912"><a href="#COMPsc-3912"><span class="linenos">3912</span></a>
</span><span id="COMPsc-3913"><a href="#COMPsc-3913"><span class="linenos">3913</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;pct&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="COMPsc-3914"><a href="#COMPsc-3914"><span class="linenos">3914</span></a>
</span><span id="COMPsc-3915"><a href="#COMPsc-3915"><span class="linenos">3915</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">composition_data</span> <span class="o">=</span> <span class="n">res</span>
</span><span id="COMPsc-3916"><a href="#COMPsc-3916"><span class="linenos">3916</span></a>
</span><span id="COMPsc-3917"><a href="#COMPsc-3917"><span class="linenos">3917</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">composition_pie</span><span class="p">(</span>
</span><span id="COMPsc-3918"><a href="#COMPsc-3918"><span class="linenos">3918</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc-3919"><a href="#COMPsc-3919"><span class="linenos">3919</span></a>        <span class="n">width</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="COMPsc-3920"><a href="#COMPsc-3920"><span class="linenos">3920</span></a>        <span class="n">height</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="COMPsc-3921"><a href="#COMPsc-3921"><span class="linenos">3921</span></a>        <span class="n">font_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="COMPsc-3922"><a href="#COMPsc-3922"><span class="linenos">3922</span></a>        <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tab20&quot;</span><span class="p">,</span>
</span><span id="COMPsc-3923"><a href="#COMPsc-3923"><span class="linenos">3923</span></a>        <span class="n">legend_split_col</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc-3924"><a href="#COMPsc-3924"><span class="linenos">3924</span></a>        <span class="n">offset_labels</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="COMPsc-3925"><a href="#COMPsc-3925"><span class="linenos">3925</span></a>        <span class="n">legend_bbox</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.15</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
</span><span id="COMPsc-3926"><a href="#COMPsc-3926"><span class="linenos">3926</span></a>    <span class="p">):</span>
</span><span id="COMPsc-3927"><a href="#COMPsc-3927"><span class="linenos">3927</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-3928"><a href="#COMPsc-3928"><span class="linenos">3928</span></a><span class="sd">        Visualize the composition of cell lineages using pie charts.</span>
</span><span id="COMPsc-3929"><a href="#COMPsc-3929"><span class="linenos">3929</span></a>
</span><span id="COMPsc-3930"><a href="#COMPsc-3930"><span class="linenos">3930</span></a><span class="sd">        Generates pie charts showing the relative proportions of features stored</span>
</span><span id="COMPsc-3931"><a href="#COMPsc-3931"><span class="linenos">3931</span></a><span class="sd">        in `self.composition_data`. If multiple sets are present, a separate</span>
</span><span id="COMPsc-3932"><a href="#COMPsc-3932"><span class="linenos">3932</span></a><span class="sd">        chart is drawn for each set.</span>
</span><span id="COMPsc-3933"><a href="#COMPsc-3933"><span class="linenos">3933</span></a>
</span><span id="COMPsc-3934"><a href="#COMPsc-3934"><span class="linenos">3934</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-3935"><a href="#COMPsc-3935"><span class="linenos">3935</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-3936"><a href="#COMPsc-3936"><span class="linenos">3936</span></a><span class="sd">        width : int, default 6</span>
</span><span id="COMPsc-3937"><a href="#COMPsc-3937"><span class="linenos">3937</span></a><span class="sd">            Width of the figure.</span>
</span><span id="COMPsc-3938"><a href="#COMPsc-3938"><span class="linenos">3938</span></a>
</span><span id="COMPsc-3939"><a href="#COMPsc-3939"><span class="linenos">3939</span></a><span class="sd">        height : int, default 6</span>
</span><span id="COMPsc-3940"><a href="#COMPsc-3940"><span class="linenos">3940</span></a><span class="sd">            Height of the figure (applied per set if multiple sets are plotted).</span>
</span><span id="COMPsc-3941"><a href="#COMPsc-3941"><span class="linenos">3941</span></a>
</span><span id="COMPsc-3942"><a href="#COMPsc-3942"><span class="linenos">3942</span></a><span class="sd">        font_size : int, default 15</span>
</span><span id="COMPsc-3943"><a href="#COMPsc-3943"><span class="linenos">3943</span></a><span class="sd">            Font size for labels and annotations.</span>
</span><span id="COMPsc-3944"><a href="#COMPsc-3944"><span class="linenos">3944</span></a>
</span><span id="COMPsc-3945"><a href="#COMPsc-3945"><span class="linenos">3945</span></a><span class="sd">        cmap : str, default &#39;tab20&#39;</span>
</span><span id="COMPsc-3946"><a href="#COMPsc-3946"><span class="linenos">3946</span></a><span class="sd">            Colormap used for pie slices.</span>
</span><span id="COMPsc-3947"><a href="#COMPsc-3947"><span class="linenos">3947</span></a>
</span><span id="COMPsc-3948"><a href="#COMPsc-3948"><span class="linenos">3948</span></a><span class="sd">        legend_split_col : int, default 1</span>
</span><span id="COMPsc-3949"><a href="#COMPsc-3949"><span class="linenos">3949</span></a><span class="sd">            Number of columns in the legend.</span>
</span><span id="COMPsc-3950"><a href="#COMPsc-3950"><span class="linenos">3950</span></a>
</span><span id="COMPsc-3951"><a href="#COMPsc-3951"><span class="linenos">3951</span></a><span class="sd">        offset_labels : float or int, default 0.5</span>
</span><span id="COMPsc-3952"><a href="#COMPsc-3952"><span class="linenos">3952</span></a><span class="sd">            Spacing offset for label placement relative to pie slices.</span>
</span><span id="COMPsc-3953"><a href="#COMPsc-3953"><span class="linenos">3953</span></a>
</span><span id="COMPsc-3954"><a href="#COMPsc-3954"><span class="linenos">3954</span></a><span class="sd">        legend_bbox : tuple, default (1.15, 0.95)</span>
</span><span id="COMPsc-3955"><a href="#COMPsc-3955"><span class="linenos">3955</span></a><span class="sd">            Bounding box anchor position for the legend.</span>
</span><span id="COMPsc-3956"><a href="#COMPsc-3956"><span class="linenos">3956</span></a>
</span><span id="COMPsc-3957"><a href="#COMPsc-3957"><span class="linenos">3957</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc-3958"><a href="#COMPsc-3958"><span class="linenos">3958</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-3959"><a href="#COMPsc-3959"><span class="linenos">3959</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc-3960"><a href="#COMPsc-3960"><span class="linenos">3960</span></a><span class="sd">            Pie chart visualization of composition data.</span>
</span><span id="COMPsc-3961"><a href="#COMPsc-3961"><span class="linenos">3961</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-3962"><a href="#COMPsc-3962"><span class="linenos">3962</span></a>
</span><span id="COMPsc-3963"><a href="#COMPsc-3963"><span class="linenos">3963</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_data</span>
</span><span id="COMPsc-3964"><a href="#COMPsc-3964"><span class="linenos">3964</span></a>
</span><span id="COMPsc-3965"><a href="#COMPsc-3965"><span class="linenos">3965</span></a>        <span class="k">if</span> <span class="s2">&quot;set&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="COMPsc-3966"><a href="#COMPsc-3966"><span class="linenos">3966</span></a>
</span><span id="COMPsc-3967"><a href="#COMPsc-3967"><span class="linenos">3967</span></a>            <span class="n">sets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]))</span>
</span><span id="COMPsc-3968"><a href="#COMPsc-3968"><span class="linenos">3968</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)))</span>
</span><span id="COMPsc-3969"><a href="#COMPsc-3969"><span class="linenos">3969</span></a>
</span><span id="COMPsc-3970"><a href="#COMPsc-3970"><span class="linenos">3970</span></a>            <span class="n">all_wedges</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc-3971"><a href="#COMPsc-3971"><span class="linenos">3971</span></a>            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="COMPsc-3972"><a href="#COMPsc-3972"><span class="linenos">3972</span></a>
</span><span id="COMPsc-3973"><a href="#COMPsc-3973"><span class="linenos">3973</span></a>            <span class="n">set_nam</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]))</span>
</span><span id="COMPsc-3974"><a href="#COMPsc-3974"><span class="linenos">3974</span></a>
</span><span id="COMPsc-3975"><a href="#COMPsc-3975"><span class="linenos">3975</span></a>            <span class="n">legend_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]))</span>
</span><span id="COMPsc-3976"><a href="#COMPsc-3976"><span class="linenos">3976</span></a>
</span><span id="COMPsc-3977"><a href="#COMPsc-3977"><span class="linenos">3977</span></a>            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">set_nam</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">set_nam</span><span class="p">)]</span>
</span><span id="COMPsc-3978"><a href="#COMPsc-3978"><span class="linenos">3978</span></a>
</span><span id="COMPsc-3979"><a href="#COMPsc-3979"><span class="linenos">3979</span></a>            <span class="n">cmap_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">legend_labels</span><span class="p">,</span> <span class="n">colors</span><span class="p">))</span>
</span><span id="COMPsc-3980"><a href="#COMPsc-3980"><span class="linenos">3980</span></a>
</span><span id="COMPsc-3981"><a href="#COMPsc-3981"><span class="linenos">3981</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sets</span><span class="p">):</span>
</span><span id="COMPsc-3982"><a href="#COMPsc-3982"><span class="linenos">3982</span></a>                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="COMPsc-3983"><a href="#COMPsc-3983"><span class="linenos">3983</span></a>                <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="COMPsc-3984"><a href="#COMPsc-3984"><span class="linenos">3984</span></a>
</span><span id="COMPsc-3985"><a href="#COMPsc-3985"><span class="linenos">3985</span></a>                <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tmp_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
</span><span id="COMPsc-3986"><a href="#COMPsc-3986"><span class="linenos">3986</span></a>
</span><span id="COMPsc-3987"><a href="#COMPsc-3987"><span class="linenos">3987</span></a>                <span class="n">wedges</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span>
</span><span id="COMPsc-3988"><a href="#COMPsc-3988"><span class="linenos">3988</span></a>                    <span class="n">tmp_df</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">],</span>
</span><span id="COMPsc-3989"><a href="#COMPsc-3989"><span class="linenos">3989</span></a>                    <span class="n">startangle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
</span><span id="COMPsc-3990"><a href="#COMPsc-3990"><span class="linenos">3990</span></a>                    <span class="n">labeldistance</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span>
</span><span id="COMPsc-3991"><a href="#COMPsc-3991"><span class="linenos">3991</span></a>                    <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="n">cmap_dict</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tmp_df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]],</span>
</span><span id="COMPsc-3992"><a href="#COMPsc-3992"><span class="linenos">3992</span></a>                    <span class="n">wedgeprops</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;edgecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">},</span>
</span><span id="COMPsc-3993"><a href="#COMPsc-3993"><span class="linenos">3993</span></a>                <span class="p">)</span>
</span><span id="COMPsc-3994"><a href="#COMPsc-3994"><span class="linenos">3994</span></a>
</span><span id="COMPsc-3995"><a href="#COMPsc-3995"><span class="linenos">3995</span></a>                <span class="n">all_wedges</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">wedges</span><span class="p">)</span>
</span><span id="COMPsc-3996"><a href="#COMPsc-3996"><span class="linenos">3996</span></a>
</span><span id="COMPsc-3997"><a href="#COMPsc-3997"><span class="linenos">3997</span></a>                <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
</span><span id="COMPsc-3998"><a href="#COMPsc-3998"><span class="linenos">3998</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="COMPsc-3999"><a href="#COMPsc-3999"><span class="linenos">3999</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wedges</span><span class="p">):</span>
</span><span id="COMPsc-4000"><a href="#COMPsc-4000"><span class="linenos">4000</span></a>                    <span class="n">ang</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">theta2</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">theta1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">theta1</span>
</span><span id="COMPsc-4001"><a href="#COMPsc-4001"><span class="linenos">4001</span></a>                    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
</span><span id="COMPsc-4002"><a href="#COMPsc-4002"><span class="linenos">4002</span></a>                    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
</span><span id="COMPsc-4003"><a href="#COMPsc-4003"><span class="linenos">4003</span></a>                    <span class="n">horizontalalignment</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;left&quot;</span><span class="p">}[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>
</span><span id="COMPsc-4004"><a href="#COMPsc-4004"><span class="linenos">4004</span></a>                    <span class="n">connectionstyle</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;angle,angleA=0,angleB=</span><span class="si">{</span><span class="n">ang</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="COMPsc-4005"><a href="#COMPsc-4005"><span class="linenos">4005</span></a>                    <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;arrowprops&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;connectionstyle&quot;</span><span class="p">:</span> <span class="n">connectionstyle</span><span class="p">})</span>
</span><span id="COMPsc-4006"><a href="#COMPsc-4006"><span class="linenos">4006</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-4007"><a href="#COMPsc-4007"><span class="linenos">4007</span></a>                        <span class="n">n</span> <span class="o">+=</span> <span class="n">offset_labels</span>
</span><span id="COMPsc-4008"><a href="#COMPsc-4008"><span class="linenos">4008</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="COMPsc-4009"><a href="#COMPsc-4009"><span class="linenos">4009</span></a>                            <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="COMPsc-4010"><a href="#COMPsc-4010"><span class="linenos">4010</span></a>                            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
</span><span id="COMPsc-4011"><a href="#COMPsc-4011"><span class="linenos">4011</span></a>                            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">4</span><span class="p">),</span> <span class="mf">1.01</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">y</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)),</span>
</span><span id="COMPsc-4012"><a href="#COMPsc-4012"><span class="linenos">4012</span></a>                            <span class="n">horizontalalignment</span><span class="o">=</span><span class="n">horizontalalignment</span><span class="p">,</span>
</span><span id="COMPsc-4013"><a href="#COMPsc-4013"><span class="linenos">4013</span></a>                            <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
</span><span id="COMPsc-4014"><a href="#COMPsc-4014"><span class="linenos">4014</span></a>                            <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4015"><a href="#COMPsc-4015"><span class="linenos">4015</span></a>                            <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
</span><span id="COMPsc-4016"><a href="#COMPsc-4016"><span class="linenos">4016</span></a>                        <span class="p">)</span>
</span><span id="COMPsc-4017"><a href="#COMPsc-4017"><span class="linenos">4017</span></a>
</span><span id="COMPsc-4018"><a href="#COMPsc-4018"><span class="linenos">4018</span></a>                <span class="n">circle2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
</span><span id="COMPsc-4019"><a href="#COMPsc-4019"><span class="linenos">4019</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle2</span><span class="p">)</span>
</span><span id="COMPsc-4020"><a href="#COMPsc-4020"><span class="linenos">4020</span></a>
</span><span id="COMPsc-4021"><a href="#COMPsc-4021"><span class="linenos">4021</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="COMPsc-4022"><a href="#COMPsc-4022"><span class="linenos">4022</span></a>                    <span class="mi">0</span><span class="p">,</span>
</span><span id="COMPsc-4023"><a href="#COMPsc-4023"><span class="linenos">4023</span></a>                    <span class="mi">0</span><span class="p">,</span>
</span><span id="COMPsc-4024"><a href="#COMPsc-4024"><span class="linenos">4024</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4025"><a href="#COMPsc-4025"><span class="linenos">4025</span></a>                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4026"><a href="#COMPsc-4026"><span class="linenos">4026</span></a>                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4027"><a href="#COMPsc-4027"><span class="linenos">4027</span></a>                    <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
</span><span id="COMPsc-4028"><a href="#COMPsc-4028"><span class="linenos">4028</span></a>                    <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4029"><a href="#COMPsc-4029"><span class="linenos">4029</span></a>                <span class="p">)</span>
</span><span id="COMPsc-4030"><a href="#COMPsc-4030"><span class="linenos">4030</span></a>
</span><span id="COMPsc-4031"><a href="#COMPsc-4031"><span class="linenos">4031</span></a>            <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc-4032"><a href="#COMPsc-4032"><span class="linenos">4032</span></a>                <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">cmap_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
</span><span id="COMPsc-4033"><a href="#COMPsc-4033"><span class="linenos">4033</span></a>                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">legend_labels</span>
</span><span id="COMPsc-4034"><a href="#COMPsc-4034"><span class="linenos">4034</span></a>            <span class="p">]</span>
</span><span id="COMPsc-4035"><a href="#COMPsc-4035"><span class="linenos">4035</span></a>
</span><span id="COMPsc-4036"><a href="#COMPsc-4036"><span class="linenos">4036</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="COMPsc-4037"><a href="#COMPsc-4037"><span class="linenos">4037</span></a>                <span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span>
</span><span id="COMPsc-4038"><a href="#COMPsc-4038"><span class="linenos">4038</span></a>                <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center right&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4039"><a href="#COMPsc-4039"><span class="linenos">4039</span></a>                <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">legend_bbox</span><span class="p">,</span>
</span><span id="COMPsc-4040"><a href="#COMPsc-4040"><span class="linenos">4040</span></a>                <span class="n">ncol</span><span class="o">=</span><span class="n">legend_split_col</span><span class="p">,</span>
</span><span id="COMPsc-4041"><a href="#COMPsc-4041"><span class="linenos">4041</span></a>                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4042"><a href="#COMPsc-4042"><span class="linenos">4042</span></a>            <span class="p">)</span>
</span><span id="COMPsc-4043"><a href="#COMPsc-4043"><span class="linenos">4043</span></a>
</span><span id="COMPsc-4044"><a href="#COMPsc-4044"><span class="linenos">4044</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="COMPsc-4045"><a href="#COMPsc-4045"><span class="linenos">4045</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="COMPsc-4046"><a href="#COMPsc-4046"><span class="linenos">4046</span></a>
</span><span id="COMPsc-4047"><a href="#COMPsc-4047"><span class="linenos">4047</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-4048"><a href="#COMPsc-4048"><span class="linenos">4048</span></a>
</span><span id="COMPsc-4049"><a href="#COMPsc-4049"><span class="linenos">4049</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
</span><span id="COMPsc-4050"><a href="#COMPsc-4050"><span class="linenos">4050</span></a>
</span><span id="COMPsc-4051"><a href="#COMPsc-4051"><span class="linenos">4051</span></a>            <span class="n">legend_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
</span><span id="COMPsc-4052"><a href="#COMPsc-4052"><span class="linenos">4052</span></a>
</span><span id="COMPsc-4053"><a href="#COMPsc-4053"><span class="linenos">4053</span></a>            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="COMPsc-4054"><a href="#COMPsc-4054"><span class="linenos">4054</span></a>            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))]</span>
</span><span id="COMPsc-4055"><a href="#COMPsc-4055"><span class="linenos">4055</span></a>
</span><span id="COMPsc-4056"><a href="#COMPsc-4056"><span class="linenos">4056</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="COMPsc-4057"><a href="#COMPsc-4057"><span class="linenos">4057</span></a>                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
</span><span id="COMPsc-4058"><a href="#COMPsc-4058"><span class="linenos">4058</span></a>            <span class="p">)</span>
</span><span id="COMPsc-4059"><a href="#COMPsc-4059"><span class="linenos">4059</span></a>
</span><span id="COMPsc-4060"><a href="#COMPsc-4060"><span class="linenos">4060</span></a>            <span class="n">wedges</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span>
</span><span id="COMPsc-4061"><a href="#COMPsc-4061"><span class="linenos">4061</span></a>                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">],</span>
</span><span id="COMPsc-4062"><a href="#COMPsc-4062"><span class="linenos">4062</span></a>                <span class="n">startangle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
</span><span id="COMPsc-4063"><a href="#COMPsc-4063"><span class="linenos">4063</span></a>                <span class="n">labeldistance</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span>
</span><span id="COMPsc-4064"><a href="#COMPsc-4064"><span class="linenos">4064</span></a>                <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
</span><span id="COMPsc-4065"><a href="#COMPsc-4065"><span class="linenos">4065</span></a>                <span class="n">wedgeprops</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;edgecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">},</span>
</span><span id="COMPsc-4066"><a href="#COMPsc-4066"><span class="linenos">4066</span></a>            <span class="p">)</span>
</span><span id="COMPsc-4067"><a href="#COMPsc-4067"><span class="linenos">4067</span></a>
</span><span id="COMPsc-4068"><a href="#COMPsc-4068"><span class="linenos">4068</span></a>            <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
</span><span id="COMPsc-4069"><a href="#COMPsc-4069"><span class="linenos">4069</span></a>            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="COMPsc-4070"><a href="#COMPsc-4070"><span class="linenos">4070</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wedges</span><span class="p">):</span>
</span><span id="COMPsc-4071"><a href="#COMPsc-4071"><span class="linenos">4071</span></a>                <span class="n">ang</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">theta2</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">theta1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">theta1</span>
</span><span id="COMPsc-4072"><a href="#COMPsc-4072"><span class="linenos">4072</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
</span><span id="COMPsc-4073"><a href="#COMPsc-4073"><span class="linenos">4073</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
</span><span id="COMPsc-4074"><a href="#COMPsc-4074"><span class="linenos">4074</span></a>                <span class="n">horizontalalignment</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;left&quot;</span><span class="p">}[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>
</span><span id="COMPsc-4075"><a href="#COMPsc-4075"><span class="linenos">4075</span></a>                <span class="n">connectionstyle</span> <span class="o">=</span> <span class="s2">&quot;angle,angleA=0,angleB=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span>
</span><span id="COMPsc-4076"><a href="#COMPsc-4076"><span class="linenos">4076</span></a>                <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;arrowprops&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;connectionstyle&quot;</span><span class="p">:</span> <span class="n">connectionstyle</span><span class="p">})</span>
</span><span id="COMPsc-4077"><a href="#COMPsc-4077"><span class="linenos">4077</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc-4078"><a href="#COMPsc-4078"><span class="linenos">4078</span></a>                    <span class="n">n</span> <span class="o">+=</span> <span class="n">offset_labels</span>
</span><span id="COMPsc-4079"><a href="#COMPsc-4079"><span class="linenos">4079</span></a>
</span><span id="COMPsc-4080"><a href="#COMPsc-4080"><span class="linenos">4080</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="COMPsc-4081"><a href="#COMPsc-4081"><span class="linenos">4081</span></a>                        <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="COMPsc-4082"><a href="#COMPsc-4082"><span class="linenos">4082</span></a>                        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
</span><span id="COMPsc-4083"><a href="#COMPsc-4083"><span class="linenos">4083</span></a>                        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">4</span><span class="p">),</span> <span class="n">y</span> <span class="o">*</span> <span class="mf">1.01</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">y</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)),</span>
</span><span id="COMPsc-4084"><a href="#COMPsc-4084"><span class="linenos">4084</span></a>                        <span class="n">horizontalalignment</span><span class="o">=</span><span class="n">horizontalalignment</span><span class="p">,</span>
</span><span id="COMPsc-4085"><a href="#COMPsc-4085"><span class="linenos">4085</span></a>                        <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
</span><span id="COMPsc-4086"><a href="#COMPsc-4086"><span class="linenos">4086</span></a>                        <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4087"><a href="#COMPsc-4087"><span class="linenos">4087</span></a>                        <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
</span><span id="COMPsc-4088"><a href="#COMPsc-4088"><span class="linenos">4088</span></a>                    <span class="p">)</span>
</span><span id="COMPsc-4089"><a href="#COMPsc-4089"><span class="linenos">4089</span></a>
</span><span id="COMPsc-4090"><a href="#COMPsc-4090"><span class="linenos">4090</span></a>            <span class="n">circle2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
</span><span id="COMPsc-4091"><a href="#COMPsc-4091"><span class="linenos">4091</span></a>            <span class="n">circle2</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
</span><span id="COMPsc-4092"><a href="#COMPsc-4092"><span class="linenos">4092</span></a>
</span><span id="COMPsc-4093"><a href="#COMPsc-4093"><span class="linenos">4093</span></a>            <span class="n">p</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
</span><span id="COMPsc-4094"><a href="#COMPsc-4094"><span class="linenos">4094</span></a>            <span class="n">p</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle2</span><span class="p">)</span>
</span><span id="COMPsc-4095"><a href="#COMPsc-4095"><span class="linenos">4095</span></a>
</span><span id="COMPsc-4096"><a href="#COMPsc-4096"><span class="linenos">4096</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="COMPsc-4097"><a href="#COMPsc-4097"><span class="linenos">4097</span></a>                <span class="n">wedges</span><span class="p">,</span>
</span><span id="COMPsc-4098"><a href="#COMPsc-4098"><span class="linenos">4098</span></a>                <span class="n">legend_labels</span><span class="p">,</span>
</span><span id="COMPsc-4099"><a href="#COMPsc-4099"><span class="linenos">4099</span></a>                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4100"><a href="#COMPsc-4100"><span class="linenos">4100</span></a>                <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4101"><a href="#COMPsc-4101"><span class="linenos">4101</span></a>                <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">legend_bbox</span><span class="p">,</span>
</span><span id="COMPsc-4102"><a href="#COMPsc-4102"><span class="linenos">4102</span></a>                <span class="n">ncol</span><span class="o">=</span><span class="n">legend_split_col</span><span class="p">,</span>
</span><span id="COMPsc-4103"><a href="#COMPsc-4103"><span class="linenos">4103</span></a>            <span class="p">)</span>
</span><span id="COMPsc-4104"><a href="#COMPsc-4104"><span class="linenos">4104</span></a>
</span><span id="COMPsc-4105"><a href="#COMPsc-4105"><span class="linenos">4105</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="COMPsc-4106"><a href="#COMPsc-4106"><span class="linenos">4106</span></a>
</span><span id="COMPsc-4107"><a href="#COMPsc-4107"><span class="linenos">4107</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="COMPsc-4108"><a href="#COMPsc-4108"><span class="linenos">4108</span></a>
</span><span id="COMPsc-4109"><a href="#COMPsc-4109"><span class="linenos">4109</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bar_composition</span><span class="p">(</span>
</span><span id="COMPsc-4110"><a href="#COMPsc-4110"><span class="linenos">4110</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc-4111"><a href="#COMPsc-4111"><span class="linenos">4111</span></a>        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;tab20b&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4112"><a href="#COMPsc-4112"><span class="linenos">4112</span></a>        <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="COMPsc-4113"><a href="#COMPsc-4113"><span class="linenos">4113</span></a>        <span class="n">height</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="COMPsc-4114"><a href="#COMPsc-4114"><span class="linenos">4114</span></a>        <span class="n">font_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="COMPsc-4115"><a href="#COMPsc-4115"><span class="linenos">4115</span></a>        <span class="n">legend_split_col</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc-4116"><a href="#COMPsc-4116"><span class="linenos">4116</span></a>        <span class="n">legend_bbox</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="COMPsc-4117"><a href="#COMPsc-4117"><span class="linenos">4117</span></a>    <span class="p">):</span>
</span><span id="COMPsc-4118"><a href="#COMPsc-4118"><span class="linenos">4118</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-4119"><a href="#COMPsc-4119"><span class="linenos">4119</span></a><span class="sd">        Visualize the composition of cell lineages using bar plots.</span>
</span><span id="COMPsc-4120"><a href="#COMPsc-4120"><span class="linenos">4120</span></a>
</span><span id="COMPsc-4121"><a href="#COMPsc-4121"><span class="linenos">4121</span></a><span class="sd">        Produces bar plots showing the distribution of features stored in</span>
</span><span id="COMPsc-4122"><a href="#COMPsc-4122"><span class="linenos">4122</span></a><span class="sd">        `self.composition_data`. If multiple sets are present, a separate</span>
</span><span id="COMPsc-4123"><a href="#COMPsc-4123"><span class="linenos">4123</span></a><span class="sd">        bar is drawn for each set. Percentages are annotated alongside the bars.</span>
</span><span id="COMPsc-4124"><a href="#COMPsc-4124"><span class="linenos">4124</span></a>
</span><span id="COMPsc-4125"><a href="#COMPsc-4125"><span class="linenos">4125</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-4126"><a href="#COMPsc-4126"><span class="linenos">4126</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-4127"><a href="#COMPsc-4127"><span class="linenos">4127</span></a><span class="sd">        cmap : str, default &#39;tab20b&#39;</span>
</span><span id="COMPsc-4128"><a href="#COMPsc-4128"><span class="linenos">4128</span></a><span class="sd">            Colormap used for stacked bars.</span>
</span><span id="COMPsc-4129"><a href="#COMPsc-4129"><span class="linenos">4129</span></a>
</span><span id="COMPsc-4130"><a href="#COMPsc-4130"><span class="linenos">4130</span></a><span class="sd">        width : int, default 2</span>
</span><span id="COMPsc-4131"><a href="#COMPsc-4131"><span class="linenos">4131</span></a><span class="sd">            Width of each subplot (per set).</span>
</span><span id="COMPsc-4132"><a href="#COMPsc-4132"><span class="linenos">4132</span></a>
</span><span id="COMPsc-4133"><a href="#COMPsc-4133"><span class="linenos">4133</span></a><span class="sd">        height : int, default 6</span>
</span><span id="COMPsc-4134"><a href="#COMPsc-4134"><span class="linenos">4134</span></a><span class="sd">            Height of the figure.</span>
</span><span id="COMPsc-4135"><a href="#COMPsc-4135"><span class="linenos">4135</span></a>
</span><span id="COMPsc-4136"><a href="#COMPsc-4136"><span class="linenos">4136</span></a><span class="sd">        font_size : int, default 15</span>
</span><span id="COMPsc-4137"><a href="#COMPsc-4137"><span class="linenos">4137</span></a><span class="sd">            Font size for labels and annotations.</span>
</span><span id="COMPsc-4138"><a href="#COMPsc-4138"><span class="linenos">4138</span></a>
</span><span id="COMPsc-4139"><a href="#COMPsc-4139"><span class="linenos">4139</span></a><span class="sd">        legend_split_col : int, default 1</span>
</span><span id="COMPsc-4140"><a href="#COMPsc-4140"><span class="linenos">4140</span></a><span class="sd">            Number of columns in the legend.</span>
</span><span id="COMPsc-4141"><a href="#COMPsc-4141"><span class="linenos">4141</span></a>
</span><span id="COMPsc-4142"><a href="#COMPsc-4142"><span class="linenos">4142</span></a><span class="sd">        legend_bbox : tuple, default (1.3, 1)</span>
</span><span id="COMPsc-4143"><a href="#COMPsc-4143"><span class="linenos">4143</span></a><span class="sd">            Bounding box anchor position for the legend.</span>
</span><span id="COMPsc-4144"><a href="#COMPsc-4144"><span class="linenos">4144</span></a>
</span><span id="COMPsc-4145"><a href="#COMPsc-4145"><span class="linenos">4145</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc-4146"><a href="#COMPsc-4146"><span class="linenos">4146</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-4147"><a href="#COMPsc-4147"><span class="linenos">4147</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc-4148"><a href="#COMPsc-4148"><span class="linenos">4148</span></a><span class="sd">            Stacked bar plot visualization of composition data.</span>
</span><span id="COMPsc-4149"><a href="#COMPsc-4149"><span class="linenos">4149</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-4150"><a href="#COMPsc-4150"><span class="linenos">4150</span></a>
</span><span id="COMPsc-4151"><a href="#COMPsc-4151"><span class="linenos">4151</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_data</span>
</span><span id="COMPsc-4152"><a href="#COMPsc-4152"><span class="linenos">4152</span></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc-4153"><a href="#COMPsc-4153"><span class="linenos">4153</span></a>
</span><span id="COMPsc-4154"><a href="#COMPsc-4154"><span class="linenos">4154</span></a>        <span class="k">if</span> <span class="s2">&quot;set&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="COMPsc-4155"><a href="#COMPsc-4155"><span class="linenos">4155</span></a>
</span><span id="COMPsc-4156"><a href="#COMPsc-4156"><span class="linenos">4156</span></a>            <span class="n">sets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]))</span>
</span><span id="COMPsc-4157"><a href="#COMPsc-4157"><span class="linenos">4157</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">),</span> <span class="n">height</span><span class="p">))</span>
</span><span id="COMPsc-4158"><a href="#COMPsc-4158"><span class="linenos">4158</span></a>
</span><span id="COMPsc-4159"><a href="#COMPsc-4159"><span class="linenos">4159</span></a>            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="COMPsc-4160"><a href="#COMPsc-4160"><span class="linenos">4160</span></a>
</span><span id="COMPsc-4161"><a href="#COMPsc-4161"><span class="linenos">4161</span></a>            <span class="n">set_nam</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]))</span>
</span><span id="COMPsc-4162"><a href="#COMPsc-4162"><span class="linenos">4162</span></a>
</span><span id="COMPsc-4163"><a href="#COMPsc-4163"><span class="linenos">4163</span></a>            <span class="n">legend_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]))</span>
</span><span id="COMPsc-4164"><a href="#COMPsc-4164"><span class="linenos">4164</span></a>
</span><span id="COMPsc-4165"><a href="#COMPsc-4165"><span class="linenos">4165</span></a>            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">set_nam</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">set_nam</span><span class="p">)]</span>
</span><span id="COMPsc-4166"><a href="#COMPsc-4166"><span class="linenos">4166</span></a>
</span><span id="COMPsc-4167"><a href="#COMPsc-4167"><span class="linenos">4167</span></a>            <span class="n">cmap_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">legend_labels</span><span class="p">,</span> <span class="n">colors</span><span class="p">))</span>
</span><span id="COMPsc-4168"><a href="#COMPsc-4168"><span class="linenos">4168</span></a>
</span><span id="COMPsc-4169"><a href="#COMPsc-4169"><span class="linenos">4169</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sets</span><span class="p">):</span>
</span><span id="COMPsc-4170"><a href="#COMPsc-4170"><span class="linenos">4170</span></a>                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="COMPsc-4171"><a href="#COMPsc-4171"><span class="linenos">4171</span></a>
</span><span id="COMPsc-4172"><a href="#COMPsc-4172"><span class="linenos">4172</span></a>                <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="COMPsc-4173"><a href="#COMPsc-4173"><span class="linenos">4173</span></a>
</span><span id="COMPsc-4174"><a href="#COMPsc-4174"><span class="linenos">4174</span></a>                <span class="n">values</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="COMPsc-4175"><a href="#COMPsc-4175"><span class="linenos">4175</span></a>                <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</span><span id="COMPsc-4176"><a href="#COMPsc-4176"><span class="linenos">4176</span></a>                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
</span><span id="COMPsc-4177"><a href="#COMPsc-4177"><span class="linenos">4177</span></a>                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
</span><span id="COMPsc-4178"><a href="#COMPsc-4178"><span class="linenos">4178</span></a>
</span><span id="COMPsc-4179"><a href="#COMPsc-4179"><span class="linenos">4179</span></a>                <span class="n">idx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</span><span id="COMPsc-4180"><a href="#COMPsc-4180"><span class="linenos">4180</span></a>                <span class="n">correction</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</span><span id="COMPsc-4181"><a href="#COMPsc-4181"><span class="linenos">4181</span></a>                <span class="n">values</span><span class="p">[</span><span class="n">idx_max</span><span class="p">]</span> <span class="o">+=</span> <span class="n">correction</span>
</span><span id="COMPsc-4182"><a href="#COMPsc-4182"><span class="linenos">4182</span></a>
</span><span id="COMPsc-4183"><a href="#COMPsc-4183"><span class="linenos">4183</span></a>                <span class="n">names</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="COMPsc-4184"><a href="#COMPsc-4184"><span class="linenos">4184</span></a>                <span class="n">perc</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="COMPsc-4185"><a href="#COMPsc-4185"><span class="linenos">4185</span></a>                <span class="n">nums</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="p">[</span><span class="s2">&quot;num&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="COMPsc-4186"><a href="#COMPsc-4186"><span class="linenos">4186</span></a>
</span><span id="COMPsc-4187"><a href="#COMPsc-4187"><span class="linenos">4187</span></a>                <span class="n">bottom</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="COMPsc-4188"><a href="#COMPsc-4188"><span class="linenos">4188</span></a>                <span class="n">centers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc-4189"><a href="#COMPsc-4189"><span class="linenos">4189</span></a>                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">nums</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
</span><span id="COMPsc-4190"><a href="#COMPsc-4190"><span class="linenos">4190</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">bottom</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap_dict</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</span><span id="COMPsc-4191"><a href="#COMPsc-4191"><span class="linenos">4191</span></a>                    <span class="n">centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bottom</span> <span class="o">+</span> <span class="n">val</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="COMPsc-4192"><a href="#COMPsc-4192"><span class="linenos">4192</span></a>                    <span class="n">bottom</span> <span class="o">+=</span> <span class="n">val</span>
</span><span id="COMPsc-4193"><a href="#COMPsc-4193"><span class="linenos">4193</span></a>
</span><span id="COMPsc-4194"><a href="#COMPsc-4194"><span class="linenos">4194</span></a>                <span class="n">y_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">centers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">centers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">centers</span><span class="p">))</span>
</span><span id="COMPsc-4195"><a href="#COMPsc-4195"><span class="linenos">4195</span></a>                <span class="n">x_text</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.8</span>
</span><span id="COMPsc-4196"><a href="#COMPsc-4196"><span class="linenos">4196</span></a>
</span><span id="COMPsc-4197"><a href="#COMPsc-4197"><span class="linenos">4197</span></a>                <span class="k">for</span> <span class="n">y_label</span><span class="p">,</span> <span class="n">y_center</span><span class="p">,</span> <span class="n">pct</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
</span><span id="COMPsc-4198"><a href="#COMPsc-4198"><span class="linenos">4198</span></a>                    <span class="n">y_positions</span><span class="p">,</span> <span class="n">centers</span><span class="p">,</span> <span class="n">perc</span><span class="p">,</span> <span class="n">nums</span>
</span><span id="COMPsc-4199"><a href="#COMPsc-4199"><span class="linenos">4199</span></a>                <span class="p">):</span>
</span><span id="COMPsc-4200"><a href="#COMPsc-4200"><span class="linenos">4200</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="COMPsc-4201"><a href="#COMPsc-4201"><span class="linenos">4201</span></a>                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4202"><a href="#COMPsc-4202"><span class="linenos">4202</span></a>                        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_center</span><span class="p">),</span>
</span><span id="COMPsc-4203"><a href="#COMPsc-4203"><span class="linenos">4203</span></a>                        <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4204"><a href="#COMPsc-4204"><span class="linenos">4204</span></a>                        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">x_text</span><span class="p">,</span> <span class="n">y_label</span><span class="p">),</span>
</span><span id="COMPsc-4205"><a href="#COMPsc-4205"><span class="linenos">4205</span></a>                        <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4206"><a href="#COMPsc-4206"><span class="linenos">4206</span></a>                        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4207"><a href="#COMPsc-4207"><span class="linenos">4207</span></a>                        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4208"><a href="#COMPsc-4208"><span class="linenos">4208</span></a>                        <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
</span><span id="COMPsc-4209"><a href="#COMPsc-4209"><span class="linenos">4209</span></a>                        <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="COMPsc-4210"><a href="#COMPsc-4210"><span class="linenos">4210</span></a>                            <span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4211"><a href="#COMPsc-4211"><span class="linenos">4211</span></a>                            <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc-4212"><a href="#COMPsc-4212"><span class="linenos">4212</span></a>                            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4213"><a href="#COMPsc-4213"><span class="linenos">4213</span></a>                            <span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;angle3,angleA=0,angleB=90&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4214"><a href="#COMPsc-4214"><span class="linenos">4214</span></a>                        <span class="p">),</span>
</span><span id="COMPsc-4215"><a href="#COMPsc-4215"><span class="linenos">4215</span></a>                    <span class="p">)</span>
</span><span id="COMPsc-4216"><a href="#COMPsc-4216"><span class="linenos">4216</span></a>
</span><span id="COMPsc-4217"><a href="#COMPsc-4217"><span class="linenos">4217</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="COMPsc-4218"><a href="#COMPsc-4218"><span class="linenos">4218</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
</span><span id="COMPsc-4219"><a href="#COMPsc-4219"><span class="linenos">4219</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="COMPsc-4220"><a href="#COMPsc-4220"><span class="linenos">4220</span></a>
</span><span id="COMPsc-4221"><a href="#COMPsc-4221"><span class="linenos">4221</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
</span><span id="COMPsc-4222"><a href="#COMPsc-4222"><span class="linenos">4222</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
</span><span id="COMPsc-4223"><a href="#COMPsc-4223"><span class="linenos">4223</span></a>                <span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="COMPsc-4224"><a href="#COMPsc-4224"><span class="linenos">4224</span></a>                    <span class="n">spine</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="COMPsc-4225"><a href="#COMPsc-4225"><span class="linenos">4225</span></a>
</span><span id="COMPsc-4226"><a href="#COMPsc-4226"><span class="linenos">4226</span></a>            <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc-4227"><a href="#COMPsc-4227"><span class="linenos">4227</span></a>                <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">cmap_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
</span><span id="COMPsc-4228"><a href="#COMPsc-4228"><span class="linenos">4228</span></a>                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">legend_labels</span>
</span><span id="COMPsc-4229"><a href="#COMPsc-4229"><span class="linenos">4229</span></a>            <span class="p">]</span>
</span><span id="COMPsc-4230"><a href="#COMPsc-4230"><span class="linenos">4230</span></a>
</span><span id="COMPsc-4231"><a href="#COMPsc-4231"><span class="linenos">4231</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="COMPsc-4232"><a href="#COMPsc-4232"><span class="linenos">4232</span></a>                <span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span>
</span><span id="COMPsc-4233"><a href="#COMPsc-4233"><span class="linenos">4233</span></a>                <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center right&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4234"><a href="#COMPsc-4234"><span class="linenos">4234</span></a>                <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">legend_bbox</span><span class="p">,</span>
</span><span id="COMPsc-4235"><a href="#COMPsc-4235"><span class="linenos">4235</span></a>                <span class="n">ncol</span><span class="o">=</span><span class="n">legend_split_col</span><span class="p">,</span>
</span><span id="COMPsc-4236"><a href="#COMPsc-4236"><span class="linenos">4236</span></a>                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4237"><a href="#COMPsc-4237"><span class="linenos">4237</span></a>            <span class="p">)</span>
</span><span id="COMPsc-4238"><a href="#COMPsc-4238"><span class="linenos">4238</span></a>
</span><span id="COMPsc-4239"><a href="#COMPsc-4239"><span class="linenos">4239</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="COMPsc-4240"><a href="#COMPsc-4240"><span class="linenos">4240</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="COMPsc-4241"><a href="#COMPsc-4241"><span class="linenos">4241</span></a>
</span><span id="COMPsc-4242"><a href="#COMPsc-4242"><span class="linenos">4242</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-4243"><a href="#COMPsc-4243"><span class="linenos">4243</span></a>
</span><span id="COMPsc-4244"><a href="#COMPsc-4244"><span class="linenos">4244</span></a>            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="COMPsc-4245"><a href="#COMPsc-4245"><span class="linenos">4245</span></a>
</span><span id="COMPsc-4246"><a href="#COMPsc-4246"><span class="linenos">4246</span></a>            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))]</span>
</span><span id="COMPsc-4247"><a href="#COMPsc-4247"><span class="linenos">4247</span></a>
</span><span id="COMPsc-4248"><a href="#COMPsc-4248"><span class="linenos">4248</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="COMPsc-4249"><a href="#COMPsc-4249"><span class="linenos">4249</span></a>
</span><span id="COMPsc-4250"><a href="#COMPsc-4250"><span class="linenos">4250</span></a>            <span class="n">values</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="COMPsc-4251"><a href="#COMPsc-4251"><span class="linenos">4251</span></a>            <span class="n">names</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="COMPsc-4252"><a href="#COMPsc-4252"><span class="linenos">4252</span></a>            <span class="n">perc</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="COMPsc-4253"><a href="#COMPsc-4253"><span class="linenos">4253</span></a>            <span class="n">nums</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;num&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="COMPsc-4254"><a href="#COMPsc-4254"><span class="linenos">4254</span></a>
</span><span id="COMPsc-4255"><a href="#COMPsc-4255"><span class="linenos">4255</span></a>            <span class="n">bottom</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="COMPsc-4256"><a href="#COMPsc-4256"><span class="linenos">4256</span></a>            <span class="n">centers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc-4257"><a href="#COMPsc-4257"><span class="linenos">4257</span></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">nums</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
</span><span id="COMPsc-4258"><a href="#COMPsc-4258"><span class="linenos">4258</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">bottom</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="COMPsc-4259"><a href="#COMPsc-4259"><span class="linenos">4259</span></a>                <span class="n">centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bottom</span> <span class="o">+</span> <span class="n">val</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="COMPsc-4260"><a href="#COMPsc-4260"><span class="linenos">4260</span></a>                <span class="n">bottom</span> <span class="o">+=</span> <span class="n">val</span>
</span><span id="COMPsc-4261"><a href="#COMPsc-4261"><span class="linenos">4261</span></a>
</span><span id="COMPsc-4262"><a href="#COMPsc-4262"><span class="linenos">4262</span></a>            <span class="n">y_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">centers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">centers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">centers</span><span class="p">))</span>
</span><span id="COMPsc-4263"><a href="#COMPsc-4263"><span class="linenos">4263</span></a>            <span class="n">x_text</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.8</span>
</span><span id="COMPsc-4264"><a href="#COMPsc-4264"><span class="linenos">4264</span></a>
</span><span id="COMPsc-4265"><a href="#COMPsc-4265"><span class="linenos">4265</span></a>            <span class="k">for</span> <span class="n">y_label</span><span class="p">,</span> <span class="n">y_center</span><span class="p">,</span> <span class="n">pct</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">y_positions</span><span class="p">,</span> <span class="n">centers</span><span class="p">,</span> <span class="n">perc</span><span class="p">,</span> <span class="n">nums</span><span class="p">):</span>
</span><span id="COMPsc-4266"><a href="#COMPsc-4266"><span class="linenos">4266</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="COMPsc-4267"><a href="#COMPsc-4267"><span class="linenos">4267</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="n">pct</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4268"><a href="#COMPsc-4268"><span class="linenos">4268</span></a>                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_center</span><span class="p">),</span>
</span><span id="COMPsc-4269"><a href="#COMPsc-4269"><span class="linenos">4269</span></a>                    <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4270"><a href="#COMPsc-4270"><span class="linenos">4270</span></a>                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">x_text</span><span class="p">,</span> <span class="n">y_label</span><span class="p">),</span>
</span><span id="COMPsc-4271"><a href="#COMPsc-4271"><span class="linenos">4271</span></a>                    <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4272"><a href="#COMPsc-4272"><span class="linenos">4272</span></a>                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4273"><a href="#COMPsc-4273"><span class="linenos">4273</span></a>                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4274"><a href="#COMPsc-4274"><span class="linenos">4274</span></a>                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
</span><span id="COMPsc-4275"><a href="#COMPsc-4275"><span class="linenos">4275</span></a>                    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="COMPsc-4276"><a href="#COMPsc-4276"><span class="linenos">4276</span></a>                        <span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4277"><a href="#COMPsc-4277"><span class="linenos">4277</span></a>                        <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc-4278"><a href="#COMPsc-4278"><span class="linenos">4278</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4279"><a href="#COMPsc-4279"><span class="linenos">4279</span></a>                        <span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;angle3,angleA=0,angleB=90&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4280"><a href="#COMPsc-4280"><span class="linenos">4280</span></a>                    <span class="p">),</span>
</span><span id="COMPsc-4281"><a href="#COMPsc-4281"><span class="linenos">4281</span></a>                <span class="p">)</span>
</span><span id="COMPsc-4282"><a href="#COMPsc-4282"><span class="linenos">4282</span></a>
</span><span id="COMPsc-4283"><a href="#COMPsc-4283"><span class="linenos">4283</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
</span><span id="COMPsc-4284"><a href="#COMPsc-4284"><span class="linenos">4284</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
</span><span id="COMPsc-4285"><a href="#COMPsc-4285"><span class="linenos">4285</span></a>            <span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="COMPsc-4286"><a href="#COMPsc-4286"><span class="linenos">4286</span></a>                <span class="n">spine</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="COMPsc-4287"><a href="#COMPsc-4287"><span class="linenos">4287</span></a>
</span><span id="COMPsc-4288"><a href="#COMPsc-4288"><span class="linenos">4288</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="COMPsc-4289"><a href="#COMPsc-4289"><span class="linenos">4289</span></a>                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Legend&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4290"><a href="#COMPsc-4290"><span class="linenos">4290</span></a>                <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">legend_bbox</span><span class="p">,</span>
</span><span id="COMPsc-4291"><a href="#COMPsc-4291"><span class="linenos">4291</span></a>                <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4292"><a href="#COMPsc-4292"><span class="linenos">4292</span></a>                <span class="n">ncol</span><span class="o">=</span><span class="n">legend_split_col</span><span class="p">,</span>
</span><span id="COMPsc-4293"><a href="#COMPsc-4293"><span class="linenos">4293</span></a>            <span class="p">)</span>
</span><span id="COMPsc-4294"><a href="#COMPsc-4294"><span class="linenos">4294</span></a>
</span><span id="COMPsc-4295"><a href="#COMPsc-4295"><span class="linenos">4295</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="COMPsc-4296"><a href="#COMPsc-4296"><span class="linenos">4296</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="COMPsc-4297"><a href="#COMPsc-4297"><span class="linenos">4297</span></a>
</span><span id="COMPsc-4298"><a href="#COMPsc-4298"><span class="linenos">4298</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="COMPsc-4299"><a href="#COMPsc-4299"><span class="linenos">4299</span></a>
</span><span id="COMPsc-4300"><a href="#COMPsc-4300"><span class="linenos">4300</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cell_regression</span><span class="p">(</span>
</span><span id="COMPsc-4301"><a href="#COMPsc-4301"><span class="linenos">4301</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc-4302"><a href="#COMPsc-4302"><span class="linenos">4302</span></a>        <span class="n">cell_x</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="COMPsc-4303"><a href="#COMPsc-4303"><span class="linenos">4303</span></a>        <span class="n">cell_y</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="COMPsc-4304"><a href="#COMPsc-4304"><span class="linenos">4304</span></a>        <span class="n">set_x</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-4305"><a href="#COMPsc-4305"><span class="linenos">4305</span></a>        <span class="n">set_y</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc-4306"><a href="#COMPsc-4306"><span class="linenos">4306</span></a>        <span class="n">threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="COMPsc-4307"><a href="#COMPsc-4307"><span class="linenos">4307</span></a>        <span class="n">image_width</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="COMPsc-4308"><a href="#COMPsc-4308"><span class="linenos">4308</span></a>        <span class="n">image_high</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
</span><span id="COMPsc-4309"><a href="#COMPsc-4309"><span class="linenos">4309</span></a>        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4310"><a href="#COMPsc-4310"><span class="linenos">4310</span></a>    <span class="p">):</span>
</span><span id="COMPsc-4311"><a href="#COMPsc-4311"><span class="linenos">4311</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc-4312"><a href="#COMPsc-4312"><span class="linenos">4312</span></a><span class="sd">        Perform regression analysis between two selected cells and visualize the relationship.</span>
</span><span id="COMPsc-4313"><a href="#COMPsc-4313"><span class="linenos">4313</span></a>
</span><span id="COMPsc-4314"><a href="#COMPsc-4314"><span class="linenos">4314</span></a><span class="sd">        This function computes a linear regression between two specified cells from</span>
</span><span id="COMPsc-4315"><a href="#COMPsc-4315"><span class="linenos">4315</span></a><span class="sd">        aggregated normalized data, plots the regression line with scatter points,</span>
</span><span id="COMPsc-4316"><a href="#COMPsc-4316"><span class="linenos">4316</span></a><span class="sd">        annotates regression statistics, and highlights potential outliers.</span>
</span><span id="COMPsc-4317"><a href="#COMPsc-4317"><span class="linenos">4317</span></a>
</span><span id="COMPsc-4318"><a href="#COMPsc-4318"><span class="linenos">4318</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc-4319"><a href="#COMPsc-4319"><span class="linenos">4319</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc-4320"><a href="#COMPsc-4320"><span class="linenos">4320</span></a><span class="sd">        cell_x : str</span>
</span><span id="COMPsc-4321"><a href="#COMPsc-4321"><span class="linenos">4321</span></a><span class="sd">            Name of the first cell (X-axis).</span>
</span><span id="COMPsc-4322"><a href="#COMPsc-4322"><span class="linenos">4322</span></a>
</span><span id="COMPsc-4323"><a href="#COMPsc-4323"><span class="linenos">4323</span></a><span class="sd">        cell_y : str</span>
</span><span id="COMPsc-4324"><a href="#COMPsc-4324"><span class="linenos">4324</span></a><span class="sd">            Name of the second cell (Y-axis).</span>
</span><span id="COMPsc-4325"><a href="#COMPsc-4325"><span class="linenos">4325</span></a>
</span><span id="COMPsc-4326"><a href="#COMPsc-4326"><span class="linenos">4326</span></a><span class="sd">        set_x : str or None</span>
</span><span id="COMPsc-4327"><a href="#COMPsc-4327"><span class="linenos">4327</span></a><span class="sd">            Dataset identifier corresponding to `cell_x`. If None, cell is selected only by name.</span>
</span><span id="COMPsc-4328"><a href="#COMPsc-4328"><span class="linenos">4328</span></a>
</span><span id="COMPsc-4329"><a href="#COMPsc-4329"><span class="linenos">4329</span></a><span class="sd">        set_y : str or None</span>
</span><span id="COMPsc-4330"><a href="#COMPsc-4330"><span class="linenos">4330</span></a><span class="sd">            Dataset identifier corresponding to `cell_y`. If None, cell is selected only by name.</span>
</span><span id="COMPsc-4331"><a href="#COMPsc-4331"><span class="linenos">4331</span></a>
</span><span id="COMPsc-4332"><a href="#COMPsc-4332"><span class="linenos">4332</span></a><span class="sd">        threshold : int or float, default 10</span>
</span><span id="COMPsc-4333"><a href="#COMPsc-4333"><span class="linenos">4333</span></a><span class="sd">            Threshold for detecting outliers. Points deviating from the mean or diagonal by more</span>
</span><span id="COMPsc-4334"><a href="#COMPsc-4334"><span class="linenos">4334</span></a><span class="sd">            than this value are annotated.</span>
</span><span id="COMPsc-4335"><a href="#COMPsc-4335"><span class="linenos">4335</span></a>
</span><span id="COMPsc-4336"><a href="#COMPsc-4336"><span class="linenos">4336</span></a><span class="sd">        image_width : int, default 12</span>
</span><span id="COMPsc-4337"><a href="#COMPsc-4337"><span class="linenos">4337</span></a><span class="sd">            Width of the regression plot (in inches).</span>
</span><span id="COMPsc-4338"><a href="#COMPsc-4338"><span class="linenos">4338</span></a>
</span><span id="COMPsc-4339"><a href="#COMPsc-4339"><span class="linenos">4339</span></a><span class="sd">        image_high : int, default 7</span>
</span><span id="COMPsc-4340"><a href="#COMPsc-4340"><span class="linenos">4340</span></a><span class="sd">            Height of the regression plot (in inches).</span>
</span><span id="COMPsc-4341"><a href="#COMPsc-4341"><span class="linenos">4341</span></a>
</span><span id="COMPsc-4342"><a href="#COMPsc-4342"><span class="linenos">4342</span></a><span class="sd">        color : str, default &#39;black&#39;</span>
</span><span id="COMPsc-4343"><a href="#COMPsc-4343"><span class="linenos">4343</span></a><span class="sd">            Color of the regression scatter points and line.</span>
</span><span id="COMPsc-4344"><a href="#COMPsc-4344"><span class="linenos">4344</span></a>
</span><span id="COMPsc-4345"><a href="#COMPsc-4345"><span class="linenos">4345</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc-4346"><a href="#COMPsc-4346"><span class="linenos">4346</span></a><span class="sd">        -------</span>
</span><span id="COMPsc-4347"><a href="#COMPsc-4347"><span class="linenos">4347</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc-4348"><a href="#COMPsc-4348"><span class="linenos">4348</span></a><span class="sd">            Regression plot figure with annotated regression line, R², p-value, and outliers.</span>
</span><span id="COMPsc-4349"><a href="#COMPsc-4349"><span class="linenos">4349</span></a>
</span><span id="COMPsc-4350"><a href="#COMPsc-4350"><span class="linenos">4350</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc-4351"><a href="#COMPsc-4351"><span class="linenos">4351</span></a><span class="sd">        ------</span>
</span><span id="COMPsc-4352"><a href="#COMPsc-4352"><span class="linenos">4352</span></a><span class="sd">        ValueError</span>
</span><span id="COMPsc-4353"><a href="#COMPsc-4353"><span class="linenos">4353</span></a><span class="sd">            If `cell_x` or `cell_y` are not found in the dataset.</span>
</span><span id="COMPsc-4354"><a href="#COMPsc-4354"><span class="linenos">4354</span></a><span class="sd">            If multiple matches are found for a cell name and `set_x`/`set_y` are not specified.</span>
</span><span id="COMPsc-4355"><a href="#COMPsc-4355"><span class="linenos">4355</span></a>
</span><span id="COMPsc-4356"><a href="#COMPsc-4356"><span class="linenos">4356</span></a><span class="sd">        Notes</span>
</span><span id="COMPsc-4357"><a href="#COMPsc-4357"><span class="linenos">4357</span></a><span class="sd">        -----</span>
</span><span id="COMPsc-4358"><a href="#COMPsc-4358"><span class="linenos">4358</span></a><span class="sd">        - The function automatically calls `jseq_object.average()` if aggregated data is not available.</span>
</span><span id="COMPsc-4359"><a href="#COMPsc-4359"><span class="linenos">4359</span></a><span class="sd">        - Outliers are annotated with their corresponding index labels.</span>
</span><span id="COMPsc-4360"><a href="#COMPsc-4360"><span class="linenos">4360</span></a><span class="sd">        - Regression is computed using `scipy.stats.linregress`.</span>
</span><span id="COMPsc-4361"><a href="#COMPsc-4361"><span class="linenos">4361</span></a>
</span><span id="COMPsc-4362"><a href="#COMPsc-4362"><span class="linenos">4362</span></a><span class="sd">        Examples</span>
</span><span id="COMPsc-4363"><a href="#COMPsc-4363"><span class="linenos">4363</span></a><span class="sd">        --------</span>
</span><span id="COMPsc-4364"><a href="#COMPsc-4364"><span class="linenos">4364</span></a><span class="sd">        &gt;&gt;&gt; obj.cell_regression(cell_x=&quot;Purkinje&quot;, cell_y=&quot;Granule&quot;, set_x=&quot;Exp1&quot;, set_y=&quot;Exp2&quot;)</span>
</span><span id="COMPsc-4365"><a href="#COMPsc-4365"><span class="linenos">4365</span></a><span class="sd">        &gt;&gt;&gt; obj.cell_regression(cell_x=&quot;NeuronA&quot;, cell_y=&quot;NeuronB&quot;, threshold=5, color=&quot;blue&quot;)</span>
</span><span id="COMPsc-4366"><a href="#COMPsc-4366"><span class="linenos">4366</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc-4367"><a href="#COMPsc-4367"><span class="linenos">4367</span></a>
</span><span id="COMPsc-4368"><a href="#COMPsc-4368"><span class="linenos">4368</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-4369"><a href="#COMPsc-4369"><span class="linenos">4369</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
</span><span id="COMPsc-4370"><a href="#COMPsc-4370"><span class="linenos">4370</span></a>
</span><span id="COMPsc-4371"><a href="#COMPsc-4371"><span class="linenos">4371</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span>
</span><span id="COMPsc-4372"><a href="#COMPsc-4372"><span class="linenos">4372</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span>
</span><span id="COMPsc-4373"><a href="#COMPsc-4373"><span class="linenos">4373</span></a>
</span><span id="COMPsc-4374"><a href="#COMPsc-4374"><span class="linenos">4374</span></a>        <span class="k">if</span> <span class="n">set_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">set_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc-4375"><a href="#COMPsc-4375"><span class="linenos">4375</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc-4376"><a href="#COMPsc-4376"><span class="linenos">4376</span></a>            <span class="n">cell_x</span> <span class="o">=</span> <span class="n">cell_x</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="n">set_x</span>
</span><span id="COMPsc-4377"><a href="#COMPsc-4377"><span class="linenos">4377</span></a>            <span class="n">cell_y</span> <span class="o">=</span> <span class="n">cell_y</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="n">set_y</span>
</span><span id="COMPsc-4378"><a href="#COMPsc-4378"><span class="linenos">4378</span></a>
</span><span id="COMPsc-4379"><a href="#COMPsc-4379"><span class="linenos">4379</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc-4380"><a href="#COMPsc-4380"><span class="linenos">4380</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span>
</span><span id="COMPsc-4381"><a href="#COMPsc-4381"><span class="linenos">4381</span></a>
</span><span id="COMPsc-4382"><a href="#COMPsc-4382"><span class="linenos">4382</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_x</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="COMPsc-4383"><a href="#COMPsc-4383"><span class="linenos">4383</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;cell_x&#39; value not in cell names!&quot;</span><span class="p">)</span>
</span><span id="COMPsc-4384"><a href="#COMPsc-4384"><span class="linenos">4384</span></a>
</span><span id="COMPsc-4385"><a href="#COMPsc-4385"><span class="linenos">4385</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_y</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="COMPsc-4386"><a href="#COMPsc-4386"><span class="linenos">4386</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;cell_y&#39; value not in cell names!&quot;</span><span class="p">)</span>
</span><span id="COMPsc-4387"><a href="#COMPsc-4387"><span class="linenos">4387</span></a>
</span><span id="COMPsc-4388"><a href="#COMPsc-4388"><span class="linenos">4388</span></a>        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">cell_x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="COMPsc-4389"><a href="#COMPsc-4389"><span class="linenos">4389</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc-4390"><a href="#COMPsc-4390"><span class="linenos">4390</span></a>                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">cell_x</span><span class="si">}</span><span class="s2">&#39; occurs more than once. If you want to select a specific cell, &quot;</span>
</span><span id="COMPsc-4391"><a href="#COMPsc-4391"><span class="linenos">4391</span></a>                <span class="sa">f</span><span class="s2">&quot;please also provide the corresponding &#39;set_x&#39; and &#39;set_y&#39; values.&quot;</span>
</span><span id="COMPsc-4392"><a href="#COMPsc-4392"><span class="linenos">4392</span></a>            <span class="p">)</span>
</span><span id="COMPsc-4393"><a href="#COMPsc-4393"><span class="linenos">4393</span></a>
</span><span id="COMPsc-4394"><a href="#COMPsc-4394"><span class="linenos">4394</span></a>        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">cell_y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="COMPsc-4395"><a href="#COMPsc-4395"><span class="linenos">4395</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc-4396"><a href="#COMPsc-4396"><span class="linenos">4396</span></a>                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">cell_y</span><span class="si">}</span><span class="s2">&#39; occurs more than once. If you want to select a specific cell, &quot;</span>
</span><span id="COMPsc-4397"><a href="#COMPsc-4397"><span class="linenos">4397</span></a>                <span class="sa">f</span><span class="s2">&quot;please also provide the corresponding &#39;set_x&#39; and &#39;set_y&#39; values.&quot;</span>
</span><span id="COMPsc-4398"><a href="#COMPsc-4398"><span class="linenos">4398</span></a>            <span class="p">)</span>
</span><span id="COMPsc-4399"><a href="#COMPsc-4399"><span class="linenos">4399</span></a>
</span><span id="COMPsc-4400"><a href="#COMPsc-4400"><span class="linenos">4400</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">image_width</span><span class="p">,</span> <span class="n">image_high</span><span class="p">))</span>
</span><span id="COMPsc-4401"><a href="#COMPsc-4401"><span class="linenos">4401</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">cell_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">cell_y</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
</span><span id="COMPsc-4402"><a href="#COMPsc-4402"><span class="linenos">4402</span></a>
</span><span id="COMPsc-4403"><a href="#COMPsc-4403"><span class="linenos">4403</span></a>        <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span>
</span><span id="COMPsc-4404"><a href="#COMPsc-4404"><span class="linenos">4404</span></a>            <span class="n">data</span><span class="p">[</span><span class="n">cell_x</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">cell_y</span><span class="p">]</span>
</span><span id="COMPsc-4405"><a href="#COMPsc-4405"><span class="linenos">4405</span></a>        <span class="p">)</span>
</span><span id="COMPsc-4406"><a href="#COMPsc-4406"><span class="linenos">4406</span></a>        <span class="n">equation</span> <span class="o">=</span> <span class="s2">&quot;y = </span><span class="si">{:.2f}</span><span class="s2">x + </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">)</span>
</span><span id="COMPsc-4407"><a href="#COMPsc-4407"><span class="linenos">4407</span></a>
</span><span id="COMPsc-4408"><a href="#COMPsc-4408"><span class="linenos">4408</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="COMPsc-4409"><a href="#COMPsc-4409"><span class="linenos">4409</span></a>            <span class="s2">&quot;R-squared = </span><span class="si">{:.2f}</span><span class="se">\n</span><span class="s2">P-value = </span><span class="si">{:.2f}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="COMPsc-4410"><a href="#COMPsc-4410"><span class="linenos">4410</span></a>                <span class="n">r_value</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">equation</span>
</span><span id="COMPsc-4411"><a href="#COMPsc-4411"><span class="linenos">4411</span></a>            <span class="p">),</span>
</span><span id="COMPsc-4412"><a href="#COMPsc-4412"><span class="linenos">4412</span></a>            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.90</span><span class="p">),</span>
</span><span id="COMPsc-4413"><a href="#COMPsc-4413"><span class="linenos">4413</span></a>            <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
</span><span id="COMPsc-4414"><a href="#COMPsc-4414"><span class="linenos">4414</span></a>            <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="COMPsc-4415"><a href="#COMPsc-4415"><span class="linenos">4415</span></a>        <span class="p">)</span>
</span><span id="COMPsc-4416"><a href="#COMPsc-4416"><span class="linenos">4416</span></a>
</span><span id="COMPsc-4417"><a href="#COMPsc-4417"><span class="linenos">4417</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="COMPsc-4418"><a href="#COMPsc-4418"><span class="linenos">4418</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="COMPsc-4419"><a href="#COMPsc-4419"><span class="linenos">4419</span></a>
</span><span id="COMPsc-4420"><a href="#COMPsc-4420"><span class="linenos">4420</span></a>        <span class="n">diff</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc-4421"><a href="#COMPsc-4421"><span class="linenos">4421</span></a>        <span class="n">x_mean</span><span class="p">,</span> <span class="n">y_mean</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">cell_x</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">data</span><span class="p">[</span><span class="n">cell_y</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="COMPsc-4422"><a href="#COMPsc-4422"><span class="linenos">4422</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">cell_x</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">cell_y</span><span class="p">])):</span>
</span><span id="COMPsc-4423"><a href="#COMPsc-4423"><span class="linenos">4423</span></a>            <span class="n">diff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">))</span>
</span><span id="COMPsc-4424"><a href="#COMPsc-4424"><span class="linenos">4424</span></a>            <span class="n">diff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">yi</span> <span class="o">-</span> <span class="n">y_mean</span><span class="p">))</span>
</span><span id="COMPsc-4425"><a href="#COMPsc-4425"><span class="linenos">4425</span></a>
</span><span id="COMPsc-4426"><a href="#COMPsc-4426"><span class="linenos">4426</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">annotate_outliers</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
</span><span id="COMPsc-4427"><a href="#COMPsc-4427"><span class="linenos">4427</span></a>            <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc-4428"><a href="#COMPsc-4428"><span class="linenos">4428</span></a>            <span class="n">x_mean</span><span class="p">,</span> <span class="n">y_mean</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="COMPsc-4429"><a href="#COMPsc-4429"><span class="linenos">4429</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)):</span>
</span><span id="COMPsc-4430"><a href="#COMPsc-4430"><span class="linenos">4430</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="COMPsc-4431"><a href="#COMPsc-4431"><span class="linenos">4431</span></a>                    <span class="nb">abs</span><span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span>
</span><span id="COMPsc-4432"><a href="#COMPsc-4432"><span class="linenos">4432</span></a>                    <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">yi</span> <span class="o">-</span> <span class="n">y_mean</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span>
</span><span id="COMPsc-4433"><a href="#COMPsc-4433"><span class="linenos">4433</span></a>                    <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">yi</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span>
</span><span id="COMPsc-4434"><a href="#COMPsc-4434"><span class="linenos">4434</span></a>                <span class="p">):</span>
</span><span id="COMPsc-4435"><a href="#COMPsc-4435"><span class="linenos">4435</span></a>                    <span class="n">text</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="COMPsc-4436"><a href="#COMPsc-4436"><span class="linenos">4436</span></a>                    <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span id="COMPsc-4437"><a href="#COMPsc-4437"><span class="linenos">4437</span></a>
</span><span id="COMPsc-4438"><a href="#COMPsc-4438"><span class="linenos">4438</span></a>            <span class="k">return</span> <span class="n">texts</span>
</span><span id="COMPsc-4439"><a href="#COMPsc-4439"><span class="linenos">4439</span></a>
</span><span id="COMPsc-4440"><a href="#COMPsc-4440"><span class="linenos">4440</span></a>        <span class="n">texts</span> <span class="o">=</span> <span class="n">annotate_outliers</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">cell_x</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">cell_y</span><span class="p">],</span> <span class="n">threshold</span><span class="p">)</span>
</span><span id="COMPsc-4441"><a href="#COMPsc-4441"><span class="linenos">4441</span></a>
</span><span id="COMPsc-4442"><a href="#COMPsc-4442"><span class="linenos">4442</span></a>        <span class="n">adjust_text</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>
</span><span id="COMPsc-4443"><a href="#COMPsc-4443"><span class="linenos">4443</span></a>
</span><span id="COMPsc-4444"><a href="#COMPsc-4444"><span class="linenos">4444</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="COMPsc-4445"><a href="#COMPsc-4445"><span class="linenos">4445</span></a>
</span><span id="COMPsc-4446"><a href="#COMPsc-4446"><span class="linenos">4446</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span></pre></div>


            <div class="docstring"><p>A class <code><a href="#COMPsc">COMPsc</a></code> (Comparison of single-cell data) designed for the integration,
analysis, and visualization of single-cell datasets.
The class supports independent dataset integration, subclustering of existing clusters,
marker detection, and multiple visualization strategies.</p>

<p>The COMPsc class provides methods for:</p>

<pre><code>- Normalizing and filtering single-cell data
- Loading and saving sparse 10x-style datasets
- Computing differential expression and marker genes
- Clustering and subclustering analysis
- Visualizing similarity and spatial relationships
- Aggregating data by cell and set annotations
- Managing metadata and renaming labels
- Plotting gene detection histograms and feature scatters
</code></pre>

<h2 id="methods">Methods</h2>

<p>project_dir(path_to_directory, project_list)
    Scans a directory to create a COMPsc instance mapping project names to their paths.</p>

<p>save_project(name, path=os.getcwd())
    Saves the COMPsc object to a pickle file on disk.</p>

<p>load_project(path)
    Loads a previously saved COMPsc object from a pickle file.</p>

<p>reduce_cols(reg, inc_set=False)
    Removes columns from data tables where column names contain a specified name or partial substring.</p>

<p>reduce_rows(reg, inc_set=False)
    Removes rows from data tables where column names contain a specified feature (gene) name.</p>

<p>get_data(set_info=False)
    Returns normalized data with optional set annotations in column names.</p>

<p>get_metadata()
    Returns the stored input metadata.</p>

<p>get_partial_data(names=None, features=None, name_slot='cell_names')
    Return a subset of the data by sample names and/or features.</p>

<p>gene_calculation()
    Calculates and stores per-cell gene detection counts as a pandas Series.</p>

<p>gene_histograme(bins=100)
    Plots a histogram of genes detected per cell with an overlaid normal distribution.</p>

<p>gene_threshold(min_n=None, max_n=None)
    Filters cells based on minimum and/or maximum gene detection thresholds.</p>

<p>load_sparse_from_projects(normalized_data=False)
    Loads and concatenates sparse 10x-style datasets from project paths into count or normalized data.</p>

<p>rename_names(mapping, slot='cell_names')
    Renames entries in a specified metadata column using a provided mapping dictionary.</p>

<p>rename_subclusters(mapping)
    Renames subcluster labels using a provided mapping dictionary.</p>

<p>save_sparse(path_to_save=os.getcwd(), name_slot='cell_names', data_slot='normalized')
    Exports data as 10x-compatible sparse files (matrix.mtx, barcodes.tsv, genes.tsv).</p>

<p>normalize_data(normalize=True, normalize_factor=100000)
    Normalizes raw counts to counts-per-specified factor (e.g., CPM-like).</p>

<p>statistic(cells=None, sets=None, min_exp=0.01, min_pct=0.1, n_proc=10)
    Computes per-feature differential expression statistics (Mann-Whitney U) comparing target vs. rest groups.</p>

<p>calculate_difference_markers(min_exp=0, min_pct=0.25, n_proc=10, force=False)
    Computes and caches differential markers using the statistic method.</p>

<p>clustering_features(features_list=None, name_slot='cell_names', p_val=0.05, top_n=25, adj_mean=True, beta=0.4)
    Prepares clustering input by selecting marker features and optionally smoothing cell values.</p>

<p>average()
    Aggregates normalized data by averaging across (cell_name, set) pairs.</p>

<p>estimating_similarity(method='pearson', p_val=0.05, top_n=25)
    Computes pairwise correlation and Euclidean distance between aggregated samples.</p>

<p>similarity_plot(split_sets=True, set_info=True, cmap='seismic', width=12, height=10)
    Visualizes pairwise similarity as a scatter plot with correlation as hue and scaled distance as point size.</p>

<p>spatial_similarity(set_info=True, bandwidth=1, n_neighbors=5, min_dist=0.1, legend_split=2, point_size=20, ...)
    Creates a UMAP-like visualization of similarity relationships with cluster hulls and nearest-neighbor arrows.</p>

<p>subcluster_prepare(features, cluster)
    Initializes a Clustering object for subcluster analysis on a selected parent cluster.</p>

<p>define_subclusters(umap_num=2, eps=0.5, min_samples=10, bandwidth=1, n_neighbors=5, min_dist=0.1, ...)
    Performs UMAP and DBSCAN clustering on prepared subcluster data and stores cluster labels.</p>

<p>subcluster_features_scatter(colors='viridis', hclust='complete', img_width=3, img_high=5, label_size=6, ...)
    Visualizes averaged expression and occurrence of features for subclusters as a scatter plot.</p>

<p>subcluster_DEG_scatter(top_n=3, min_exp=0, min_pct=0.25, p_val=0.05, colors='viridis', ...)
    Plots top differential features for subclusters as a features-scatter visualization.</p>

<p>accept_subclusters()
    Commits subcluster labels to main metadata by renaming cell names and clears subcluster data.</p>

<h2 id="raises">Raises</h2>

<p>ValueError
    For invalid parameters, mismatched dimensions, or missing metadata.</p>
</div>


                            <div id="COMPsc.__init__" class="classattr">
                                        <input id="COMPsc.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">COMPsc</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">objects</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="COMPsc.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.__init__-1146"><a href="#COMPsc.__init__-1146"><span class="linenos">1146</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="COMPsc.__init__-1147"><a href="#COMPsc.__init__-1147"><span class="linenos">1147</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc.__init__-1148"><a href="#COMPsc.__init__-1148"><span class="linenos">1148</span></a>        <span class="n">objects</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.__init__-1149"><a href="#COMPsc.__init__-1149"><span class="linenos">1149</span></a>    <span class="p">):</span>
</span><span id="COMPsc.__init__-1150"><a href="#COMPsc.__init__-1150"><span class="linenos">1150</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.__init__-1151"><a href="#COMPsc.__init__-1151"><span class="linenos">1151</span></a><span class="sd">        Initialize the COMPsc class for single-cell data integration and analysis.</span>
</span><span id="COMPsc.__init__-1152"><a href="#COMPsc.__init__-1152"><span class="linenos">1152</span></a>
</span><span id="COMPsc.__init__-1153"><a href="#COMPsc.__init__-1153"><span class="linenos">1153</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.__init__-1154"><a href="#COMPsc.__init__-1154"><span class="linenos">1154</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.__init__-1155"><a href="#COMPsc.__init__-1155"><span class="linenos">1155</span></a><span class="sd">        objects : list or None, optional</span>
</span><span id="COMPsc.__init__-1156"><a href="#COMPsc.__init__-1156"><span class="linenos">1156</span></a><span class="sd">            Optional list of data objects to initialize the instance with.</span>
</span><span id="COMPsc.__init__-1157"><a href="#COMPsc.__init__-1157"><span class="linenos">1157</span></a>
</span><span id="COMPsc.__init__-1158"><a href="#COMPsc.__init__-1158"><span class="linenos">1158</span></a><span class="sd">        Attributes</span>
</span><span id="COMPsc.__init__-1159"><a href="#COMPsc.__init__-1159"><span class="linenos">1159</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.__init__-1160"><a href="#COMPsc.__init__-1160"><span class="linenos">1160</span></a><span class="sd">        -objects : list or None</span>
</span><span id="COMPsc.__init__-1161"><a href="#COMPsc.__init__-1161"><span class="linenos">1161</span></a><span class="sd">        -input_data : pandas.DataFrame or None</span>
</span><span id="COMPsc.__init__-1162"><a href="#COMPsc.__init__-1162"><span class="linenos">1162</span></a><span class="sd">        -input_metadata : pandas.DataFrame or None</span>
</span><span id="COMPsc.__init__-1163"><a href="#COMPsc.__init__-1163"><span class="linenos">1163</span></a><span class="sd">        -normalized_data : pandas.DataFrame or None</span>
</span><span id="COMPsc.__init__-1164"><a href="#COMPsc.__init__-1164"><span class="linenos">1164</span></a><span class="sd">        -agg_metadata : pandas.DataFrame or None</span>
</span><span id="COMPsc.__init__-1165"><a href="#COMPsc.__init__-1165"><span class="linenos">1165</span></a><span class="sd">        -agg_normalized_data : pandas.DataFrame or None</span>
</span><span id="COMPsc.__init__-1166"><a href="#COMPsc.__init__-1166"><span class="linenos">1166</span></a><span class="sd">        -similarity : pandas.DataFrame or None</span>
</span><span id="COMPsc.__init__-1167"><a href="#COMPsc.__init__-1167"><span class="linenos">1167</span></a><span class="sd">        -var_data : pandas.DataFrame or None</span>
</span><span id="COMPsc.__init__-1168"><a href="#COMPsc.__init__-1168"><span class="linenos">1168</span></a><span class="sd">        -subclusters_ : instance of Clustering class or None</span>
</span><span id="COMPsc.__init__-1169"><a href="#COMPsc.__init__-1169"><span class="linenos">1169</span></a><span class="sd">        -cells_calc : pandas.Series or None</span>
</span><span id="COMPsc.__init__-1170"><a href="#COMPsc.__init__-1170"><span class="linenos">1170</span></a><span class="sd">        -gene_calc : pandas.Series or None</span>
</span><span id="COMPsc.__init__-1171"><a href="#COMPsc.__init__-1171"><span class="linenos">1171</span></a><span class="sd">        -composition_data : pandas.DataFrame or None</span>
</span><span id="COMPsc.__init__-1172"><a href="#COMPsc.__init__-1172"><span class="linenos">1172</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.__init__-1173"><a href="#COMPsc.__init__-1173"><span class="linenos">1173</span></a>
</span><span id="COMPsc.__init__-1174"><a href="#COMPsc.__init__-1174"><span class="linenos">1174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="n">objects</span>
</span><span id="COMPsc.__init__-1175"><a href="#COMPsc.__init__-1175"><span class="linenos">1175</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Stores the input data objects.&quot;&quot;&quot;</span>
</span><span id="COMPsc.__init__-1176"><a href="#COMPsc.__init__-1176"><span class="linenos">1176</span></a>
</span><span id="COMPsc.__init__-1177"><a href="#COMPsc.__init__-1177"><span class="linenos">1177</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc.__init__-1178"><a href="#COMPsc.__init__-1178"><span class="linenos">1178</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Raw input data for clustering or integration analysis.&quot;&quot;&quot;</span>
</span><span id="COMPsc.__init__-1179"><a href="#COMPsc.__init__-1179"><span class="linenos">1179</span></a>
</span><span id="COMPsc.__init__-1180"><a href="#COMPsc.__init__-1180"><span class="linenos">1180</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc.__init__-1181"><a href="#COMPsc.__init__-1181"><span class="linenos">1181</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Metadata associated with the input data.&quot;&quot;&quot;</span>
</span><span id="COMPsc.__init__-1182"><a href="#COMPsc.__init__-1182"><span class="linenos">1182</span></a>
</span><span id="COMPsc.__init__-1183"><a href="#COMPsc.__init__-1183"><span class="linenos">1183</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc.__init__-1184"><a href="#COMPsc.__init__-1184"><span class="linenos">1184</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalized version of the input data.&quot;&quot;&quot;</span>
</span><span id="COMPsc.__init__-1185"><a href="#COMPsc.__init__-1185"><span class="linenos">1185</span></a>
</span><span id="COMPsc.__init__-1186"><a href="#COMPsc.__init__-1186"><span class="linenos">1186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc.__init__-1187"><a href="#COMPsc.__init__-1187"><span class="linenos">1187</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Aggregated metadata for all sets in object related to &quot;agg_normalized_data&quot;&#39;&#39;&#39;</span>
</span><span id="COMPsc.__init__-1188"><a href="#COMPsc.__init__-1188"><span class="linenos">1188</span></a>
</span><span id="COMPsc.__init__-1189"><a href="#COMPsc.__init__-1189"><span class="linenos">1189</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc.__init__-1190"><a href="#COMPsc.__init__-1190"><span class="linenos">1190</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregated and normalized data across multiple sets.&quot;&quot;&quot;</span>
</span><span id="COMPsc.__init__-1191"><a href="#COMPsc.__init__-1191"><span class="linenos">1191</span></a>
</span><span id="COMPsc.__init__-1192"><a href="#COMPsc.__init__-1192"><span class="linenos">1192</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc.__init__-1193"><a href="#COMPsc.__init__-1193"><span class="linenos">1193</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Similarity data between cells across all samples. and sets&quot;&quot;&quot;</span>
</span><span id="COMPsc.__init__-1194"><a href="#COMPsc.__init__-1194"><span class="linenos">1194</span></a>
</span><span id="COMPsc.__init__-1195"><a href="#COMPsc.__init__-1195"><span class="linenos">1195</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc.__init__-1196"><a href="#COMPsc.__init__-1196"><span class="linenos">1196</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;DEG analysis results summarizing variance across all samples in the object.&quot;&quot;&quot;</span>
</span><span id="COMPsc.__init__-1197"><a href="#COMPsc.__init__-1197"><span class="linenos">1197</span></a>
</span><span id="COMPsc.__init__-1198"><a href="#COMPsc.__init__-1198"><span class="linenos">1198</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc.__init__-1199"><a href="#COMPsc.__init__-1199"><span class="linenos">1199</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Placeholder for information about subclusters analysis; if computed.&quot;&quot;&quot;</span>
</span><span id="COMPsc.__init__-1200"><a href="#COMPsc.__init__-1200"><span class="linenos">1200</span></a>
</span><span id="COMPsc.__init__-1201"><a href="#COMPsc.__init__-1201"><span class="linenos">1201</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc.__init__-1202"><a href="#COMPsc.__init__-1202"><span class="linenos">1202</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of cells detected per sample (grouped by lineage, e.g., cluster or name), reflecting data composition.&quot;&quot;&quot;</span>
</span><span id="COMPsc.__init__-1203"><a href="#COMPsc.__init__-1203"><span class="linenos">1203</span></a>
</span><span id="COMPsc.__init__-1204"><a href="#COMPsc.__init__-1204"><span class="linenos">1204</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc.__init__-1205"><a href="#COMPsc.__init__-1205"><span class="linenos">1205</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of genes detected per sample (cell), reflecting the sequencing depth.&quot;&quot;&quot;</span>
</span><span id="COMPsc.__init__-1206"><a href="#COMPsc.__init__-1206"><span class="linenos">1206</span></a>
</span><span id="COMPsc.__init__-1207"><a href="#COMPsc.__init__-1207"><span class="linenos">1207</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">composition_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="COMPsc.__init__-1208"><a href="#COMPsc.__init__-1208"><span class="linenos">1208</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Data describing composition of cells across clusters or sets.&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the COMPsc class for single-cell data integration and analysis.</p>

<h2 id="parameters">Parameters</h2>

<p>objects : list or None, optional
    Optional list of data objects to initialize the instance with.</p>

<h2 id="attributes">Attributes</h2>

<p>-objects : list or None
-input_data : pandas.DataFrame or None
-input_metadata : pandas.DataFrame or None
-normalized_data : pandas.DataFrame or None
-agg_metadata : pandas.DataFrame or None
-agg_normalized_data : pandas.DataFrame or None
-similarity : pandas.DataFrame or None
-var_data : pandas.DataFrame or None
-subclusters_ : instance of Clustering class or None
-cells_calc : pandas.Series or None
-gene_calc : pandas.Series or None
-composition_data : pandas.DataFrame or None</p>
</div>


                            </div>
                            <div id="COMPsc.objects" class="classattr">
                                <div class="attr variable">
            <span class="name">objects</span>

        
    </div>
    <a class="headerlink" href="#COMPsc.objects"></a>
    
            <div class="docstring"><p>Stores the input data objects.</p>
</div>


                            </div>
                            <div id="COMPsc.input_data" class="classattr">
                                <div class="attr variable">
            <span class="name">input_data</span>

        
    </div>
    <a class="headerlink" href="#COMPsc.input_data"></a>
    
            <div class="docstring"><p>Raw input data for clustering or integration analysis.</p>
</div>


                            </div>
                            <div id="COMPsc.input_metadata" class="classattr">
                                <div class="attr variable">
            <span class="name">input_metadata</span>

        
    </div>
    <a class="headerlink" href="#COMPsc.input_metadata"></a>
    
            <div class="docstring"><p>Metadata associated with the input data.</p>
</div>


                            </div>
                            <div id="COMPsc.normalized_data" class="classattr">
                                <div class="attr variable">
            <span class="name">normalized_data</span>

        
    </div>
    <a class="headerlink" href="#COMPsc.normalized_data"></a>
    
            <div class="docstring"><p>Normalized version of the input data.</p>
</div>


                            </div>
                            <div id="COMPsc.agg_metadata" class="classattr">
                                <div class="attr variable">
            <span class="name">agg_metadata</span>

        
    </div>
    <a class="headerlink" href="#COMPsc.agg_metadata"></a>
    
            <div class="docstring"><p>Aggregated metadata for all sets in object related to "agg_normalized_data"</p>
</div>


                            </div>
                            <div id="COMPsc.agg_normalized_data" class="classattr">
                                <div class="attr variable">
            <span class="name">agg_normalized_data</span>

        
    </div>
    <a class="headerlink" href="#COMPsc.agg_normalized_data"></a>
    
            <div class="docstring"><p>Aggregated and normalized data across multiple sets.</p>
</div>


                            </div>
                            <div id="COMPsc.similarity" class="classattr">
                                <div class="attr variable">
            <span class="name">similarity</span>

        
    </div>
    <a class="headerlink" href="#COMPsc.similarity"></a>
    
            <div class="docstring"><p>Similarity data between cells across all samples. and sets</p>
</div>


                            </div>
                            <div id="COMPsc.var_data" class="classattr">
                                <div class="attr variable">
            <span class="name">var_data</span>

        
    </div>
    <a class="headerlink" href="#COMPsc.var_data"></a>
    
            <div class="docstring"><p>DEG analysis results summarizing variance across all samples in the object.</p>
</div>


                            </div>
                            <div id="COMPsc.subclusters_" class="classattr">
                                <div class="attr variable">
            <span class="name">subclusters_</span>

        
    </div>
    <a class="headerlink" href="#COMPsc.subclusters_"></a>
    
            <div class="docstring"><p>Placeholder for information about subclusters analysis; if computed.</p>
</div>


                            </div>
                            <div id="COMPsc.cells_calc" class="classattr">
                                <div class="attr variable">
            <span class="name">cells_calc</span>

        
    </div>
    <a class="headerlink" href="#COMPsc.cells_calc"></a>
    
            <div class="docstring"><p>Number of cells detected per sample (grouped by lineage, e.g., cluster or name), reflecting data composition.</p>
</div>


                            </div>
                            <div id="COMPsc.gene_calc" class="classattr">
                                <div class="attr variable">
            <span class="name">gene_calc</span>

        
    </div>
    <a class="headerlink" href="#COMPsc.gene_calc"></a>
    
            <div class="docstring"><p>Number of genes detected per sample (cell), reflecting the sequencing depth.</p>
</div>


                            </div>
                            <div id="COMPsc.composition_data" class="classattr">
                                <div class="attr variable">
            <span class="name">composition_data</span>

        
    </div>
    <a class="headerlink" href="#COMPsc.composition_data"></a>
    
            <div class="docstring"><p>Data describing composition of cells across clusters or sets.</p>
</div>


                            </div>
                            <div id="COMPsc.project_dir" class="classattr">
                                        <input id="COMPsc.project_dir-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">project_dir</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">path_to_directory</span>, </span><span class="param"><span class="n">project_list</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.project_dir-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.project_dir"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.project_dir-1210"><a href="#COMPsc.project_dir-1210"><span class="linenos">1210</span></a>    <span class="nd">@classmethod</span>
</span><span id="COMPsc.project_dir-1211"><a href="#COMPsc.project_dir-1211"><span class="linenos">1211</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">project_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path_to_directory</span><span class="p">,</span> <span class="n">project_list</span><span class="p">):</span>
</span><span id="COMPsc.project_dir-1212"><a href="#COMPsc.project_dir-1212"><span class="linenos">1212</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.project_dir-1213"><a href="#COMPsc.project_dir-1213"><span class="linenos">1213</span></a><span class="sd">        Scan a directory and build a COMPsc instance mapping provided project names</span>
</span><span id="COMPsc.project_dir-1214"><a href="#COMPsc.project_dir-1214"><span class="linenos">1214</span></a><span class="sd">        to their paths.</span>
</span><span id="COMPsc.project_dir-1215"><a href="#COMPsc.project_dir-1215"><span class="linenos">1215</span></a>
</span><span id="COMPsc.project_dir-1216"><a href="#COMPsc.project_dir-1216"><span class="linenos">1216</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.project_dir-1217"><a href="#COMPsc.project_dir-1217"><span class="linenos">1217</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.project_dir-1218"><a href="#COMPsc.project_dir-1218"><span class="linenos">1218</span></a><span class="sd">        path_to_directory : str</span>
</span><span id="COMPsc.project_dir-1219"><a href="#COMPsc.project_dir-1219"><span class="linenos">1219</span></a><span class="sd">            Path containing project subfolders.</span>
</span><span id="COMPsc.project_dir-1220"><a href="#COMPsc.project_dir-1220"><span class="linenos">1220</span></a>
</span><span id="COMPsc.project_dir-1221"><a href="#COMPsc.project_dir-1221"><span class="linenos">1221</span></a><span class="sd">        project_list : list[str]</span>
</span><span id="COMPsc.project_dir-1222"><a href="#COMPsc.project_dir-1222"><span class="linenos">1222</span></a><span class="sd">            List of filenames (folder names) to include in the returned object map.</span>
</span><span id="COMPsc.project_dir-1223"><a href="#COMPsc.project_dir-1223"><span class="linenos">1223</span></a>
</span><span id="COMPsc.project_dir-1224"><a href="#COMPsc.project_dir-1224"><span class="linenos">1224</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc.project_dir-1225"><a href="#COMPsc.project_dir-1225"><span class="linenos">1225</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.project_dir-1226"><a href="#COMPsc.project_dir-1226"><span class="linenos">1226</span></a><span class="sd">        COMPsc</span>
</span><span id="COMPsc.project_dir-1227"><a href="#COMPsc.project_dir-1227"><span class="linenos">1227</span></a><span class="sd">            New COMPsc instance with `objects` populated.</span>
</span><span id="COMPsc.project_dir-1228"><a href="#COMPsc.project_dir-1228"><span class="linenos">1228</span></a>
</span><span id="COMPsc.project_dir-1229"><a href="#COMPsc.project_dir-1229"><span class="linenos">1229</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc.project_dir-1230"><a href="#COMPsc.project_dir-1230"><span class="linenos">1230</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.project_dir-1231"><a href="#COMPsc.project_dir-1231"><span class="linenos">1231</span></a><span class="sd">        Exception</span>
</span><span id="COMPsc.project_dir-1232"><a href="#COMPsc.project_dir-1232"><span class="linenos">1232</span></a><span class="sd">            A generic exception is caught and a message printed if scanning fails.</span>
</span><span id="COMPsc.project_dir-1233"><a href="#COMPsc.project_dir-1233"><span class="linenos">1233</span></a>
</span><span id="COMPsc.project_dir-1234"><a href="#COMPsc.project_dir-1234"><span class="linenos">1234</span></a><span class="sd">        Notes</span>
</span><span id="COMPsc.project_dir-1235"><a href="#COMPsc.project_dir-1235"><span class="linenos">1235</span></a><span class="sd">        -----</span>
</span><span id="COMPsc.project_dir-1236"><a href="#COMPsc.project_dir-1236"><span class="linenos">1236</span></a><span class="sd">        Function attempts to match entries in `project_list` to directory</span>
</span><span id="COMPsc.project_dir-1237"><a href="#COMPsc.project_dir-1237"><span class="linenos">1237</span></a><span class="sd">        names and constructs a simplified object key from the folder name.</span>
</span><span id="COMPsc.project_dir-1238"><a href="#COMPsc.project_dir-1238"><span class="linenos">1238</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.project_dir-1239"><a href="#COMPsc.project_dir-1239"><span class="linenos">1239</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="COMPsc.project_dir-1240"><a href="#COMPsc.project_dir-1240"><span class="linenos">1240</span></a>            <span class="n">objects</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="COMPsc.project_dir-1241"><a href="#COMPsc.project_dir-1241"><span class="linenos">1241</span></a>            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path_to_directory</span><span class="p">)):</span>
</span><span id="COMPsc.project_dir-1242"><a href="#COMPsc.project_dir-1242"><span class="linenos">1242</span></a>                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">project_list</span><span class="p">:</span>
</span><span id="COMPsc.project_dir-1243"><a href="#COMPsc.project_dir-1243"><span class="linenos">1243</span></a>                    <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="COMPsc.project_dir-1244"><a href="#COMPsc.project_dir-1244"><span class="linenos">1244</span></a>                    <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">filename</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span><span id="COMPsc.project_dir-1245"><a href="#COMPsc.project_dir-1245"><span class="linenos">1245</span></a>                        <span class="n">objects</span><span class="p">[</span>
</span><span id="COMPsc.project_dir-1246"><a href="#COMPsc.project_dir-1246"><span class="linenos">1246</span></a>                            <span class="nb">str</span><span class="p">(</span>
</span><span id="COMPsc.project_dir-1247"><a href="#COMPsc.project_dir-1247"><span class="linenos">1247</span></a>                                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
</span><span id="COMPsc.project_dir-1248"><a href="#COMPsc.project_dir-1248"><span class="linenos">1248</span></a>                                    <span class="s2">&quot;_count&quot;</span><span class="p">,</span>
</span><span id="COMPsc.project_dir-1249"><a href="#COMPsc.project_dir-1249"><span class="linenos">1249</span></a>                                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="COMPsc.project_dir-1250"><a href="#COMPsc.project_dir-1250"><span class="linenos">1250</span></a>                                    <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
</span><span id="COMPsc.project_dir-1251"><a href="#COMPsc.project_dir-1251"><span class="linenos">1251</span></a>                                        <span class="s2">&quot;_fq&quot;</span><span class="p">,</span>
</span><span id="COMPsc.project_dir-1252"><a href="#COMPsc.project_dir-1252"><span class="linenos">1252</span></a>                                        <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="COMPsc.project_dir-1253"><a href="#COMPsc.project_dir-1253"><span class="linenos">1253</span></a>                                        <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
</span><span id="COMPsc.project_dir-1254"><a href="#COMPsc.project_dir-1254"><span class="linenos">1254</span></a>                                            <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;_.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
</span><span id="COMPsc.project_dir-1255"><a href="#COMPsc.project_dir-1255"><span class="linenos">1255</span></a>                                            <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="COMPsc.project_dir-1256"><a href="#COMPsc.project_dir-1256"><span class="linenos">1256</span></a>                                            <span class="n">filename</span><span class="p">,</span>
</span><span id="COMPsc.project_dir-1257"><a href="#COMPsc.project_dir-1257"><span class="linenos">1257</span></a>                                        <span class="p">),</span>
</span><span id="COMPsc.project_dir-1258"><a href="#COMPsc.project_dir-1258"><span class="linenos">1258</span></a>                                    <span class="p">),</span>
</span><span id="COMPsc.project_dir-1259"><a href="#COMPsc.project_dir-1259"><span class="linenos">1259</span></a>                                <span class="p">)</span>
</span><span id="COMPsc.project_dir-1260"><a href="#COMPsc.project_dir-1260"><span class="linenos">1260</span></a>                            <span class="p">)</span>
</span><span id="COMPsc.project_dir-1261"><a href="#COMPsc.project_dir-1261"><span class="linenos">1261</span></a>                        <span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
</span><span id="COMPsc.project_dir-1262"><a href="#COMPsc.project_dir-1262"><span class="linenos">1262</span></a>
</span><span id="COMPsc.project_dir-1263"><a href="#COMPsc.project_dir-1263"><span class="linenos">1263</span></a>            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
</span><span id="COMPsc.project_dir-1264"><a href="#COMPsc.project_dir-1264"><span class="linenos">1264</span></a>
</span><span id="COMPsc.project_dir-1265"><a href="#COMPsc.project_dir-1265"><span class="linenos">1265</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="COMPsc.project_dir-1266"><a href="#COMPsc.project_dir-1266"><span class="linenos">1266</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Scan a directory and build a COMPsc instance mapping provided project names
to their paths.</p>

<h2 id="parameters">Parameters</h2>

<p>path_to_directory : str
    Path containing project subfolders.</p>

<p>project_list : list[str]
    List of filenames (folder names) to include in the returned object map.</p>

<h2 id="returns">Returns</h2>

<p>COMPsc
    New COMPsc instance with <code><a href="#COMPsc.objects">objects</a></code> populated.</p>

<h2 id="raises">Raises</h2>

<p>Exception
    A generic exception is caught and a message printed if scanning fails.</p>

<h2 id="notes">Notes</h2>

<p>Function attempts to match entries in <code>project_list</code> to directory
names and constructs a simplified object key from the folder name.</p>
</div>


                            </div>
                            <div id="COMPsc.save_project" class="classattr">
                                        <input id="COMPsc.save_project-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_project</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name</span>, </span><span class="param"><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;/mnt/c/Users/merag/Git/JDti&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.save_project-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.save_project"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.save_project-1268"><a href="#COMPsc.save_project-1268"><span class="linenos">1268</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()):</span>
</span><span id="COMPsc.save_project-1269"><a href="#COMPsc.save_project-1269"><span class="linenos">1269</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.save_project-1270"><a href="#COMPsc.save_project-1270"><span class="linenos">1270</span></a><span class="sd">        Save the COMPsc object to disk using pickle.</span>
</span><span id="COMPsc.save_project-1271"><a href="#COMPsc.save_project-1271"><span class="linenos">1271</span></a>
</span><span id="COMPsc.save_project-1272"><a href="#COMPsc.save_project-1272"><span class="linenos">1272</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.save_project-1273"><a href="#COMPsc.save_project-1273"><span class="linenos">1273</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.save_project-1274"><a href="#COMPsc.save_project-1274"><span class="linenos">1274</span></a><span class="sd">        name : str</span>
</span><span id="COMPsc.save_project-1275"><a href="#COMPsc.save_project-1275"><span class="linenos">1275</span></a><span class="sd">            Base filename (without extension) to use when saving.</span>
</span><span id="COMPsc.save_project-1276"><a href="#COMPsc.save_project-1276"><span class="linenos">1276</span></a>
</span><span id="COMPsc.save_project-1277"><a href="#COMPsc.save_project-1277"><span class="linenos">1277</span></a><span class="sd">        path : str, default os.getcwd()</span>
</span><span id="COMPsc.save_project-1278"><a href="#COMPsc.save_project-1278"><span class="linenos">1278</span></a><span class="sd">            Directory in which to save the project file.</span>
</span><span id="COMPsc.save_project-1279"><a href="#COMPsc.save_project-1279"><span class="linenos">1279</span></a>
</span><span id="COMPsc.save_project-1280"><a href="#COMPsc.save_project-1280"><span class="linenos">1280</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc.save_project-1281"><a href="#COMPsc.save_project-1281"><span class="linenos">1281</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.save_project-1282"><a href="#COMPsc.save_project-1282"><span class="linenos">1282</span></a><span class="sd">        None</span>
</span><span id="COMPsc.save_project-1283"><a href="#COMPsc.save_project-1283"><span class="linenos">1283</span></a>
</span><span id="COMPsc.save_project-1284"><a href="#COMPsc.save_project-1284"><span class="linenos">1284</span></a><span class="sd">        Side Effects</span>
</span><span id="COMPsc.save_project-1285"><a href="#COMPsc.save_project-1285"><span class="linenos">1285</span></a><span class="sd">        ------------</span>
</span><span id="COMPsc.save_project-1286"><a href="#COMPsc.save_project-1286"><span class="linenos">1286</span></a><span class="sd">        - Writes a file `&lt;path&gt;/&lt;name&gt;.jpkl` containing the pickled object.</span>
</span><span id="COMPsc.save_project-1287"><a href="#COMPsc.save_project-1287"><span class="linenos">1287</span></a><span class="sd">        - Prints a confirmation message with saved path.</span>
</span><span id="COMPsc.save_project-1288"><a href="#COMPsc.save_project-1288"><span class="linenos">1288</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.save_project-1289"><a href="#COMPsc.save_project-1289"><span class="linenos">1289</span></a>
</span><span id="COMPsc.save_project-1290"><a href="#COMPsc.save_project-1290"><span class="linenos">1290</span></a>        <span class="n">full</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.jpkl&quot;</span><span class="p">)</span>
</span><span id="COMPsc.save_project-1291"><a href="#COMPsc.save_project-1291"><span class="linenos">1291</span></a>
</span><span id="COMPsc.save_project-1292"><a href="#COMPsc.save_project-1292"><span class="linenos">1292</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="COMPsc.save_project-1293"><a href="#COMPsc.save_project-1293"><span class="linenos">1293</span></a>            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="COMPsc.save_project-1294"><a href="#COMPsc.save_project-1294"><span class="linenos">1294</span></a>
</span><span id="COMPsc.save_project-1295"><a href="#COMPsc.save_project-1295"><span class="linenos">1295</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project saved as </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save the COMPsc object to disk using pickle.</p>

<h2 id="parameters">Parameters</h2>

<p>name : str
    Base filename (without extension) to use when saving.</p>

<p>path : str, default os.getcwd()
    Directory in which to save the project file.</p>

<h2 id="returns">Returns</h2>

<p>None</p>

<h2 id="side-effects">Side Effects</h2>

<ul>
<li>Writes a file <code>&lt;path&gt;/&lt;name&gt;.jpkl</code> containing the pickled object.</li>
<li>Prints a confirmation message with saved path.</li>
</ul>
</div>


                            </div>
                            <div id="COMPsc.load_project" class="classattr">
                                        <input id="COMPsc.load_project-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">load_project</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">path</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.load_project-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.load_project"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.load_project-1297"><a href="#COMPsc.load_project-1297"><span class="linenos">1297</span></a>    <span class="nd">@classmethod</span>
</span><span id="COMPsc.load_project-1298"><a href="#COMPsc.load_project-1298"><span class="linenos">1298</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_project</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
</span><span id="COMPsc.load_project-1299"><a href="#COMPsc.load_project-1299"><span class="linenos">1299</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.load_project-1300"><a href="#COMPsc.load_project-1300"><span class="linenos">1300</span></a><span class="sd">        Load a previously saved COMPsc project from a pickle file.</span>
</span><span id="COMPsc.load_project-1301"><a href="#COMPsc.load_project-1301"><span class="linenos">1301</span></a>
</span><span id="COMPsc.load_project-1302"><a href="#COMPsc.load_project-1302"><span class="linenos">1302</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.load_project-1303"><a href="#COMPsc.load_project-1303"><span class="linenos">1303</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.load_project-1304"><a href="#COMPsc.load_project-1304"><span class="linenos">1304</span></a><span class="sd">        path : str</span>
</span><span id="COMPsc.load_project-1305"><a href="#COMPsc.load_project-1305"><span class="linenos">1305</span></a><span class="sd">            Full path to the pickled project file.</span>
</span><span id="COMPsc.load_project-1306"><a href="#COMPsc.load_project-1306"><span class="linenos">1306</span></a>
</span><span id="COMPsc.load_project-1307"><a href="#COMPsc.load_project-1307"><span class="linenos">1307</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc.load_project-1308"><a href="#COMPsc.load_project-1308"><span class="linenos">1308</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.load_project-1309"><a href="#COMPsc.load_project-1309"><span class="linenos">1309</span></a><span class="sd">        COMPsc</span>
</span><span id="COMPsc.load_project-1310"><a href="#COMPsc.load_project-1310"><span class="linenos">1310</span></a><span class="sd">            The unpickled COMPsc object.</span>
</span><span id="COMPsc.load_project-1311"><a href="#COMPsc.load_project-1311"><span class="linenos">1311</span></a>
</span><span id="COMPsc.load_project-1312"><a href="#COMPsc.load_project-1312"><span class="linenos">1312</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc.load_project-1313"><a href="#COMPsc.load_project-1313"><span class="linenos">1313</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.load_project-1314"><a href="#COMPsc.load_project-1314"><span class="linenos">1314</span></a><span class="sd">        FileNotFoundError</span>
</span><span id="COMPsc.load_project-1315"><a href="#COMPsc.load_project-1315"><span class="linenos">1315</span></a><span class="sd">            If the provided path does not exist.</span>
</span><span id="COMPsc.load_project-1316"><a href="#COMPsc.load_project-1316"><span class="linenos">1316</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.load_project-1317"><a href="#COMPsc.load_project-1317"><span class="linenos">1317</span></a>
</span><span id="COMPsc.load_project-1318"><a href="#COMPsc.load_project-1318"><span class="linenos">1318</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="COMPsc.load_project-1319"><a href="#COMPsc.load_project-1319"><span class="linenos">1319</span></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;File does not exist!&quot;</span><span class="p">)</span>
</span><span id="COMPsc.load_project-1320"><a href="#COMPsc.load_project-1320"><span class="linenos">1320</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="COMPsc.load_project-1321"><a href="#COMPsc.load_project-1321"><span class="linenos">1321</span></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="COMPsc.load_project-1322"><a href="#COMPsc.load_project-1322"><span class="linenos">1322</span></a>        <span class="k">return</span> <span class="n">obj</span>
</span></pre></div>


            <div class="docstring"><p>Load a previously saved COMPsc project from a pickle file.</p>

<h2 id="parameters">Parameters</h2>

<p>path : str
    Full path to the pickled project file.</p>

<h2 id="returns">Returns</h2>

<p>COMPsc
    The unpickled COMPsc object.</p>

<h2 id="raises">Raises</h2>

<p>FileNotFoundError
    If the provided path does not exist.</p>
</div>


                            </div>
                            <div id="COMPsc.reduce_cols" class="classattr">
                                        <input id="COMPsc.reduce_cols-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reduce_cols</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">reg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">full</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cell_names&#39;</span>,</span><span class="param">	<span class="n">inc_set</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.reduce_cols-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.reduce_cols"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.reduce_cols-1324"><a href="#COMPsc.reduce_cols-1324"><span class="linenos">1324</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reduce_cols</span><span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1325"><a href="#COMPsc.reduce_cols-1325"><span class="linenos">1325</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc.reduce_cols-1326"><a href="#COMPsc.reduce_cols-1326"><span class="linenos">1326</span></a>        <span class="n">reg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.reduce_cols-1327"><a href="#COMPsc.reduce_cols-1327"><span class="linenos">1327</span></a>        <span class="n">full</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.reduce_cols-1328"><a href="#COMPsc.reduce_cols-1328"><span class="linenos">1328</span></a>        <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="COMPsc.reduce_cols-1329"><a href="#COMPsc.reduce_cols-1329"><span class="linenos">1329</span></a>        <span class="n">inc_set</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="COMPsc.reduce_cols-1330"><a href="#COMPsc.reduce_cols-1330"><span class="linenos">1330</span></a>    <span class="p">):</span>
</span><span id="COMPsc.reduce_cols-1331"><a href="#COMPsc.reduce_cols-1331"><span class="linenos">1331</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.reduce_cols-1332"><a href="#COMPsc.reduce_cols-1332"><span class="linenos">1332</span></a><span class="sd">        Remove columns (cells) whose names contain a substring `reg` or</span>
</span><span id="COMPsc.reduce_cols-1333"><a href="#COMPsc.reduce_cols-1333"><span class="linenos">1333</span></a><span class="sd">        full name `full` from available tables.</span>
</span><span id="COMPsc.reduce_cols-1334"><a href="#COMPsc.reduce_cols-1334"><span class="linenos">1334</span></a>
</span><span id="COMPsc.reduce_cols-1335"><a href="#COMPsc.reduce_cols-1335"><span class="linenos">1335</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.reduce_cols-1336"><a href="#COMPsc.reduce_cols-1336"><span class="linenos">1336</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.reduce_cols-1337"><a href="#COMPsc.reduce_cols-1337"><span class="linenos">1337</span></a><span class="sd">        reg : str | None</span>
</span><span id="COMPsc.reduce_cols-1338"><a href="#COMPsc.reduce_cols-1338"><span class="linenos">1338</span></a><span class="sd">            Substring to search for in column/cell names; matching columns will be removed.</span>
</span><span id="COMPsc.reduce_cols-1339"><a href="#COMPsc.reduce_cols-1339"><span class="linenos">1339</span></a><span class="sd">            If not None, `full` must be None.</span>
</span><span id="COMPsc.reduce_cols-1340"><a href="#COMPsc.reduce_cols-1340"><span class="linenos">1340</span></a>
</span><span id="COMPsc.reduce_cols-1341"><a href="#COMPsc.reduce_cols-1341"><span class="linenos">1341</span></a><span class="sd">        full : str | None</span>
</span><span id="COMPsc.reduce_cols-1342"><a href="#COMPsc.reduce_cols-1342"><span class="linenos">1342</span></a><span class="sd">            Full name to search for in column/cell names; matching columns will be removed.</span>
</span><span id="COMPsc.reduce_cols-1343"><a href="#COMPsc.reduce_cols-1343"><span class="linenos">1343</span></a><span class="sd">            If not None, `reg` must be None.</span>
</span><span id="COMPsc.reduce_cols-1344"><a href="#COMPsc.reduce_cols-1344"><span class="linenos">1344</span></a>
</span><span id="COMPsc.reduce_cols-1345"><a href="#COMPsc.reduce_cols-1345"><span class="linenos">1345</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="COMPsc.reduce_cols-1346"><a href="#COMPsc.reduce_cols-1346"><span class="linenos">1346</span></a><span class="sd">            Column in metadata to use as sample names.</span>
</span><span id="COMPsc.reduce_cols-1347"><a href="#COMPsc.reduce_cols-1347"><span class="linenos">1347</span></a>
</span><span id="COMPsc.reduce_cols-1348"><a href="#COMPsc.reduce_cols-1348"><span class="linenos">1348</span></a><span class="sd">        inc_set : bool, default False</span>
</span><span id="COMPsc.reduce_cols-1349"><a href="#COMPsc.reduce_cols-1349"><span class="linenos">1349</span></a><span class="sd">            If True, column names are interpreted as &#39;cell_name # set&#39; when matching.</span>
</span><span id="COMPsc.reduce_cols-1350"><a href="#COMPsc.reduce_cols-1350"><span class="linenos">1350</span></a>
</span><span id="COMPsc.reduce_cols-1351"><a href="#COMPsc.reduce_cols-1351"><span class="linenos">1351</span></a><span class="sd">        Update</span>
</span><span id="COMPsc.reduce_cols-1352"><a href="#COMPsc.reduce_cols-1352"><span class="linenos">1352</span></a><span class="sd">        ------------</span>
</span><span id="COMPsc.reduce_cols-1353"><a href="#COMPsc.reduce_cols-1353"><span class="linenos">1353</span></a><span class="sd">        Mutates `self.input_data`, `self.normalized_data`, `self.input_metadata`,</span>
</span><span id="COMPsc.reduce_cols-1354"><a href="#COMPsc.reduce_cols-1354"><span class="linenos">1354</span></a><span class="sd">        `self.agg_normalized_data`, and `self.agg_metadata` (if they exist),</span>
</span><span id="COMPsc.reduce_cols-1355"><a href="#COMPsc.reduce_cols-1355"><span class="linenos">1355</span></a><span class="sd">        removing columns/rows that match `reg`.</span>
</span><span id="COMPsc.reduce_cols-1356"><a href="#COMPsc.reduce_cols-1356"><span class="linenos">1356</span></a>
</span><span id="COMPsc.reduce_cols-1357"><a href="#COMPsc.reduce_cols-1357"><span class="linenos">1357</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc.reduce_cols-1358"><a href="#COMPsc.reduce_cols-1358"><span class="linenos">1358</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.reduce_cols-1359"><a href="#COMPsc.reduce_cols-1359"><span class="linenos">1359</span></a><span class="sd">        Raises ValueError if nothing matches the reduction mask.</span>
</span><span id="COMPsc.reduce_cols-1360"><a href="#COMPsc.reduce_cols-1360"><span class="linenos">1360</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.reduce_cols-1361"><a href="#COMPsc.reduce_cols-1361"><span class="linenos">1361</span></a>
</span><span id="COMPsc.reduce_cols-1362"><a href="#COMPsc.reduce_cols-1362"><span class="linenos">1362</span></a>        <span class="k">if</span> <span class="n">reg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">full</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1363"><a href="#COMPsc.reduce_cols-1363"><span class="linenos">1363</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1364"><a href="#COMPsc.reduce_cols-1364"><span class="linenos">1364</span></a>                <span class="s2">&quot;Both &#39;reg&#39; and &#39;full&#39; arguments not provided. Please provide at least one of them!&quot;</span>
</span><span id="COMPsc.reduce_cols-1365"><a href="#COMPsc.reduce_cols-1365"><span class="linenos">1365</span></a>            <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1366"><a href="#COMPsc.reduce_cols-1366"><span class="linenos">1366</span></a>
</span><span id="COMPsc.reduce_cols-1367"><a href="#COMPsc.reduce_cols-1367"><span class="linenos">1367</span></a>        <span class="k">if</span> <span class="n">reg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">full</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1368"><a href="#COMPsc.reduce_cols-1368"><span class="linenos">1368</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1369"><a href="#COMPsc.reduce_cols-1369"><span class="linenos">1369</span></a>                <span class="s2">&quot;Both &#39;reg&#39; and &#39;full&#39; arguments are provided. &quot;</span>
</span><span id="COMPsc.reduce_cols-1370"><a href="#COMPsc.reduce_cols-1370"><span class="linenos">1370</span></a>                <span class="s2">&quot;Please provide only one of them!</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="COMPsc.reduce_cols-1371"><a href="#COMPsc.reduce_cols-1371"><span class="linenos">1371</span></a>                <span class="s2">&quot;&#39;reg&#39; is used when only part of the name must be detected.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="COMPsc.reduce_cols-1372"><a href="#COMPsc.reduce_cols-1372"><span class="linenos">1372</span></a>                <span class="s2">&quot;&#39;full&#39; is used if the full name must be detected.&quot;</span>
</span><span id="COMPsc.reduce_cols-1373"><a href="#COMPsc.reduce_cols-1373"><span class="linenos">1373</span></a>            <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1374"><a href="#COMPsc.reduce_cols-1374"><span class="linenos">1374</span></a>
</span><span id="COMPsc.reduce_cols-1375"><a href="#COMPsc.reduce_cols-1375"><span class="linenos">1375</span></a>        <span class="k">if</span> <span class="n">reg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1376"><a href="#COMPsc.reduce_cols-1376"><span class="linenos">1376</span></a>
</span><span id="COMPsc.reduce_cols-1377"><a href="#COMPsc.reduce_cols-1377"><span class="linenos">1377</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1378"><a href="#COMPsc.reduce_cols-1378"><span class="linenos">1378</span></a>
</span><span id="COMPsc.reduce_cols-1379"><a href="#COMPsc.reduce_cols-1379"><span class="linenos">1379</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1380"><a href="#COMPsc.reduce_cols-1380"><span class="linenos">1380</span></a>
</span><span id="COMPsc.reduce_cols-1381"><a href="#COMPsc.reduce_cols-1381"><span class="linenos">1381</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1382"><a href="#COMPsc.reduce_cols-1382"><span class="linenos">1382</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1383"><a href="#COMPsc.reduce_cols-1383"><span class="linenos">1383</span></a>                        <span class="o">+</span> <span class="s2">&quot; # &quot;</span>
</span><span id="COMPsc.reduce_cols-1384"><a href="#COMPsc.reduce_cols-1384"><span class="linenos">1384</span></a>                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1385"><a href="#COMPsc.reduce_cols-1385"><span class="linenos">1385</span></a>                    <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1386"><a href="#COMPsc.reduce_cols-1386"><span class="linenos">1386</span></a>
</span><span id="COMPsc.reduce_cols-1387"><a href="#COMPsc.reduce_cols-1387"><span class="linenos">1387</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1388"><a href="#COMPsc.reduce_cols-1388"><span class="linenos">1388</span></a>
</span><span id="COMPsc.reduce_cols-1389"><a href="#COMPsc.reduce_cols-1389"><span class="linenos">1389</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1390"><a href="#COMPsc.reduce_cols-1390"><span class="linenos">1390</span></a>
</span><span id="COMPsc.reduce_cols-1391"><a href="#COMPsc.reduce_cols-1391"><span class="linenos">1391</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">reg</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1392"><a href="#COMPsc.reduce_cols-1392"><span class="linenos">1392</span></a>
</span><span id="COMPsc.reduce_cols-1393"><a href="#COMPsc.reduce_cols-1393"><span class="linenos">1393</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1394"><a href="#COMPsc.reduce_cols-1394"><span class="linenos">1394</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1395"><a href="#COMPsc.reduce_cols-1395"><span class="linenos">1395</span></a>
</span><span id="COMPsc.reduce_cols-1396"><a href="#COMPsc.reduce_cols-1396"><span class="linenos">1396</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1397"><a href="#COMPsc.reduce_cols-1397"><span class="linenos">1397</span></a>
</span><span id="COMPsc.reduce_cols-1398"><a href="#COMPsc.reduce_cols-1398"><span class="linenos">1398</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1399"><a href="#COMPsc.reduce_cols-1399"><span class="linenos">1399</span></a>
</span><span id="COMPsc.reduce_cols-1400"><a href="#COMPsc.reduce_cols-1400"><span class="linenos">1400</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1401"><a href="#COMPsc.reduce_cols-1401"><span class="linenos">1401</span></a>
</span><span id="COMPsc.reduce_cols-1402"><a href="#COMPsc.reduce_cols-1402"><span class="linenos">1402</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1403"><a href="#COMPsc.reduce_cols-1403"><span class="linenos">1403</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1404"><a href="#COMPsc.reduce_cols-1404"><span class="linenos">1404</span></a>                        <span class="o">+</span> <span class="s2">&quot; # &quot;</span>
</span><span id="COMPsc.reduce_cols-1405"><a href="#COMPsc.reduce_cols-1405"><span class="linenos">1405</span></a>                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1406"><a href="#COMPsc.reduce_cols-1406"><span class="linenos">1406</span></a>                    <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1407"><a href="#COMPsc.reduce_cols-1407"><span class="linenos">1407</span></a>
</span><span id="COMPsc.reduce_cols-1408"><a href="#COMPsc.reduce_cols-1408"><span class="linenos">1408</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1409"><a href="#COMPsc.reduce_cols-1409"><span class="linenos">1409</span></a>
</span><span id="COMPsc.reduce_cols-1410"><a href="#COMPsc.reduce_cols-1410"><span class="linenos">1410</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1411"><a href="#COMPsc.reduce_cols-1411"><span class="linenos">1411</span></a>
</span><span id="COMPsc.reduce_cols-1412"><a href="#COMPsc.reduce_cols-1412"><span class="linenos">1412</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc.reduce_cols-1413"><a href="#COMPsc.reduce_cols-1413"><span class="linenos">1413</span></a>                    <span class="n">reg</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="COMPsc.reduce_cols-1414"><a href="#COMPsc.reduce_cols-1414"><span class="linenos">1414</span></a>                <span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1415"><a href="#COMPsc.reduce_cols-1415"><span class="linenos">1415</span></a>
</span><span id="COMPsc.reduce_cols-1416"><a href="#COMPsc.reduce_cols-1416"><span class="linenos">1416</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1417"><a href="#COMPsc.reduce_cols-1417"><span class="linenos">1417</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1418"><a href="#COMPsc.reduce_cols-1418"><span class="linenos">1418</span></a>
</span><span id="COMPsc.reduce_cols-1419"><a href="#COMPsc.reduce_cols-1419"><span class="linenos">1419</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1420"><a href="#COMPsc.reduce_cols-1420"><span class="linenos">1420</span></a>
</span><span id="COMPsc.reduce_cols-1421"><a href="#COMPsc.reduce_cols-1421"><span class="linenos">1421</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1422"><a href="#COMPsc.reduce_cols-1422"><span class="linenos">1422</span></a>
</span><span id="COMPsc.reduce_cols-1423"><a href="#COMPsc.reduce_cols-1423"><span class="linenos">1423</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1424"><a href="#COMPsc.reduce_cols-1424"><span class="linenos">1424</span></a>
</span><span id="COMPsc.reduce_cols-1425"><a href="#COMPsc.reduce_cols-1425"><span class="linenos">1425</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1426"><a href="#COMPsc.reduce_cols-1426"><span class="linenos">1426</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1427"><a href="#COMPsc.reduce_cols-1427"><span class="linenos">1427</span></a>                        <span class="o">+</span> <span class="s2">&quot; # &quot;</span>
</span><span id="COMPsc.reduce_cols-1428"><a href="#COMPsc.reduce_cols-1428"><span class="linenos">1428</span></a>                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1429"><a href="#COMPsc.reduce_cols-1429"><span class="linenos">1429</span></a>                    <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1430"><a href="#COMPsc.reduce_cols-1430"><span class="linenos">1430</span></a>
</span><span id="COMPsc.reduce_cols-1431"><a href="#COMPsc.reduce_cols-1431"><span class="linenos">1431</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1432"><a href="#COMPsc.reduce_cols-1432"><span class="linenos">1432</span></a>
</span><span id="COMPsc.reduce_cols-1433"><a href="#COMPsc.reduce_cols-1433"><span class="linenos">1433</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1434"><a href="#COMPsc.reduce_cols-1434"><span class="linenos">1434</span></a>
</span><span id="COMPsc.reduce_cols-1435"><a href="#COMPsc.reduce_cols-1435"><span class="linenos">1435</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc.reduce_cols-1436"><a href="#COMPsc.reduce_cols-1436"><span class="linenos">1436</span></a>                    <span class="n">reg</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1437"><a href="#COMPsc.reduce_cols-1437"><span class="linenos">1437</span></a>                <span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1438"><a href="#COMPsc.reduce_cols-1438"><span class="linenos">1438</span></a>
</span><span id="COMPsc.reduce_cols-1439"><a href="#COMPsc.reduce_cols-1439"><span class="linenos">1439</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1440"><a href="#COMPsc.reduce_cols-1440"><span class="linenos">1440</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1441"><a href="#COMPsc.reduce_cols-1441"><span class="linenos">1441</span></a>
</span><span id="COMPsc.reduce_cols-1442"><a href="#COMPsc.reduce_cols-1442"><span class="linenos">1442</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1443"><a href="#COMPsc.reduce_cols-1443"><span class="linenos">1443</span></a>                    <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="COMPsc.reduce_cols-1444"><a href="#COMPsc.reduce_cols-1444"><span class="linenos">1444</span></a>                <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1445"><a href="#COMPsc.reduce_cols-1445"><span class="linenos">1445</span></a>
</span><span id="COMPsc.reduce_cols-1446"><a href="#COMPsc.reduce_cols-1446"><span class="linenos">1446</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1447"><a href="#COMPsc.reduce_cols-1447"><span class="linenos">1447</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="COMPsc.reduce_cols-1448"><a href="#COMPsc.reduce_cols-1448"><span class="linenos">1448</span></a>                <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1449"><a href="#COMPsc.reduce_cols-1449"><span class="linenos">1449</span></a>
</span><span id="COMPsc.reduce_cols-1450"><a href="#COMPsc.reduce_cols-1450"><span class="linenos">1450</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1451"><a href="#COMPsc.reduce_cols-1451"><span class="linenos">1451</span></a>
</span><span id="COMPsc.reduce_cols-1452"><a href="#COMPsc.reduce_cols-1452"><span class="linenos">1452</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1453"><a href="#COMPsc.reduce_cols-1453"><span class="linenos">1453</span></a>
</span><span id="COMPsc.reduce_cols-1454"><a href="#COMPsc.reduce_cols-1454"><span class="linenos">1454</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1455"><a href="#COMPsc.reduce_cols-1455"><span class="linenos">1455</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1456"><a href="#COMPsc.reduce_cols-1456"><span class="linenos">1456</span></a>                    <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1457"><a href="#COMPsc.reduce_cols-1457"><span class="linenos">1457</span></a>
</span><span id="COMPsc.reduce_cols-1458"><a href="#COMPsc.reduce_cols-1458"><span class="linenos">1458</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1459"><a href="#COMPsc.reduce_cols-1459"><span class="linenos">1459</span></a>
</span><span id="COMPsc.reduce_cols-1460"><a href="#COMPsc.reduce_cols-1460"><span class="linenos">1460</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1461"><a href="#COMPsc.reduce_cols-1461"><span class="linenos">1461</span></a>
</span><span id="COMPsc.reduce_cols-1462"><a href="#COMPsc.reduce_cols-1462"><span class="linenos">1462</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc.reduce_cols-1463"><a href="#COMPsc.reduce_cols-1463"><span class="linenos">1463</span></a>                    <span class="n">reg</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="COMPsc.reduce_cols-1464"><a href="#COMPsc.reduce_cols-1464"><span class="linenos">1464</span></a>                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="COMPsc.reduce_cols-1465"><a href="#COMPsc.reduce_cols-1465"><span class="linenos">1465</span></a>                <span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1466"><a href="#COMPsc.reduce_cols-1466"><span class="linenos">1466</span></a>
</span><span id="COMPsc.reduce_cols-1467"><a href="#COMPsc.reduce_cols-1467"><span class="linenos">1467</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1468"><a href="#COMPsc.reduce_cols-1468"><span class="linenos">1468</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1469"><a href="#COMPsc.reduce_cols-1469"><span class="linenos">1469</span></a>
</span><span id="COMPsc.reduce_cols-1470"><a href="#COMPsc.reduce_cols-1470"><span class="linenos">1470</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1471"><a href="#COMPsc.reduce_cols-1471"><span class="linenos">1471</span></a>
</span><span id="COMPsc.reduce_cols-1472"><a href="#COMPsc.reduce_cols-1472"><span class="linenos">1472</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1473"><a href="#COMPsc.reduce_cols-1473"><span class="linenos">1473</span></a>
</span><span id="COMPsc.reduce_cols-1474"><a href="#COMPsc.reduce_cols-1474"><span class="linenos">1474</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1475"><a href="#COMPsc.reduce_cols-1475"><span class="linenos">1475</span></a>
</span><span id="COMPsc.reduce_cols-1476"><a href="#COMPsc.reduce_cols-1476"><span class="linenos">1476</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1477"><a href="#COMPsc.reduce_cols-1477"><span class="linenos">1477</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1478"><a href="#COMPsc.reduce_cols-1478"><span class="linenos">1478</span></a>                    <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1479"><a href="#COMPsc.reduce_cols-1479"><span class="linenos">1479</span></a>
</span><span id="COMPsc.reduce_cols-1480"><a href="#COMPsc.reduce_cols-1480"><span class="linenos">1480</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1481"><a href="#COMPsc.reduce_cols-1481"><span class="linenos">1481</span></a>
</span><span id="COMPsc.reduce_cols-1482"><a href="#COMPsc.reduce_cols-1482"><span class="linenos">1482</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1483"><a href="#COMPsc.reduce_cols-1483"><span class="linenos">1483</span></a>
</span><span id="COMPsc.reduce_cols-1484"><a href="#COMPsc.reduce_cols-1484"><span class="linenos">1484</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">reg</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]]</span>
</span><span id="COMPsc.reduce_cols-1485"><a href="#COMPsc.reduce_cols-1485"><span class="linenos">1485</span></a>
</span><span id="COMPsc.reduce_cols-1486"><a href="#COMPsc.reduce_cols-1486"><span class="linenos">1486</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1487"><a href="#COMPsc.reduce_cols-1487"><span class="linenos">1487</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1488"><a href="#COMPsc.reduce_cols-1488"><span class="linenos">1488</span></a>
</span><span id="COMPsc.reduce_cols-1489"><a href="#COMPsc.reduce_cols-1489"><span class="linenos">1489</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1490"><a href="#COMPsc.reduce_cols-1490"><span class="linenos">1490</span></a>                    <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="COMPsc.reduce_cols-1491"><a href="#COMPsc.reduce_cols-1491"><span class="linenos">1491</span></a>                <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1492"><a href="#COMPsc.reduce_cols-1492"><span class="linenos">1492</span></a>
</span><span id="COMPsc.reduce_cols-1493"><a href="#COMPsc.reduce_cols-1493"><span class="linenos">1493</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1494"><a href="#COMPsc.reduce_cols-1494"><span class="linenos">1494</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="COMPsc.reduce_cols-1495"><a href="#COMPsc.reduce_cols-1495"><span class="linenos">1495</span></a>                <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1496"><a href="#COMPsc.reduce_cols-1496"><span class="linenos">1496</span></a>
</span><span id="COMPsc.reduce_cols-1497"><a href="#COMPsc.reduce_cols-1497"><span class="linenos">1497</span></a>        <span class="k">elif</span> <span class="n">full</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1498"><a href="#COMPsc.reduce_cols-1498"><span class="linenos">1498</span></a>
</span><span id="COMPsc.reduce_cols-1499"><a href="#COMPsc.reduce_cols-1499"><span class="linenos">1499</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1500"><a href="#COMPsc.reduce_cols-1500"><span class="linenos">1500</span></a>
</span><span id="COMPsc.reduce_cols-1501"><a href="#COMPsc.reduce_cols-1501"><span class="linenos">1501</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1502"><a href="#COMPsc.reduce_cols-1502"><span class="linenos">1502</span></a>
</span><span id="COMPsc.reduce_cols-1503"><a href="#COMPsc.reduce_cols-1503"><span class="linenos">1503</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1504"><a href="#COMPsc.reduce_cols-1504"><span class="linenos">1504</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1505"><a href="#COMPsc.reduce_cols-1505"><span class="linenos">1505</span></a>                        <span class="o">+</span> <span class="s2">&quot; # &quot;</span>
</span><span id="COMPsc.reduce_cols-1506"><a href="#COMPsc.reduce_cols-1506"><span class="linenos">1506</span></a>                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1507"><a href="#COMPsc.reduce_cols-1507"><span class="linenos">1507</span></a>                    <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1508"><a href="#COMPsc.reduce_cols-1508"><span class="linenos">1508</span></a>
</span><span id="COMPsc.reduce_cols-1509"><a href="#COMPsc.reduce_cols-1509"><span class="linenos">1509</span></a>                    <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">full</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1510"><a href="#COMPsc.reduce_cols-1510"><span class="linenos">1510</span></a>
</span><span id="COMPsc.reduce_cols-1511"><a href="#COMPsc.reduce_cols-1511"><span class="linenos">1511</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1512"><a href="#COMPsc.reduce_cols-1512"><span class="linenos">1512</span></a>
</span><span id="COMPsc.reduce_cols-1513"><a href="#COMPsc.reduce_cols-1513"><span class="linenos">1513</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1514"><a href="#COMPsc.reduce_cols-1514"><span class="linenos">1514</span></a>                            <span class="s2">&quot;Not include the set info (name # set) in the &#39;full&#39; argument, where &#39;inc_set&#39; is True&quot;</span>
</span><span id="COMPsc.reduce_cols-1515"><a href="#COMPsc.reduce_cols-1515"><span class="linenos">1515</span></a>                            <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="COMPsc.reduce_cols-1516"><a href="#COMPsc.reduce_cols-1516"><span class="linenos">1516</span></a>                        <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1517"><a href="#COMPsc.reduce_cols-1517"><span class="linenos">1517</span></a>
</span><span id="COMPsc.reduce_cols-1518"><a href="#COMPsc.reduce_cols-1518"><span class="linenos">1518</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1519"><a href="#COMPsc.reduce_cols-1519"><span class="linenos">1519</span></a>
</span><span id="COMPsc.reduce_cols-1520"><a href="#COMPsc.reduce_cols-1520"><span class="linenos">1520</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1521"><a href="#COMPsc.reduce_cols-1521"><span class="linenos">1521</span></a>
</span><span id="COMPsc.reduce_cols-1522"><a href="#COMPsc.reduce_cols-1522"><span class="linenos">1522</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">full</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1523"><a href="#COMPsc.reduce_cols-1523"><span class="linenos">1523</span></a>
</span><span id="COMPsc.reduce_cols-1524"><a href="#COMPsc.reduce_cols-1524"><span class="linenos">1524</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1525"><a href="#COMPsc.reduce_cols-1525"><span class="linenos">1525</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1526"><a href="#COMPsc.reduce_cols-1526"><span class="linenos">1526</span></a>
</span><span id="COMPsc.reduce_cols-1527"><a href="#COMPsc.reduce_cols-1527"><span class="linenos">1527</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1528"><a href="#COMPsc.reduce_cols-1528"><span class="linenos">1528</span></a>
</span><span id="COMPsc.reduce_cols-1529"><a href="#COMPsc.reduce_cols-1529"><span class="linenos">1529</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1530"><a href="#COMPsc.reduce_cols-1530"><span class="linenos">1530</span></a>
</span><span id="COMPsc.reduce_cols-1531"><a href="#COMPsc.reduce_cols-1531"><span class="linenos">1531</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1532"><a href="#COMPsc.reduce_cols-1532"><span class="linenos">1532</span></a>
</span><span id="COMPsc.reduce_cols-1533"><a href="#COMPsc.reduce_cols-1533"><span class="linenos">1533</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1534"><a href="#COMPsc.reduce_cols-1534"><span class="linenos">1534</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1535"><a href="#COMPsc.reduce_cols-1535"><span class="linenos">1535</span></a>                        <span class="o">+</span> <span class="s2">&quot; # &quot;</span>
</span><span id="COMPsc.reduce_cols-1536"><a href="#COMPsc.reduce_cols-1536"><span class="linenos">1536</span></a>                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1537"><a href="#COMPsc.reduce_cols-1537"><span class="linenos">1537</span></a>                    <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1538"><a href="#COMPsc.reduce_cols-1538"><span class="linenos">1538</span></a>
</span><span id="COMPsc.reduce_cols-1539"><a href="#COMPsc.reduce_cols-1539"><span class="linenos">1539</span></a>                    <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">full</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1540"><a href="#COMPsc.reduce_cols-1540"><span class="linenos">1540</span></a>
</span><span id="COMPsc.reduce_cols-1541"><a href="#COMPsc.reduce_cols-1541"><span class="linenos">1541</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1542"><a href="#COMPsc.reduce_cols-1542"><span class="linenos">1542</span></a>
</span><span id="COMPsc.reduce_cols-1543"><a href="#COMPsc.reduce_cols-1543"><span class="linenos">1543</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1544"><a href="#COMPsc.reduce_cols-1544"><span class="linenos">1544</span></a>                            <span class="s2">&quot;Not include the set info (name # set) in the &#39;full&#39; argument, where &#39;inc_set&#39; is True&quot;</span>
</span><span id="COMPsc.reduce_cols-1545"><a href="#COMPsc.reduce_cols-1545"><span class="linenos">1545</span></a>                            <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="COMPsc.reduce_cols-1546"><a href="#COMPsc.reduce_cols-1546"><span class="linenos">1546</span></a>                        <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1547"><a href="#COMPsc.reduce_cols-1547"><span class="linenos">1547</span></a>
</span><span id="COMPsc.reduce_cols-1548"><a href="#COMPsc.reduce_cols-1548"><span class="linenos">1548</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1549"><a href="#COMPsc.reduce_cols-1549"><span class="linenos">1549</span></a>
</span><span id="COMPsc.reduce_cols-1550"><a href="#COMPsc.reduce_cols-1550"><span class="linenos">1550</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1551"><a href="#COMPsc.reduce_cols-1551"><span class="linenos">1551</span></a>
</span><span id="COMPsc.reduce_cols-1552"><a href="#COMPsc.reduce_cols-1552"><span class="linenos">1552</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">full</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1553"><a href="#COMPsc.reduce_cols-1553"><span class="linenos">1553</span></a>
</span><span id="COMPsc.reduce_cols-1554"><a href="#COMPsc.reduce_cols-1554"><span class="linenos">1554</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1555"><a href="#COMPsc.reduce_cols-1555"><span class="linenos">1555</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1556"><a href="#COMPsc.reduce_cols-1556"><span class="linenos">1556</span></a>
</span><span id="COMPsc.reduce_cols-1557"><a href="#COMPsc.reduce_cols-1557"><span class="linenos">1557</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1558"><a href="#COMPsc.reduce_cols-1558"><span class="linenos">1558</span></a>
</span><span id="COMPsc.reduce_cols-1559"><a href="#COMPsc.reduce_cols-1559"><span class="linenos">1559</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1560"><a href="#COMPsc.reduce_cols-1560"><span class="linenos">1560</span></a>
</span><span id="COMPsc.reduce_cols-1561"><a href="#COMPsc.reduce_cols-1561"><span class="linenos">1561</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1562"><a href="#COMPsc.reduce_cols-1562"><span class="linenos">1562</span></a>
</span><span id="COMPsc.reduce_cols-1563"><a href="#COMPsc.reduce_cols-1563"><span class="linenos">1563</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1564"><a href="#COMPsc.reduce_cols-1564"><span class="linenos">1564</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1565"><a href="#COMPsc.reduce_cols-1565"><span class="linenos">1565</span></a>                        <span class="o">+</span> <span class="s2">&quot; # &quot;</span>
</span><span id="COMPsc.reduce_cols-1566"><a href="#COMPsc.reduce_cols-1566"><span class="linenos">1566</span></a>                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1567"><a href="#COMPsc.reduce_cols-1567"><span class="linenos">1567</span></a>                    <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1568"><a href="#COMPsc.reduce_cols-1568"><span class="linenos">1568</span></a>
</span><span id="COMPsc.reduce_cols-1569"><a href="#COMPsc.reduce_cols-1569"><span class="linenos">1569</span></a>                    <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">full</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1570"><a href="#COMPsc.reduce_cols-1570"><span class="linenos">1570</span></a>
</span><span id="COMPsc.reduce_cols-1571"><a href="#COMPsc.reduce_cols-1571"><span class="linenos">1571</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1572"><a href="#COMPsc.reduce_cols-1572"><span class="linenos">1572</span></a>
</span><span id="COMPsc.reduce_cols-1573"><a href="#COMPsc.reduce_cols-1573"><span class="linenos">1573</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1574"><a href="#COMPsc.reduce_cols-1574"><span class="linenos">1574</span></a>                            <span class="s2">&quot;Not include the set info (name # set) in the &#39;full&#39; argument, where &#39;inc_set&#39; is True&quot;</span>
</span><span id="COMPsc.reduce_cols-1575"><a href="#COMPsc.reduce_cols-1575"><span class="linenos">1575</span></a>                            <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="COMPsc.reduce_cols-1576"><a href="#COMPsc.reduce_cols-1576"><span class="linenos">1576</span></a>                        <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1577"><a href="#COMPsc.reduce_cols-1577"><span class="linenos">1577</span></a>
</span><span id="COMPsc.reduce_cols-1578"><a href="#COMPsc.reduce_cols-1578"><span class="linenos">1578</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1579"><a href="#COMPsc.reduce_cols-1579"><span class="linenos">1579</span></a>
</span><span id="COMPsc.reduce_cols-1580"><a href="#COMPsc.reduce_cols-1580"><span class="linenos">1580</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1581"><a href="#COMPsc.reduce_cols-1581"><span class="linenos">1581</span></a>
</span><span id="COMPsc.reduce_cols-1582"><a href="#COMPsc.reduce_cols-1582"><span class="linenos">1582</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">full</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]]</span>
</span><span id="COMPsc.reduce_cols-1583"><a href="#COMPsc.reduce_cols-1583"><span class="linenos">1583</span></a>
</span><span id="COMPsc.reduce_cols-1584"><a href="#COMPsc.reduce_cols-1584"><span class="linenos">1584</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1585"><a href="#COMPsc.reduce_cols-1585"><span class="linenos">1585</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1586"><a href="#COMPsc.reduce_cols-1586"><span class="linenos">1586</span></a>
</span><span id="COMPsc.reduce_cols-1587"><a href="#COMPsc.reduce_cols-1587"><span class="linenos">1587</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1588"><a href="#COMPsc.reduce_cols-1588"><span class="linenos">1588</span></a>                    <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="COMPsc.reduce_cols-1589"><a href="#COMPsc.reduce_cols-1589"><span class="linenos">1589</span></a>                <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1590"><a href="#COMPsc.reduce_cols-1590"><span class="linenos">1590</span></a>
</span><span id="COMPsc.reduce_cols-1591"><a href="#COMPsc.reduce_cols-1591"><span class="linenos">1591</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1592"><a href="#COMPsc.reduce_cols-1592"><span class="linenos">1592</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="COMPsc.reduce_cols-1593"><a href="#COMPsc.reduce_cols-1593"><span class="linenos">1593</span></a>                <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1594"><a href="#COMPsc.reduce_cols-1594"><span class="linenos">1594</span></a>
</span><span id="COMPsc.reduce_cols-1595"><a href="#COMPsc.reduce_cols-1595"><span class="linenos">1595</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1596"><a href="#COMPsc.reduce_cols-1596"><span class="linenos">1596</span></a>
</span><span id="COMPsc.reduce_cols-1597"><a href="#COMPsc.reduce_cols-1597"><span class="linenos">1597</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1598"><a href="#COMPsc.reduce_cols-1598"><span class="linenos">1598</span></a>
</span><span id="COMPsc.reduce_cols-1599"><a href="#COMPsc.reduce_cols-1599"><span class="linenos">1599</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1600"><a href="#COMPsc.reduce_cols-1600"><span class="linenos">1600</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1601"><a href="#COMPsc.reduce_cols-1601"><span class="linenos">1601</span></a>                    <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1602"><a href="#COMPsc.reduce_cols-1602"><span class="linenos">1602</span></a>
</span><span id="COMPsc.reduce_cols-1603"><a href="#COMPsc.reduce_cols-1603"><span class="linenos">1603</span></a>                    <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">full</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1604"><a href="#COMPsc.reduce_cols-1604"><span class="linenos">1604</span></a>
</span><span id="COMPsc.reduce_cols-1605"><a href="#COMPsc.reduce_cols-1605"><span class="linenos">1605</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1606"><a href="#COMPsc.reduce_cols-1606"><span class="linenos">1606</span></a>
</span><span id="COMPsc.reduce_cols-1607"><a href="#COMPsc.reduce_cols-1607"><span class="linenos">1607</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1608"><a href="#COMPsc.reduce_cols-1608"><span class="linenos">1608</span></a>                            <span class="s2">&quot;Not include the set info (name # set) in the &#39;full&#39; argument, where &#39;inc_set&#39; is True&quot;</span>
</span><span id="COMPsc.reduce_cols-1609"><a href="#COMPsc.reduce_cols-1609"><span class="linenos">1609</span></a>                            <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="COMPsc.reduce_cols-1610"><a href="#COMPsc.reduce_cols-1610"><span class="linenos">1610</span></a>                        <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1611"><a href="#COMPsc.reduce_cols-1611"><span class="linenos">1611</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1612"><a href="#COMPsc.reduce_cols-1612"><span class="linenos">1612</span></a>
</span><span id="COMPsc.reduce_cols-1613"><a href="#COMPsc.reduce_cols-1613"><span class="linenos">1613</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1614"><a href="#COMPsc.reduce_cols-1614"><span class="linenos">1614</span></a>
</span><span id="COMPsc.reduce_cols-1615"><a href="#COMPsc.reduce_cols-1615"><span class="linenos">1615</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc.reduce_cols-1616"><a href="#COMPsc.reduce_cols-1616"><span class="linenos">1616</span></a>                    <span class="n">full</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="COMPsc.reduce_cols-1617"><a href="#COMPsc.reduce_cols-1617"><span class="linenos">1617</span></a>                <span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1618"><a href="#COMPsc.reduce_cols-1618"><span class="linenos">1618</span></a>
</span><span id="COMPsc.reduce_cols-1619"><a href="#COMPsc.reduce_cols-1619"><span class="linenos">1619</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1620"><a href="#COMPsc.reduce_cols-1620"><span class="linenos">1620</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1621"><a href="#COMPsc.reduce_cols-1621"><span class="linenos">1621</span></a>
</span><span id="COMPsc.reduce_cols-1622"><a href="#COMPsc.reduce_cols-1622"><span class="linenos">1622</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1623"><a href="#COMPsc.reduce_cols-1623"><span class="linenos">1623</span></a>
</span><span id="COMPsc.reduce_cols-1624"><a href="#COMPsc.reduce_cols-1624"><span class="linenos">1624</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1625"><a href="#COMPsc.reduce_cols-1625"><span class="linenos">1625</span></a>
</span><span id="COMPsc.reduce_cols-1626"><a href="#COMPsc.reduce_cols-1626"><span class="linenos">1626</span></a>                <span class="k">if</span> <span class="n">inc_set</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1627"><a href="#COMPsc.reduce_cols-1627"><span class="linenos">1627</span></a>
</span><span id="COMPsc.reduce_cols-1628"><a href="#COMPsc.reduce_cols-1628"><span class="linenos">1628</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1629"><a href="#COMPsc.reduce_cols-1629"><span class="linenos">1629</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1630"><a href="#COMPsc.reduce_cols-1630"><span class="linenos">1630</span></a>                    <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1631"><a href="#COMPsc.reduce_cols-1631"><span class="linenos">1631</span></a>
</span><span id="COMPsc.reduce_cols-1632"><a href="#COMPsc.reduce_cols-1632"><span class="linenos">1632</span></a>                    <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">full</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1633"><a href="#COMPsc.reduce_cols-1633"><span class="linenos">1633</span></a>
</span><span id="COMPsc.reduce_cols-1634"><a href="#COMPsc.reduce_cols-1634"><span class="linenos">1634</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1635"><a href="#COMPsc.reduce_cols-1635"><span class="linenos">1635</span></a>
</span><span id="COMPsc.reduce_cols-1636"><a href="#COMPsc.reduce_cols-1636"><span class="linenos">1636</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1637"><a href="#COMPsc.reduce_cols-1637"><span class="linenos">1637</span></a>                            <span class="s2">&quot;Not include the set info (name # set) in the &#39;full&#39; argument, where &#39;inc_set&#39; is True&quot;</span>
</span><span id="COMPsc.reduce_cols-1638"><a href="#COMPsc.reduce_cols-1638"><span class="linenos">1638</span></a>                            <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="COMPsc.reduce_cols-1639"><a href="#COMPsc.reduce_cols-1639"><span class="linenos">1639</span></a>                        <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1640"><a href="#COMPsc.reduce_cols-1640"><span class="linenos">1640</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1641"><a href="#COMPsc.reduce_cols-1641"><span class="linenos">1641</span></a>
</span><span id="COMPsc.reduce_cols-1642"><a href="#COMPsc.reduce_cols-1642"><span class="linenos">1642</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.reduce_cols-1643"><a href="#COMPsc.reduce_cols-1643"><span class="linenos">1643</span></a>
</span><span id="COMPsc.reduce_cols-1644"><a href="#COMPsc.reduce_cols-1644"><span class="linenos">1644</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">full</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]]</span>
</span><span id="COMPsc.reduce_cols-1645"><a href="#COMPsc.reduce_cols-1645"><span class="linenos">1645</span></a>
</span><span id="COMPsc.reduce_cols-1646"><a href="#COMPsc.reduce_cols-1646"><span class="linenos">1646</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.reduce_cols-1647"><a href="#COMPsc.reduce_cols-1647"><span class="linenos">1647</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1648"><a href="#COMPsc.reduce_cols-1648"><span class="linenos">1648</span></a>
</span><span id="COMPsc.reduce_cols-1649"><a href="#COMPsc.reduce_cols-1649"><span class="linenos">1649</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1650"><a href="#COMPsc.reduce_cols-1650"><span class="linenos">1650</span></a>                    <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="COMPsc.reduce_cols-1651"><a href="#COMPsc.reduce_cols-1651"><span class="linenos">1651</span></a>                <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1652"><a href="#COMPsc.reduce_cols-1652"><span class="linenos">1652</span></a>
</span><span id="COMPsc.reduce_cols-1653"><a href="#COMPsc.reduce_cols-1653"><span class="linenos">1653</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="COMPsc.reduce_cols-1654"><a href="#COMPsc.reduce_cols-1654"><span class="linenos">1654</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="COMPsc.reduce_cols-1655"><a href="#COMPsc.reduce_cols-1655"><span class="linenos">1655</span></a>                <span class="p">)</span>
</span><span id="COMPsc.reduce_cols-1656"><a href="#COMPsc.reduce_cols-1656"><span class="linenos">1656</span></a>
</span><span id="COMPsc.reduce_cols-1657"><a href="#COMPsc.reduce_cols-1657"><span class="linenos">1657</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_calculation</span><span class="p">()</span>
</span><span id="COMPsc.reduce_cols-1658"><a href="#COMPsc.reduce_cols-1658"><span class="linenos">1658</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Remove columns (cells) whose names contain a substring <code>reg</code> or
full name <code>full</code> from available tables.</p>

<h2 id="parameters">Parameters</h2>

<p>reg : str | None
    Substring to search for in column/cell names; matching columns will be removed.
    If not None, <code>full</code> must be None.</p>

<p>full : str | None
    Full name to search for in column/cell names; matching columns will be removed.
    If not None, <code>reg</code> must be None.</p>

<p>name_slot : str, default 'cell_names'
    Column in metadata to use as sample names.</p>

<p>inc_set : bool, default False
    If True, column names are interpreted as 'cell_name # set' when matching.</p>

<h2 id="update">Update</h2>

<p>Mutates <code>self.input_data</code>, <code>self.normalized_data</code>, <code>self.input_metadata</code>,
<code>self.agg_normalized_data</code>, and <code>self.agg_metadata</code> (if they exist),
removing columns/rows that match <code>reg</code>.</p>

<h2 id="raises">Raises</h2>

<p>Raises ValueError if nothing matches the reduction mask.</p>
</div>


                            </div>
                            <div id="COMPsc.reduce_rows" class="classattr">
                                        <input id="COMPsc.reduce_rows-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reduce_rows</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">features_list</span><span class="p">:</span> <span class="nb">list</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.reduce_rows-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.reduce_rows"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.reduce_rows-1660"><a href="#COMPsc.reduce_rows-1660"><span class="linenos">1660</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reduce_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="COMPsc.reduce_rows-1661"><a href="#COMPsc.reduce_rows-1661"><span class="linenos">1661</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.reduce_rows-1662"><a href="#COMPsc.reduce_rows-1662"><span class="linenos">1662</span></a><span class="sd">        Remove rows (features) whose names are included in features_list.</span>
</span><span id="COMPsc.reduce_rows-1663"><a href="#COMPsc.reduce_rows-1663"><span class="linenos">1663</span></a>
</span><span id="COMPsc.reduce_rows-1664"><a href="#COMPsc.reduce_rows-1664"><span class="linenos">1664</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.reduce_rows-1665"><a href="#COMPsc.reduce_rows-1665"><span class="linenos">1665</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.reduce_rows-1666"><a href="#COMPsc.reduce_rows-1666"><span class="linenos">1666</span></a><span class="sd">        features_list : list</span>
</span><span id="COMPsc.reduce_rows-1667"><a href="#COMPsc.reduce_rows-1667"><span class="linenos">1667</span></a><span class="sd">            List of features to search for in index/gene names; matching entries will be removed.</span>
</span><span id="COMPsc.reduce_rows-1668"><a href="#COMPsc.reduce_rows-1668"><span class="linenos">1668</span></a>
</span><span id="COMPsc.reduce_rows-1669"><a href="#COMPsc.reduce_rows-1669"><span class="linenos">1669</span></a><span class="sd">        Update</span>
</span><span id="COMPsc.reduce_rows-1670"><a href="#COMPsc.reduce_rows-1670"><span class="linenos">1670</span></a><span class="sd">        ------------</span>
</span><span id="COMPsc.reduce_rows-1671"><a href="#COMPsc.reduce_rows-1671"><span class="linenos">1671</span></a><span class="sd">        Mutates `self.input_data`, `self.normalized_data`, `self.input_metadata`,</span>
</span><span id="COMPsc.reduce_rows-1672"><a href="#COMPsc.reduce_rows-1672"><span class="linenos">1672</span></a><span class="sd">        `self.agg_normalized_data`, and `self.agg_metadata` (if they exist),</span>
</span><span id="COMPsc.reduce_rows-1673"><a href="#COMPsc.reduce_rows-1673"><span class="linenos">1673</span></a><span class="sd">        removing columns/rows that match `reg`.</span>
</span><span id="COMPsc.reduce_rows-1674"><a href="#COMPsc.reduce_rows-1674"><span class="linenos">1674</span></a>
</span><span id="COMPsc.reduce_rows-1675"><a href="#COMPsc.reduce_rows-1675"><span class="linenos">1675</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc.reduce_rows-1676"><a href="#COMPsc.reduce_rows-1676"><span class="linenos">1676</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.reduce_rows-1677"><a href="#COMPsc.reduce_rows-1677"><span class="linenos">1677</span></a><span class="sd">        Prints a message listing features that are not found in the data.</span>
</span><span id="COMPsc.reduce_rows-1678"><a href="#COMPsc.reduce_rows-1678"><span class="linenos">1678</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.reduce_rows-1679"><a href="#COMPsc.reduce_rows-1679"><span class="linenos">1679</span></a>
</span><span id="COMPsc.reduce_rows-1680"><a href="#COMPsc.reduce_rows-1680"><span class="linenos">1680</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.reduce_rows-1681"><a href="#COMPsc.reduce_rows-1681"><span class="linenos">1681</span></a>
</span><span id="COMPsc.reduce_rows-1682"><a href="#COMPsc.reduce_rows-1682"><span class="linenos">1682</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">find_features</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features_list</span><span class="p">)</span>
</span><span id="COMPsc.reduce_rows-1683"><a href="#COMPsc.reduce_rows-1683"><span class="linenos">1683</span></a>
</span><span id="COMPsc.reduce_rows-1684"><a href="#COMPsc.reduce_rows-1684"><span class="linenos">1684</span></a>            <span class="n">res_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;included&quot;</span><span class="p">]]</span>
</span><span id="COMPsc.reduce_rows-1685"><a href="#COMPsc.reduce_rows-1685"><span class="linenos">1685</span></a>
</span><span id="COMPsc.reduce_rows-1686"><a href="#COMPsc.reduce_rows-1686"><span class="linenos">1686</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res_list</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="COMPsc.reduce_rows-1687"><a href="#COMPsc.reduce_rows-1687"><span class="linenos">1687</span></a>
</span><span id="COMPsc.reduce_rows-1688"><a href="#COMPsc.reduce_rows-1688"><span class="linenos">1688</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.reduce_rows-1689"><a href="#COMPsc.reduce_rows-1689"><span class="linenos">1689</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc.reduce_rows-1690"><a href="#COMPsc.reduce_rows-1690"><span class="linenos">1690</span></a>
</span><span id="COMPsc.reduce_rows-1691"><a href="#COMPsc.reduce_rows-1691"><span class="linenos">1691</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="COMPsc.reduce_rows-1692"><a href="#COMPsc.reduce_rows-1692"><span class="linenos">1692</span></a>
</span><span id="COMPsc.reduce_rows-1693"><a href="#COMPsc.reduce_rows-1693"><span class="linenos">1693</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.reduce_rows-1694"><a href="#COMPsc.reduce_rows-1694"><span class="linenos">1694</span></a>
</span><span id="COMPsc.reduce_rows-1695"><a href="#COMPsc.reduce_rows-1695"><span class="linenos">1695</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">find_features</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features_list</span><span class="p">)</span>
</span><span id="COMPsc.reduce_rows-1696"><a href="#COMPsc.reduce_rows-1696"><span class="linenos">1696</span></a>
</span><span id="COMPsc.reduce_rows-1697"><a href="#COMPsc.reduce_rows-1697"><span class="linenos">1697</span></a>            <span class="n">res_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;included&quot;</span><span class="p">]]</span>
</span><span id="COMPsc.reduce_rows-1698"><a href="#COMPsc.reduce_rows-1698"><span class="linenos">1698</span></a>
</span><span id="COMPsc.reduce_rows-1699"><a href="#COMPsc.reduce_rows-1699"><span class="linenos">1699</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res_list</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="COMPsc.reduce_rows-1700"><a href="#COMPsc.reduce_rows-1700"><span class="linenos">1700</span></a>
</span><span id="COMPsc.reduce_rows-1701"><a href="#COMPsc.reduce_rows-1701"><span class="linenos">1701</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.reduce_rows-1702"><a href="#COMPsc.reduce_rows-1702"><span class="linenos">1702</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc.reduce_rows-1703"><a href="#COMPsc.reduce_rows-1703"><span class="linenos">1703</span></a>
</span><span id="COMPsc.reduce_rows-1704"><a href="#COMPsc.reduce_rows-1704"><span class="linenos">1704</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="COMPsc.reduce_rows-1705"><a href="#COMPsc.reduce_rows-1705"><span class="linenos">1705</span></a>
</span><span id="COMPsc.reduce_rows-1706"><a href="#COMPsc.reduce_rows-1706"><span class="linenos">1706</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.reduce_rows-1707"><a href="#COMPsc.reduce_rows-1707"><span class="linenos">1707</span></a>
</span><span id="COMPsc.reduce_rows-1708"><a href="#COMPsc.reduce_rows-1708"><span class="linenos">1708</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">find_features</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features_list</span><span class="p">)</span>
</span><span id="COMPsc.reduce_rows-1709"><a href="#COMPsc.reduce_rows-1709"><span class="linenos">1709</span></a>
</span><span id="COMPsc.reduce_rows-1710"><a href="#COMPsc.reduce_rows-1710"><span class="linenos">1710</span></a>            <span class="n">res_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;included&quot;</span><span class="p">]]</span>
</span><span id="COMPsc.reduce_rows-1711"><a href="#COMPsc.reduce_rows-1711"><span class="linenos">1711</span></a>
</span><span id="COMPsc.reduce_rows-1712"><a href="#COMPsc.reduce_rows-1712"><span class="linenos">1712</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res_list</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="COMPsc.reduce_rows-1713"><a href="#COMPsc.reduce_rows-1713"><span class="linenos">1713</span></a>
</span><span id="COMPsc.reduce_rows-1714"><a href="#COMPsc.reduce_rows-1714"><span class="linenos">1714</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.reduce_rows-1715"><a href="#COMPsc.reduce_rows-1715"><span class="linenos">1715</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing found to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc.reduce_rows-1716"><a href="#COMPsc.reduce_rows-1716"><span class="linenos">1716</span></a>
</span><span id="COMPsc.reduce_rows-1717"><a href="#COMPsc.reduce_rows-1717"><span class="linenos">1717</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="COMPsc.reduce_rows-1718"><a href="#COMPsc.reduce_rows-1718"><span class="linenos">1718</span></a>
</span><span id="COMPsc.reduce_rows-1719"><a href="#COMPsc.reduce_rows-1719"><span class="linenos">1719</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;not_included&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.reduce_rows-1720"><a href="#COMPsc.reduce_rows-1720"><span class="linenos">1720</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Features not found:&quot;</span><span class="p">)</span>
</span><span id="COMPsc.reduce_rows-1721"><a href="#COMPsc.reduce_rows-1721"><span class="linenos">1721</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;not_included&quot;</span><span class="p">]:</span>
</span><span id="COMPsc.reduce_rows-1722"><a href="#COMPsc.reduce_rows-1722"><span class="linenos">1722</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="COMPsc.reduce_rows-1723"><a href="#COMPsc.reduce_rows-1723"><span class="linenos">1723</span></a>
</span><span id="COMPsc.reduce_rows-1724"><a href="#COMPsc.reduce_rows-1724"><span class="linenos">1724</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_calculation</span><span class="p">()</span>
</span><span id="COMPsc.reduce_rows-1725"><a href="#COMPsc.reduce_rows-1725"><span class="linenos">1725</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Remove rows (features) whose names are included in features_list.</p>

<h2 id="parameters">Parameters</h2>

<p>features_list : list
    List of features to search for in index/gene names; matching entries will be removed.</p>

<h2 id="update">Update</h2>

<p>Mutates <code>self.input_data</code>, <code>self.normalized_data</code>, <code>self.input_metadata</code>,
<code>self.agg_normalized_data</code>, and <code>self.agg_metadata</code> (if they exist),
removing columns/rows that match <code>reg</code>.</p>

<h2 id="raises">Raises</h2>

<p>Prints a message listing features that are not found in the data.</p>
</div>


                            </div>
                            <div id="COMPsc.get_data" class="classattr">
                                        <input id="COMPsc.get_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_data</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">set_info</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.get_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.get_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.get_data-1727"><a href="#COMPsc.get_data-1727"><span class="linenos">1727</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_info</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="COMPsc.get_data-1728"><a href="#COMPsc.get_data-1728"><span class="linenos">1728</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.get_data-1729"><a href="#COMPsc.get_data-1729"><span class="linenos">1729</span></a><span class="sd">        Return normalized data with optional set annotation appended to column names.</span>
</span><span id="COMPsc.get_data-1730"><a href="#COMPsc.get_data-1730"><span class="linenos">1730</span></a>
</span><span id="COMPsc.get_data-1731"><a href="#COMPsc.get_data-1731"><span class="linenos">1731</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.get_data-1732"><a href="#COMPsc.get_data-1732"><span class="linenos">1732</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.get_data-1733"><a href="#COMPsc.get_data-1733"><span class="linenos">1733</span></a><span class="sd">        set_info : bool, default False</span>
</span><span id="COMPsc.get_data-1734"><a href="#COMPsc.get_data-1734"><span class="linenos">1734</span></a><span class="sd">            If True, column names are returned as &quot;cell_name # set&quot;; otherwise</span>
</span><span id="COMPsc.get_data-1735"><a href="#COMPsc.get_data-1735"><span class="linenos">1735</span></a><span class="sd">            only the `cell_name` is used.</span>
</span><span id="COMPsc.get_data-1736"><a href="#COMPsc.get_data-1736"><span class="linenos">1736</span></a>
</span><span id="COMPsc.get_data-1737"><a href="#COMPsc.get_data-1737"><span class="linenos">1737</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc.get_data-1738"><a href="#COMPsc.get_data-1738"><span class="linenos">1738</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.get_data-1739"><a href="#COMPsc.get_data-1739"><span class="linenos">1739</span></a><span class="sd">        pandas.DataFrame</span>
</span><span id="COMPsc.get_data-1740"><a href="#COMPsc.get_data-1740"><span class="linenos">1740</span></a><span class="sd">            The `self.normalized_data` table with columns renamed according to `set_info`.</span>
</span><span id="COMPsc.get_data-1741"><a href="#COMPsc.get_data-1741"><span class="linenos">1741</span></a>
</span><span id="COMPsc.get_data-1742"><a href="#COMPsc.get_data-1742"><span class="linenos">1742</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc.get_data-1743"><a href="#COMPsc.get_data-1743"><span class="linenos">1743</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.get_data-1744"><a href="#COMPsc.get_data-1744"><span class="linenos">1744</span></a><span class="sd">        AttributeError</span>
</span><span id="COMPsc.get_data-1745"><a href="#COMPsc.get_data-1745"><span class="linenos">1745</span></a><span class="sd">            If `self.normalized_data` or `self.input_metadata` is missing.</span>
</span><span id="COMPsc.get_data-1746"><a href="#COMPsc.get_data-1746"><span class="linenos">1746</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.get_data-1747"><a href="#COMPsc.get_data-1747"><span class="linenos">1747</span></a>
</span><span id="COMPsc.get_data-1748"><a href="#COMPsc.get_data-1748"><span class="linenos">1748</span></a>        <span class="n">to_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span>
</span><span id="COMPsc.get_data-1749"><a href="#COMPsc.get_data-1749"><span class="linenos">1749</span></a>
</span><span id="COMPsc.get_data-1750"><a href="#COMPsc.get_data-1750"><span class="linenos">1750</span></a>        <span class="k">if</span> <span class="n">set_info</span><span class="p">:</span>
</span><span id="COMPsc.get_data-1751"><a href="#COMPsc.get_data-1751"><span class="linenos">1751</span></a>            <span class="n">to_return</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc.get_data-1752"><a href="#COMPsc.get_data-1752"><span class="linenos">1752</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc.get_data-1753"><a href="#COMPsc.get_data-1753"><span class="linenos">1753</span></a>            <span class="p">)</span>
</span><span id="COMPsc.get_data-1754"><a href="#COMPsc.get_data-1754"><span class="linenos">1754</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.get_data-1755"><a href="#COMPsc.get_data-1755"><span class="linenos">1755</span></a>            <span class="n">to_return</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span>
</span><span id="COMPsc.get_data-1756"><a href="#COMPsc.get_data-1756"><span class="linenos">1756</span></a>
</span><span id="COMPsc.get_data-1757"><a href="#COMPsc.get_data-1757"><span class="linenos">1757</span></a>        <span class="k">return</span> <span class="n">to_return</span>
</span></pre></div>


            <div class="docstring"><p>Return normalized data with optional set annotation appended to column names.</p>

<h2 id="parameters">Parameters</h2>

<p>set_info : bool, default False
    If True, column names are returned as "cell_name # set"; otherwise
    only the <code>cell_name</code> is used.</p>

<h2 id="returns">Returns</h2>

<p>pandas.DataFrame
    The <code>self.normalized_data</code> table with columns renamed according to <code>set_info</code>.</p>

<h2 id="raises">Raises</h2>

<p>AttributeError
    If <code>self.normalized_data</code> or <code>self.input_metadata</code> is missing.</p>
</div>


                            </div>
                            <div id="COMPsc.get_partial_data" class="classattr">
                                        <input id="COMPsc.get_partial_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_partial_data</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">features</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cell_names&#39;</span>,</span><span class="param">	<span class="n">inc_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.get_partial_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.get_partial_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.get_partial_data-1759"><a href="#COMPsc.get_partial_data-1759"><span class="linenos">1759</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_partial_data</span><span class="p">(</span>
</span><span id="COMPsc.get_partial_data-1760"><a href="#COMPsc.get_partial_data-1760"><span class="linenos">1760</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc.get_partial_data-1761"><a href="#COMPsc.get_partial_data-1761"><span class="linenos">1761</span></a>        <span class="n">names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.get_partial_data-1762"><a href="#COMPsc.get_partial_data-1762"><span class="linenos">1762</span></a>        <span class="n">features</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.get_partial_data-1763"><a href="#COMPsc.get_partial_data-1763"><span class="linenos">1763</span></a>        <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="COMPsc.get_partial_data-1764"><a href="#COMPsc.get_partial_data-1764"><span class="linenos">1764</span></a>        <span class="n">inc_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="COMPsc.get_partial_data-1765"><a href="#COMPsc.get_partial_data-1765"><span class="linenos">1765</span></a>    <span class="p">):</span>
</span><span id="COMPsc.get_partial_data-1766"><a href="#COMPsc.get_partial_data-1766"><span class="linenos">1766</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.get_partial_data-1767"><a href="#COMPsc.get_partial_data-1767"><span class="linenos">1767</span></a><span class="sd">        Return a subset of the data filtered by sample names and/or feature names.</span>
</span><span id="COMPsc.get_partial_data-1768"><a href="#COMPsc.get_partial_data-1768"><span class="linenos">1768</span></a>
</span><span id="COMPsc.get_partial_data-1769"><a href="#COMPsc.get_partial_data-1769"><span class="linenos">1769</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.get_partial_data-1770"><a href="#COMPsc.get_partial_data-1770"><span class="linenos">1770</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.get_partial_data-1771"><a href="#COMPsc.get_partial_data-1771"><span class="linenos">1771</span></a><span class="sd">        names : list, str, or None</span>
</span><span id="COMPsc.get_partial_data-1772"><a href="#COMPsc.get_partial_data-1772"><span class="linenos">1772</span></a><span class="sd">            Names of samples to include. If None, all samples are considered.</span>
</span><span id="COMPsc.get_partial_data-1773"><a href="#COMPsc.get_partial_data-1773"><span class="linenos">1773</span></a>
</span><span id="COMPsc.get_partial_data-1774"><a href="#COMPsc.get_partial_data-1774"><span class="linenos">1774</span></a><span class="sd">        features : list, str, or None</span>
</span><span id="COMPsc.get_partial_data-1775"><a href="#COMPsc.get_partial_data-1775"><span class="linenos">1775</span></a><span class="sd">            Names of features to include. If None, all features are considered.</span>
</span><span id="COMPsc.get_partial_data-1776"><a href="#COMPsc.get_partial_data-1776"><span class="linenos">1776</span></a>
</span><span id="COMPsc.get_partial_data-1777"><a href="#COMPsc.get_partial_data-1777"><span class="linenos">1777</span></a><span class="sd">        name_slot : str</span>
</span><span id="COMPsc.get_partial_data-1778"><a href="#COMPsc.get_partial_data-1778"><span class="linenos">1778</span></a><span class="sd">            Column in metadata to use as sample names.</span>
</span><span id="COMPsc.get_partial_data-1779"><a href="#COMPsc.get_partial_data-1779"><span class="linenos">1779</span></a>
</span><span id="COMPsc.get_partial_data-1780"><a href="#COMPsc.get_partial_data-1780"><span class="linenos">1780</span></a><span class="sd">        inc_metadata : bool</span>
</span><span id="COMPsc.get_partial_data-1781"><a href="#COMPsc.get_partial_data-1781"><span class="linenos">1781</span></a><span class="sd">            If True return tuple (data, metadata)</span>
</span><span id="COMPsc.get_partial_data-1782"><a href="#COMPsc.get_partial_data-1782"><span class="linenos">1782</span></a>
</span><span id="COMPsc.get_partial_data-1783"><a href="#COMPsc.get_partial_data-1783"><span class="linenos">1783</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc.get_partial_data-1784"><a href="#COMPsc.get_partial_data-1784"><span class="linenos">1784</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.get_partial_data-1785"><a href="#COMPsc.get_partial_data-1785"><span class="linenos">1785</span></a><span class="sd">        pandas.DataFrame</span>
</span><span id="COMPsc.get_partial_data-1786"><a href="#COMPsc.get_partial_data-1786"><span class="linenos">1786</span></a><span class="sd">            Subset of the normalized data based on the specified names and features.</span>
</span><span id="COMPsc.get_partial_data-1787"><a href="#COMPsc.get_partial_data-1787"><span class="linenos">1787</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.get_partial_data-1788"><a href="#COMPsc.get_partial_data-1788"><span class="linenos">1788</span></a>
</span><span id="COMPsc.get_partial_data-1789"><a href="#COMPsc.get_partial_data-1789"><span class="linenos">1789</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="COMPsc.get_partial_data-1790"><a href="#COMPsc.get_partial_data-1790"><span class="linenos">1790</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span>
</span><span id="COMPsc.get_partial_data-1791"><a href="#COMPsc.get_partial_data-1791"><span class="linenos">1791</span></a>
</span><span id="COMPsc.get_partial_data-1792"><a href="#COMPsc.get_partial_data-1792"><span class="linenos">1792</span></a>        <span class="k">if</span> <span class="n">name_slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="COMPsc.get_partial_data-1793"><a href="#COMPsc.get_partial_data-1793"><span class="linenos">1793</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.get_partial_data-1794"><a href="#COMPsc.get_partial_data-1794"><span class="linenos">1794</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.get_partial_data-1795"><a href="#COMPsc.get_partial_data-1795"><span class="linenos">1795</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;name_slot&#39; not occured in data!&#39;&quot;</span><span class="p">)</span>
</span><span id="COMPsc.get_partial_data-1796"><a href="#COMPsc.get_partial_data-1796"><span class="linenos">1796</span></a>
</span><span id="COMPsc.get_partial_data-1797"><a href="#COMPsc.get_partial_data-1797"><span class="linenos">1797</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="COMPsc.get_partial_data-1798"><a href="#COMPsc.get_partial_data-1798"><span class="linenos">1798</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">features</span><span class="p">]</span>
</span><span id="COMPsc.get_partial_data-1799"><a href="#COMPsc.get_partial_data-1799"><span class="linenos">1799</span></a>        <span class="k">elif</span> <span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.get_partial_data-1800"><a href="#COMPsc.get_partial_data-1800"><span class="linenos">1800</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc.get_partial_data-1801"><a href="#COMPsc.get_partial_data-1801"><span class="linenos">1801</span></a>
</span><span id="COMPsc.get_partial_data-1802"><a href="#COMPsc.get_partial_data-1802"><span class="linenos">1802</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="COMPsc.get_partial_data-1803"><a href="#COMPsc.get_partial_data-1803"><span class="linenos">1803</span></a>            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">names</span><span class="p">]</span>
</span><span id="COMPsc.get_partial_data-1804"><a href="#COMPsc.get_partial_data-1804"><span class="linenos">1804</span></a>        <span class="k">elif</span> <span class="n">names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.get_partial_data-1805"><a href="#COMPsc.get_partial_data-1805"><span class="linenos">1805</span></a>            <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc.get_partial_data-1806"><a href="#COMPsc.get_partial_data-1806"><span class="linenos">1806</span></a>
</span><span id="COMPsc.get_partial_data-1807"><a href="#COMPsc.get_partial_data-1807"><span class="linenos">1807</span></a>        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">features</span><span class="p">]</span>
</span><span id="COMPsc.get_partial_data-1808"><a href="#COMPsc.get_partial_data-1808"><span class="linenos">1808</span></a>        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
</span><span id="COMPsc.get_partial_data-1809"><a href="#COMPsc.get_partial_data-1809"><span class="linenos">1809</span></a>
</span><span id="COMPsc.get_partial_data-1810"><a href="#COMPsc.get_partial_data-1810"><span class="linenos">1810</span></a>        <span class="n">columns_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc.get_partial_data-1811"><a href="#COMPsc.get_partial_data-1811"><span class="linenos">1811</span></a>        <span class="n">features_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="COMPsc.get_partial_data-1812"><a href="#COMPsc.get_partial_data-1812"><span class="linenos">1812</span></a>
</span><span id="COMPsc.get_partial_data-1813"><a href="#COMPsc.get_partial_data-1813"><span class="linenos">1813</span></a>        <span class="n">columns_bool</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">columns_names</span><span class="p">]</span>
</span><span id="COMPsc.get_partial_data-1814"><a href="#COMPsc.get_partial_data-1814"><span class="linenos">1814</span></a>        <span class="n">features_bool</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">features</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">features_names</span><span class="p">]</span>
</span><span id="COMPsc.get_partial_data-1815"><a href="#COMPsc.get_partial_data-1815"><span class="linenos">1815</span></a>
</span><span id="COMPsc.get_partial_data-1816"><a href="#COMPsc.get_partial_data-1816"><span class="linenos">1816</span></a>        <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns_bool</span> <span class="ow">and</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">features_bool</span><span class="p">:</span>
</span><span id="COMPsc.get_partial_data-1817"><a href="#COMPsc.get_partial_data-1817"><span class="linenos">1817</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Missing &#39;names&#39; and/or &#39;features&#39;. Returning full dataset instead.&quot;</span><span class="p">)</span>
</span><span id="COMPsc.get_partial_data-1818"><a href="#COMPsc.get_partial_data-1818"><span class="linenos">1818</span></a>            <span class="k">if</span> <span class="n">inc_metadata</span><span class="p">:</span>
</span><span id="COMPsc.get_partial_data-1819"><a href="#COMPsc.get_partial_data-1819"><span class="linenos">1819</span></a>                <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span>
</span><span id="COMPsc.get_partial_data-1820"><a href="#COMPsc.get_partial_data-1820"><span class="linenos">1820</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.get_partial_data-1821"><a href="#COMPsc.get_partial_data-1821"><span class="linenos">1821</span></a>                <span class="k">return</span> <span class="n">data</span>
</span><span id="COMPsc.get_partial_data-1822"><a href="#COMPsc.get_partial_data-1822"><span class="linenos">1822</span></a>
</span><span id="COMPsc.get_partial_data-1823"><a href="#COMPsc.get_partial_data-1823"><span class="linenos">1823</span></a>        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">columns_bool</span><span class="p">:</span>
</span><span id="COMPsc.get_partial_data-1824"><a href="#COMPsc.get_partial_data-1824"><span class="linenos">1824</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">columns_bool</span><span class="p">]</span>
</span><span id="COMPsc.get_partial_data-1825"><a href="#COMPsc.get_partial_data-1825"><span class="linenos">1825</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">columns_bool</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="COMPsc.get_partial_data-1826"><a href="#COMPsc.get_partial_data-1826"><span class="linenos">1826</span></a>
</span><span id="COMPsc.get_partial_data-1827"><a href="#COMPsc.get_partial_data-1827"><span class="linenos">1827</span></a>            <span class="k">if</span> <span class="n">inc_metadata</span><span class="p">:</span>
</span><span id="COMPsc.get_partial_data-1828"><a href="#COMPsc.get_partial_data-1828"><span class="linenos">1828</span></a>                <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span>
</span><span id="COMPsc.get_partial_data-1829"><a href="#COMPsc.get_partial_data-1829"><span class="linenos">1829</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.get_partial_data-1830"><a href="#COMPsc.get_partial_data-1830"><span class="linenos">1830</span></a>                <span class="k">return</span> <span class="n">data</span>
</span><span id="COMPsc.get_partial_data-1831"><a href="#COMPsc.get_partial_data-1831"><span class="linenos">1831</span></a>
</span><span id="COMPsc.get_partial_data-1832"><a href="#COMPsc.get_partial_data-1832"><span class="linenos">1832</span></a>        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">features_bool</span><span class="p">:</span>
</span><span id="COMPsc.get_partial_data-1833"><a href="#COMPsc.get_partial_data-1833"><span class="linenos">1833</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">features_bool</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="COMPsc.get_partial_data-1834"><a href="#COMPsc.get_partial_data-1834"><span class="linenos">1834</span></a>
</span><span id="COMPsc.get_partial_data-1835"><a href="#COMPsc.get_partial_data-1835"><span class="linenos">1835</span></a>            <span class="k">if</span> <span class="n">inc_metadata</span><span class="p">:</span>
</span><span id="COMPsc.get_partial_data-1836"><a href="#COMPsc.get_partial_data-1836"><span class="linenos">1836</span></a>                <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span>
</span><span id="COMPsc.get_partial_data-1837"><a href="#COMPsc.get_partial_data-1837"><span class="linenos">1837</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.get_partial_data-1838"><a href="#COMPsc.get_partial_data-1838"><span class="linenos">1838</span></a>                <span class="k">return</span> <span class="n">data</span>
</span></pre></div>


            <div class="docstring"><p>Return a subset of the data filtered by sample names and/or feature names.</p>

<h2 id="parameters">Parameters</h2>

<p>names : list, str, or None
    Names of samples to include. If None, all samples are considered.</p>

<p>features : list, str, or None
    Names of features to include. If None, all features are considered.</p>

<p>name_slot : str
    Column in metadata to use as sample names.</p>

<p>inc_metadata : bool
    If True return tuple (data, metadata)</p>

<h2 id="returns">Returns</h2>

<p>pandas.DataFrame
    Subset of the normalized data based on the specified names and features.</p>
</div>


                            </div>
                            <div id="COMPsc.get_metadata" class="classattr">
                                        <input id="COMPsc.get_metadata-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_metadata</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.get_metadata-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.get_metadata"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.get_metadata-1840"><a href="#COMPsc.get_metadata-1840"><span class="linenos">1840</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="COMPsc.get_metadata-1841"><a href="#COMPsc.get_metadata-1841"><span class="linenos">1841</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.get_metadata-1842"><a href="#COMPsc.get_metadata-1842"><span class="linenos">1842</span></a><span class="sd">        Return the stored input metadata.</span>
</span><span id="COMPsc.get_metadata-1843"><a href="#COMPsc.get_metadata-1843"><span class="linenos">1843</span></a>
</span><span id="COMPsc.get_metadata-1844"><a href="#COMPsc.get_metadata-1844"><span class="linenos">1844</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc.get_metadata-1845"><a href="#COMPsc.get_metadata-1845"><span class="linenos">1845</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.get_metadata-1846"><a href="#COMPsc.get_metadata-1846"><span class="linenos">1846</span></a><span class="sd">        pandas.DataFrame</span>
</span><span id="COMPsc.get_metadata-1847"><a href="#COMPsc.get_metadata-1847"><span class="linenos">1847</span></a><span class="sd">            `self.input_metadata` (may be None if not set).</span>
</span><span id="COMPsc.get_metadata-1848"><a href="#COMPsc.get_metadata-1848"><span class="linenos">1848</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.get_metadata-1849"><a href="#COMPsc.get_metadata-1849"><span class="linenos">1849</span></a>
</span><span id="COMPsc.get_metadata-1850"><a href="#COMPsc.get_metadata-1850"><span class="linenos">1850</span></a>        <span class="n">to_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span>
</span><span id="COMPsc.get_metadata-1851"><a href="#COMPsc.get_metadata-1851"><span class="linenos">1851</span></a>
</span><span id="COMPsc.get_metadata-1852"><a href="#COMPsc.get_metadata-1852"><span class="linenos">1852</span></a>        <span class="k">return</span> <span class="n">to_return</span>
</span></pre></div>


            <div class="docstring"><p>Return the stored input metadata.</p>

<h2 id="returns">Returns</h2>

<p>pandas.DataFrame
    <code>self.input_metadata</code> (may be None if not set).</p>
</div>


                            </div>
                            <div id="COMPsc.gene_calculation" class="classattr">
                                        <input id="COMPsc.gene_calculation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">gene_calculation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.gene_calculation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.gene_calculation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.gene_calculation-1854"><a href="#COMPsc.gene_calculation-1854"><span class="linenos">1854</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gene_calculation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="COMPsc.gene_calculation-1855"><a href="#COMPsc.gene_calculation-1855"><span class="linenos">1855</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.gene_calculation-1856"><a href="#COMPsc.gene_calculation-1856"><span class="linenos">1856</span></a><span class="sd">        Calculate and store per-cell counts (e.g., number of detected genes).</span>
</span><span id="COMPsc.gene_calculation-1857"><a href="#COMPsc.gene_calculation-1857"><span class="linenos">1857</span></a>
</span><span id="COMPsc.gene_calculation-1858"><a href="#COMPsc.gene_calculation-1858"><span class="linenos">1858</span></a><span class="sd">        The method computes a binary (presence/absence) per cell and sums across</span>
</span><span id="COMPsc.gene_calculation-1859"><a href="#COMPsc.gene_calculation-1859"><span class="linenos">1859</span></a><span class="sd">        features to produce `self.gene_calc`.</span>
</span><span id="COMPsc.gene_calculation-1860"><a href="#COMPsc.gene_calculation-1860"><span class="linenos">1860</span></a>
</span><span id="COMPsc.gene_calculation-1861"><a href="#COMPsc.gene_calculation-1861"><span class="linenos">1861</span></a><span class="sd">        Update</span>
</span><span id="COMPsc.gene_calculation-1862"><a href="#COMPsc.gene_calculation-1862"><span class="linenos">1862</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.gene_calculation-1863"><a href="#COMPsc.gene_calculation-1863"><span class="linenos">1863</span></a><span class="sd">        Sets `self.gene_calc` as a pandas.Series.</span>
</span><span id="COMPsc.gene_calculation-1864"><a href="#COMPsc.gene_calculation-1864"><span class="linenos">1864</span></a>
</span><span id="COMPsc.gene_calculation-1865"><a href="#COMPsc.gene_calculation-1865"><span class="linenos">1865</span></a><span class="sd">        Side Effects</span>
</span><span id="COMPsc.gene_calculation-1866"><a href="#COMPsc.gene_calculation-1866"><span class="linenos">1866</span></a><span class="sd">        ------------</span>
</span><span id="COMPsc.gene_calculation-1867"><a href="#COMPsc.gene_calculation-1867"><span class="linenos">1867</span></a><span class="sd">        Uses `self.input_data` when available, otherwise `self.normalized_data`.</span>
</span><span id="COMPsc.gene_calculation-1868"><a href="#COMPsc.gene_calculation-1868"><span class="linenos">1868</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.gene_calculation-1869"><a href="#COMPsc.gene_calculation-1869"><span class="linenos">1869</span></a>
</span><span id="COMPsc.gene_calculation-1870"><a href="#COMPsc.gene_calculation-1870"><span class="linenos">1870</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.gene_calculation-1871"><a href="#COMPsc.gene_calculation-1871"><span class="linenos">1871</span></a>
</span><span id="COMPsc.gene_calculation-1872"><a href="#COMPsc.gene_calculation-1872"><span class="linenos">1872</span></a>            <span class="n">bin_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="COMPsc.gene_calculation-1873"><a href="#COMPsc.gene_calculation-1873"><span class="linenos">1873</span></a>
</span><span id="COMPsc.gene_calculation-1874"><a href="#COMPsc.gene_calculation-1874"><span class="linenos">1874</span></a>            <span class="n">bin_col</span> <span class="o">=</span> <span class="n">bin_col</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bin_col</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc.gene_calculation-1875"><a href="#COMPsc.gene_calculation-1875"><span class="linenos">1875</span></a>
</span><span id="COMPsc.gene_calculation-1876"><a href="#COMPsc.gene_calculation-1876"><span class="linenos">1876</span></a>            <span class="n">sum_data</span> <span class="o">=</span> <span class="n">bin_col</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="COMPsc.gene_calculation-1877"><a href="#COMPsc.gene_calculation-1877"><span class="linenos">1877</span></a>
</span><span id="COMPsc.gene_calculation-1878"><a href="#COMPsc.gene_calculation-1878"><span class="linenos">1878</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">=</span> <span class="n">sum_data</span>
</span><span id="COMPsc.gene_calculation-1879"><a href="#COMPsc.gene_calculation-1879"><span class="linenos">1879</span></a>
</span><span id="COMPsc.gene_calculation-1880"><a href="#COMPsc.gene_calculation-1880"><span class="linenos">1880</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.gene_calculation-1881"><a href="#COMPsc.gene_calculation-1881"><span class="linenos">1881</span></a>
</span><span id="COMPsc.gene_calculation-1882"><a href="#COMPsc.gene_calculation-1882"><span class="linenos">1882</span></a>            <span class="n">bin_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="COMPsc.gene_calculation-1883"><a href="#COMPsc.gene_calculation-1883"><span class="linenos">1883</span></a>
</span><span id="COMPsc.gene_calculation-1884"><a href="#COMPsc.gene_calculation-1884"><span class="linenos">1884</span></a>            <span class="n">bin_col</span> <span class="o">=</span> <span class="n">bin_col</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bin_col</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc.gene_calculation-1885"><a href="#COMPsc.gene_calculation-1885"><span class="linenos">1885</span></a>
</span><span id="COMPsc.gene_calculation-1886"><a href="#COMPsc.gene_calculation-1886"><span class="linenos">1886</span></a>            <span class="n">sum_data</span> <span class="o">=</span> <span class="n">bin_col</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="COMPsc.gene_calculation-1887"><a href="#COMPsc.gene_calculation-1887"><span class="linenos">1887</span></a>
</span><span id="COMPsc.gene_calculation-1888"><a href="#COMPsc.gene_calculation-1888"><span class="linenos">1888</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">=</span> <span class="n">sum_data</span>
</span></pre></div>


            <div class="docstring"><p>Calculate and store per-cell counts (e.g., number of detected genes).</p>

<p>The method computes a binary (presence/absence) per cell and sums across
features to produce <code>self.gene_calc</code>.</p>

<h2 id="update">Update</h2>

<p>Sets <code>self.gene_calc</code> as a pandas.Series.</p>

<h2 id="side-effects">Side Effects</h2>

<p>Uses <code>self.input_data</code> when available, otherwise <code>self.normalized_data</code>.</p>
</div>


                            </div>
                            <div id="COMPsc.gene_histograme" class="classattr">
                                        <input id="COMPsc.gene_histograme-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">gene_histograme</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">bins</span><span class="o">=</span><span class="mi">100</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.gene_histograme-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.gene_histograme"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.gene_histograme-1890"><a href="#COMPsc.gene_histograme-1890"><span class="linenos">1890</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gene_histograme</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="COMPsc.gene_histograme-1891"><a href="#COMPsc.gene_histograme-1891"><span class="linenos">1891</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.gene_histograme-1892"><a href="#COMPsc.gene_histograme-1892"><span class="linenos">1892</span></a><span class="sd">        Plot a histogram of the number of genes detected per cell.</span>
</span><span id="COMPsc.gene_histograme-1893"><a href="#COMPsc.gene_histograme-1893"><span class="linenos">1893</span></a>
</span><span id="COMPsc.gene_histograme-1894"><a href="#COMPsc.gene_histograme-1894"><span class="linenos">1894</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.gene_histograme-1895"><a href="#COMPsc.gene_histograme-1895"><span class="linenos">1895</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.gene_histograme-1896"><a href="#COMPsc.gene_histograme-1896"><span class="linenos">1896</span></a><span class="sd">        bins : int, default 100</span>
</span><span id="COMPsc.gene_histograme-1897"><a href="#COMPsc.gene_histograme-1897"><span class="linenos">1897</span></a><span class="sd">            Number of histogram bins.</span>
</span><span id="COMPsc.gene_histograme-1898"><a href="#COMPsc.gene_histograme-1898"><span class="linenos">1898</span></a>
</span><span id="COMPsc.gene_histograme-1899"><a href="#COMPsc.gene_histograme-1899"><span class="linenos">1899</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc.gene_histograme-1900"><a href="#COMPsc.gene_histograme-1900"><span class="linenos">1900</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.gene_histograme-1901"><a href="#COMPsc.gene_histograme-1901"><span class="linenos">1901</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc.gene_histograme-1902"><a href="#COMPsc.gene_histograme-1902"><span class="linenos">1902</span></a><span class="sd">            Figure containing the histogram of gene contents.</span>
</span><span id="COMPsc.gene_histograme-1903"><a href="#COMPsc.gene_histograme-1903"><span class="linenos">1903</span></a>
</span><span id="COMPsc.gene_histograme-1904"><a href="#COMPsc.gene_histograme-1904"><span class="linenos">1904</span></a><span class="sd">        Notes</span>
</span><span id="COMPsc.gene_histograme-1905"><a href="#COMPsc.gene_histograme-1905"><span class="linenos">1905</span></a><span class="sd">        -----</span>
</span><span id="COMPsc.gene_histograme-1906"><a href="#COMPsc.gene_histograme-1906"><span class="linenos">1906</span></a><span class="sd">        Requires `self.gene_calc` to be computed prior to calling.</span>
</span><span id="COMPsc.gene_histograme-1907"><a href="#COMPsc.gene_histograme-1907"><span class="linenos">1907</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.gene_histograme-1908"><a href="#COMPsc.gene_histograme-1908"><span class="linenos">1908</span></a>
</span><span id="COMPsc.gene_histograme-1909"><a href="#COMPsc.gene_histograme-1909"><span class="linenos">1909</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="COMPsc.gene_histograme-1910"><a href="#COMPsc.gene_histograme-1910"><span class="linenos">1910</span></a>
</span><span id="COMPsc.gene_histograme-1911"><a href="#COMPsc.gene_histograme-1911"><span class="linenos">1911</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
</span><span id="COMPsc.gene_histograme-1912"><a href="#COMPsc.gene_histograme-1912"><span class="linenos">1912</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span>
</span><span id="COMPsc.gene_histograme-1913"><a href="#COMPsc.gene_histograme-1913"><span class="linenos">1913</span></a>        <span class="p">)</span>
</span><span id="COMPsc.gene_histograme-1914"><a href="#COMPsc.gene_histograme-1914"><span class="linenos">1914</span></a>
</span><span id="COMPsc.gene_histograme-1915"><a href="#COMPsc.gene_histograme-1915"><span class="linenos">1915</span></a>        <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">)</span>
</span><span id="COMPsc.gene_histograme-1916"><a href="#COMPsc.gene_histograme-1916"><span class="linenos">1916</span></a>
</span><span id="COMPsc.gene_histograme-1917"><a href="#COMPsc.gene_histograme-1917"><span class="linenos">1917</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="COMPsc.gene_histograme-1918"><a href="#COMPsc.gene_histograme-1918"><span class="linenos">1918</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="COMPsc.gene_histograme-1919"><a href="#COMPsc.gene_histograme-1919"><span class="linenos">1919</span></a>
</span><span id="COMPsc.gene_histograme-1920"><a href="#COMPsc.gene_histograme-1920"><span class="linenos">1920</span></a>        <span class="n">y_scaled</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="COMPsc.gene_histograme-1921"><a href="#COMPsc.gene_histograme-1921"><span class="linenos">1921</span></a>
</span><span id="COMPsc.gene_histograme-1922"><a href="#COMPsc.gene_histograme-1922"><span class="linenos">1922</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="COMPsc.gene_histograme-1923"><a href="#COMPsc.gene_histograme-1923"><span class="linenos">1923</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y_scaled</span><span class="p">,</span> <span class="s2">&quot;r-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Normal(μ=</span><span class="si">{</span><span class="n">mu</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, σ=</span><span class="si">{</span><span class="n">sigma</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="COMPsc.gene_histograme-1924"><a href="#COMPsc.gene_histograme-1924"><span class="linenos">1924</span></a>        <span class="p">)</span>
</span><span id="COMPsc.gene_histograme-1925"><a href="#COMPsc.gene_histograme-1925"><span class="linenos">1925</span></a>
</span><span id="COMPsc.gene_histograme-1926"><a href="#COMPsc.gene_histograme-1926"><span class="linenos">1926</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>
</span><span id="COMPsc.gene_histograme-1927"><a href="#COMPsc.gene_histograme-1927"><span class="linenos">1927</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
</span><span id="COMPsc.gene_histograme-1928"><a href="#COMPsc.gene_histograme-1928"><span class="linenos">1928</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Histogram of genes detected per cell&quot;</span><span class="p">)</span>
</span><span id="COMPsc.gene_histograme-1929"><a href="#COMPsc.gene_histograme-1929"><span class="linenos">1929</span></a>
</span><span id="COMPsc.gene_histograme-1930"><a href="#COMPsc.gene_histograme-1930"><span class="linenos">1930</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span><span class="p">),</span> <span class="mi">20</span><span class="p">))</span>
</span><span id="COMPsc.gene_histograme-1931"><a href="#COMPsc.gene_histograme-1931"><span class="linenos">1931</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
</span><span id="COMPsc.gene_histograme-1932"><a href="#COMPsc.gene_histograme-1932"><span class="linenos">1932</span></a>
</span><span id="COMPsc.gene_histograme-1933"><a href="#COMPsc.gene_histograme-1933"><span class="linenos">1933</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="COMPsc.gene_histograme-1934"><a href="#COMPsc.gene_histograme-1934"><span class="linenos">1934</span></a>
</span><span id="COMPsc.gene_histograme-1935"><a href="#COMPsc.gene_histograme-1935"><span class="linenos">1935</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span></pre></div>


            <div class="docstring"><p>Plot a histogram of the number of genes detected per cell.</p>

<h2 id="parameters">Parameters</h2>

<p>bins : int, default 100
    Number of histogram bins.</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.figure.Figure
    Figure containing the histogram of gene contents.</p>

<h2 id="notes">Notes</h2>

<p>Requires <code>self.gene_calc</code> to be computed prior to calling.</p>
</div>


                            </div>
                            <div id="COMPsc.gene_threshold" class="classattr">
                                        <input id="COMPsc.gene_threshold-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">gene_threshold</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">min_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span>, </span><span class="param"><span class="n">max_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.gene_threshold-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.gene_threshold"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.gene_threshold-1937"><a href="#COMPsc.gene_threshold-1937"><span class="linenos">1937</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gene_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">max_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="COMPsc.gene_threshold-1938"><a href="#COMPsc.gene_threshold-1938"><span class="linenos">1938</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.gene_threshold-1939"><a href="#COMPsc.gene_threshold-1939"><span class="linenos">1939</span></a><span class="sd">        Filter cells by gene-detection thresholds (min and/or max).</span>
</span><span id="COMPsc.gene_threshold-1940"><a href="#COMPsc.gene_threshold-1940"><span class="linenos">1940</span></a>
</span><span id="COMPsc.gene_threshold-1941"><a href="#COMPsc.gene_threshold-1941"><span class="linenos">1941</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.gene_threshold-1942"><a href="#COMPsc.gene_threshold-1942"><span class="linenos">1942</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.gene_threshold-1943"><a href="#COMPsc.gene_threshold-1943"><span class="linenos">1943</span></a><span class="sd">        min_n : int or None</span>
</span><span id="COMPsc.gene_threshold-1944"><a href="#COMPsc.gene_threshold-1944"><span class="linenos">1944</span></a><span class="sd">            Minimum number of detected genes required to keep a cell.</span>
</span><span id="COMPsc.gene_threshold-1945"><a href="#COMPsc.gene_threshold-1945"><span class="linenos">1945</span></a>
</span><span id="COMPsc.gene_threshold-1946"><a href="#COMPsc.gene_threshold-1946"><span class="linenos">1946</span></a><span class="sd">        max_n : int or None</span>
</span><span id="COMPsc.gene_threshold-1947"><a href="#COMPsc.gene_threshold-1947"><span class="linenos">1947</span></a><span class="sd">            Maximum number of detected genes allowed to keep a cell.</span>
</span><span id="COMPsc.gene_threshold-1948"><a href="#COMPsc.gene_threshold-1948"><span class="linenos">1948</span></a>
</span><span id="COMPsc.gene_threshold-1949"><a href="#COMPsc.gene_threshold-1949"><span class="linenos">1949</span></a><span class="sd">        Update</span>
</span><span id="COMPsc.gene_threshold-1950"><a href="#COMPsc.gene_threshold-1950"><span class="linenos">1950</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.gene_threshold-1951"><a href="#COMPsc.gene_threshold-1951"><span class="linenos">1951</span></a><span class="sd">        Filters `self.input_data`, `self.normalized_data`, `self.input_metadata`</span>
</span><span id="COMPsc.gene_threshold-1952"><a href="#COMPsc.gene_threshold-1952"><span class="linenos">1952</span></a><span class="sd">        (and calls `average()` if `self.agg_normalized_data` exists).</span>
</span><span id="COMPsc.gene_threshold-1953"><a href="#COMPsc.gene_threshold-1953"><span class="linenos">1953</span></a>
</span><span id="COMPsc.gene_threshold-1954"><a href="#COMPsc.gene_threshold-1954"><span class="linenos">1954</span></a><span class="sd">        Side Effects</span>
</span><span id="COMPsc.gene_threshold-1955"><a href="#COMPsc.gene_threshold-1955"><span class="linenos">1955</span></a><span class="sd">        ------------</span>
</span><span id="COMPsc.gene_threshold-1956"><a href="#COMPsc.gene_threshold-1956"><span class="linenos">1956</span></a><span class="sd">        Raises ValueError if both bounds are None or if filtering removes all cells.</span>
</span><span id="COMPsc.gene_threshold-1957"><a href="#COMPsc.gene_threshold-1957"><span class="linenos">1957</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.gene_threshold-1958"><a href="#COMPsc.gene_threshold-1958"><span class="linenos">1958</span></a>
</span><span id="COMPsc.gene_threshold-1959"><a href="#COMPsc.gene_threshold-1959"><span class="linenos">1959</span></a>        <span class="k">if</span> <span class="n">min_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.gene_threshold-1960"><a href="#COMPsc.gene_threshold-1960"><span class="linenos">1960</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">&gt;</span> <span class="n">min_n</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">&lt;</span> <span class="n">max_n</span><span class="p">)</span>
</span><span id="COMPsc.gene_threshold-1961"><a href="#COMPsc.gene_threshold-1961"><span class="linenos">1961</span></a>        <span class="k">elif</span> <span class="n">min_n</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.gene_threshold-1962"><a href="#COMPsc.gene_threshold-1962"><span class="linenos">1962</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">&lt;</span> <span class="n">max_n</span>
</span><span id="COMPsc.gene_threshold-1963"><a href="#COMPsc.gene_threshold-1963"><span class="linenos">1963</span></a>        <span class="k">elif</span> <span class="n">min_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.gene_threshold-1964"><a href="#COMPsc.gene_threshold-1964"><span class="linenos">1964</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_calc</span> <span class="o">&gt;</span> <span class="n">min_n</span>
</span><span id="COMPsc.gene_threshold-1965"><a href="#COMPsc.gene_threshold-1965"><span class="linenos">1965</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.gene_threshold-1966"><a href="#COMPsc.gene_threshold-1966"><span class="linenos">1966</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lack of both min_n and max_n values&quot;</span><span class="p">)</span>
</span><span id="COMPsc.gene_threshold-1967"><a href="#COMPsc.gene_threshold-1967"><span class="linenos">1967</span></a>
</span><span id="COMPsc.gene_threshold-1968"><a href="#COMPsc.gene_threshold-1968"><span class="linenos">1968</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.gene_threshold-1969"><a href="#COMPsc.gene_threshold-1969"><span class="linenos">1969</span></a>
</span><span id="COMPsc.gene_threshold-1970"><a href="#COMPsc.gene_threshold-1970"><span class="linenos">1970</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.gene_threshold-1971"><a href="#COMPsc.gene_threshold-1971"><span class="linenos">1971</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc.gene_threshold-1972"><a href="#COMPsc.gene_threshold-1972"><span class="linenos">1972</span></a>
</span><span id="COMPsc.gene_threshold-1973"><a href="#COMPsc.gene_threshold-1973"><span class="linenos">1973</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
</span><span id="COMPsc.gene_threshold-1974"><a href="#COMPsc.gene_threshold-1974"><span class="linenos">1974</span></a>
</span><span id="COMPsc.gene_threshold-1975"><a href="#COMPsc.gene_threshold-1975"><span class="linenos">1975</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.gene_threshold-1976"><a href="#COMPsc.gene_threshold-1976"><span class="linenos">1976</span></a>
</span><span id="COMPsc.gene_threshold-1977"><a href="#COMPsc.gene_threshold-1977"><span class="linenos">1977</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.gene_threshold-1978"><a href="#COMPsc.gene_threshold-1978"><span class="linenos">1978</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc.gene_threshold-1979"><a href="#COMPsc.gene_threshold-1979"><span class="linenos">1979</span></a>
</span><span id="COMPsc.gene_threshold-1980"><a href="#COMPsc.gene_threshold-1980"><span class="linenos">1980</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
</span><span id="COMPsc.gene_threshold-1981"><a href="#COMPsc.gene_threshold-1981"><span class="linenos">1981</span></a>
</span><span id="COMPsc.gene_threshold-1982"><a href="#COMPsc.gene_threshold-1982"><span class="linenos">1982</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.gene_threshold-1983"><a href="#COMPsc.gene_threshold-1983"><span class="linenos">1983</span></a>
</span><span id="COMPsc.gene_threshold-1984"><a href="#COMPsc.gene_threshold-1984"><span class="linenos">1984</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.gene_threshold-1985"><a href="#COMPsc.gene_threshold-1985"><span class="linenos">1985</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nothing to reduce&quot;</span><span class="p">)</span>
</span><span id="COMPsc.gene_threshold-1986"><a href="#COMPsc.gene_threshold-1986"><span class="linenos">1986</span></a>
</span><span id="COMPsc.gene_threshold-1987"><a href="#COMPsc.gene_threshold-1987"><span class="linenos">1987</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="COMPsc.gene_threshold-1988"><a href="#COMPsc.gene_threshold-1988"><span class="linenos">1988</span></a>                <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="COMPsc.gene_threshold-1989"><a href="#COMPsc.gene_threshold-1989"><span class="linenos">1989</span></a>            <span class="p">)</span>
</span><span id="COMPsc.gene_threshold-1990"><a href="#COMPsc.gene_threshold-1990"><span class="linenos">1990</span></a>
</span><span id="COMPsc.gene_threshold-1991"><a href="#COMPsc.gene_threshold-1991"><span class="linenos">1991</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="COMPsc.gene_threshold-1992"><a href="#COMPsc.gene_threshold-1992"><span class="linenos">1992</span></a>                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="COMPsc.gene_threshold-1993"><a href="#COMPsc.gene_threshold-1993"><span class="linenos">1993</span></a>            <span class="p">)</span>
</span><span id="COMPsc.gene_threshold-1994"><a href="#COMPsc.gene_threshold-1994"><span class="linenos">1994</span></a>
</span><span id="COMPsc.gene_threshold-1995"><a href="#COMPsc.gene_threshold-1995"><span class="linenos">1995</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.gene_threshold-1996"><a href="#COMPsc.gene_threshold-1996"><span class="linenos">1996</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
</span><span id="COMPsc.gene_threshold-1997"><a href="#COMPsc.gene_threshold-1997"><span class="linenos">1997</span></a>
</span><span id="COMPsc.gene_threshold-1998"><a href="#COMPsc.gene_threshold-1998"><span class="linenos">1998</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_calculation</span><span class="p">()</span>
</span><span id="COMPsc.gene_threshold-1999"><a href="#COMPsc.gene_threshold-1999"><span class="linenos">1999</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Filter cells by gene-detection thresholds (min and/or max).</p>

<h2 id="parameters">Parameters</h2>

<p>min_n : int or None
    Minimum number of detected genes required to keep a cell.</p>

<p>max_n : int or None
    Maximum number of detected genes allowed to keep a cell.</p>

<h2 id="update">Update</h2>

<p>Filters <code>self.input_data</code>, <code>self.normalized_data</code>, <code>self.input_metadata</code>
(and calls <code><a href="#COMPsc.average">average()</a></code> if <code>self.agg_normalized_data</code> exists).</p>

<h2 id="side-effects">Side Effects</h2>

<p>Raises ValueError if both bounds are None or if filtering removes all cells.</p>
</div>


                            </div>
                            <div id="COMPsc.cells_calculation" class="classattr">
                                        <input id="COMPsc.cells_calculation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cells_calculation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name_slot</span><span class="o">=</span><span class="s1">&#39;cell_names&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.cells_calculation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.cells_calculation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.cells_calculation-2001"><a href="#COMPsc.cells_calculation-2001"><span class="linenos">2001</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cells_calculation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_slot</span><span class="o">=</span><span class="s2">&quot;cell_names&quot;</span><span class="p">):</span>
</span><span id="COMPsc.cells_calculation-2002"><a href="#COMPsc.cells_calculation-2002"><span class="linenos">2002</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.cells_calculation-2003"><a href="#COMPsc.cells_calculation-2003"><span class="linenos">2003</span></a><span class="sd">        Calculate number of cells per  call name / cluster.</span>
</span><span id="COMPsc.cells_calculation-2004"><a href="#COMPsc.cells_calculation-2004"><span class="linenos">2004</span></a>
</span><span id="COMPsc.cells_calculation-2005"><a href="#COMPsc.cells_calculation-2005"><span class="linenos">2005</span></a><span class="sd">        The method computes a binary (presence/absence) per cell name / cluster and sums across</span>
</span><span id="COMPsc.cells_calculation-2006"><a href="#COMPsc.cells_calculation-2006"><span class="linenos">2006</span></a><span class="sd">        cells.</span>
</span><span id="COMPsc.cells_calculation-2007"><a href="#COMPsc.cells_calculation-2007"><span class="linenos">2007</span></a>
</span><span id="COMPsc.cells_calculation-2008"><a href="#COMPsc.cells_calculation-2008"><span class="linenos">2008</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.cells_calculation-2009"><a href="#COMPsc.cells_calculation-2009"><span class="linenos">2009</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.cells_calculation-2010"><a href="#COMPsc.cells_calculation-2010"><span class="linenos">2010</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="COMPsc.cells_calculation-2011"><a href="#COMPsc.cells_calculation-2011"><span class="linenos">2011</span></a><span class="sd">            Column in metadata to use as sample names.</span>
</span><span id="COMPsc.cells_calculation-2012"><a href="#COMPsc.cells_calculation-2012"><span class="linenos">2012</span></a>
</span><span id="COMPsc.cells_calculation-2013"><a href="#COMPsc.cells_calculation-2013"><span class="linenos">2013</span></a><span class="sd">        Update</span>
</span><span id="COMPsc.cells_calculation-2014"><a href="#COMPsc.cells_calculation-2014"><span class="linenos">2014</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.cells_calculation-2015"><a href="#COMPsc.cells_calculation-2015"><span class="linenos">2015</span></a><span class="sd">        Sets `self.cells_calc` as a pd.DataFrame.</span>
</span><span id="COMPsc.cells_calculation-2016"><a href="#COMPsc.cells_calculation-2016"><span class="linenos">2016</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.cells_calculation-2017"><a href="#COMPsc.cells_calculation-2017"><span class="linenos">2017</span></a>
</span><span id="COMPsc.cells_calculation-2018"><a href="#COMPsc.cells_calculation-2018"><span class="linenos">2018</span></a>        <span class="n">ls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">])</span>
</span><span id="COMPsc.cells_calculation-2019"><a href="#COMPsc.cells_calculation-2019"><span class="linenos">2019</span></a>
</span><span id="COMPsc.cells_calculation-2020"><a href="#COMPsc.cells_calculation-2020"><span class="linenos">2020</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="COMPsc.cells_calculation-2021"><a href="#COMPsc.cells_calculation-2021"><span class="linenos">2021</span></a>            <span class="p">{</span>
</span><span id="COMPsc.cells_calculation-2022"><a href="#COMPsc.cells_calculation-2022"><span class="linenos">2022</span></a>                <span class="s2">&quot;cluster&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
</span><span id="COMPsc.cells_calculation-2023"><a href="#COMPsc.cells_calculation-2023"><span class="linenos">2023</span></a>                <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
</span><span id="COMPsc.cells_calculation-2024"><a href="#COMPsc.cells_calculation-2024"><span class="linenos">2024</span></a>            <span class="p">}</span>
</span><span id="COMPsc.cells_calculation-2025"><a href="#COMPsc.cells_calculation-2025"><span class="linenos">2025</span></a>        <span class="p">)</span>
</span><span id="COMPsc.cells_calculation-2026"><a href="#COMPsc.cells_calculation-2026"><span class="linenos">2026</span></a>
</span><span id="COMPsc.cells_calculation-2027"><a href="#COMPsc.cells_calculation-2027"><span class="linenos">2027</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span> <span class="o">=</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Calculate number of cells per  call name / cluster.</p>

<p>The method computes a binary (presence/absence) per cell name / cluster and sums across
cells.</p>

<h2 id="parameters">Parameters</h2>

<p>name_slot : str, default 'cell_names'
    Column in metadata to use as sample names.</p>

<h2 id="update">Update</h2>

<p>Sets <code>self.cells_calc</code> as a pd.DataFrame.</p>
</div>


                            </div>
                            <div id="COMPsc.cell_histograme" class="classattr">
                                        <input id="COMPsc.cell_histograme-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cell_histograme</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cell_names&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.cell_histograme-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.cell_histograme"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.cell_histograme-2029"><a href="#COMPsc.cell_histograme-2029"><span class="linenos">2029</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cell_histograme</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">):</span>
</span><span id="COMPsc.cell_histograme-2030"><a href="#COMPsc.cell_histograme-2030"><span class="linenos">2030</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.cell_histograme-2031"><a href="#COMPsc.cell_histograme-2031"><span class="linenos">2031</span></a><span class="sd">        Plot a histogram of the number of cells detected per cell name (cluster).</span>
</span><span id="COMPsc.cell_histograme-2032"><a href="#COMPsc.cell_histograme-2032"><span class="linenos">2032</span></a>
</span><span id="COMPsc.cell_histograme-2033"><a href="#COMPsc.cell_histograme-2033"><span class="linenos">2033</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.cell_histograme-2034"><a href="#COMPsc.cell_histograme-2034"><span class="linenos">2034</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.cell_histograme-2035"><a href="#COMPsc.cell_histograme-2035"><span class="linenos">2035</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="COMPsc.cell_histograme-2036"><a href="#COMPsc.cell_histograme-2036"><span class="linenos">2036</span></a><span class="sd">            Column in metadata to use as sample names.</span>
</span><span id="COMPsc.cell_histograme-2037"><a href="#COMPsc.cell_histograme-2037"><span class="linenos">2037</span></a>
</span><span id="COMPsc.cell_histograme-2038"><a href="#COMPsc.cell_histograme-2038"><span class="linenos">2038</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc.cell_histograme-2039"><a href="#COMPsc.cell_histograme-2039"><span class="linenos">2039</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.cell_histograme-2040"><a href="#COMPsc.cell_histograme-2040"><span class="linenos">2040</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc.cell_histograme-2041"><a href="#COMPsc.cell_histograme-2041"><span class="linenos">2041</span></a><span class="sd">            Figure containing the histogram of cell contents.</span>
</span><span id="COMPsc.cell_histograme-2042"><a href="#COMPsc.cell_histograme-2042"><span class="linenos">2042</span></a>
</span><span id="COMPsc.cell_histograme-2043"><a href="#COMPsc.cell_histograme-2043"><span class="linenos">2043</span></a><span class="sd">        Notes</span>
</span><span id="COMPsc.cell_histograme-2044"><a href="#COMPsc.cell_histograme-2044"><span class="linenos">2044</span></a><span class="sd">        -----</span>
</span><span id="COMPsc.cell_histograme-2045"><a href="#COMPsc.cell_histograme-2045"><span class="linenos">2045</span></a><span class="sd">        Requires `self.cells_calc` to be computed prior to calling.</span>
</span><span id="COMPsc.cell_histograme-2046"><a href="#COMPsc.cell_histograme-2046"><span class="linenos">2046</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.cell_histograme-2047"><a href="#COMPsc.cell_histograme-2047"><span class="linenos">2047</span></a>
</span><span id="COMPsc.cell_histograme-2048"><a href="#COMPsc.cell_histograme-2048"><span class="linenos">2048</span></a>        <span class="k">if</span> <span class="n">name_slot</span> <span class="o">!=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">:</span>
</span><span id="COMPsc.cell_histograme-2049"><a href="#COMPsc.cell_histograme-2049"><span class="linenos">2049</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">(</span><span class="n">name_slot</span><span class="o">=</span><span class="n">name_slot</span><span class="p">)</span>
</span><span id="COMPsc.cell_histograme-2050"><a href="#COMPsc.cell_histograme-2050"><span class="linenos">2050</span></a>
</span><span id="COMPsc.cell_histograme-2051"><a href="#COMPsc.cell_histograme-2051"><span class="linenos">2051</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="COMPsc.cell_histograme-2052"><a href="#COMPsc.cell_histograme-2052"><span class="linenos">2052</span></a>
</span><span id="COMPsc.cell_histograme-2053"><a href="#COMPsc.cell_histograme-2053"><span class="linenos">2053</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
</span><span id="COMPsc.cell_histograme-2054"><a href="#COMPsc.cell_histograme-2054"><span class="linenos">2054</span></a>            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]),</span>
</span><span id="COMPsc.cell_histograme-2055"><a href="#COMPsc.cell_histograme-2055"><span class="linenos">2055</span></a>            <span class="n">bins</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">])),</span>
</span><span id="COMPsc.cell_histograme-2056"><a href="#COMPsc.cell_histograme-2056"><span class="linenos">2056</span></a>            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="COMPsc.cell_histograme-2057"><a href="#COMPsc.cell_histograme-2057"><span class="linenos">2057</span></a>            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
</span><span id="COMPsc.cell_histograme-2058"><a href="#COMPsc.cell_histograme-2058"><span class="linenos">2058</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
</span><span id="COMPsc.cell_histograme-2059"><a href="#COMPsc.cell_histograme-2059"><span class="linenos">2059</span></a>        <span class="p">)</span>
</span><span id="COMPsc.cell_histograme-2060"><a href="#COMPsc.cell_histograme-2060"><span class="linenos">2060</span></a>
</span><span id="COMPsc.cell_histograme-2061"><a href="#COMPsc.cell_histograme-2061"><span class="linenos">2061</span></a>        <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
</span><span id="COMPsc.cell_histograme-2062"><a href="#COMPsc.cell_histograme-2062"><span class="linenos">2062</span></a>            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])</span>
</span><span id="COMPsc.cell_histograme-2063"><a href="#COMPsc.cell_histograme-2063"><span class="linenos">2063</span></a>        <span class="p">)</span>
</span><span id="COMPsc.cell_histograme-2064"><a href="#COMPsc.cell_histograme-2064"><span class="linenos">2064</span></a>
</span><span id="COMPsc.cell_histograme-2065"><a href="#COMPsc.cell_histograme-2065"><span class="linenos">2065</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
</span><span id="COMPsc.cell_histograme-2066"><a href="#COMPsc.cell_histograme-2066"><span class="linenos">2066</span></a>            <span class="nb">min</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])),</span> <span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])),</span> <span class="mi">1000</span>
</span><span id="COMPsc.cell_histograme-2067"><a href="#COMPsc.cell_histograme-2067"><span class="linenos">2067</span></a>        <span class="p">)</span>
</span><span id="COMPsc.cell_histograme-2068"><a href="#COMPsc.cell_histograme-2068"><span class="linenos">2068</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="COMPsc.cell_histograme-2069"><a href="#COMPsc.cell_histograme-2069"><span class="linenos">2069</span></a>
</span><span id="COMPsc.cell_histograme-2070"><a href="#COMPsc.cell_histograme-2070"><span class="linenos">2070</span></a>        <span class="n">y_scaled</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]))</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="COMPsc.cell_histograme-2071"><a href="#COMPsc.cell_histograme-2071"><span class="linenos">2071</span></a>
</span><span id="COMPsc.cell_histograme-2072"><a href="#COMPsc.cell_histograme-2072"><span class="linenos">2072</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="COMPsc.cell_histograme-2073"><a href="#COMPsc.cell_histograme-2073"><span class="linenos">2073</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y_scaled</span><span class="p">,</span> <span class="s2">&quot;r-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Normal(μ=</span><span class="si">{</span><span class="n">mu</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, σ=</span><span class="si">{</span><span class="n">sigma</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="COMPsc.cell_histograme-2074"><a href="#COMPsc.cell_histograme-2074"><span class="linenos">2074</span></a>        <span class="p">)</span>
</span><span id="COMPsc.cell_histograme-2075"><a href="#COMPsc.cell_histograme-2075"><span class="linenos">2075</span></a>
</span><span id="COMPsc.cell_histograme-2076"><a href="#COMPsc.cell_histograme-2076"><span class="linenos">2076</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>
</span><span id="COMPsc.cell_histograme-2077"><a href="#COMPsc.cell_histograme-2077"><span class="linenos">2077</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
</span><span id="COMPsc.cell_histograme-2078"><a href="#COMPsc.cell_histograme-2078"><span class="linenos">2078</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Histogram of cells detected per cell name / cluster&quot;</span><span class="p">)</span>
</span><span id="COMPsc.cell_histograme-2079"><a href="#COMPsc.cell_histograme-2079"><span class="linenos">2079</span></a>
</span><span id="COMPsc.cell_histograme-2080"><a href="#COMPsc.cell_histograme-2080"><span class="linenos">2080</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span>
</span><span id="COMPsc.cell_histograme-2081"><a href="#COMPsc.cell_histograme-2081"><span class="linenos">2081</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
</span><span id="COMPsc.cell_histograme-2082"><a href="#COMPsc.cell_histograme-2082"><span class="linenos">2082</span></a>                <span class="nb">min</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])),</span> <span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])),</span> <span class="mi">20</span>
</span><span id="COMPsc.cell_histograme-2083"><a href="#COMPsc.cell_histograme-2083"><span class="linenos">2083</span></a>            <span class="p">)</span>
</span><span id="COMPsc.cell_histograme-2084"><a href="#COMPsc.cell_histograme-2084"><span class="linenos">2084</span></a>        <span class="p">)</span>
</span><span id="COMPsc.cell_histograme-2085"><a href="#COMPsc.cell_histograme-2085"><span class="linenos">2085</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
</span><span id="COMPsc.cell_histograme-2086"><a href="#COMPsc.cell_histograme-2086"><span class="linenos">2086</span></a>
</span><span id="COMPsc.cell_histograme-2087"><a href="#COMPsc.cell_histograme-2087"><span class="linenos">2087</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="COMPsc.cell_histograme-2088"><a href="#COMPsc.cell_histograme-2088"><span class="linenos">2088</span></a>
</span><span id="COMPsc.cell_histograme-2089"><a href="#COMPsc.cell_histograme-2089"><span class="linenos">2089</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span></pre></div>


            <div class="docstring"><p>Plot a histogram of the number of cells detected per cell name (cluster).</p>

<h2 id="parameters">Parameters</h2>

<p>name_slot : str, default 'cell_names'
    Column in metadata to use as sample names.</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.figure.Figure
    Figure containing the histogram of cell contents.</p>

<h2 id="notes">Notes</h2>

<p>Requires <code>self.cells_calc</code> to be computed prior to calling.</p>
</div>


                            </div>
                            <div id="COMPsc.cluster_threshold" class="classattr">
                                        <input id="COMPsc.cluster_threshold-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cluster_threshold</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">min_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span>, </span><span class="param"><span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cell_names&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.cluster_threshold-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.cluster_threshold"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.cluster_threshold-2091"><a href="#COMPsc.cluster_threshold-2091"><span class="linenos">2091</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cluster_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">):</span>
</span><span id="COMPsc.cluster_threshold-2092"><a href="#COMPsc.cluster_threshold-2092"><span class="linenos">2092</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.cluster_threshold-2093"><a href="#COMPsc.cluster_threshold-2093"><span class="linenos">2093</span></a><span class="sd">        Filter cell names / clusters by cell-detection threshold.</span>
</span><span id="COMPsc.cluster_threshold-2094"><a href="#COMPsc.cluster_threshold-2094"><span class="linenos">2094</span></a>
</span><span id="COMPsc.cluster_threshold-2095"><a href="#COMPsc.cluster_threshold-2095"><span class="linenos">2095</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.cluster_threshold-2096"><a href="#COMPsc.cluster_threshold-2096"><span class="linenos">2096</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.cluster_threshold-2097"><a href="#COMPsc.cluster_threshold-2097"><span class="linenos">2097</span></a><span class="sd">        min_n : int or None</span>
</span><span id="COMPsc.cluster_threshold-2098"><a href="#COMPsc.cluster_threshold-2098"><span class="linenos">2098</span></a><span class="sd">            Minimum number of detected genes required to keep a cell.</span>
</span><span id="COMPsc.cluster_threshold-2099"><a href="#COMPsc.cluster_threshold-2099"><span class="linenos">2099</span></a>
</span><span id="COMPsc.cluster_threshold-2100"><a href="#COMPsc.cluster_threshold-2100"><span class="linenos">2100</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="COMPsc.cluster_threshold-2101"><a href="#COMPsc.cluster_threshold-2101"><span class="linenos">2101</span></a><span class="sd">            Column in metadata to use as sample names.</span>
</span><span id="COMPsc.cluster_threshold-2102"><a href="#COMPsc.cluster_threshold-2102"><span class="linenos">2102</span></a>
</span><span id="COMPsc.cluster_threshold-2103"><a href="#COMPsc.cluster_threshold-2103"><span class="linenos">2103</span></a>
</span><span id="COMPsc.cluster_threshold-2104"><a href="#COMPsc.cluster_threshold-2104"><span class="linenos">2104</span></a><span class="sd">        Update</span>
</span><span id="COMPsc.cluster_threshold-2105"><a href="#COMPsc.cluster_threshold-2105"><span class="linenos">2105</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.cluster_threshold-2106"><a href="#COMPsc.cluster_threshold-2106"><span class="linenos">2106</span></a><span class="sd">        Filters `self.input_data`, `self.normalized_data`, `self.input_metadata`</span>
</span><span id="COMPsc.cluster_threshold-2107"><a href="#COMPsc.cluster_threshold-2107"><span class="linenos">2107</span></a><span class="sd">        (and calls `average()` if `self.agg_normalized_data` exists).</span>
</span><span id="COMPsc.cluster_threshold-2108"><a href="#COMPsc.cluster_threshold-2108"><span class="linenos">2108</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.cluster_threshold-2109"><a href="#COMPsc.cluster_threshold-2109"><span class="linenos">2109</span></a>
</span><span id="COMPsc.cluster_threshold-2110"><a href="#COMPsc.cluster_threshold-2110"><span class="linenos">2110</span></a>        <span class="k">if</span> <span class="n">name_slot</span> <span class="o">!=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">:</span>
</span><span id="COMPsc.cluster_threshold-2111"><a href="#COMPsc.cluster_threshold-2111"><span class="linenos">2111</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">(</span><span class="n">name_slot</span><span class="o">=</span><span class="n">name_slot</span><span class="p">)</span>
</span><span id="COMPsc.cluster_threshold-2112"><a href="#COMPsc.cluster_threshold-2112"><span class="linenos">2112</span></a>
</span><span id="COMPsc.cluster_threshold-2113"><a href="#COMPsc.cluster_threshold-2113"><span class="linenos">2113</span></a>        <span class="k">if</span> <span class="n">min_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.cluster_threshold-2114"><a href="#COMPsc.cluster_threshold-2114"><span class="linenos">2114</span></a>            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_calc</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_n</span><span class="p">]</span>
</span><span id="COMPsc.cluster_threshold-2115"><a href="#COMPsc.cluster_threshold-2115"><span class="linenos">2115</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.cluster_threshold-2116"><a href="#COMPsc.cluster_threshold-2116"><span class="linenos">2116</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lack of min_n value&quot;</span><span class="p">)</span>
</span><span id="COMPsc.cluster_threshold-2117"><a href="#COMPsc.cluster_threshold-2117"><span class="linenos">2117</span></a>
</span><span id="COMPsc.cluster_threshold-2118"><a href="#COMPsc.cluster_threshold-2118"><span class="linenos">2118</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.cluster_threshold-2119"><a href="#COMPsc.cluster_threshold-2119"><span class="linenos">2119</span></a>
</span><span id="COMPsc.cluster_threshold-2120"><a href="#COMPsc.cluster_threshold-2120"><span class="linenos">2120</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.cluster_threshold-2121"><a href="#COMPsc.cluster_threshold-2121"><span class="linenos">2121</span></a>
</span><span id="COMPsc.cluster_threshold-2122"><a href="#COMPsc.cluster_threshold-2122"><span class="linenos">2122</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.cluster_threshold-2123"><a href="#COMPsc.cluster_threshold-2123"><span class="linenos">2123</span></a>
</span><span id="COMPsc.cluster_threshold-2124"><a href="#COMPsc.cluster_threshold-2124"><span class="linenos">2124</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc.cluster_threshold-2125"><a href="#COMPsc.cluster_threshold-2125"><span class="linenos">2125</span></a>
</span><span id="COMPsc.cluster_threshold-2126"><a href="#COMPsc.cluster_threshold-2126"><span class="linenos">2126</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.cluster_threshold-2127"><a href="#COMPsc.cluster_threshold-2127"><span class="linenos">2127</span></a>
</span><span id="COMPsc.cluster_threshold-2128"><a href="#COMPsc.cluster_threshold-2128"><span class="linenos">2128</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="COMPsc.cluster_threshold-2129"><a href="#COMPsc.cluster_threshold-2129"><span class="linenos">2129</span></a>
</span><span id="COMPsc.cluster_threshold-2130"><a href="#COMPsc.cluster_threshold-2130"><span class="linenos">2130</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.cluster_threshold-2131"><a href="#COMPsc.cluster_threshold-2131"><span class="linenos">2131</span></a>
</span><span id="COMPsc.cluster_threshold-2132"><a href="#COMPsc.cluster_threshold-2132"><span class="linenos">2132</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.cluster_threshold-2133"><a href="#COMPsc.cluster_threshold-2133"><span class="linenos">2133</span></a>
</span><span id="COMPsc.cluster_threshold-2134"><a href="#COMPsc.cluster_threshold-2134"><span class="linenos">2134</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc.cluster_threshold-2135"><a href="#COMPsc.cluster_threshold-2135"><span class="linenos">2135</span></a>                    <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="COMPsc.cluster_threshold-2136"><a href="#COMPsc.cluster_threshold-2136"><span class="linenos">2136</span></a>                <span class="p">]</span>
</span><span id="COMPsc.cluster_threshold-2137"><a href="#COMPsc.cluster_threshold-2137"><span class="linenos">2137</span></a>
</span><span id="COMPsc.cluster_threshold-2138"><a href="#COMPsc.cluster_threshold-2138"><span class="linenos">2138</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.cluster_threshold-2139"><a href="#COMPsc.cluster_threshold-2139"><span class="linenos">2139</span></a>
</span><span id="COMPsc.cluster_threshold-2140"><a href="#COMPsc.cluster_threshold-2140"><span class="linenos">2140</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="COMPsc.cluster_threshold-2141"><a href="#COMPsc.cluster_threshold-2141"><span class="linenos">2141</span></a>
</span><span id="COMPsc.cluster_threshold-2142"><a href="#COMPsc.cluster_threshold-2142"><span class="linenos">2142</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.cluster_threshold-2143"><a href="#COMPsc.cluster_threshold-2143"><span class="linenos">2143</span></a>
</span><span id="COMPsc.cluster_threshold-2144"><a href="#COMPsc.cluster_threshold-2144"><span class="linenos">2144</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.cluster_threshold-2145"><a href="#COMPsc.cluster_threshold-2145"><span class="linenos">2145</span></a>
</span><span id="COMPsc.cluster_threshold-2146"><a href="#COMPsc.cluster_threshold-2146"><span class="linenos">2146</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc.cluster_threshold-2147"><a href="#COMPsc.cluster_threshold-2147"><span class="linenos">2147</span></a>                    <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="COMPsc.cluster_threshold-2148"><a href="#COMPsc.cluster_threshold-2148"><span class="linenos">2148</span></a>                <span class="p">]</span>
</span><span id="COMPsc.cluster_threshold-2149"><a href="#COMPsc.cluster_threshold-2149"><span class="linenos">2149</span></a>
</span><span id="COMPsc.cluster_threshold-2150"><a href="#COMPsc.cluster_threshold-2150"><span class="linenos">2150</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.cluster_threshold-2151"><a href="#COMPsc.cluster_threshold-2151"><span class="linenos">2151</span></a>
</span><span id="COMPsc.cluster_threshold-2152"><a href="#COMPsc.cluster_threshold-2152"><span class="linenos">2152</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="COMPsc.cluster_threshold-2153"><a href="#COMPsc.cluster_threshold-2153"><span class="linenos">2153</span></a>                        <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="COMPsc.cluster_threshold-2154"><a href="#COMPsc.cluster_threshold-2154"><span class="linenos">2154</span></a>                    <span class="p">)</span>
</span><span id="COMPsc.cluster_threshold-2155"><a href="#COMPsc.cluster_threshold-2155"><span class="linenos">2155</span></a>
</span><span id="COMPsc.cluster_threshold-2156"><a href="#COMPsc.cluster_threshold-2156"><span class="linenos">2156</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="COMPsc.cluster_threshold-2157"><a href="#COMPsc.cluster_threshold-2157"><span class="linenos">2157</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="COMPsc.cluster_threshold-2158"><a href="#COMPsc.cluster_threshold-2158"><span class="linenos">2158</span></a>                <span class="p">)</span>
</span><span id="COMPsc.cluster_threshold-2159"><a href="#COMPsc.cluster_threshold-2159"><span class="linenos">2159</span></a>
</span><span id="COMPsc.cluster_threshold-2160"><a href="#COMPsc.cluster_threshold-2160"><span class="linenos">2160</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.cluster_threshold-2161"><a href="#COMPsc.cluster_threshold-2161"><span class="linenos">2161</span></a>
</span><span id="COMPsc.cluster_threshold-2162"><a href="#COMPsc.cluster_threshold-2162"><span class="linenos">2162</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.cluster_threshold-2163"><a href="#COMPsc.cluster_threshold-2163"><span class="linenos">2163</span></a>
</span><span id="COMPsc.cluster_threshold-2164"><a href="#COMPsc.cluster_threshold-2164"><span class="linenos">2164</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc.cluster_threshold-2165"><a href="#COMPsc.cluster_threshold-2165"><span class="linenos">2165</span></a>                    <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
</span><span id="COMPsc.cluster_threshold-2166"><a href="#COMPsc.cluster_threshold-2166"><span class="linenos">2166</span></a>                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="COMPsc.cluster_threshold-2167"><a href="#COMPsc.cluster_threshold-2167"><span class="linenos">2167</span></a>                <span class="p">]</span>
</span><span id="COMPsc.cluster_threshold-2168"><a href="#COMPsc.cluster_threshold-2168"><span class="linenos">2168</span></a>
</span><span id="COMPsc.cluster_threshold-2169"><a href="#COMPsc.cluster_threshold-2169"><span class="linenos">2169</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.cluster_threshold-2170"><a href="#COMPsc.cluster_threshold-2170"><span class="linenos">2170</span></a>
</span><span id="COMPsc.cluster_threshold-2171"><a href="#COMPsc.cluster_threshold-2171"><span class="linenos">2171</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
</span><span id="COMPsc.cluster_threshold-2172"><a href="#COMPsc.cluster_threshold-2172"><span class="linenos">2172</span></a>
</span><span id="COMPsc.cluster_threshold-2173"><a href="#COMPsc.cluster_threshold-2173"><span class="linenos">2173</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.cluster_threshold-2174"><a href="#COMPsc.cluster_threshold-2174"><span class="linenos">2174</span></a>
</span><span id="COMPsc.cluster_threshold-2175"><a href="#COMPsc.cluster_threshold-2175"><span class="linenos">2175</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.cluster_threshold-2176"><a href="#COMPsc.cluster_threshold-2176"><span class="linenos">2176</span></a>
</span><span id="COMPsc.cluster_threshold-2177"><a href="#COMPsc.cluster_threshold-2177"><span class="linenos">2177</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc.cluster_threshold-2178"><a href="#COMPsc.cluster_threshold-2178"><span class="linenos">2178</span></a>                    <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="COMPsc.cluster_threshold-2179"><a href="#COMPsc.cluster_threshold-2179"><span class="linenos">2179</span></a>                <span class="p">]</span>
</span><span id="COMPsc.cluster_threshold-2180"><a href="#COMPsc.cluster_threshold-2180"><span class="linenos">2180</span></a>
</span><span id="COMPsc.cluster_threshold-2181"><a href="#COMPsc.cluster_threshold-2181"><span class="linenos">2181</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.cluster_threshold-2182"><a href="#COMPsc.cluster_threshold-2182"><span class="linenos">2182</span></a>
</span><span id="COMPsc.cluster_threshold-2183"><a href="#COMPsc.cluster_threshold-2183"><span class="linenos">2183</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="COMPsc.cluster_threshold-2184"><a href="#COMPsc.cluster_threshold-2184"><span class="linenos">2184</span></a>                        <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
</span><span id="COMPsc.cluster_threshold-2185"><a href="#COMPsc.cluster_threshold-2185"><span class="linenos">2185</span></a>                    <span class="p">)</span>
</span><span id="COMPsc.cluster_threshold-2186"><a href="#COMPsc.cluster_threshold-2186"><span class="linenos">2186</span></a>
</span><span id="COMPsc.cluster_threshold-2187"><a href="#COMPsc.cluster_threshold-2187"><span class="linenos">2187</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="COMPsc.cluster_threshold-2188"><a href="#COMPsc.cluster_threshold-2188"><span class="linenos">2188</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="COMPsc.cluster_threshold-2189"><a href="#COMPsc.cluster_threshold-2189"><span class="linenos">2189</span></a>                <span class="p">)</span>
</span><span id="COMPsc.cluster_threshold-2190"><a href="#COMPsc.cluster_threshold-2190"><span class="linenos">2190</span></a>
</span><span id="COMPsc.cluster_threshold-2191"><a href="#COMPsc.cluster_threshold-2191"><span class="linenos">2191</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gene_calculation</span><span class="p">()</span>
</span><span id="COMPsc.cluster_threshold-2192"><a href="#COMPsc.cluster_threshold-2192"><span class="linenos">2192</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Filter cell names / clusters by cell-detection threshold.</p>

<h2 id="parameters">Parameters</h2>

<p>min_n : int or None
    Minimum number of detected genes required to keep a cell.</p>

<p>name_slot : str, default 'cell_names'
    Column in metadata to use as sample names.</p>

<h2 id="update">Update</h2>

<p>Filters <code>self.input_data</code>, <code>self.normalized_data</code>, <code>self.input_metadata</code>
(and calls <code><a href="#COMPsc.average">average()</a></code> if <code>self.agg_normalized_data</code> exists).</p>
</div>


                            </div>
                            <div id="COMPsc.load_sparse_from_projects" class="classattr">
                                        <input id="COMPsc.load_sparse_from_projects-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_sparse_from_projects</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">normalized_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.load_sparse_from_projects-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.load_sparse_from_projects"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.load_sparse_from_projects-2194"><a href="#COMPsc.load_sparse_from_projects-2194"><span class="linenos">2194</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_sparse_from_projects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalized_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="COMPsc.load_sparse_from_projects-2195"><a href="#COMPsc.load_sparse_from_projects-2195"><span class="linenos">2195</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.load_sparse_from_projects-2196"><a href="#COMPsc.load_sparse_from_projects-2196"><span class="linenos">2196</span></a><span class="sd">        Load sparse 10x-style datasets from stored project paths, concatenate them,</span>
</span><span id="COMPsc.load_sparse_from_projects-2197"><a href="#COMPsc.load_sparse_from_projects-2197"><span class="linenos">2197</span></a><span class="sd">        and populate `input_data` / `normalized_data` and `input_metadata`.</span>
</span><span id="COMPsc.load_sparse_from_projects-2198"><a href="#COMPsc.load_sparse_from_projects-2198"><span class="linenos">2198</span></a>
</span><span id="COMPsc.load_sparse_from_projects-2199"><a href="#COMPsc.load_sparse_from_projects-2199"><span class="linenos">2199</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.load_sparse_from_projects-2200"><a href="#COMPsc.load_sparse_from_projects-2200"><span class="linenos">2200</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.load_sparse_from_projects-2201"><a href="#COMPsc.load_sparse_from_projects-2201"><span class="linenos">2201</span></a><span class="sd">        normalized_data : bool, default False</span>
</span><span id="COMPsc.load_sparse_from_projects-2202"><a href="#COMPsc.load_sparse_from_projects-2202"><span class="linenos">2202</span></a><span class="sd">            If True, store concatenated tables in `self.normalized_data`.</span>
</span><span id="COMPsc.load_sparse_from_projects-2203"><a href="#COMPsc.load_sparse_from_projects-2203"><span class="linenos">2203</span></a><span class="sd">            If False, store them in `self.input_data` and normalization</span>
</span><span id="COMPsc.load_sparse_from_projects-2204"><a href="#COMPsc.load_sparse_from_projects-2204"><span class="linenos">2204</span></a><span class="sd">            is needed using normalize_data() method.</span>
</span><span id="COMPsc.load_sparse_from_projects-2205"><a href="#COMPsc.load_sparse_from_projects-2205"><span class="linenos">2205</span></a>
</span><span id="COMPsc.load_sparse_from_projects-2206"><a href="#COMPsc.load_sparse_from_projects-2206"><span class="linenos">2206</span></a><span class="sd">        Side Effects</span>
</span><span id="COMPsc.load_sparse_from_projects-2207"><a href="#COMPsc.load_sparse_from_projects-2207"><span class="linenos">2207</span></a><span class="sd">        ------------</span>
</span><span id="COMPsc.load_sparse_from_projects-2208"><a href="#COMPsc.load_sparse_from_projects-2208"><span class="linenos">2208</span></a><span class="sd">        - Reads each project using `load_sparse(...)` (expects matrix.mtx, genes.tsv, barcodes.tsv).</span>
</span><span id="COMPsc.load_sparse_from_projects-2209"><a href="#COMPsc.load_sparse_from_projects-2209"><span class="linenos">2209</span></a><span class="sd">        - Concatenates all projects column-wise and sets `self.input_metadata`.</span>
</span><span id="COMPsc.load_sparse_from_projects-2210"><a href="#COMPsc.load_sparse_from_projects-2210"><span class="linenos">2210</span></a><span class="sd">        - Replaces NaNs with zeros and updates `self.gene_calc`.</span>
</span><span id="COMPsc.load_sparse_from_projects-2211"><a href="#COMPsc.load_sparse_from_projects-2211"><span class="linenos">2211</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.load_sparse_from_projects-2212"><a href="#COMPsc.load_sparse_from_projects-2212"><span class="linenos">2212</span></a>
</span><span id="COMPsc.load_sparse_from_projects-2213"><a href="#COMPsc.load_sparse_from_projects-2213"><span class="linenos">2213</span></a>        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span>
</span><span id="COMPsc.load_sparse_from_projects-2214"><a href="#COMPsc.load_sparse_from_projects-2214"><span class="linenos">2214</span></a>
</span><span id="COMPsc.load_sparse_from_projects-2215"><a href="#COMPsc.load_sparse_from_projects-2215"><span class="linenos">2215</span></a>        <span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span><span id="COMPsc.load_sparse_from_projects-2216"><a href="#COMPsc.load_sparse_from_projects-2216"><span class="linenos">2216</span></a>        <span class="n">full_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span><span id="COMPsc.load_sparse_from_projects-2217"><a href="#COMPsc.load_sparse_from_projects-2217"><span class="linenos">2217</span></a>
</span><span id="COMPsc.load_sparse_from_projects-2218"><a href="#COMPsc.load_sparse_from_projects-2218"><span class="linenos">2218</span></a>        <span class="k">for</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="COMPsc.load_sparse_from_projects-2219"><a href="#COMPsc.load_sparse_from_projects-2219"><span class="linenos">2219</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
</span><span id="COMPsc.load_sparse_from_projects-2220"><a href="#COMPsc.load_sparse_from_projects-2220"><span class="linenos">2220</span></a>
</span><span id="COMPsc.load_sparse_from_projects-2221"><a href="#COMPsc.load_sparse_from_projects-2221"><span class="linenos">2221</span></a>            <span class="n">dt</span><span class="p">,</span> <span class="n">met</span> <span class="o">=</span> <span class="n">load_sparse</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">obj</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">ke</span><span class="p">)</span>
</span><span id="COMPsc.load_sparse_from_projects-2222"><a href="#COMPsc.load_sparse_from_projects-2222"><span class="linenos">2222</span></a>
</span><span id="COMPsc.load_sparse_from_projects-2223"><a href="#COMPsc.load_sparse_from_projects-2223"><span class="linenos">2223</span></a>            <span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">full_data</span><span class="p">,</span> <span class="n">dt</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc.load_sparse_from_projects-2224"><a href="#COMPsc.load_sparse_from_projects-2224"><span class="linenos">2224</span></a>            <span class="n">full_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">full_metadata</span><span class="p">,</span> <span class="n">met</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="COMPsc.load_sparse_from_projects-2225"><a href="#COMPsc.load_sparse_from_projects-2225"><span class="linenos">2225</span></a>
</span><span id="COMPsc.load_sparse_from_projects-2226"><a href="#COMPsc.load_sparse_from_projects-2226"><span class="linenos">2226</span></a>        <span class="n">full_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">full_data</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="COMPsc.load_sparse_from_projects-2227"><a href="#COMPsc.load_sparse_from_projects-2227"><span class="linenos">2227</span></a>
</span><span id="COMPsc.load_sparse_from_projects-2228"><a href="#COMPsc.load_sparse_from_projects-2228"><span class="linenos">2228</span></a>        <span class="k">if</span> <span class="n">normalized_data</span><span class="p">:</span>
</span><span id="COMPsc.load_sparse_from_projects-2229"><a href="#COMPsc.load_sparse_from_projects-2229"><span class="linenos">2229</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="n">full_data</span>
</span><span id="COMPsc.load_sparse_from_projects-2230"><a href="#COMPsc.load_sparse_from_projects-2230"><span class="linenos">2230</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="n">full_metadata</span>
</span><span id="COMPsc.load_sparse_from_projects-2231"><a href="#COMPsc.load_sparse_from_projects-2231"><span class="linenos">2231</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.load_sparse_from_projects-2232"><a href="#COMPsc.load_sparse_from_projects-2232"><span class="linenos">2232</span></a>
</span><span id="COMPsc.load_sparse_from_projects-2233"><a href="#COMPsc.load_sparse_from_projects-2233"><span class="linenos">2233</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="n">full_data</span>
</span><span id="COMPsc.load_sparse_from_projects-2234"><a href="#COMPsc.load_sparse_from_projects-2234"><span class="linenos">2234</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span> <span class="o">=</span> <span class="n">full_metadata</span>
</span><span id="COMPsc.load_sparse_from_projects-2235"><a href="#COMPsc.load_sparse_from_projects-2235"><span class="linenos">2235</span></a>
</span><span id="COMPsc.load_sparse_from_projects-2236"><a href="#COMPsc.load_sparse_from_projects-2236"><span class="linenos">2236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_calculation</span><span class="p">()</span>
</span><span id="COMPsc.load_sparse_from_projects-2237"><a href="#COMPsc.load_sparse_from_projects-2237"><span class="linenos">2237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_calculation</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Load sparse 10x-style datasets from stored project paths, concatenate them,
and populate <code><a href="#COMPsc.input_data">input_data</a></code> / <code><a href="#COMPsc.normalized_data">normalized_data</a></code> and <code><a href="#COMPsc.input_metadata">input_metadata</a></code>.</p>

<h2 id="parameters">Parameters</h2>

<p>normalized_data : bool, default False
    If True, store concatenated tables in <code>self.normalized_data</code>.
    If False, store them in <code>self.input_data</code> and normalization
    is needed using normalize_data() method.</p>

<h2 id="side-effects">Side Effects</h2>

<ul>
<li>Reads each project using <code>load_sparse(...)</code> (expects matrix.mtx, genes.tsv, barcodes.tsv).</li>
<li>Concatenates all projects column-wise and sets <code>self.input_metadata</code>.</li>
<li>Replaces NaNs with zeros and updates <code>self.gene_calc</code>.</li>
</ul>
</div>


                            </div>
                            <div id="COMPsc.rename_names" class="classattr">
                                        <input id="COMPsc.rename_names-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">rename_names</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mapping</span><span class="p">:</span> <span class="nb">dict</span>, </span><span class="param"><span class="n">slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cell_names&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.rename_names-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.rename_names"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.rename_names-2239"><a href="#COMPsc.rename_names-2239"><span class="linenos">2239</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rename_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">):</span>
</span><span id="COMPsc.rename_names-2240"><a href="#COMPsc.rename_names-2240"><span class="linenos">2240</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.rename_names-2241"><a href="#COMPsc.rename_names-2241"><span class="linenos">2241</span></a><span class="sd">        Rename entries in `self.input_metadata[slot]` according to a provided mapping.</span>
</span><span id="COMPsc.rename_names-2242"><a href="#COMPsc.rename_names-2242"><span class="linenos">2242</span></a>
</span><span id="COMPsc.rename_names-2243"><a href="#COMPsc.rename_names-2243"><span class="linenos">2243</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.rename_names-2244"><a href="#COMPsc.rename_names-2244"><span class="linenos">2244</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.rename_names-2245"><a href="#COMPsc.rename_names-2245"><span class="linenos">2245</span></a><span class="sd">        mapping : dict</span>
</span><span id="COMPsc.rename_names-2246"><a href="#COMPsc.rename_names-2246"><span class="linenos">2246</span></a><span class="sd">            Dictionary with keys &#39;old_name&#39; and &#39;new_name&#39;, each mapping to a list</span>
</span><span id="COMPsc.rename_names-2247"><a href="#COMPsc.rename_names-2247"><span class="linenos">2247</span></a><span class="sd">            of equal length describing replacements.</span>
</span><span id="COMPsc.rename_names-2248"><a href="#COMPsc.rename_names-2248"><span class="linenos">2248</span></a>
</span><span id="COMPsc.rename_names-2249"><a href="#COMPsc.rename_names-2249"><span class="linenos">2249</span></a><span class="sd">        slot : str, default &#39;cell_names&#39;</span>
</span><span id="COMPsc.rename_names-2250"><a href="#COMPsc.rename_names-2250"><span class="linenos">2250</span></a><span class="sd">            Metadata column to operate on.</span>
</span><span id="COMPsc.rename_names-2251"><a href="#COMPsc.rename_names-2251"><span class="linenos">2251</span></a>
</span><span id="COMPsc.rename_names-2252"><a href="#COMPsc.rename_names-2252"><span class="linenos">2252</span></a><span class="sd">        Update</span>
</span><span id="COMPsc.rename_names-2253"><a href="#COMPsc.rename_names-2253"><span class="linenos">2253</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.rename_names-2254"><a href="#COMPsc.rename_names-2254"><span class="linenos">2254</span></a><span class="sd">        Updates `self.input_metadata[slot]` in-place with renamed values.</span>
</span><span id="COMPsc.rename_names-2255"><a href="#COMPsc.rename_names-2255"><span class="linenos">2255</span></a>
</span><span id="COMPsc.rename_names-2256"><a href="#COMPsc.rename_names-2256"><span class="linenos">2256</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc.rename_names-2257"><a href="#COMPsc.rename_names-2257"><span class="linenos">2257</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.rename_names-2258"><a href="#COMPsc.rename_names-2258"><span class="linenos">2258</span></a><span class="sd">        ValueError</span>
</span><span id="COMPsc.rename_names-2259"><a href="#COMPsc.rename_names-2259"><span class="linenos">2259</span></a><span class="sd">            If mapping keys are incorrect, lengths differ, or some &#39;old_name&#39; values</span>
</span><span id="COMPsc.rename_names-2260"><a href="#COMPsc.rename_names-2260"><span class="linenos">2260</span></a><span class="sd">            are not present in the metadata column.</span>
</span><span id="COMPsc.rename_names-2261"><a href="#COMPsc.rename_names-2261"><span class="linenos">2261</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.rename_names-2262"><a href="#COMPsc.rename_names-2262"><span class="linenos">2262</span></a>
</span><span id="COMPsc.rename_names-2263"><a href="#COMPsc.rename_names-2263"><span class="linenos">2263</span></a>        <span class="k">if</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;old_name&quot;</span><span class="p">,</span> <span class="s2">&quot;new_name&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="COMPsc.rename_names-2264"><a href="#COMPsc.rename_names-2264"><span class="linenos">2264</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc.rename_names-2265"><a href="#COMPsc.rename_names-2265"><span class="linenos">2265</span></a>                <span class="s2">&quot;Mapping dictionary must contain keys &#39;old_name&#39; and &#39;new_name&#39;, &quot;</span>
</span><span id="COMPsc.rename_names-2266"><a href="#COMPsc.rename_names-2266"><span class="linenos">2266</span></a>                <span class="s2">&quot;each with a list of names to change.&quot;</span>
</span><span id="COMPsc.rename_names-2267"><a href="#COMPsc.rename_names-2267"><span class="linenos">2267</span></a>            <span class="p">)</span>
</span><span id="COMPsc.rename_names-2268"><a href="#COMPsc.rename_names-2268"><span class="linenos">2268</span></a>
</span><span id="COMPsc.rename_names-2269"><a href="#COMPsc.rename_names-2269"><span class="linenos">2269</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;old_name&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;new_name&quot;</span><span class="p">]):</span>
</span><span id="COMPsc.rename_names-2270"><a href="#COMPsc.rename_names-2270"><span class="linenos">2270</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc.rename_names-2271"><a href="#COMPsc.rename_names-2271"><span class="linenos">2271</span></a>                <span class="s2">&quot;Mapping dictionary lists &#39;old_name&#39; and &#39;new_name&#39; &quot;</span>
</span><span id="COMPsc.rename_names-2272"><a href="#COMPsc.rename_names-2272"><span class="linenos">2272</span></a>                <span class="s2">&quot;must have the same length!&quot;</span>
</span><span id="COMPsc.rename_names-2273"><a href="#COMPsc.rename_names-2273"><span class="linenos">2273</span></a>            <span class="p">)</span>
</span><span id="COMPsc.rename_names-2274"><a href="#COMPsc.rename_names-2274"><span class="linenos">2274</span></a>
</span><span id="COMPsc.rename_names-2275"><a href="#COMPsc.rename_names-2275"><span class="linenos">2275</span></a>        <span class="n">names_vector</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span>
</span><span id="COMPsc.rename_names-2276"><a href="#COMPsc.rename_names-2276"><span class="linenos">2276</span></a>
</span><span id="COMPsc.rename_names-2277"><a href="#COMPsc.rename_names-2277"><span class="linenos">2277</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">elem</span> <span class="ow">in</span> <span class="n">names_vector</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;old_name&quot;</span><span class="p">])):</span>
</span><span id="COMPsc.rename_names-2278"><a href="#COMPsc.rename_names-2278"><span class="linenos">2278</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc.rename_names-2279"><a href="#COMPsc.rename_names-2279"><span class="linenos">2279</span></a>                <span class="sa">f</span><span class="s2">&quot;Some entries from &#39;old_name&#39; do not exist in the names of slot </span><span class="si">{</span><span class="n">slot</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="COMPsc.rename_names-2280"><a href="#COMPsc.rename_names-2280"><span class="linenos">2280</span></a>            <span class="p">)</span>
</span><span id="COMPsc.rename_names-2281"><a href="#COMPsc.rename_names-2281"><span class="linenos">2281</span></a>
</span><span id="COMPsc.rename_names-2282"><a href="#COMPsc.rename_names-2282"><span class="linenos">2282</span></a>        <span class="n">replace_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;old_name&quot;</span><span class="p">],</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;new_name&quot;</span><span class="p">]))</span>
</span><span id="COMPsc.rename_names-2283"><a href="#COMPsc.rename_names-2283"><span class="linenos">2283</span></a>
</span><span id="COMPsc.rename_names-2284"><a href="#COMPsc.rename_names-2284"><span class="linenos">2284</span></a>        <span class="n">names_vector_ret</span> <span class="o">=</span> <span class="p">[</span><span class="n">replace_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">names_vector</span><span class="p">]</span>
</span><span id="COMPsc.rename_names-2285"><a href="#COMPsc.rename_names-2285"><span class="linenos">2285</span></a>
</span><span id="COMPsc.rename_names-2286"><a href="#COMPsc.rename_names-2286"><span class="linenos">2286</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">names_vector_ret</span>
</span></pre></div>


            <div class="docstring"><p>Rename entries in <code>self.input_metadata[slot]</code> according to a provided mapping.</p>

<h2 id="parameters">Parameters</h2>

<p>mapping : dict
    Dictionary with keys 'old_name' and 'new_name', each mapping to a list
    of equal length describing replacements.</p>

<p>slot : str, default 'cell_names'
    Metadata column to operate on.</p>

<h2 id="update">Update</h2>

<p>Updates <code>self.input_metadata[slot]</code> in-place with renamed values.</p>

<h2 id="raises">Raises</h2>

<p>ValueError
    If mapping keys are incorrect, lengths differ, or some 'old_name' values
    are not present in the metadata column.</p>
</div>


                            </div>
                            <div id="COMPsc.rename_subclusters" class="classattr">
                                        <input id="COMPsc.rename_subclusters-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">rename_subclusters</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mapping</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.rename_subclusters-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.rename_subclusters"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.rename_subclusters-2288"><a href="#COMPsc.rename_subclusters-2288"><span class="linenos">2288</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rename_subclusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
</span><span id="COMPsc.rename_subclusters-2289"><a href="#COMPsc.rename_subclusters-2289"><span class="linenos">2289</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.rename_subclusters-2290"><a href="#COMPsc.rename_subclusters-2290"><span class="linenos">2290</span></a><span class="sd">        Rename labels stored in `self.subclusters_.subclusters` according to mapping.</span>
</span><span id="COMPsc.rename_subclusters-2291"><a href="#COMPsc.rename_subclusters-2291"><span class="linenos">2291</span></a>
</span><span id="COMPsc.rename_subclusters-2292"><a href="#COMPsc.rename_subclusters-2292"><span class="linenos">2292</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.rename_subclusters-2293"><a href="#COMPsc.rename_subclusters-2293"><span class="linenos">2293</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.rename_subclusters-2294"><a href="#COMPsc.rename_subclusters-2294"><span class="linenos">2294</span></a><span class="sd">        mapping : dict</span>
</span><span id="COMPsc.rename_subclusters-2295"><a href="#COMPsc.rename_subclusters-2295"><span class="linenos">2295</span></a><span class="sd">            Mapping with keys &#39;old_name&#39; and &#39;new_name&#39; (lists of equal length).</span>
</span><span id="COMPsc.rename_subclusters-2296"><a href="#COMPsc.rename_subclusters-2296"><span class="linenos">2296</span></a>
</span><span id="COMPsc.rename_subclusters-2297"><a href="#COMPsc.rename_subclusters-2297"><span class="linenos">2297</span></a><span class="sd">        Update</span>
</span><span id="COMPsc.rename_subclusters-2298"><a href="#COMPsc.rename_subclusters-2298"><span class="linenos">2298</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.rename_subclusters-2299"><a href="#COMPsc.rename_subclusters-2299"><span class="linenos">2299</span></a><span class="sd">        Updates `self.subclusters_.subclusters` with renamed labels.</span>
</span><span id="COMPsc.rename_subclusters-2300"><a href="#COMPsc.rename_subclusters-2300"><span class="linenos">2300</span></a>
</span><span id="COMPsc.rename_subclusters-2301"><a href="#COMPsc.rename_subclusters-2301"><span class="linenos">2301</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc.rename_subclusters-2302"><a href="#COMPsc.rename_subclusters-2302"><span class="linenos">2302</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.rename_subclusters-2303"><a href="#COMPsc.rename_subclusters-2303"><span class="linenos">2303</span></a><span class="sd">        ValueError</span>
</span><span id="COMPsc.rename_subclusters-2304"><a href="#COMPsc.rename_subclusters-2304"><span class="linenos">2304</span></a><span class="sd">            If mapping is invalid or old names are not present.</span>
</span><span id="COMPsc.rename_subclusters-2305"><a href="#COMPsc.rename_subclusters-2305"><span class="linenos">2305</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.rename_subclusters-2306"><a href="#COMPsc.rename_subclusters-2306"><span class="linenos">2306</span></a>
</span><span id="COMPsc.rename_subclusters-2307"><a href="#COMPsc.rename_subclusters-2307"><span class="linenos">2307</span></a>        <span class="k">if</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;old_name&quot;</span><span class="p">,</span> <span class="s2">&quot;new_name&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="COMPsc.rename_subclusters-2308"><a href="#COMPsc.rename_subclusters-2308"><span class="linenos">2308</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc.rename_subclusters-2309"><a href="#COMPsc.rename_subclusters-2309"><span class="linenos">2309</span></a>                <span class="s2">&quot;Mapping dictionary must contain keys &#39;old_name&#39; and &#39;new_name&#39;, &quot;</span>
</span><span id="COMPsc.rename_subclusters-2310"><a href="#COMPsc.rename_subclusters-2310"><span class="linenos">2310</span></a>                <span class="s2">&quot;each with a list of names to change.&quot;</span>
</span><span id="COMPsc.rename_subclusters-2311"><a href="#COMPsc.rename_subclusters-2311"><span class="linenos">2311</span></a>            <span class="p">)</span>
</span><span id="COMPsc.rename_subclusters-2312"><a href="#COMPsc.rename_subclusters-2312"><span class="linenos">2312</span></a>
</span><span id="COMPsc.rename_subclusters-2313"><a href="#COMPsc.rename_subclusters-2313"><span class="linenos">2313</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;old_name&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;new_name&quot;</span><span class="p">]):</span>
</span><span id="COMPsc.rename_subclusters-2314"><a href="#COMPsc.rename_subclusters-2314"><span class="linenos">2314</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc.rename_subclusters-2315"><a href="#COMPsc.rename_subclusters-2315"><span class="linenos">2315</span></a>                <span class="s2">&quot;Mapping dictionary lists &#39;old_name&#39; and &#39;new_name&#39; &quot;</span>
</span><span id="COMPsc.rename_subclusters-2316"><a href="#COMPsc.rename_subclusters-2316"><span class="linenos">2316</span></a>                <span class="s2">&quot;must have the same length!&quot;</span>
</span><span id="COMPsc.rename_subclusters-2317"><a href="#COMPsc.rename_subclusters-2317"><span class="linenos">2317</span></a>            <span class="p">)</span>
</span><span id="COMPsc.rename_subclusters-2318"><a href="#COMPsc.rename_subclusters-2318"><span class="linenos">2318</span></a>
</span><span id="COMPsc.rename_subclusters-2319"><a href="#COMPsc.rename_subclusters-2319"><span class="linenos">2319</span></a>        <span class="n">names_vector</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span><span class="p">)</span>
</span><span id="COMPsc.rename_subclusters-2320"><a href="#COMPsc.rename_subclusters-2320"><span class="linenos">2320</span></a>
</span><span id="COMPsc.rename_subclusters-2321"><a href="#COMPsc.rename_subclusters-2321"><span class="linenos">2321</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">elem</span> <span class="ow">in</span> <span class="n">names_vector</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;old_name&quot;</span><span class="p">])):</span>
</span><span id="COMPsc.rename_subclusters-2322"><a href="#COMPsc.rename_subclusters-2322"><span class="linenos">2322</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc.rename_subclusters-2323"><a href="#COMPsc.rename_subclusters-2323"><span class="linenos">2323</span></a>                <span class="s2">&quot;Some entries from &#39;old_name&#39; do not exist in the subcluster names.&quot;</span>
</span><span id="COMPsc.rename_subclusters-2324"><a href="#COMPsc.rename_subclusters-2324"><span class="linenos">2324</span></a>            <span class="p">)</span>
</span><span id="COMPsc.rename_subclusters-2325"><a href="#COMPsc.rename_subclusters-2325"><span class="linenos">2325</span></a>
</span><span id="COMPsc.rename_subclusters-2326"><a href="#COMPsc.rename_subclusters-2326"><span class="linenos">2326</span></a>        <span class="n">replace_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;old_name&quot;</span><span class="p">],</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;new_name&quot;</span><span class="p">]))</span>
</span><span id="COMPsc.rename_subclusters-2327"><a href="#COMPsc.rename_subclusters-2327"><span class="linenos">2327</span></a>
</span><span id="COMPsc.rename_subclusters-2328"><a href="#COMPsc.rename_subclusters-2328"><span class="linenos">2328</span></a>        <span class="n">names_vector_ret</span> <span class="o">=</span> <span class="p">[</span><span class="n">replace_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">names_vector</span><span class="p">]</span>
</span><span id="COMPsc.rename_subclusters-2329"><a href="#COMPsc.rename_subclusters-2329"><span class="linenos">2329</span></a>
</span><span id="COMPsc.rename_subclusters-2330"><a href="#COMPsc.rename_subclusters-2330"><span class="linenos">2330</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span> <span class="o">=</span> <span class="n">names_vector_ret</span>
</span></pre></div>


            <div class="docstring"><p>Rename labels stored in <code>self.subclusters_.subclusters</code> according to mapping.</p>

<h2 id="parameters">Parameters</h2>

<p>mapping : dict
    Mapping with keys 'old_name' and 'new_name' (lists of equal length).</p>

<h2 id="update">Update</h2>

<p>Updates <code>self.subclusters_.subclusters</code> with renamed labels.</p>

<h2 id="raises">Raises</h2>

<p>ValueError
    If mapping is invalid or old names are not present.</p>
</div>


                            </div>
                            <div id="COMPsc.save_sparse" class="classattr">
                                        <input id="COMPsc.save_sparse-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_sparse</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">path_to_save</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;/mnt/c/Users/merag/Git/JDti&#39;</span>,</span><span class="param">	<span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cell_names&#39;</span>,</span><span class="param">	<span class="n">data_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;normalized&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.save_sparse-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.save_sparse"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.save_sparse-2332"><a href="#COMPsc.save_sparse-2332"><span class="linenos">2332</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_sparse</span><span class="p">(</span>
</span><span id="COMPsc.save_sparse-2333"><a href="#COMPsc.save_sparse-2333"><span class="linenos">2333</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc.save_sparse-2334"><a href="#COMPsc.save_sparse-2334"><span class="linenos">2334</span></a>        <span class="n">path_to_save</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
</span><span id="COMPsc.save_sparse-2335"><a href="#COMPsc.save_sparse-2335"><span class="linenos">2335</span></a>        <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="COMPsc.save_sparse-2336"><a href="#COMPsc.save_sparse-2336"><span class="linenos">2336</span></a>        <span class="n">data_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;normalized&quot;</span><span class="p">,</span>
</span><span id="COMPsc.save_sparse-2337"><a href="#COMPsc.save_sparse-2337"><span class="linenos">2337</span></a>    <span class="p">):</span>
</span><span id="COMPsc.save_sparse-2338"><a href="#COMPsc.save_sparse-2338"><span class="linenos">2338</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.save_sparse-2339"><a href="#COMPsc.save_sparse-2339"><span class="linenos">2339</span></a><span class="sd">        Export data as 10x-compatible sparse files (matrix.mtx, barcodes.tsv, genes.tsv).</span>
</span><span id="COMPsc.save_sparse-2340"><a href="#COMPsc.save_sparse-2340"><span class="linenos">2340</span></a>
</span><span id="COMPsc.save_sparse-2341"><a href="#COMPsc.save_sparse-2341"><span class="linenos">2341</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.save_sparse-2342"><a href="#COMPsc.save_sparse-2342"><span class="linenos">2342</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.save_sparse-2343"><a href="#COMPsc.save_sparse-2343"><span class="linenos">2343</span></a><span class="sd">        path_to_save : str, default current working directory</span>
</span><span id="COMPsc.save_sparse-2344"><a href="#COMPsc.save_sparse-2344"><span class="linenos">2344</span></a><span class="sd">            Directory where files will be written.</span>
</span><span id="COMPsc.save_sparse-2345"><a href="#COMPsc.save_sparse-2345"><span class="linenos">2345</span></a>
</span><span id="COMPsc.save_sparse-2346"><a href="#COMPsc.save_sparse-2346"><span class="linenos">2346</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="COMPsc.save_sparse-2347"><a href="#COMPsc.save_sparse-2347"><span class="linenos">2347</span></a><span class="sd">            Metadata column providing cell names for barcodes.tsv.</span>
</span><span id="COMPsc.save_sparse-2348"><a href="#COMPsc.save_sparse-2348"><span class="linenos">2348</span></a>
</span><span id="COMPsc.save_sparse-2349"><a href="#COMPsc.save_sparse-2349"><span class="linenos">2349</span></a><span class="sd">        data_slot : str, default &#39;normalized&#39;</span>
</span><span id="COMPsc.save_sparse-2350"><a href="#COMPsc.save_sparse-2350"><span class="linenos">2350</span></a><span class="sd">            Either &#39;normalized&#39; (uses self.normalized_data) or &#39;count&#39; (uses self.input_data).</span>
</span><span id="COMPsc.save_sparse-2351"><a href="#COMPsc.save_sparse-2351"><span class="linenos">2351</span></a>
</span><span id="COMPsc.save_sparse-2352"><a href="#COMPsc.save_sparse-2352"><span class="linenos">2352</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc.save_sparse-2353"><a href="#COMPsc.save_sparse-2353"><span class="linenos">2353</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.save_sparse-2354"><a href="#COMPsc.save_sparse-2354"><span class="linenos">2354</span></a><span class="sd">        ValueError</span>
</span><span id="COMPsc.save_sparse-2355"><a href="#COMPsc.save_sparse-2355"><span class="linenos">2355</span></a><span class="sd">            If `data_slot` is not &#39;normalized&#39; or &#39;count&#39;.</span>
</span><span id="COMPsc.save_sparse-2356"><a href="#COMPsc.save_sparse-2356"><span class="linenos">2356</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.save_sparse-2357"><a href="#COMPsc.save_sparse-2357"><span class="linenos">2357</span></a>
</span><span id="COMPsc.save_sparse-2358"><a href="#COMPsc.save_sparse-2358"><span class="linenos">2358</span></a>        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]</span>
</span><span id="COMPsc.save_sparse-2359"><a href="#COMPsc.save_sparse-2359"><span class="linenos">2359</span></a>
</span><span id="COMPsc.save_sparse-2360"><a href="#COMPsc.save_sparse-2360"><span class="linenos">2360</span></a>        <span class="k">if</span> <span class="n">data_slot</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;normalized&quot;</span><span class="p">:</span>
</span><span id="COMPsc.save_sparse-2361"><a href="#COMPsc.save_sparse-2361"><span class="linenos">2361</span></a>
</span><span id="COMPsc.save_sparse-2362"><a href="#COMPsc.save_sparse-2362"><span class="linenos">2362</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="COMPsc.save_sparse-2363"><a href="#COMPsc.save_sparse-2363"><span class="linenos">2363</span></a>            <span class="n">mtx</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="p">)</span>
</span><span id="COMPsc.save_sparse-2364"><a href="#COMPsc.save_sparse-2364"><span class="linenos">2364</span></a>
</span><span id="COMPsc.save_sparse-2365"><a href="#COMPsc.save_sparse-2365"><span class="linenos">2365</span></a>        <span class="k">elif</span> <span class="n">data_slot</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span>
</span><span id="COMPsc.save_sparse-2366"><a href="#COMPsc.save_sparse-2366"><span class="linenos">2366</span></a>
</span><span id="COMPsc.save_sparse-2367"><a href="#COMPsc.save_sparse-2367"><span class="linenos">2367</span></a>            <span class="n">features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="COMPsc.save_sparse-2368"><a href="#COMPsc.save_sparse-2368"><span class="linenos">2368</span></a>            <span class="n">mtx</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">)</span>
</span><span id="COMPsc.save_sparse-2369"><a href="#COMPsc.save_sparse-2369"><span class="linenos">2369</span></a>
</span><span id="COMPsc.save_sparse-2370"><a href="#COMPsc.save_sparse-2370"><span class="linenos">2370</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.save_sparse-2371"><a href="#COMPsc.save_sparse-2371"><span class="linenos">2371</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;data_slot&#39; must be included in &#39;normalized&#39; or &#39;count&#39;&quot;</span><span class="p">)</span>
</span><span id="COMPsc.save_sparse-2372"><a href="#COMPsc.save_sparse-2372"><span class="linenos">2372</span></a>
</span><span id="COMPsc.save_sparse-2373"><a href="#COMPsc.save_sparse-2373"><span class="linenos">2373</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="COMPsc.save_sparse-2374"><a href="#COMPsc.save_sparse-2374"><span class="linenos">2374</span></a>
</span><span id="COMPsc.save_sparse-2375"><a href="#COMPsc.save_sparse-2375"><span class="linenos">2375</span></a>        <span class="n">mmwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s2">&quot;matrix.mtx&quot;</span><span class="p">),</span> <span class="n">mtx</span><span class="p">)</span>
</span><span id="COMPsc.save_sparse-2376"><a href="#COMPsc.save_sparse-2376"><span class="linenos">2376</span></a>
</span><span id="COMPsc.save_sparse-2377"><a href="#COMPsc.save_sparse-2377"><span class="linenos">2377</span></a>        <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">names</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
</span><span id="COMPsc.save_sparse-2378"><a href="#COMPsc.save_sparse-2378"><span class="linenos">2378</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s2">&quot;barcodes.tsv&quot;</span><span class="p">),</span>
</span><span id="COMPsc.save_sparse-2379"><a href="#COMPsc.save_sparse-2379"><span class="linenos">2379</span></a>            <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="COMPsc.save_sparse-2380"><a href="#COMPsc.save_sparse-2380"><span class="linenos">2380</span></a>            <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="COMPsc.save_sparse-2381"><a href="#COMPsc.save_sparse-2381"><span class="linenos">2381</span></a>            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="COMPsc.save_sparse-2382"><a href="#COMPsc.save_sparse-2382"><span class="linenos">2382</span></a>        <span class="p">)</span>
</span><span id="COMPsc.save_sparse-2383"><a href="#COMPsc.save_sparse-2383"><span class="linenos">2383</span></a>
</span><span id="COMPsc.save_sparse-2384"><a href="#COMPsc.save_sparse-2384"><span class="linenos">2384</span></a>        <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">features</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
</span><span id="COMPsc.save_sparse-2385"><a href="#COMPsc.save_sparse-2385"><span class="linenos">2385</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s2">&quot;genes.tsv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
</span><span id="COMPsc.save_sparse-2386"><a href="#COMPsc.save_sparse-2386"><span class="linenos">2386</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Export data as 10x-compatible sparse files (matrix.mtx, barcodes.tsv, genes.tsv).</p>

<h2 id="parameters">Parameters</h2>

<p>path_to_save : str, default current working directory
    Directory where files will be written.</p>

<p>name_slot : str, default 'cell_names'
    Metadata column providing cell names for barcodes.tsv.</p>

<p>data_slot : str, default 'normalized'
    Either 'normalized' (uses self.normalized_data) or 'count' (uses self.input_data).</p>

<h2 id="raises">Raises</h2>

<p>ValueError
    If <code>data_slot</code> is not 'normalized' or 'count'.</p>
</div>


                            </div>
                            <div id="COMPsc.normalize_counts" class="classattr">
                                        <input id="COMPsc.normalize_counts-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">normalize_counts</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">normalize_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100000</span>, </span><span class="param"><span class="n">log_transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.normalize_counts-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.normalize_counts"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.normalize_counts-2388"><a href="#COMPsc.normalize_counts-2388"><span class="linenos">2388</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">normalize_counts</span><span class="p">(</span>
</span><span id="COMPsc.normalize_counts-2389"><a href="#COMPsc.normalize_counts-2389"><span class="linenos">2389</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">normalize_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">log_transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="COMPsc.normalize_counts-2390"><a href="#COMPsc.normalize_counts-2390"><span class="linenos">2390</span></a>    <span class="p">):</span>
</span><span id="COMPsc.normalize_counts-2391"><a href="#COMPsc.normalize_counts-2391"><span class="linenos">2391</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.normalize_counts-2392"><a href="#COMPsc.normalize_counts-2392"><span class="linenos">2392</span></a><span class="sd">        Normalize raw counts to counts-per-(normalize_factor)</span>
</span><span id="COMPsc.normalize_counts-2393"><a href="#COMPsc.normalize_counts-2393"><span class="linenos">2393</span></a><span class="sd">        (e.g., CPM, TPM - depending on normalize_factor).</span>
</span><span id="COMPsc.normalize_counts-2394"><a href="#COMPsc.normalize_counts-2394"><span class="linenos">2394</span></a>
</span><span id="COMPsc.normalize_counts-2395"><a href="#COMPsc.normalize_counts-2395"><span class="linenos">2395</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.normalize_counts-2396"><a href="#COMPsc.normalize_counts-2396"><span class="linenos">2396</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.normalize_counts-2397"><a href="#COMPsc.normalize_counts-2397"><span class="linenos">2397</span></a><span class="sd">        normalize_factor : int, default 100000</span>
</span><span id="COMPsc.normalize_counts-2398"><a href="#COMPsc.normalize_counts-2398"><span class="linenos">2398</span></a><span class="sd">            Scaling factor used after dividing by column sums.</span>
</span><span id="COMPsc.normalize_counts-2399"><a href="#COMPsc.normalize_counts-2399"><span class="linenos">2399</span></a>
</span><span id="COMPsc.normalize_counts-2400"><a href="#COMPsc.normalize_counts-2400"><span class="linenos">2400</span></a><span class="sd">        log_transform : bool, default True</span>
</span><span id="COMPsc.normalize_counts-2401"><a href="#COMPsc.normalize_counts-2401"><span class="linenos">2401</span></a><span class="sd">            If True, apply log2(x+1) transformation to normalized values.</span>
</span><span id="COMPsc.normalize_counts-2402"><a href="#COMPsc.normalize_counts-2402"><span class="linenos">2402</span></a>
</span><span id="COMPsc.normalize_counts-2403"><a href="#COMPsc.normalize_counts-2403"><span class="linenos">2403</span></a><span class="sd">        Update</span>
</span><span id="COMPsc.normalize_counts-2404"><a href="#COMPsc.normalize_counts-2404"><span class="linenos">2404</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.normalize_counts-2405"><a href="#COMPsc.normalize_counts-2405"><span class="linenos">2405</span></a><span class="sd">            Sets `self.normalized_data` to normalized values (fills NaNs with 0).</span>
</span><span id="COMPsc.normalize_counts-2406"><a href="#COMPsc.normalize_counts-2406"><span class="linenos">2406</span></a>
</span><span id="COMPsc.normalize_counts-2407"><a href="#COMPsc.normalize_counts-2407"><span class="linenos">2407</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc.normalize_counts-2408"><a href="#COMPsc.normalize_counts-2408"><span class="linenos">2408</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.normalize_counts-2409"><a href="#COMPsc.normalize_counts-2409"><span class="linenos">2409</span></a><span class="sd">        ValueError</span>
</span><span id="COMPsc.normalize_counts-2410"><a href="#COMPsc.normalize_counts-2410"><span class="linenos">2410</span></a><span class="sd">            If `self.input_data` is missing (cannot normalize).</span>
</span><span id="COMPsc.normalize_counts-2411"><a href="#COMPsc.normalize_counts-2411"><span class="linenos">2411</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.normalize_counts-2412"><a href="#COMPsc.normalize_counts-2412"><span class="linenos">2412</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.normalize_counts-2413"><a href="#COMPsc.normalize_counts-2413"><span class="linenos">2413</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input data is missing, cannot normalize.&quot;</span><span class="p">)</span>
</span><span id="COMPsc.normalize_counts-2414"><a href="#COMPsc.normalize_counts-2414"><span class="linenos">2414</span></a>
</span><span id="COMPsc.normalize_counts-2415"><a href="#COMPsc.normalize_counts-2415"><span class="linenos">2415</span></a>        <span class="n">sum_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="COMPsc.normalize_counts-2416"><a href="#COMPsc.normalize_counts-2416"><span class="linenos">2416</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">sum_col</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">normalize_factor</span>
</span><span id="COMPsc.normalize_counts-2417"><a href="#COMPsc.normalize_counts-2417"><span class="linenos">2417</span></a>
</span><span id="COMPsc.normalize_counts-2418"><a href="#COMPsc.normalize_counts-2418"><span class="linenos">2418</span></a>        <span class="k">if</span> <span class="n">log_transform</span><span class="p">:</span>
</span><span id="COMPsc.normalize_counts-2419"><a href="#COMPsc.normalize_counts-2419"><span class="linenos">2419</span></a>            <span class="c1"># log2(x + 1) to avoid -inf for zeros</span>
</span><span id="COMPsc.normalize_counts-2420"><a href="#COMPsc.normalize_counts-2420"><span class="linenos">2420</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Normalize raw counts to counts-per-(normalize_factor)
(e.g., CPM, TPM - depending on normalize_factor).</p>

<h2 id="parameters">Parameters</h2>

<p>normalize_factor : int, default 100000
    Scaling factor used after dividing by column sums.</p>

<p>log_transform : bool, default True
    If True, apply log2(x+1) transformation to normalized values.</p>

<h2 id="update">Update</h2>

<pre><code>Sets `self.normalized_data` to normalized values (fills NaNs with 0).
</code></pre>

<h2 id="raises">Raises</h2>

<p>ValueError
    If <code>self.input_data</code> is missing (cannot normalize).</p>
</div>


                            </div>
                            <div id="COMPsc.statistic" class="classattr">
                                        <input id="COMPsc.statistic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">statistic</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">cells</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">sets</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">min_exp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span>,</span><span class="param">	<span class="n">min_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>,</span><span class="param">	<span class="n">n_proc</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.statistic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.statistic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.statistic-2422"><a href="#COMPsc.statistic-2422"><span class="linenos">2422</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">statistic</span><span class="p">(</span>
</span><span id="COMPsc.statistic-2423"><a href="#COMPsc.statistic-2423"><span class="linenos">2423</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2424"><a href="#COMPsc.statistic-2424"><span class="linenos">2424</span></a>        <span class="n">cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2425"><a href="#COMPsc.statistic-2425"><span class="linenos">2425</span></a>        <span class="n">sets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2426"><a href="#COMPsc.statistic-2426"><span class="linenos">2426</span></a>        <span class="n">min_exp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2427"><a href="#COMPsc.statistic-2427"><span class="linenos">2427</span></a>        <span class="n">min_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2428"><a href="#COMPsc.statistic-2428"><span class="linenos">2428</span></a>        <span class="n">n_proc</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2429"><a href="#COMPsc.statistic-2429"><span class="linenos">2429</span></a>    <span class="p">):</span>
</span><span id="COMPsc.statistic-2430"><a href="#COMPsc.statistic-2430"><span class="linenos">2430</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.statistic-2431"><a href="#COMPsc.statistic-2431"><span class="linenos">2431</span></a><span class="sd">        Compute per-feature statistics (Mann–Whitney U) comparing target vs rest.</span>
</span><span id="COMPsc.statistic-2432"><a href="#COMPsc.statistic-2432"><span class="linenos">2432</span></a>
</span><span id="COMPsc.statistic-2433"><a href="#COMPsc.statistic-2433"><span class="linenos">2433</span></a><span class="sd">        This is a wrapper similar to `calc_DEG` tailored to use `self.normalized_data`</span>
</span><span id="COMPsc.statistic-2434"><a href="#COMPsc.statistic-2434"><span class="linenos">2434</span></a><span class="sd">        and `self.input_metadata`. It returns per-feature statistics including p-values,</span>
</span><span id="COMPsc.statistic-2435"><a href="#COMPsc.statistic-2435"><span class="linenos">2435</span></a><span class="sd">        adjusted p-values, means, variances, effect-size measures and fold-changes.</span>
</span><span id="COMPsc.statistic-2436"><a href="#COMPsc.statistic-2436"><span class="linenos">2436</span></a>
</span><span id="COMPsc.statistic-2437"><a href="#COMPsc.statistic-2437"><span class="linenos">2437</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.statistic-2438"><a href="#COMPsc.statistic-2438"><span class="linenos">2438</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.statistic-2439"><a href="#COMPsc.statistic-2439"><span class="linenos">2439</span></a><span class="sd">        cells : list, &#39;All&#39;, dict, or None</span>
</span><span id="COMPsc.statistic-2440"><a href="#COMPsc.statistic-2440"><span class="linenos">2440</span></a><span class="sd">            Defines the target cells or groups for comparison (several modes supported).</span>
</span><span id="COMPsc.statistic-2441"><a href="#COMPsc.statistic-2441"><span class="linenos">2441</span></a>
</span><span id="COMPsc.statistic-2442"><a href="#COMPsc.statistic-2442"><span class="linenos">2442</span></a><span class="sd">        sets : &#39;All&#39;, dict, or None</span>
</span><span id="COMPsc.statistic-2443"><a href="#COMPsc.statistic-2443"><span class="linenos">2443</span></a><span class="sd">            Alternative grouping mode (operate on `self.input_metadata[&#39;sets&#39;]`).</span>
</span><span id="COMPsc.statistic-2444"><a href="#COMPsc.statistic-2444"><span class="linenos">2444</span></a>
</span><span id="COMPsc.statistic-2445"><a href="#COMPsc.statistic-2445"><span class="linenos">2445</span></a><span class="sd">        min_exp : float, default 0.01</span>
</span><span id="COMPsc.statistic-2446"><a href="#COMPsc.statistic-2446"><span class="linenos">2446</span></a><span class="sd">            Minimum expression threshold used when filtering features.</span>
</span><span id="COMPsc.statistic-2447"><a href="#COMPsc.statistic-2447"><span class="linenos">2447</span></a>
</span><span id="COMPsc.statistic-2448"><a href="#COMPsc.statistic-2448"><span class="linenos">2448</span></a><span class="sd">        min_pct : float, default 0.1</span>
</span><span id="COMPsc.statistic-2449"><a href="#COMPsc.statistic-2449"><span class="linenos">2449</span></a><span class="sd">            Minimum proportion of expressing cells in the target group required to test a feature.</span>
</span><span id="COMPsc.statistic-2450"><a href="#COMPsc.statistic-2450"><span class="linenos">2450</span></a>
</span><span id="COMPsc.statistic-2451"><a href="#COMPsc.statistic-2451"><span class="linenos">2451</span></a><span class="sd">        n_proc : int, default 10</span>
</span><span id="COMPsc.statistic-2452"><a href="#COMPsc.statistic-2452"><span class="linenos">2452</span></a><span class="sd">            Number of parallel jobs to use.</span>
</span><span id="COMPsc.statistic-2453"><a href="#COMPsc.statistic-2453"><span class="linenos">2453</span></a>
</span><span id="COMPsc.statistic-2454"><a href="#COMPsc.statistic-2454"><span class="linenos">2454</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc.statistic-2455"><a href="#COMPsc.statistic-2455"><span class="linenos">2455</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.statistic-2456"><a href="#COMPsc.statistic-2456"><span class="linenos">2456</span></a><span class="sd">        pandas.DataFrame or dict</span>
</span><span id="COMPsc.statistic-2457"><a href="#COMPsc.statistic-2457"><span class="linenos">2457</span></a><span class="sd">            Results DataFrame (or dict containing valid/control cells + DataFrame),</span>
</span><span id="COMPsc.statistic-2458"><a href="#COMPsc.statistic-2458"><span class="linenos">2458</span></a><span class="sd">            similar to `calc_DEG` interface.</span>
</span><span id="COMPsc.statistic-2459"><a href="#COMPsc.statistic-2459"><span class="linenos">2459</span></a>
</span><span id="COMPsc.statistic-2460"><a href="#COMPsc.statistic-2460"><span class="linenos">2460</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc.statistic-2461"><a href="#COMPsc.statistic-2461"><span class="linenos">2461</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.statistic-2462"><a href="#COMPsc.statistic-2462"><span class="linenos">2462</span></a><span class="sd">        ValueError</span>
</span><span id="COMPsc.statistic-2463"><a href="#COMPsc.statistic-2463"><span class="linenos">2463</span></a><span class="sd">            If neither `cells` nor `sets` is provided, or input metadata mismatch occurs.</span>
</span><span id="COMPsc.statistic-2464"><a href="#COMPsc.statistic-2464"><span class="linenos">2464</span></a>
</span><span id="COMPsc.statistic-2465"><a href="#COMPsc.statistic-2465"><span class="linenos">2465</span></a><span class="sd">        Notes</span>
</span><span id="COMPsc.statistic-2466"><a href="#COMPsc.statistic-2466"><span class="linenos">2466</span></a><span class="sd">        -----</span>
</span><span id="COMPsc.statistic-2467"><a href="#COMPsc.statistic-2467"><span class="linenos">2467</span></a><span class="sd">        Multiple modes supported: single-list entities, &#39;All&#39;, pairwise dicts, etc.</span>
</span><span id="COMPsc.statistic-2468"><a href="#COMPsc.statistic-2468"><span class="linenos">2468</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.statistic-2469"><a href="#COMPsc.statistic-2469"><span class="linenos">2469</span></a>
</span><span id="COMPsc.statistic-2470"><a href="#COMPsc.statistic-2470"><span class="linenos">2470</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">stat_calc</span><span class="p">(</span><span class="n">choose</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">):</span>
</span><span id="COMPsc.statistic-2471"><a href="#COMPsc.statistic-2471"><span class="linenos">2471</span></a>            <span class="n">target_values</span> <span class="o">=</span> <span class="n">choose</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2472"><a href="#COMPsc.statistic-2472"><span class="linenos">2472</span></a>            <span class="n">rest_values</span> <span class="o">=</span> <span class="n">choose</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rest&quot;</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2473"><a href="#COMPsc.statistic-2473"><span class="linenos">2473</span></a>
</span><span id="COMPsc.statistic-2474"><a href="#COMPsc.statistic-2474"><span class="linenos">2474</span></a>            <span class="n">pct_valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_values</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2475"><a href="#COMPsc.statistic-2475"><span class="linenos">2475</span></a>            <span class="n">pct_rest</span> <span class="o">=</span> <span class="p">(</span><span class="n">rest_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest_values</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2476"><a href="#COMPsc.statistic-2476"><span class="linenos">2476</span></a>
</span><span id="COMPsc.statistic-2477"><a href="#COMPsc.statistic-2477"><span class="linenos">2477</span></a>            <span class="n">avg_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_values</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2478"><a href="#COMPsc.statistic-2478"><span class="linenos">2478</span></a>            <span class="n">avg_ctrl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rest_values</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2479"><a href="#COMPsc.statistic-2479"><span class="linenos">2479</span></a>            <span class="n">sd_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">target_values</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2480"><a href="#COMPsc.statistic-2480"><span class="linenos">2480</span></a>            <span class="n">sd_ctrl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">rest_values</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2481"><a href="#COMPsc.statistic-2481"><span class="linenos">2481</span></a>            <span class="n">esm</span> <span class="o">=</span> <span class="p">(</span><span class="n">avg_valid</span> <span class="o">-</span> <span class="n">avg_ctrl</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">sd_valid</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sd_ctrl</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="COMPsc.statistic-2482"><a href="#COMPsc.statistic-2482"><span class="linenos">2482</span></a>
</span><span id="COMPsc.statistic-2483"><a href="#COMPsc.statistic-2483"><span class="linenos">2483</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">target_values</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rest_values</span><span class="p">):</span>
</span><span id="COMPsc.statistic-2484"><a href="#COMPsc.statistic-2484"><span class="linenos">2484</span></a>                <span class="n">p_val</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="COMPsc.statistic-2485"><a href="#COMPsc.statistic-2485"><span class="linenos">2485</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.statistic-2486"><a href="#COMPsc.statistic-2486"><span class="linenos">2486</span></a>                <span class="n">_</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span>
</span><span id="COMPsc.statistic-2487"><a href="#COMPsc.statistic-2487"><span class="linenos">2487</span></a>                    <span class="n">target_values</span><span class="p">,</span> <span class="n">rest_values</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s2">&quot;two-sided&quot;</span>
</span><span id="COMPsc.statistic-2488"><a href="#COMPsc.statistic-2488"><span class="linenos">2488</span></a>                <span class="p">)</span>
</span><span id="COMPsc.statistic-2489"><a href="#COMPsc.statistic-2489"><span class="linenos">2489</span></a>
</span><span id="COMPsc.statistic-2490"><a href="#COMPsc.statistic-2490"><span class="linenos">2490</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="COMPsc.statistic-2491"><a href="#COMPsc.statistic-2491"><span class="linenos">2491</span></a>                <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="n">feature_name</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2492"><a href="#COMPsc.statistic-2492"><span class="linenos">2492</span></a>                <span class="s2">&quot;p_val&quot;</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2493"><a href="#COMPsc.statistic-2493"><span class="linenos">2493</span></a>                <span class="s2">&quot;pct_valid&quot;</span><span class="p">:</span> <span class="n">pct_valid</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2494"><a href="#COMPsc.statistic-2494"><span class="linenos">2494</span></a>                <span class="s2">&quot;pct_ctrl&quot;</span><span class="p">:</span> <span class="n">pct_rest</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2495"><a href="#COMPsc.statistic-2495"><span class="linenos">2495</span></a>                <span class="s2">&quot;avg_valid&quot;</span><span class="p">:</span> <span class="n">avg_valid</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2496"><a href="#COMPsc.statistic-2496"><span class="linenos">2496</span></a>                <span class="s2">&quot;avg_ctrl&quot;</span><span class="p">:</span> <span class="n">avg_ctrl</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2497"><a href="#COMPsc.statistic-2497"><span class="linenos">2497</span></a>                <span class="s2">&quot;sd_valid&quot;</span><span class="p">:</span> <span class="n">sd_valid</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2498"><a href="#COMPsc.statistic-2498"><span class="linenos">2498</span></a>                <span class="s2">&quot;sd_ctrl&quot;</span><span class="p">:</span> <span class="n">sd_ctrl</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2499"><a href="#COMPsc.statistic-2499"><span class="linenos">2499</span></a>                <span class="s2">&quot;esm&quot;</span><span class="p">:</span> <span class="n">esm</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2500"><a href="#COMPsc.statistic-2500"><span class="linenos">2500</span></a>            <span class="p">}</span>
</span><span id="COMPsc.statistic-2501"><a href="#COMPsc.statistic-2501"><span class="linenos">2501</span></a>
</span><span id="COMPsc.statistic-2502"><a href="#COMPsc.statistic-2502"><span class="linenos">2502</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">prepare_and_run_stat</span><span class="p">(</span>
</span><span id="COMPsc.statistic-2503"><a href="#COMPsc.statistic-2503"><span class="linenos">2503</span></a>            <span class="n">choose</span><span class="p">,</span> <span class="n">valid_group</span><span class="p">,</span> <span class="n">min_exp</span><span class="p">,</span> <span class="n">min_pct</span><span class="p">,</span> <span class="n">n_proc</span><span class="p">,</span> <span class="n">factors</span>
</span><span id="COMPsc.statistic-2504"><a href="#COMPsc.statistic-2504"><span class="linenos">2504</span></a>        <span class="p">):</span>
</span><span id="COMPsc.statistic-2505"><a href="#COMPsc.statistic-2505"><span class="linenos">2505</span></a>
</span><span id="COMPsc.statistic-2506"><a href="#COMPsc.statistic-2506"><span class="linenos">2506</span></a>            <span class="n">tmp_dat</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2507"><a href="#COMPsc.statistic-2507"><span class="linenos">2507</span></a>            <span class="n">tmp_dat</span> <span class="o">=</span> <span class="n">tmp_dat</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;DEG&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2508"><a href="#COMPsc.statistic-2508"><span class="linenos">2508</span></a>
</span><span id="COMPsc.statistic-2509"><a href="#COMPsc.statistic-2509"><span class="linenos">2509</span></a>            <span class="n">counts</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp_dat</span> <span class="o">&gt;</span> <span class="n">min_exp</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2510"><a href="#COMPsc.statistic-2510"><span class="linenos">2510</span></a>
</span><span id="COMPsc.statistic-2511"><a href="#COMPsc.statistic-2511"><span class="linenos">2511</span></a>            <span class="n">total_count</span> <span class="o">=</span> <span class="n">tmp_dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2512"><a href="#COMPsc.statistic-2512"><span class="linenos">2512</span></a>
</span><span id="COMPsc.statistic-2513"><a href="#COMPsc.statistic-2513"><span class="linenos">2513</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="COMPsc.statistic-2514"><a href="#COMPsc.statistic-2514"><span class="linenos">2514</span></a>                <span class="p">{</span><span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmp_dat</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="s2">&quot;pct&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">counts</span> <span class="o">/</span> <span class="n">total_count</span><span class="p">)}</span>
</span><span id="COMPsc.statistic-2515"><a href="#COMPsc.statistic-2515"><span class="linenos">2515</span></a>            <span class="p">)</span>
</span><span id="COMPsc.statistic-2516"><a href="#COMPsc.statistic-2516"><span class="linenos">2516</span></a>
</span><span id="COMPsc.statistic-2517"><a href="#COMPsc.statistic-2517"><span class="linenos">2517</span></a>            <span class="k">del</span> <span class="n">tmp_dat</span>
</span><span id="COMPsc.statistic-2518"><a href="#COMPsc.statistic-2518"><span class="linenos">2518</span></a>
</span><span id="COMPsc.statistic-2519"><a href="#COMPsc.statistic-2519"><span class="linenos">2519</span></a>            <span class="n">drop_col</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">][</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">min_pct</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2520"><a href="#COMPsc.statistic-2520"><span class="linenos">2520</span></a>
</span><span id="COMPsc.statistic-2521"><a href="#COMPsc.statistic-2521"><span class="linenos">2521</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">drop_col</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
</span><span id="COMPsc.statistic-2522"><a href="#COMPsc.statistic-2522"><span class="linenos">2522</span></a>                <span class="n">drop_col</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">][</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2523"><a href="#COMPsc.statistic-2523"><span class="linenos">2523</span></a>
</span><span id="COMPsc.statistic-2524"><a href="#COMPsc.statistic-2524"><span class="linenos">2524</span></a>            <span class="k">del</span> <span class="n">info</span>
</span><span id="COMPsc.statistic-2525"><a href="#COMPsc.statistic-2525"><span class="linenos">2525</span></a>
</span><span id="COMPsc.statistic-2526"><a href="#COMPsc.statistic-2526"><span class="linenos">2526</span></a>            <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">drop_col</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2527"><a href="#COMPsc.statistic-2527"><span class="linenos">2527</span></a>
</span><span id="COMPsc.statistic-2528"><a href="#COMPsc.statistic-2528"><span class="linenos">2528</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_proc</span><span class="p">)(</span>
</span><span id="COMPsc.statistic-2529"><a href="#COMPsc.statistic-2529"><span class="linenos">2529</span></a>                <span class="n">delayed</span><span class="p">(</span><span class="n">stat_calc</span><span class="p">)(</span><span class="n">choose</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2530"><a href="#COMPsc.statistic-2530"><span class="linenos">2530</span></a>                <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">choose</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="s2">&quot;DEG&quot;</span><span class="p">])</span>
</span><span id="COMPsc.statistic-2531"><a href="#COMPsc.statistic-2531"><span class="linenos">2531</span></a>            <span class="p">)</span>
</span><span id="COMPsc.statistic-2532"><a href="#COMPsc.statistic-2532"><span class="linenos">2532</span></a>
</span><span id="COMPsc.statistic-2533"><a href="#COMPsc.statistic-2533"><span class="linenos">2533</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2534"><a href="#COMPsc.statistic-2534"><span class="linenos">2534</span></a>            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_group</span>
</span><span id="COMPsc.statistic-2535"><a href="#COMPsc.statistic-2535"><span class="linenos">2535</span></a>            <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;p_val&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2536"><a href="#COMPsc.statistic-2536"><span class="linenos">2536</span></a>
</span><span id="COMPsc.statistic-2537"><a href="#COMPsc.statistic-2537"><span class="linenos">2537</span></a>            <span class="n">num_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2538"><a href="#COMPsc.statistic-2538"><span class="linenos">2538</span></a>            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;adj_pval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
</span><span id="COMPsc.statistic-2539"><a href="#COMPsc.statistic-2539"><span class="linenos">2539</span></a>                <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;p_val&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_tests</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_tests</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2540"><a href="#COMPsc.statistic-2540"><span class="linenos">2540</span></a>            <span class="p">)</span>
</span><span id="COMPsc.statistic-2541"><a href="#COMPsc.statistic-2541"><span class="linenos">2541</span></a>
</span><span id="COMPsc.statistic-2542"><a href="#COMPsc.statistic-2542"><span class="linenos">2542</span></a>            <span class="n">factors_df</span> <span class="o">=</span> <span class="n">factors</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;factor&quot;</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2543"><a href="#COMPsc.statistic-2543"><span class="linenos">2543</span></a>
</span><span id="COMPsc.statistic-2544"><a href="#COMPsc.statistic-2544"><span class="linenos">2544</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">factors_df</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;feature&quot;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2545"><a href="#COMPsc.statistic-2545"><span class="linenos">2545</span></a>
</span><span id="COMPsc.statistic-2546"><a href="#COMPsc.statistic-2546"><span class="linenos">2546</span></a>            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;FC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;factor&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
</span><span id="COMPsc.statistic-2547"><a href="#COMPsc.statistic-2547"><span class="linenos">2547</span></a>                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;factor&quot;</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2548"><a href="#COMPsc.statistic-2548"><span class="linenos">2548</span></a>            <span class="p">)</span>
</span><span id="COMPsc.statistic-2549"><a href="#COMPsc.statistic-2549"><span class="linenos">2549</span></a>            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;log(FC)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;FC&quot;</span><span class="p">])</span>
</span><span id="COMPsc.statistic-2550"><a href="#COMPsc.statistic-2550"><span class="linenos">2550</span></a>            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;norm_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2551"><a href="#COMPsc.statistic-2551"><span class="linenos">2551</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;factor&quot;</span><span class="p">])</span>
</span><span id="COMPsc.statistic-2552"><a href="#COMPsc.statistic-2552"><span class="linenos">2552</span></a>
</span><span id="COMPsc.statistic-2553"><a href="#COMPsc.statistic-2553"><span class="linenos">2553</span></a>            <span class="k">return</span> <span class="n">df</span>
</span><span id="COMPsc.statistic-2554"><a href="#COMPsc.statistic-2554"><span class="linenos">2554</span></a>
</span><span id="COMPsc.statistic-2555"><a href="#COMPsc.statistic-2555"><span class="linenos">2555</span></a>        <span class="n">choose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</span><span id="COMPsc.statistic-2556"><a href="#COMPsc.statistic-2556"><span class="linenos">2556</span></a>        <span class="n">factors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2557"><a href="#COMPsc.statistic-2557"><span class="linenos">2557</span></a>        <span class="n">factors</span><span class="p">[</span><span class="n">factors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">factors</span><span class="p">[</span><span class="n">factors</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="COMPsc.statistic-2558"><a href="#COMPsc.statistic-2558"><span class="linenos">2558</span></a>
</span><span id="COMPsc.statistic-2559"><a href="#COMPsc.statistic-2559"><span class="linenos">2559</span></a>        <span class="n">final_results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc.statistic-2560"><a href="#COMPsc.statistic-2560"><span class="linenos">2560</span></a>
</span><span id="COMPsc.statistic-2561"><a href="#COMPsc.statistic-2561"><span class="linenos">2561</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cells</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.statistic-2562"><a href="#COMPsc.statistic-2562"><span class="linenos">2562</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis started...</span><span class="se">\n</span><span class="s2">Comparing selected cells to the whole set...&quot;</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2563"><a href="#COMPsc.statistic-2563"><span class="linenos">2563</span></a>            <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc.statistic-2564"><a href="#COMPsc.statistic-2564"><span class="linenos">2564</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2565"><a href="#COMPsc.statistic-2565"><span class="linenos">2565</span></a>            <span class="p">)</span>
</span><span id="COMPsc.statistic-2566"><a href="#COMPsc.statistic-2566"><span class="linenos">2566</span></a>
</span><span id="COMPsc.statistic-2567"><a href="#COMPsc.statistic-2567"><span class="linenos">2567</span></a>            <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="COMPsc.statistic-2568"><a href="#COMPsc.statistic-2568"><span class="linenos">2568</span></a>                <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2569"><a href="#COMPsc.statistic-2569"><span class="linenos">2569</span></a>
</span><span id="COMPsc.statistic-2570"><a href="#COMPsc.statistic-2570"><span class="linenos">2570</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="COMPsc.statistic-2571"><a href="#COMPsc.statistic-2571"><span class="linenos">2571</span></a>                    <span class="s2">&quot;Not include the set info (name # set) in the &#39;cells&#39; list. &quot;</span>
</span><span id="COMPsc.statistic-2572"><a href="#COMPsc.statistic-2572"><span class="linenos">2572</span></a>                    <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="COMPsc.statistic-2573"><a href="#COMPsc.statistic-2573"><span class="linenos">2573</span></a>                <span class="p">)</span>
</span><span id="COMPsc.statistic-2574"><a href="#COMPsc.statistic-2574"><span class="linenos">2574</span></a>
</span><span id="COMPsc.statistic-2575"><a href="#COMPsc.statistic-2575"><span class="linenos">2575</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;target&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">cells</span> <span class="k">else</span> <span class="s2">&quot;rest&quot;</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2576"><a href="#COMPsc.statistic-2576"><span class="linenos">2576</span></a>            <span class="n">valid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="COMPsc.statistic-2577"><a href="#COMPsc.statistic-2577"><span class="linenos">2577</span></a>                <span class="nb">set</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">]])</span>
</span><span id="COMPsc.statistic-2578"><a href="#COMPsc.statistic-2578"><span class="linenos">2578</span></a>            <span class="p">)</span>
</span><span id="COMPsc.statistic-2579"><a href="#COMPsc.statistic-2579"><span class="linenos">2579</span></a>
</span><span id="COMPsc.statistic-2580"><a href="#COMPsc.statistic-2580"><span class="linenos">2580</span></a>            <span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span id="COMPsc.statistic-2581"><a href="#COMPsc.statistic-2581"><span class="linenos">2581</span></a>            <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2582"><a href="#COMPsc.statistic-2582"><span class="linenos">2582</span></a>
</span><span id="COMPsc.statistic-2583"><a href="#COMPsc.statistic-2583"><span class="linenos">2583</span></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="n">prepare_and_run_stat</span><span class="p">(</span>
</span><span id="COMPsc.statistic-2584"><a href="#COMPsc.statistic-2584"><span class="linenos">2584</span></a>                <span class="n">choose</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="COMPsc.statistic-2585"><a href="#COMPsc.statistic-2585"><span class="linenos">2585</span></a>                <span class="n">valid_group</span><span class="o">=</span><span class="n">valid</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2586"><a href="#COMPsc.statistic-2586"><span class="linenos">2586</span></a>                <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2587"><a href="#COMPsc.statistic-2587"><span class="linenos">2587</span></a>                <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2588"><a href="#COMPsc.statistic-2588"><span class="linenos">2588</span></a>                <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2589"><a href="#COMPsc.statistic-2589"><span class="linenos">2589</span></a>                <span class="n">factors</span><span class="o">=</span><span class="n">factors</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2590"><a href="#COMPsc.statistic-2590"><span class="linenos">2590</span></a>            <span class="p">)</span>
</span><span id="COMPsc.statistic-2591"><a href="#COMPsc.statistic-2591"><span class="linenos">2591</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;valid_cells&quot;</span><span class="p">:</span> <span class="n">valid</span><span class="p">,</span> <span class="s2">&quot;control_cells&quot;</span><span class="p">:</span> <span class="s2">&quot;rest&quot;</span><span class="p">,</span> <span class="s2">&quot;DEG&quot;</span><span class="p">:</span> <span class="n">result_df</span><span class="p">}</span>
</span><span id="COMPsc.statistic-2592"><a href="#COMPsc.statistic-2592"><span class="linenos">2592</span></a>
</span><span id="COMPsc.statistic-2593"><a href="#COMPsc.statistic-2593"><span class="linenos">2593</span></a>        <span class="k">elif</span> <span class="n">cells</span> <span class="o">==</span> <span class="s2">&quot;All&quot;</span> <span class="ow">and</span> <span class="n">sets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.statistic-2594"><a href="#COMPsc.statistic-2594"><span class="linenos">2594</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis started...</span><span class="se">\n</span><span class="s2">Comparing each type of cell to others...&quot;</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2595"><a href="#COMPsc.statistic-2595"><span class="linenos">2595</span></a>            <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc.statistic-2596"><a href="#COMPsc.statistic-2596"><span class="linenos">2596</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2597"><a href="#COMPsc.statistic-2597"><span class="linenos">2597</span></a>            <span class="p">)</span>
</span><span id="COMPsc.statistic-2598"><a href="#COMPsc.statistic-2598"><span class="linenos">2598</span></a>            <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2599"><a href="#COMPsc.statistic-2599"><span class="linenos">2599</span></a>
</span><span id="COMPsc.statistic-2600"><a href="#COMPsc.statistic-2600"><span class="linenos">2600</span></a>            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">):</span>
</span><span id="COMPsc.statistic-2601"><a href="#COMPsc.statistic-2601"><span class="linenos">2601</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calculating statistics for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2602"><a href="#COMPsc.statistic-2602"><span class="linenos">2602</span></a>                <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;target&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">label</span> <span class="k">else</span> <span class="s2">&quot;rest&quot;</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2603"><a href="#COMPsc.statistic-2603"><span class="linenos">2603</span></a>                <span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span id="COMPsc.statistic-2604"><a href="#COMPsc.statistic-2604"><span class="linenos">2604</span></a>                <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2605"><a href="#COMPsc.statistic-2605"><span class="linenos">2605</span></a>                <span class="n">result_df</span> <span class="o">=</span> <span class="n">prepare_and_run_stat</span><span class="p">(</span>
</span><span id="COMPsc.statistic-2606"><a href="#COMPsc.statistic-2606"><span class="linenos">2606</span></a>                    <span class="n">choose</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
</span><span id="COMPsc.statistic-2607"><a href="#COMPsc.statistic-2607"><span class="linenos">2607</span></a>                    <span class="n">valid_group</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2608"><a href="#COMPsc.statistic-2608"><span class="linenos">2608</span></a>                    <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2609"><a href="#COMPsc.statistic-2609"><span class="linenos">2609</span></a>                    <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2610"><a href="#COMPsc.statistic-2610"><span class="linenos">2610</span></a>                    <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2611"><a href="#COMPsc.statistic-2611"><span class="linenos">2611</span></a>                    <span class="n">factors</span><span class="o">=</span><span class="n">factors</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2612"><a href="#COMPsc.statistic-2612"><span class="linenos">2612</span></a>                <span class="p">)</span>
</span><span id="COMPsc.statistic-2613"><a href="#COMPsc.statistic-2613"><span class="linenos">2613</span></a>                <span class="n">final_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_df</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2614"><a href="#COMPsc.statistic-2614"><span class="linenos">2614</span></a>
</span><span id="COMPsc.statistic-2615"><a href="#COMPsc.statistic-2615"><span class="linenos">2615</span></a>            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">final_results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2616"><a href="#COMPsc.statistic-2616"><span class="linenos">2616</span></a>
</span><span id="COMPsc.statistic-2617"><a href="#COMPsc.statistic-2617"><span class="linenos">2617</span></a>        <span class="k">elif</span> <span class="n">cells</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sets</span> <span class="o">==</span> <span class="s2">&quot;All&quot;</span><span class="p">:</span>
</span><span id="COMPsc.statistic-2618"><a href="#COMPsc.statistic-2618"><span class="linenos">2618</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis started...</span><span class="se">\n</span><span class="s2">Comparing each set/group to others...&quot;</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2619"><a href="#COMPsc.statistic-2619"><span class="linenos">2619</span></a>            <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2620"><a href="#COMPsc.statistic-2620"><span class="linenos">2620</span></a>            <span class="n">unique_sets</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2621"><a href="#COMPsc.statistic-2621"><span class="linenos">2621</span></a>
</span><span id="COMPsc.statistic-2622"><a href="#COMPsc.statistic-2622"><span class="linenos">2622</span></a>            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">unique_sets</span><span class="p">):</span>
</span><span id="COMPsc.statistic-2623"><a href="#COMPsc.statistic-2623"><span class="linenos">2623</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calculating statistics for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2624"><a href="#COMPsc.statistic-2624"><span class="linenos">2624</span></a>                <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;target&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">label</span> <span class="k">else</span> <span class="s2">&quot;rest&quot;</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2625"><a href="#COMPsc.statistic-2625"><span class="linenos">2625</span></a>
</span><span id="COMPsc.statistic-2626"><a href="#COMPsc.statistic-2626"><span class="linenos">2626</span></a>                <span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span id="COMPsc.statistic-2627"><a href="#COMPsc.statistic-2627"><span class="linenos">2627</span></a>                <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2628"><a href="#COMPsc.statistic-2628"><span class="linenos">2628</span></a>                <span class="n">result_df</span> <span class="o">=</span> <span class="n">prepare_and_run_stat</span><span class="p">(</span>
</span><span id="COMPsc.statistic-2629"><a href="#COMPsc.statistic-2629"><span class="linenos">2629</span></a>                    <span class="n">choose</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
</span><span id="COMPsc.statistic-2630"><a href="#COMPsc.statistic-2630"><span class="linenos">2630</span></a>                    <span class="n">valid_group</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2631"><a href="#COMPsc.statistic-2631"><span class="linenos">2631</span></a>                    <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2632"><a href="#COMPsc.statistic-2632"><span class="linenos">2632</span></a>                    <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2633"><a href="#COMPsc.statistic-2633"><span class="linenos">2633</span></a>                    <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2634"><a href="#COMPsc.statistic-2634"><span class="linenos">2634</span></a>                    <span class="n">factors</span><span class="o">=</span><span class="n">factors</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2635"><a href="#COMPsc.statistic-2635"><span class="linenos">2635</span></a>                <span class="p">)</span>
</span><span id="COMPsc.statistic-2636"><a href="#COMPsc.statistic-2636"><span class="linenos">2636</span></a>                <span class="n">final_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_df</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2637"><a href="#COMPsc.statistic-2637"><span class="linenos">2637</span></a>
</span><span id="COMPsc.statistic-2638"><a href="#COMPsc.statistic-2638"><span class="linenos">2638</span></a>            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">final_results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2639"><a href="#COMPsc.statistic-2639"><span class="linenos">2639</span></a>
</span><span id="COMPsc.statistic-2640"><a href="#COMPsc.statistic-2640"><span class="linenos">2640</span></a>        <span class="k">elif</span> <span class="n">cells</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sets</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="COMPsc.statistic-2641"><a href="#COMPsc.statistic-2641"><span class="linenos">2641</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis started...</span><span class="se">\n</span><span class="s2">Comparing groups...&quot;</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2642"><a href="#COMPsc.statistic-2642"><span class="linenos">2642</span></a>
</span><span id="COMPsc.statistic-2643"><a href="#COMPsc.statistic-2643"><span class="linenos">2643</span></a>            <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2644"><a href="#COMPsc.statistic-2644"><span class="linenos">2644</span></a>
</span><span id="COMPsc.statistic-2645"><a href="#COMPsc.statistic-2645"><span class="linenos">2645</span></a>            <span class="n">group_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="COMPsc.statistic-2646"><a href="#COMPsc.statistic-2646"><span class="linenos">2646</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="COMPsc.statistic-2647"><a href="#COMPsc.statistic-2647"><span class="linenos">2647</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only pairwise group comparison is supported.&quot;</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2648"><a href="#COMPsc.statistic-2648"><span class="linenos">2648</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="COMPsc.statistic-2649"><a href="#COMPsc.statistic-2649"><span class="linenos">2649</span></a>
</span><span id="COMPsc.statistic-2650"><a href="#COMPsc.statistic-2650"><span class="linenos">2650</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc.statistic-2651"><a href="#COMPsc.statistic-2651"><span class="linenos">2651</span></a>                <span class="p">(</span>
</span><span id="COMPsc.statistic-2652"><a href="#COMPsc.statistic-2652"><span class="linenos">2652</span></a>                    <span class="s2">&quot;target&quot;</span>
</span><span id="COMPsc.statistic-2653"><a href="#COMPsc.statistic-2653"><span class="linenos">2653</span></a>                    <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">[</span><span class="n">group_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="COMPsc.statistic-2654"><a href="#COMPsc.statistic-2654"><span class="linenos">2654</span></a>                    <span class="k">else</span> <span class="s2">&quot;rest&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">[</span><span class="n">group_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">else</span> <span class="s2">&quot;drop&quot;</span>
</span><span id="COMPsc.statistic-2655"><a href="#COMPsc.statistic-2655"><span class="linenos">2655</span></a>                <span class="p">)</span>
</span><span id="COMPsc.statistic-2656"><a href="#COMPsc.statistic-2656"><span class="linenos">2656</span></a>                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">choose</span><span class="o">.</span><span class="n">index</span>
</span><span id="COMPsc.statistic-2657"><a href="#COMPsc.statistic-2657"><span class="linenos">2657</span></a>            <span class="p">]</span>
</span><span id="COMPsc.statistic-2658"><a href="#COMPsc.statistic-2658"><span class="linenos">2658</span></a>            <span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span id="COMPsc.statistic-2659"><a href="#COMPsc.statistic-2659"><span class="linenos">2659</span></a>            <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2660"><a href="#COMPsc.statistic-2660"><span class="linenos">2660</span></a>
</span><span id="COMPsc.statistic-2661"><a href="#COMPsc.statistic-2661"><span class="linenos">2661</span></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="n">prepare_and_run_stat</span><span class="p">(</span>
</span><span id="COMPsc.statistic-2662"><a href="#COMPsc.statistic-2662"><span class="linenos">2662</span></a>                <span class="n">choose</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="COMPsc.statistic-2663"><a href="#COMPsc.statistic-2663"><span class="linenos">2663</span></a>                <span class="n">valid_group</span><span class="o">=</span><span class="n">group_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="COMPsc.statistic-2664"><a href="#COMPsc.statistic-2664"><span class="linenos">2664</span></a>                <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2665"><a href="#COMPsc.statistic-2665"><span class="linenos">2665</span></a>                <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2666"><a href="#COMPsc.statistic-2666"><span class="linenos">2666</span></a>                <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2667"><a href="#COMPsc.statistic-2667"><span class="linenos">2667</span></a>                <span class="n">factors</span><span class="o">=</span><span class="n">factors</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2668"><a href="#COMPsc.statistic-2668"><span class="linenos">2668</span></a>            <span class="p">)</span>
</span><span id="COMPsc.statistic-2669"><a href="#COMPsc.statistic-2669"><span class="linenos">2669</span></a>            <span class="k">return</span> <span class="n">result_df</span>
</span><span id="COMPsc.statistic-2670"><a href="#COMPsc.statistic-2670"><span class="linenos">2670</span></a>
</span><span id="COMPsc.statistic-2671"><a href="#COMPsc.statistic-2671"><span class="linenos">2671</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cells</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.statistic-2672"><a href="#COMPsc.statistic-2672"><span class="linenos">2672</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis started...</span><span class="se">\n</span><span class="s2">Comparing groups...&quot;</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2673"><a href="#COMPsc.statistic-2673"><span class="linenos">2673</span></a>            <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc.statistic-2674"><a href="#COMPsc.statistic-2674"><span class="linenos">2674</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2675"><a href="#COMPsc.statistic-2675"><span class="linenos">2675</span></a>            <span class="p">)</span>
</span><span id="COMPsc.statistic-2676"><a href="#COMPsc.statistic-2676"><span class="linenos">2676</span></a>
</span><span id="COMPsc.statistic-2677"><a href="#COMPsc.statistic-2677"><span class="linenos">2677</span></a>            <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">cells</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="COMPsc.statistic-2678"><a href="#COMPsc.statistic-2678"><span class="linenos">2678</span></a>                <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2679"><a href="#COMPsc.statistic-2679"><span class="linenos">2679</span></a>
</span><span id="COMPsc.statistic-2680"><a href="#COMPsc.statistic-2680"><span class="linenos">2680</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="COMPsc.statistic-2681"><a href="#COMPsc.statistic-2681"><span class="linenos">2681</span></a>                    <span class="s2">&quot;Not include the set info (name # set) in the &#39;cells&#39; dict. &quot;</span>
</span><span id="COMPsc.statistic-2682"><a href="#COMPsc.statistic-2682"><span class="linenos">2682</span></a>                    <span class="s2">&quot;Only the names will be compared, without considering the set information.&quot;</span>
</span><span id="COMPsc.statistic-2683"><a href="#COMPsc.statistic-2683"><span class="linenos">2683</span></a>                <span class="p">)</span>
</span><span id="COMPsc.statistic-2684"><a href="#COMPsc.statistic-2684"><span class="linenos">2684</span></a>
</span><span id="COMPsc.statistic-2685"><a href="#COMPsc.statistic-2685"><span class="linenos">2685</span></a>            <span class="n">group_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cells</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="COMPsc.statistic-2686"><a href="#COMPsc.statistic-2686"><span class="linenos">2686</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="COMPsc.statistic-2687"><a href="#COMPsc.statistic-2687"><span class="linenos">2687</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only pairwise group comparison is supported.&quot;</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2688"><a href="#COMPsc.statistic-2688"><span class="linenos">2688</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="COMPsc.statistic-2689"><a href="#COMPsc.statistic-2689"><span class="linenos">2689</span></a>
</span><span id="COMPsc.statistic-2690"><a href="#COMPsc.statistic-2690"><span class="linenos">2690</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc.statistic-2691"><a href="#COMPsc.statistic-2691"><span class="linenos">2691</span></a>                <span class="p">(</span>
</span><span id="COMPsc.statistic-2692"><a href="#COMPsc.statistic-2692"><span class="linenos">2692</span></a>                    <span class="s2">&quot;target&quot;</span>
</span><span id="COMPsc.statistic-2693"><a href="#COMPsc.statistic-2693"><span class="linenos">2693</span></a>                    <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">[</span><span class="n">group_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="COMPsc.statistic-2694"><a href="#COMPsc.statistic-2694"><span class="linenos">2694</span></a>                    <span class="k">else</span> <span class="s2">&quot;rest&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">[</span><span class="n">group_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">else</span> <span class="s2">&quot;drop&quot;</span>
</span><span id="COMPsc.statistic-2695"><a href="#COMPsc.statistic-2695"><span class="linenos">2695</span></a>                <span class="p">)</span>
</span><span id="COMPsc.statistic-2696"><a href="#COMPsc.statistic-2696"><span class="linenos">2696</span></a>                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">choose</span><span class="o">.</span><span class="n">index</span>
</span><span id="COMPsc.statistic-2697"><a href="#COMPsc.statistic-2697"><span class="linenos">2697</span></a>            <span class="p">]</span>
</span><span id="COMPsc.statistic-2698"><a href="#COMPsc.statistic-2698"><span class="linenos">2698</span></a>
</span><span id="COMPsc.statistic-2699"><a href="#COMPsc.statistic-2699"><span class="linenos">2699</span></a>            <span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span id="COMPsc.statistic-2700"><a href="#COMPsc.statistic-2700"><span class="linenos">2700</span></a>            <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="COMPsc.statistic-2701"><a href="#COMPsc.statistic-2701"><span class="linenos">2701</span></a>
</span><span id="COMPsc.statistic-2702"><a href="#COMPsc.statistic-2702"><span class="linenos">2702</span></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="n">prepare_and_run_stat</span><span class="p">(</span>
</span><span id="COMPsc.statistic-2703"><a href="#COMPsc.statistic-2703"><span class="linenos">2703</span></a>                <span class="n">choose</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="COMPsc.statistic-2704"><a href="#COMPsc.statistic-2704"><span class="linenos">2704</span></a>                <span class="n">valid_group</span><span class="o">=</span><span class="n">group_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="COMPsc.statistic-2705"><a href="#COMPsc.statistic-2705"><span class="linenos">2705</span></a>                <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2706"><a href="#COMPsc.statistic-2706"><span class="linenos">2706</span></a>                <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2707"><a href="#COMPsc.statistic-2707"><span class="linenos">2707</span></a>                <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2708"><a href="#COMPsc.statistic-2708"><span class="linenos">2708</span></a>                <span class="n">factors</span><span class="o">=</span><span class="n">factors</span><span class="p">,</span>
</span><span id="COMPsc.statistic-2709"><a href="#COMPsc.statistic-2709"><span class="linenos">2709</span></a>            <span class="p">)</span>
</span><span id="COMPsc.statistic-2710"><a href="#COMPsc.statistic-2710"><span class="linenos">2710</span></a>
</span><span id="COMPsc.statistic-2711"><a href="#COMPsc.statistic-2711"><span class="linenos">2711</span></a>            <span class="k">return</span> <span class="n">result_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="COMPsc.statistic-2712"><a href="#COMPsc.statistic-2712"><span class="linenos">2712</span></a>
</span><span id="COMPsc.statistic-2713"><a href="#COMPsc.statistic-2713"><span class="linenos">2713</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.statistic-2714"><a href="#COMPsc.statistic-2714"><span class="linenos">2714</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc.statistic-2715"><a href="#COMPsc.statistic-2715"><span class="linenos">2715</span></a>                <span class="s2">&quot;You must specify either &#39;cells&#39; or &#39;sets&#39; (or both). None were provided, which is not allowed for this analysis.&quot;</span>
</span><span id="COMPsc.statistic-2716"><a href="#COMPsc.statistic-2716"><span class="linenos">2716</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compute per-feature statistics (Mann–Whitney U) comparing target vs rest.</p>

<p>This is a wrapper similar to <code>calc_DEG</code> tailored to use <code>self.normalized_data</code>
and <code>self.input_metadata</code>. It returns per-feature statistics including p-values,
adjusted p-values, means, variances, effect-size measures and fold-changes.</p>

<h2 id="parameters">Parameters</h2>

<p>cells : list, 'All', dict, or None
    Defines the target cells or groups for comparison (several modes supported).</p>

<p>sets : 'All', dict, or None
    Alternative grouping mode (operate on <code>self.input_metadata['sets']</code>).</p>

<p>min_exp : float, default 0.01
    Minimum expression threshold used when filtering features.</p>

<p>min_pct : float, default 0.1
    Minimum proportion of expressing cells in the target group required to test a feature.</p>

<p>n_proc : int, default 10
    Number of parallel jobs to use.</p>

<h2 id="returns">Returns</h2>

<p>pandas.DataFrame or dict
    Results DataFrame (or dict containing valid/control cells + DataFrame),
    similar to <code>calc_DEG</code> interface.</p>

<h2 id="raises">Raises</h2>

<p>ValueError
    If neither <code>cells</code> nor <code>sets</code> is provided, or input metadata mismatch occurs.</p>

<h2 id="notes">Notes</h2>

<p>Multiple modes supported: single-list entities, 'All', pairwise dicts, etc.</p>
</div>


                            </div>
                            <div id="COMPsc.calculate_difference_markers" class="classattr">
                                        <input id="COMPsc.calculate_difference_markers-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calculate_difference_markers</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">min_exp</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">min_pct</span><span class="o">=</span><span class="mf">0.25</span>, </span><span class="param"><span class="n">n_proc</span><span class="o">=</span><span class="mi">10</span>, </span><span class="param"><span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.calculate_difference_markers-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.calculate_difference_markers"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.calculate_difference_markers-2718"><a href="#COMPsc.calculate_difference_markers-2718"><span class="linenos">2718</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_difference_markers</span><span class="p">(</span>
</span><span id="COMPsc.calculate_difference_markers-2719"><a href="#COMPsc.calculate_difference_markers-2719"><span class="linenos">2719</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">min_exp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_pct</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="COMPsc.calculate_difference_markers-2720"><a href="#COMPsc.calculate_difference_markers-2720"><span class="linenos">2720</span></a>    <span class="p">):</span>
</span><span id="COMPsc.calculate_difference_markers-2721"><a href="#COMPsc.calculate_difference_markers-2721"><span class="linenos">2721</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.calculate_difference_markers-2722"><a href="#COMPsc.calculate_difference_markers-2722"><span class="linenos">2722</span></a><span class="sd">        Compute differential markers (var_data) if not already present.</span>
</span><span id="COMPsc.calculate_difference_markers-2723"><a href="#COMPsc.calculate_difference_markers-2723"><span class="linenos">2723</span></a>
</span><span id="COMPsc.calculate_difference_markers-2724"><a href="#COMPsc.calculate_difference_markers-2724"><span class="linenos">2724</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.calculate_difference_markers-2725"><a href="#COMPsc.calculate_difference_markers-2725"><span class="linenos">2725</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.calculate_difference_markers-2726"><a href="#COMPsc.calculate_difference_markers-2726"><span class="linenos">2726</span></a><span class="sd">        min_exp : float, default 0</span>
</span><span id="COMPsc.calculate_difference_markers-2727"><a href="#COMPsc.calculate_difference_markers-2727"><span class="linenos">2727</span></a><span class="sd">            Minimum expression threshold passed to `statistic`.</span>
</span><span id="COMPsc.calculate_difference_markers-2728"><a href="#COMPsc.calculate_difference_markers-2728"><span class="linenos">2728</span></a>
</span><span id="COMPsc.calculate_difference_markers-2729"><a href="#COMPsc.calculate_difference_markers-2729"><span class="linenos">2729</span></a><span class="sd">        min_pct : float, default 0.25</span>
</span><span id="COMPsc.calculate_difference_markers-2730"><a href="#COMPsc.calculate_difference_markers-2730"><span class="linenos">2730</span></a><span class="sd">            Minimum percent expressed in target group.</span>
</span><span id="COMPsc.calculate_difference_markers-2731"><a href="#COMPsc.calculate_difference_markers-2731"><span class="linenos">2731</span></a>
</span><span id="COMPsc.calculate_difference_markers-2732"><a href="#COMPsc.calculate_difference_markers-2732"><span class="linenos">2732</span></a><span class="sd">        n_proc : int, default 10</span>
</span><span id="COMPsc.calculate_difference_markers-2733"><a href="#COMPsc.calculate_difference_markers-2733"><span class="linenos">2733</span></a><span class="sd">            Parallel jobs.</span>
</span><span id="COMPsc.calculate_difference_markers-2734"><a href="#COMPsc.calculate_difference_markers-2734"><span class="linenos">2734</span></a>
</span><span id="COMPsc.calculate_difference_markers-2735"><a href="#COMPsc.calculate_difference_markers-2735"><span class="linenos">2735</span></a><span class="sd">        force : bool, default False</span>
</span><span id="COMPsc.calculate_difference_markers-2736"><a href="#COMPsc.calculate_difference_markers-2736"><span class="linenos">2736</span></a><span class="sd">            If True, recompute even if `self.var_data` is present.</span>
</span><span id="COMPsc.calculate_difference_markers-2737"><a href="#COMPsc.calculate_difference_markers-2737"><span class="linenos">2737</span></a>
</span><span id="COMPsc.calculate_difference_markers-2738"><a href="#COMPsc.calculate_difference_markers-2738"><span class="linenos">2738</span></a><span class="sd">        Update</span>
</span><span id="COMPsc.calculate_difference_markers-2739"><a href="#COMPsc.calculate_difference_markers-2739"><span class="linenos">2739</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.calculate_difference_markers-2740"><a href="#COMPsc.calculate_difference_markers-2740"><span class="linenos">2740</span></a><span class="sd">        Sets `self.var_data` to the result of `self.statistic(...)`.</span>
</span><span id="COMPsc.calculate_difference_markers-2741"><a href="#COMPsc.calculate_difference_markers-2741"><span class="linenos">2741</span></a>
</span><span id="COMPsc.calculate_difference_markers-2742"><a href="#COMPsc.calculate_difference_markers-2742"><span class="linenos">2742</span></a><span class="sd">        Raise</span>
</span><span id="COMPsc.calculate_difference_markers-2743"><a href="#COMPsc.calculate_difference_markers-2743"><span class="linenos">2743</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.calculate_difference_markers-2744"><a href="#COMPsc.calculate_difference_markers-2744"><span class="linenos">2744</span></a><span class="sd">        ValueError if already computed and `force` is False.</span>
</span><span id="COMPsc.calculate_difference_markers-2745"><a href="#COMPsc.calculate_difference_markers-2745"><span class="linenos">2745</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.calculate_difference_markers-2746"><a href="#COMPsc.calculate_difference_markers-2746"><span class="linenos">2746</span></a>
</span><span id="COMPsc.calculate_difference_markers-2747"><a href="#COMPsc.calculate_difference_markers-2747"><span class="linenos">2747</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
</span><span id="COMPsc.calculate_difference_markers-2748"><a href="#COMPsc.calculate_difference_markers-2748"><span class="linenos">2748</span></a>
</span><span id="COMPsc.calculate_difference_markers-2749"><a href="#COMPsc.calculate_difference_markers-2749"><span class="linenos">2749</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="p">(</span>
</span><span id="COMPsc.calculate_difference_markers-2750"><a href="#COMPsc.calculate_difference_markers-2750"><span class="linenos">2750</span></a>                <span class="n">cells</span><span class="o">=</span><span class="s2">&quot;All&quot;</span><span class="p">,</span> <span class="n">sets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span> <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span>
</span><span id="COMPsc.calculate_difference_markers-2751"><a href="#COMPsc.calculate_difference_markers-2751"><span class="linenos">2751</span></a>            <span class="p">)</span>
</span><span id="COMPsc.calculate_difference_markers-2752"><a href="#COMPsc.calculate_difference_markers-2752"><span class="linenos">2752</span></a>
</span><span id="COMPsc.calculate_difference_markers-2753"><a href="#COMPsc.calculate_difference_markers-2753"><span class="linenos">2753</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.calculate_difference_markers-2754"><a href="#COMPsc.calculate_difference_markers-2754"><span class="linenos">2754</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc.calculate_difference_markers-2755"><a href="#COMPsc.calculate_difference_markers-2755"><span class="linenos">2755</span></a>                <span class="s2">&quot;self.calculate_difference_markers() has already been executed. &quot;</span>
</span><span id="COMPsc.calculate_difference_markers-2756"><a href="#COMPsc.calculate_difference_markers-2756"><span class="linenos">2756</span></a>                <span class="s2">&quot;The results are stored in self.var. &quot;</span>
</span><span id="COMPsc.calculate_difference_markers-2757"><a href="#COMPsc.calculate_difference_markers-2757"><span class="linenos">2757</span></a>                <span class="s2">&quot;If you want to recalculate with different statistics, please rerun the method with force=True.&quot;</span>
</span><span id="COMPsc.calculate_difference_markers-2758"><a href="#COMPsc.calculate_difference_markers-2758"><span class="linenos">2758</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compute differential markers (var_data) if not already present.</p>

<h2 id="parameters">Parameters</h2>

<p>min_exp : float, default 0
    Minimum expression threshold passed to <code><a href="#COMPsc.statistic">statistic</a></code>.</p>

<p>min_pct : float, default 0.25
    Minimum percent expressed in target group.</p>

<p>n_proc : int, default 10
    Parallel jobs.</p>

<p>force : bool, default False
    If True, recompute even if <code>self.var_data</code> is present.</p>

<h2 id="update">Update</h2>

<p>Sets <code>self.var_data</code> to the result of <code>self.statistic(...)</code>.</p>

<h2 id="raise">Raise</h2>

<p>ValueError if already computed and <code>force</code> is False.</p>
</div>


                            </div>
                            <div id="COMPsc.clustering_features" class="classattr">
                                        <input id="COMPsc.clustering_features-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clustering_features</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">features_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cell_names&#39;</span>,</span><span class="param">	<span class="n">p_val</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span>,</span><span class="param">	<span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span>,</span><span class="param">	<span class="n">adj_mean</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.clustering_features-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.clustering_features"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.clustering_features-2760"><a href="#COMPsc.clustering_features-2760"><span class="linenos">2760</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clustering_features</span><span class="p">(</span>
</span><span id="COMPsc.clustering_features-2761"><a href="#COMPsc.clustering_features-2761"><span class="linenos">2761</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc.clustering_features-2762"><a href="#COMPsc.clustering_features-2762"><span class="linenos">2762</span></a>        <span class="n">features_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.clustering_features-2763"><a href="#COMPsc.clustering_features-2763"><span class="linenos">2763</span></a>        <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="COMPsc.clustering_features-2764"><a href="#COMPsc.clustering_features-2764"><span class="linenos">2764</span></a>        <span class="n">p_val</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
</span><span id="COMPsc.clustering_features-2765"><a href="#COMPsc.clustering_features-2765"><span class="linenos">2765</span></a>        <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
</span><span id="COMPsc.clustering_features-2766"><a href="#COMPsc.clustering_features-2766"><span class="linenos">2766</span></a>        <span class="n">adj_mean</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="COMPsc.clustering_features-2767"><a href="#COMPsc.clustering_features-2767"><span class="linenos">2767</span></a>        <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
</span><span id="COMPsc.clustering_features-2768"><a href="#COMPsc.clustering_features-2768"><span class="linenos">2768</span></a>    <span class="p">):</span>
</span><span id="COMPsc.clustering_features-2769"><a href="#COMPsc.clustering_features-2769"><span class="linenos">2769</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.clustering_features-2770"><a href="#COMPsc.clustering_features-2770"><span class="linenos">2770</span></a><span class="sd">        Prepare clustering input by selecting marker features and optionally smoothing cell values</span>
</span><span id="COMPsc.clustering_features-2771"><a href="#COMPsc.clustering_features-2771"><span class="linenos">2771</span></a><span class="sd">        toward group means.</span>
</span><span id="COMPsc.clustering_features-2772"><a href="#COMPsc.clustering_features-2772"><span class="linenos">2772</span></a>
</span><span id="COMPsc.clustering_features-2773"><a href="#COMPsc.clustering_features-2773"><span class="linenos">2773</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.clustering_features-2774"><a href="#COMPsc.clustering_features-2774"><span class="linenos">2774</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.clustering_features-2775"><a href="#COMPsc.clustering_features-2775"><span class="linenos">2775</span></a><span class="sd">        features_list : list or None</span>
</span><span id="COMPsc.clustering_features-2776"><a href="#COMPsc.clustering_features-2776"><span class="linenos">2776</span></a><span class="sd">            If provided, use this list of features. If None, features are selected</span>
</span><span id="COMPsc.clustering_features-2777"><a href="#COMPsc.clustering_features-2777"><span class="linenos">2777</span></a><span class="sd">            from `self.var_data` (adj_pval &lt;= p_val, positive logFC) picking `top_n` per group.</span>
</span><span id="COMPsc.clustering_features-2778"><a href="#COMPsc.clustering_features-2778"><span class="linenos">2778</span></a>
</span><span id="COMPsc.clustering_features-2779"><a href="#COMPsc.clustering_features-2779"><span class="linenos">2779</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="COMPsc.clustering_features-2780"><a href="#COMPsc.clustering_features-2780"><span class="linenos">2780</span></a><span class="sd">            Metadata column used for naming.</span>
</span><span id="COMPsc.clustering_features-2781"><a href="#COMPsc.clustering_features-2781"><span class="linenos">2781</span></a>
</span><span id="COMPsc.clustering_features-2782"><a href="#COMPsc.clustering_features-2782"><span class="linenos">2782</span></a><span class="sd">        p_val : float, default 0.05</span>
</span><span id="COMPsc.clustering_features-2783"><a href="#COMPsc.clustering_features-2783"><span class="linenos">2783</span></a><span class="sd">            Adjusted p-value cutoff when selecting features automatically.</span>
</span><span id="COMPsc.clustering_features-2784"><a href="#COMPsc.clustering_features-2784"><span class="linenos">2784</span></a>
</span><span id="COMPsc.clustering_features-2785"><a href="#COMPsc.clustering_features-2785"><span class="linenos">2785</span></a><span class="sd">        top_n : int, default 25</span>
</span><span id="COMPsc.clustering_features-2786"><a href="#COMPsc.clustering_features-2786"><span class="linenos">2786</span></a><span class="sd">            Number of top features per valid group to keep if `features_list` is None.</span>
</span><span id="COMPsc.clustering_features-2787"><a href="#COMPsc.clustering_features-2787"><span class="linenos">2787</span></a>
</span><span id="COMPsc.clustering_features-2788"><a href="#COMPsc.clustering_features-2788"><span class="linenos">2788</span></a><span class="sd">        adj_mean : bool, default True</span>
</span><span id="COMPsc.clustering_features-2789"><a href="#COMPsc.clustering_features-2789"><span class="linenos">2789</span></a><span class="sd">            If True, adjust cell values toward group means using `beta`.</span>
</span><span id="COMPsc.clustering_features-2790"><a href="#COMPsc.clustering_features-2790"><span class="linenos">2790</span></a>
</span><span id="COMPsc.clustering_features-2791"><a href="#COMPsc.clustering_features-2791"><span class="linenos">2791</span></a><span class="sd">        beta : float, default 0.2</span>
</span><span id="COMPsc.clustering_features-2792"><a href="#COMPsc.clustering_features-2792"><span class="linenos">2792</span></a><span class="sd">            Adjustment strength toward group mean.</span>
</span><span id="COMPsc.clustering_features-2793"><a href="#COMPsc.clustering_features-2793"><span class="linenos">2793</span></a>
</span><span id="COMPsc.clustering_features-2794"><a href="#COMPsc.clustering_features-2794"><span class="linenos">2794</span></a><span class="sd">        Update</span>
</span><span id="COMPsc.clustering_features-2795"><a href="#COMPsc.clustering_features-2795"><span class="linenos">2795</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.clustering_features-2796"><a href="#COMPsc.clustering_features-2796"><span class="linenos">2796</span></a><span class="sd">        Sets `self.clustering_data` and `self.clustering_metadata` to the selected subset,</span>
</span><span id="COMPsc.clustering_features-2797"><a href="#COMPsc.clustering_features-2797"><span class="linenos">2797</span></a><span class="sd">        ready for PCA/UMAP/clustering.</span>
</span><span id="COMPsc.clustering_features-2798"><a href="#COMPsc.clustering_features-2798"><span class="linenos">2798</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.clustering_features-2799"><a href="#COMPsc.clustering_features-2799"><span class="linenos">2799</span></a>
</span><span id="COMPsc.clustering_features-2800"><a href="#COMPsc.clustering_features-2800"><span class="linenos">2800</span></a>        <span class="k">if</span> <span class="n">features_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">features_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.clustering_features-2801"><a href="#COMPsc.clustering_features-2801"><span class="linenos">2801</span></a>
</span><span id="COMPsc.clustering_features-2802"><a href="#COMPsc.clustering_features-2802"><span class="linenos">2802</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.clustering_features-2803"><a href="#COMPsc.clustering_features-2803"><span class="linenos">2803</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc.clustering_features-2804"><a href="#COMPsc.clustering_features-2804"><span class="linenos">2804</span></a>                    <span class="s2">&quot;Lack of &#39;self.var_data&#39;. Use self.calculate_difference_markers() method first.&quot;</span>
</span><span id="COMPsc.clustering_features-2805"><a href="#COMPsc.clustering_features-2805"><span class="linenos">2805</span></a>                <span class="p">)</span>
</span><span id="COMPsc.clustering_features-2806"><a href="#COMPsc.clustering_features-2806"><span class="linenos">2806</span></a>
</span><span id="COMPsc.clustering_features-2807"><a href="#COMPsc.clustering_features-2807"><span class="linenos">2807</span></a>            <span class="n">df_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;adj_pval&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_val</span><span class="p">]</span>
</span><span id="COMPsc.clustering_features-2808"><a href="#COMPsc.clustering_features-2808"><span class="linenos">2808</span></a>            <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">df_tmp</span><span class="p">[</span><span class="n">df_tmp</span><span class="p">[</span><span class="s2">&quot;log(FC)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="COMPsc.clustering_features-2809"><a href="#COMPsc.clustering_features-2809"><span class="linenos">2809</span></a>            <span class="n">df_tmp</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc.clustering_features-2810"><a href="#COMPsc.clustering_features-2810"><span class="linenos">2810</span></a>                <span class="n">df_tmp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
</span><span id="COMPsc.clustering_features-2811"><a href="#COMPsc.clustering_features-2811"><span class="linenos">2811</span></a>                    <span class="p">[</span><span class="s2">&quot;valid_group&quot;</span><span class="p">,</span> <span class="s2">&quot;esm&quot;</span><span class="p">,</span> <span class="s2">&quot;log(FC)&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
</span><span id="COMPsc.clustering_features-2812"><a href="#COMPsc.clustering_features-2812"><span class="linenos">2812</span></a>                <span class="p">)</span>
</span><span id="COMPsc.clustering_features-2813"><a href="#COMPsc.clustering_features-2813"><span class="linenos">2813</span></a>                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;valid_group&quot;</span><span class="p">)</span>
</span><span id="COMPsc.clustering_features-2814"><a href="#COMPsc.clustering_features-2814"><span class="linenos">2814</span></a>                <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">top_n</span><span class="p">)</span>
</span><span id="COMPsc.clustering_features-2815"><a href="#COMPsc.clustering_features-2815"><span class="linenos">2815</span></a>            <span class="p">)</span>
</span><span id="COMPsc.clustering_features-2816"><a href="#COMPsc.clustering_features-2816"><span class="linenos">2816</span></a>
</span><span id="COMPsc.clustering_features-2817"><a href="#COMPsc.clustering_features-2817"><span class="linenos">2817</span></a>            <span class="n">feaures_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df_tmp</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">]))</span>
</span><span id="COMPsc.clustering_features-2818"><a href="#COMPsc.clustering_features-2818"><span class="linenos">2818</span></a>
</span><span id="COMPsc.clustering_features-2819"><a href="#COMPsc.clustering_features-2819"><span class="linenos">2819</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_partial_data</span><span class="p">(</span>
</span><span id="COMPsc.clustering_features-2820"><a href="#COMPsc.clustering_features-2820"><span class="linenos">2820</span></a>            <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">feaures_list</span><span class="p">,</span> <span class="n">name_slot</span><span class="o">=</span><span class="n">name_slot</span>
</span><span id="COMPsc.clustering_features-2821"><a href="#COMPsc.clustering_features-2821"><span class="linenos">2821</span></a>        <span class="p">)</span>
</span><span id="COMPsc.clustering_features-2822"><a href="#COMPsc.clustering_features-2822"><span class="linenos">2822</span></a>        <span class="n">data_avg</span> <span class="o">=</span> <span class="n">average</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="COMPsc.clustering_features-2823"><a href="#COMPsc.clustering_features-2823"><span class="linenos">2823</span></a>
</span><span id="COMPsc.clustering_features-2824"><a href="#COMPsc.clustering_features-2824"><span class="linenos">2824</span></a>        <span class="k">if</span> <span class="n">adj_mean</span><span class="p">:</span>
</span><span id="COMPsc.clustering_features-2825"><a href="#COMPsc.clustering_features-2825"><span class="linenos">2825</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">adjust_cells_to_group_mean</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">data_avg</span><span class="o">=</span><span class="n">data_avg</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">)</span>
</span><span id="COMPsc.clustering_features-2826"><a href="#COMPsc.clustering_features-2826"><span class="linenos">2826</span></a>
</span><span id="COMPsc.clustering_features-2827"><a href="#COMPsc.clustering_features-2827"><span class="linenos">2827</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_data</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="COMPsc.clustering_features-2828"><a href="#COMPsc.clustering_features-2828"><span class="linenos">2828</span></a>
</span><span id="COMPsc.clustering_features-2829"><a href="#COMPsc.clustering_features-2829"><span class="linenos">2829</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span>
</span></pre></div>


            <div class="docstring"><p>Prepare clustering input by selecting marker features and optionally smoothing cell values
toward group means.</p>

<h2 id="parameters">Parameters</h2>

<p>features_list : list or None
    If provided, use this list of features. If None, features are selected
    from <code>self.var_data</code> (adj_pval &lt;= p_val, positive logFC) picking <code>top_n</code> per group.</p>

<p>name_slot : str, default 'cell_names'
    Metadata column used for naming.</p>

<p>p_val : float, default 0.05
    Adjusted p-value cutoff when selecting features automatically.</p>

<p>top_n : int, default 25
    Number of top features per valid group to keep if <code>features_list</code> is None.</p>

<p>adj_mean : bool, default True
    If True, adjust cell values toward group means using <code>beta</code>.</p>

<p>beta : float, default 0.2
    Adjustment strength toward group mean.</p>

<h2 id="update">Update</h2>

<p>Sets <code>self.clustering_data</code> and <code>self.clustering_metadata</code> to the selected subset,
ready for PCA/UMAP/clustering.</p>
</div>


                            </div>
                            <div id="COMPsc.average" class="classattr">
                                        <input id="COMPsc.average-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">average</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.average-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.average"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.average-2831"><a href="#COMPsc.average-2831"><span class="linenos">2831</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">average</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="COMPsc.average-2832"><a href="#COMPsc.average-2832"><span class="linenos">2832</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.average-2833"><a href="#COMPsc.average-2833"><span class="linenos">2833</span></a><span class="sd">        Aggregate normalized data by (cell_name, set) pairs computing the mean per group.</span>
</span><span id="COMPsc.average-2834"><a href="#COMPsc.average-2834"><span class="linenos">2834</span></a>
</span><span id="COMPsc.average-2835"><a href="#COMPsc.average-2835"><span class="linenos">2835</span></a><span class="sd">        The method constructs new column names as &quot;cell_name # set&quot;, averages columns</span>
</span><span id="COMPsc.average-2836"><a href="#COMPsc.average-2836"><span class="linenos">2836</span></a><span class="sd">        sharing identical labels, and populates `self.agg_normalized_data` and `self.agg_metadata`.</span>
</span><span id="COMPsc.average-2837"><a href="#COMPsc.average-2837"><span class="linenos">2837</span></a>
</span><span id="COMPsc.average-2838"><a href="#COMPsc.average-2838"><span class="linenos">2838</span></a><span class="sd">        Update</span>
</span><span id="COMPsc.average-2839"><a href="#COMPsc.average-2839"><span class="linenos">2839</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.average-2840"><a href="#COMPsc.average-2840"><span class="linenos">2840</span></a><span class="sd">        Sets `self.agg_normalized_data` (features x aggregated samples) and</span>
</span><span id="COMPsc.average-2841"><a href="#COMPsc.average-2841"><span class="linenos">2841</span></a><span class="sd">        `self.agg_metadata` (DataFrame with &#39;cell_names&#39; and &#39;sets&#39;).</span>
</span><span id="COMPsc.average-2842"><a href="#COMPsc.average-2842"><span class="linenos">2842</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.average-2843"><a href="#COMPsc.average-2843"><span class="linenos">2843</span></a>
</span><span id="COMPsc.average-2844"><a href="#COMPsc.average-2844"><span class="linenos">2844</span></a>        <span class="n">wide_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span>
</span><span id="COMPsc.average-2845"><a href="#COMPsc.average-2845"><span class="linenos">2845</span></a>
</span><span id="COMPsc.average-2846"><a href="#COMPsc.average-2846"><span class="linenos">2846</span></a>        <span class="n">wide_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span>
</span><span id="COMPsc.average-2847"><a href="#COMPsc.average-2847"><span class="linenos">2847</span></a>
</span><span id="COMPsc.average-2848"><a href="#COMPsc.average-2848"><span class="linenos">2848</span></a>        <span class="n">new_names</span> <span class="o">=</span> <span class="n">wide_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="n">wide_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc.average-2849"><a href="#COMPsc.average-2849"><span class="linenos">2849</span></a>
</span><span id="COMPsc.average-2850"><a href="#COMPsc.average-2850"><span class="linenos">2850</span></a>        <span class="n">wide_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_names</span><span class="p">)</span>
</span><span id="COMPsc.average-2851"><a href="#COMPsc.average-2851"><span class="linenos">2851</span></a>
</span><span id="COMPsc.average-2852"><a href="#COMPsc.average-2852"><span class="linenos">2852</span></a>        <span class="n">aggregated_df</span> <span class="o">=</span> <span class="n">wide_data</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">wide_data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</span><span id="COMPsc.average-2853"><a href="#COMPsc.average-2853"><span class="linenos">2853</span></a>
</span><span id="COMPsc.average-2854"><a href="#COMPsc.average-2854"><span class="linenos">2854</span></a>        <span class="n">sets</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*# &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">aggregated_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc.average-2855"><a href="#COMPsc.average-2855"><span class="linenos">2855</span></a>        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; #.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">aggregated_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc.average-2856"><a href="#COMPsc.average-2856"><span class="linenos">2856</span></a>
</span><span id="COMPsc.average-2857"><a href="#COMPsc.average-2857"><span class="linenos">2857</span></a>        <span class="n">aggregated_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">names</span>
</span><span id="COMPsc.average-2858"><a href="#COMPsc.average-2858"><span class="linenos">2858</span></a>        <span class="n">aggregated_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;cell_names&quot;</span><span class="p">:</span> <span class="n">names</span><span class="p">,</span> <span class="s2">&quot;sets&quot;</span><span class="p">:</span> <span class="n">sets</span><span class="p">})</span>
</span><span id="COMPsc.average-2859"><a href="#COMPsc.average-2859"><span class="linenos">2859</span></a>
</span><span id="COMPsc.average-2860"><a href="#COMPsc.average-2860"><span class="linenos">2860</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span> <span class="o">=</span> <span class="n">aggregated_metadata</span>
</span><span id="COMPsc.average-2861"><a href="#COMPsc.average-2861"><span class="linenos">2861</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="o">=</span> <span class="n">aggregated_df</span>
</span></pre></div>


            <div class="docstring"><p>Aggregate normalized data by (cell_name, set) pairs computing the mean per group.</p>

<p>The method constructs new column names as "cell_name # set", averages columns
sharing identical labels, and populates <code>self.agg_normalized_data</code> and <code>self.agg_metadata</code>.</p>

<h2 id="update">Update</h2>

<p>Sets <code>self.agg_normalized_data</code> (features x aggregated samples) and
<code>self.agg_metadata</code> (DataFrame with 'cell_names' and 'sets').</p>
</div>


                            </div>
                            <div id="COMPsc.estimating_similarity" class="classattr">
                                        <input id="COMPsc.estimating_similarity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">estimating_similarity</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">method</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span>, </span><span class="param"><span class="n">p_val</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span>, </span><span class="param"><span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.estimating_similarity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.estimating_similarity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.estimating_similarity-2863"><a href="#COMPsc.estimating_similarity-2863"><span class="linenos">2863</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">estimating_similarity</span><span class="p">(</span>
</span><span id="COMPsc.estimating_similarity-2864"><a href="#COMPsc.estimating_similarity-2864"><span class="linenos">2864</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;pearson&quot;</span><span class="p">,</span> <span class="n">p_val</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span>
</span><span id="COMPsc.estimating_similarity-2865"><a href="#COMPsc.estimating_similarity-2865"><span class="linenos">2865</span></a>    <span class="p">):</span>
</span><span id="COMPsc.estimating_similarity-2866"><a href="#COMPsc.estimating_similarity-2866"><span class="linenos">2866</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.estimating_similarity-2867"><a href="#COMPsc.estimating_similarity-2867"><span class="linenos">2867</span></a><span class="sd">        Estimate pairwise similarity and Euclidean distance between aggregated samples.</span>
</span><span id="COMPsc.estimating_similarity-2868"><a href="#COMPsc.estimating_similarity-2868"><span class="linenos">2868</span></a>
</span><span id="COMPsc.estimating_similarity-2869"><a href="#COMPsc.estimating_similarity-2869"><span class="linenos">2869</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.estimating_similarity-2870"><a href="#COMPsc.estimating_similarity-2870"><span class="linenos">2870</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.estimating_similarity-2871"><a href="#COMPsc.estimating_similarity-2871"><span class="linenos">2871</span></a><span class="sd">        method : str, default &#39;pearson&#39;</span>
</span><span id="COMPsc.estimating_similarity-2872"><a href="#COMPsc.estimating_similarity-2872"><span class="linenos">2872</span></a><span class="sd">            Correlation method to use (passed to pandas.DataFrame.corr()).</span>
</span><span id="COMPsc.estimating_similarity-2873"><a href="#COMPsc.estimating_similarity-2873"><span class="linenos">2873</span></a>
</span><span id="COMPsc.estimating_similarity-2874"><a href="#COMPsc.estimating_similarity-2874"><span class="linenos">2874</span></a><span class="sd">        p_val : float, default 0.05</span>
</span><span id="COMPsc.estimating_similarity-2875"><a href="#COMPsc.estimating_similarity-2875"><span class="linenos">2875</span></a><span class="sd">            Adjusted p-value cutoff used to select marker features from `self.var_data`.</span>
</span><span id="COMPsc.estimating_similarity-2876"><a href="#COMPsc.estimating_similarity-2876"><span class="linenos">2876</span></a>
</span><span id="COMPsc.estimating_similarity-2877"><a href="#COMPsc.estimating_similarity-2877"><span class="linenos">2877</span></a><span class="sd">        top_n : int, default 25</span>
</span><span id="COMPsc.estimating_similarity-2878"><a href="#COMPsc.estimating_similarity-2878"><span class="linenos">2878</span></a><span class="sd">            Number of top features per valid group to include.</span>
</span><span id="COMPsc.estimating_similarity-2879"><a href="#COMPsc.estimating_similarity-2879"><span class="linenos">2879</span></a>
</span><span id="COMPsc.estimating_similarity-2880"><a href="#COMPsc.estimating_similarity-2880"><span class="linenos">2880</span></a><span class="sd">        Update</span>
</span><span id="COMPsc.estimating_similarity-2881"><a href="#COMPsc.estimating_similarity-2881"><span class="linenos">2881</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.estimating_similarity-2882"><a href="#COMPsc.estimating_similarity-2882"><span class="linenos">2882</span></a><span class="sd">        Computes a combined table with per-pair correlation and euclidean distance</span>
</span><span id="COMPsc.estimating_similarity-2883"><a href="#COMPsc.estimating_similarity-2883"><span class="linenos">2883</span></a><span class="sd">        and stores it in `self.similarity`.</span>
</span><span id="COMPsc.estimating_similarity-2884"><a href="#COMPsc.estimating_similarity-2884"><span class="linenos">2884</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.estimating_similarity-2885"><a href="#COMPsc.estimating_similarity-2885"><span class="linenos">2885</span></a>
</span><span id="COMPsc.estimating_similarity-2886"><a href="#COMPsc.estimating_similarity-2886"><span class="linenos">2886</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.estimating_similarity-2887"><a href="#COMPsc.estimating_similarity-2887"><span class="linenos">2887</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc.estimating_similarity-2888"><a href="#COMPsc.estimating_similarity-2888"><span class="linenos">2888</span></a>                <span class="s2">&quot;Lack of &#39;self.var_data&#39;. Use self.calculate_difference_markers() method first.&quot;</span>
</span><span id="COMPsc.estimating_similarity-2889"><a href="#COMPsc.estimating_similarity-2889"><span class="linenos">2889</span></a>            <span class="p">)</span>
</span><span id="COMPsc.estimating_similarity-2890"><a href="#COMPsc.estimating_similarity-2890"><span class="linenos">2890</span></a>
</span><span id="COMPsc.estimating_similarity-2891"><a href="#COMPsc.estimating_similarity-2891"><span class="linenos">2891</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.estimating_similarity-2892"><a href="#COMPsc.estimating_similarity-2892"><span class="linenos">2892</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
</span><span id="COMPsc.estimating_similarity-2893"><a href="#COMPsc.estimating_similarity-2893"><span class="linenos">2893</span></a>
</span><span id="COMPsc.estimating_similarity-2894"><a href="#COMPsc.estimating_similarity-2894"><span class="linenos">2894</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span>
</span><span id="COMPsc.estimating_similarity-2895"><a href="#COMPsc.estimating_similarity-2895"><span class="linenos">2895</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span>
</span><span id="COMPsc.estimating_similarity-2896"><a href="#COMPsc.estimating_similarity-2896"><span class="linenos">2896</span></a>
</span><span id="COMPsc.estimating_similarity-2897"><a href="#COMPsc.estimating_similarity-2897"><span class="linenos">2897</span></a>        <span class="n">df_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;adj_pval&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_val</span><span class="p">]</span>
</span><span id="COMPsc.estimating_similarity-2898"><a href="#COMPsc.estimating_similarity-2898"><span class="linenos">2898</span></a>        <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">df_tmp</span><span class="p">[</span><span class="n">df_tmp</span><span class="p">[</span><span class="s2">&quot;log(FC)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="COMPsc.estimating_similarity-2899"><a href="#COMPsc.estimating_similarity-2899"><span class="linenos">2899</span></a>        <span class="n">df_tmp</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc.estimating_similarity-2900"><a href="#COMPsc.estimating_similarity-2900"><span class="linenos">2900</span></a>            <span class="n">df_tmp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
</span><span id="COMPsc.estimating_similarity-2901"><a href="#COMPsc.estimating_similarity-2901"><span class="linenos">2901</span></a>                <span class="p">[</span><span class="s2">&quot;valid_group&quot;</span><span class="p">,</span> <span class="s2">&quot;esm&quot;</span><span class="p">,</span> <span class="s2">&quot;log(FC)&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
</span><span id="COMPsc.estimating_similarity-2902"><a href="#COMPsc.estimating_similarity-2902"><span class="linenos">2902</span></a>            <span class="p">)</span>
</span><span id="COMPsc.estimating_similarity-2903"><a href="#COMPsc.estimating_similarity-2903"><span class="linenos">2903</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;valid_group&quot;</span><span class="p">)</span>
</span><span id="COMPsc.estimating_similarity-2904"><a href="#COMPsc.estimating_similarity-2904"><span class="linenos">2904</span></a>            <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">top_n</span><span class="p">)</span>
</span><span id="COMPsc.estimating_similarity-2905"><a href="#COMPsc.estimating_similarity-2905"><span class="linenos">2905</span></a>        <span class="p">)</span>
</span><span id="COMPsc.estimating_similarity-2906"><a href="#COMPsc.estimating_similarity-2906"><span class="linenos">2906</span></a>
</span><span id="COMPsc.estimating_similarity-2907"><a href="#COMPsc.estimating_similarity-2907"><span class="linenos">2907</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df_tmp</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">]))]</span>
</span><span id="COMPsc.estimating_similarity-2908"><a href="#COMPsc.estimating_similarity-2908"><span class="linenos">2908</span></a>
</span><span id="COMPsc.estimating_similarity-2909"><a href="#COMPsc.estimating_similarity-2909"><span class="linenos">2909</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="COMPsc.estimating_similarity-2910"><a href="#COMPsc.estimating_similarity-2910"><span class="linenos">2910</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]]</span>
</span><span id="COMPsc.estimating_similarity-2911"><a href="#COMPsc.estimating_similarity-2911"><span class="linenos">2911</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.estimating_similarity-2912"><a href="#COMPsc.estimating_similarity-2912"><span class="linenos">2912</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="COMPsc.estimating_similarity-2913"><a href="#COMPsc.estimating_similarity-2913"><span class="linenos">2913</span></a>
</span><span id="COMPsc.estimating_similarity-2914"><a href="#COMPsc.estimating_similarity-2914"><span class="linenos">2914</span></a>        <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
</span><span id="COMPsc.estimating_similarity-2915"><a href="#COMPsc.estimating_similarity-2915"><span class="linenos">2915</span></a>
</span><span id="COMPsc.estimating_similarity-2916"><a href="#COMPsc.estimating_similarity-2916"><span class="linenos">2916</span></a>        <span class="n">scaled_data</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="COMPsc.estimating_similarity-2917"><a href="#COMPsc.estimating_similarity-2917"><span class="linenos">2917</span></a>
</span><span id="COMPsc.estimating_similarity-2918"><a href="#COMPsc.estimating_similarity-2918"><span class="linenos">2918</span></a>        <span class="n">scaled_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scaled_data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</span><span id="COMPsc.estimating_similarity-2919"><a href="#COMPsc.estimating_similarity-2919"><span class="linenos">2919</span></a>
</span><span id="COMPsc.estimating_similarity-2920"><a href="#COMPsc.estimating_similarity-2920"><span class="linenos">2920</span></a>        <span class="n">cor</span> <span class="o">=</span> <span class="n">scaled_df</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
</span><span id="COMPsc.estimating_similarity-2921"><a href="#COMPsc.estimating_similarity-2921"><span class="linenos">2921</span></a>        <span class="n">cor_df</span> <span class="o">=</span> <span class="n">cor</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="COMPsc.estimating_similarity-2922"><a href="#COMPsc.estimating_similarity-2922"><span class="linenos">2922</span></a>        <span class="n">cor_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">,</span> <span class="s2">&quot;cell2&quot;</span><span class="p">,</span> <span class="s2">&quot;correlation&quot;</span><span class="p">]</span>
</span><span id="COMPsc.estimating_similarity-2923"><a href="#COMPsc.estimating_similarity-2923"><span class="linenos">2923</span></a>
</span><span id="COMPsc.estimating_similarity-2924"><a href="#COMPsc.estimating_similarity-2924"><span class="linenos">2924</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="n">pdist</span><span class="p">(</span><span class="n">scaled_df</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;euclidean&quot;</span><span class="p">)</span>
</span><span id="COMPsc.estimating_similarity-2925"><a href="#COMPsc.estimating_similarity-2925"><span class="linenos">2925</span></a>        <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="COMPsc.estimating_similarity-2926"><a href="#COMPsc.estimating_similarity-2926"><span class="linenos">2926</span></a>            <span class="n">squareform</span><span class="p">(</span><span class="n">distances</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">scaled_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">scaled_df</span><span class="o">.</span><span class="n">columns</span>
</span><span id="COMPsc.estimating_similarity-2927"><a href="#COMPsc.estimating_similarity-2927"><span class="linenos">2927</span></a>        <span class="p">)</span>
</span><span id="COMPsc.estimating_similarity-2928"><a href="#COMPsc.estimating_similarity-2928"><span class="linenos">2928</span></a>        <span class="n">dist_df</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="COMPsc.estimating_similarity-2929"><a href="#COMPsc.estimating_similarity-2929"><span class="linenos">2929</span></a>        <span class="n">dist_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">,</span> <span class="s2">&quot;cell2&quot;</span><span class="p">,</span> <span class="s2">&quot;euclidean_dist&quot;</span><span class="p">]</span>
</span><span id="COMPsc.estimating_similarity-2930"><a href="#COMPsc.estimating_similarity-2930"><span class="linenos">2930</span></a>
</span><span id="COMPsc.estimating_similarity-2931"><a href="#COMPsc.estimating_similarity-2931"><span class="linenos">2931</span></a>        <span class="n">full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cor_df</span><span class="p">,</span> <span class="n">dist_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">,</span> <span class="s2">&quot;cell2&quot;</span><span class="p">])</span>
</span><span id="COMPsc.estimating_similarity-2932"><a href="#COMPsc.estimating_similarity-2932"><span class="linenos">2932</span></a>
</span><span id="COMPsc.estimating_similarity-2933"><a href="#COMPsc.estimating_similarity-2933"><span class="linenos">2933</span></a>        <span class="n">full</span> <span class="o">=</span> <span class="n">full</span><span class="p">[</span><span class="n">full</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">full</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]]</span>
</span><span id="COMPsc.estimating_similarity-2934"><a href="#COMPsc.estimating_similarity-2934"><span class="linenos">2934</span></a>        <span class="n">full</span> <span class="o">=</span> <span class="n">full</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="COMPsc.estimating_similarity-2935"><a href="#COMPsc.estimating_similarity-2935"><span class="linenos">2935</span></a>
</span><span id="COMPsc.estimating_similarity-2936"><a href="#COMPsc.estimating_similarity-2936"><span class="linenos">2936</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="o">=</span> <span class="n">full</span>
</span></pre></div>


            <div class="docstring"><p>Estimate pairwise similarity and Euclidean distance between aggregated samples.</p>

<h2 id="parameters">Parameters</h2>

<p>method : str, default 'pearson'
    Correlation method to use (passed to pandas.DataFrame.corr()).</p>

<p>p_val : float, default 0.05
    Adjusted p-value cutoff used to select marker features from <code>self.var_data</code>.</p>

<p>top_n : int, default 25
    Number of top features per valid group to include.</p>

<h2 id="update">Update</h2>

<p>Computes a combined table with per-pair correlation and euclidean distance
and stores it in <code>self.similarity</code>.</p>
</div>


                            </div>
                            <div id="COMPsc.similarity_plot" class="classattr">
                                        <input id="COMPsc.similarity_plot-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">similarity_plot</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">split_sets</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">set_info</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span>,</span><span class="param">	<span class="n">width</span><span class="o">=</span><span class="mi">12</span>,</span><span class="param">	<span class="n">height</span><span class="o">=</span><span class="mi">10</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.similarity_plot-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.similarity_plot"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.similarity_plot-2938"><a href="#COMPsc.similarity_plot-2938"><span class="linenos">2938</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">similarity_plot</span><span class="p">(</span>
</span><span id="COMPsc.similarity_plot-2939"><a href="#COMPsc.similarity_plot-2939"><span class="linenos">2939</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc.similarity_plot-2940"><a href="#COMPsc.similarity_plot-2940"><span class="linenos">2940</span></a>        <span class="n">split_sets</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="COMPsc.similarity_plot-2941"><a href="#COMPsc.similarity_plot-2941"><span class="linenos">2941</span></a>        <span class="n">set_info</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="COMPsc.similarity_plot-2942"><a href="#COMPsc.similarity_plot-2942"><span class="linenos">2942</span></a>        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;seismic&quot;</span><span class="p">,</span>
</span><span id="COMPsc.similarity_plot-2943"><a href="#COMPsc.similarity_plot-2943"><span class="linenos">2943</span></a>        <span class="n">width</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="COMPsc.similarity_plot-2944"><a href="#COMPsc.similarity_plot-2944"><span class="linenos">2944</span></a>        <span class="n">height</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="COMPsc.similarity_plot-2945"><a href="#COMPsc.similarity_plot-2945"><span class="linenos">2945</span></a>    <span class="p">):</span>
</span><span id="COMPsc.similarity_plot-2946"><a href="#COMPsc.similarity_plot-2946"><span class="linenos">2946</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.similarity_plot-2947"><a href="#COMPsc.similarity_plot-2947"><span class="linenos">2947</span></a><span class="sd">        Visualize pairwise similarity as a scatter plot.</span>
</span><span id="COMPsc.similarity_plot-2948"><a href="#COMPsc.similarity_plot-2948"><span class="linenos">2948</span></a>
</span><span id="COMPsc.similarity_plot-2949"><a href="#COMPsc.similarity_plot-2949"><span class="linenos">2949</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.similarity_plot-2950"><a href="#COMPsc.similarity_plot-2950"><span class="linenos">2950</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.similarity_plot-2951"><a href="#COMPsc.similarity_plot-2951"><span class="linenos">2951</span></a><span class="sd">        split_sets : bool, default True</span>
</span><span id="COMPsc.similarity_plot-2952"><a href="#COMPsc.similarity_plot-2952"><span class="linenos">2952</span></a><span class="sd">            If True and set information is present, split plotting area roughly into two halves to visualize cross-set pairs.</span>
</span><span id="COMPsc.similarity_plot-2953"><a href="#COMPsc.similarity_plot-2953"><span class="linenos">2953</span></a>
</span><span id="COMPsc.similarity_plot-2954"><a href="#COMPsc.similarity_plot-2954"><span class="linenos">2954</span></a><span class="sd">        set_info : bool, default True</span>
</span><span id="COMPsc.similarity_plot-2955"><a href="#COMPsc.similarity_plot-2955"><span class="linenos">2955</span></a><span class="sd">            If True, keep the &#39; # set&#39; annotation in labels; otherwise strip it.</span>
</span><span id="COMPsc.similarity_plot-2956"><a href="#COMPsc.similarity_plot-2956"><span class="linenos">2956</span></a>
</span><span id="COMPsc.similarity_plot-2957"><a href="#COMPsc.similarity_plot-2957"><span class="linenos">2957</span></a><span class="sd">        cmap : str, default &#39;seismic&#39;</span>
</span><span id="COMPsc.similarity_plot-2958"><a href="#COMPsc.similarity_plot-2958"><span class="linenos">2958</span></a><span class="sd">            Color map for correlation (hue).</span>
</span><span id="COMPsc.similarity_plot-2959"><a href="#COMPsc.similarity_plot-2959"><span class="linenos">2959</span></a>
</span><span id="COMPsc.similarity_plot-2960"><a href="#COMPsc.similarity_plot-2960"><span class="linenos">2960</span></a><span class="sd">        width : int, default 12</span>
</span><span id="COMPsc.similarity_plot-2961"><a href="#COMPsc.similarity_plot-2961"><span class="linenos">2961</span></a><span class="sd">            Figure width.</span>
</span><span id="COMPsc.similarity_plot-2962"><a href="#COMPsc.similarity_plot-2962"><span class="linenos">2962</span></a>
</span><span id="COMPsc.similarity_plot-2963"><a href="#COMPsc.similarity_plot-2963"><span class="linenos">2963</span></a><span class="sd">        height : int, default 10</span>
</span><span id="COMPsc.similarity_plot-2964"><a href="#COMPsc.similarity_plot-2964"><span class="linenos">2964</span></a><span class="sd">            Figure height.</span>
</span><span id="COMPsc.similarity_plot-2965"><a href="#COMPsc.similarity_plot-2965"><span class="linenos">2965</span></a>
</span><span id="COMPsc.similarity_plot-2966"><a href="#COMPsc.similarity_plot-2966"><span class="linenos">2966</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc.similarity_plot-2967"><a href="#COMPsc.similarity_plot-2967"><span class="linenos">2967</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.similarity_plot-2968"><a href="#COMPsc.similarity_plot-2968"><span class="linenos">2968</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc.similarity_plot-2969"><a href="#COMPsc.similarity_plot-2969"><span class="linenos">2969</span></a>
</span><span id="COMPsc.similarity_plot-2970"><a href="#COMPsc.similarity_plot-2970"><span class="linenos">2970</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc.similarity_plot-2971"><a href="#COMPsc.similarity_plot-2971"><span class="linenos">2971</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.similarity_plot-2972"><a href="#COMPsc.similarity_plot-2972"><span class="linenos">2972</span></a><span class="sd">        ValueError</span>
</span><span id="COMPsc.similarity_plot-2973"><a href="#COMPsc.similarity_plot-2973"><span class="linenos">2973</span></a><span class="sd">            If `self.similarity` is None.</span>
</span><span id="COMPsc.similarity_plot-2974"><a href="#COMPsc.similarity_plot-2974"><span class="linenos">2974</span></a>
</span><span id="COMPsc.similarity_plot-2975"><a href="#COMPsc.similarity_plot-2975"><span class="linenos">2975</span></a><span class="sd">        Notes</span>
</span><span id="COMPsc.similarity_plot-2976"><a href="#COMPsc.similarity_plot-2976"><span class="linenos">2976</span></a><span class="sd">        -----</span>
</span><span id="COMPsc.similarity_plot-2977"><a href="#COMPsc.similarity_plot-2977"><span class="linenos">2977</span></a><span class="sd">        The function filters pairs by z-scored euclidean distance &gt; 0 to focus on closer pairs.</span>
</span><span id="COMPsc.similarity_plot-2978"><a href="#COMPsc.similarity_plot-2978"><span class="linenos">2978</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.similarity_plot-2979"><a href="#COMPsc.similarity_plot-2979"><span class="linenos">2979</span></a>
</span><span id="COMPsc.similarity_plot-2980"><a href="#COMPsc.similarity_plot-2980"><span class="linenos">2980</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.similarity_plot-2981"><a href="#COMPsc.similarity_plot-2981"><span class="linenos">2981</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc.similarity_plot-2982"><a href="#COMPsc.similarity_plot-2982"><span class="linenos">2982</span></a>                <span class="s2">&quot;Similarity data is missing. Please calculate similarity using self.estimating_similarity.&quot;</span>
</span><span id="COMPsc.similarity_plot-2983"><a href="#COMPsc.similarity_plot-2983"><span class="linenos">2983</span></a>            <span class="p">)</span>
</span><span id="COMPsc.similarity_plot-2984"><a href="#COMPsc.similarity_plot-2984"><span class="linenos">2984</span></a>
</span><span id="COMPsc.similarity_plot-2985"><a href="#COMPsc.similarity_plot-2985"><span class="linenos">2985</span></a>        <span class="n">similarity_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span>
</span><span id="COMPsc.similarity_plot-2986"><a href="#COMPsc.similarity_plot-2986"><span class="linenos">2986</span></a>
</span><span id="COMPsc.similarity_plot-2987"><a href="#COMPsc.similarity_plot-2987"><span class="linenos">2987</span></a>        <span class="k">if</span> <span class="s2">&quot; # &quot;</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="COMPsc.similarity_plot-2988"><a href="#COMPsc.similarity_plot-2988"><span class="linenos">2988</span></a>            <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;set1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc.similarity_plot-2989"><a href="#COMPsc.similarity_plot-2989"><span class="linenos">2989</span></a>                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*# &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">]</span>
</span><span id="COMPsc.similarity_plot-2990"><a href="#COMPsc.similarity_plot-2990"><span class="linenos">2990</span></a>            <span class="p">]</span>
</span><span id="COMPsc.similarity_plot-2991"><a href="#COMPsc.similarity_plot-2991"><span class="linenos">2991</span></a>            <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;set2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc.similarity_plot-2992"><a href="#COMPsc.similarity_plot-2992"><span class="linenos">2992</span></a>                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*# &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]</span>
</span><span id="COMPsc.similarity_plot-2993"><a href="#COMPsc.similarity_plot-2993"><span class="linenos">2993</span></a>            <span class="p">]</span>
</span><span id="COMPsc.similarity_plot-2994"><a href="#COMPsc.similarity_plot-2994"><span class="linenos">2994</span></a>
</span><span id="COMPsc.similarity_plot-2995"><a href="#COMPsc.similarity_plot-2995"><span class="linenos">2995</span></a>        <span class="k">if</span> <span class="n">split_sets</span> <span class="ow">and</span> <span class="s2">&quot; # &quot;</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="COMPsc.similarity_plot-2996"><a href="#COMPsc.similarity_plot-2996"><span class="linenos">2996</span></a>            <span class="n">sets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="COMPsc.similarity_plot-2997"><a href="#COMPsc.similarity_plot-2997"><span class="linenos">2997</span></a>                <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;set1&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;set2&quot;</span><span class="p">]))</span>
</span><span id="COMPsc.similarity_plot-2998"><a href="#COMPsc.similarity_plot-2998"><span class="linenos">2998</span></a>            <span class="p">)</span>
</span><span id="COMPsc.similarity_plot-2999"><a href="#COMPsc.similarity_plot-2999"><span class="linenos">2999</span></a>
</span><span id="COMPsc.similarity_plot-3000"><a href="#COMPsc.similarity_plot-3000"><span class="linenos">3000</span></a>            <span class="n">mm</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="COMPsc.similarity_plot-3001"><a href="#COMPsc.similarity_plot-3001"><span class="linenos">3001</span></a>
</span><span id="COMPsc.similarity_plot-3002"><a href="#COMPsc.similarity_plot-3002"><span class="linenos">3002</span></a>            <span class="n">x_s</span> <span class="o">=</span> <span class="n">sets</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">mm</span><span class="p">]</span>
</span><span id="COMPsc.similarity_plot-3003"><a href="#COMPsc.similarity_plot-3003"><span class="linenos">3003</span></a>            <span class="n">y_s</span> <span class="o">=</span> <span class="n">sets</span><span class="p">[</span><span class="n">mm</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)]</span>
</span><span id="COMPsc.similarity_plot-3004"><a href="#COMPsc.similarity_plot-3004"><span class="linenos">3004</span></a>
</span><span id="COMPsc.similarity_plot-3005"><a href="#COMPsc.similarity_plot-3005"><span class="linenos">3005</span></a>            <span class="n">similarity_data</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="p">[</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;set1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">x_s</span><span class="p">)]</span>
</span><span id="COMPsc.similarity_plot-3006"><a href="#COMPsc.similarity_plot-3006"><span class="linenos">3006</span></a>            <span class="n">similarity_data</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="p">[</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;set2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">y_s</span><span class="p">)]</span>
</span><span id="COMPsc.similarity_plot-3007"><a href="#COMPsc.similarity_plot-3007"><span class="linenos">3007</span></a>
</span><span id="COMPsc.similarity_plot-3008"><a href="#COMPsc.similarity_plot-3008"><span class="linenos">3008</span></a>            <span class="n">similarity_data</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;set1&quot;</span><span class="p">,</span> <span class="s2">&quot;set2&quot;</span><span class="p">])</span>
</span><span id="COMPsc.similarity_plot-3009"><a href="#COMPsc.similarity_plot-3009"><span class="linenos">3009</span></a>
</span><span id="COMPsc.similarity_plot-3010"><a href="#COMPsc.similarity_plot-3010"><span class="linenos">3010</span></a>        <span class="k">if</span> <span class="n">set_info</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="s2">&quot; # &quot;</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="COMPsc.similarity_plot-3011"><a href="#COMPsc.similarity_plot-3011"><span class="linenos">3011</span></a>            <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc.similarity_plot-3012"><a href="#COMPsc.similarity_plot-3012"><span class="linenos">3012</span></a>                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; #.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">]</span>
</span><span id="COMPsc.similarity_plot-3013"><a href="#COMPsc.similarity_plot-3013"><span class="linenos">3013</span></a>            <span class="p">]</span>
</span><span id="COMPsc.similarity_plot-3014"><a href="#COMPsc.similarity_plot-3014"><span class="linenos">3014</span></a>            <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc.similarity_plot-3015"><a href="#COMPsc.similarity_plot-3015"><span class="linenos">3015</span></a>                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; #.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]</span>
</span><span id="COMPsc.similarity_plot-3016"><a href="#COMPsc.similarity_plot-3016"><span class="linenos">3016</span></a>            <span class="p">]</span>
</span><span id="COMPsc.similarity_plot-3017"><a href="#COMPsc.similarity_plot-3017"><span class="linenos">3017</span></a>
</span><span id="COMPsc.similarity_plot-3018"><a href="#COMPsc.similarity_plot-3018"><span class="linenos">3018</span></a>        <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;-euclidean_zscore&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">zscore</span><span class="p">(</span>
</span><span id="COMPsc.similarity_plot-3019"><a href="#COMPsc.similarity_plot-3019"><span class="linenos">3019</span></a>            <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;euclidean_dist&quot;</span><span class="p">]</span>
</span><span id="COMPsc.similarity_plot-3020"><a href="#COMPsc.similarity_plot-3020"><span class="linenos">3020</span></a>        <span class="p">)</span>
</span><span id="COMPsc.similarity_plot-3021"><a href="#COMPsc.similarity_plot-3021"><span class="linenos">3021</span></a>
</span><span id="COMPsc.similarity_plot-3022"><a href="#COMPsc.similarity_plot-3022"><span class="linenos">3022</span></a>        <span class="n">similarity_data</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="p">[</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;-euclidean_zscore&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="COMPsc.similarity_plot-3023"><a href="#COMPsc.similarity_plot-3023"><span class="linenos">3023</span></a>
</span><span id="COMPsc.similarity_plot-3024"><a href="#COMPsc.similarity_plot-3024"><span class="linenos">3024</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="COMPsc.similarity_plot-3025"><a href="#COMPsc.similarity_plot-3025"><span class="linenos">3025</span></a>        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
</span><span id="COMPsc.similarity_plot-3026"><a href="#COMPsc.similarity_plot-3026"><span class="linenos">3026</span></a>            <span class="n">data</span><span class="o">=</span><span class="n">similarity_data</span><span class="p">,</span>
</span><span id="COMPsc.similarity_plot-3027"><a href="#COMPsc.similarity_plot-3027"><span class="linenos">3027</span></a>            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;cell1&quot;</span><span class="p">,</span>
</span><span id="COMPsc.similarity_plot-3028"><a href="#COMPsc.similarity_plot-3028"><span class="linenos">3028</span></a>            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;cell2&quot;</span><span class="p">,</span>
</span><span id="COMPsc.similarity_plot-3029"><a href="#COMPsc.similarity_plot-3029"><span class="linenos">3029</span></a>            <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;correlation&quot;</span><span class="p">,</span>
</span><span id="COMPsc.similarity_plot-3030"><a href="#COMPsc.similarity_plot-3030"><span class="linenos">3030</span></a>            <span class="n">size</span><span class="o">=</span><span class="s2">&quot;-euclidean_zscore&quot;</span><span class="p">,</span>
</span><span id="COMPsc.similarity_plot-3031"><a href="#COMPsc.similarity_plot-3031"><span class="linenos">3031</span></a>            <span class="n">sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
</span><span id="COMPsc.similarity_plot-3032"><a href="#COMPsc.similarity_plot-3032"><span class="linenos">3032</span></a>            <span class="n">palette</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="COMPsc.similarity_plot-3033"><a href="#COMPsc.similarity_plot-3033"><span class="linenos">3033</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc.similarity_plot-3034"><a href="#COMPsc.similarity_plot-3034"><span class="linenos">3034</span></a>            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="COMPsc.similarity_plot-3035"><a href="#COMPsc.similarity_plot-3035"><span class="linenos">3035</span></a>        <span class="p">)</span>
</span><span id="COMPsc.similarity_plot-3036"><a href="#COMPsc.similarity_plot-3036"><span class="linenos">3036</span></a>
</span><span id="COMPsc.similarity_plot-3037"><a href="#COMPsc.similarity_plot-3037"><span class="linenos">3037</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
</span><span id="COMPsc.similarity_plot-3038"><a href="#COMPsc.similarity_plot-3038"><span class="linenos">3038</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="COMPsc.similarity_plot-3039"><a href="#COMPsc.similarity_plot-3039"><span class="linenos">3039</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Cell 1&quot;</span><span class="p">)</span>
</span><span id="COMPsc.similarity_plot-3040"><a href="#COMPsc.similarity_plot-3040"><span class="linenos">3040</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cell 2&quot;</span><span class="p">)</span>
</span><span id="COMPsc.similarity_plot-3041"><a href="#COMPsc.similarity_plot-3041"><span class="linenos">3041</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
</span><span id="COMPsc.similarity_plot-3042"><a href="#COMPsc.similarity_plot-3042"><span class="linenos">3042</span></a>
</span><span id="COMPsc.similarity_plot-3043"><a href="#COMPsc.similarity_plot-3043"><span class="linenos">3043</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
</span><span id="COMPsc.similarity_plot-3044"><a href="#COMPsc.similarity_plot-3044"><span class="linenos">3044</span></a>
</span><span id="COMPsc.similarity_plot-3045"><a href="#COMPsc.similarity_plot-3045"><span class="linenos">3045</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="COMPsc.similarity_plot-3046"><a href="#COMPsc.similarity_plot-3046"><span class="linenos">3046</span></a>
</span><span id="COMPsc.similarity_plot-3047"><a href="#COMPsc.similarity_plot-3047"><span class="linenos">3047</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span></pre></div>


            <div class="docstring"><p>Visualize pairwise similarity as a scatter plot.</p>

<h2 id="parameters">Parameters</h2>

<p>split_sets : bool, default True
    If True and set information is present, split plotting area roughly into two halves to visualize cross-set pairs.</p>

<p>set_info : bool, default True
    If True, keep the ' # set' annotation in labels; otherwise strip it.</p>

<p>cmap : str, default 'seismic'
    Color map for correlation (hue).</p>

<p>width : int, default 12
    Figure width.</p>

<p>height : int, default 10
    Figure height.</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.figure.Figure</p>

<h2 id="raises">Raises</h2>

<p>ValueError
    If <code>self.similarity</code> is None.</p>

<h2 id="notes">Notes</h2>

<p>The function filters pairs by z-scored euclidean distance &gt; 0 to focus on closer pairs.</p>
</div>


                            </div>
                            <div id="COMPsc.spatial_similarity" class="classattr">
                                        <input id="COMPsc.spatial_similarity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">spatial_similarity</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">set_info</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">bandwidth</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">n_neighbors</span><span class="o">=</span><span class="mi">5</span>,</span><span class="param">	<span class="n">min_dist</span><span class="o">=</span><span class="mf">0.1</span>,</span><span class="param">	<span class="n">legend_split</span><span class="o">=</span><span class="mi">2</span>,</span><span class="param">	<span class="n">point_size</span><span class="o">=</span><span class="mi">100</span>,</span><span class="param">	<span class="n">spread</span><span class="o">=</span><span class="mf">1.0</span>,</span><span class="param">	<span class="n">set_op_mix_ratio</span><span class="o">=</span><span class="mf">1.0</span>,</span><span class="param">	<span class="n">local_connectivity</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">repulsion_strength</span><span class="o">=</span><span class="mf">1.0</span>,</span><span class="param">	<span class="n">negative_sample_rate</span><span class="o">=</span><span class="mi">5</span>,</span><span class="param">	<span class="n">threshold</span><span class="o">=</span><span class="mf">0.1</span>,</span><span class="param">	<span class="n">width</span><span class="o">=</span><span class="mi">12</span>,</span><span class="param">	<span class="n">height</span><span class="o">=</span><span class="mi">10</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.spatial_similarity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.spatial_similarity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.spatial_similarity-3049"><a href="#COMPsc.spatial_similarity-3049"><span class="linenos">3049</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">spatial_similarity</span><span class="p">(</span>
</span><span id="COMPsc.spatial_similarity-3050"><a href="#COMPsc.spatial_similarity-3050"><span class="linenos">3050</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3051"><a href="#COMPsc.spatial_similarity-3051"><span class="linenos">3051</span></a>        <span class="n">set_info</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3052"><a href="#COMPsc.spatial_similarity-3052"><span class="linenos">3052</span></a>        <span class="n">bandwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3053"><a href="#COMPsc.spatial_similarity-3053"><span class="linenos">3053</span></a>        <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3054"><a href="#COMPsc.spatial_similarity-3054"><span class="linenos">3054</span></a>        <span class="n">min_dist</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3055"><a href="#COMPsc.spatial_similarity-3055"><span class="linenos">3055</span></a>        <span class="n">legend_split</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3056"><a href="#COMPsc.spatial_similarity-3056"><span class="linenos">3056</span></a>        <span class="n">point_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3057"><a href="#COMPsc.spatial_similarity-3057"><span class="linenos">3057</span></a>        <span class="n">spread</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3058"><a href="#COMPsc.spatial_similarity-3058"><span class="linenos">3058</span></a>        <span class="n">set_op_mix_ratio</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3059"><a href="#COMPsc.spatial_similarity-3059"><span class="linenos">3059</span></a>        <span class="n">local_connectivity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3060"><a href="#COMPsc.spatial_similarity-3060"><span class="linenos">3060</span></a>        <span class="n">repulsion_strength</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3061"><a href="#COMPsc.spatial_similarity-3061"><span class="linenos">3061</span></a>        <span class="n">negative_sample_rate</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3062"><a href="#COMPsc.spatial_similarity-3062"><span class="linenos">3062</span></a>        <span class="n">threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3063"><a href="#COMPsc.spatial_similarity-3063"><span class="linenos">3063</span></a>        <span class="n">width</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3064"><a href="#COMPsc.spatial_similarity-3064"><span class="linenos">3064</span></a>        <span class="n">height</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3065"><a href="#COMPsc.spatial_similarity-3065"><span class="linenos">3065</span></a>    <span class="p">):</span>
</span><span id="COMPsc.spatial_similarity-3066"><a href="#COMPsc.spatial_similarity-3066"><span class="linenos">3066</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.spatial_similarity-3067"><a href="#COMPsc.spatial_similarity-3067"><span class="linenos">3067</span></a><span class="sd">        Create a spatial UMAP-like visualization of similarity relationships between samples.</span>
</span><span id="COMPsc.spatial_similarity-3068"><a href="#COMPsc.spatial_similarity-3068"><span class="linenos">3068</span></a>
</span><span id="COMPsc.spatial_similarity-3069"><a href="#COMPsc.spatial_similarity-3069"><span class="linenos">3069</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.spatial_similarity-3070"><a href="#COMPsc.spatial_similarity-3070"><span class="linenos">3070</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.spatial_similarity-3071"><a href="#COMPsc.spatial_similarity-3071"><span class="linenos">3071</span></a><span class="sd">        set_info : bool, default True</span>
</span><span id="COMPsc.spatial_similarity-3072"><a href="#COMPsc.spatial_similarity-3072"><span class="linenos">3072</span></a><span class="sd">            If True, retain set information in labels.</span>
</span><span id="COMPsc.spatial_similarity-3073"><a href="#COMPsc.spatial_similarity-3073"><span class="linenos">3073</span></a>
</span><span id="COMPsc.spatial_similarity-3074"><a href="#COMPsc.spatial_similarity-3074"><span class="linenos">3074</span></a><span class="sd">        bandwidth : float, default 1</span>
</span><span id="COMPsc.spatial_similarity-3075"><a href="#COMPsc.spatial_similarity-3075"><span class="linenos">3075</span></a><span class="sd">            Bandwidth used by MeanShift for clustering polygons.</span>
</span><span id="COMPsc.spatial_similarity-3076"><a href="#COMPsc.spatial_similarity-3076"><span class="linenos">3076</span></a>
</span><span id="COMPsc.spatial_similarity-3077"><a href="#COMPsc.spatial_similarity-3077"><span class="linenos">3077</span></a><span class="sd">        point_size : float, default 100</span>
</span><span id="COMPsc.spatial_similarity-3078"><a href="#COMPsc.spatial_similarity-3078"><span class="linenos">3078</span></a><span class="sd">            Size of scatter points.</span>
</span><span id="COMPsc.spatial_similarity-3079"><a href="#COMPsc.spatial_similarity-3079"><span class="linenos">3079</span></a>
</span><span id="COMPsc.spatial_similarity-3080"><a href="#COMPsc.spatial_similarity-3080"><span class="linenos">3080</span></a><span class="sd">        legend_split : int, default 2</span>
</span><span id="COMPsc.spatial_similarity-3081"><a href="#COMPsc.spatial_similarity-3081"><span class="linenos">3081</span></a><span class="sd">            Number of columns in legend.</span>
</span><span id="COMPsc.spatial_similarity-3082"><a href="#COMPsc.spatial_similarity-3082"><span class="linenos">3082</span></a>
</span><span id="COMPsc.spatial_similarity-3083"><a href="#COMPsc.spatial_similarity-3083"><span class="linenos">3083</span></a><span class="sd">        n_neighbors, min_dist, spread, set_op_mix_ratio, local_connectivity, repulsion_strength, negative_sample_rate : parameters passed to UMAP.</span>
</span><span id="COMPsc.spatial_similarity-3084"><a href="#COMPsc.spatial_similarity-3084"><span class="linenos">3084</span></a>
</span><span id="COMPsc.spatial_similarity-3085"><a href="#COMPsc.spatial_similarity-3085"><span class="linenos">3085</span></a><span class="sd">        threshold : float, default 0.1</span>
</span><span id="COMPsc.spatial_similarity-3086"><a href="#COMPsc.spatial_similarity-3086"><span class="linenos">3086</span></a><span class="sd">            Minimum text distance for label adjustment to avoid overlap.</span>
</span><span id="COMPsc.spatial_similarity-3087"><a href="#COMPsc.spatial_similarity-3087"><span class="linenos">3087</span></a>
</span><span id="COMPsc.spatial_similarity-3088"><a href="#COMPsc.spatial_similarity-3088"><span class="linenos">3088</span></a><span class="sd">        width : int, default 12</span>
</span><span id="COMPsc.spatial_similarity-3089"><a href="#COMPsc.spatial_similarity-3089"><span class="linenos">3089</span></a><span class="sd">            Figure width.</span>
</span><span id="COMPsc.spatial_similarity-3090"><a href="#COMPsc.spatial_similarity-3090"><span class="linenos">3090</span></a>
</span><span id="COMPsc.spatial_similarity-3091"><a href="#COMPsc.spatial_similarity-3091"><span class="linenos">3091</span></a><span class="sd">        height : int, default 10</span>
</span><span id="COMPsc.spatial_similarity-3092"><a href="#COMPsc.spatial_similarity-3092"><span class="linenos">3092</span></a><span class="sd">            Figure height.</span>
</span><span id="COMPsc.spatial_similarity-3093"><a href="#COMPsc.spatial_similarity-3093"><span class="linenos">3093</span></a>
</span><span id="COMPsc.spatial_similarity-3094"><a href="#COMPsc.spatial_similarity-3094"><span class="linenos">3094</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc.spatial_similarity-3095"><a href="#COMPsc.spatial_similarity-3095"><span class="linenos">3095</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.spatial_similarity-3096"><a href="#COMPsc.spatial_similarity-3096"><span class="linenos">3096</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc.spatial_similarity-3097"><a href="#COMPsc.spatial_similarity-3097"><span class="linenos">3097</span></a>
</span><span id="COMPsc.spatial_similarity-3098"><a href="#COMPsc.spatial_similarity-3098"><span class="linenos">3098</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc.spatial_similarity-3099"><a href="#COMPsc.spatial_similarity-3099"><span class="linenos">3099</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.spatial_similarity-3100"><a href="#COMPsc.spatial_similarity-3100"><span class="linenos">3100</span></a><span class="sd">        ValueError</span>
</span><span id="COMPsc.spatial_similarity-3101"><a href="#COMPsc.spatial_similarity-3101"><span class="linenos">3101</span></a><span class="sd">            If `self.similarity` is None.</span>
</span><span id="COMPsc.spatial_similarity-3102"><a href="#COMPsc.spatial_similarity-3102"><span class="linenos">3102</span></a>
</span><span id="COMPsc.spatial_similarity-3103"><a href="#COMPsc.spatial_similarity-3103"><span class="linenos">3103</span></a><span class="sd">        Notes</span>
</span><span id="COMPsc.spatial_similarity-3104"><a href="#COMPsc.spatial_similarity-3104"><span class="linenos">3104</span></a><span class="sd">        -----</span>
</span><span id="COMPsc.spatial_similarity-3105"><a href="#COMPsc.spatial_similarity-3105"><span class="linenos">3105</span></a><span class="sd">        Builds a precomputed distance matrix combining correlation and euclidean distance,</span>
</span><span id="COMPsc.spatial_similarity-3106"><a href="#COMPsc.spatial_similarity-3106"><span class="linenos">3106</span></a><span class="sd">        runs UMAP with metric=&#39;precomputed&#39;, then overlays cluster hulls (MeanShift + convex hull)</span>
</span><span id="COMPsc.spatial_similarity-3107"><a href="#COMPsc.spatial_similarity-3107"><span class="linenos">3107</span></a><span class="sd">        and arrows to indicate nearest neighbors (minimal combined distance).</span>
</span><span id="COMPsc.spatial_similarity-3108"><a href="#COMPsc.spatial_similarity-3108"><span class="linenos">3108</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.spatial_similarity-3109"><a href="#COMPsc.spatial_similarity-3109"><span class="linenos">3109</span></a>
</span><span id="COMPsc.spatial_similarity-3110"><a href="#COMPsc.spatial_similarity-3110"><span class="linenos">3110</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.spatial_similarity-3111"><a href="#COMPsc.spatial_similarity-3111"><span class="linenos">3111</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc.spatial_similarity-3112"><a href="#COMPsc.spatial_similarity-3112"><span class="linenos">3112</span></a>                <span class="s2">&quot;Similarity data is missing. Please calculate similarity using self.estimating_similarity.&quot;</span>
</span><span id="COMPsc.spatial_similarity-3113"><a href="#COMPsc.spatial_similarity-3113"><span class="linenos">3113</span></a>            <span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3114"><a href="#COMPsc.spatial_similarity-3114"><span class="linenos">3114</span></a>
</span><span id="COMPsc.spatial_similarity-3115"><a href="#COMPsc.spatial_similarity-3115"><span class="linenos">3115</span></a>        <span class="n">similarity_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span>
</span><span id="COMPsc.spatial_similarity-3116"><a href="#COMPsc.spatial_similarity-3116"><span class="linenos">3116</span></a>
</span><span id="COMPsc.spatial_similarity-3117"><a href="#COMPsc.spatial_similarity-3117"><span class="linenos">3117</span></a>        <span class="n">sim</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;correlation&quot;</span><span class="p">]</span>
</span><span id="COMPsc.spatial_similarity-3118"><a href="#COMPsc.spatial_similarity-3118"><span class="linenos">3118</span></a>        <span class="n">sim_scaled</span> <span class="o">=</span> <span class="p">(</span><span class="n">sim</span> <span class="o">-</span> <span class="n">sim</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">sim</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</span><span id="COMPsc.spatial_similarity-3119"><a href="#COMPsc.spatial_similarity-3119"><span class="linenos">3119</span></a>        <span class="n">eu_dist</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;euclidean_dist&quot;</span><span class="p">]</span>
</span><span id="COMPsc.spatial_similarity-3120"><a href="#COMPsc.spatial_similarity-3120"><span class="linenos">3120</span></a>        <span class="n">eu_dist_scaled</span> <span class="o">=</span> <span class="p">(</span><span class="n">eu_dist</span> <span class="o">-</span> <span class="n">eu_dist</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">eu_dist</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">eu_dist</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</span><span id="COMPsc.spatial_similarity-3121"><a href="#COMPsc.spatial_similarity-3121"><span class="linenos">3121</span></a>
</span><span id="COMPsc.spatial_similarity-3122"><a href="#COMPsc.spatial_similarity-3122"><span class="linenos">3122</span></a>        <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;combo_dist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sim_scaled</span><span class="p">)</span> <span class="o">*</span> <span class="n">eu_dist_scaled</span>
</span><span id="COMPsc.spatial_similarity-3123"><a href="#COMPsc.spatial_similarity-3123"><span class="linenos">3123</span></a>
</span><span id="COMPsc.spatial_similarity-3124"><a href="#COMPsc.spatial_similarity-3124"><span class="linenos">3124</span></a>        <span class="c1"># for nn target</span>
</span><span id="COMPsc.spatial_similarity-3125"><a href="#COMPsc.spatial_similarity-3125"><span class="linenos">3125</span></a>        <span class="n">arrow_df</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="COMPsc.spatial_similarity-3126"><a href="#COMPsc.spatial_similarity-3126"><span class="linenos">3126</span></a>        <span class="n">arrow_df</span> <span class="o">=</span> <span class="n">similarity_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
</span><span id="COMPsc.spatial_similarity-3127"><a href="#COMPsc.spatial_similarity-3127"><span class="linenos">3127</span></a>            <span class="n">similarity_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;cell1&quot;</span><span class="p">)[</span><span class="s2">&quot;combo_dist&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
</span><span id="COMPsc.spatial_similarity-3128"><a href="#COMPsc.spatial_similarity-3128"><span class="linenos">3128</span></a>        <span class="p">]</span>
</span><span id="COMPsc.spatial_similarity-3129"><a href="#COMPsc.spatial_similarity-3129"><span class="linenos">3129</span></a>
</span><span id="COMPsc.spatial_similarity-3130"><a href="#COMPsc.spatial_similarity-3130"><span class="linenos">3130</span></a>        <span class="n">cells</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">])</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]))</span>
</span><span id="COMPsc.spatial_similarity-3131"><a href="#COMPsc.spatial_similarity-3131"><span class="linenos">3131</span></a>        <span class="n">combo_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">cells</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cells</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3132"><a href="#COMPsc.spatial_similarity-3132"><span class="linenos">3132</span></a>
</span><span id="COMPsc.spatial_similarity-3133"><a href="#COMPsc.spatial_similarity-3133"><span class="linenos">3133</span></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="COMPsc.spatial_similarity-3134"><a href="#COMPsc.spatial_similarity-3134"><span class="linenos">3134</span></a>            <span class="n">combo_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;combo_dist&quot;</span><span class="p">]</span>
</span><span id="COMPsc.spatial_similarity-3135"><a href="#COMPsc.spatial_similarity-3135"><span class="linenos">3135</span></a>            <span class="n">combo_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;combo_dist&quot;</span><span class="p">]</span>
</span><span id="COMPsc.spatial_similarity-3136"><a href="#COMPsc.spatial_similarity-3136"><span class="linenos">3136</span></a>
</span><span id="COMPsc.spatial_similarity-3137"><a href="#COMPsc.spatial_similarity-3137"><span class="linenos">3137</span></a>        <span class="n">umap_model</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">UMAP</span><span class="p">(</span>
</span><span id="COMPsc.spatial_similarity-3138"><a href="#COMPsc.spatial_similarity-3138"><span class="linenos">3138</span></a>            <span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3139"><a href="#COMPsc.spatial_similarity-3139"><span class="linenos">3139</span></a>            <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;precomputed&quot;</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3140"><a href="#COMPsc.spatial_similarity-3140"><span class="linenos">3140</span></a>            <span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3141"><a href="#COMPsc.spatial_similarity-3141"><span class="linenos">3141</span></a>            <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3142"><a href="#COMPsc.spatial_similarity-3142"><span class="linenos">3142</span></a>            <span class="n">spread</span><span class="o">=</span><span class="n">spread</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3143"><a href="#COMPsc.spatial_similarity-3143"><span class="linenos">3143</span></a>            <span class="n">set_op_mix_ratio</span><span class="o">=</span><span class="n">set_op_mix_ratio</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3144"><a href="#COMPsc.spatial_similarity-3144"><span class="linenos">3144</span></a>            <span class="n">local_connectivity</span><span class="o">=</span><span class="n">set_op_mix_ratio</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3145"><a href="#COMPsc.spatial_similarity-3145"><span class="linenos">3145</span></a>            <span class="n">repulsion_strength</span><span class="o">=</span><span class="n">repulsion_strength</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3146"><a href="#COMPsc.spatial_similarity-3146"><span class="linenos">3146</span></a>            <span class="n">negative_sample_rate</span><span class="o">=</span><span class="n">negative_sample_rate</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3147"><a href="#COMPsc.spatial_similarity-3147"><span class="linenos">3147</span></a>            <span class="n">transform_seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3148"><a href="#COMPsc.spatial_similarity-3148"><span class="linenos">3148</span></a>            <span class="n">init</span><span class="o">=</span><span class="s2">&quot;spectral&quot;</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3149"><a href="#COMPsc.spatial_similarity-3149"><span class="linenos">3149</span></a>            <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3150"><a href="#COMPsc.spatial_similarity-3150"><span class="linenos">3150</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3151"><a href="#COMPsc.spatial_similarity-3151"><span class="linenos">3151</span></a>        <span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3152"><a href="#COMPsc.spatial_similarity-3152"><span class="linenos">3152</span></a>
</span><span id="COMPsc.spatial_similarity-3153"><a href="#COMPsc.spatial_similarity-3153"><span class="linenos">3153</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">umap_model</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">combo_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3154"><a href="#COMPsc.spatial_similarity-3154"><span class="linenos">3154</span></a>        <span class="n">cell_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combo_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3155"><a href="#COMPsc.spatial_similarity-3155"><span class="linenos">3155</span></a>        <span class="n">num_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_names</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3156"><a href="#COMPsc.spatial_similarity-3156"><span class="linenos">3156</span></a>        <span class="n">palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;tab20c&quot;</span><span class="p">,</span> <span class="n">num_cells</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3157"><a href="#COMPsc.spatial_similarity-3157"><span class="linenos">3157</span></a>
</span><span id="COMPsc.spatial_similarity-3158"><a href="#COMPsc.spatial_similarity-3158"><span class="linenos">3158</span></a>        <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">in</span> <span class="n">cell_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="COMPsc.spatial_similarity-3159"><a href="#COMPsc.spatial_similarity-3159"><span class="linenos">3159</span></a>            <span class="n">avsets</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
</span><span id="COMPsc.spatial_similarity-3160"><a href="#COMPsc.spatial_similarity-3160"><span class="linenos">3160</span></a>                <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*# &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">]]</span>
</span><span id="COMPsc.spatial_similarity-3161"><a href="#COMPsc.spatial_similarity-3161"><span class="linenos">3161</span></a>                <span class="o">+</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*# &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">]]</span>
</span><span id="COMPsc.spatial_similarity-3162"><a href="#COMPsc.spatial_similarity-3162"><span class="linenos">3162</span></a>            <span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3163"><a href="#COMPsc.spatial_similarity-3163"><span class="linenos">3163</span></a>            <span class="n">num_sets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">avsets</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3164"><a href="#COMPsc.spatial_similarity-3164"><span class="linenos">3164</span></a>            <span class="n">color_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span> <span class="o">//</span> <span class="n">num_sets</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sets</span><span class="p">)]</span>
</span><span id="COMPsc.spatial_similarity-3165"><a href="#COMPsc.spatial_similarity-3165"><span class="linenos">3165</span></a>            <span class="n">color_mapping_sets</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="COMPsc.spatial_similarity-3166"><a href="#COMPsc.spatial_similarity-3166"><span class="linenos">3166</span></a>                <span class="n">set_name</span><span class="p">:</span> <span class="n">palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">set_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">color_indices</span><span class="p">,</span> <span class="n">avsets</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3167"><a href="#COMPsc.spatial_similarity-3167"><span class="linenos">3167</span></a>            <span class="p">}</span>
</span><span id="COMPsc.spatial_similarity-3168"><a href="#COMPsc.spatial_similarity-3168"><span class="linenos">3168</span></a>            <span class="n">color_mapping</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="COMPsc.spatial_similarity-3169"><a href="#COMPsc.spatial_similarity-3169"><span class="linenos">3169</span></a>                <span class="n">name</span><span class="p">:</span> <span class="n">color_mapping_sets</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*# &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)]</span>
</span><span id="COMPsc.spatial_similarity-3170"><a href="#COMPsc.spatial_similarity-3170"><span class="linenos">3170</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cell_names</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3171"><a href="#COMPsc.spatial_similarity-3171"><span class="linenos">3171</span></a>            <span class="p">}</span>
</span><span id="COMPsc.spatial_similarity-3172"><a href="#COMPsc.spatial_similarity-3172"><span class="linenos">3172</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.spatial_similarity-3173"><a href="#COMPsc.spatial_similarity-3173"><span class="linenos">3173</span></a>            <span class="n">color_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cell_names</span><span class="p">)}</span>
</span><span id="COMPsc.spatial_similarity-3174"><a href="#COMPsc.spatial_similarity-3174"><span class="linenos">3174</span></a>
</span><span id="COMPsc.spatial_similarity-3175"><a href="#COMPsc.spatial_similarity-3175"><span class="linenos">3175</span></a>        <span class="n">meanshift</span> <span class="o">=</span> <span class="n">MeanShift</span><span class="p">(</span><span class="n">bandwidth</span><span class="o">=</span><span class="n">bandwidth</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3176"><a href="#COMPsc.spatial_similarity-3176"><span class="linenos">3176</span></a>        <span class="n">labels</span> <span class="o">=</span> <span class="n">meanshift</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3177"><a href="#COMPsc.spatial_similarity-3177"><span class="linenos">3177</span></a>
</span><span id="COMPsc.spatial_similarity-3178"><a href="#COMPsc.spatial_similarity-3178"><span class="linenos">3178</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="COMPsc.spatial_similarity-3179"><a href="#COMPsc.spatial_similarity-3179"><span class="linenos">3179</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
</span><span id="COMPsc.spatial_similarity-3180"><a href="#COMPsc.spatial_similarity-3180"><span class="linenos">3180</span></a>
</span><span id="COMPsc.spatial_similarity-3181"><a href="#COMPsc.spatial_similarity-3181"><span class="linenos">3181</span></a>        <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3182"><a href="#COMPsc.spatial_similarity-3182"><span class="linenos">3182</span></a>        <span class="n">cluster_palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;hls&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">))</span>
</span><span id="COMPsc.spatial_similarity-3183"><a href="#COMPsc.spatial_similarity-3183"><span class="linenos">3183</span></a>
</span><span id="COMPsc.spatial_similarity-3184"><a href="#COMPsc.spatial_similarity-3184"><span class="linenos">3184</span></a>        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
</span><span id="COMPsc.spatial_similarity-3185"><a href="#COMPsc.spatial_similarity-3185"><span class="linenos">3185</span></a>            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="COMPsc.spatial_similarity-3186"><a href="#COMPsc.spatial_similarity-3186"><span class="linenos">3186</span></a>                <span class="k">continue</span>
</span><span id="COMPsc.spatial_similarity-3187"><a href="#COMPsc.spatial_similarity-3187"><span class="linenos">3187</span></a>            <span class="n">cluster_coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">label</span><span class="p">]</span>
</span><span id="COMPsc.spatial_similarity-3188"><a href="#COMPsc.spatial_similarity-3188"><span class="linenos">3188</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_coords</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="COMPsc.spatial_similarity-3189"><a href="#COMPsc.spatial_similarity-3189"><span class="linenos">3189</span></a>                <span class="k">continue</span>
</span><span id="COMPsc.spatial_similarity-3190"><a href="#COMPsc.spatial_similarity-3190"><span class="linenos">3190</span></a>
</span><span id="COMPsc.spatial_similarity-3191"><a href="#COMPsc.spatial_similarity-3191"><span class="linenos">3191</span></a>            <span class="n">hull</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">(</span><span class="n">cluster_coords</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3192"><a href="#COMPsc.spatial_similarity-3192"><span class="linenos">3192</span></a>            <span class="n">hull_points</span> <span class="o">=</span> <span class="n">cluster_coords</span><span class="p">[</span><span class="n">hull</span><span class="o">.</span><span class="n">vertices</span><span class="p">]</span>
</span><span id="COMPsc.spatial_similarity-3193"><a href="#COMPsc.spatial_similarity-3193"><span class="linenos">3193</span></a>
</span><span id="COMPsc.spatial_similarity-3194"><a href="#COMPsc.spatial_similarity-3194"><span class="linenos">3194</span></a>            <span class="n">centroid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hull_points</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3195"><a href="#COMPsc.spatial_similarity-3195"><span class="linenos">3195</span></a>            <span class="n">expanded</span> <span class="o">=</span> <span class="n">hull_points</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="n">hull_points</span> <span class="o">-</span> <span class="n">centroid</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3196"><a href="#COMPsc.spatial_similarity-3196"><span class="linenos">3196</span></a>
</span><span id="COMPsc.spatial_similarity-3197"><a href="#COMPsc.spatial_similarity-3197"><span class="linenos">3197</span></a>            <span class="n">poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span>
</span><span id="COMPsc.spatial_similarity-3198"><a href="#COMPsc.spatial_similarity-3198"><span class="linenos">3198</span></a>                <span class="n">expanded</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3199"><a href="#COMPsc.spatial_similarity-3199"><span class="linenos">3199</span></a>                <span class="n">closed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3200"><a href="#COMPsc.spatial_similarity-3200"><span class="linenos">3200</span></a>                <span class="n">facecolor</span><span class="o">=</span><span class="n">cluster_palette</span><span class="p">[</span><span class="n">label</span><span class="p">],</span>
</span><span id="COMPsc.spatial_similarity-3201"><a href="#COMPsc.spatial_similarity-3201"><span class="linenos">3201</span></a>                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3202"><a href="#COMPsc.spatial_similarity-3202"><span class="linenos">3202</span></a>                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3203"><a href="#COMPsc.spatial_similarity-3203"><span class="linenos">3203</span></a>                <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3204"><a href="#COMPsc.spatial_similarity-3204"><span class="linenos">3204</span></a>            <span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3205"><a href="#COMPsc.spatial_similarity-3205"><span class="linenos">3205</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3206"><a href="#COMPsc.spatial_similarity-3206"><span class="linenos">3206</span></a>
</span><span id="COMPsc.spatial_similarity-3207"><a href="#COMPsc.spatial_similarity-3207"><span class="linenos">3207</span></a>        <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc.spatial_similarity-3208"><a href="#COMPsc.spatial_similarity-3208"><span class="linenos">3208</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
</span><span id="COMPsc.spatial_similarity-3209"><a href="#COMPsc.spatial_similarity-3209"><span class="linenos">3209</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="COMPsc.spatial_similarity-3210"><a href="#COMPsc.spatial_similarity-3210"><span class="linenos">3210</span></a>                <span class="n">x</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3211"><a href="#COMPsc.spatial_similarity-3211"><span class="linenos">3211</span></a>                <span class="n">y</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3212"><a href="#COMPsc.spatial_similarity-3212"><span class="linenos">3212</span></a>                <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3213"><a href="#COMPsc.spatial_similarity-3213"><span class="linenos">3213</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">color_mapping</span><span class="p">[</span><span class="n">cell_names</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
</span><span id="COMPsc.spatial_similarity-3214"><a href="#COMPsc.spatial_similarity-3214"><span class="linenos">3214</span></a>                <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3215"><a href="#COMPsc.spatial_similarity-3215"><span class="linenos">3215</span></a>                <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3216"><a href="#COMPsc.spatial_similarity-3216"><span class="linenos">3216</span></a>                <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3217"><a href="#COMPsc.spatial_similarity-3217"><span class="linenos">3217</span></a>            <span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3218"><a href="#COMPsc.spatial_similarity-3218"><span class="linenos">3218</span></a>            <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="COMPsc.spatial_similarity-3219"><a href="#COMPsc.spatial_similarity-3219"><span class="linenos">3219</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="COMPsc.spatial_similarity-3220"><a href="#COMPsc.spatial_similarity-3220"><span class="linenos">3220</span></a>                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span>
</span><span id="COMPsc.spatial_similarity-3221"><a href="#COMPsc.spatial_similarity-3221"><span class="linenos">3221</span></a>                <span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3222"><a href="#COMPsc.spatial_similarity-3222"><span class="linenos">3222</span></a>            <span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3223"><a href="#COMPsc.spatial_similarity-3223"><span class="linenos">3223</span></a>
</span><span id="COMPsc.spatial_similarity-3224"><a href="#COMPsc.spatial_similarity-3224"><span class="linenos">3224</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">dist</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
</span><span id="COMPsc.spatial_similarity-3225"><a href="#COMPsc.spatial_similarity-3225"><span class="linenos">3225</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3226"><a href="#COMPsc.spatial_similarity-3226"><span class="linenos">3226</span></a>
</span><span id="COMPsc.spatial_similarity-3227"><a href="#COMPsc.spatial_similarity-3227"><span class="linenos">3227</span></a>        <span class="n">texts_to_adjust</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc.spatial_similarity-3228"><a href="#COMPsc.spatial_similarity-3228"><span class="linenos">3228</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
</span><span id="COMPsc.spatial_similarity-3229"><a href="#COMPsc.spatial_similarity-3229"><span class="linenos">3229</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">t2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
</span><span id="COMPsc.spatial_similarity-3230"><a href="#COMPsc.spatial_similarity-3230"><span class="linenos">3230</span></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">j</span><span class="p">:</span>
</span><span id="COMPsc.spatial_similarity-3231"><a href="#COMPsc.spatial_similarity-3231"><span class="linenos">3231</span></a>                    <span class="k">continue</span>
</span><span id="COMPsc.spatial_similarity-3232"><a href="#COMPsc.spatial_similarity-3232"><span class="linenos">3232</span></a>                <span class="n">d</span> <span class="o">=</span> <span class="n">dist</span><span class="p">(</span>
</span><span id="COMPsc.spatial_similarity-3233"><a href="#COMPsc.spatial_similarity-3233"><span class="linenos">3233</span></a>                    <span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">get_position</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t1</span><span class="o">.</span><span class="n">get_position</span><span class="p">()[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="COMPsc.spatial_similarity-3234"><a href="#COMPsc.spatial_similarity-3234"><span class="linenos">3234</span></a>                    <span class="p">(</span><span class="n">t2</span><span class="o">.</span><span class="n">get_position</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t2</span><span class="o">.</span><span class="n">get_position</span><span class="p">()[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="COMPsc.spatial_similarity-3235"><a href="#COMPsc.spatial_similarity-3235"><span class="linenos">3235</span></a>                <span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3236"><a href="#COMPsc.spatial_similarity-3236"><span class="linenos">3236</span></a>                <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="COMPsc.spatial_similarity-3237"><a href="#COMPsc.spatial_similarity-3237"><span class="linenos">3237</span></a>                    <span class="k">if</span> <span class="n">t1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">texts_to_adjust</span><span class="p">:</span>
</span><span id="COMPsc.spatial_similarity-3238"><a href="#COMPsc.spatial_similarity-3238"><span class="linenos">3238</span></a>                        <span class="n">texts_to_adjust</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3239"><a href="#COMPsc.spatial_similarity-3239"><span class="linenos">3239</span></a>                    <span class="k">if</span> <span class="n">t2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">texts_to_adjust</span><span class="p">:</span>
</span><span id="COMPsc.spatial_similarity-3240"><a href="#COMPsc.spatial_similarity-3240"><span class="linenos">3240</span></a>                        <span class="n">texts_to_adjust</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3241"><a href="#COMPsc.spatial_similarity-3241"><span class="linenos">3241</span></a>
</span><span id="COMPsc.spatial_similarity-3242"><a href="#COMPsc.spatial_similarity-3242"><span class="linenos">3242</span></a>        <span class="n">adjust_text</span><span class="p">(</span>
</span><span id="COMPsc.spatial_similarity-3243"><a href="#COMPsc.spatial_similarity-3243"><span class="linenos">3243</span></a>            <span class="n">texts_to_adjust</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3244"><a href="#COMPsc.spatial_similarity-3244"><span class="linenos">3244</span></a>            <span class="n">expand_text</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
</span><span id="COMPsc.spatial_similarity-3245"><a href="#COMPsc.spatial_similarity-3245"><span class="linenos">3245</span></a>            <span class="n">force_text</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3246"><a href="#COMPsc.spatial_similarity-3246"><span class="linenos">3246</span></a>            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span>
</span><span id="COMPsc.spatial_similarity-3247"><a href="#COMPsc.spatial_similarity-3247"><span class="linenos">3247</span></a>            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3248"><a href="#COMPsc.spatial_similarity-3248"><span class="linenos">3248</span></a>        <span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3249"><a href="#COMPsc.spatial_similarity-3249"><span class="linenos">3249</span></a>
</span><span id="COMPsc.spatial_similarity-3250"><a href="#COMPsc.spatial_similarity-3250"><span class="linenos">3250</span></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">arrow_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="COMPsc.spatial_similarity-3251"><a href="#COMPsc.spatial_similarity-3251"><span class="linenos">3251</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="COMPsc.spatial_similarity-3252"><a href="#COMPsc.spatial_similarity-3252"><span class="linenos">3252</span></a>                <span class="n">idx1</span> <span class="o">=</span> <span class="n">cell_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;cell1&quot;</span><span class="p">])</span>
</span><span id="COMPsc.spatial_similarity-3253"><a href="#COMPsc.spatial_similarity-3253"><span class="linenos">3253</span></a>                <span class="n">idx2</span> <span class="o">=</span> <span class="n">cell_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;cell2&quot;</span><span class="p">])</span>
</span><span id="COMPsc.spatial_similarity-3254"><a href="#COMPsc.spatial_similarity-3254"><span class="linenos">3254</span></a>            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="COMPsc.spatial_similarity-3255"><a href="#COMPsc.spatial_similarity-3255"><span class="linenos">3255</span></a>                <span class="k">continue</span>
</span><span id="COMPsc.spatial_similarity-3256"><a href="#COMPsc.spatial_similarity-3256"><span class="linenos">3256</span></a>            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span>
</span><span id="COMPsc.spatial_similarity-3257"><a href="#COMPsc.spatial_similarity-3257"><span class="linenos">3257</span></a>            <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span>
</span><span id="COMPsc.spatial_similarity-3258"><a href="#COMPsc.spatial_similarity-3258"><span class="linenos">3258</span></a>            <span class="n">arrow</span> <span class="o">=</span> <span class="n">FancyArrowPatch</span><span class="p">(</span>
</span><span id="COMPsc.spatial_similarity-3259"><a href="#COMPsc.spatial_similarity-3259"><span class="linenos">3259</span></a>                <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span>
</span><span id="COMPsc.spatial_similarity-3260"><a href="#COMPsc.spatial_similarity-3260"><span class="linenos">3260</span></a>                <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span>
</span><span id="COMPsc.spatial_similarity-3261"><a href="#COMPsc.spatial_similarity-3261"><span class="linenos">3261</span></a>                <span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3262"><a href="#COMPsc.spatial_similarity-3262"><span class="linenos">3262</span></a>                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3263"><a href="#COMPsc.spatial_similarity-3263"><span class="linenos">3263</span></a>                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3264"><a href="#COMPsc.spatial_similarity-3264"><span class="linenos">3264</span></a>                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3265"><a href="#COMPsc.spatial_similarity-3265"><span class="linenos">3265</span></a>                <span class="n">mutation_scale</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3266"><a href="#COMPsc.spatial_similarity-3266"><span class="linenos">3266</span></a>                <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3267"><a href="#COMPsc.spatial_similarity-3267"><span class="linenos">3267</span></a>            <span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3268"><a href="#COMPsc.spatial_similarity-3268"><span class="linenos">3268</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">arrow</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3269"><a href="#COMPsc.spatial_similarity-3269"><span class="linenos">3269</span></a>
</span><span id="COMPsc.spatial_similarity-3270"><a href="#COMPsc.spatial_similarity-3270"><span class="linenos">3270</span></a>        <span class="k">if</span> <span class="n">set_info</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="s2">&quot; # &quot;</span> <span class="ow">in</span> <span class="n">cell_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="COMPsc.spatial_similarity-3271"><a href="#COMPsc.spatial_similarity-3271"><span class="linenos">3271</span></a>
</span><span id="COMPsc.spatial_similarity-3272"><a href="#COMPsc.spatial_similarity-3272"><span class="linenos">3272</span></a>            <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc.spatial_similarity-3273"><a href="#COMPsc.spatial_similarity-3273"><span class="linenos">3273</span></a>                <span class="n">Patch</span><span class="p">(</span>
</span><span id="COMPsc.spatial_similarity-3274"><a href="#COMPsc.spatial_similarity-3274"><span class="linenos">3274</span></a>                    <span class="n">facecolor</span><span class="o">=</span><span class="n">color_mapping</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
</span><span id="COMPsc.spatial_similarity-3275"><a href="#COMPsc.spatial_similarity-3275"><span class="linenos">3275</span></a>                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3276"><a href="#COMPsc.spatial_similarity-3276"><span class="linenos">3276</span></a>                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> – </span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; #.*&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3277"><a href="#COMPsc.spatial_similarity-3277"><span class="linenos">3277</span></a>                <span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3278"><a href="#COMPsc.spatial_similarity-3278"><span class="linenos">3278</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cell_names</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3279"><a href="#COMPsc.spatial_similarity-3279"><span class="linenos">3279</span></a>            <span class="p">]</span>
</span><span id="COMPsc.spatial_similarity-3280"><a href="#COMPsc.spatial_similarity-3280"><span class="linenos">3280</span></a>
</span><span id="COMPsc.spatial_similarity-3281"><a href="#COMPsc.spatial_similarity-3281"><span class="linenos">3281</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.spatial_similarity-3282"><a href="#COMPsc.spatial_similarity-3282"><span class="linenos">3282</span></a>
</span><span id="COMPsc.spatial_similarity-3283"><a href="#COMPsc.spatial_similarity-3283"><span class="linenos">3283</span></a>            <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc.spatial_similarity-3284"><a href="#COMPsc.spatial_similarity-3284"><span class="linenos">3284</span></a>                <span class="n">Patch</span><span class="p">(</span>
</span><span id="COMPsc.spatial_similarity-3285"><a href="#COMPsc.spatial_similarity-3285"><span class="linenos">3285</span></a>                    <span class="n">facecolor</span><span class="o">=</span><span class="n">color_mapping</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
</span><span id="COMPsc.spatial_similarity-3286"><a href="#COMPsc.spatial_similarity-3286"><span class="linenos">3286</span></a>                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3287"><a href="#COMPsc.spatial_similarity-3287"><span class="linenos">3287</span></a>                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> – </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3288"><a href="#COMPsc.spatial_similarity-3288"><span class="linenos">3288</span></a>                <span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3289"><a href="#COMPsc.spatial_similarity-3289"><span class="linenos">3289</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cell_names</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3290"><a href="#COMPsc.spatial_similarity-3290"><span class="linenos">3290</span></a>            <span class="p">]</span>
</span><span id="COMPsc.spatial_similarity-3291"><a href="#COMPsc.spatial_similarity-3291"><span class="linenos">3291</span></a>
</span><span id="COMPsc.spatial_similarity-3292"><a href="#COMPsc.spatial_similarity-3292"><span class="linenos">3292</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="COMPsc.spatial_similarity-3293"><a href="#COMPsc.spatial_similarity-3293"><span class="linenos">3293</span></a>            <span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3294"><a href="#COMPsc.spatial_similarity-3294"><span class="linenos">3294</span></a>            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Cells&quot;</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3295"><a href="#COMPsc.spatial_similarity-3295"><span class="linenos">3295</span></a>            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="COMPsc.spatial_similarity-3296"><a href="#COMPsc.spatial_similarity-3296"><span class="linenos">3296</span></a>            <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3297"><a href="#COMPsc.spatial_similarity-3297"><span class="linenos">3297</span></a>            <span class="n">ncol</span><span class="o">=</span><span class="n">legend_split</span><span class="p">,</span>
</span><span id="COMPsc.spatial_similarity-3298"><a href="#COMPsc.spatial_similarity-3298"><span class="linenos">3298</span></a>        <span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3299"><a href="#COMPsc.spatial_similarity-3299"><span class="linenos">3299</span></a>
</span><span id="COMPsc.spatial_similarity-3300"><a href="#COMPsc.spatial_similarity-3300"><span class="linenos">3300</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3301"><a href="#COMPsc.spatial_similarity-3301"><span class="linenos">3301</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3302"><a href="#COMPsc.spatial_similarity-3302"><span class="linenos">3302</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="COMPsc.spatial_similarity-3303"><a href="#COMPsc.spatial_similarity-3303"><span class="linenos">3303</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="COMPsc.spatial_similarity-3304"><a href="#COMPsc.spatial_similarity-3304"><span class="linenos">3304</span></a>
</span><span id="COMPsc.spatial_similarity-3305"><a href="#COMPsc.spatial_similarity-3305"><span class="linenos">3305</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span></pre></div>


            <div class="docstring"><p>Create a spatial UMAP-like visualization of similarity relationships between samples.</p>

<h2 id="parameters">Parameters</h2>

<p>set_info : bool, default True
    If True, retain set information in labels.</p>

<p>bandwidth : float, default 1
    Bandwidth used by MeanShift for clustering polygons.</p>

<p>point_size : float, default 100
    Size of scatter points.</p>

<p>legend_split : int, default 2
    Number of columns in legend.</p>

<p>n_neighbors, min_dist, spread, set_op_mix_ratio, local_connectivity, repulsion_strength, negative_sample_rate : parameters passed to UMAP.</p>

<p>threshold : float, default 0.1
    Minimum text distance for label adjustment to avoid overlap.</p>

<p>width : int, default 12
    Figure width.</p>

<p>height : int, default 10
    Figure height.</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.figure.Figure</p>

<h2 id="raises">Raises</h2>

<p>ValueError
    If <code>self.similarity</code> is None.</p>

<h2 id="notes">Notes</h2>

<p>Builds a precomputed distance matrix combining correlation and euclidean distance,
runs UMAP with metric='precomputed', then overlays cluster hulls (MeanShift + convex hull)
and arrows to indicate nearest neighbors (minimal combined distance).</p>
</div>


                            </div>
                            <div id="COMPsc.subcluster_prepare" class="classattr">
                                        <input id="COMPsc.subcluster_prepare-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">subcluster_prepare</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">features</span><span class="p">:</span> <span class="nb">list</span>, </span><span class="param"><span class="n">cluster</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.subcluster_prepare-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.subcluster_prepare"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.subcluster_prepare-3309"><a href="#COMPsc.subcluster_prepare-3309"><span class="linenos">3309</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">subcluster_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">cluster</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="COMPsc.subcluster_prepare-3310"><a href="#COMPsc.subcluster_prepare-3310"><span class="linenos">3310</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.subcluster_prepare-3311"><a href="#COMPsc.subcluster_prepare-3311"><span class="linenos">3311</span></a><span class="sd">        Prepare a `Clustering` object for subcluster analysis on a selected parent cluster.</span>
</span><span id="COMPsc.subcluster_prepare-3312"><a href="#COMPsc.subcluster_prepare-3312"><span class="linenos">3312</span></a>
</span><span id="COMPsc.subcluster_prepare-3313"><a href="#COMPsc.subcluster_prepare-3313"><span class="linenos">3313</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.subcluster_prepare-3314"><a href="#COMPsc.subcluster_prepare-3314"><span class="linenos">3314</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.subcluster_prepare-3315"><a href="#COMPsc.subcluster_prepare-3315"><span class="linenos">3315</span></a><span class="sd">        features : list</span>
</span><span id="COMPsc.subcluster_prepare-3316"><a href="#COMPsc.subcluster_prepare-3316"><span class="linenos">3316</span></a><span class="sd">            Features to include for subcluster analysis.</span>
</span><span id="COMPsc.subcluster_prepare-3317"><a href="#COMPsc.subcluster_prepare-3317"><span class="linenos">3317</span></a>
</span><span id="COMPsc.subcluster_prepare-3318"><a href="#COMPsc.subcluster_prepare-3318"><span class="linenos">3318</span></a><span class="sd">        cluster : str</span>
</span><span id="COMPsc.subcluster_prepare-3319"><a href="#COMPsc.subcluster_prepare-3319"><span class="linenos">3319</span></a><span class="sd">            Parent cluster name (used to select matching cells).</span>
</span><span id="COMPsc.subcluster_prepare-3320"><a href="#COMPsc.subcluster_prepare-3320"><span class="linenos">3320</span></a>
</span><span id="COMPsc.subcluster_prepare-3321"><a href="#COMPsc.subcluster_prepare-3321"><span class="linenos">3321</span></a><span class="sd">        Update</span>
</span><span id="COMPsc.subcluster_prepare-3322"><a href="#COMPsc.subcluster_prepare-3322"><span class="linenos">3322</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.subcluster_prepare-3323"><a href="#COMPsc.subcluster_prepare-3323"><span class="linenos">3323</span></a><span class="sd">        Initializes `self.subclusters_` as a new `Clustering` instance containing the</span>
</span><span id="COMPsc.subcluster_prepare-3324"><a href="#COMPsc.subcluster_prepare-3324"><span class="linenos">3324</span></a><span class="sd">        reduced data for the given cluster and stores `current_features` and `current_cluster`.</span>
</span><span id="COMPsc.subcluster_prepare-3325"><a href="#COMPsc.subcluster_prepare-3325"><span class="linenos">3325</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.subcluster_prepare-3326"><a href="#COMPsc.subcluster_prepare-3326"><span class="linenos">3326</span></a>
</span><span id="COMPsc.subcluster_prepare-3327"><a href="#COMPsc.subcluster_prepare-3327"><span class="linenos">3327</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span>
</span><span id="COMPsc.subcluster_prepare-3328"><a href="#COMPsc.subcluster_prepare-3328"><span class="linenos">3328</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">])</span>
</span><span id="COMPsc.subcluster_prepare-3329"><a href="#COMPsc.subcluster_prepare-3329"><span class="linenos">3329</span></a>
</span><span id="COMPsc.subcluster_prepare-3330"><a href="#COMPsc.subcluster_prepare-3330"><span class="linenos">3330</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="n">reduce_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="n">cluster</span><span class="p">])</span>
</span><span id="COMPsc.subcluster_prepare-3331"><a href="#COMPsc.subcluster_prepare-3331"><span class="linenos">3331</span></a>
</span><span id="COMPsc.subcluster_prepare-3332"><a href="#COMPsc.subcluster_prepare-3332"><span class="linenos">3332</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="o">=</span> <span class="n">Clustering</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="COMPsc.subcluster_prepare-3333"><a href="#COMPsc.subcluster_prepare-3333"><span class="linenos">3333</span></a>
</span><span id="COMPsc.subcluster_prepare-3334"><a href="#COMPsc.subcluster_prepare-3334"><span class="linenos">3334</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">current_features</span> <span class="o">=</span> <span class="n">features</span>
</span><span id="COMPsc.subcluster_prepare-3335"><a href="#COMPsc.subcluster_prepare-3335"><span class="linenos">3335</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">current_cluster</span> <span class="o">=</span> <span class="n">cluster</span>
</span></pre></div>


            <div class="docstring"><p>Prepare a <code><a href="#Clustering">Clustering</a></code> object for subcluster analysis on a selected parent cluster.</p>

<h2 id="parameters">Parameters</h2>

<p>features : list
    Features to include for subcluster analysis.</p>

<p>cluster : str
    Parent cluster name (used to select matching cells).</p>

<h2 id="update">Update</h2>

<p>Initializes <code>self.subclusters_</code> as a new <code><a href="#Clustering">Clustering</a></code> instance containing the
reduced data for the given cluster and stores <code>current_features</code> and <code>current_cluster</code>.</p>
</div>


                            </div>
                            <div id="COMPsc.define_subclusters" class="classattr">
                                        <input id="COMPsc.define_subclusters-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">define_subclusters</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">umap_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>,</span><span class="param">	<span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span>,</span><span class="param">	<span class="n">min_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">n_neighbors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>,</span><span class="param">	<span class="n">min_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>,</span><span class="param">	<span class="n">spread</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">set_op_mix_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">local_connectivity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">repulsion_strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">negative_sample_rate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>,</span><span class="param">	<span class="n">width</span><span class="o">=</span><span class="mi">8</span>,</span><span class="param">	<span class="n">height</span><span class="o">=</span><span class="mi">6</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.define_subclusters-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.define_subclusters"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.define_subclusters-3337"><a href="#COMPsc.define_subclusters-3337"><span class="linenos">3337</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_subclusters</span><span class="p">(</span>
</span><span id="COMPsc.define_subclusters-3338"><a href="#COMPsc.define_subclusters-3338"><span class="linenos">3338</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3339"><a href="#COMPsc.define_subclusters-3339"><span class="linenos">3339</span></a>        <span class="n">umap_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3340"><a href="#COMPsc.define_subclusters-3340"><span class="linenos">3340</span></a>        <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3341"><a href="#COMPsc.define_subclusters-3341"><span class="linenos">3341</span></a>        <span class="n">min_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3342"><a href="#COMPsc.define_subclusters-3342"><span class="linenos">3342</span></a>        <span class="n">n_neighbors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3343"><a href="#COMPsc.define_subclusters-3343"><span class="linenos">3343</span></a>        <span class="n">min_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3344"><a href="#COMPsc.define_subclusters-3344"><span class="linenos">3344</span></a>        <span class="n">spread</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3345"><a href="#COMPsc.define_subclusters-3345"><span class="linenos">3345</span></a>        <span class="n">set_op_mix_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3346"><a href="#COMPsc.define_subclusters-3346"><span class="linenos">3346</span></a>        <span class="n">local_connectivity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3347"><a href="#COMPsc.define_subclusters-3347"><span class="linenos">3347</span></a>        <span class="n">repulsion_strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3348"><a href="#COMPsc.define_subclusters-3348"><span class="linenos">3348</span></a>        <span class="n">negative_sample_rate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3349"><a href="#COMPsc.define_subclusters-3349"><span class="linenos">3349</span></a>        <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3350"><a href="#COMPsc.define_subclusters-3350"><span class="linenos">3350</span></a>        <span class="n">height</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3351"><a href="#COMPsc.define_subclusters-3351"><span class="linenos">3351</span></a>    <span class="p">):</span>
</span><span id="COMPsc.define_subclusters-3352"><a href="#COMPsc.define_subclusters-3352"><span class="linenos">3352</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.define_subclusters-3353"><a href="#COMPsc.define_subclusters-3353"><span class="linenos">3353</span></a><span class="sd">        Compute UMAP and DBSCAN clustering within a previously prepared subcluster dataset.</span>
</span><span id="COMPsc.define_subclusters-3354"><a href="#COMPsc.define_subclusters-3354"><span class="linenos">3354</span></a>
</span><span id="COMPsc.define_subclusters-3355"><a href="#COMPsc.define_subclusters-3355"><span class="linenos">3355</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.define_subclusters-3356"><a href="#COMPsc.define_subclusters-3356"><span class="linenos">3356</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.define_subclusters-3357"><a href="#COMPsc.define_subclusters-3357"><span class="linenos">3357</span></a><span class="sd">        umap_num : int, default 2</span>
</span><span id="COMPsc.define_subclusters-3358"><a href="#COMPsc.define_subclusters-3358"><span class="linenos">3358</span></a><span class="sd">            Number of UMAP dimensions to compute.</span>
</span><span id="COMPsc.define_subclusters-3359"><a href="#COMPsc.define_subclusters-3359"><span class="linenos">3359</span></a>
</span><span id="COMPsc.define_subclusters-3360"><a href="#COMPsc.define_subclusters-3360"><span class="linenos">3360</span></a><span class="sd">        eps : float, default 0.5</span>
</span><span id="COMPsc.define_subclusters-3361"><a href="#COMPsc.define_subclusters-3361"><span class="linenos">3361</span></a><span class="sd">            DBSCAN eps parameter.</span>
</span><span id="COMPsc.define_subclusters-3362"><a href="#COMPsc.define_subclusters-3362"><span class="linenos">3362</span></a>
</span><span id="COMPsc.define_subclusters-3363"><a href="#COMPsc.define_subclusters-3363"><span class="linenos">3363</span></a><span class="sd">        min_samples : int, default 10</span>
</span><span id="COMPsc.define_subclusters-3364"><a href="#COMPsc.define_subclusters-3364"><span class="linenos">3364</span></a><span class="sd">            DBSCAN min_samples parameter.</span>
</span><span id="COMPsc.define_subclusters-3365"><a href="#COMPsc.define_subclusters-3365"><span class="linenos">3365</span></a>
</span><span id="COMPsc.define_subclusters-3366"><a href="#COMPsc.define_subclusters-3366"><span class="linenos">3366</span></a><span class="sd">        n_neighbors, min_dist, spread, set_op_mix_ratio, local_connectivity, repulsion_strength, negative_sample_rate, width, height :</span>
</span><span id="COMPsc.define_subclusters-3367"><a href="#COMPsc.define_subclusters-3367"><span class="linenos">3367</span></a><span class="sd">            Additional parameters passed to UMAP / plotting / MeanShift as appropriate.</span>
</span><span id="COMPsc.define_subclusters-3368"><a href="#COMPsc.define_subclusters-3368"><span class="linenos">3368</span></a>
</span><span id="COMPsc.define_subclusters-3369"><a href="#COMPsc.define_subclusters-3369"><span class="linenos">3369</span></a><span class="sd">        Update</span>
</span><span id="COMPsc.define_subclusters-3370"><a href="#COMPsc.define_subclusters-3370"><span class="linenos">3370</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.define_subclusters-3371"><a href="#COMPsc.define_subclusters-3371"><span class="linenos">3371</span></a><span class="sd">        Stores cluster labels in `self.subclusters_.subclusters`.</span>
</span><span id="COMPsc.define_subclusters-3372"><a href="#COMPsc.define_subclusters-3372"><span class="linenos">3372</span></a>
</span><span id="COMPsc.define_subclusters-3373"><a href="#COMPsc.define_subclusters-3373"><span class="linenos">3373</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc.define_subclusters-3374"><a href="#COMPsc.define_subclusters-3374"><span class="linenos">3374</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.define_subclusters-3375"><a href="#COMPsc.define_subclusters-3375"><span class="linenos">3375</span></a><span class="sd">        RuntimeError</span>
</span><span id="COMPsc.define_subclusters-3376"><a href="#COMPsc.define_subclusters-3376"><span class="linenos">3376</span></a><span class="sd">            If `self.subclusters_` has not been prepared.</span>
</span><span id="COMPsc.define_subclusters-3377"><a href="#COMPsc.define_subclusters-3377"><span class="linenos">3377</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.define_subclusters-3378"><a href="#COMPsc.define_subclusters-3378"><span class="linenos">3378</span></a>
</span><span id="COMPsc.define_subclusters-3379"><a href="#COMPsc.define_subclusters-3379"><span class="linenos">3379</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.define_subclusters-3380"><a href="#COMPsc.define_subclusters-3380"><span class="linenos">3380</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="COMPsc.define_subclusters-3381"><a href="#COMPsc.define_subclusters-3381"><span class="linenos">3381</span></a>                <span class="s2">&quot;Nothing to return. &#39;self.subcluster_prepare&#39; was not conducted!&quot;</span>
</span><span id="COMPsc.define_subclusters-3382"><a href="#COMPsc.define_subclusters-3382"><span class="linenos">3382</span></a>            <span class="p">)</span>
</span><span id="COMPsc.define_subclusters-3383"><a href="#COMPsc.define_subclusters-3383"><span class="linenos">3383</span></a>
</span><span id="COMPsc.define_subclusters-3384"><a href="#COMPsc.define_subclusters-3384"><span class="linenos">3384</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">perform_UMAP</span><span class="p">(</span>
</span><span id="COMPsc.define_subclusters-3385"><a href="#COMPsc.define_subclusters-3385"><span class="linenos">3385</span></a>            <span class="n">factorize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3386"><a href="#COMPsc.define_subclusters-3386"><span class="linenos">3386</span></a>            <span class="n">umap_num</span><span class="o">=</span><span class="n">umap_num</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3387"><a href="#COMPsc.define_subclusters-3387"><span class="linenos">3387</span></a>            <span class="n">pc_num</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3388"><a href="#COMPsc.define_subclusters-3388"><span class="linenos">3388</span></a>            <span class="n">harmonized</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3389"><a href="#COMPsc.define_subclusters-3389"><span class="linenos">3389</span></a>            <span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3390"><a href="#COMPsc.define_subclusters-3390"><span class="linenos">3390</span></a>            <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3391"><a href="#COMPsc.define_subclusters-3391"><span class="linenos">3391</span></a>            <span class="n">spread</span><span class="o">=</span><span class="n">spread</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3392"><a href="#COMPsc.define_subclusters-3392"><span class="linenos">3392</span></a>            <span class="n">set_op_mix_ratio</span><span class="o">=</span><span class="n">set_op_mix_ratio</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3393"><a href="#COMPsc.define_subclusters-3393"><span class="linenos">3393</span></a>            <span class="n">local_connectivity</span><span class="o">=</span><span class="n">local_connectivity</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3394"><a href="#COMPsc.define_subclusters-3394"><span class="linenos">3394</span></a>            <span class="n">repulsion_strength</span><span class="o">=</span><span class="n">repulsion_strength</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3395"><a href="#COMPsc.define_subclusters-3395"><span class="linenos">3395</span></a>            <span class="n">negative_sample_rate</span><span class="o">=</span><span class="n">negative_sample_rate</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3396"><a href="#COMPsc.define_subclusters-3396"><span class="linenos">3396</span></a>            <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3397"><a href="#COMPsc.define_subclusters-3397"><span class="linenos">3397</span></a>            <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3398"><a href="#COMPsc.define_subclusters-3398"><span class="linenos">3398</span></a>        <span class="p">)</span>
</span><span id="COMPsc.define_subclusters-3399"><a href="#COMPsc.define_subclusters-3399"><span class="linenos">3399</span></a>
</span><span id="COMPsc.define_subclusters-3400"><a href="#COMPsc.define_subclusters-3400"><span class="linenos">3400</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">find_clusters_UMAP</span><span class="p">(</span>
</span><span id="COMPsc.define_subclusters-3401"><a href="#COMPsc.define_subclusters-3401"><span class="linenos">3401</span></a>            <span class="n">umap_n</span><span class="o">=</span><span class="n">umap_num</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3402"><a href="#COMPsc.define_subclusters-3402"><span class="linenos">3402</span></a>            <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3403"><a href="#COMPsc.define_subclusters-3403"><span class="linenos">3403</span></a>            <span class="n">min_samples</span><span class="o">=</span><span class="n">min_samples</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3404"><a href="#COMPsc.define_subclusters-3404"><span class="linenos">3404</span></a>            <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3405"><a href="#COMPsc.define_subclusters-3405"><span class="linenos">3405</span></a>            <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
</span><span id="COMPsc.define_subclusters-3406"><a href="#COMPsc.define_subclusters-3406"><span class="linenos">3406</span></a>        <span class="p">)</span>
</span><span id="COMPsc.define_subclusters-3407"><a href="#COMPsc.define_subclusters-3407"><span class="linenos">3407</span></a>
</span><span id="COMPsc.define_subclusters-3408"><a href="#COMPsc.define_subclusters-3408"><span class="linenos">3408</span></a>        <span class="n">clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">return_clusters</span><span class="p">(</span><span class="n">clusters</span><span class="o">=</span><span class="s2">&quot;umap&quot;</span><span class="p">)</span>
</span><span id="COMPsc.define_subclusters-3409"><a href="#COMPsc.define_subclusters-3409"><span class="linenos">3409</span></a>
</span><span id="COMPsc.define_subclusters-3410"><a href="#COMPsc.define_subclusters-3410"><span class="linenos">3410</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">clusters</span><span class="p">)]</span>
</span><span id="COMPsc.define_subclusters-3411"><a href="#COMPsc.define_subclusters-3411"><span class="linenos">3411</span></a>
</span><span id="COMPsc.define_subclusters-3412"><a href="#COMPsc.define_subclusters-3412"><span class="linenos">3412</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span></pre></div>


            <div class="docstring"><p>Compute UMAP and DBSCAN clustering within a previously prepared subcluster dataset.</p>

<h2 id="parameters">Parameters</h2>

<p>umap_num : int, default 2
    Number of UMAP dimensions to compute.</p>

<p>eps : float, default 0.5
    DBSCAN eps parameter.</p>

<p>min_samples : int, default 10
    DBSCAN min_samples parameter.</p>

<p>n_neighbors, min_dist, spread, set_op_mix_ratio, local_connectivity, repulsion_strength, negative_sample_rate, width, height :
    Additional parameters passed to UMAP / plotting / MeanShift as appropriate.</p>

<h2 id="update">Update</h2>

<p>Stores cluster labels in <code>self.subclusters_.subclusters</code>.</p>

<h2 id="raises">Raises</h2>

<p>RuntimeError
    If <code>self.subclusters_</code> has not been prepared.</p>
</div>


                            </div>
                            <div id="COMPsc.subcluster_features_scatter" class="classattr">
                                        <input id="COMPsc.subcluster_features_scatter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">subcluster_features_scatter</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">colors</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span>,</span><span class="param">	<span class="n">hclust</span><span class="o">=</span><span class="s1">&#39;complete&#39;</span>,</span><span class="param">	<span class="n">scale</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">img_width</span><span class="o">=</span><span class="mi">3</span>,</span><span class="param">	<span class="n">img_high</span><span class="o">=</span><span class="mi">5</span>,</span><span class="param">	<span class="n">label_size</span><span class="o">=</span><span class="mi">6</span>,</span><span class="param">	<span class="n">size_scale</span><span class="o">=</span><span class="mi">70</span>,</span><span class="param">	<span class="n">y_lab</span><span class="o">=</span><span class="s1">&#39;Genes&#39;</span>,</span><span class="param">	<span class="n">legend_lab</span><span class="o">=</span><span class="s1">&#39;normalized&#39;</span>,</span><span class="param">	<span class="n">bbox_to_anchor_scale</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span>,</span><span class="param">	<span class="n">bbox_to_anchor_perc</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.91</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">)</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.subcluster_features_scatter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.subcluster_features_scatter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.subcluster_features_scatter-3414"><a href="#COMPsc.subcluster_features_scatter-3414"><span class="linenos">3414</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">subcluster_features_scatter</span><span class="p">(</span>
</span><span id="COMPsc.subcluster_features_scatter-3415"><a href="#COMPsc.subcluster_features_scatter-3415"><span class="linenos">3415</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3416"><a href="#COMPsc.subcluster_features_scatter-3416"><span class="linenos">3416</span></a>        <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3417"><a href="#COMPsc.subcluster_features_scatter-3417"><span class="linenos">3417</span></a>        <span class="n">hclust</span><span class="o">=</span><span class="s2">&quot;complete&quot;</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3418"><a href="#COMPsc.subcluster_features_scatter-3418"><span class="linenos">3418</span></a>        <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3419"><a href="#COMPsc.subcluster_features_scatter-3419"><span class="linenos">3419</span></a>        <span class="n">img_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3420"><a href="#COMPsc.subcluster_features_scatter-3420"><span class="linenos">3420</span></a>        <span class="n">img_high</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3421"><a href="#COMPsc.subcluster_features_scatter-3421"><span class="linenos">3421</span></a>        <span class="n">label_size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3422"><a href="#COMPsc.subcluster_features_scatter-3422"><span class="linenos">3422</span></a>        <span class="n">size_scale</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3423"><a href="#COMPsc.subcluster_features_scatter-3423"><span class="linenos">3423</span></a>        <span class="n">y_lab</span><span class="o">=</span><span class="s2">&quot;Genes&quot;</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3424"><a href="#COMPsc.subcluster_features_scatter-3424"><span class="linenos">3424</span></a>        <span class="n">legend_lab</span><span class="o">=</span><span class="s2">&quot;normalized&quot;</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3425"><a href="#COMPsc.subcluster_features_scatter-3425"><span class="linenos">3425</span></a>        <span class="n">bbox_to_anchor_scale</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3426"><a href="#COMPsc.subcluster_features_scatter-3426"><span class="linenos">3426</span></a>        <span class="n">bbox_to_anchor_perc</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.91</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">),</span>
</span><span id="COMPsc.subcluster_features_scatter-3427"><a href="#COMPsc.subcluster_features_scatter-3427"><span class="linenos">3427</span></a>    <span class="p">):</span>
</span><span id="COMPsc.subcluster_features_scatter-3428"><a href="#COMPsc.subcluster_features_scatter-3428"><span class="linenos">3428</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.subcluster_features_scatter-3429"><a href="#COMPsc.subcluster_features_scatter-3429"><span class="linenos">3429</span></a><span class="sd">        Create a features-scatter visualization for the subclusters (averaged and occurrence).</span>
</span><span id="COMPsc.subcluster_features_scatter-3430"><a href="#COMPsc.subcluster_features_scatter-3430"><span class="linenos">3430</span></a>
</span><span id="COMPsc.subcluster_features_scatter-3431"><a href="#COMPsc.subcluster_features_scatter-3431"><span class="linenos">3431</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.subcluster_features_scatter-3432"><a href="#COMPsc.subcluster_features_scatter-3432"><span class="linenos">3432</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.subcluster_features_scatter-3433"><a href="#COMPsc.subcluster_features_scatter-3433"><span class="linenos">3433</span></a><span class="sd">        colors : str, default &#39;viridis&#39;</span>
</span><span id="COMPsc.subcluster_features_scatter-3434"><a href="#COMPsc.subcluster_features_scatter-3434"><span class="linenos">3434</span></a><span class="sd">            Colormap name passed to `features_scatter`.</span>
</span><span id="COMPsc.subcluster_features_scatter-3435"><a href="#COMPsc.subcluster_features_scatter-3435"><span class="linenos">3435</span></a>
</span><span id="COMPsc.subcluster_features_scatter-3436"><a href="#COMPsc.subcluster_features_scatter-3436"><span class="linenos">3436</span></a><span class="sd">        hclust : str or None</span>
</span><span id="COMPsc.subcluster_features_scatter-3437"><a href="#COMPsc.subcluster_features_scatter-3437"><span class="linenos">3437</span></a><span class="sd">            Hierarchical clustering linkage to order rows/columns.</span>
</span><span id="COMPsc.subcluster_features_scatter-3438"><a href="#COMPsc.subcluster_features_scatter-3438"><span class="linenos">3438</span></a>
</span><span id="COMPsc.subcluster_features_scatter-3439"><a href="#COMPsc.subcluster_features_scatter-3439"><span class="linenos">3439</span></a><span class="sd">        scale: bool, default False</span>
</span><span id="COMPsc.subcluster_features_scatter-3440"><a href="#COMPsc.subcluster_features_scatter-3440"><span class="linenos">3440</span></a><span class="sd">            If True, expression data will be scaled (0–1) across the rows (features).</span>
</span><span id="COMPsc.subcluster_features_scatter-3441"><a href="#COMPsc.subcluster_features_scatter-3441"><span class="linenos">3441</span></a>
</span><span id="COMPsc.subcluster_features_scatter-3442"><a href="#COMPsc.subcluster_features_scatter-3442"><span class="linenos">3442</span></a><span class="sd">        img_width, img_high : float</span>
</span><span id="COMPsc.subcluster_features_scatter-3443"><a href="#COMPsc.subcluster_features_scatter-3443"><span class="linenos">3443</span></a><span class="sd">            Figure size.</span>
</span><span id="COMPsc.subcluster_features_scatter-3444"><a href="#COMPsc.subcluster_features_scatter-3444"><span class="linenos">3444</span></a>
</span><span id="COMPsc.subcluster_features_scatter-3445"><a href="#COMPsc.subcluster_features_scatter-3445"><span class="linenos">3445</span></a><span class="sd">        label_size : int</span>
</span><span id="COMPsc.subcluster_features_scatter-3446"><a href="#COMPsc.subcluster_features_scatter-3446"><span class="linenos">3446</span></a><span class="sd">            Font size for labels.</span>
</span><span id="COMPsc.subcluster_features_scatter-3447"><a href="#COMPsc.subcluster_features_scatter-3447"><span class="linenos">3447</span></a>
</span><span id="COMPsc.subcluster_features_scatter-3448"><a href="#COMPsc.subcluster_features_scatter-3448"><span class="linenos">3448</span></a><span class="sd">        size_scale : int</span>
</span><span id="COMPsc.subcluster_features_scatter-3449"><a href="#COMPsc.subcluster_features_scatter-3449"><span class="linenos">3449</span></a><span class="sd">            Bubble size scaling.</span>
</span><span id="COMPsc.subcluster_features_scatter-3450"><a href="#COMPsc.subcluster_features_scatter-3450"><span class="linenos">3450</span></a>
</span><span id="COMPsc.subcluster_features_scatter-3451"><a href="#COMPsc.subcluster_features_scatter-3451"><span class="linenos">3451</span></a><span class="sd">        y_lab : str</span>
</span><span id="COMPsc.subcluster_features_scatter-3452"><a href="#COMPsc.subcluster_features_scatter-3452"><span class="linenos">3452</span></a><span class="sd">            X axis label.</span>
</span><span id="COMPsc.subcluster_features_scatter-3453"><a href="#COMPsc.subcluster_features_scatter-3453"><span class="linenos">3453</span></a>
</span><span id="COMPsc.subcluster_features_scatter-3454"><a href="#COMPsc.subcluster_features_scatter-3454"><span class="linenos">3454</span></a><span class="sd">        legend_lab : str</span>
</span><span id="COMPsc.subcluster_features_scatter-3455"><a href="#COMPsc.subcluster_features_scatter-3455"><span class="linenos">3455</span></a><span class="sd">            Colorbar label.</span>
</span><span id="COMPsc.subcluster_features_scatter-3456"><a href="#COMPsc.subcluster_features_scatter-3456"><span class="linenos">3456</span></a>
</span><span id="COMPsc.subcluster_features_scatter-3457"><a href="#COMPsc.subcluster_features_scatter-3457"><span class="linenos">3457</span></a><span class="sd">        bbox_to_anchor_scale : int, default=25</span>
</span><span id="COMPsc.subcluster_features_scatter-3458"><a href="#COMPsc.subcluster_features_scatter-3458"><span class="linenos">3458</span></a><span class="sd">            Vertical scale (percentage) for positioning the colorbar.</span>
</span><span id="COMPsc.subcluster_features_scatter-3459"><a href="#COMPsc.subcluster_features_scatter-3459"><span class="linenos">3459</span></a>
</span><span id="COMPsc.subcluster_features_scatter-3460"><a href="#COMPsc.subcluster_features_scatter-3460"><span class="linenos">3460</span></a><span class="sd">        bbox_to_anchor_perc : tuple, default=(0.91, 0.63)</span>
</span><span id="COMPsc.subcluster_features_scatter-3461"><a href="#COMPsc.subcluster_features_scatter-3461"><span class="linenos">3461</span></a><span class="sd">            Anchor position for the size legend (percent bubble legend).</span>
</span><span id="COMPsc.subcluster_features_scatter-3462"><a href="#COMPsc.subcluster_features_scatter-3462"><span class="linenos">3462</span></a>
</span><span id="COMPsc.subcluster_features_scatter-3463"><a href="#COMPsc.subcluster_features_scatter-3463"><span class="linenos">3463</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc.subcluster_features_scatter-3464"><a href="#COMPsc.subcluster_features_scatter-3464"><span class="linenos">3464</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.subcluster_features_scatter-3465"><a href="#COMPsc.subcluster_features_scatter-3465"><span class="linenos">3465</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc.subcluster_features_scatter-3466"><a href="#COMPsc.subcluster_features_scatter-3466"><span class="linenos">3466</span></a>
</span><span id="COMPsc.subcluster_features_scatter-3467"><a href="#COMPsc.subcluster_features_scatter-3467"><span class="linenos">3467</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc.subcluster_features_scatter-3468"><a href="#COMPsc.subcluster_features_scatter-3468"><span class="linenos">3468</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.subcluster_features_scatter-3469"><a href="#COMPsc.subcluster_features_scatter-3469"><span class="linenos">3469</span></a><span class="sd">        RuntimeError</span>
</span><span id="COMPsc.subcluster_features_scatter-3470"><a href="#COMPsc.subcluster_features_scatter-3470"><span class="linenos">3470</span></a><span class="sd">            If subcluster preparation/definition has not been run.</span>
</span><span id="COMPsc.subcluster_features_scatter-3471"><a href="#COMPsc.subcluster_features_scatter-3471"><span class="linenos">3471</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.subcluster_features_scatter-3472"><a href="#COMPsc.subcluster_features_scatter-3472"><span class="linenos">3472</span></a>
</span><span id="COMPsc.subcluster_features_scatter-3473"><a href="#COMPsc.subcluster_features_scatter-3473"><span class="linenos">3473</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.subcluster_features_scatter-3474"><a href="#COMPsc.subcluster_features_scatter-3474"><span class="linenos">3474</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="COMPsc.subcluster_features_scatter-3475"><a href="#COMPsc.subcluster_features_scatter-3475"><span class="linenos">3475</span></a>                <span class="s2">&quot;Nothing to return. &#39;self.subcluster_prepare&#39; -&gt; &#39;self.define_subclusters&#39; pip was not conducted!&quot;</span>
</span><span id="COMPsc.subcluster_features_scatter-3476"><a href="#COMPsc.subcluster_features_scatter-3476"><span class="linenos">3476</span></a>            <span class="p">)</span>
</span><span id="COMPsc.subcluster_features_scatter-3477"><a href="#COMPsc.subcluster_features_scatter-3477"><span class="linenos">3477</span></a>
</span><span id="COMPsc.subcluster_features_scatter-3478"><a href="#COMPsc.subcluster_features_scatter-3478"><span class="linenos">3478</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span>
</span><span id="COMPsc.subcluster_features_scatter-3479"><a href="#COMPsc.subcluster_features_scatter-3479"><span class="linenos">3479</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">])</span>
</span><span id="COMPsc.subcluster_features_scatter-3480"><a href="#COMPsc.subcluster_features_scatter-3480"><span class="linenos">3480</span></a>
</span><span id="COMPsc.subcluster_features_scatter-3481"><a href="#COMPsc.subcluster_features_scatter-3481"><span class="linenos">3481</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="n">reduce_data</span><span class="p">(</span>
</span><span id="COMPsc.subcluster_features_scatter-3482"><a href="#COMPsc.subcluster_features_scatter-3482"><span class="linenos">3482</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3483"><a href="#COMPsc.subcluster_features_scatter-3483"><span class="linenos">3483</span></a>            <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">current_features</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3484"><a href="#COMPsc.subcluster_features_scatter-3484"><span class="linenos">3484</span></a>            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">current_cluster</span><span class="p">],</span>
</span><span id="COMPsc.subcluster_features_scatter-3485"><a href="#COMPsc.subcluster_features_scatter-3485"><span class="linenos">3485</span></a>        <span class="p">)</span>
</span><span id="COMPsc.subcluster_features_scatter-3486"><a href="#COMPsc.subcluster_features_scatter-3486"><span class="linenos">3486</span></a>
</span><span id="COMPsc.subcluster_features_scatter-3487"><a href="#COMPsc.subcluster_features_scatter-3487"><span class="linenos">3487</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span>
</span><span id="COMPsc.subcluster_features_scatter-3488"><a href="#COMPsc.subcluster_features_scatter-3488"><span class="linenos">3488</span></a>
</span><span id="COMPsc.subcluster_features_scatter-3489"><a href="#COMPsc.subcluster_features_scatter-3489"><span class="linenos">3489</span></a>        <span class="n">avg</span> <span class="o">=</span> <span class="n">average</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="COMPsc.subcluster_features_scatter-3490"><a href="#COMPsc.subcluster_features_scatter-3490"><span class="linenos">3490</span></a>        <span class="n">occ</span> <span class="o">=</span> <span class="n">occurrence</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="COMPsc.subcluster_features_scatter-3491"><a href="#COMPsc.subcluster_features_scatter-3491"><span class="linenos">3491</span></a>
</span><span id="COMPsc.subcluster_features_scatter-3492"><a href="#COMPsc.subcluster_features_scatter-3492"><span class="linenos">3492</span></a>        <span class="n">scatter</span> <span class="o">=</span> <span class="n">features_scatter</span><span class="p">(</span>
</span><span id="COMPsc.subcluster_features_scatter-3493"><a href="#COMPsc.subcluster_features_scatter-3493"><span class="linenos">3493</span></a>            <span class="n">expression_data</span><span class="o">=</span><span class="n">avg</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3494"><a href="#COMPsc.subcluster_features_scatter-3494"><span class="linenos">3494</span></a>            <span class="n">occurence_data</span><span class="o">=</span><span class="n">occ</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3495"><a href="#COMPsc.subcluster_features_scatter-3495"><span class="linenos">3495</span></a>            <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3496"><a href="#COMPsc.subcluster_features_scatter-3496"><span class="linenos">3496</span></a>            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3497"><a href="#COMPsc.subcluster_features_scatter-3497"><span class="linenos">3497</span></a>            <span class="n">metadata_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3498"><a href="#COMPsc.subcluster_features_scatter-3498"><span class="linenos">3498</span></a>            <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3499"><a href="#COMPsc.subcluster_features_scatter-3499"><span class="linenos">3499</span></a>            <span class="n">hclust</span><span class="o">=</span><span class="n">hclust</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3500"><a href="#COMPsc.subcluster_features_scatter-3500"><span class="linenos">3500</span></a>            <span class="n">img_width</span><span class="o">=</span><span class="n">img_width</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3501"><a href="#COMPsc.subcluster_features_scatter-3501"><span class="linenos">3501</span></a>            <span class="n">img_high</span><span class="o">=</span><span class="n">img_high</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3502"><a href="#COMPsc.subcluster_features_scatter-3502"><span class="linenos">3502</span></a>            <span class="n">label_size</span><span class="o">=</span><span class="n">label_size</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3503"><a href="#COMPsc.subcluster_features_scatter-3503"><span class="linenos">3503</span></a>            <span class="n">size_scale</span><span class="o">=</span><span class="n">size_scale</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3504"><a href="#COMPsc.subcluster_features_scatter-3504"><span class="linenos">3504</span></a>            <span class="n">y_lab</span><span class="o">=</span><span class="n">y_lab</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3505"><a href="#COMPsc.subcluster_features_scatter-3505"><span class="linenos">3505</span></a>            <span class="n">legend_lab</span><span class="o">=</span><span class="n">legend_lab</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3506"><a href="#COMPsc.subcluster_features_scatter-3506"><span class="linenos">3506</span></a>            <span class="n">bbox_to_anchor_scale</span><span class="o">=</span><span class="n">bbox_to_anchor_scale</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3507"><a href="#COMPsc.subcluster_features_scatter-3507"><span class="linenos">3507</span></a>            <span class="n">bbox_to_anchor_perc</span><span class="o">=</span><span class="n">bbox_to_anchor_perc</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_features_scatter-3508"><a href="#COMPsc.subcluster_features_scatter-3508"><span class="linenos">3508</span></a>        <span class="p">)</span>
</span><span id="COMPsc.subcluster_features_scatter-3509"><a href="#COMPsc.subcluster_features_scatter-3509"><span class="linenos">3509</span></a>
</span><span id="COMPsc.subcluster_features_scatter-3510"><a href="#COMPsc.subcluster_features_scatter-3510"><span class="linenos">3510</span></a>        <span class="k">return</span> <span class="n">scatter</span>
</span></pre></div>


            <div class="docstring"><p>Create a features-scatter visualization for the subclusters (averaged and occurrence).</p>

<h2 id="parameters">Parameters</h2>

<p>colors : str, default 'viridis'
    Colormap name passed to <code>features_scatter</code>.</p>

<p>hclust : str or None
    Hierarchical clustering linkage to order rows/columns.</p>

<p>scale: bool, default False
    If True, expression data will be scaled (0–1) across the rows (features).</p>

<p>img_width, img_high : float
    Figure size.</p>

<p>label_size : int
    Font size for labels.</p>

<p>size_scale : int
    Bubble size scaling.</p>

<p>y_lab : str
    X axis label.</p>

<p>legend_lab : str
    Colorbar label.</p>

<p>bbox_to_anchor_scale : int, default=25
    Vertical scale (percentage) for positioning the colorbar.</p>

<p>bbox_to_anchor_perc : tuple, default=(0.91, 0.63)
    Anchor position for the size legend (percent bubble legend).</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.figure.Figure</p>

<h2 id="raises">Raises</h2>

<p>RuntimeError
    If subcluster preparation/definition has not been run.</p>
</div>


                            </div>
                            <div id="COMPsc.subcluster_DEG_scatter" class="classattr">
                                        <input id="COMPsc.subcluster_DEG_scatter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">subcluster_DEG_scatter</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">top_n</span><span class="o">=</span><span class="mi">3</span>,</span><span class="param">	<span class="n">min_exp</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">min_pct</span><span class="o">=</span><span class="mf">0.25</span>,</span><span class="param">	<span class="n">p_val</span><span class="o">=</span><span class="mf">0.05</span>,</span><span class="param">	<span class="n">colors</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span>,</span><span class="param">	<span class="n">hclust</span><span class="o">=</span><span class="s1">&#39;complete&#39;</span>,</span><span class="param">	<span class="n">scale</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">img_width</span><span class="o">=</span><span class="mi">3</span>,</span><span class="param">	<span class="n">img_high</span><span class="o">=</span><span class="mi">5</span>,</span><span class="param">	<span class="n">label_size</span><span class="o">=</span><span class="mi">6</span>,</span><span class="param">	<span class="n">size_scale</span><span class="o">=</span><span class="mi">70</span>,</span><span class="param">	<span class="n">y_lab</span><span class="o">=</span><span class="s1">&#39;Genes&#39;</span>,</span><span class="param">	<span class="n">legend_lab</span><span class="o">=</span><span class="s1">&#39;normalized&#39;</span>,</span><span class="param">	<span class="n">bbox_to_anchor_scale</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span>,</span><span class="param">	<span class="n">bbox_to_anchor_perc</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.91</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">)</span>,</span><span class="param">	<span class="n">n_proc</span><span class="o">=</span><span class="mi">10</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.subcluster_DEG_scatter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.subcluster_DEG_scatter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.subcluster_DEG_scatter-3512"><a href="#COMPsc.subcluster_DEG_scatter-3512"><span class="linenos">3512</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">subcluster_DEG_scatter</span><span class="p">(</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3513"><a href="#COMPsc.subcluster_DEG_scatter-3513"><span class="linenos">3513</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3514"><a href="#COMPsc.subcluster_DEG_scatter-3514"><span class="linenos">3514</span></a>        <span class="n">top_n</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3515"><a href="#COMPsc.subcluster_DEG_scatter-3515"><span class="linenos">3515</span></a>        <span class="n">min_exp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3516"><a href="#COMPsc.subcluster_DEG_scatter-3516"><span class="linenos">3516</span></a>        <span class="n">min_pct</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3517"><a href="#COMPsc.subcluster_DEG_scatter-3517"><span class="linenos">3517</span></a>        <span class="n">p_val</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3518"><a href="#COMPsc.subcluster_DEG_scatter-3518"><span class="linenos">3518</span></a>        <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3519"><a href="#COMPsc.subcluster_DEG_scatter-3519"><span class="linenos">3519</span></a>        <span class="n">hclust</span><span class="o">=</span><span class="s2">&quot;complete&quot;</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3520"><a href="#COMPsc.subcluster_DEG_scatter-3520"><span class="linenos">3520</span></a>        <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3521"><a href="#COMPsc.subcluster_DEG_scatter-3521"><span class="linenos">3521</span></a>        <span class="n">img_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3522"><a href="#COMPsc.subcluster_DEG_scatter-3522"><span class="linenos">3522</span></a>        <span class="n">img_high</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3523"><a href="#COMPsc.subcluster_DEG_scatter-3523"><span class="linenos">3523</span></a>        <span class="n">label_size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3524"><a href="#COMPsc.subcluster_DEG_scatter-3524"><span class="linenos">3524</span></a>        <span class="n">size_scale</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3525"><a href="#COMPsc.subcluster_DEG_scatter-3525"><span class="linenos">3525</span></a>        <span class="n">y_lab</span><span class="o">=</span><span class="s2">&quot;Genes&quot;</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3526"><a href="#COMPsc.subcluster_DEG_scatter-3526"><span class="linenos">3526</span></a>        <span class="n">legend_lab</span><span class="o">=</span><span class="s2">&quot;normalized&quot;</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3527"><a href="#COMPsc.subcluster_DEG_scatter-3527"><span class="linenos">3527</span></a>        <span class="n">bbox_to_anchor_scale</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3528"><a href="#COMPsc.subcluster_DEG_scatter-3528"><span class="linenos">3528</span></a>        <span class="n">bbox_to_anchor_perc</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.91</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">),</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3529"><a href="#COMPsc.subcluster_DEG_scatter-3529"><span class="linenos">3529</span></a>        <span class="n">n_proc</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3530"><a href="#COMPsc.subcluster_DEG_scatter-3530"><span class="linenos">3530</span></a>    <span class="p">):</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3531"><a href="#COMPsc.subcluster_DEG_scatter-3531"><span class="linenos">3531</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3532"><a href="#COMPsc.subcluster_DEG_scatter-3532"><span class="linenos">3532</span></a><span class="sd">        Plot top differential features (DEGs) for subclusters as a features-scatter.</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3533"><a href="#COMPsc.subcluster_DEG_scatter-3533"><span class="linenos">3533</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3534"><a href="#COMPsc.subcluster_DEG_scatter-3534"><span class="linenos">3534</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3535"><a href="#COMPsc.subcluster_DEG_scatter-3535"><span class="linenos">3535</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3536"><a href="#COMPsc.subcluster_DEG_scatter-3536"><span class="linenos">3536</span></a><span class="sd">        top_n : int, default 3</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3537"><a href="#COMPsc.subcluster_DEG_scatter-3537"><span class="linenos">3537</span></a><span class="sd">            Number of top features per subcluster to show.</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3538"><a href="#COMPsc.subcluster_DEG_scatter-3538"><span class="linenos">3538</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3539"><a href="#COMPsc.subcluster_DEG_scatter-3539"><span class="linenos">3539</span></a><span class="sd">        min_exp : float, default 0</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3540"><a href="#COMPsc.subcluster_DEG_scatter-3540"><span class="linenos">3540</span></a><span class="sd">            Minimum expression threshold passed to `statistic`.</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3541"><a href="#COMPsc.subcluster_DEG_scatter-3541"><span class="linenos">3541</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3542"><a href="#COMPsc.subcluster_DEG_scatter-3542"><span class="linenos">3542</span></a><span class="sd">        min_pct : float, default 0.25</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3543"><a href="#COMPsc.subcluster_DEG_scatter-3543"><span class="linenos">3543</span></a><span class="sd">            Minimum percent expressed in target group.</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3544"><a href="#COMPsc.subcluster_DEG_scatter-3544"><span class="linenos">3544</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3545"><a href="#COMPsc.subcluster_DEG_scatter-3545"><span class="linenos">3545</span></a><span class="sd">        p_val: float, default 0.05</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3546"><a href="#COMPsc.subcluster_DEG_scatter-3546"><span class="linenos">3546</span></a><span class="sd">            Maximum p-value for visualizing features.</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3547"><a href="#COMPsc.subcluster_DEG_scatter-3547"><span class="linenos">3547</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3548"><a href="#COMPsc.subcluster_DEG_scatter-3548"><span class="linenos">3548</span></a><span class="sd">        n_proc : int, default 10</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3549"><a href="#COMPsc.subcluster_DEG_scatter-3549"><span class="linenos">3549</span></a><span class="sd">            Parallel jobs used for DEG calculation.</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3550"><a href="#COMPsc.subcluster_DEG_scatter-3550"><span class="linenos">3550</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3551"><a href="#COMPsc.subcluster_DEG_scatter-3551"><span class="linenos">3551</span></a><span class="sd">        scale: bool, default False</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3552"><a href="#COMPsc.subcluster_DEG_scatter-3552"><span class="linenos">3552</span></a><span class="sd">            If True, expression_data will be scaled (0–1) across the rows (features).</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3553"><a href="#COMPsc.subcluster_DEG_scatter-3553"><span class="linenos">3553</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3554"><a href="#COMPsc.subcluster_DEG_scatter-3554"><span class="linenos">3554</span></a><span class="sd">        colors : str, default=&#39;viridis&#39;</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3555"><a href="#COMPsc.subcluster_DEG_scatter-3555"><span class="linenos">3555</span></a><span class="sd">            Colormap for expression values.</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3556"><a href="#COMPsc.subcluster_DEG_scatter-3556"><span class="linenos">3556</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3557"><a href="#COMPsc.subcluster_DEG_scatter-3557"><span class="linenos">3557</span></a><span class="sd">        hclust : str or None, default=&#39;complete&#39;</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3558"><a href="#COMPsc.subcluster_DEG_scatter-3558"><span class="linenos">3558</span></a><span class="sd">            Linkage method for hierarchical clustering. If None, no clustering</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3559"><a href="#COMPsc.subcluster_DEG_scatter-3559"><span class="linenos">3559</span></a><span class="sd">            is performed.</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3560"><a href="#COMPsc.subcluster_DEG_scatter-3560"><span class="linenos">3560</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3561"><a href="#COMPsc.subcluster_DEG_scatter-3561"><span class="linenos">3561</span></a><span class="sd">        img_width : int or float, default=8</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3562"><a href="#COMPsc.subcluster_DEG_scatter-3562"><span class="linenos">3562</span></a><span class="sd">            Width of the plot in inches.</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3563"><a href="#COMPsc.subcluster_DEG_scatter-3563"><span class="linenos">3563</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3564"><a href="#COMPsc.subcluster_DEG_scatter-3564"><span class="linenos">3564</span></a><span class="sd">        img_high : int or float, default=5</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3565"><a href="#COMPsc.subcluster_DEG_scatter-3565"><span class="linenos">3565</span></a><span class="sd">            Height of the plot in inches.</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3566"><a href="#COMPsc.subcluster_DEG_scatter-3566"><span class="linenos">3566</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3567"><a href="#COMPsc.subcluster_DEG_scatter-3567"><span class="linenos">3567</span></a><span class="sd">        label_size : int, default=10</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3568"><a href="#COMPsc.subcluster_DEG_scatter-3568"><span class="linenos">3568</span></a><span class="sd">            Font size for axis labels and ticks.</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3569"><a href="#COMPsc.subcluster_DEG_scatter-3569"><span class="linenos">3569</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3570"><a href="#COMPsc.subcluster_DEG_scatter-3570"><span class="linenos">3570</span></a><span class="sd">        size_scale : int or float, default=100</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3571"><a href="#COMPsc.subcluster_DEG_scatter-3571"><span class="linenos">3571</span></a><span class="sd">            Scaling factor for bubble sizes.</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3572"><a href="#COMPsc.subcluster_DEG_scatter-3572"><span class="linenos">3572</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3573"><a href="#COMPsc.subcluster_DEG_scatter-3573"><span class="linenos">3573</span></a><span class="sd">        y_lab : str, default=&#39;Genes&#39;</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3574"><a href="#COMPsc.subcluster_DEG_scatter-3574"><span class="linenos">3574</span></a><span class="sd">            Label for the x-axis.</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3575"><a href="#COMPsc.subcluster_DEG_scatter-3575"><span class="linenos">3575</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3576"><a href="#COMPsc.subcluster_DEG_scatter-3576"><span class="linenos">3576</span></a><span class="sd">        legend_lab : str, default=&#39;normalized&#39;</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3577"><a href="#COMPsc.subcluster_DEG_scatter-3577"><span class="linenos">3577</span></a><span class="sd">            Label for the colorbar legend.</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3578"><a href="#COMPsc.subcluster_DEG_scatter-3578"><span class="linenos">3578</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3579"><a href="#COMPsc.subcluster_DEG_scatter-3579"><span class="linenos">3579</span></a><span class="sd">        bbox_to_anchor_scale : int, default=25</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3580"><a href="#COMPsc.subcluster_DEG_scatter-3580"><span class="linenos">3580</span></a><span class="sd">            Vertical scale (percentage) for positioning the colorbar.</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3581"><a href="#COMPsc.subcluster_DEG_scatter-3581"><span class="linenos">3581</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3582"><a href="#COMPsc.subcluster_DEG_scatter-3582"><span class="linenos">3582</span></a><span class="sd">        bbox_to_anchor_perc : tuple, default=(0.91, 0.63)</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3583"><a href="#COMPsc.subcluster_DEG_scatter-3583"><span class="linenos">3583</span></a><span class="sd">            Anchor position for the size legend (percent bubble legend).</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3584"><a href="#COMPsc.subcluster_DEG_scatter-3584"><span class="linenos">3584</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3585"><a href="#COMPsc.subcluster_DEG_scatter-3585"><span class="linenos">3585</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3586"><a href="#COMPsc.subcluster_DEG_scatter-3586"><span class="linenos">3586</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3587"><a href="#COMPsc.subcluster_DEG_scatter-3587"><span class="linenos">3587</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3588"><a href="#COMPsc.subcluster_DEG_scatter-3588"><span class="linenos">3588</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3589"><a href="#COMPsc.subcluster_DEG_scatter-3589"><span class="linenos">3589</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3590"><a href="#COMPsc.subcluster_DEG_scatter-3590"><span class="linenos">3590</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3591"><a href="#COMPsc.subcluster_DEG_scatter-3591"><span class="linenos">3591</span></a><span class="sd">        RuntimeError</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3592"><a href="#COMPsc.subcluster_DEG_scatter-3592"><span class="linenos">3592</span></a><span class="sd">            If subcluster preparation/definition has not been run.</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3593"><a href="#COMPsc.subcluster_DEG_scatter-3593"><span class="linenos">3593</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3594"><a href="#COMPsc.subcluster_DEG_scatter-3594"><span class="linenos">3594</span></a><span class="sd">        Notes</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3595"><a href="#COMPsc.subcluster_DEG_scatter-3595"><span class="linenos">3595</span></a><span class="sd">        -----</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3596"><a href="#COMPsc.subcluster_DEG_scatter-3596"><span class="linenos">3596</span></a><span class="sd">        Internally calls `calc_DEG` (or equivalent) to obtain statistics, filters</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3597"><a href="#COMPsc.subcluster_DEG_scatter-3597"><span class="linenos">3597</span></a><span class="sd">        by p-value and effect-size, selects top features per valid group and plots them.</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3598"><a href="#COMPsc.subcluster_DEG_scatter-3598"><span class="linenos">3598</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3599"><a href="#COMPsc.subcluster_DEG_scatter-3599"><span class="linenos">3599</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3600"><a href="#COMPsc.subcluster_DEG_scatter-3600"><span class="linenos">3600</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3601"><a href="#COMPsc.subcluster_DEG_scatter-3601"><span class="linenos">3601</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3602"><a href="#COMPsc.subcluster_DEG_scatter-3602"><span class="linenos">3602</span></a>                <span class="s2">&quot;Nothing to return. &#39;self.subcluster_prepare&#39; -&gt; &#39;self.define_subclusters&#39; pip was not conducted!&quot;</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3603"><a href="#COMPsc.subcluster_DEG_scatter-3603"><span class="linenos">3603</span></a>            <span class="p">)</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3604"><a href="#COMPsc.subcluster_DEG_scatter-3604"><span class="linenos">3604</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3605"><a href="#COMPsc.subcluster_DEG_scatter-3605"><span class="linenos">3605</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3606"><a href="#COMPsc.subcluster_DEG_scatter-3606"><span class="linenos">3606</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">])</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3607"><a href="#COMPsc.subcluster_DEG_scatter-3607"><span class="linenos">3607</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3608"><a href="#COMPsc.subcluster_DEG_scatter-3608"><span class="linenos">3608</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="n">reduce_data</span><span class="p">(</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3609"><a href="#COMPsc.subcluster_DEG_scatter-3609"><span class="linenos">3609</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_data</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">current_cluster</span><span class="p">]</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3610"><a href="#COMPsc.subcluster_DEG_scatter-3610"><span class="linenos">3610</span></a>        <span class="p">)</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3611"><a href="#COMPsc.subcluster_DEG_scatter-3611"><span class="linenos">3611</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3612"><a href="#COMPsc.subcluster_DEG_scatter-3612"><span class="linenos">3612</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3613"><a href="#COMPsc.subcluster_DEG_scatter-3613"><span class="linenos">3613</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3614"><a href="#COMPsc.subcluster_DEG_scatter-3614"><span class="linenos">3614</span></a>        <span class="n">deg_stats</span> <span class="o">=</span> <span class="n">calc_DEG</span><span class="p">(</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3615"><a href="#COMPsc.subcluster_DEG_scatter-3615"><span class="linenos">3615</span></a>            <span class="n">dat</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3616"><a href="#COMPsc.subcluster_DEG_scatter-3616"><span class="linenos">3616</span></a>            <span class="n">metadata_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3617"><a href="#COMPsc.subcluster_DEG_scatter-3617"><span class="linenos">3617</span></a>            <span class="n">entities</span><span class="o">=</span><span class="s2">&quot;All&quot;</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3618"><a href="#COMPsc.subcluster_DEG_scatter-3618"><span class="linenos">3618</span></a>            <span class="n">sets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3619"><a href="#COMPsc.subcluster_DEG_scatter-3619"><span class="linenos">3619</span></a>            <span class="n">min_exp</span><span class="o">=</span><span class="n">min_exp</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3620"><a href="#COMPsc.subcluster_DEG_scatter-3620"><span class="linenos">3620</span></a>            <span class="n">min_pct</span><span class="o">=</span><span class="n">min_pct</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3621"><a href="#COMPsc.subcluster_DEG_scatter-3621"><span class="linenos">3621</span></a>            <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3622"><a href="#COMPsc.subcluster_DEG_scatter-3622"><span class="linenos">3622</span></a>        <span class="p">)</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3623"><a href="#COMPsc.subcluster_DEG_scatter-3623"><span class="linenos">3623</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3624"><a href="#COMPsc.subcluster_DEG_scatter-3624"><span class="linenos">3624</span></a>        <span class="n">deg_stats</span> <span class="o">=</span> <span class="n">deg_stats</span><span class="p">[</span><span class="n">deg_stats</span><span class="p">[</span><span class="s2">&quot;p_val&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_val</span><span class="p">]</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3625"><a href="#COMPsc.subcluster_DEG_scatter-3625"><span class="linenos">3625</span></a>        <span class="n">deg_stats</span> <span class="o">=</span> <span class="n">deg_stats</span><span class="p">[</span><span class="n">deg_stats</span><span class="p">[</span><span class="s2">&quot;log(FC)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3626"><a href="#COMPsc.subcluster_DEG_scatter-3626"><span class="linenos">3626</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3627"><a href="#COMPsc.subcluster_DEG_scatter-3627"><span class="linenos">3627</span></a>        <span class="n">deg_stats</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3628"><a href="#COMPsc.subcluster_DEG_scatter-3628"><span class="linenos">3628</span></a>            <span class="n">deg_stats</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3629"><a href="#COMPsc.subcluster_DEG_scatter-3629"><span class="linenos">3629</span></a>                <span class="p">[</span><span class="s2">&quot;valid_group&quot;</span><span class="p">,</span> <span class="s2">&quot;esm&quot;</span><span class="p">,</span> <span class="s2">&quot;log(FC)&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3630"><a href="#COMPsc.subcluster_DEG_scatter-3630"><span class="linenos">3630</span></a>            <span class="p">)</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3631"><a href="#COMPsc.subcluster_DEG_scatter-3631"><span class="linenos">3631</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;valid_group&quot;</span><span class="p">)</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3632"><a href="#COMPsc.subcluster_DEG_scatter-3632"><span class="linenos">3632</span></a>            <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">top_n</span><span class="p">)</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3633"><a href="#COMPsc.subcluster_DEG_scatter-3633"><span class="linenos">3633</span></a>        <span class="p">)</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3634"><a href="#COMPsc.subcluster_DEG_scatter-3634"><span class="linenos">3634</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3635"><a href="#COMPsc.subcluster_DEG_scatter-3635"><span class="linenos">3635</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="n">reduce_data</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">deg_stats</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">])))</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3636"><a href="#COMPsc.subcluster_DEG_scatter-3636"><span class="linenos">3636</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3637"><a href="#COMPsc.subcluster_DEG_scatter-3637"><span class="linenos">3637</span></a>        <span class="n">avg</span> <span class="o">=</span> <span class="n">average</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3638"><a href="#COMPsc.subcluster_DEG_scatter-3638"><span class="linenos">3638</span></a>        <span class="n">occ</span> <span class="o">=</span> <span class="n">occurrence</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3639"><a href="#COMPsc.subcluster_DEG_scatter-3639"><span class="linenos">3639</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3640"><a href="#COMPsc.subcluster_DEG_scatter-3640"><span class="linenos">3640</span></a>        <span class="n">scatter</span> <span class="o">=</span> <span class="n">features_scatter</span><span class="p">(</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3641"><a href="#COMPsc.subcluster_DEG_scatter-3641"><span class="linenos">3641</span></a>            <span class="n">expression_data</span><span class="o">=</span><span class="n">avg</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3642"><a href="#COMPsc.subcluster_DEG_scatter-3642"><span class="linenos">3642</span></a>            <span class="n">occurence_data</span><span class="o">=</span><span class="n">occ</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3643"><a href="#COMPsc.subcluster_DEG_scatter-3643"><span class="linenos">3643</span></a>            <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3644"><a href="#COMPsc.subcluster_DEG_scatter-3644"><span class="linenos">3644</span></a>            <span class="n">metadata_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3645"><a href="#COMPsc.subcluster_DEG_scatter-3645"><span class="linenos">3645</span></a>            <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3646"><a href="#COMPsc.subcluster_DEG_scatter-3646"><span class="linenos">3646</span></a>            <span class="n">hclust</span><span class="o">=</span><span class="n">hclust</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3647"><a href="#COMPsc.subcluster_DEG_scatter-3647"><span class="linenos">3647</span></a>            <span class="n">img_width</span><span class="o">=</span><span class="n">img_width</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3648"><a href="#COMPsc.subcluster_DEG_scatter-3648"><span class="linenos">3648</span></a>            <span class="n">img_high</span><span class="o">=</span><span class="n">img_high</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3649"><a href="#COMPsc.subcluster_DEG_scatter-3649"><span class="linenos">3649</span></a>            <span class="n">label_size</span><span class="o">=</span><span class="n">label_size</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3650"><a href="#COMPsc.subcluster_DEG_scatter-3650"><span class="linenos">3650</span></a>            <span class="n">size_scale</span><span class="o">=</span><span class="n">size_scale</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3651"><a href="#COMPsc.subcluster_DEG_scatter-3651"><span class="linenos">3651</span></a>            <span class="n">y_lab</span><span class="o">=</span><span class="n">y_lab</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3652"><a href="#COMPsc.subcluster_DEG_scatter-3652"><span class="linenos">3652</span></a>            <span class="n">legend_lab</span><span class="o">=</span><span class="n">legend_lab</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3653"><a href="#COMPsc.subcluster_DEG_scatter-3653"><span class="linenos">3653</span></a>            <span class="n">bbox_to_anchor_scale</span><span class="o">=</span><span class="n">bbox_to_anchor_scale</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3654"><a href="#COMPsc.subcluster_DEG_scatter-3654"><span class="linenos">3654</span></a>            <span class="n">bbox_to_anchor_perc</span><span class="o">=</span><span class="n">bbox_to_anchor_perc</span><span class="p">,</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3655"><a href="#COMPsc.subcluster_DEG_scatter-3655"><span class="linenos">3655</span></a>        <span class="p">)</span>
</span><span id="COMPsc.subcluster_DEG_scatter-3656"><a href="#COMPsc.subcluster_DEG_scatter-3656"><span class="linenos">3656</span></a>
</span><span id="COMPsc.subcluster_DEG_scatter-3657"><a href="#COMPsc.subcluster_DEG_scatter-3657"><span class="linenos">3657</span></a>        <span class="k">return</span> <span class="n">scatter</span>
</span></pre></div>


            <div class="docstring"><p>Plot top differential features (DEGs) for subclusters as a features-scatter.</p>

<h2 id="parameters">Parameters</h2>

<p>top_n : int, default 3
    Number of top features per subcluster to show.</p>

<p>min_exp : float, default 0
    Minimum expression threshold passed to <code><a href="#COMPsc.statistic">statistic</a></code>.</p>

<p>min_pct : float, default 0.25
    Minimum percent expressed in target group.</p>

<p>p_val: float, default 0.05
    Maximum p-value for visualizing features.</p>

<p>n_proc : int, default 10
    Parallel jobs used for DEG calculation.</p>

<p>scale: bool, default False
    If True, expression_data will be scaled (0–1) across the rows (features).</p>

<p>colors : str, default='viridis'
    Colormap for expression values.</p>

<p>hclust : str or None, default='complete'
    Linkage method for hierarchical clustering. If None, no clustering
    is performed.</p>

<p>img_width : int or float, default=8
    Width of the plot in inches.</p>

<p>img_high : int or float, default=5
    Height of the plot in inches.</p>

<p>label_size : int, default=10
    Font size for axis labels and ticks.</p>

<p>size_scale : int or float, default=100
    Scaling factor for bubble sizes.</p>

<p>y_lab : str, default='Genes'
    Label for the x-axis.</p>

<p>legend_lab : str, default='normalized'
    Label for the colorbar legend.</p>

<p>bbox_to_anchor_scale : int, default=25
    Vertical scale (percentage) for positioning the colorbar.</p>

<p>bbox_to_anchor_perc : tuple, default=(0.91, 0.63)
    Anchor position for the size legend (percent bubble legend).</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.figure.Figure</p>

<h2 id="raises">Raises</h2>

<p>RuntimeError
    If subcluster preparation/definition has not been run.</p>

<h2 id="notes">Notes</h2>

<p>Internally calls <code>calc_DEG</code> (or equivalent) to obtain statistics, filters
by p-value and effect-size, selects top features per valid group and plots them.</p>
</div>


                            </div>
                            <div id="COMPsc.accept_subclusters" class="classattr">
                                        <input id="COMPsc.accept_subclusters-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">accept_subclusters</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.accept_subclusters-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.accept_subclusters"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.accept_subclusters-3659"><a href="#COMPsc.accept_subclusters-3659"><span class="linenos">3659</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">accept_subclusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="COMPsc.accept_subclusters-3660"><a href="#COMPsc.accept_subclusters-3660"><span class="linenos">3660</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.accept_subclusters-3661"><a href="#COMPsc.accept_subclusters-3661"><span class="linenos">3661</span></a><span class="sd">        Commit subcluster labels into the main `input_metadata` by renaming cell names.</span>
</span><span id="COMPsc.accept_subclusters-3662"><a href="#COMPsc.accept_subclusters-3662"><span class="linenos">3662</span></a>
</span><span id="COMPsc.accept_subclusters-3663"><a href="#COMPsc.accept_subclusters-3663"><span class="linenos">3663</span></a><span class="sd">        The method replaces occurrences of the parent cluster name in `self.input_metadata[&#39;cell_names&#39;]`</span>
</span><span id="COMPsc.accept_subclusters-3664"><a href="#COMPsc.accept_subclusters-3664"><span class="linenos">3664</span></a><span class="sd">        with the expanded names that include subcluster suffixes (via `add_subnames`),</span>
</span><span id="COMPsc.accept_subclusters-3665"><a href="#COMPsc.accept_subclusters-3665"><span class="linenos">3665</span></a><span class="sd">        then clears `self.subclusters_`.</span>
</span><span id="COMPsc.accept_subclusters-3666"><a href="#COMPsc.accept_subclusters-3666"><span class="linenos">3666</span></a>
</span><span id="COMPsc.accept_subclusters-3667"><a href="#COMPsc.accept_subclusters-3667"><span class="linenos">3667</span></a><span class="sd">        Update</span>
</span><span id="COMPsc.accept_subclusters-3668"><a href="#COMPsc.accept_subclusters-3668"><span class="linenos">3668</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.accept_subclusters-3669"><a href="#COMPsc.accept_subclusters-3669"><span class="linenos">3669</span></a><span class="sd">        Modifies `self.input_metadata[&#39;cell_names&#39;]`.</span>
</span><span id="COMPsc.accept_subclusters-3670"><a href="#COMPsc.accept_subclusters-3670"><span class="linenos">3670</span></a>
</span><span id="COMPsc.accept_subclusters-3671"><a href="#COMPsc.accept_subclusters-3671"><span class="linenos">3671</span></a><span class="sd">        Resets `self.subclusters_` to None.</span>
</span><span id="COMPsc.accept_subclusters-3672"><a href="#COMPsc.accept_subclusters-3672"><span class="linenos">3672</span></a>
</span><span id="COMPsc.accept_subclusters-3673"><a href="#COMPsc.accept_subclusters-3673"><span class="linenos">3673</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc.accept_subclusters-3674"><a href="#COMPsc.accept_subclusters-3674"><span class="linenos">3674</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.accept_subclusters-3675"><a href="#COMPsc.accept_subclusters-3675"><span class="linenos">3675</span></a><span class="sd">        RuntimeError</span>
</span><span id="COMPsc.accept_subclusters-3676"><a href="#COMPsc.accept_subclusters-3676"><span class="linenos">3676</span></a><span class="sd">            If `self.subclusters_` is not defined or subclusters were not computed.</span>
</span><span id="COMPsc.accept_subclusters-3677"><a href="#COMPsc.accept_subclusters-3677"><span class="linenos">3677</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.accept_subclusters-3678"><a href="#COMPsc.accept_subclusters-3678"><span class="linenos">3678</span></a>
</span><span id="COMPsc.accept_subclusters-3679"><a href="#COMPsc.accept_subclusters-3679"><span class="linenos">3679</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.accept_subclusters-3680"><a href="#COMPsc.accept_subclusters-3680"><span class="linenos">3680</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="COMPsc.accept_subclusters-3681"><a href="#COMPsc.accept_subclusters-3681"><span class="linenos">3681</span></a>                <span class="s2">&quot;Nothing to return. &#39;self.subcluster_prepare&#39; -&gt; &#39;self.define_subclusters&#39; pip was not conducted!&quot;</span>
</span><span id="COMPsc.accept_subclusters-3682"><a href="#COMPsc.accept_subclusters-3682"><span class="linenos">3682</span></a>            <span class="p">)</span>
</span><span id="COMPsc.accept_subclusters-3683"><a href="#COMPsc.accept_subclusters-3683"><span class="linenos">3683</span></a>
</span><span id="COMPsc.accept_subclusters-3684"><a href="#COMPsc.accept_subclusters-3684"><span class="linenos">3684</span></a>        <span class="n">new_meta</span> <span class="o">=</span> <span class="n">add_subnames</span><span class="p">(</span>
</span><span id="COMPsc.accept_subclusters-3685"><a href="#COMPsc.accept_subclusters-3685"><span class="linenos">3685</span></a>            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]),</span>
</span><span id="COMPsc.accept_subclusters-3686"><a href="#COMPsc.accept_subclusters-3686"><span class="linenos">3686</span></a>            <span class="n">parent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">current_cluster</span><span class="p">,</span>
</span><span id="COMPsc.accept_subclusters-3687"><a href="#COMPsc.accept_subclusters-3687"><span class="linenos">3687</span></a>            <span class="n">new_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span><span class="o">.</span><span class="n">subclusters</span><span class="p">,</span>
</span><span id="COMPsc.accept_subclusters-3688"><a href="#COMPsc.accept_subclusters-3688"><span class="linenos">3688</span></a>        <span class="p">)</span>
</span><span id="COMPsc.accept_subclusters-3689"><a href="#COMPsc.accept_subclusters-3689"><span class="linenos">3689</span></a>
</span><span id="COMPsc.accept_subclusters-3690"><a href="#COMPsc.accept_subclusters-3690"><span class="linenos">3690</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_meta</span>
</span><span id="COMPsc.accept_subclusters-3691"><a href="#COMPsc.accept_subclusters-3691"><span class="linenos">3691</span></a>
</span><span id="COMPsc.accept_subclusters-3692"><a href="#COMPsc.accept_subclusters-3692"><span class="linenos">3692</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subclusters_</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Commit subcluster labels into the main <code><a href="#COMPsc.input_metadata">input_metadata</a></code> by renaming cell names.</p>

<p>The method replaces occurrences of the parent cluster name in <code>self.input_metadata['cell_names']</code>
with the expanded names that include subcluster suffixes (via <code>add_subnames</code>),
then clears <code>self.subclusters_</code>.</p>

<h2 id="update">Update</h2>

<p>Modifies <code>self.input_metadata['cell_names']</code>.</p>

<p>Resets <code>self.subclusters_</code> to None.</p>

<h2 id="raises">Raises</h2>

<p>RuntimeError
    If <code>self.subclusters_</code> is not defined or subclusters were not computed.</p>
</div>


                            </div>
                            <div id="COMPsc.scatter_plot" class="classattr">
                                        <input id="COMPsc.scatter_plot-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">scatter_plot</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">features</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cell_names&#39;</span>,</span><span class="param">	<span class="n">scale</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">colors</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span>,</span><span class="param">	<span class="n">hclust</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">img_width</span><span class="o">=</span><span class="mi">15</span>,</span><span class="param">	<span class="n">img_high</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">label_size</span><span class="o">=</span><span class="mi">10</span>,</span><span class="param">	<span class="n">size_scale</span><span class="o">=</span><span class="mi">200</span>,</span><span class="param">	<span class="n">y_lab</span><span class="o">=</span><span class="s1">&#39;Genes&#39;</span>,</span><span class="param">	<span class="n">legend_lab</span><span class="o">=</span><span class="s1">&#39;log(CPM + 1)&#39;</span>,</span><span class="param">	<span class="n">set_box_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>,</span><span class="param">	<span class="n">set_box_high</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>,</span><span class="param">	<span class="n">bbox_to_anchor_scale</span><span class="o">=</span><span class="mi">25</span>,</span><span class="param">	<span class="n">bbox_to_anchor_perc</span><span class="o">=</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.24</span><span class="p">)</span>,</span><span class="param">	<span class="n">bbox_to_anchor_group</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.scatter_plot-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.scatter_plot"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.scatter_plot-3694"><a href="#COMPsc.scatter_plot-3694"><span class="linenos">3694</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">scatter_plot</span><span class="p">(</span>
</span><span id="COMPsc.scatter_plot-3695"><a href="#COMPsc.scatter_plot-3695"><span class="linenos">3695</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3696"><a href="#COMPsc.scatter_plot-3696"><span class="linenos">3696</span></a>        <span class="n">names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3697"><a href="#COMPsc.scatter_plot-3697"><span class="linenos">3697</span></a>        <span class="n">features</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3698"><a href="#COMPsc.scatter_plot-3698"><span class="linenos">3698</span></a>        <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3699"><a href="#COMPsc.scatter_plot-3699"><span class="linenos">3699</span></a>        <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3700"><a href="#COMPsc.scatter_plot-3700"><span class="linenos">3700</span></a>        <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3701"><a href="#COMPsc.scatter_plot-3701"><span class="linenos">3701</span></a>        <span class="n">hclust</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3702"><a href="#COMPsc.scatter_plot-3702"><span class="linenos">3702</span></a>        <span class="n">img_width</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3703"><a href="#COMPsc.scatter_plot-3703"><span class="linenos">3703</span></a>        <span class="n">img_high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3704"><a href="#COMPsc.scatter_plot-3704"><span class="linenos">3704</span></a>        <span class="n">label_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3705"><a href="#COMPsc.scatter_plot-3705"><span class="linenos">3705</span></a>        <span class="n">size_scale</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3706"><a href="#COMPsc.scatter_plot-3706"><span class="linenos">3706</span></a>        <span class="n">y_lab</span><span class="o">=</span><span class="s2">&quot;Genes&quot;</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3707"><a href="#COMPsc.scatter_plot-3707"><span class="linenos">3707</span></a>        <span class="n">legend_lab</span><span class="o">=</span><span class="s2">&quot;log(CPM + 1)&quot;</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3708"><a href="#COMPsc.scatter_plot-3708"><span class="linenos">3708</span></a>        <span class="n">set_box_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3709"><a href="#COMPsc.scatter_plot-3709"><span class="linenos">3709</span></a>        <span class="n">set_box_high</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3710"><a href="#COMPsc.scatter_plot-3710"><span class="linenos">3710</span></a>        <span class="n">bbox_to_anchor_scale</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3711"><a href="#COMPsc.scatter_plot-3711"><span class="linenos">3711</span></a>        <span class="n">bbox_to_anchor_perc</span><span class="o">=</span><span class="p">(</span><span class="mf">0.90</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.24</span><span class="p">),</span>
</span><span id="COMPsc.scatter_plot-3712"><a href="#COMPsc.scatter_plot-3712"><span class="linenos">3712</span></a>        <span class="n">bbox_to_anchor_group</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">),</span>
</span><span id="COMPsc.scatter_plot-3713"><a href="#COMPsc.scatter_plot-3713"><span class="linenos">3713</span></a>    <span class="p">):</span>
</span><span id="COMPsc.scatter_plot-3714"><a href="#COMPsc.scatter_plot-3714"><span class="linenos">3714</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.scatter_plot-3715"><a href="#COMPsc.scatter_plot-3715"><span class="linenos">3715</span></a><span class="sd">        Create a bubble scatter plot of selected features across samples inside project.</span>
</span><span id="COMPsc.scatter_plot-3716"><a href="#COMPsc.scatter_plot-3716"><span class="linenos">3716</span></a>
</span><span id="COMPsc.scatter_plot-3717"><a href="#COMPsc.scatter_plot-3717"><span class="linenos">3717</span></a><span class="sd">        Each point represents a feature-sample pair, where the color encodes the</span>
</span><span id="COMPsc.scatter_plot-3718"><a href="#COMPsc.scatter_plot-3718"><span class="linenos">3718</span></a><span class="sd">        expression value and the size encodes occurrence or relative abundance.</span>
</span><span id="COMPsc.scatter_plot-3719"><a href="#COMPsc.scatter_plot-3719"><span class="linenos">3719</span></a><span class="sd">        Optionally, hierarchical clustering can be applied to order rows and columns.</span>
</span><span id="COMPsc.scatter_plot-3720"><a href="#COMPsc.scatter_plot-3720"><span class="linenos">3720</span></a>
</span><span id="COMPsc.scatter_plot-3721"><a href="#COMPsc.scatter_plot-3721"><span class="linenos">3721</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.scatter_plot-3722"><a href="#COMPsc.scatter_plot-3722"><span class="linenos">3722</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.scatter_plot-3723"><a href="#COMPsc.scatter_plot-3723"><span class="linenos">3723</span></a><span class="sd">        names : list, str, or None</span>
</span><span id="COMPsc.scatter_plot-3724"><a href="#COMPsc.scatter_plot-3724"><span class="linenos">3724</span></a><span class="sd">            Names of samples to include. If None, all samples are considered.</span>
</span><span id="COMPsc.scatter_plot-3725"><a href="#COMPsc.scatter_plot-3725"><span class="linenos">3725</span></a>
</span><span id="COMPsc.scatter_plot-3726"><a href="#COMPsc.scatter_plot-3726"><span class="linenos">3726</span></a><span class="sd">        features : list, str, or None</span>
</span><span id="COMPsc.scatter_plot-3727"><a href="#COMPsc.scatter_plot-3727"><span class="linenos">3727</span></a><span class="sd">            Names of features to include. If None, all features are considered.</span>
</span><span id="COMPsc.scatter_plot-3728"><a href="#COMPsc.scatter_plot-3728"><span class="linenos">3728</span></a>
</span><span id="COMPsc.scatter_plot-3729"><a href="#COMPsc.scatter_plot-3729"><span class="linenos">3729</span></a><span class="sd">        name_slot : str</span>
</span><span id="COMPsc.scatter_plot-3730"><a href="#COMPsc.scatter_plot-3730"><span class="linenos">3730</span></a><span class="sd">            Column in metadata to use as sample names.</span>
</span><span id="COMPsc.scatter_plot-3731"><a href="#COMPsc.scatter_plot-3731"><span class="linenos">3731</span></a>
</span><span id="COMPsc.scatter_plot-3732"><a href="#COMPsc.scatter_plot-3732"><span class="linenos">3732</span></a><span class="sd">        scale: bool, default False</span>
</span><span id="COMPsc.scatter_plot-3733"><a href="#COMPsc.scatter_plot-3733"><span class="linenos">3733</span></a><span class="sd">            If True, expression_data will be scaled (0–1) across the rows (features).</span>
</span><span id="COMPsc.scatter_plot-3734"><a href="#COMPsc.scatter_plot-3734"><span class="linenos">3734</span></a>
</span><span id="COMPsc.scatter_plot-3735"><a href="#COMPsc.scatter_plot-3735"><span class="linenos">3735</span></a><span class="sd">        colors : str, default=&#39;viridis&#39;</span>
</span><span id="COMPsc.scatter_plot-3736"><a href="#COMPsc.scatter_plot-3736"><span class="linenos">3736</span></a><span class="sd">            Colormap for expression values.</span>
</span><span id="COMPsc.scatter_plot-3737"><a href="#COMPsc.scatter_plot-3737"><span class="linenos">3737</span></a>
</span><span id="COMPsc.scatter_plot-3738"><a href="#COMPsc.scatter_plot-3738"><span class="linenos">3738</span></a><span class="sd">        hclust : str or None, default=&#39;complete&#39;</span>
</span><span id="COMPsc.scatter_plot-3739"><a href="#COMPsc.scatter_plot-3739"><span class="linenos">3739</span></a><span class="sd">            Linkage method for hierarchical clustering. If None, no clustering</span>
</span><span id="COMPsc.scatter_plot-3740"><a href="#COMPsc.scatter_plot-3740"><span class="linenos">3740</span></a><span class="sd">            is performed.</span>
</span><span id="COMPsc.scatter_plot-3741"><a href="#COMPsc.scatter_plot-3741"><span class="linenos">3741</span></a>
</span><span id="COMPsc.scatter_plot-3742"><a href="#COMPsc.scatter_plot-3742"><span class="linenos">3742</span></a><span class="sd">        img_width : int or float, default=8</span>
</span><span id="COMPsc.scatter_plot-3743"><a href="#COMPsc.scatter_plot-3743"><span class="linenos">3743</span></a><span class="sd">            Width of the plot in inches.</span>
</span><span id="COMPsc.scatter_plot-3744"><a href="#COMPsc.scatter_plot-3744"><span class="linenos">3744</span></a>
</span><span id="COMPsc.scatter_plot-3745"><a href="#COMPsc.scatter_plot-3745"><span class="linenos">3745</span></a><span class="sd">        img_high : int or float, default=5</span>
</span><span id="COMPsc.scatter_plot-3746"><a href="#COMPsc.scatter_plot-3746"><span class="linenos">3746</span></a><span class="sd">            Height of the plot in inches.</span>
</span><span id="COMPsc.scatter_plot-3747"><a href="#COMPsc.scatter_plot-3747"><span class="linenos">3747</span></a>
</span><span id="COMPsc.scatter_plot-3748"><a href="#COMPsc.scatter_plot-3748"><span class="linenos">3748</span></a><span class="sd">        label_size : int, default=10</span>
</span><span id="COMPsc.scatter_plot-3749"><a href="#COMPsc.scatter_plot-3749"><span class="linenos">3749</span></a><span class="sd">            Font size for axis labels and ticks.</span>
</span><span id="COMPsc.scatter_plot-3750"><a href="#COMPsc.scatter_plot-3750"><span class="linenos">3750</span></a>
</span><span id="COMPsc.scatter_plot-3751"><a href="#COMPsc.scatter_plot-3751"><span class="linenos">3751</span></a><span class="sd">        size_scale : int or float, default=100</span>
</span><span id="COMPsc.scatter_plot-3752"><a href="#COMPsc.scatter_plot-3752"><span class="linenos">3752</span></a><span class="sd">            Scaling factor for bubble sizes.</span>
</span><span id="COMPsc.scatter_plot-3753"><a href="#COMPsc.scatter_plot-3753"><span class="linenos">3753</span></a>
</span><span id="COMPsc.scatter_plot-3754"><a href="#COMPsc.scatter_plot-3754"><span class="linenos">3754</span></a><span class="sd">        y_lab : str, default=&#39;Genes&#39;</span>
</span><span id="COMPsc.scatter_plot-3755"><a href="#COMPsc.scatter_plot-3755"><span class="linenos">3755</span></a><span class="sd">            Label for the x-axis.</span>
</span><span id="COMPsc.scatter_plot-3756"><a href="#COMPsc.scatter_plot-3756"><span class="linenos">3756</span></a>
</span><span id="COMPsc.scatter_plot-3757"><a href="#COMPsc.scatter_plot-3757"><span class="linenos">3757</span></a><span class="sd">        legend_lab : str, default=&#39;log(CPM + 1)&#39;</span>
</span><span id="COMPsc.scatter_plot-3758"><a href="#COMPsc.scatter_plot-3758"><span class="linenos">3758</span></a><span class="sd">            Label for the colorbar legend.</span>
</span><span id="COMPsc.scatter_plot-3759"><a href="#COMPsc.scatter_plot-3759"><span class="linenos">3759</span></a>
</span><span id="COMPsc.scatter_plot-3760"><a href="#COMPsc.scatter_plot-3760"><span class="linenos">3760</span></a><span class="sd">        bbox_to_anchor_scale : int, default=25</span>
</span><span id="COMPsc.scatter_plot-3761"><a href="#COMPsc.scatter_plot-3761"><span class="linenos">3761</span></a><span class="sd">            Vertical scale (percentage) for positioning the colorbar.</span>
</span><span id="COMPsc.scatter_plot-3762"><a href="#COMPsc.scatter_plot-3762"><span class="linenos">3762</span></a>
</span><span id="COMPsc.scatter_plot-3763"><a href="#COMPsc.scatter_plot-3763"><span class="linenos">3763</span></a><span class="sd">        bbox_to_anchor_perc : tuple, default=(0.91, 0.63)</span>
</span><span id="COMPsc.scatter_plot-3764"><a href="#COMPsc.scatter_plot-3764"><span class="linenos">3764</span></a><span class="sd">            Anchor position for the size legend (percent bubble legend).</span>
</span><span id="COMPsc.scatter_plot-3765"><a href="#COMPsc.scatter_plot-3765"><span class="linenos">3765</span></a>
</span><span id="COMPsc.scatter_plot-3766"><a href="#COMPsc.scatter_plot-3766"><span class="linenos">3766</span></a><span class="sd">        bbox_to_anchor_group : tuple, default=(1.01, 0.4)</span>
</span><span id="COMPsc.scatter_plot-3767"><a href="#COMPsc.scatter_plot-3767"><span class="linenos">3767</span></a><span class="sd">            Anchor position for the group legend.</span>
</span><span id="COMPsc.scatter_plot-3768"><a href="#COMPsc.scatter_plot-3768"><span class="linenos">3768</span></a>
</span><span id="COMPsc.scatter_plot-3769"><a href="#COMPsc.scatter_plot-3769"><span class="linenos">3769</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc.scatter_plot-3770"><a href="#COMPsc.scatter_plot-3770"><span class="linenos">3770</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.scatter_plot-3771"><a href="#COMPsc.scatter_plot-3771"><span class="linenos">3771</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc.scatter_plot-3772"><a href="#COMPsc.scatter_plot-3772"><span class="linenos">3772</span></a><span class="sd">            The generated scatter plot figure.</span>
</span><span id="COMPsc.scatter_plot-3773"><a href="#COMPsc.scatter_plot-3773"><span class="linenos">3773</span></a>
</span><span id="COMPsc.scatter_plot-3774"><a href="#COMPsc.scatter_plot-3774"><span class="linenos">3774</span></a><span class="sd">        Notes</span>
</span><span id="COMPsc.scatter_plot-3775"><a href="#COMPsc.scatter_plot-3775"><span class="linenos">3775</span></a><span class="sd">        -----</span>
</span><span id="COMPsc.scatter_plot-3776"><a href="#COMPsc.scatter_plot-3776"><span class="linenos">3776</span></a><span class="sd">        Colors represent expression values normalized to the colormap.</span>
</span><span id="COMPsc.scatter_plot-3777"><a href="#COMPsc.scatter_plot-3777"><span class="linenos">3777</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.scatter_plot-3778"><a href="#COMPsc.scatter_plot-3778"><span class="linenos">3778</span></a>
</span><span id="COMPsc.scatter_plot-3779"><a href="#COMPsc.scatter_plot-3779"><span class="linenos">3779</span></a>        <span class="n">prtd</span><span class="p">,</span> <span class="n">met</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_partial_data</span><span class="p">(</span>
</span><span id="COMPsc.scatter_plot-3780"><a href="#COMPsc.scatter_plot-3780"><span class="linenos">3780</span></a>            <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">name_slot</span><span class="o">=</span><span class="n">name_slot</span><span class="p">,</span> <span class="n">inc_metadata</span><span class="o">=</span><span class="kc">True</span>
</span><span id="COMPsc.scatter_plot-3781"><a href="#COMPsc.scatter_plot-3781"><span class="linenos">3781</span></a>        <span class="p">)</span>
</span><span id="COMPsc.scatter_plot-3782"><a href="#COMPsc.scatter_plot-3782"><span class="linenos">3782</span></a>
</span><span id="COMPsc.scatter_plot-3783"><a href="#COMPsc.scatter_plot-3783"><span class="linenos">3783</span></a>        <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
</span><span id="COMPsc.scatter_plot-3784"><a href="#COMPsc.scatter_plot-3784"><span class="linenos">3784</span></a>
</span><span id="COMPsc.scatter_plot-3785"><a href="#COMPsc.scatter_plot-3785"><span class="linenos">3785</span></a>            <span class="n">legend_lab</span> <span class="o">=</span> <span class="s2">&quot;Scaled</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">legend_lab</span>
</span><span id="COMPsc.scatter_plot-3786"><a href="#COMPsc.scatter_plot-3786"><span class="linenos">3786</span></a>
</span><span id="COMPsc.scatter_plot-3787"><a href="#COMPsc.scatter_plot-3787"><span class="linenos">3787</span></a>            <span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="COMPsc.scatter_plot-3788"><a href="#COMPsc.scatter_plot-3788"><span class="linenos">3788</span></a>            <span class="n">prtd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="COMPsc.scatter_plot-3789"><a href="#COMPsc.scatter_plot-3789"><span class="linenos">3789</span></a>                <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">prtd</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3790"><a href="#COMPsc.scatter_plot-3790"><span class="linenos">3790</span></a>                <span class="n">index</span><span class="o">=</span><span class="n">prtd</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3791"><a href="#COMPsc.scatter_plot-3791"><span class="linenos">3791</span></a>                <span class="n">columns</span><span class="o">=</span><span class="n">prtd</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3792"><a href="#COMPsc.scatter_plot-3792"><span class="linenos">3792</span></a>            <span class="p">)</span>
</span><span id="COMPsc.scatter_plot-3793"><a href="#COMPsc.scatter_plot-3793"><span class="linenos">3793</span></a>
</span><span id="COMPsc.scatter_plot-3794"><a href="#COMPsc.scatter_plot-3794"><span class="linenos">3794</span></a>        <span class="n">prtd</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">prtd</span><span class="o">.</span><span class="n">columns</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">met</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc.scatter_plot-3795"><a href="#COMPsc.scatter_plot-3795"><span class="linenos">3795</span></a>
</span><span id="COMPsc.scatter_plot-3796"><a href="#COMPsc.scatter_plot-3796"><span class="linenos">3796</span></a>        <span class="n">prtd_avg</span> <span class="o">=</span> <span class="n">average</span><span class="p">(</span><span class="n">prtd</span><span class="p">)</span>
</span><span id="COMPsc.scatter_plot-3797"><a href="#COMPsc.scatter_plot-3797"><span class="linenos">3797</span></a>
</span><span id="COMPsc.scatter_plot-3798"><a href="#COMPsc.scatter_plot-3798"><span class="linenos">3798</span></a>        <span class="n">meta_sets</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*#&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prtd_avg</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc.scatter_plot-3799"><a href="#COMPsc.scatter_plot-3799"><span class="linenos">3799</span></a>
</span><span id="COMPsc.scatter_plot-3800"><a href="#COMPsc.scatter_plot-3800"><span class="linenos">3800</span></a>        <span class="n">prtd_avg</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;#.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prtd_avg</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc.scatter_plot-3801"><a href="#COMPsc.scatter_plot-3801"><span class="linenos">3801</span></a>
</span><span id="COMPsc.scatter_plot-3802"><a href="#COMPsc.scatter_plot-3802"><span class="linenos">3802</span></a>        <span class="n">prtd_occ</span> <span class="o">=</span> <span class="n">occurrence</span><span class="p">(</span><span class="n">prtd</span><span class="p">)</span>
</span><span id="COMPsc.scatter_plot-3803"><a href="#COMPsc.scatter_plot-3803"><span class="linenos">3803</span></a>
</span><span id="COMPsc.scatter_plot-3804"><a href="#COMPsc.scatter_plot-3804"><span class="linenos">3804</span></a>        <span class="n">prtd_occ</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;#.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prtd_occ</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="COMPsc.scatter_plot-3805"><a href="#COMPsc.scatter_plot-3805"><span class="linenos">3805</span></a>
</span><span id="COMPsc.scatter_plot-3806"><a href="#COMPsc.scatter_plot-3806"><span class="linenos">3806</span></a>        <span class="n">fig_scatter</span> <span class="o">=</span> <span class="n">features_scatter</span><span class="p">(</span>
</span><span id="COMPsc.scatter_plot-3807"><a href="#COMPsc.scatter_plot-3807"><span class="linenos">3807</span></a>            <span class="n">expression_data</span><span class="o">=</span><span class="n">prtd_avg</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3808"><a href="#COMPsc.scatter_plot-3808"><span class="linenos">3808</span></a>            <span class="n">occurence_data</span><span class="o">=</span><span class="n">prtd_occ</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3809"><a href="#COMPsc.scatter_plot-3809"><span class="linenos">3809</span></a>            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3810"><a href="#COMPsc.scatter_plot-3810"><span class="linenos">3810</span></a>            <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3811"><a href="#COMPsc.scatter_plot-3811"><span class="linenos">3811</span></a>            <span class="n">metadata_list</span><span class="o">=</span><span class="n">meta_sets</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3812"><a href="#COMPsc.scatter_plot-3812"><span class="linenos">3812</span></a>            <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3813"><a href="#COMPsc.scatter_plot-3813"><span class="linenos">3813</span></a>            <span class="n">hclust</span><span class="o">=</span><span class="n">hclust</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3814"><a href="#COMPsc.scatter_plot-3814"><span class="linenos">3814</span></a>            <span class="n">img_width</span><span class="o">=</span><span class="n">img_width</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3815"><a href="#COMPsc.scatter_plot-3815"><span class="linenos">3815</span></a>            <span class="n">img_high</span><span class="o">=</span><span class="n">img_high</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3816"><a href="#COMPsc.scatter_plot-3816"><span class="linenos">3816</span></a>            <span class="n">label_size</span><span class="o">=</span><span class="n">label_size</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3817"><a href="#COMPsc.scatter_plot-3817"><span class="linenos">3817</span></a>            <span class="n">size_scale</span><span class="o">=</span><span class="n">size_scale</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3818"><a href="#COMPsc.scatter_plot-3818"><span class="linenos">3818</span></a>            <span class="n">y_lab</span><span class="o">=</span><span class="n">y_lab</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3819"><a href="#COMPsc.scatter_plot-3819"><span class="linenos">3819</span></a>            <span class="n">legend_lab</span><span class="o">=</span><span class="n">legend_lab</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3820"><a href="#COMPsc.scatter_plot-3820"><span class="linenos">3820</span></a>            <span class="n">set_box_size</span><span class="o">=</span><span class="n">set_box_size</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3821"><a href="#COMPsc.scatter_plot-3821"><span class="linenos">3821</span></a>            <span class="n">set_box_high</span><span class="o">=</span><span class="n">set_box_high</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3822"><a href="#COMPsc.scatter_plot-3822"><span class="linenos">3822</span></a>            <span class="n">bbox_to_anchor_scale</span><span class="o">=</span><span class="n">bbox_to_anchor_scale</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3823"><a href="#COMPsc.scatter_plot-3823"><span class="linenos">3823</span></a>            <span class="n">bbox_to_anchor_perc</span><span class="o">=</span><span class="n">bbox_to_anchor_perc</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3824"><a href="#COMPsc.scatter_plot-3824"><span class="linenos">3824</span></a>            <span class="n">bbox_to_anchor_group</span><span class="o">=</span><span class="n">bbox_to_anchor_group</span><span class="p">,</span>
</span><span id="COMPsc.scatter_plot-3825"><a href="#COMPsc.scatter_plot-3825"><span class="linenos">3825</span></a>        <span class="p">)</span>
</span><span id="COMPsc.scatter_plot-3826"><a href="#COMPsc.scatter_plot-3826"><span class="linenos">3826</span></a>
</span><span id="COMPsc.scatter_plot-3827"><a href="#COMPsc.scatter_plot-3827"><span class="linenos">3827</span></a>        <span class="k">return</span> <span class="n">fig_scatter</span>
</span></pre></div>


            <div class="docstring"><p>Create a bubble scatter plot of selected features across samples inside project.</p>

<p>Each point represents a feature-sample pair, where the color encodes the
expression value and the size encodes occurrence or relative abundance.
Optionally, hierarchical clustering can be applied to order rows and columns.</p>

<h2 id="parameters">Parameters</h2>

<p>names : list, str, or None
    Names of samples to include. If None, all samples are considered.</p>

<p>features : list, str, or None
    Names of features to include. If None, all features are considered.</p>

<p>name_slot : str
    Column in metadata to use as sample names.</p>

<p>scale: bool, default False
    If True, expression_data will be scaled (0–1) across the rows (features).</p>

<p>colors : str, default='viridis'
    Colormap for expression values.</p>

<p>hclust : str or None, default='complete'
    Linkage method for hierarchical clustering. If None, no clustering
    is performed.</p>

<p>img_width : int or float, default=8
    Width of the plot in inches.</p>

<p>img_high : int or float, default=5
    Height of the plot in inches.</p>

<p>label_size : int, default=10
    Font size for axis labels and ticks.</p>

<p>size_scale : int or float, default=100
    Scaling factor for bubble sizes.</p>

<p>y_lab : str, default='Genes'
    Label for the x-axis.</p>

<p>legend_lab : str, default='log(CPM + 1)'
    Label for the colorbar legend.</p>

<p>bbox_to_anchor_scale : int, default=25
    Vertical scale (percentage) for positioning the colorbar.</p>

<p>bbox_to_anchor_perc : tuple, default=(0.91, 0.63)
    Anchor position for the size legend (percent bubble legend).</p>

<p>bbox_to_anchor_group : tuple, default=(1.01, 0.4)
    Anchor position for the group legend.</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.figure.Figure
    The generated scatter plot figure.</p>

<h2 id="notes">Notes</h2>

<p>Colors represent expression values normalized to the colormap.</p>
</div>


                            </div>
                            <div id="COMPsc.data_composition" class="classattr">
                                        <input id="COMPsc.data_composition-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">data_composition</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">features_count</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cell_names&#39;</span>,</span><span class="param">	<span class="n">set_sep</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.data_composition-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.data_composition"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.data_composition-3829"><a href="#COMPsc.data_composition-3829"><span class="linenos">3829</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">data_composition</span><span class="p">(</span>
</span><span id="COMPsc.data_composition-3830"><a href="#COMPsc.data_composition-3830"><span class="linenos">3830</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc.data_composition-3831"><a href="#COMPsc.data_composition-3831"><span class="linenos">3831</span></a>        <span class="n">features_count</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.data_composition-3832"><a href="#COMPsc.data_composition-3832"><span class="linenos">3832</span></a>        <span class="n">name_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_names&quot;</span><span class="p">,</span>
</span><span id="COMPsc.data_composition-3833"><a href="#COMPsc.data_composition-3833"><span class="linenos">3833</span></a>        <span class="n">set_sep</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="COMPsc.data_composition-3834"><a href="#COMPsc.data_composition-3834"><span class="linenos">3834</span></a>    <span class="p">):</span>
</span><span id="COMPsc.data_composition-3835"><a href="#COMPsc.data_composition-3835"><span class="linenos">3835</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.data_composition-3836"><a href="#COMPsc.data_composition-3836"><span class="linenos">3836</span></a><span class="sd">        Compute composition of cell types in data set.</span>
</span><span id="COMPsc.data_composition-3837"><a href="#COMPsc.data_composition-3837"><span class="linenos">3837</span></a>
</span><span id="COMPsc.data_composition-3838"><a href="#COMPsc.data_composition-3838"><span class="linenos">3838</span></a><span class="sd">        This function counts the occurrences of specific cells (e.g., cell types, subtypes)</span>
</span><span id="COMPsc.data_composition-3839"><a href="#COMPsc.data_composition-3839"><span class="linenos">3839</span></a><span class="sd">        within metadata entries, calculates their relative percentages, and stores</span>
</span><span id="COMPsc.data_composition-3840"><a href="#COMPsc.data_composition-3840"><span class="linenos">3840</span></a><span class="sd">        the results in `self.composition_data`.</span>
</span><span id="COMPsc.data_composition-3841"><a href="#COMPsc.data_composition-3841"><span class="linenos">3841</span></a>
</span><span id="COMPsc.data_composition-3842"><a href="#COMPsc.data_composition-3842"><span class="linenos">3842</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.data_composition-3843"><a href="#COMPsc.data_composition-3843"><span class="linenos">3843</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.data_composition-3844"><a href="#COMPsc.data_composition-3844"><span class="linenos">3844</span></a><span class="sd">        features_count : list or None</span>
</span><span id="COMPsc.data_composition-3845"><a href="#COMPsc.data_composition-3845"><span class="linenos">3845</span></a><span class="sd">            List of features (part or full names) to be counted.</span>
</span><span id="COMPsc.data_composition-3846"><a href="#COMPsc.data_composition-3846"><span class="linenos">3846</span></a><span class="sd">            If None, all unique elements from the specified `name_slot` metadata field are used.</span>
</span><span id="COMPsc.data_composition-3847"><a href="#COMPsc.data_composition-3847"><span class="linenos">3847</span></a>
</span><span id="COMPsc.data_composition-3848"><a href="#COMPsc.data_composition-3848"><span class="linenos">3848</span></a><span class="sd">        name_slot : str, default &#39;cell_names&#39;</span>
</span><span id="COMPsc.data_composition-3849"><a href="#COMPsc.data_composition-3849"><span class="linenos">3849</span></a><span class="sd">            Metadata field containing sample identifiers or labels.</span>
</span><span id="COMPsc.data_composition-3850"><a href="#COMPsc.data_composition-3850"><span class="linenos">3850</span></a>
</span><span id="COMPsc.data_composition-3851"><a href="#COMPsc.data_composition-3851"><span class="linenos">3851</span></a><span class="sd">        set_sep : bool, default True</span>
</span><span id="COMPsc.data_composition-3852"><a href="#COMPsc.data_composition-3852"><span class="linenos">3852</span></a><span class="sd">            If True and multiple sets are present in metadata, compute composition</span>
</span><span id="COMPsc.data_composition-3853"><a href="#COMPsc.data_composition-3853"><span class="linenos">3853</span></a><span class="sd">            separately for each set.</span>
</span><span id="COMPsc.data_composition-3854"><a href="#COMPsc.data_composition-3854"><span class="linenos">3854</span></a>
</span><span id="COMPsc.data_composition-3855"><a href="#COMPsc.data_composition-3855"><span class="linenos">3855</span></a><span class="sd">        Update</span>
</span><span id="COMPsc.data_composition-3856"><a href="#COMPsc.data_composition-3856"><span class="linenos">3856</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.data_composition-3857"><a href="#COMPsc.data_composition-3857"><span class="linenos">3857</span></a><span class="sd">        Stores results in `self.composition_data` as a pandas DataFrame with:</span>
</span><span id="COMPsc.data_composition-3858"><a href="#COMPsc.data_composition-3858"><span class="linenos">3858</span></a><span class="sd">        - &#39;name&#39;: feature name</span>
</span><span id="COMPsc.data_composition-3859"><a href="#COMPsc.data_composition-3859"><span class="linenos">3859</span></a><span class="sd">        - &#39;n&#39;: number of occurrences</span>
</span><span id="COMPsc.data_composition-3860"><a href="#COMPsc.data_composition-3860"><span class="linenos">3860</span></a><span class="sd">        - &#39;pct&#39;: percentage of occurrences</span>
</span><span id="COMPsc.data_composition-3861"><a href="#COMPsc.data_composition-3861"><span class="linenos">3861</span></a><span class="sd">        - &#39;set&#39; (if applicable): dataset identifier</span>
</span><span id="COMPsc.data_composition-3862"><a href="#COMPsc.data_composition-3862"><span class="linenos">3862</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.data_composition-3863"><a href="#COMPsc.data_composition-3863"><span class="linenos">3863</span></a>
</span><span id="COMPsc.data_composition-3864"><a href="#COMPsc.data_composition-3864"><span class="linenos">3864</span></a>        <span class="n">validated_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">])</span>
</span><span id="COMPsc.data_composition-3865"><a href="#COMPsc.data_composition-3865"><span class="linenos">3865</span></a>        <span class="n">sets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">])</span>
</span><span id="COMPsc.data_composition-3866"><a href="#COMPsc.data_composition-3866"><span class="linenos">3866</span></a>
</span><span id="COMPsc.data_composition-3867"><a href="#COMPsc.data_composition-3867"><span class="linenos">3867</span></a>        <span class="k">if</span> <span class="n">features_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.data_composition-3868"><a href="#COMPsc.data_composition-3868"><span class="linenos">3868</span></a>            <span class="n">features_count</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_metadata</span><span class="p">[</span><span class="n">name_slot</span><span class="p">]))</span>
</span><span id="COMPsc.data_composition-3869"><a href="#COMPsc.data_composition-3869"><span class="linenos">3869</span></a>
</span><span id="COMPsc.data_composition-3870"><a href="#COMPsc.data_composition-3870"><span class="linenos">3870</span></a>        <span class="k">if</span> <span class="n">set_sep</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sets</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="COMPsc.data_composition-3871"><a href="#COMPsc.data_composition-3871"><span class="linenos">3871</span></a>
</span><span id="COMPsc.data_composition-3872"><a href="#COMPsc.data_composition-3872"><span class="linenos">3872</span></a>            <span class="n">final_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span><span id="COMPsc.data_composition-3873"><a href="#COMPsc.data_composition-3873"><span class="linenos">3873</span></a>
</span><span id="COMPsc.data_composition-3874"><a href="#COMPsc.data_composition-3874"><span class="linenos">3874</span></a>            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">sets</span><span class="p">):</span>
</span><span id="COMPsc.data_composition-3875"><a href="#COMPsc.data_composition-3875"><span class="linenos">3875</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="COMPsc.data_composition-3876"><a href="#COMPsc.data_composition-3876"><span class="linenos">3876</span></a>
</span><span id="COMPsc.data_composition-3877"><a href="#COMPsc.data_composition-3877"><span class="linenos">3877</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span> <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">x</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">]</span>
</span><span id="COMPsc.data_composition-3878"><a href="#COMPsc.data_composition-3878"><span class="linenos">3878</span></a>
</span><span id="COMPsc.data_composition-3879"><a href="#COMPsc.data_composition-3879"><span class="linenos">3879</span></a>                <span class="n">tmp_val_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">validated_list</span><span class="p">)</span>
</span><span id="COMPsc.data_composition-3880"><a href="#COMPsc.data_composition-3880"><span class="linenos">3880</span></a>
</span><span id="COMPsc.data_composition-3881"><a href="#COMPsc.data_composition-3881"><span class="linenos">3881</span></a>                <span class="n">tmp_val_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmp_val_list</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
</span><span id="COMPsc.data_composition-3882"><a href="#COMPsc.data_composition-3882"><span class="linenos">3882</span></a>
</span><span id="COMPsc.data_composition-3883"><a href="#COMPsc.data_composition-3883"><span class="linenos">3883</span></a>                <span class="n">res_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;set&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="COMPsc.data_composition-3884"><a href="#COMPsc.data_composition-3884"><span class="linenos">3884</span></a>
</span><span id="COMPsc.data_composition-3885"><a href="#COMPsc.data_composition-3885"><span class="linenos">3885</span></a>                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">features_count</span><span class="p">):</span>
</span><span id="COMPsc.data_composition-3886"><a href="#COMPsc.data_composition-3886"><span class="linenos">3886</span></a>                    <span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="COMPsc.data_composition-3887"><a href="#COMPsc.data_composition-3887"><span class="linenos">3887</span></a>                        <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">tmp_val_list</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">element</span><span class="p">)</span>
</span><span id="COMPsc.data_composition-3888"><a href="#COMPsc.data_composition-3888"><span class="linenos">3888</span></a>                    <span class="p">)</span>
</span><span id="COMPsc.data_composition-3889"><a href="#COMPsc.data_composition-3889"><span class="linenos">3889</span></a>                    <span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="COMPsc.data_composition-3890"><a href="#COMPsc.data_composition-3890"><span class="linenos">3890</span></a>                    <span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="COMPsc.data_composition-3891"><a href="#COMPsc.data_composition-3891"><span class="linenos">3891</span></a>                    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res_dict</span><span class="p">)</span>
</span><span id="COMPsc.data_composition-3892"><a href="#COMPsc.data_composition-3892"><span class="linenos">3892</span></a>                    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="COMPsc.data_composition-3893"><a href="#COMPsc.data_composition-3893"><span class="linenos">3893</span></a>                    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="COMPsc.data_composition-3894"><a href="#COMPsc.data_composition-3894"><span class="linenos">3894</span></a>
</span><span id="COMPsc.data_composition-3895"><a href="#COMPsc.data_composition-3895"><span class="linenos">3895</span></a>                <span class="n">final_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">final_res</span><span class="p">,</span> <span class="n">res</span><span class="p">])</span>
</span><span id="COMPsc.data_composition-3896"><a href="#COMPsc.data_composition-3896"><span class="linenos">3896</span></a>
</span><span id="COMPsc.data_composition-3897"><a href="#COMPsc.data_composition-3897"><span class="linenos">3897</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">final_res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="s2">&quot;pct&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
</span><span id="COMPsc.data_composition-3898"><a href="#COMPsc.data_composition-3898"><span class="linenos">3898</span></a>
</span><span id="COMPsc.data_composition-3899"><a href="#COMPsc.data_composition-3899"><span class="linenos">3899</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.data_composition-3900"><a href="#COMPsc.data_composition-3900"><span class="linenos">3900</span></a>
</span><span id="COMPsc.data_composition-3901"><a href="#COMPsc.data_composition-3901"><span class="linenos">3901</span></a>            <span class="n">res_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="COMPsc.data_composition-3902"><a href="#COMPsc.data_composition-3902"><span class="linenos">3902</span></a>
</span><span id="COMPsc.data_composition-3903"><a href="#COMPsc.data_composition-3903"><span class="linenos">3903</span></a>            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">features_count</span><span class="p">):</span>
</span><span id="COMPsc.data_composition-3904"><a href="#COMPsc.data_composition-3904"><span class="linenos">3904</span></a>                <span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="COMPsc.data_composition-3905"><a href="#COMPsc.data_composition-3905"><span class="linenos">3905</span></a>                    <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">validated_list</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">element</span><span class="p">)</span>
</span><span id="COMPsc.data_composition-3906"><a href="#COMPsc.data_composition-3906"><span class="linenos">3906</span></a>                <span class="p">)</span>
</span><span id="COMPsc.data_composition-3907"><a href="#COMPsc.data_composition-3907"><span class="linenos">3907</span></a>                <span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="COMPsc.data_composition-3908"><a href="#COMPsc.data_composition-3908"><span class="linenos">3908</span></a>
</span><span id="COMPsc.data_composition-3909"><a href="#COMPsc.data_composition-3909"><span class="linenos">3909</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res_dict</span><span class="p">)</span>
</span><span id="COMPsc.data_composition-3910"><a href="#COMPsc.data_composition-3910"><span class="linenos">3910</span></a>            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="COMPsc.data_composition-3911"><a href="#COMPsc.data_composition-3911"><span class="linenos">3911</span></a>            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="COMPsc.data_composition-3912"><a href="#COMPsc.data_composition-3912"><span class="linenos">3912</span></a>
</span><span id="COMPsc.data_composition-3913"><a href="#COMPsc.data_composition-3913"><span class="linenos">3913</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;pct&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="COMPsc.data_composition-3914"><a href="#COMPsc.data_composition-3914"><span class="linenos">3914</span></a>
</span><span id="COMPsc.data_composition-3915"><a href="#COMPsc.data_composition-3915"><span class="linenos">3915</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">composition_data</span> <span class="o">=</span> <span class="n">res</span>
</span></pre></div>


            <div class="docstring"><p>Compute composition of cell types in data set.</p>

<p>This function counts the occurrences of specific cells (e.g., cell types, subtypes)
within metadata entries, calculates their relative percentages, and stores
the results in <code>self.composition_data</code>.</p>

<h2 id="parameters">Parameters</h2>

<p>features_count : list or None
    List of features (part or full names) to be counted.
    If None, all unique elements from the specified <code>name_slot</code> metadata field are used.</p>

<p>name_slot : str, default 'cell_names'
    Metadata field containing sample identifiers or labels.</p>

<p>set_sep : bool, default True
    If True and multiple sets are present in metadata, compute composition
    separately for each set.</p>

<h2 id="update">Update</h2>

<p>Stores results in <code>self.composition_data</code> as a pandas DataFrame with:</p>

<ul>
<li>'name': feature name</li>
<li>'n': number of occurrences</li>
<li>'pct': percentage of occurrences</li>
<li>'set' (if applicable): dataset identifier</li>
</ul>
</div>


                            </div>
                            <div id="COMPsc.composition_pie" class="classattr">
                                        <input id="COMPsc.composition_pie-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">composition_pie</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">width</span><span class="o">=</span><span class="mi">6</span>,</span><span class="param">	<span class="n">height</span><span class="o">=</span><span class="mi">6</span>,</span><span class="param">	<span class="n">font_size</span><span class="o">=</span><span class="mi">15</span>,</span><span class="param">	<span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;tab20&#39;</span>,</span><span class="param">	<span class="n">legend_split_col</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">offset_labels</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">0.5</span>,</span><span class="param">	<span class="n">legend_bbox</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.15</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.composition_pie-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.composition_pie"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.composition_pie-3917"><a href="#COMPsc.composition_pie-3917"><span class="linenos">3917</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">composition_pie</span><span class="p">(</span>
</span><span id="COMPsc.composition_pie-3918"><a href="#COMPsc.composition_pie-3918"><span class="linenos">3918</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-3919"><a href="#COMPsc.composition_pie-3919"><span class="linenos">3919</span></a>        <span class="n">width</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-3920"><a href="#COMPsc.composition_pie-3920"><span class="linenos">3920</span></a>        <span class="n">height</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-3921"><a href="#COMPsc.composition_pie-3921"><span class="linenos">3921</span></a>        <span class="n">font_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-3922"><a href="#COMPsc.composition_pie-3922"><span class="linenos">3922</span></a>        <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tab20&quot;</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-3923"><a href="#COMPsc.composition_pie-3923"><span class="linenos">3923</span></a>        <span class="n">legend_split_col</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-3924"><a href="#COMPsc.composition_pie-3924"><span class="linenos">3924</span></a>        <span class="n">offset_labels</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-3925"><a href="#COMPsc.composition_pie-3925"><span class="linenos">3925</span></a>        <span class="n">legend_bbox</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.15</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
</span><span id="COMPsc.composition_pie-3926"><a href="#COMPsc.composition_pie-3926"><span class="linenos">3926</span></a>    <span class="p">):</span>
</span><span id="COMPsc.composition_pie-3927"><a href="#COMPsc.composition_pie-3927"><span class="linenos">3927</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.composition_pie-3928"><a href="#COMPsc.composition_pie-3928"><span class="linenos">3928</span></a><span class="sd">        Visualize the composition of cell lineages using pie charts.</span>
</span><span id="COMPsc.composition_pie-3929"><a href="#COMPsc.composition_pie-3929"><span class="linenos">3929</span></a>
</span><span id="COMPsc.composition_pie-3930"><a href="#COMPsc.composition_pie-3930"><span class="linenos">3930</span></a><span class="sd">        Generates pie charts showing the relative proportions of features stored</span>
</span><span id="COMPsc.composition_pie-3931"><a href="#COMPsc.composition_pie-3931"><span class="linenos">3931</span></a><span class="sd">        in `self.composition_data`. If multiple sets are present, a separate</span>
</span><span id="COMPsc.composition_pie-3932"><a href="#COMPsc.composition_pie-3932"><span class="linenos">3932</span></a><span class="sd">        chart is drawn for each set.</span>
</span><span id="COMPsc.composition_pie-3933"><a href="#COMPsc.composition_pie-3933"><span class="linenos">3933</span></a>
</span><span id="COMPsc.composition_pie-3934"><a href="#COMPsc.composition_pie-3934"><span class="linenos">3934</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.composition_pie-3935"><a href="#COMPsc.composition_pie-3935"><span class="linenos">3935</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.composition_pie-3936"><a href="#COMPsc.composition_pie-3936"><span class="linenos">3936</span></a><span class="sd">        width : int, default 6</span>
</span><span id="COMPsc.composition_pie-3937"><a href="#COMPsc.composition_pie-3937"><span class="linenos">3937</span></a><span class="sd">            Width of the figure.</span>
</span><span id="COMPsc.composition_pie-3938"><a href="#COMPsc.composition_pie-3938"><span class="linenos">3938</span></a>
</span><span id="COMPsc.composition_pie-3939"><a href="#COMPsc.composition_pie-3939"><span class="linenos">3939</span></a><span class="sd">        height : int, default 6</span>
</span><span id="COMPsc.composition_pie-3940"><a href="#COMPsc.composition_pie-3940"><span class="linenos">3940</span></a><span class="sd">            Height of the figure (applied per set if multiple sets are plotted).</span>
</span><span id="COMPsc.composition_pie-3941"><a href="#COMPsc.composition_pie-3941"><span class="linenos">3941</span></a>
</span><span id="COMPsc.composition_pie-3942"><a href="#COMPsc.composition_pie-3942"><span class="linenos">3942</span></a><span class="sd">        font_size : int, default 15</span>
</span><span id="COMPsc.composition_pie-3943"><a href="#COMPsc.composition_pie-3943"><span class="linenos">3943</span></a><span class="sd">            Font size for labels and annotations.</span>
</span><span id="COMPsc.composition_pie-3944"><a href="#COMPsc.composition_pie-3944"><span class="linenos">3944</span></a>
</span><span id="COMPsc.composition_pie-3945"><a href="#COMPsc.composition_pie-3945"><span class="linenos">3945</span></a><span class="sd">        cmap : str, default &#39;tab20&#39;</span>
</span><span id="COMPsc.composition_pie-3946"><a href="#COMPsc.composition_pie-3946"><span class="linenos">3946</span></a><span class="sd">            Colormap used for pie slices.</span>
</span><span id="COMPsc.composition_pie-3947"><a href="#COMPsc.composition_pie-3947"><span class="linenos">3947</span></a>
</span><span id="COMPsc.composition_pie-3948"><a href="#COMPsc.composition_pie-3948"><span class="linenos">3948</span></a><span class="sd">        legend_split_col : int, default 1</span>
</span><span id="COMPsc.composition_pie-3949"><a href="#COMPsc.composition_pie-3949"><span class="linenos">3949</span></a><span class="sd">            Number of columns in the legend.</span>
</span><span id="COMPsc.composition_pie-3950"><a href="#COMPsc.composition_pie-3950"><span class="linenos">3950</span></a>
</span><span id="COMPsc.composition_pie-3951"><a href="#COMPsc.composition_pie-3951"><span class="linenos">3951</span></a><span class="sd">        offset_labels : float or int, default 0.5</span>
</span><span id="COMPsc.composition_pie-3952"><a href="#COMPsc.composition_pie-3952"><span class="linenos">3952</span></a><span class="sd">            Spacing offset for label placement relative to pie slices.</span>
</span><span id="COMPsc.composition_pie-3953"><a href="#COMPsc.composition_pie-3953"><span class="linenos">3953</span></a>
</span><span id="COMPsc.composition_pie-3954"><a href="#COMPsc.composition_pie-3954"><span class="linenos">3954</span></a><span class="sd">        legend_bbox : tuple, default (1.15, 0.95)</span>
</span><span id="COMPsc.composition_pie-3955"><a href="#COMPsc.composition_pie-3955"><span class="linenos">3955</span></a><span class="sd">            Bounding box anchor position for the legend.</span>
</span><span id="COMPsc.composition_pie-3956"><a href="#COMPsc.composition_pie-3956"><span class="linenos">3956</span></a>
</span><span id="COMPsc.composition_pie-3957"><a href="#COMPsc.composition_pie-3957"><span class="linenos">3957</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc.composition_pie-3958"><a href="#COMPsc.composition_pie-3958"><span class="linenos">3958</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.composition_pie-3959"><a href="#COMPsc.composition_pie-3959"><span class="linenos">3959</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc.composition_pie-3960"><a href="#COMPsc.composition_pie-3960"><span class="linenos">3960</span></a><span class="sd">            Pie chart visualization of composition data.</span>
</span><span id="COMPsc.composition_pie-3961"><a href="#COMPsc.composition_pie-3961"><span class="linenos">3961</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.composition_pie-3962"><a href="#COMPsc.composition_pie-3962"><span class="linenos">3962</span></a>
</span><span id="COMPsc.composition_pie-3963"><a href="#COMPsc.composition_pie-3963"><span class="linenos">3963</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_data</span>
</span><span id="COMPsc.composition_pie-3964"><a href="#COMPsc.composition_pie-3964"><span class="linenos">3964</span></a>
</span><span id="COMPsc.composition_pie-3965"><a href="#COMPsc.composition_pie-3965"><span class="linenos">3965</span></a>        <span class="k">if</span> <span class="s2">&quot;set&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="COMPsc.composition_pie-3966"><a href="#COMPsc.composition_pie-3966"><span class="linenos">3966</span></a>
</span><span id="COMPsc.composition_pie-3967"><a href="#COMPsc.composition_pie-3967"><span class="linenos">3967</span></a>            <span class="n">sets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]))</span>
</span><span id="COMPsc.composition_pie-3968"><a href="#COMPsc.composition_pie-3968"><span class="linenos">3968</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)))</span>
</span><span id="COMPsc.composition_pie-3969"><a href="#COMPsc.composition_pie-3969"><span class="linenos">3969</span></a>
</span><span id="COMPsc.composition_pie-3970"><a href="#COMPsc.composition_pie-3970"><span class="linenos">3970</span></a>            <span class="n">all_wedges</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc.composition_pie-3971"><a href="#COMPsc.composition_pie-3971"><span class="linenos">3971</span></a>            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="COMPsc.composition_pie-3972"><a href="#COMPsc.composition_pie-3972"><span class="linenos">3972</span></a>
</span><span id="COMPsc.composition_pie-3973"><a href="#COMPsc.composition_pie-3973"><span class="linenos">3973</span></a>            <span class="n">set_nam</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]))</span>
</span><span id="COMPsc.composition_pie-3974"><a href="#COMPsc.composition_pie-3974"><span class="linenos">3974</span></a>
</span><span id="COMPsc.composition_pie-3975"><a href="#COMPsc.composition_pie-3975"><span class="linenos">3975</span></a>            <span class="n">legend_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]))</span>
</span><span id="COMPsc.composition_pie-3976"><a href="#COMPsc.composition_pie-3976"><span class="linenos">3976</span></a>
</span><span id="COMPsc.composition_pie-3977"><a href="#COMPsc.composition_pie-3977"><span class="linenos">3977</span></a>            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">set_nam</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">set_nam</span><span class="p">)]</span>
</span><span id="COMPsc.composition_pie-3978"><a href="#COMPsc.composition_pie-3978"><span class="linenos">3978</span></a>
</span><span id="COMPsc.composition_pie-3979"><a href="#COMPsc.composition_pie-3979"><span class="linenos">3979</span></a>            <span class="n">cmap_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">legend_labels</span><span class="p">,</span> <span class="n">colors</span><span class="p">))</span>
</span><span id="COMPsc.composition_pie-3980"><a href="#COMPsc.composition_pie-3980"><span class="linenos">3980</span></a>
</span><span id="COMPsc.composition_pie-3981"><a href="#COMPsc.composition_pie-3981"><span class="linenos">3981</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sets</span><span class="p">):</span>
</span><span id="COMPsc.composition_pie-3982"><a href="#COMPsc.composition_pie-3982"><span class="linenos">3982</span></a>                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="COMPsc.composition_pie-3983"><a href="#COMPsc.composition_pie-3983"><span class="linenos">3983</span></a>                <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="COMPsc.composition_pie-3984"><a href="#COMPsc.composition_pie-3984"><span class="linenos">3984</span></a>
</span><span id="COMPsc.composition_pie-3985"><a href="#COMPsc.composition_pie-3985"><span class="linenos">3985</span></a>                <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tmp_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
</span><span id="COMPsc.composition_pie-3986"><a href="#COMPsc.composition_pie-3986"><span class="linenos">3986</span></a>
</span><span id="COMPsc.composition_pie-3987"><a href="#COMPsc.composition_pie-3987"><span class="linenos">3987</span></a>                <span class="n">wedges</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span>
</span><span id="COMPsc.composition_pie-3988"><a href="#COMPsc.composition_pie-3988"><span class="linenos">3988</span></a>                    <span class="n">tmp_df</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">],</span>
</span><span id="COMPsc.composition_pie-3989"><a href="#COMPsc.composition_pie-3989"><span class="linenos">3989</span></a>                    <span class="n">startangle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-3990"><a href="#COMPsc.composition_pie-3990"><span class="linenos">3990</span></a>                    <span class="n">labeldistance</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-3991"><a href="#COMPsc.composition_pie-3991"><span class="linenos">3991</span></a>                    <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="n">cmap_dict</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tmp_df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]],</span>
</span><span id="COMPsc.composition_pie-3992"><a href="#COMPsc.composition_pie-3992"><span class="linenos">3992</span></a>                    <span class="n">wedgeprops</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;edgecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">},</span>
</span><span id="COMPsc.composition_pie-3993"><a href="#COMPsc.composition_pie-3993"><span class="linenos">3993</span></a>                <span class="p">)</span>
</span><span id="COMPsc.composition_pie-3994"><a href="#COMPsc.composition_pie-3994"><span class="linenos">3994</span></a>
</span><span id="COMPsc.composition_pie-3995"><a href="#COMPsc.composition_pie-3995"><span class="linenos">3995</span></a>                <span class="n">all_wedges</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">wedges</span><span class="p">)</span>
</span><span id="COMPsc.composition_pie-3996"><a href="#COMPsc.composition_pie-3996"><span class="linenos">3996</span></a>
</span><span id="COMPsc.composition_pie-3997"><a href="#COMPsc.composition_pie-3997"><span class="linenos">3997</span></a>                <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
</span><span id="COMPsc.composition_pie-3998"><a href="#COMPsc.composition_pie-3998"><span class="linenos">3998</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="COMPsc.composition_pie-3999"><a href="#COMPsc.composition_pie-3999"><span class="linenos">3999</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wedges</span><span class="p">):</span>
</span><span id="COMPsc.composition_pie-4000"><a href="#COMPsc.composition_pie-4000"><span class="linenos">4000</span></a>                    <span class="n">ang</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">theta2</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">theta1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">theta1</span>
</span><span id="COMPsc.composition_pie-4001"><a href="#COMPsc.composition_pie-4001"><span class="linenos">4001</span></a>                    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
</span><span id="COMPsc.composition_pie-4002"><a href="#COMPsc.composition_pie-4002"><span class="linenos">4002</span></a>                    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
</span><span id="COMPsc.composition_pie-4003"><a href="#COMPsc.composition_pie-4003"><span class="linenos">4003</span></a>                    <span class="n">horizontalalignment</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;left&quot;</span><span class="p">}[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>
</span><span id="COMPsc.composition_pie-4004"><a href="#COMPsc.composition_pie-4004"><span class="linenos">4004</span></a>                    <span class="n">connectionstyle</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;angle,angleA=0,angleB=</span><span class="si">{</span><span class="n">ang</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="COMPsc.composition_pie-4005"><a href="#COMPsc.composition_pie-4005"><span class="linenos">4005</span></a>                    <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;arrowprops&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;connectionstyle&quot;</span><span class="p">:</span> <span class="n">connectionstyle</span><span class="p">})</span>
</span><span id="COMPsc.composition_pie-4006"><a href="#COMPsc.composition_pie-4006"><span class="linenos">4006</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.composition_pie-4007"><a href="#COMPsc.composition_pie-4007"><span class="linenos">4007</span></a>                        <span class="n">n</span> <span class="o">+=</span> <span class="n">offset_labels</span>
</span><span id="COMPsc.composition_pie-4008"><a href="#COMPsc.composition_pie-4008"><span class="linenos">4008</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="COMPsc.composition_pie-4009"><a href="#COMPsc.composition_pie-4009"><span class="linenos">4009</span></a>                            <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="COMPsc.composition_pie-4010"><a href="#COMPsc.composition_pie-4010"><span class="linenos">4010</span></a>                            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
</span><span id="COMPsc.composition_pie-4011"><a href="#COMPsc.composition_pie-4011"><span class="linenos">4011</span></a>                            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">4</span><span class="p">),</span> <span class="mf">1.01</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">y</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)),</span>
</span><span id="COMPsc.composition_pie-4012"><a href="#COMPsc.composition_pie-4012"><span class="linenos">4012</span></a>                            <span class="n">horizontalalignment</span><span class="o">=</span><span class="n">horizontalalignment</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4013"><a href="#COMPsc.composition_pie-4013"><span class="linenos">4013</span></a>                            <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4014"><a href="#COMPsc.composition_pie-4014"><span class="linenos">4014</span></a>                            <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4015"><a href="#COMPsc.composition_pie-4015"><span class="linenos">4015</span></a>                            <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4016"><a href="#COMPsc.composition_pie-4016"><span class="linenos">4016</span></a>                        <span class="p">)</span>
</span><span id="COMPsc.composition_pie-4017"><a href="#COMPsc.composition_pie-4017"><span class="linenos">4017</span></a>
</span><span id="COMPsc.composition_pie-4018"><a href="#COMPsc.composition_pie-4018"><span class="linenos">4018</span></a>                <span class="n">circle2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
</span><span id="COMPsc.composition_pie-4019"><a href="#COMPsc.composition_pie-4019"><span class="linenos">4019</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle2</span><span class="p">)</span>
</span><span id="COMPsc.composition_pie-4020"><a href="#COMPsc.composition_pie-4020"><span class="linenos">4020</span></a>
</span><span id="COMPsc.composition_pie-4021"><a href="#COMPsc.composition_pie-4021"><span class="linenos">4021</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="COMPsc.composition_pie-4022"><a href="#COMPsc.composition_pie-4022"><span class="linenos">4022</span></a>                    <span class="mi">0</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4023"><a href="#COMPsc.composition_pie-4023"><span class="linenos">4023</span></a>                    <span class="mi">0</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4024"><a href="#COMPsc.composition_pie-4024"><span class="linenos">4024</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4025"><a href="#COMPsc.composition_pie-4025"><span class="linenos">4025</span></a>                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4026"><a href="#COMPsc.composition_pie-4026"><span class="linenos">4026</span></a>                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4027"><a href="#COMPsc.composition_pie-4027"><span class="linenos">4027</span></a>                    <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4028"><a href="#COMPsc.composition_pie-4028"><span class="linenos">4028</span></a>                    <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4029"><a href="#COMPsc.composition_pie-4029"><span class="linenos">4029</span></a>                <span class="p">)</span>
</span><span id="COMPsc.composition_pie-4030"><a href="#COMPsc.composition_pie-4030"><span class="linenos">4030</span></a>
</span><span id="COMPsc.composition_pie-4031"><a href="#COMPsc.composition_pie-4031"><span class="linenos">4031</span></a>            <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc.composition_pie-4032"><a href="#COMPsc.composition_pie-4032"><span class="linenos">4032</span></a>                <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">cmap_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
</span><span id="COMPsc.composition_pie-4033"><a href="#COMPsc.composition_pie-4033"><span class="linenos">4033</span></a>                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">legend_labels</span>
</span><span id="COMPsc.composition_pie-4034"><a href="#COMPsc.composition_pie-4034"><span class="linenos">4034</span></a>            <span class="p">]</span>
</span><span id="COMPsc.composition_pie-4035"><a href="#COMPsc.composition_pie-4035"><span class="linenos">4035</span></a>
</span><span id="COMPsc.composition_pie-4036"><a href="#COMPsc.composition_pie-4036"><span class="linenos">4036</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="COMPsc.composition_pie-4037"><a href="#COMPsc.composition_pie-4037"><span class="linenos">4037</span></a>                <span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4038"><a href="#COMPsc.composition_pie-4038"><span class="linenos">4038</span></a>                <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center right&quot;</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4039"><a href="#COMPsc.composition_pie-4039"><span class="linenos">4039</span></a>                <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">legend_bbox</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4040"><a href="#COMPsc.composition_pie-4040"><span class="linenos">4040</span></a>                <span class="n">ncol</span><span class="o">=</span><span class="n">legend_split_col</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4041"><a href="#COMPsc.composition_pie-4041"><span class="linenos">4041</span></a>                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4042"><a href="#COMPsc.composition_pie-4042"><span class="linenos">4042</span></a>            <span class="p">)</span>
</span><span id="COMPsc.composition_pie-4043"><a href="#COMPsc.composition_pie-4043"><span class="linenos">4043</span></a>
</span><span id="COMPsc.composition_pie-4044"><a href="#COMPsc.composition_pie-4044"><span class="linenos">4044</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="COMPsc.composition_pie-4045"><a href="#COMPsc.composition_pie-4045"><span class="linenos">4045</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="COMPsc.composition_pie-4046"><a href="#COMPsc.composition_pie-4046"><span class="linenos">4046</span></a>
</span><span id="COMPsc.composition_pie-4047"><a href="#COMPsc.composition_pie-4047"><span class="linenos">4047</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.composition_pie-4048"><a href="#COMPsc.composition_pie-4048"><span class="linenos">4048</span></a>
</span><span id="COMPsc.composition_pie-4049"><a href="#COMPsc.composition_pie-4049"><span class="linenos">4049</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
</span><span id="COMPsc.composition_pie-4050"><a href="#COMPsc.composition_pie-4050"><span class="linenos">4050</span></a>
</span><span id="COMPsc.composition_pie-4051"><a href="#COMPsc.composition_pie-4051"><span class="linenos">4051</span></a>            <span class="n">legend_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
</span><span id="COMPsc.composition_pie-4052"><a href="#COMPsc.composition_pie-4052"><span class="linenos">4052</span></a>
</span><span id="COMPsc.composition_pie-4053"><a href="#COMPsc.composition_pie-4053"><span class="linenos">4053</span></a>            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="COMPsc.composition_pie-4054"><a href="#COMPsc.composition_pie-4054"><span class="linenos">4054</span></a>            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))]</span>
</span><span id="COMPsc.composition_pie-4055"><a href="#COMPsc.composition_pie-4055"><span class="linenos">4055</span></a>
</span><span id="COMPsc.composition_pie-4056"><a href="#COMPsc.composition_pie-4056"><span class="linenos">4056</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="COMPsc.composition_pie-4057"><a href="#COMPsc.composition_pie-4057"><span class="linenos">4057</span></a>                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
</span><span id="COMPsc.composition_pie-4058"><a href="#COMPsc.composition_pie-4058"><span class="linenos">4058</span></a>            <span class="p">)</span>
</span><span id="COMPsc.composition_pie-4059"><a href="#COMPsc.composition_pie-4059"><span class="linenos">4059</span></a>
</span><span id="COMPsc.composition_pie-4060"><a href="#COMPsc.composition_pie-4060"><span class="linenos">4060</span></a>            <span class="n">wedges</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span>
</span><span id="COMPsc.composition_pie-4061"><a href="#COMPsc.composition_pie-4061"><span class="linenos">4061</span></a>                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">],</span>
</span><span id="COMPsc.composition_pie-4062"><a href="#COMPsc.composition_pie-4062"><span class="linenos">4062</span></a>                <span class="n">startangle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4063"><a href="#COMPsc.composition_pie-4063"><span class="linenos">4063</span></a>                <span class="n">labeldistance</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4064"><a href="#COMPsc.composition_pie-4064"><span class="linenos">4064</span></a>                <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4065"><a href="#COMPsc.composition_pie-4065"><span class="linenos">4065</span></a>                <span class="n">wedgeprops</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;edgecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">},</span>
</span><span id="COMPsc.composition_pie-4066"><a href="#COMPsc.composition_pie-4066"><span class="linenos">4066</span></a>            <span class="p">)</span>
</span><span id="COMPsc.composition_pie-4067"><a href="#COMPsc.composition_pie-4067"><span class="linenos">4067</span></a>
</span><span id="COMPsc.composition_pie-4068"><a href="#COMPsc.composition_pie-4068"><span class="linenos">4068</span></a>            <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
</span><span id="COMPsc.composition_pie-4069"><a href="#COMPsc.composition_pie-4069"><span class="linenos">4069</span></a>            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="COMPsc.composition_pie-4070"><a href="#COMPsc.composition_pie-4070"><span class="linenos">4070</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wedges</span><span class="p">):</span>
</span><span id="COMPsc.composition_pie-4071"><a href="#COMPsc.composition_pie-4071"><span class="linenos">4071</span></a>                <span class="n">ang</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">theta2</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">theta1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">theta1</span>
</span><span id="COMPsc.composition_pie-4072"><a href="#COMPsc.composition_pie-4072"><span class="linenos">4072</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
</span><span id="COMPsc.composition_pie-4073"><a href="#COMPsc.composition_pie-4073"><span class="linenos">4073</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
</span><span id="COMPsc.composition_pie-4074"><a href="#COMPsc.composition_pie-4074"><span class="linenos">4074</span></a>                <span class="n">horizontalalignment</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;left&quot;</span><span class="p">}[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>
</span><span id="COMPsc.composition_pie-4075"><a href="#COMPsc.composition_pie-4075"><span class="linenos">4075</span></a>                <span class="n">connectionstyle</span> <span class="o">=</span> <span class="s2">&quot;angle,angleA=0,angleB=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span>
</span><span id="COMPsc.composition_pie-4076"><a href="#COMPsc.composition_pie-4076"><span class="linenos">4076</span></a>                <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;arrowprops&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;connectionstyle&quot;</span><span class="p">:</span> <span class="n">connectionstyle</span><span class="p">})</span>
</span><span id="COMPsc.composition_pie-4077"><a href="#COMPsc.composition_pie-4077"><span class="linenos">4077</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="COMPsc.composition_pie-4078"><a href="#COMPsc.composition_pie-4078"><span class="linenos">4078</span></a>                    <span class="n">n</span> <span class="o">+=</span> <span class="n">offset_labels</span>
</span><span id="COMPsc.composition_pie-4079"><a href="#COMPsc.composition_pie-4079"><span class="linenos">4079</span></a>
</span><span id="COMPsc.composition_pie-4080"><a href="#COMPsc.composition_pie-4080"><span class="linenos">4080</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="COMPsc.composition_pie-4081"><a href="#COMPsc.composition_pie-4081"><span class="linenos">4081</span></a>                        <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="COMPsc.composition_pie-4082"><a href="#COMPsc.composition_pie-4082"><span class="linenos">4082</span></a>                        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
</span><span id="COMPsc.composition_pie-4083"><a href="#COMPsc.composition_pie-4083"><span class="linenos">4083</span></a>                        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">4</span><span class="p">),</span> <span class="n">y</span> <span class="o">*</span> <span class="mf">1.01</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">y</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)),</span>
</span><span id="COMPsc.composition_pie-4084"><a href="#COMPsc.composition_pie-4084"><span class="linenos">4084</span></a>                        <span class="n">horizontalalignment</span><span class="o">=</span><span class="n">horizontalalignment</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4085"><a href="#COMPsc.composition_pie-4085"><span class="linenos">4085</span></a>                        <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4086"><a href="#COMPsc.composition_pie-4086"><span class="linenos">4086</span></a>                        <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4087"><a href="#COMPsc.composition_pie-4087"><span class="linenos">4087</span></a>                        <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4088"><a href="#COMPsc.composition_pie-4088"><span class="linenos">4088</span></a>                    <span class="p">)</span>
</span><span id="COMPsc.composition_pie-4089"><a href="#COMPsc.composition_pie-4089"><span class="linenos">4089</span></a>
</span><span id="COMPsc.composition_pie-4090"><a href="#COMPsc.composition_pie-4090"><span class="linenos">4090</span></a>            <span class="n">circle2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
</span><span id="COMPsc.composition_pie-4091"><a href="#COMPsc.composition_pie-4091"><span class="linenos">4091</span></a>            <span class="n">circle2</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
</span><span id="COMPsc.composition_pie-4092"><a href="#COMPsc.composition_pie-4092"><span class="linenos">4092</span></a>
</span><span id="COMPsc.composition_pie-4093"><a href="#COMPsc.composition_pie-4093"><span class="linenos">4093</span></a>            <span class="n">p</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
</span><span id="COMPsc.composition_pie-4094"><a href="#COMPsc.composition_pie-4094"><span class="linenos">4094</span></a>            <span class="n">p</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle2</span><span class="p">)</span>
</span><span id="COMPsc.composition_pie-4095"><a href="#COMPsc.composition_pie-4095"><span class="linenos">4095</span></a>
</span><span id="COMPsc.composition_pie-4096"><a href="#COMPsc.composition_pie-4096"><span class="linenos">4096</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="COMPsc.composition_pie-4097"><a href="#COMPsc.composition_pie-4097"><span class="linenos">4097</span></a>                <span class="n">wedges</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4098"><a href="#COMPsc.composition_pie-4098"><span class="linenos">4098</span></a>                <span class="n">legend_labels</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4099"><a href="#COMPsc.composition_pie-4099"><span class="linenos">4099</span></a>                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4100"><a href="#COMPsc.composition_pie-4100"><span class="linenos">4100</span></a>                <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4101"><a href="#COMPsc.composition_pie-4101"><span class="linenos">4101</span></a>                <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">legend_bbox</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4102"><a href="#COMPsc.composition_pie-4102"><span class="linenos">4102</span></a>                <span class="n">ncol</span><span class="o">=</span><span class="n">legend_split_col</span><span class="p">,</span>
</span><span id="COMPsc.composition_pie-4103"><a href="#COMPsc.composition_pie-4103"><span class="linenos">4103</span></a>            <span class="p">)</span>
</span><span id="COMPsc.composition_pie-4104"><a href="#COMPsc.composition_pie-4104"><span class="linenos">4104</span></a>
</span><span id="COMPsc.composition_pie-4105"><a href="#COMPsc.composition_pie-4105"><span class="linenos">4105</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="COMPsc.composition_pie-4106"><a href="#COMPsc.composition_pie-4106"><span class="linenos">4106</span></a>
</span><span id="COMPsc.composition_pie-4107"><a href="#COMPsc.composition_pie-4107"><span class="linenos">4107</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span></pre></div>


            <div class="docstring"><p>Visualize the composition of cell lineages using pie charts.</p>

<p>Generates pie charts showing the relative proportions of features stored
in <code>self.composition_data</code>. If multiple sets are present, a separate
chart is drawn for each set.</p>

<h2 id="parameters">Parameters</h2>

<p>width : int, default 6
    Width of the figure.</p>

<p>height : int, default 6
    Height of the figure (applied per set if multiple sets are plotted).</p>

<p>font_size : int, default 15
    Font size for labels and annotations.</p>

<p>cmap : str, default 'tab20'
    Colormap used for pie slices.</p>

<p>legend_split_col : int, default 1
    Number of columns in the legend.</p>

<p>offset_labels : float or int, default 0.5
    Spacing offset for label placement relative to pie slices.</p>

<p>legend_bbox : tuple, default (1.15, 0.95)
    Bounding box anchor position for the legend.</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.figure.Figure
    Pie chart visualization of composition data.</p>
</div>


                            </div>
                            <div id="COMPsc.bar_composition" class="classattr">
                                        <input id="COMPsc.bar_composition-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">bar_composition</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;tab20b&#39;</span>,</span><span class="param">	<span class="n">width</span><span class="o">=</span><span class="mi">2</span>,</span><span class="param">	<span class="n">height</span><span class="o">=</span><span class="mi">6</span>,</span><span class="param">	<span class="n">font_size</span><span class="o">=</span><span class="mi">15</span>,</span><span class="param">	<span class="n">legend_split_col</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">legend_bbox</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.bar_composition-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.bar_composition"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.bar_composition-4109"><a href="#COMPsc.bar_composition-4109"><span class="linenos">4109</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bar_composition</span><span class="p">(</span>
</span><span id="COMPsc.bar_composition-4110"><a href="#COMPsc.bar_composition-4110"><span class="linenos">4110</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4111"><a href="#COMPsc.bar_composition-4111"><span class="linenos">4111</span></a>        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;tab20b&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4112"><a href="#COMPsc.bar_composition-4112"><span class="linenos">4112</span></a>        <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4113"><a href="#COMPsc.bar_composition-4113"><span class="linenos">4113</span></a>        <span class="n">height</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4114"><a href="#COMPsc.bar_composition-4114"><span class="linenos">4114</span></a>        <span class="n">font_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4115"><a href="#COMPsc.bar_composition-4115"><span class="linenos">4115</span></a>        <span class="n">legend_split_col</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4116"><a href="#COMPsc.bar_composition-4116"><span class="linenos">4116</span></a>        <span class="n">legend_bbox</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="COMPsc.bar_composition-4117"><a href="#COMPsc.bar_composition-4117"><span class="linenos">4117</span></a>    <span class="p">):</span>
</span><span id="COMPsc.bar_composition-4118"><a href="#COMPsc.bar_composition-4118"><span class="linenos">4118</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.bar_composition-4119"><a href="#COMPsc.bar_composition-4119"><span class="linenos">4119</span></a><span class="sd">        Visualize the composition of cell lineages using bar plots.</span>
</span><span id="COMPsc.bar_composition-4120"><a href="#COMPsc.bar_composition-4120"><span class="linenos">4120</span></a>
</span><span id="COMPsc.bar_composition-4121"><a href="#COMPsc.bar_composition-4121"><span class="linenos">4121</span></a><span class="sd">        Produces bar plots showing the distribution of features stored in</span>
</span><span id="COMPsc.bar_composition-4122"><a href="#COMPsc.bar_composition-4122"><span class="linenos">4122</span></a><span class="sd">        `self.composition_data`. If multiple sets are present, a separate</span>
</span><span id="COMPsc.bar_composition-4123"><a href="#COMPsc.bar_composition-4123"><span class="linenos">4123</span></a><span class="sd">        bar is drawn for each set. Percentages are annotated alongside the bars.</span>
</span><span id="COMPsc.bar_composition-4124"><a href="#COMPsc.bar_composition-4124"><span class="linenos">4124</span></a>
</span><span id="COMPsc.bar_composition-4125"><a href="#COMPsc.bar_composition-4125"><span class="linenos">4125</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.bar_composition-4126"><a href="#COMPsc.bar_composition-4126"><span class="linenos">4126</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.bar_composition-4127"><a href="#COMPsc.bar_composition-4127"><span class="linenos">4127</span></a><span class="sd">        cmap : str, default &#39;tab20b&#39;</span>
</span><span id="COMPsc.bar_composition-4128"><a href="#COMPsc.bar_composition-4128"><span class="linenos">4128</span></a><span class="sd">            Colormap used for stacked bars.</span>
</span><span id="COMPsc.bar_composition-4129"><a href="#COMPsc.bar_composition-4129"><span class="linenos">4129</span></a>
</span><span id="COMPsc.bar_composition-4130"><a href="#COMPsc.bar_composition-4130"><span class="linenos">4130</span></a><span class="sd">        width : int, default 2</span>
</span><span id="COMPsc.bar_composition-4131"><a href="#COMPsc.bar_composition-4131"><span class="linenos">4131</span></a><span class="sd">            Width of each subplot (per set).</span>
</span><span id="COMPsc.bar_composition-4132"><a href="#COMPsc.bar_composition-4132"><span class="linenos">4132</span></a>
</span><span id="COMPsc.bar_composition-4133"><a href="#COMPsc.bar_composition-4133"><span class="linenos">4133</span></a><span class="sd">        height : int, default 6</span>
</span><span id="COMPsc.bar_composition-4134"><a href="#COMPsc.bar_composition-4134"><span class="linenos">4134</span></a><span class="sd">            Height of the figure.</span>
</span><span id="COMPsc.bar_composition-4135"><a href="#COMPsc.bar_composition-4135"><span class="linenos">4135</span></a>
</span><span id="COMPsc.bar_composition-4136"><a href="#COMPsc.bar_composition-4136"><span class="linenos">4136</span></a><span class="sd">        font_size : int, default 15</span>
</span><span id="COMPsc.bar_composition-4137"><a href="#COMPsc.bar_composition-4137"><span class="linenos">4137</span></a><span class="sd">            Font size for labels and annotations.</span>
</span><span id="COMPsc.bar_composition-4138"><a href="#COMPsc.bar_composition-4138"><span class="linenos">4138</span></a>
</span><span id="COMPsc.bar_composition-4139"><a href="#COMPsc.bar_composition-4139"><span class="linenos">4139</span></a><span class="sd">        legend_split_col : int, default 1</span>
</span><span id="COMPsc.bar_composition-4140"><a href="#COMPsc.bar_composition-4140"><span class="linenos">4140</span></a><span class="sd">            Number of columns in the legend.</span>
</span><span id="COMPsc.bar_composition-4141"><a href="#COMPsc.bar_composition-4141"><span class="linenos">4141</span></a>
</span><span id="COMPsc.bar_composition-4142"><a href="#COMPsc.bar_composition-4142"><span class="linenos">4142</span></a><span class="sd">        legend_bbox : tuple, default (1.3, 1)</span>
</span><span id="COMPsc.bar_composition-4143"><a href="#COMPsc.bar_composition-4143"><span class="linenos">4143</span></a><span class="sd">            Bounding box anchor position for the legend.</span>
</span><span id="COMPsc.bar_composition-4144"><a href="#COMPsc.bar_composition-4144"><span class="linenos">4144</span></a>
</span><span id="COMPsc.bar_composition-4145"><a href="#COMPsc.bar_composition-4145"><span class="linenos">4145</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc.bar_composition-4146"><a href="#COMPsc.bar_composition-4146"><span class="linenos">4146</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.bar_composition-4147"><a href="#COMPsc.bar_composition-4147"><span class="linenos">4147</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc.bar_composition-4148"><a href="#COMPsc.bar_composition-4148"><span class="linenos">4148</span></a><span class="sd">            Stacked bar plot visualization of composition data.</span>
</span><span id="COMPsc.bar_composition-4149"><a href="#COMPsc.bar_composition-4149"><span class="linenos">4149</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.bar_composition-4150"><a href="#COMPsc.bar_composition-4150"><span class="linenos">4150</span></a>
</span><span id="COMPsc.bar_composition-4151"><a href="#COMPsc.bar_composition-4151"><span class="linenos">4151</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_data</span>
</span><span id="COMPsc.bar_composition-4152"><a href="#COMPsc.bar_composition-4152"><span class="linenos">4152</span></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="COMPsc.bar_composition-4153"><a href="#COMPsc.bar_composition-4153"><span class="linenos">4153</span></a>
</span><span id="COMPsc.bar_composition-4154"><a href="#COMPsc.bar_composition-4154"><span class="linenos">4154</span></a>        <span class="k">if</span> <span class="s2">&quot;set&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="COMPsc.bar_composition-4155"><a href="#COMPsc.bar_composition-4155"><span class="linenos">4155</span></a>
</span><span id="COMPsc.bar_composition-4156"><a href="#COMPsc.bar_composition-4156"><span class="linenos">4156</span></a>            <span class="n">sets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]))</span>
</span><span id="COMPsc.bar_composition-4157"><a href="#COMPsc.bar_composition-4157"><span class="linenos">4157</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">),</span> <span class="n">height</span><span class="p">))</span>
</span><span id="COMPsc.bar_composition-4158"><a href="#COMPsc.bar_composition-4158"><span class="linenos">4158</span></a>
</span><span id="COMPsc.bar_composition-4159"><a href="#COMPsc.bar_composition-4159"><span class="linenos">4159</span></a>            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="COMPsc.bar_composition-4160"><a href="#COMPsc.bar_composition-4160"><span class="linenos">4160</span></a>
</span><span id="COMPsc.bar_composition-4161"><a href="#COMPsc.bar_composition-4161"><span class="linenos">4161</span></a>            <span class="n">set_nam</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]))</span>
</span><span id="COMPsc.bar_composition-4162"><a href="#COMPsc.bar_composition-4162"><span class="linenos">4162</span></a>
</span><span id="COMPsc.bar_composition-4163"><a href="#COMPsc.bar_composition-4163"><span class="linenos">4163</span></a>            <span class="n">legend_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]))</span>
</span><span id="COMPsc.bar_composition-4164"><a href="#COMPsc.bar_composition-4164"><span class="linenos">4164</span></a>
</span><span id="COMPsc.bar_composition-4165"><a href="#COMPsc.bar_composition-4165"><span class="linenos">4165</span></a>            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">set_nam</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">set_nam</span><span class="p">)]</span>
</span><span id="COMPsc.bar_composition-4166"><a href="#COMPsc.bar_composition-4166"><span class="linenos">4166</span></a>
</span><span id="COMPsc.bar_composition-4167"><a href="#COMPsc.bar_composition-4167"><span class="linenos">4167</span></a>            <span class="n">cmap_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">legend_labels</span><span class="p">,</span> <span class="n">colors</span><span class="p">))</span>
</span><span id="COMPsc.bar_composition-4168"><a href="#COMPsc.bar_composition-4168"><span class="linenos">4168</span></a>
</span><span id="COMPsc.bar_composition-4169"><a href="#COMPsc.bar_composition-4169"><span class="linenos">4169</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sets</span><span class="p">):</span>
</span><span id="COMPsc.bar_composition-4170"><a href="#COMPsc.bar_composition-4170"><span class="linenos">4170</span></a>                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="COMPsc.bar_composition-4171"><a href="#COMPsc.bar_composition-4171"><span class="linenos">4171</span></a>
</span><span id="COMPsc.bar_composition-4172"><a href="#COMPsc.bar_composition-4172"><span class="linenos">4172</span></a>                <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="COMPsc.bar_composition-4173"><a href="#COMPsc.bar_composition-4173"><span class="linenos">4173</span></a>
</span><span id="COMPsc.bar_composition-4174"><a href="#COMPsc.bar_composition-4174"><span class="linenos">4174</span></a>                <span class="n">values</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="COMPsc.bar_composition-4175"><a href="#COMPsc.bar_composition-4175"><span class="linenos">4175</span></a>                <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</span><span id="COMPsc.bar_composition-4176"><a href="#COMPsc.bar_composition-4176"><span class="linenos">4176</span></a>                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
</span><span id="COMPsc.bar_composition-4177"><a href="#COMPsc.bar_composition-4177"><span class="linenos">4177</span></a>                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
</span><span id="COMPsc.bar_composition-4178"><a href="#COMPsc.bar_composition-4178"><span class="linenos">4178</span></a>
</span><span id="COMPsc.bar_composition-4179"><a href="#COMPsc.bar_composition-4179"><span class="linenos">4179</span></a>                <span class="n">idx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</span><span id="COMPsc.bar_composition-4180"><a href="#COMPsc.bar_composition-4180"><span class="linenos">4180</span></a>                <span class="n">correction</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</span><span id="COMPsc.bar_composition-4181"><a href="#COMPsc.bar_composition-4181"><span class="linenos">4181</span></a>                <span class="n">values</span><span class="p">[</span><span class="n">idx_max</span><span class="p">]</span> <span class="o">+=</span> <span class="n">correction</span>
</span><span id="COMPsc.bar_composition-4182"><a href="#COMPsc.bar_composition-4182"><span class="linenos">4182</span></a>
</span><span id="COMPsc.bar_composition-4183"><a href="#COMPsc.bar_composition-4183"><span class="linenos">4183</span></a>                <span class="n">names</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="COMPsc.bar_composition-4184"><a href="#COMPsc.bar_composition-4184"><span class="linenos">4184</span></a>                <span class="n">perc</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="COMPsc.bar_composition-4185"><a href="#COMPsc.bar_composition-4185"><span class="linenos">4185</span></a>                <span class="n">nums</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="p">[</span><span class="s2">&quot;num&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="COMPsc.bar_composition-4186"><a href="#COMPsc.bar_composition-4186"><span class="linenos">4186</span></a>
</span><span id="COMPsc.bar_composition-4187"><a href="#COMPsc.bar_composition-4187"><span class="linenos">4187</span></a>                <span class="n">bottom</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="COMPsc.bar_composition-4188"><a href="#COMPsc.bar_composition-4188"><span class="linenos">4188</span></a>                <span class="n">centers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc.bar_composition-4189"><a href="#COMPsc.bar_composition-4189"><span class="linenos">4189</span></a>                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">nums</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
</span><span id="COMPsc.bar_composition-4190"><a href="#COMPsc.bar_composition-4190"><span class="linenos">4190</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">bottom</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap_dict</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</span><span id="COMPsc.bar_composition-4191"><a href="#COMPsc.bar_composition-4191"><span class="linenos">4191</span></a>                    <span class="n">centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bottom</span> <span class="o">+</span> <span class="n">val</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="COMPsc.bar_composition-4192"><a href="#COMPsc.bar_composition-4192"><span class="linenos">4192</span></a>                    <span class="n">bottom</span> <span class="o">+=</span> <span class="n">val</span>
</span><span id="COMPsc.bar_composition-4193"><a href="#COMPsc.bar_composition-4193"><span class="linenos">4193</span></a>
</span><span id="COMPsc.bar_composition-4194"><a href="#COMPsc.bar_composition-4194"><span class="linenos">4194</span></a>                <span class="n">y_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">centers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">centers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">centers</span><span class="p">))</span>
</span><span id="COMPsc.bar_composition-4195"><a href="#COMPsc.bar_composition-4195"><span class="linenos">4195</span></a>                <span class="n">x_text</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.8</span>
</span><span id="COMPsc.bar_composition-4196"><a href="#COMPsc.bar_composition-4196"><span class="linenos">4196</span></a>
</span><span id="COMPsc.bar_composition-4197"><a href="#COMPsc.bar_composition-4197"><span class="linenos">4197</span></a>                <span class="k">for</span> <span class="n">y_label</span><span class="p">,</span> <span class="n">y_center</span><span class="p">,</span> <span class="n">pct</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
</span><span id="COMPsc.bar_composition-4198"><a href="#COMPsc.bar_composition-4198"><span class="linenos">4198</span></a>                    <span class="n">y_positions</span><span class="p">,</span> <span class="n">centers</span><span class="p">,</span> <span class="n">perc</span><span class="p">,</span> <span class="n">nums</span>
</span><span id="COMPsc.bar_composition-4199"><a href="#COMPsc.bar_composition-4199"><span class="linenos">4199</span></a>                <span class="p">):</span>
</span><span id="COMPsc.bar_composition-4200"><a href="#COMPsc.bar_composition-4200"><span class="linenos">4200</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="COMPsc.bar_composition-4201"><a href="#COMPsc.bar_composition-4201"><span class="linenos">4201</span></a>                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4202"><a href="#COMPsc.bar_composition-4202"><span class="linenos">4202</span></a>                        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_center</span><span class="p">),</span>
</span><span id="COMPsc.bar_composition-4203"><a href="#COMPsc.bar_composition-4203"><span class="linenos">4203</span></a>                        <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4204"><a href="#COMPsc.bar_composition-4204"><span class="linenos">4204</span></a>                        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">x_text</span><span class="p">,</span> <span class="n">y_label</span><span class="p">),</span>
</span><span id="COMPsc.bar_composition-4205"><a href="#COMPsc.bar_composition-4205"><span class="linenos">4205</span></a>                        <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4206"><a href="#COMPsc.bar_composition-4206"><span class="linenos">4206</span></a>                        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4207"><a href="#COMPsc.bar_composition-4207"><span class="linenos">4207</span></a>                        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4208"><a href="#COMPsc.bar_composition-4208"><span class="linenos">4208</span></a>                        <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4209"><a href="#COMPsc.bar_composition-4209"><span class="linenos">4209</span></a>                        <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="COMPsc.bar_composition-4210"><a href="#COMPsc.bar_composition-4210"><span class="linenos">4210</span></a>                            <span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4211"><a href="#COMPsc.bar_composition-4211"><span class="linenos">4211</span></a>                            <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4212"><a href="#COMPsc.bar_composition-4212"><span class="linenos">4212</span></a>                            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4213"><a href="#COMPsc.bar_composition-4213"><span class="linenos">4213</span></a>                            <span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;angle3,angleA=0,angleB=90&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4214"><a href="#COMPsc.bar_composition-4214"><span class="linenos">4214</span></a>                        <span class="p">),</span>
</span><span id="COMPsc.bar_composition-4215"><a href="#COMPsc.bar_composition-4215"><span class="linenos">4215</span></a>                    <span class="p">)</span>
</span><span id="COMPsc.bar_composition-4216"><a href="#COMPsc.bar_composition-4216"><span class="linenos">4216</span></a>
</span><span id="COMPsc.bar_composition-4217"><a href="#COMPsc.bar_composition-4217"><span class="linenos">4217</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="COMPsc.bar_composition-4218"><a href="#COMPsc.bar_composition-4218"><span class="linenos">4218</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
</span><span id="COMPsc.bar_composition-4219"><a href="#COMPsc.bar_composition-4219"><span class="linenos">4219</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="COMPsc.bar_composition-4220"><a href="#COMPsc.bar_composition-4220"><span class="linenos">4220</span></a>
</span><span id="COMPsc.bar_composition-4221"><a href="#COMPsc.bar_composition-4221"><span class="linenos">4221</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
</span><span id="COMPsc.bar_composition-4222"><a href="#COMPsc.bar_composition-4222"><span class="linenos">4222</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
</span><span id="COMPsc.bar_composition-4223"><a href="#COMPsc.bar_composition-4223"><span class="linenos">4223</span></a>                <span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="COMPsc.bar_composition-4224"><a href="#COMPsc.bar_composition-4224"><span class="linenos">4224</span></a>                    <span class="n">spine</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="COMPsc.bar_composition-4225"><a href="#COMPsc.bar_composition-4225"><span class="linenos">4225</span></a>
</span><span id="COMPsc.bar_composition-4226"><a href="#COMPsc.bar_composition-4226"><span class="linenos">4226</span></a>            <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="COMPsc.bar_composition-4227"><a href="#COMPsc.bar_composition-4227"><span class="linenos">4227</span></a>                <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">cmap_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
</span><span id="COMPsc.bar_composition-4228"><a href="#COMPsc.bar_composition-4228"><span class="linenos">4228</span></a>                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">legend_labels</span>
</span><span id="COMPsc.bar_composition-4229"><a href="#COMPsc.bar_composition-4229"><span class="linenos">4229</span></a>            <span class="p">]</span>
</span><span id="COMPsc.bar_composition-4230"><a href="#COMPsc.bar_composition-4230"><span class="linenos">4230</span></a>
</span><span id="COMPsc.bar_composition-4231"><a href="#COMPsc.bar_composition-4231"><span class="linenos">4231</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="COMPsc.bar_composition-4232"><a href="#COMPsc.bar_composition-4232"><span class="linenos">4232</span></a>                <span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4233"><a href="#COMPsc.bar_composition-4233"><span class="linenos">4233</span></a>                <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center right&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4234"><a href="#COMPsc.bar_composition-4234"><span class="linenos">4234</span></a>                <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">legend_bbox</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4235"><a href="#COMPsc.bar_composition-4235"><span class="linenos">4235</span></a>                <span class="n">ncol</span><span class="o">=</span><span class="n">legend_split_col</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4236"><a href="#COMPsc.bar_composition-4236"><span class="linenos">4236</span></a>                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4237"><a href="#COMPsc.bar_composition-4237"><span class="linenos">4237</span></a>            <span class="p">)</span>
</span><span id="COMPsc.bar_composition-4238"><a href="#COMPsc.bar_composition-4238"><span class="linenos">4238</span></a>
</span><span id="COMPsc.bar_composition-4239"><a href="#COMPsc.bar_composition-4239"><span class="linenos">4239</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="COMPsc.bar_composition-4240"><a href="#COMPsc.bar_composition-4240"><span class="linenos">4240</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="COMPsc.bar_composition-4241"><a href="#COMPsc.bar_composition-4241"><span class="linenos">4241</span></a>
</span><span id="COMPsc.bar_composition-4242"><a href="#COMPsc.bar_composition-4242"><span class="linenos">4242</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.bar_composition-4243"><a href="#COMPsc.bar_composition-4243"><span class="linenos">4243</span></a>
</span><span id="COMPsc.bar_composition-4244"><a href="#COMPsc.bar_composition-4244"><span class="linenos">4244</span></a>            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="COMPsc.bar_composition-4245"><a href="#COMPsc.bar_composition-4245"><span class="linenos">4245</span></a>
</span><span id="COMPsc.bar_composition-4246"><a href="#COMPsc.bar_composition-4246"><span class="linenos">4246</span></a>            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))]</span>
</span><span id="COMPsc.bar_composition-4247"><a href="#COMPsc.bar_composition-4247"><span class="linenos">4247</span></a>
</span><span id="COMPsc.bar_composition-4248"><a href="#COMPsc.bar_composition-4248"><span class="linenos">4248</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="COMPsc.bar_composition-4249"><a href="#COMPsc.bar_composition-4249"><span class="linenos">4249</span></a>
</span><span id="COMPsc.bar_composition-4250"><a href="#COMPsc.bar_composition-4250"><span class="linenos">4250</span></a>            <span class="n">values</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="COMPsc.bar_composition-4251"><a href="#COMPsc.bar_composition-4251"><span class="linenos">4251</span></a>            <span class="n">names</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="COMPsc.bar_composition-4252"><a href="#COMPsc.bar_composition-4252"><span class="linenos">4252</span></a>            <span class="n">perc</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pct&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="COMPsc.bar_composition-4253"><a href="#COMPsc.bar_composition-4253"><span class="linenos">4253</span></a>            <span class="n">nums</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;num&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="COMPsc.bar_composition-4254"><a href="#COMPsc.bar_composition-4254"><span class="linenos">4254</span></a>
</span><span id="COMPsc.bar_composition-4255"><a href="#COMPsc.bar_composition-4255"><span class="linenos">4255</span></a>            <span class="n">bottom</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="COMPsc.bar_composition-4256"><a href="#COMPsc.bar_composition-4256"><span class="linenos">4256</span></a>            <span class="n">centers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc.bar_composition-4257"><a href="#COMPsc.bar_composition-4257"><span class="linenos">4257</span></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">nums</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
</span><span id="COMPsc.bar_composition-4258"><a href="#COMPsc.bar_composition-4258"><span class="linenos">4258</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">bottom</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="COMPsc.bar_composition-4259"><a href="#COMPsc.bar_composition-4259"><span class="linenos">4259</span></a>                <span class="n">centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bottom</span> <span class="o">+</span> <span class="n">val</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="COMPsc.bar_composition-4260"><a href="#COMPsc.bar_composition-4260"><span class="linenos">4260</span></a>                <span class="n">bottom</span> <span class="o">+=</span> <span class="n">val</span>
</span><span id="COMPsc.bar_composition-4261"><a href="#COMPsc.bar_composition-4261"><span class="linenos">4261</span></a>
</span><span id="COMPsc.bar_composition-4262"><a href="#COMPsc.bar_composition-4262"><span class="linenos">4262</span></a>            <span class="n">y_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">centers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">centers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">centers</span><span class="p">))</span>
</span><span id="COMPsc.bar_composition-4263"><a href="#COMPsc.bar_composition-4263"><span class="linenos">4263</span></a>            <span class="n">x_text</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.8</span>
</span><span id="COMPsc.bar_composition-4264"><a href="#COMPsc.bar_composition-4264"><span class="linenos">4264</span></a>
</span><span id="COMPsc.bar_composition-4265"><a href="#COMPsc.bar_composition-4265"><span class="linenos">4265</span></a>            <span class="k">for</span> <span class="n">y_label</span><span class="p">,</span> <span class="n">y_center</span><span class="p">,</span> <span class="n">pct</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">y_positions</span><span class="p">,</span> <span class="n">centers</span><span class="p">,</span> <span class="n">perc</span><span class="p">,</span> <span class="n">nums</span><span class="p">):</span>
</span><span id="COMPsc.bar_composition-4266"><a href="#COMPsc.bar_composition-4266"><span class="linenos">4266</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="COMPsc.bar_composition-4267"><a href="#COMPsc.bar_composition-4267"><span class="linenos">4267</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="n">pct</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4268"><a href="#COMPsc.bar_composition-4268"><span class="linenos">4268</span></a>                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_center</span><span class="p">),</span>
</span><span id="COMPsc.bar_composition-4269"><a href="#COMPsc.bar_composition-4269"><span class="linenos">4269</span></a>                    <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4270"><a href="#COMPsc.bar_composition-4270"><span class="linenos">4270</span></a>                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">x_text</span><span class="p">,</span> <span class="n">y_label</span><span class="p">),</span>
</span><span id="COMPsc.bar_composition-4271"><a href="#COMPsc.bar_composition-4271"><span class="linenos">4271</span></a>                    <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4272"><a href="#COMPsc.bar_composition-4272"><span class="linenos">4272</span></a>                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4273"><a href="#COMPsc.bar_composition-4273"><span class="linenos">4273</span></a>                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4274"><a href="#COMPsc.bar_composition-4274"><span class="linenos">4274</span></a>                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4275"><a href="#COMPsc.bar_composition-4275"><span class="linenos">4275</span></a>                    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="COMPsc.bar_composition-4276"><a href="#COMPsc.bar_composition-4276"><span class="linenos">4276</span></a>                        <span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4277"><a href="#COMPsc.bar_composition-4277"><span class="linenos">4277</span></a>                        <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4278"><a href="#COMPsc.bar_composition-4278"><span class="linenos">4278</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4279"><a href="#COMPsc.bar_composition-4279"><span class="linenos">4279</span></a>                        <span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;angle3,angleA=0,angleB=90&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4280"><a href="#COMPsc.bar_composition-4280"><span class="linenos">4280</span></a>                    <span class="p">),</span>
</span><span id="COMPsc.bar_composition-4281"><a href="#COMPsc.bar_composition-4281"><span class="linenos">4281</span></a>                <span class="p">)</span>
</span><span id="COMPsc.bar_composition-4282"><a href="#COMPsc.bar_composition-4282"><span class="linenos">4282</span></a>
</span><span id="COMPsc.bar_composition-4283"><a href="#COMPsc.bar_composition-4283"><span class="linenos">4283</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
</span><span id="COMPsc.bar_composition-4284"><a href="#COMPsc.bar_composition-4284"><span class="linenos">4284</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
</span><span id="COMPsc.bar_composition-4285"><a href="#COMPsc.bar_composition-4285"><span class="linenos">4285</span></a>            <span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="COMPsc.bar_composition-4286"><a href="#COMPsc.bar_composition-4286"><span class="linenos">4286</span></a>                <span class="n">spine</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="COMPsc.bar_composition-4287"><a href="#COMPsc.bar_composition-4287"><span class="linenos">4287</span></a>
</span><span id="COMPsc.bar_composition-4288"><a href="#COMPsc.bar_composition-4288"><span class="linenos">4288</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="COMPsc.bar_composition-4289"><a href="#COMPsc.bar_composition-4289"><span class="linenos">4289</span></a>                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Legend&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4290"><a href="#COMPsc.bar_composition-4290"><span class="linenos">4290</span></a>                <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">legend_bbox</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4291"><a href="#COMPsc.bar_composition-4291"><span class="linenos">4291</span></a>                <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4292"><a href="#COMPsc.bar_composition-4292"><span class="linenos">4292</span></a>                <span class="n">ncol</span><span class="o">=</span><span class="n">legend_split_col</span><span class="p">,</span>
</span><span id="COMPsc.bar_composition-4293"><a href="#COMPsc.bar_composition-4293"><span class="linenos">4293</span></a>            <span class="p">)</span>
</span><span id="COMPsc.bar_composition-4294"><a href="#COMPsc.bar_composition-4294"><span class="linenos">4294</span></a>
</span><span id="COMPsc.bar_composition-4295"><a href="#COMPsc.bar_composition-4295"><span class="linenos">4295</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="COMPsc.bar_composition-4296"><a href="#COMPsc.bar_composition-4296"><span class="linenos">4296</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="COMPsc.bar_composition-4297"><a href="#COMPsc.bar_composition-4297"><span class="linenos">4297</span></a>
</span><span id="COMPsc.bar_composition-4298"><a href="#COMPsc.bar_composition-4298"><span class="linenos">4298</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span></pre></div>


            <div class="docstring"><p>Visualize the composition of cell lineages using bar plots.</p>

<p>Produces bar plots showing the distribution of features stored in
<code>self.composition_data</code>. If multiple sets are present, a separate
bar is drawn for each set. Percentages are annotated alongside the bars.</p>

<h2 id="parameters">Parameters</h2>

<p>cmap : str, default 'tab20b'
    Colormap used for stacked bars.</p>

<p>width : int, default 2
    Width of each subplot (per set).</p>

<p>height : int, default 6
    Height of the figure.</p>

<p>font_size : int, default 15
    Font size for labels and annotations.</p>

<p>legend_split_col : int, default 1
    Number of columns in the legend.</p>

<p>legend_bbox : tuple, default (1.3, 1)
    Bounding box anchor position for the legend.</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.figure.Figure
    Stacked bar plot visualization of composition data.</p>
</div>


                            </div>
                            <div id="COMPsc.cell_regression" class="classattr">
                                        <input id="COMPsc.cell_regression-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cell_regression</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">cell_x</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">cell_y</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">set_x</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">set_y</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">threshold</span><span class="o">=</span><span class="mi">10</span>,</span><span class="param">	<span class="n">image_width</span><span class="o">=</span><span class="mi">12</span>,</span><span class="param">	<span class="n">image_high</span><span class="o">=</span><span class="mi">7</span>,</span><span class="param">	<span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="COMPsc.cell_regression-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#COMPsc.cell_regression"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="COMPsc.cell_regression-4300"><a href="#COMPsc.cell_regression-4300"><span class="linenos">4300</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cell_regression</span><span class="p">(</span>
</span><span id="COMPsc.cell_regression-4301"><a href="#COMPsc.cell_regression-4301"><span class="linenos">4301</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="COMPsc.cell_regression-4302"><a href="#COMPsc.cell_regression-4302"><span class="linenos">4302</span></a>        <span class="n">cell_x</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="COMPsc.cell_regression-4303"><a href="#COMPsc.cell_regression-4303"><span class="linenos">4303</span></a>        <span class="n">cell_y</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="COMPsc.cell_regression-4304"><a href="#COMPsc.cell_regression-4304"><span class="linenos">4304</span></a>        <span class="n">set_x</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.cell_regression-4305"><a href="#COMPsc.cell_regression-4305"><span class="linenos">4305</span></a>        <span class="n">set_y</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="COMPsc.cell_regression-4306"><a href="#COMPsc.cell_regression-4306"><span class="linenos">4306</span></a>        <span class="n">threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="COMPsc.cell_regression-4307"><a href="#COMPsc.cell_regression-4307"><span class="linenos">4307</span></a>        <span class="n">image_width</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="COMPsc.cell_regression-4308"><a href="#COMPsc.cell_regression-4308"><span class="linenos">4308</span></a>        <span class="n">image_high</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
</span><span id="COMPsc.cell_regression-4309"><a href="#COMPsc.cell_regression-4309"><span class="linenos">4309</span></a>        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="COMPsc.cell_regression-4310"><a href="#COMPsc.cell_regression-4310"><span class="linenos">4310</span></a>    <span class="p">):</span>
</span><span id="COMPsc.cell_regression-4311"><a href="#COMPsc.cell_regression-4311"><span class="linenos">4311</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="COMPsc.cell_regression-4312"><a href="#COMPsc.cell_regression-4312"><span class="linenos">4312</span></a><span class="sd">        Perform regression analysis between two selected cells and visualize the relationship.</span>
</span><span id="COMPsc.cell_regression-4313"><a href="#COMPsc.cell_regression-4313"><span class="linenos">4313</span></a>
</span><span id="COMPsc.cell_regression-4314"><a href="#COMPsc.cell_regression-4314"><span class="linenos">4314</span></a><span class="sd">        This function computes a linear regression between two specified cells from</span>
</span><span id="COMPsc.cell_regression-4315"><a href="#COMPsc.cell_regression-4315"><span class="linenos">4315</span></a><span class="sd">        aggregated normalized data, plots the regression line with scatter points,</span>
</span><span id="COMPsc.cell_regression-4316"><a href="#COMPsc.cell_regression-4316"><span class="linenos">4316</span></a><span class="sd">        annotates regression statistics, and highlights potential outliers.</span>
</span><span id="COMPsc.cell_regression-4317"><a href="#COMPsc.cell_regression-4317"><span class="linenos">4317</span></a>
</span><span id="COMPsc.cell_regression-4318"><a href="#COMPsc.cell_regression-4318"><span class="linenos">4318</span></a><span class="sd">        Parameters</span>
</span><span id="COMPsc.cell_regression-4319"><a href="#COMPsc.cell_regression-4319"><span class="linenos">4319</span></a><span class="sd">        ----------</span>
</span><span id="COMPsc.cell_regression-4320"><a href="#COMPsc.cell_regression-4320"><span class="linenos">4320</span></a><span class="sd">        cell_x : str</span>
</span><span id="COMPsc.cell_regression-4321"><a href="#COMPsc.cell_regression-4321"><span class="linenos">4321</span></a><span class="sd">            Name of the first cell (X-axis).</span>
</span><span id="COMPsc.cell_regression-4322"><a href="#COMPsc.cell_regression-4322"><span class="linenos">4322</span></a>
</span><span id="COMPsc.cell_regression-4323"><a href="#COMPsc.cell_regression-4323"><span class="linenos">4323</span></a><span class="sd">        cell_y : str</span>
</span><span id="COMPsc.cell_regression-4324"><a href="#COMPsc.cell_regression-4324"><span class="linenos">4324</span></a><span class="sd">            Name of the second cell (Y-axis).</span>
</span><span id="COMPsc.cell_regression-4325"><a href="#COMPsc.cell_regression-4325"><span class="linenos">4325</span></a>
</span><span id="COMPsc.cell_regression-4326"><a href="#COMPsc.cell_regression-4326"><span class="linenos">4326</span></a><span class="sd">        set_x : str or None</span>
</span><span id="COMPsc.cell_regression-4327"><a href="#COMPsc.cell_regression-4327"><span class="linenos">4327</span></a><span class="sd">            Dataset identifier corresponding to `cell_x`. If None, cell is selected only by name.</span>
</span><span id="COMPsc.cell_regression-4328"><a href="#COMPsc.cell_regression-4328"><span class="linenos">4328</span></a>
</span><span id="COMPsc.cell_regression-4329"><a href="#COMPsc.cell_regression-4329"><span class="linenos">4329</span></a><span class="sd">        set_y : str or None</span>
</span><span id="COMPsc.cell_regression-4330"><a href="#COMPsc.cell_regression-4330"><span class="linenos">4330</span></a><span class="sd">            Dataset identifier corresponding to `cell_y`. If None, cell is selected only by name.</span>
</span><span id="COMPsc.cell_regression-4331"><a href="#COMPsc.cell_regression-4331"><span class="linenos">4331</span></a>
</span><span id="COMPsc.cell_regression-4332"><a href="#COMPsc.cell_regression-4332"><span class="linenos">4332</span></a><span class="sd">        threshold : int or float, default 10</span>
</span><span id="COMPsc.cell_regression-4333"><a href="#COMPsc.cell_regression-4333"><span class="linenos">4333</span></a><span class="sd">            Threshold for detecting outliers. Points deviating from the mean or diagonal by more</span>
</span><span id="COMPsc.cell_regression-4334"><a href="#COMPsc.cell_regression-4334"><span class="linenos">4334</span></a><span class="sd">            than this value are annotated.</span>
</span><span id="COMPsc.cell_regression-4335"><a href="#COMPsc.cell_regression-4335"><span class="linenos">4335</span></a>
</span><span id="COMPsc.cell_regression-4336"><a href="#COMPsc.cell_regression-4336"><span class="linenos">4336</span></a><span class="sd">        image_width : int, default 12</span>
</span><span id="COMPsc.cell_regression-4337"><a href="#COMPsc.cell_regression-4337"><span class="linenos">4337</span></a><span class="sd">            Width of the regression plot (in inches).</span>
</span><span id="COMPsc.cell_regression-4338"><a href="#COMPsc.cell_regression-4338"><span class="linenos">4338</span></a>
</span><span id="COMPsc.cell_regression-4339"><a href="#COMPsc.cell_regression-4339"><span class="linenos">4339</span></a><span class="sd">        image_high : int, default 7</span>
</span><span id="COMPsc.cell_regression-4340"><a href="#COMPsc.cell_regression-4340"><span class="linenos">4340</span></a><span class="sd">            Height of the regression plot (in inches).</span>
</span><span id="COMPsc.cell_regression-4341"><a href="#COMPsc.cell_regression-4341"><span class="linenos">4341</span></a>
</span><span id="COMPsc.cell_regression-4342"><a href="#COMPsc.cell_regression-4342"><span class="linenos">4342</span></a><span class="sd">        color : str, default &#39;black&#39;</span>
</span><span id="COMPsc.cell_regression-4343"><a href="#COMPsc.cell_regression-4343"><span class="linenos">4343</span></a><span class="sd">            Color of the regression scatter points and line.</span>
</span><span id="COMPsc.cell_regression-4344"><a href="#COMPsc.cell_regression-4344"><span class="linenos">4344</span></a>
</span><span id="COMPsc.cell_regression-4345"><a href="#COMPsc.cell_regression-4345"><span class="linenos">4345</span></a><span class="sd">        Returns</span>
</span><span id="COMPsc.cell_regression-4346"><a href="#COMPsc.cell_regression-4346"><span class="linenos">4346</span></a><span class="sd">        -------</span>
</span><span id="COMPsc.cell_regression-4347"><a href="#COMPsc.cell_regression-4347"><span class="linenos">4347</span></a><span class="sd">        matplotlib.figure.Figure</span>
</span><span id="COMPsc.cell_regression-4348"><a href="#COMPsc.cell_regression-4348"><span class="linenos">4348</span></a><span class="sd">            Regression plot figure with annotated regression line, R², p-value, and outliers.</span>
</span><span id="COMPsc.cell_regression-4349"><a href="#COMPsc.cell_regression-4349"><span class="linenos">4349</span></a>
</span><span id="COMPsc.cell_regression-4350"><a href="#COMPsc.cell_regression-4350"><span class="linenos">4350</span></a><span class="sd">        Raises</span>
</span><span id="COMPsc.cell_regression-4351"><a href="#COMPsc.cell_regression-4351"><span class="linenos">4351</span></a><span class="sd">        ------</span>
</span><span id="COMPsc.cell_regression-4352"><a href="#COMPsc.cell_regression-4352"><span class="linenos">4352</span></a><span class="sd">        ValueError</span>
</span><span id="COMPsc.cell_regression-4353"><a href="#COMPsc.cell_regression-4353"><span class="linenos">4353</span></a><span class="sd">            If `cell_x` or `cell_y` are not found in the dataset.</span>
</span><span id="COMPsc.cell_regression-4354"><a href="#COMPsc.cell_regression-4354"><span class="linenos">4354</span></a><span class="sd">            If multiple matches are found for a cell name and `set_x`/`set_y` are not specified.</span>
</span><span id="COMPsc.cell_regression-4355"><a href="#COMPsc.cell_regression-4355"><span class="linenos">4355</span></a>
</span><span id="COMPsc.cell_regression-4356"><a href="#COMPsc.cell_regression-4356"><span class="linenos">4356</span></a><span class="sd">        Notes</span>
</span><span id="COMPsc.cell_regression-4357"><a href="#COMPsc.cell_regression-4357"><span class="linenos">4357</span></a><span class="sd">        -----</span>
</span><span id="COMPsc.cell_regression-4358"><a href="#COMPsc.cell_regression-4358"><span class="linenos">4358</span></a><span class="sd">        - The function automatically calls `jseq_object.average()` if aggregated data is not available.</span>
</span><span id="COMPsc.cell_regression-4359"><a href="#COMPsc.cell_regression-4359"><span class="linenos">4359</span></a><span class="sd">        - Outliers are annotated with their corresponding index labels.</span>
</span><span id="COMPsc.cell_regression-4360"><a href="#COMPsc.cell_regression-4360"><span class="linenos">4360</span></a><span class="sd">        - Regression is computed using `scipy.stats.linregress`.</span>
</span><span id="COMPsc.cell_regression-4361"><a href="#COMPsc.cell_regression-4361"><span class="linenos">4361</span></a>
</span><span id="COMPsc.cell_regression-4362"><a href="#COMPsc.cell_regression-4362"><span class="linenos">4362</span></a><span class="sd">        Examples</span>
</span><span id="COMPsc.cell_regression-4363"><a href="#COMPsc.cell_regression-4363"><span class="linenos">4363</span></a><span class="sd">        --------</span>
</span><span id="COMPsc.cell_regression-4364"><a href="#COMPsc.cell_regression-4364"><span class="linenos">4364</span></a><span class="sd">        &gt;&gt;&gt; obj.cell_regression(cell_x=&quot;Purkinje&quot;, cell_y=&quot;Granule&quot;, set_x=&quot;Exp1&quot;, set_y=&quot;Exp2&quot;)</span>
</span><span id="COMPsc.cell_regression-4365"><a href="#COMPsc.cell_regression-4365"><span class="linenos">4365</span></a><span class="sd">        &gt;&gt;&gt; obj.cell_regression(cell_x=&quot;NeuronA&quot;, cell_y=&quot;NeuronB&quot;, threshold=5, color=&quot;blue&quot;)</span>
</span><span id="COMPsc.cell_regression-4366"><a href="#COMPsc.cell_regression-4366"><span class="linenos">4366</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="COMPsc.cell_regression-4367"><a href="#COMPsc.cell_regression-4367"><span class="linenos">4367</span></a>
</span><span id="COMPsc.cell_regression-4368"><a href="#COMPsc.cell_regression-4368"><span class="linenos">4368</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.cell_regression-4369"><a href="#COMPsc.cell_regression-4369"><span class="linenos">4369</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
</span><span id="COMPsc.cell_regression-4370"><a href="#COMPsc.cell_regression-4370"><span class="linenos">4370</span></a>
</span><span id="COMPsc.cell_regression-4371"><a href="#COMPsc.cell_regression-4371"><span class="linenos">4371</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_metadata</span>
</span><span id="COMPsc.cell_regression-4372"><a href="#COMPsc.cell_regression-4372"><span class="linenos">4372</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_normalized_data</span>
</span><span id="COMPsc.cell_regression-4373"><a href="#COMPsc.cell_regression-4373"><span class="linenos">4373</span></a>
</span><span id="COMPsc.cell_regression-4374"><a href="#COMPsc.cell_regression-4374"><span class="linenos">4374</span></a>        <span class="k">if</span> <span class="n">set_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">set_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="COMPsc.cell_regression-4375"><a href="#COMPsc.cell_regression-4375"><span class="linenos">4375</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="COMPsc.cell_regression-4376"><a href="#COMPsc.cell_regression-4376"><span class="linenos">4376</span></a>            <span class="n">cell_x</span> <span class="o">=</span> <span class="n">cell_x</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="n">set_x</span>
</span><span id="COMPsc.cell_regression-4377"><a href="#COMPsc.cell_regression-4377"><span class="linenos">4377</span></a>            <span class="n">cell_y</span> <span class="o">=</span> <span class="n">cell_y</span> <span class="o">+</span> <span class="s2">&quot; # &quot;</span> <span class="o">+</span> <span class="n">set_y</span>
</span><span id="COMPsc.cell_regression-4378"><a href="#COMPsc.cell_regression-4378"><span class="linenos">4378</span></a>
</span><span id="COMPsc.cell_regression-4379"><a href="#COMPsc.cell_regression-4379"><span class="linenos">4379</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="COMPsc.cell_regression-4380"><a href="#COMPsc.cell_regression-4380"><span class="linenos">4380</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;cell_names&quot;</span><span class="p">]</span>
</span><span id="COMPsc.cell_regression-4381"><a href="#COMPsc.cell_regression-4381"><span class="linenos">4381</span></a>
</span><span id="COMPsc.cell_regression-4382"><a href="#COMPsc.cell_regression-4382"><span class="linenos">4382</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_x</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="COMPsc.cell_regression-4383"><a href="#COMPsc.cell_regression-4383"><span class="linenos">4383</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;cell_x&#39; value not in cell names!&quot;</span><span class="p">)</span>
</span><span id="COMPsc.cell_regression-4384"><a href="#COMPsc.cell_regression-4384"><span class="linenos">4384</span></a>
</span><span id="COMPsc.cell_regression-4385"><a href="#COMPsc.cell_regression-4385"><span class="linenos">4385</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_y</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="COMPsc.cell_regression-4386"><a href="#COMPsc.cell_regression-4386"><span class="linenos">4386</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;cell_y&#39; value not in cell names!&quot;</span><span class="p">)</span>
</span><span id="COMPsc.cell_regression-4387"><a href="#COMPsc.cell_regression-4387"><span class="linenos">4387</span></a>
</span><span id="COMPsc.cell_regression-4388"><a href="#COMPsc.cell_regression-4388"><span class="linenos">4388</span></a>        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">cell_x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="COMPsc.cell_regression-4389"><a href="#COMPsc.cell_regression-4389"><span class="linenos">4389</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc.cell_regression-4390"><a href="#COMPsc.cell_regression-4390"><span class="linenos">4390</span></a>                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">cell_x</span><span class="si">}</span><span class="s2">&#39; occurs more than once. If you want to select a specific cell, &quot;</span>
</span><span id="COMPsc.cell_regression-4391"><a href="#COMPsc.cell_regression-4391"><span class="linenos">4391</span></a>                <span class="sa">f</span><span class="s2">&quot;please also provide the corresponding &#39;set_x&#39; and &#39;set_y&#39; values.&quot;</span>
</span><span id="COMPsc.cell_regression-4392"><a href="#COMPsc.cell_regression-4392"><span class="linenos">4392</span></a>            <span class="p">)</span>
</span><span id="COMPsc.cell_regression-4393"><a href="#COMPsc.cell_regression-4393"><span class="linenos">4393</span></a>
</span><span id="COMPsc.cell_regression-4394"><a href="#COMPsc.cell_regression-4394"><span class="linenos">4394</span></a>        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">cell_y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="COMPsc.cell_regression-4395"><a href="#COMPsc.cell_regression-4395"><span class="linenos">4395</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="COMPsc.cell_regression-4396"><a href="#COMPsc.cell_regression-4396"><span class="linenos">4396</span></a>                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">cell_y</span><span class="si">}</span><span class="s2">&#39; occurs more than once. If you want to select a specific cell, &quot;</span>
</span><span id="COMPsc.cell_regression-4397"><a href="#COMPsc.cell_regression-4397"><span class="linenos">4397</span></a>                <span class="sa">f</span><span class="s2">&quot;please also provide the corresponding &#39;set_x&#39; and &#39;set_y&#39; values.&quot;</span>
</span><span id="COMPsc.cell_regression-4398"><a href="#COMPsc.cell_regression-4398"><span class="linenos">4398</span></a>            <span class="p">)</span>
</span><span id="COMPsc.cell_regression-4399"><a href="#COMPsc.cell_regression-4399"><span class="linenos">4399</span></a>
</span><span id="COMPsc.cell_regression-4400"><a href="#COMPsc.cell_regression-4400"><span class="linenos">4400</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">image_width</span><span class="p">,</span> <span class="n">image_high</span><span class="p">))</span>
</span><span id="COMPsc.cell_regression-4401"><a href="#COMPsc.cell_regression-4401"><span class="linenos">4401</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">cell_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">cell_y</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
</span><span id="COMPsc.cell_regression-4402"><a href="#COMPsc.cell_regression-4402"><span class="linenos">4402</span></a>
</span><span id="COMPsc.cell_regression-4403"><a href="#COMPsc.cell_regression-4403"><span class="linenos">4403</span></a>        <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span>
</span><span id="COMPsc.cell_regression-4404"><a href="#COMPsc.cell_regression-4404"><span class="linenos">4404</span></a>            <span class="n">data</span><span class="p">[</span><span class="n">cell_x</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">cell_y</span><span class="p">]</span>
</span><span id="COMPsc.cell_regression-4405"><a href="#COMPsc.cell_regression-4405"><span class="linenos">4405</span></a>        <span class="p">)</span>
</span><span id="COMPsc.cell_regression-4406"><a href="#COMPsc.cell_regression-4406"><span class="linenos">4406</span></a>        <span class="n">equation</span> <span class="o">=</span> <span class="s2">&quot;y = </span><span class="si">{:.2f}</span><span class="s2">x + </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">)</span>
</span><span id="COMPsc.cell_regression-4407"><a href="#COMPsc.cell_regression-4407"><span class="linenos">4407</span></a>
</span><span id="COMPsc.cell_regression-4408"><a href="#COMPsc.cell_regression-4408"><span class="linenos">4408</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="COMPsc.cell_regression-4409"><a href="#COMPsc.cell_regression-4409"><span class="linenos">4409</span></a>            <span class="s2">&quot;R-squared = </span><span class="si">{:.2f}</span><span class="se">\n</span><span class="s2">P-value = </span><span class="si">{:.2f}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="COMPsc.cell_regression-4410"><a href="#COMPsc.cell_regression-4410"><span class="linenos">4410</span></a>                <span class="n">r_value</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">equation</span>
</span><span id="COMPsc.cell_regression-4411"><a href="#COMPsc.cell_regression-4411"><span class="linenos">4411</span></a>            <span class="p">),</span>
</span><span id="COMPsc.cell_regression-4412"><a href="#COMPsc.cell_regression-4412"><span class="linenos">4412</span></a>            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.90</span><span class="p">),</span>
</span><span id="COMPsc.cell_regression-4413"><a href="#COMPsc.cell_regression-4413"><span class="linenos">4413</span></a>            <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
</span><span id="COMPsc.cell_regression-4414"><a href="#COMPsc.cell_regression-4414"><span class="linenos">4414</span></a>            <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="COMPsc.cell_regression-4415"><a href="#COMPsc.cell_regression-4415"><span class="linenos">4415</span></a>        <span class="p">)</span>
</span><span id="COMPsc.cell_regression-4416"><a href="#COMPsc.cell_regression-4416"><span class="linenos">4416</span></a>
</span><span id="COMPsc.cell_regression-4417"><a href="#COMPsc.cell_regression-4417"><span class="linenos">4417</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="COMPsc.cell_regression-4418"><a href="#COMPsc.cell_regression-4418"><span class="linenos">4418</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="COMPsc.cell_regression-4419"><a href="#COMPsc.cell_regression-4419"><span class="linenos">4419</span></a>
</span><span id="COMPsc.cell_regression-4420"><a href="#COMPsc.cell_regression-4420"><span class="linenos">4420</span></a>        <span class="n">diff</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc.cell_regression-4421"><a href="#COMPsc.cell_regression-4421"><span class="linenos">4421</span></a>        <span class="n">x_mean</span><span class="p">,</span> <span class="n">y_mean</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">cell_x</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">data</span><span class="p">[</span><span class="n">cell_y</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="COMPsc.cell_regression-4422"><a href="#COMPsc.cell_regression-4422"><span class="linenos">4422</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">cell_x</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">cell_y</span><span class="p">])):</span>
</span><span id="COMPsc.cell_regression-4423"><a href="#COMPsc.cell_regression-4423"><span class="linenos">4423</span></a>            <span class="n">diff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">))</span>
</span><span id="COMPsc.cell_regression-4424"><a href="#COMPsc.cell_regression-4424"><span class="linenos">4424</span></a>            <span class="n">diff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">yi</span> <span class="o">-</span> <span class="n">y_mean</span><span class="p">))</span>
</span><span id="COMPsc.cell_regression-4425"><a href="#COMPsc.cell_regression-4425"><span class="linenos">4425</span></a>
</span><span id="COMPsc.cell_regression-4426"><a href="#COMPsc.cell_regression-4426"><span class="linenos">4426</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">annotate_outliers</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
</span><span id="COMPsc.cell_regression-4427"><a href="#COMPsc.cell_regression-4427"><span class="linenos">4427</span></a>            <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="COMPsc.cell_regression-4428"><a href="#COMPsc.cell_regression-4428"><span class="linenos">4428</span></a>            <span class="n">x_mean</span><span class="p">,</span> <span class="n">y_mean</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="COMPsc.cell_regression-4429"><a href="#COMPsc.cell_regression-4429"><span class="linenos">4429</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)):</span>
</span><span id="COMPsc.cell_regression-4430"><a href="#COMPsc.cell_regression-4430"><span class="linenos">4430</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="COMPsc.cell_regression-4431"><a href="#COMPsc.cell_regression-4431"><span class="linenos">4431</span></a>                    <span class="nb">abs</span><span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span>
</span><span id="COMPsc.cell_regression-4432"><a href="#COMPsc.cell_regression-4432"><span class="linenos">4432</span></a>                    <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">yi</span> <span class="o">-</span> <span class="n">y_mean</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span>
</span><span id="COMPsc.cell_regression-4433"><a href="#COMPsc.cell_regression-4433"><span class="linenos">4433</span></a>                    <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">yi</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span>
</span><span id="COMPsc.cell_regression-4434"><a href="#COMPsc.cell_regression-4434"><span class="linenos">4434</span></a>                <span class="p">):</span>
</span><span id="COMPsc.cell_regression-4435"><a href="#COMPsc.cell_regression-4435"><span class="linenos">4435</span></a>                    <span class="n">text</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="COMPsc.cell_regression-4436"><a href="#COMPsc.cell_regression-4436"><span class="linenos">4436</span></a>                    <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span id="COMPsc.cell_regression-4437"><a href="#COMPsc.cell_regression-4437"><span class="linenos">4437</span></a>
</span><span id="COMPsc.cell_regression-4438"><a href="#COMPsc.cell_regression-4438"><span class="linenos">4438</span></a>            <span class="k">return</span> <span class="n">texts</span>
</span><span id="COMPsc.cell_regression-4439"><a href="#COMPsc.cell_regression-4439"><span class="linenos">4439</span></a>
</span><span id="COMPsc.cell_regression-4440"><a href="#COMPsc.cell_regression-4440"><span class="linenos">4440</span></a>        <span class="n">texts</span> <span class="o">=</span> <span class="n">annotate_outliers</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">cell_x</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">cell_y</span><span class="p">],</span> <span class="n">threshold</span><span class="p">)</span>
</span><span id="COMPsc.cell_regression-4441"><a href="#COMPsc.cell_regression-4441"><span class="linenos">4441</span></a>
</span><span id="COMPsc.cell_regression-4442"><a href="#COMPsc.cell_regression-4442"><span class="linenos">4442</span></a>        <span class="n">adjust_text</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>
</span><span id="COMPsc.cell_regression-4443"><a href="#COMPsc.cell_regression-4443"><span class="linenos">4443</span></a>
</span><span id="COMPsc.cell_regression-4444"><a href="#COMPsc.cell_regression-4444"><span class="linenos">4444</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="COMPsc.cell_regression-4445"><a href="#COMPsc.cell_regression-4445"><span class="linenos">4445</span></a>
</span><span id="COMPsc.cell_regression-4446"><a href="#COMPsc.cell_regression-4446"><span class="linenos">4446</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span></pre></div>


            <div class="docstring"><p>Perform regression analysis between two selected cells and visualize the relationship.</p>

<p>This function computes a linear regression between two specified cells from
aggregated normalized data, plots the regression line with scatter points,
annotates regression statistics, and highlights potential outliers.</p>

<h2 id="parameters">Parameters</h2>

<p>cell_x : str
    Name of the first cell (X-axis).</p>

<p>cell_y : str
    Name of the second cell (Y-axis).</p>

<p>set_x : str or None
    Dataset identifier corresponding to <code>cell_x</code>. If None, cell is selected only by name.</p>

<p>set_y : str or None
    Dataset identifier corresponding to <code>cell_y</code>. If None, cell is selected only by name.</p>

<p>threshold : int or float, default 10
    Threshold for detecting outliers. Points deviating from the mean or diagonal by more
    than this value are annotated.</p>

<p>image_width : int, default 12
    Width of the regression plot (in inches).</p>

<p>image_high : int, default 7
    Height of the regression plot (in inches).</p>

<p>color : str, default 'black'
    Color of the regression scatter points and line.</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.figure.Figure
    Regression plot figure with annotated regression line, R², p-value, and outliers.</p>

<h2 id="raises">Raises</h2>

<p>ValueError
    If <code>cell_x</code> or <code>cell_y</code> are not found in the dataset.
    If multiple matches are found for a cell name and <code>set_x</code>/<code>set_y</code> are not specified.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>The function automatically calls <code>jseq_object.average()</code> if aggregated data is not available.</li>
<li>Outliers are annotated with their corresponding index labels.</li>
<li>Regression is computed using <code>scipy.stats.linregress</code>.</li>
</ul>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">obj</span><span class="o">.</span><span class="n">cell_regression</span><span class="p">(</span><span class="n">cell_x</span><span class="o">=</span><span class="s2">&quot;Purkinje&quot;</span><span class="p">,</span> <span class="n">cell_y</span><span class="o">=</span><span class="s2">&quot;Granule&quot;</span><span class="p">,</span> <span class="n">set_x</span><span class="o">=</span><span class="s2">&quot;Exp1&quot;</span><span class="p">,</span> <span class="n">set_y</span><span class="o">=</span><span class="s2">&quot;Exp2&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">obj</span><span class="o">.</span><span class="n">cell_regression</span><span class="p">(</span><span class="n">cell_x</span><span class="o">=</span><span class="s2">&quot;NeuronA&quot;</span><span class="p">,</span> <span class="n">cell_y</span><span class="o">=</span><span class="s2">&quot;NeuronB&quot;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
</code></pre>
</div>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Clustering">Clustering</a></dt>
                                <dd id="COMPsc.clustering_data" class="variable"><a href="#Clustering.clustering_data">clustering_data</a></dd>
                <dd id="COMPsc.clustering_metadata" class="variable"><a href="#Clustering.clustering_metadata">clustering_metadata</a></dd>
                <dd id="COMPsc.subclusters" class="variable"><a href="#Clustering.subclusters">subclusters</a></dd>
                <dd id="COMPsc.explained_var" class="variable"><a href="#Clustering.explained_var">explained_var</a></dd>
                <dd id="COMPsc.cumulative_var" class="variable"><a href="#Clustering.cumulative_var">cumulative_var</a></dd>
                <dd id="COMPsc.pca" class="variable"><a href="#Clustering.pca">pca</a></dd>
                <dd id="COMPsc.harmonized_pca" class="variable"><a href="#Clustering.harmonized_pca">harmonized_pca</a></dd>
                <dd id="COMPsc.umap" class="variable"><a href="#Clustering.umap">umap</a></dd>
                <dd id="COMPsc.add_data_frame" class="function"><a href="#Clustering.add_data_frame">add_data_frame</a></dd>
                <dd id="COMPsc.harmonize_sets" class="function"><a href="#Clustering.harmonize_sets">harmonize_sets</a></dd>
                <dd id="COMPsc.perform_PCA" class="function"><a href="#Clustering.perform_PCA">perform_PCA</a></dd>
                <dd id="COMPsc.knee_plot_PCA" class="function"><a href="#Clustering.knee_plot_PCA">knee_plot_PCA</a></dd>
                <dd id="COMPsc.find_clusters_PCA" class="function"><a href="#Clustering.find_clusters_PCA">find_clusters_PCA</a></dd>
                <dd id="COMPsc.perform_UMAP" class="function"><a href="#Clustering.perform_UMAP">perform_UMAP</a></dd>
                <dd id="COMPsc.knee_plot_umap" class="function"><a href="#Clustering.knee_plot_umap">knee_plot_umap</a></dd>
                <dd id="COMPsc.find_clusters_UMAP" class="function"><a href="#Clustering.find_clusters_UMAP">find_clusters_UMAP</a></dd>
                <dd id="COMPsc.UMAP_vis" class="function"><a href="#Clustering.UMAP_vis">UMAP_vis</a></dd>
                <dd id="COMPsc.UMAP_feature" class="function"><a href="#Clustering.UMAP_feature">UMAP_feature</a></dd>
                <dd id="COMPsc.get_umap_data" class="function"><a href="#Clustering.get_umap_data">get_umap_data</a></dd>
                <dd id="COMPsc.get_pca_data" class="function"><a href="#Clustering.get_pca_data">get_pca_data</a></dd>
                <dd id="COMPsc.return_clusters" class="function"><a href="#Clustering.return_clusters">return_clusters</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>